<!DOCTYPE html>
<meta charset="utf-8">
<title>Two-Paned Editor</title>
<link rel="stylesheet" href="../codemirror2/lib/codemirror.css">
<link rel="stylesheet" href="../jsbin-codemirror-theme.css">
<style>
html, body {
  height: 100%;
  margin: 0px;
  padding: 0px;
}

.html {
  position: absolute;
  top: 0px;
  left: 0px;
  bottom: 0px;
  width: 50%;
}

.CodeMirror, .CodeMirror-scroll {
  height: 100%;
}

.error, .preview {
  position: absolute;
  top: 0px;
  right: 0px;
  bottom: 0px;
  width: 50%;
  height: 100%;
  border: none;
}

.preview {
  border-left: 1px solid black;
}

.error {
  background: rgba(128, 0, 0, 0.75);
  color: white;
  padding: 10px;
  overflow: auto;
  -webkit-box-sizing: border-box;
}

.error em[data-highlight] {
  font-style: normal;
  cursor: pointer;
}

.error em.highlight-1, .CodeMirror span.highlight-1 {
  color: black;
  background: yellow;
}

.error em.highlight-2, .CodeMirror span.highlight-2 {
  color: white;
  background: gray;
}

.suggestions a {
  color: inherit;
}

.suggestions li p {
  font-size: smaller;
}

code {
  font-family: Menlo, Monaco, consolas, monospace;
  font-size: smaller;
}
</style>
<textarea class="html"></textarea>
<script type="text/html" id="initial-html">
<style>
  p {
    colo: blue;
  }
</style>
<p>Tinker with me.</p>
</script>
<iframe class="preview" src="blank.html"></iframe>
<div class="error" style="display: none"></div>
<div id="templates" style="display: none">
  <div class="error-msgs"></div>
  <div class="suggestions">
    <p>Following are some suggestions that may help. Click on one for more detailed information.</p>
    <ul>
      <li>
        <code><a href="" target="mdn"></a></code>
        <p></p>
      </li>
    </ul>
  </div>
</div>
<script src="../jquery.min.js"></script>
<script src="../underscore.min.js"></script>
<script src="../codemirror2/lib/codemirror.js"></script>
<script src="../codemirror2/mode/xml/xml.js"></script>
<script src="../codemirror2/mode/javascript/javascript.js"></script>
<script src="../codemirror2/mode/css/css.js"></script>
<script src="../codemirror2/mode/htmlmixed/htmlmixed.js"></script>
<script src="../../slowparse.js"></script>
<script src="hacktionary-data.js"></script>
<script>
// TODOS:
//
// * Mouseover of DOM elements in preview area should highlight the relevant
//   source code.
//
// * Mouseover of tag names and attributes on page should show relevant
//   MDN help tooltip, with link to more information on MDN (e.g. via
//   shift-click).
//
// * On mouseover of word "here" in error message, the associated source code
//   should scroll into view if not already visible.
//
// * Suggestions for unrecognized tags/properties/attrs should have MDN
//   blurbs next to them.
//
// * We should detect unrecognized attributes for the current tag and
//   provide suggestions for those.
//
// * Images that don't load should also dim the preview area and provide
//   help atop it, e.g. telling the user to check the URL and make sure
//   it's an image and not a web page. Relevant source code should
//   be highlighted.

var editor;

_.templateSettings = {
  escape: /\{\{(.+?)\}\}/g
};

function selectInterval(interval) {
  var start = editor.coordsFromIndex(interval.start);
  var end = editor.coordsFromIndex(interval.end);
  editor.setSelection(start, end);
  editor.focus();
}

$(document).on("mouseover", "[data-highlight]", function(event) {
  var interval = $(this).attr("data-highlight").split(",");
  selectInterval({
    start: parseInt(interval[0]),
    end: parseInt(interval[1])
  });
});

function createSuggestions(options) {
  var name = options.name.toLowerCase();
  var matches = options.lexicon.filter(function(s) {
    return s.indexOf(name) != -1;
  });
  if (!matches.length)
    return $();
  var suggs = $("#templates .suggestions").clone();
  var li = suggs.find("li").remove();
  matches.forEach(function(sugg) {
    var suggItem = li.clone();
    suggItem.find('a')
      .attr("href", options.baseURL + sugg)
      .text(sugg);
    if (sugg in options.blurbs) {
      suggItem.find('p').html(options.blurbs[sugg]);
      suggItem.find('p a').attr("target", "mdn");
    }
    suggItem.appendTo(suggs.find('ul'));
  });
  return suggs;
}

function reportError(error) {
  var template = $("#templates .error-msg." + error.type);
  $(".error").html(_.template(template.html(), error)).show()
    .find("[data-highlight]").each(setErrorHighlight);
  if (error.type == "INVALID_TAG_NAME") {
    createSuggestions({
      name: error.openTag.name,
      lexicon: Slowparse.HTML_ELEMENT_NAMES,
      baseURL: "https://developer.mozilla.org/en/HTML/Element/",
      blurbs: HacktionaryData["html-element-docs"]
    }).appendTo(".error");
  } else if (error.type == "INVALID_CSS_PROPERTY_NAME") {
    createSuggestions({
      name: error.cssProperty.name,
      lexicon: Slowparse.CSS_PROPERTY_NAMES,
      baseURL: "https://developer.mozilla.org/en/CSS/",
      blurbs: HacktionaryData["css-property-docs"]
    }).appendTo(".error");
  }
}

function setErrorHighlight(i) {
  var className = "highlight-" + (i+1);
  var interval = $(this).attr("data-highlight").split(",");
  var start = editor.coordsFromIndex(interval[0]);
  var end = editor.coordsFromIndex(interval[1]);
  var mark = editor.markText(start, end, className);
  $(this).addClass(className).data("mark", mark);
}

function clearErrorHighlights() {
  $(".error").find("[data-highlight]").each(function() {
    // Odd, from the CodeMirror docs you'd think this would remove
    // the class from the highlighted text, too, but it doesn't.
    // I guess we're just garbage collecting here.
    $(this).data("mark").clear();
  });
  for (var i = 1; i <= 5; i++)
    $(".CodeMirror .highlight-" + i).removeClass("highlight-" + i);
}

function updatePreview(html) {
  $(".error").hide();
  var doc = $(".preview").contents()[0];
  doc.open();
  doc.write(html);
  doc.close();
}

function onChange() {
  var html = editor.getValue();
  var result = Slowparse.HTML(document, html);
  clearErrorHighlights();
  if (result.error) {
    reportError(result.error);
  } else {
    updatePreview(html);
  }
}

$(window).load(function() {
  $(".html").val($("#initial-html").text().trim());
  $("#templates .error-msgs").load("../error-msgs.html", function() {
    editor = CodeMirror.fromTextArea($(".html")[0], {
      mode: "text/html",
      theme: "jsbin",
      tabMode: "indent",
      lineWrapping: true,
      lineNumbers: true,
      onChange: onChange
    });
    editor.focus();
    onChange();
  });
});
</script>
