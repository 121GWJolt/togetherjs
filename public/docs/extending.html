<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <title>
      Mozilla Labs : TogetherJS
    </title>
    <meta name="viewport" content="width=320; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;"/>
    <meta name="description" content="Real time collaboration features for your website or app.">
    <meta name="author" content="">
    <link rel="shortcut icon" href="../images/fav-icon.png">

    <script src="../js/jquery-1.10.2.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/parallax.js"></script>
    <script src="../js/custom.js"></script>
    <script src="../js/scrollTo.js"></script>
    <script src="../js/waypoints.min.js"></script>
    <script src="../js/how-animations.js"></script>

    <!-- retina library -->
    <script src="../js/retina.js"></script>

    <script src="//mozorg.cdn.mozilla.net/tabzilla/tabzilla.js"></script>
    <script src="//mozorg.cdn.mozilla.net/{locale}/tabzilla/tabzilla.js"></script>

    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-35433268-28']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>

    <!-- Bootstrap core CSS -->
    <link href="../css/bootstrap.css" rel="stylesheet">
    <link href="../css/jumbotron.css" rel="stylesheet">
    <link href="../css/carousel.css" rel="stylesheet">
    <link href="../css/grid.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
    <link href="//mozorg.cdn.mozilla.net/media/css/tabzilla-min.css" rel="stylesheet" />

    

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js">
      </script>
    <![endif]-->
    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="../assets/ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">

  </head>
  <body>
    <div class="navbar navbar-inverse navbar-fixed-top main-header" id="main-navbar">

      <!-- Tabzilla -->
      <a href="https://www.mozilla.org/" id="tabzilla">mozilla</a>

      <!-- start container -->
      <div class="container navbox">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand main-logo scrollnav" href=".././"></a>
          <a class="navbar-brand masthead-title" href=".././">TogetherJS</a>
        </div>

        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right main-nav">
          
          
          </ul>
        </div><!--/.navbar-collapse -->

      </div>
    </div>



    


<div class="container">
  <section class="row" id="markdownpages">
    <div class="col-md-3">
      <div class="panel" role="complementary" data-spy="affix" data-offset-top="200" id="sidenav">
        <ul class="nav">
          <li><a href="#quick-start" class="scrollnavdocs">Quick Start</a></li>
          <li><a href="#about-audio-chat-and-webrtc" class="scrollnavdocs">About Audio Chat and WebRTC</a></li>
          <li><a href="#addons" class="scrollnavdocs">Addons</a></li>
          <li><a href="#contributing" class="scrollnavdocs">Contributing</a></li>
          <li><a href="#extending-togetherjs" class="scrollnavdocs">Extending TogetherJS</a></li>
          <li><a href="#hosting-the-hub-server" class="scrollnavdocs">Hosting the Hub Server</a></li>
          <li><a href="#browser-support" class="scrollnavdocs">Browser Support</a></li>
        </ul>
      </div>
    </div>
    <div class="col-md-9">
      <h1>Extending TogetherJS</h1>
      
<p>This page documents some of the ways you can customize the TowTruck experience on your site.  Especially how you can extend TowTruck to synchronize parts of your application that require special treatment.</p>
<h3 id="work-in-progress">Work in progress</h3>
<p>We‘re still working on this part, and your feedback is especially important.  We’re using the <a href="https://github.com/mozilla/towtruck/issues?labels=extending&amp;milestone=&amp;page=1&amp;state=open">extending</a> label to categorize tickets related to this.  If you have a use case you&#39;d like us to address, please <a href="https://github.com/mozilla/towtruck/issues/new">open a new issue</a> and describe it – and don‘t be shy, if it’s a problem that can be solved with the API we‘ve already implemented we don’t mind describing how to use it in detail in a ticket.</p>
<h3 id="configuring-events">Configuring events</h3>
<p>Like other configuration, you may not wish to set up these callbacks before <code>towtruck.js</code> is loaded.  You can do that with the <code>&quot;on&quot;</code> configuration parameter, like:</p>
<pre><code class="lang-js">TowTruckConfig_on = {
  ready: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>}
};</code></pre>
<p>Or if you want to set things separately you can do:</p>
<pre><code class="lang-js">TowTruckConfig_on_ready = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>};</code></pre>
<h2 id="communication-channel">Communication Channel</h2>
<p>If you have a component you want to synchronize between two clients, you&#39;ll want to use the TowTruck communication channel.  This is a broadcast channel – any message you send is sent to everyone else in the session (which can also be no one), and includes people who are on different pages.</p>
<p>All messages are JSON objects with a <code>type</code> property.  Custom application messages are put into their own namespace.  So imagine you want to keep an element hidden or visible on all clients, in a synchronized way, and when the element visibility changes an event is fired, <code>MyApp.emit(&quot;visibilityChange&quot;, element, isVisible)</code>:</p>
<pre><code class="lang-js">TowTruckConfig_on_ready = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  MyApp.on(<span class="string">"visibilityChange"</span>, fireTowTruckVisibility);
};
TowTruckConfig_on_close = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  MyApp.off(<span class="string">"visibilityChange"</span>, fireTowTruckVisibility);
};</code></pre>
<p>Now when TowTruck is activated we&#39;ll call <code>fireTowTruckVisibility(el, isVisible)</code>.  Now we have to write that function:</p>
<pre><code class="lang-js"><span class="function"><span class="keyword">function</span> <span class="title">fireTowTruckVisibility</span><span class="params">(element, isVisible)</span> {</span>
  TowTruck.send({type: <span class="string">"visibilityChange"</span>, isVisible: isVisible, element: element});
}</code></pre>
<p>Well, that‘s not quite right, we have to send a JSON object, and we can’t send <code>element</code>.  Instead we need to give an identifier for the element.  TowTruck has a helpful function for that, which will require us to import the <code>elementFinder</code> module:</p>
<pre><code class="lang-js"><span class="function"><span class="keyword">function</span> <span class="title">fireTowTruckVisibility</span><span class="params">(element, isVisible)</span> {</span>
  <span class="keyword">var</span> elementFinder = TowTruck.require(<span class="string">"elementFinder"</span>);
  <span class="keyword">var</span> location = elementFinder.elementLocation(element);
  TowTruck.send({type: <span class="string">"visibilityChange"</span>, isVisible: isVisible, element: location});
}</code></pre>
<p>Then we also have to listen for the message.  We can setup this listener right away (without using the ready/close TowTruck events) because when TowTruck isn&#39;t on then the event will just not fire:</p>
<pre><code class="lang-js">TowTruck.hub.on(<span class="string">"visibilityChange"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
  <span class="keyword">var</span> elementFinder = TowTruck.require(<span class="string">"elementFinder"</span>);
  <span class="comment">// If the element can't be found this will throw an exception:</span>
  <span class="keyword">var</span> element = elementFinder.findElement(msg.element);
  MyApp.changeVisibility(element, msg.isVisible);
});</code></pre>
<p>This has two major problems though: when you call <code>MyApp.changeVisibility</code> it will probably fire a <code>visibilityChange</code> event, which will cause another <code>fireTowTruckVisibility</code> call.  The result may or may not be circular, but it‘s definitely not efficient.  Another problem is that you can get messages from peers who are at a different URL.  We’ll use a simple global variable to handle the first case, and <code>msg.sameUrl</code> to fix the second:</p>
<pre><code class="lang-js"><span class="keyword">var</span> visibilityChangeFromRemote = <span class="literal">false</span>;

<span class="function"><span class="keyword">function</span> <span class="title">fireTowTruckVisibility</span><span class="params">(element, isVisible)</span> {</span>
  <span class="keyword">if</span> (visibilityChangeFromRemote) {
    <span class="keyword">return</span>;
  }
  <span class="keyword">var</span> elementFinder = TowTruck.require(<span class="string">"elementFinder"</span>);
  <span class="keyword">var</span> location = elementFinder.elementLocation(element);
  TowTruck.send({type: <span class="string">"visibilityChange"</span>, isVisible: isVisible, element: location});
}

TowTruck.hub.on(<span class="string">"visibilityChange"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
  <span class="keyword">if</span> (! msg.sameUrl) {
    <span class="keyword">return</span>;
  }
  <span class="keyword">var</span> elementFinder = TowTruck.require(<span class="string">"elementFinder"</span>);
  <span class="comment">// If the element can't be found this will throw an exception:</span>
  <span class="keyword">var</span> element = elementFinder.findElement(msg.element);
  visibilityChangeFromRemote = <span class="literal">true</span>;
  <span class="keyword">try</span> {
    MyApp.changeVisibility(element, msg.isVisible);
  } <span class="keyword">finally</span> {
    visibilityChangeFromRemote = <span class="literal">false</span>;
  }
});</code></pre>
<p>Now we‘re getting close, except for one last problem: these events sync everything when the users are on the same page, but there may be a late comer whose page won’t be in sync with everything else.  An event <code>towtruck.hello</code> will fire when a person appears on a new page, and we can use to that send all our state.  To do this we&#39;ll imagine the <code>MyApp</code> object has a function like <code>MyApp.allToggleElements()</code> that returns a list of elements that we&#39;d be expected to sync.</p>
<pre><code class="lang-js">TowTruck.hub.on(<span class="string">"towtruck.hello"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
  <span class="keyword">if</span> (! msg.sameUrl) {
    <span class="keyword">return</span>;
  }
  MyApp.allToggleElements.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
    <span class="keyword">var</span> isVisible = $(el).is(<span class="string">":visible"</span>);
    fireTowTruckVisibility(el, isVisible);
  });
});</code></pre>
<p>You‘ll notice that multiple clients might do this reset.  This is an open question for us, and in the future we’ll provide a higher-level API for this kind of initialization.</p>
<h3 id="implementing-those-visibility-function-from-jquery">Implementing those visibility function from jQuery</h3>
<p>Let‘s say your app doesn’t have all these methods, and you are just using plain ol‘ jQuery.  Here’s how you might implement them each; you&#39;ll just have to start using <code>$(el).syncShow()</code> and <code>$(el).syncHide()</code> to do your showing and hiding:</p>
<pre><code class="lang-js">$.fn.syncShow = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">this</span>.show();
  <span class="keyword">this</span>.trigger(<span class="string">"visibilityChange"</span>);
};

$.fn.syncHide = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">this</span>.hide();
  <span class="keyword">this</span>.trigger(<span class="string">"visibilityChange"</span>);
};

$(document).on(<span class="string">"visibilityChange"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  MyApp.emit(<span class="string">"visibilityChange"</span>, <span class="keyword">this</span>, $(<span class="keyword">this</span>).is(<span class="string">":visible"</span>));
});

MyApp.changeVisibility = <span class="function"><span class="keyword">function</span> <span class="params">(el, isVisible)</span> {</span>
  <span class="keyword">if</span> (isVisible &amp;&amp; ! el.is(<span class="string">":visible"</span>)) {
    el.syncShow();
  } <span class="keyword">else</span> <span class="keyword">if</span> ((! isVisible) &amp;&amp; el.is(<span class="string">":visible"</span>)) {
    el.syncHide();
  }
};</code></pre>
<h2 id="setting-identity-information">Setting identity information</h2>
<p>There‘s a good chance your application has its own identity, and you know the name of the user, and perhaps have an avatar.  (If you don’t have an avatar but do have an email, you might want to use that to make a Gravatar.)</p>
<p>To see an example of this see <code>/example/app-integration</code></p>
<p>To do this you configure TowTruck with some functions:</p>
<p><code>TowTruckConfig_getUserName = function () {return &#39;User Name&#39;;};</code></p>
<p>This returns the user‘s name (or nick).  Return null if you can’t determine the name.</p>
<p><code>TowTruckConfig_getUserAvatar = function () {return avatarUrl;};</code></p>
<p>This returns a URL to the user‘s avatar.  It should be 40px square.  Again return null if you aren’t sure.</p>
<p><code>TowTruckConfig_getUserColor = function () {return &#39;#ff00ff&#39;;};</code></p>
<p>This returns the user&#39;s preferred color that represents them.  This should be a CSS color.</p>
<p>If any of these values are updated while in the page (like if you have a login process that doesn&#39;t cause a page reload) then call <code>TowTruck.refreshUserData()</code> and the respective <code>getUser*</code> callbacks will all be called again.</p>
<p>See <a href="https://github.com/mozilla/towtruck/issues/504">#504</a> for a bug related to improving this support.</p>
<h2 id="codetowtruckreinitializecode"><code>TowTruck.reinitialize()</code></h2>
<p>You can run this to try to reinitialize anything TowTruck initializes on page load.  In particular you can use it if there are new textareas or code editors that should be sync&#39;d, but were added dynamically to the page.  E.g.:</p>
<pre><code class="lang-javascript">$(<span class="string">"#form"</span>).append(<span class="string">"&lt;textarea&gt;"</span>);
TowTruck.reinitialize();</code></pre>
<p>(We hope with <a href="https://github.com/mozilla/towtruck/issues/70">#70</a> that this will no longer be necessary.)</p>
<h2 id="towtruck-events">TowTruck events</h2>
<p>The <code>TowTruck</code> object is an event emitter.  It uses the style of <code>TowTruck.on(&quot;event&quot;, handler)</code>.  The available events:</p>
<ul>
<li><code>TowTruck.on(&quot;ready&quot;, function () {})</code>: emitted when TowTruck is fully started up.</li>
<li><code>TowTruck.on(&quot;close&quot;, function () {})</code>: emitted when TowTruck is closed.  This is <em>not</em> emitted when the page simply closes or navigates elsewhere.  It is only closed when TowTruck is specifically stopped.</li>
</ul>
<h2 id="deferring-initialization">Deferring Initialization</h2>
<p>TowTruck starts up automatically as soon as it can, especially when continuing a session.  Sometimes this is problematic, like an application that bootstraps all of its UI after page load.  To defer this initialization, define a function <code>TowTruckConfig_callToStart</code> like:</p>
<pre><code class="lang-js">TowTruckConfig_callToStart = <span class="function"><span class="keyword">function</span> <span class="params">(callback)</span> {</span>
  MyApp.onload = callback;
};</code></pre>
<p>In this example when <code>MyApp.onload()</code> is called, TowTruck will start to initialize itself.  Note that calling <code>TowTruck.reinitialize()</code> might be sufficient for your application&#39;s needs if it does a lot of setup after the page loads.</p>
<h2 id="invitation">Invitation</h2>
<p>Sometimes instead of having the user invite someone to TowTruck you might want to handle the invitation internally in your app.  So typically when the person started TowTruck, you&#39;d want to find some other person they want to collaborate with and send the TowTruck link to them.  To get at the TowTruck link:</p>
<pre><code class="lang-js">TowTruckConfig_on_ready = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  sendTowTruckURLToServer(TowTruck.shareUrl());
};</code></pre>
<p>If you call <code>TowTruck.shareUrl()</code> before TowTruck is initialized it will return <code>null</code>.</p>
<h2 id="getting-at-the-innards">Getting At The Innards</h2>
<p>You can still get at TowTruck, even if you can&#39;t rely on the internals not to change underneath you.  (You would be well recommended to deploy your own copy of the client if you do this stuff.)</p>
<p>Most of the TowTruck features are implemented as individual modules, so it should be possible to introduce your own module to do many of the same things.  The most important thing is the <code>session</code> module, and sending and receiving messages.</p>
<p>To get the session module (or any module) you can run this after TowTruck starts:</p>
<pre><code class="lang-javascript"><span class="keyword">var</span> session = TowTruck.require(<span class="string">"session"</span>);</code></pre>
<p>This assumes that the module has already been loaded… but that assumption would be correct once TowTruck has started.</p>
<p>Then there are two interesting methods:</p>
<pre><code class="lang-javascript">session.send({type: <span class="string">"my-custom-type"</span>, attr: value});
session.hub.on(<span class="string">"my-custom-type"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
  alert(msg.value);
});</code></pre>
<p>I.e., <code>session.send()</code> and <code>session.hub.on()</code>.  As you can see the messages are dispatched based on <code>msg.type</code>.  These messages are broadcasted to all other participants.  Note that the messages are <em>always</em> sent, even if the other person is at a different URL.  To check if an incoming message comes from a person on the same page as you, check <code>msg.sameUrl</code> (<code>msg.url</code> shows the actual URL of the other person).</p>

    </div>
  </section>
  



        <hr>

        <footer>

          <section class="row" id="footer">
            <div class="col-xs-3 text-left">
              <p><a href="https://mozillalabs.com/en-US/" target="_blank"><img src="../images/footer-mozilla-labs.png"></a></p>
            </div>
            <div class="col-xs-3">
              <ul class="list-unstyled text-left">
                <li class=""><a href=".././" class="scrollnav">Overview</a></li>
                <li><a href=".././docs/developers-getting-started.html" target="_blank">Docs</a></li>
                <li class=""><a href="mailto:towtruck@mozilla.com" target="_blank">Contact</a></li>
              </ul>
            </div>
            <div class="col-xs-3">
              <ul class="list-unstyled text-left">
                <li class=""><a href="https://mozillalabs.com/en-US/towtruck/" target="_blank">About</a></li>
                <li class=""><a href="https://github.com/mozilla/towtruck" target="_blank">Github</a></li>
                <li><a href="../source/analytics.js.html">Source Code</a></li>
                <li><a href="../faq.html">FAQ</a></li>
                <li class=""><a href="https://twitter.com/moztowtruck" target="_blank">Twitter</a></li>
              </ul>
            </div>
            <div class="col-xs-3">
              <ul class="list-unstyled text-left">
                <li class=""><a href="https://www.mozilla.org/en-US/privacy-policy.html" target="_blank">Privacy Policy</a></li>
                <li class=""><a href="https://www.mozilla.org/en-US/about/legal.html" target="_blank">Legal Notices</a></li>
                <li class=""><a href="https://www.mozilla.org/en-US/legal/fraud-report/index.html" target="_blank">Report Trademark Abuses</a></li>
              </ul>
            </div>
          </section>
        </footer>
      </section>

    </div> <!-- /container -->

  </body>
</html>
