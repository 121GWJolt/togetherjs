<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <title>
      Mozilla Labs : TogetherJS
    </title>
    <meta name="viewport" content="width=320; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;"/>
    <meta name="description" content="Real time collaboration features for your website or app.">
    <meta name="author" content="">
    <link rel="shortcut icon" href="../images/fav-icon.png">

    <script src="../js/jquery-1.10.2.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/parallax.js"></script>
    <script src="../js/custom.js"></script>
    <script src="../js/scrollTo.js"></script>
    <script src="../js/waypoints.min.js"></script>
    <script src="../js/how-animations.js"></script>

    <!-- retina library -->
    <script src="../js/retina.js"></script>

    <script src="//mozorg.cdn.mozilla.net/tabzilla/tabzilla.js"></script>
    <script src="//mozorg.cdn.mozilla.net/{locale}/tabzilla/tabzilla.js"></script>

    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-35433268-28']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>

    <!-- Bootstrap core CSS -->
    <link href="../css/bootstrap.css" rel="stylesheet">
    <link href="../css/jumbotron.css" rel="stylesheet">
    <link href="../css/carousel.css" rel="stylesheet">
    <link href="../css/grid.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
    <link href="//mozorg.cdn.mozilla.net/media/css/tabzilla-min.css" rel="stylesheet" />

    
  <link rel="stylesheet" href="../css/docco.css">
  <script src="../js/source-code.js"></script>


    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js">
      </script>
    <![endif]-->
    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="../assets/ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">

  </head>
  <body>
    <div class="navbar navbar-inverse navbar-fixed-top main-header" id="main-navbar">

      <!-- Tabzilla -->
      <a href="https://www.mozilla.org/" id="tabzilla">mozilla</a>

      <!-- start container -->
      <div class="container navbox">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand main-logo scrollnav" href=".././"></a>
          <a class="navbar-brand masthead-title" href=".././">TogetherJS</a>
        </div>

        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right main-nav">
            <li><a href=".././"  >Overview</a></li>
            <li><a href=".././docs/developers-getting-started.html"  >Docs</a></li>
            <li><a href="mailto:towtruck@mozilla.com">Contact</a></li>
          </ul>
        </div><!--/.navbar-collapse -->

      </div>
    </div>


    

<div class="container">

    <section class="row" id="sourcecode">
      <div class="col-md-3" id="source-toc">
        <div class="panel" role="complementary" data-spy="affix" data-offset-top="200" id="sidenav">
          <div class="panel-heading">Source Code</div>
          <ul class="nav">
            
              <li><a href="analytics.js.html">analytics</a></li>
            
              <li><a href="channels.js.html">channels</a></li>
            
              <li><a href="chat.js.html">chat</a></li>
            
              <li><a href="cursor.js.html">cursor</a></li>
            
              <li><a href="elementFinder.js.html">elementFinder</a></li>
            
              <li><a href="eventMaker.js.html">eventMaker</a></li>
            
              <li><a href="forms.js.html">forms</a></li>
            
              <li><a href="jqueryPlugins.js.html">jqueryPlugins</a></li>
            
              <li><a href="linkify.js.html">linkify</a></li>
            
              <li><a href="ot.js.html">ot</a></li>
            
              <li><a href="peers.js.html">peers</a></li>
            
              <li><a href="playback.js.html">playback</a></li>
            
              <li><a href="presence.js.html">presence</a></li>
            
              <li><a href="randomutil.js.html">randomutil</a></li>
            
              <li><a href="recorder.js.html">recorder</a></li>
            
              <li><a href="session.js.html">session</a></li>
            
              <li><a href="startup.js.html">startup</a></li>
            
              <li><a href="storage.js.html">storage</a></li>
            
              <li><a href="templates.js.html">templates</a></li>
            
              <li><a href="templating.js.html">templating</a></li>
            
              <li><a href="towtruck.js.html">towtruck</a></li>
            
              <li><a href="towtruckPackage.js.html">towtruckPackage</a></li>
            
              <li><a href="ui.js.html">ui</a></li>
            
              <li><a href="util.js.html">util</a></li>
            
              <li><a href="visibilityApi.js.html">visibilityApi</a></li>
            
              <li><a href="walkthrough.js.html">walkthrough</a></li>
            
              <li><a href="webrtc.js.html">webrtc</a></li>
            
              <li><a href="windowing.js.html">windowing</a></li>
            
          </ul>
        </div>
      </div>

      <div class="col-md-9" id="source-content">
        <h1>towtruckPackage.js</h1>
        

        <div class="small"><a href="https://github.com/mozilla/towtruck/blob/develop/towtruck/towtruckPackage.js">See this file on Github</a></div>

        <ul class="sections">
          
            <li id="section-0">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-0">&#182;</a>
                </div>
                
              </div>
              
                <div class="content"><div class='highlight'><pre>(<span class="keyword">function</span>() {
<span class="comment">/**
 * almond 0.2.5 Copyright (c) 2011-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */</span></pre></div></div>
              
            </li>
          
            <li id="section-1">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-1">&#182;</a>
                </div>
                <p>Going sloppy to avoid &#39;use strict&#39; string cost, but strict practices should
be followed.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre><span class="comment">/*jslint sloppy: true */</span>
<span class="comment">/*global setTimeout: false */</span>

<span class="keyword">var</span> requirejs, require, define;
(<span class="function"><span class="keyword">function</span> <span class="params">(undef)</span> {</span>
    <span class="keyword">var</span> main, req, makeMap, handlers,
        defined = {},
        waiting = {},
        config = {},
        defining = {},
        hasOwn = Object.prototype.hasOwnProperty,
        aps = [].slice;

    <span class="function"><span class="keyword">function</span> <span class="title">hasProp</span><span class="params">(obj, prop)</span> {</span>
        <span class="keyword">return</span> hasOwn.call(obj, prop);
    }

    <span class="comment">/**
     * Given a relative module name, like ./something, normalize it to
     * a real name that can be mapped to a path.
     * @param {String} name the relative name
     * @param {String} baseName a real name that the name arg is relative
     * to.
     * @returns {String} normalized name
     */</span>
    <span class="function"><span class="keyword">function</span> <span class="title">normalize</span><span class="params">(name, baseName)</span> {</span>
        <span class="keyword">var</span> nameParts, nameSegment, mapValue, foundMap,
            foundI, foundStarMap, starI, i, j, part,
            baseParts = baseName &amp;&amp; baseName.split(<span class="string">"/"</span>),
            map = config.map,
            starMap = (map &amp;&amp; map[<span class="string">'*'</span>]) || {};</pre></div></div>
              
            </li>
          
            <li id="section-2">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-2">&#182;</a>
                </div>
                <p>Adjust any relative paths.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (name &amp;&amp; name.charAt(<span class="number">0</span>) === <span class="string">"."</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-3">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-3">&#182;</a>
                </div>
                <p>If have a base name, try to normalize against it,
otherwise, assume it is a top-level require that will
be relative to baseUrl in the end.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (baseName) {</pre></div></div>
              
            </li>
          
            <li id="section-4">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-4">&#182;</a>
                </div>
                <p>Convert baseName to array, and lop off the last part,
so that . matches that &quot;directory&quot; and not name of the baseName&#39;s
module. For instance, baseName of &quot;one/two/three&quot;, maps to
&quot;one/two/three.js&quot;, but we want the directory, &quot;one/two&quot; for
this normalization.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>                baseParts = baseParts.slice(<span class="number">0</span>, baseParts.length - <span class="number">1</span>);

                name = baseParts.concat(name.split(<span class="string">"/"</span>));</pre></div></div>
              
            </li>
          
            <li id="section-5">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-5">&#182;</a>
                </div>
                <p>start trimDots</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; name.length; i += <span class="number">1</span>) {
                    part = name[i];
                    <span class="keyword">if</span> (part === <span class="string">"."</span>) {
                        name.splice(i, <span class="number">1</span>);
                        i -= <span class="number">1</span>;
                    } <span class="keyword">else</span> <span class="keyword">if</span> (part === <span class="string">".."</span>) {
                        <span class="keyword">if</span> (i === <span class="number">1</span> &amp;&amp; (name[<span class="number">2</span>] === <span class="string">'..'</span> || name[<span class="number">0</span>] === <span class="string">'..'</span>)) {</pre></div></div>
              
            </li>
          
            <li id="section-6">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-6">&#182;</a>
                </div>
                <p>End of the line. Keep at least one non-dot
path segment at the front so it can be mapped
correctly to disk. Otherwise, there is likely
no path mapping for a path starting with &#39;..&#39;.
This can still fail, but catches the most reasonable
uses of ..</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>                            <span class="keyword">break</span>;
                        } <span class="keyword">else</span> <span class="keyword">if</span> (i &gt; <span class="number">0</span>) {
                            name.splice(i - <span class="number">1</span>, <span class="number">2</span>);
                            i -= <span class="number">2</span>;
                        }
                    }
                }</pre></div></div>
              
            </li>
          
            <li id="section-7">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-7">&#182;</a>
                </div>
                <p>end trimDots</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>                name = name.join(<span class="string">"/"</span>);
            } <span class="keyword">else</span> <span class="keyword">if</span> (name.indexOf(<span class="string">'./'</span>) === <span class="number">0</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-8">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-8">&#182;</a>
                </div>
                <p>No baseName, so this is ID is resolved relative
to baseUrl, pull off the leading dot.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>                name = name.substring(<span class="number">2</span>);
            }
        }</pre></div></div>
              
            </li>
          
            <li id="section-9">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-9">&#182;</a>
                </div>
                <p>Apply map config if available.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> ((baseParts || starMap) &amp;&amp; map) {
            nameParts = name.split(<span class="string">'/'</span>);

            <span class="keyword">for</span> (i = nameParts.length; i &gt; <span class="number">0</span>; i -= <span class="number">1</span>) {
                nameSegment = nameParts.slice(<span class="number">0</span>, i).join(<span class="string">"/"</span>);

                <span class="keyword">if</span> (baseParts) {</pre></div></div>
              
            </li>
          
            <li id="section-10">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-10">&#182;</a>
                </div>
                <p>Find the longest baseName segment match in the config.
So, do joins on the biggest to smallest lengths of baseParts.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>                    <span class="keyword">for</span> (j = baseParts.length; j &gt; <span class="number">0</span>; j -= <span class="number">1</span>) {
                        mapValue = map[baseParts.slice(<span class="number">0</span>, j).join(<span class="string">'/'</span>)];</pre></div></div>
              
            </li>
          
            <li id="section-11">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-11">&#182;</a>
                </div>
                <p>baseName segment has  config, find if it has one for
this name.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>                        <span class="keyword">if</span> (mapValue) {
                            mapValue = mapValue[nameSegment];
                            <span class="keyword">if</span> (mapValue) {</pre></div></div>
              
            </li>
          
            <li id="section-12">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-12">&#182;</a>
                </div>
                <p>Match, update name to the new value.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>                                foundMap = mapValue;
                                foundI = i;
                                <span class="keyword">break</span>;
                            }
                        }
                    }
                }

                <span class="keyword">if</span> (foundMap) {
                    <span class="keyword">break</span>;
                }</pre></div></div>
              
            </li>
          
            <li id="section-13">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-13">&#182;</a>
                </div>
                <p>Check for a star map match, but just hold on to it,
if there is a shorter segment match later in a matching
config, then favor over this star map.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (!foundStarMap &amp;&amp; starMap &amp;&amp; starMap[nameSegment]) {
                    foundStarMap = starMap[nameSegment];
                    starI = i;
                }
            }

            <span class="keyword">if</span> (!foundMap &amp;&amp; foundStarMap) {
                foundMap = foundStarMap;
                foundI = starI;
            }

            <span class="keyword">if</span> (foundMap) {
                nameParts.splice(<span class="number">0</span>, foundI, foundMap);
                name = nameParts.join(<span class="string">'/'</span>);
            }
        }

        <span class="keyword">return</span> name;
    }

    <span class="function"><span class="keyword">function</span> <span class="title">makeRequire</span><span class="params">(relName, forceSync)</span> {</span>
        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-14">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-14">&#182;</a>
                </div>
                <p>A version of a require function that passes a moduleName
value for items that may need to
look up paths relative to the moduleName</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> req.apply(undef, aps.call(arguments, <span class="number">0</span>).concat([relName, forceSync]));
        };
    }

    <span class="function"><span class="keyword">function</span> <span class="title">makeNormalize</span><span class="params">(relName)</span> {</span>
        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(name)</span> {</span>
            <span class="keyword">return</span> normalize(name, relName);
        };
    }

    <span class="function"><span class="keyword">function</span> <span class="title">makeLoad</span><span class="params">(depName)</span> {</span>
        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(value)</span> {</span>
            defined[depName] = value;
        };
    }

    <span class="function"><span class="keyword">function</span> <span class="title">callDep</span><span class="params">(name)</span> {</span>
        <span class="keyword">if</span> (hasProp(waiting, name)) {
            <span class="keyword">var</span> args = waiting[name];
            <span class="keyword">delete</span> waiting[name];
            defining[name] = <span class="literal">true</span>;
            main.apply(undef, args);
        }

        <span class="keyword">if</span> (!hasProp(defined, name) &amp;&amp; !hasProp(defining, name)) {
            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'No '</span> + name);
        }
        <span class="keyword">return</span> defined[name];
    }</pre></div></div>
              
            </li>
          
            <li id="section-15">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-15">&#182;</a>
                </div>
                <p>Turns a plugin!resource to [plugin, resource]
with the plugin being undefined if the name
did not have a plugin prefix.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="function"><span class="keyword">function</span> <span class="title">splitPrefix</span><span class="params">(name)</span> {</span>
        <span class="keyword">var</span> prefix,
            index = name ? name.indexOf(<span class="string">'!'</span>) : -<span class="number">1</span>;
        <span class="keyword">if</span> (index &gt; -<span class="number">1</span>) {
            prefix = name.substring(<span class="number">0</span>, index);
            name = name.substring(index + <span class="number">1</span>, name.length);
        }
        <span class="keyword">return</span> [prefix, name];
    }

    <span class="comment">/**
     * Makes a name map, normalizing the name, and using a plugin
     * for normalization if necessary. Grabs a ref to plugin
     * too, as an optimization.
     */</span>
    makeMap = <span class="function"><span class="keyword">function</span> <span class="params">(name, relName)</span> {</span>
        <span class="keyword">var</span> plugin,
            parts = splitPrefix(name),
            prefix = parts[<span class="number">0</span>];

        name = parts[<span class="number">1</span>];

        <span class="keyword">if</span> (prefix) {
            prefix = normalize(prefix, relName);
            plugin = callDep(prefix);
        }</pre></div></div>
              
            </li>
          
            <li id="section-16">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-16">&#182;</a>
                </div>
                <p>Normalize according</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (prefix) {
            <span class="keyword">if</span> (plugin &amp;&amp; plugin.normalize) {
                name = plugin.normalize(name, makeNormalize(relName));
            } <span class="keyword">else</span> {
                name = normalize(name, relName);
            }
        } <span class="keyword">else</span> {
            name = normalize(name, relName);
            parts = splitPrefix(name);
            prefix = parts[<span class="number">0</span>];
            name = parts[<span class="number">1</span>];
            <span class="keyword">if</span> (prefix) {
                plugin = callDep(prefix);
            }
        }</pre></div></div>
              
            </li>
          
            <li id="section-17">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-17">&#182;</a>
                </div>
                <p>Using ridiculous property names for space reasons</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> {
            f: prefix ? prefix + <span class="string">'!'</span> + name : name, <span class="comment">//fullName</span>
            n: name,
            pr: prefix,
            p: plugin
        };
    };

    <span class="function"><span class="keyword">function</span> <span class="title">makeConfig</span><span class="params">(name)</span> {</span>
        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            <span class="keyword">return</span> (config &amp;&amp; config.config &amp;&amp; config.config[name]) || {};
        };
    }

    handlers = {
        require: <span class="function"><span class="keyword">function</span> <span class="params">(name)</span> {</span>
            <span class="keyword">return</span> makeRequire(name);
        },
        exports: <span class="function"><span class="keyword">function</span> <span class="params">(name)</span> {</span>
            <span class="keyword">var</span> e = defined[name];
            <span class="keyword">if</span> (<span class="keyword">typeof</span> e !== <span class="string">'undefined'</span>) {
                <span class="keyword">return</span> e;
            } <span class="keyword">else</span> {
                <span class="keyword">return</span> (defined[name] = {});
            }
        },
        module: <span class="function"><span class="keyword">function</span> <span class="params">(name)</span> {</span>
            <span class="keyword">return</span> {
                id: name,
                uri: <span class="string">''</span>,
                exports: defined[name],
                config: makeConfig(name)
            };
        }
    };

    main = <span class="function"><span class="keyword">function</span> <span class="params">(name, deps, callback, relName)</span> {</span>
        <span class="keyword">var</span> cjsModule, depName, ret, map, i,
            args = [],
            usingExports;</pre></div></div>
              
            </li>
          
            <li id="section-18">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-18">&#182;</a>
                </div>
                <p>Use name if no relName</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        relName = relName || name;</pre></div></div>
              
            </li>
          
            <li id="section-19">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-19">&#182;</a>
                </div>
                <p>Call the callback to define the module, if necessary.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (<span class="keyword">typeof</span> callback === <span class="string">'function'</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-20">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-20">&#182;</a>
                </div>
                <p>Pull out the defined dependencies and pass the ordered
values to the callback.
Default to [require, exports, module] if no deps</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>            deps = !deps.length &amp;&amp; callback.length ? [<span class="string">'require'</span>, <span class="string">'exports'</span>, <span class="string">'module'</span>] : deps;
            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; deps.length; i += <span class="number">1</span>) {
                map = makeMap(deps[i], relName);
                depName = map.f;</pre></div></div>
              
            </li>
          
            <li id="section-21">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-21">&#182;</a>
                </div>
                <p>Fast path CommonJS standard dependencies.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (depName === <span class="string">"require"</span>) {
                    args[i] = handlers.require(name);
                } <span class="keyword">else</span> <span class="keyword">if</span> (depName === <span class="string">"exports"</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-22">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-22">&#182;</a>
                </div>
                <p>CommonJS module spec 1.1</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>                    args[i] = handlers.exports(name);
                    usingExports = <span class="literal">true</span>;
                } <span class="keyword">else</span> <span class="keyword">if</span> (depName === <span class="string">"module"</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-23">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-23">&#182;</a>
                </div>
                <p>CommonJS module spec 1.1</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>                    cjsModule = args[i] = handlers.module(name);
                } <span class="keyword">else</span> <span class="keyword">if</span> (hasProp(defined, depName) ||
                           hasProp(waiting, depName) ||
                           hasProp(defining, depName)) {
                    args[i] = callDep(depName);
                } <span class="keyword">else</span> <span class="keyword">if</span> (map.p) {
                    map.p.load(map.n, makeRequire(relName, <span class="literal">true</span>), makeLoad(depName), {});
                    args[i] = defined[depName];
                } <span class="keyword">else</span> {
                    <span class="keyword">throw</span> <span class="keyword">new</span> Error(name + <span class="string">' missing '</span> + depName);
                }
            }

            ret = callback.apply(defined[name], args);

            <span class="keyword">if</span> (name) {</pre></div></div>
              
            </li>
          
            <li id="section-24">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-24">&#182;</a>
                </div>
                <p>If setting exports via &quot;module&quot; is in play,
favor that over return value and exports. After that,
favor a non-undefined return value over exports use.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (cjsModule &amp;&amp; cjsModule.exports !== undef &amp;&amp;
                        cjsModule.exports !== defined[name]) {
                    defined[name] = cjsModule.exports;
                } <span class="keyword">else</span> <span class="keyword">if</span> (ret !== undef || !usingExports) {</pre></div></div>
              
            </li>
          
            <li id="section-25">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-25">&#182;</a>
                </div>
                <p>Use the return value from the function.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>                    defined[name] = ret;
                }
            }
        } <span class="keyword">else</span> <span class="keyword">if</span> (name) {</pre></div></div>
              
            </li>
          
            <li id="section-26">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-26">&#182;</a>
                </div>
                <p>May just be an object definition for the module. Only
worry about defining if have a module name.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>            defined[name] = callback;
        }
    };

    requirejs = require = req = <span class="function"><span class="keyword">function</span> <span class="params">(deps, callback, relName, forceSync, alt)</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">typeof</span> deps === <span class="string">"string"</span>) {
            <span class="keyword">if</span> (handlers[deps]) {</pre></div></div>
              
            </li>
          
            <li id="section-27">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-27">&#182;</a>
                </div>
                <p>callback in this case is really relName</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>                <span class="keyword">return</span> handlers[deps](callback);
            }</pre></div></div>
              
            </li>
          
            <li id="section-28">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-28">&#182;</a>
                </div>
                <p>Just return the module wanted. In this scenario, the
deps arg is the module name, and second arg (if passed)
is just the relName.
Normalize module name, if it contains . or ..</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> callDep(makeMap(deps, callback).f);
        } <span class="keyword">else</span> <span class="keyword">if</span> (!deps.splice) {</pre></div></div>
              
            </li>
          
            <li id="section-29">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-29">&#182;</a>
                </div>
                <p>deps is a config object, not an array.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>            config = deps;
            <span class="keyword">if</span> (callback.splice) {</pre></div></div>
              
            </li>
          
            <li id="section-30">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-30">&#182;</a>
                </div>
                <p>callback is an array, which means it is a dependency list.
Adjust args if there are dependencies</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>                deps = callback;
                callback = relName;
                relName = <span class="literal">null</span>;
            } <span class="keyword">else</span> {
                deps = undef;
            }
        }</pre></div></div>
              
            </li>
          
            <li id="section-31">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-31">&#182;</a>
                </div>
                <p>Support require([&#39;a&#39;])</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        callback = callback || <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>};</pre></div></div>
              
            </li>
          
            <li id="section-32">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-32">&#182;</a>
                </div>
                <p>If relName is a function, it is an errback handler,
so remove it.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (<span class="keyword">typeof</span> relName === <span class="string">'function'</span>) {
            relName = forceSync;
            forceSync = alt;
        }</pre></div></div>
              
            </li>
          
            <li id="section-33">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-33">&#182;</a>
                </div>
                <p>Simulate async callback;</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (forceSync) {
            main(undef, deps, callback, relName);
        } <span class="keyword">else</span> {</pre></div></div>
              
            </li>
          
            <li id="section-34">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-34">&#182;</a>
                </div>
                <p>Using a non-zero value because of concern for what old browsers
do, and latest browsers &quot;upgrade&quot; to 4 if lower value is used:
<a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/timers.html#dom-windowtimers-settimeout">http://www.whatwg.org/specs/web-apps/current-work/multipage/timers.html#dom-windowtimers-settimeout</a>:
If want a value immediately, use require(&#39;id&#39;) instead -- something
that works in almond on the global level, but not guaranteed and
unlikely to work in other AMD implementations.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>            setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                main(undef, deps, callback, relName);
            }, <span class="number">4</span>);
        }

        <span class="keyword">return</span> req;
    };

    <span class="comment">/**
     * Just drops the config on the floor, but returns req in case
     * the config return value is used.
     */</span>
    req.config = <span class="function"><span class="keyword">function</span> <span class="params">(cfg)</span> {</span>
        config = cfg;
        <span class="keyword">if</span> (config.deps) {
            req(config.deps, config.callback);
        }
        <span class="keyword">return</span> req;
    };

    define = <span class="function"><span class="keyword">function</span> <span class="params">(name, deps, callback)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-35">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-35">&#182;</a>
                </div>
                <p>This module may not have dependencies</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (!deps.splice) {</pre></div></div>
              
            </li>
          
            <li id="section-36">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-36">&#182;</a>
                </div>
                <p>deps is not an array, so probably means
an object literal or factory function for
the value. Adjust args.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>            callback = deps;
            deps = [];
        }

        if (!hasProp(defined, name) &amp;&amp; !hasProp(waiting, name)) {
            waiting[name] = [name, deps, callback];
        }
    };

    define.amd = {
        jQuery: true
    };
}());

define("libs/almond", function(){});

/*! jQuery v1.8.3 jquery.com | jquery.org/license */
(function(e,t){function _(e){var t=M[e]={};return v.each(e.split(y),function(e,n){t[n]=!0}),t}function H(e,n,r){if(r===t&amp;&amp;e.nodeType===1){var i="data-"+n.replace(P,"-$1").toLowerCase();r=e.getAttribute(i);if(typeof r=="string"){try{r=r==="true"?!0:r==="false"?!1:r==="null"?null:+r+""===r?+r:D.test(r)?v.parseJSON(r):r}catch(s){}v.data(e,n,r)}else r=t}return r}function B(e){var t;for(t in e){if(t==="data"&amp;&amp;v.isEmptyObject(e[t]))continue;if(t!=="toJSON")return!1}return!0}function et(){return!1}function tt(){return!0}function ut(e){return!e||!e.parentNode||e.parentNode.nodeType===11}function at(e,t){do e=e[t];while(e&amp;&amp;e.nodeType!==1);return e}function ft(e,t,n){t=t||0;if(v.isFunction(t))return v.grep(e,function(e,r){var i=!!t.call(e,r,e);return i===n});if(t.nodeType)return v.grep(e,function(e,r){return e===t===n});if(typeof t=="string"){var r=v.grep(e,function(e){return e.nodeType===1});if(it.test(t))return v.filter(t,r,!n);t=v.filter(t,r)}return v.grep(e,function(e,r){return v.inArray(e,t)&gt;=0===n})}function lt(e){var t=ct.split("|"),n=e.createDocumentFragment();if(n.createElement)while(t.length)n.createElement(t.pop());return n}function Lt(e,t){return e.getElementsByTagName(t)[0]||e.appendChild(e.ownerDocument.createElement(t))}function At(e,t){if(t.nodeType!==1||!v.hasData(e))return;var n,r,i,s=v._data(e),o=v._data(t,s),u=s.events;if(u){delete o.handle,o.events={};for(n in u)for(r=0,i=u[n].length;r&lt;i;r++)v.event.add(t,n,u[n][r])}o.data&amp;&amp;(o.data=v.extend({},o.data))}function Ot(e,t){var n;if(t.nodeType!==1)return;t.clearAttributes&amp;&amp;t.clearAttributes(),t.mergeAttributes&amp;&amp;t.mergeAttributes(e),n=t.nodeName.toLowerCase(),n==="object"?(t.parentNode&amp;&amp;(t.outerHTML=e.outerHTML),v.support.html5Clone&amp;&amp;e.innerHTML&amp;&amp;!v.trim(t.innerHTML)&amp;&amp;(t.innerHTML=e.innerHTML)):n==="input"&amp;&amp;Et.test(e.type)?(t.defaultChecked=t.checked=e.checked,t.value!==e.value&amp;&amp;(t.value=e.value)):n==="option"?t.selected=e.defaultSelected:n==="input"||n==="textarea"?t.defaultValue=e.defaultValue:n==="script"&amp;&amp;t.text!==e.text&amp;&amp;(t.text=e.text),t.removeAttribute(v.expando)}function Mt(e){return typeof e.getElementsByTagName!="undefined"?e.getElementsByTagName("*"):typeof e.querySelectorAll!="undefined"?e.querySelectorAll("*"):[]}function _t(e){Et.test(e.type)&amp;&amp;(e.defaultChecked=e.checked)}function Qt(e,t){if(t in e)return t;var n=t.charAt(0).toUpperCase()+t.slice(1),r=t,i=Jt.length;while(i--){t=Jt[i]+n;if(t in e)return t}return r}function Gt(e,t){return e=t||e,v.css(e,"display")==="none"||!v.contains(e.ownerDocument,e)}function Yt(e,t){var n,r,i=[],s=0,o=e.length;for(;s&lt;o;s++){n=e[s];if(!n.style)continue;i[s]=v._data(n,"olddisplay"),t?(!i[s]&amp;&amp;n.style.display==="none"&amp;&amp;(n.style.display=""),n.style.display===""&amp;&amp;Gt(n)&amp;&amp;(i[s]=v._data(n,"olddisplay",nn(n.nodeName)))):(r=Dt(n,"display"),!i[s]&amp;&amp;r!=="none"&amp;&amp;v._data(n,"olddisplay",r))}for(s=0;s&lt;o;s++){n=e[s];if(!n.style)continue;if(!t||n.style.display==="none"||n.style.display==="")n.style.display=t?i[s]||"":"none"}return e}function Zt(e,t,n){var r=Rt.exec(t);return r?Math.max(0,r[1]-(n||0))+(r[2]||"px"):t}function en(e,t,n,r){var i=n===(r?"border":"content")?4:t==="width"?1:0,s=0;for(;i&lt;4;i+=2)n==="margin"&amp;&amp;(s+=v.css(e,n+$t[i],!0)),r?(n==="content"&amp;&amp;(s-=parseFloat(Dt(e,"padding"+$t[i]))||0),n!=="margin"&amp;&amp;(s-=parseFloat(Dt(e,"border"+$t[i]+"Width"))||0)):(s+=parseFloat(Dt(e,"padding"+$t[i]))||0,n!=="padding"&amp;&amp;(s+=parseFloat(Dt(e,"border"+$t[i]+"Width"))||0));return s}function tn(e,t,n){var r=t==="width"?e.offsetWidth:e.offsetHeight,i=!0,s=v.support.boxSizing&amp;&amp;v.css(e,"boxSizing")==="border-box";if(r&lt;=0||r==null){r=Dt(e,t);if(r&lt;0||r==null)r=e.style[t];if(Ut.test(r))return r;i=s&amp;&amp;(v.support.boxSizingReliable||r===e.style[t]),r=parseFloat(r)||0}return r+en(e,t,n||(s?"border":"content"),i)+"px"}function nn(e){if(Wt[e])return Wt[e];var t=v("&lt;"+e+"&gt;").appendTo(i.body),n=t.css("display");t.remove();if(n==="none"||n===""){Pt=i.body.appendChild(Pt||v.extend(i.createElement("iframe"),{frameBorder:0,width:0,height:0}));if(!Ht||!Pt.createElement)Ht=(Pt.contentWindow||Pt.contentDocument).document,Ht.write("&lt;!doctype html&gt;&lt;html&gt;&lt;body&gt;"),Ht.close();t=Ht.body.appendChild(Ht.createElement(e)),n=Dt(t,"display"),i.body.removeChild(Pt)}return Wt[e]=n,n}function fn(e,t,n,r){var i;if(v.isArray(t))v.each(t,function(t,i){n||sn.test(e)?r(e,i):fn(e+"["+(typeof i=="object"?t:"")+"]",i,n,r)});else if(!n&amp;&amp;v.type(t)==="object")for(i in t)fn(e+"["+i+"]",t[i],n,r);else r(e,t)}function Cn(e){return function(t,n){typeof t!="string"&amp;&amp;(n=t,t="*");var r,i,s,o=t.toLowerCase().split(y),u=0,a=o.length;if(v.isFunction(n))for(;u&lt;a;u++)r=o[u],s=/^\+/.test(r),s&amp;&amp;(r=r.substr(1)||"*"),i=e[r]=e[r]||[],i[s?"unshift":"push"](n)}}function kn(e,n,r,i,s,o){s=s||n.dataTypes[0],o=o||{},o[s]=!0;var u,a=e[s],f=0,l=a?a.length:0,c=e===Sn;for(;f&lt;l&amp;&amp;(c||!u);f++)u=a[f](n,r,i),typeof u=="string"&amp;&amp;(!c||o[u]?u=t:(n.dataTypes.unshift(u),u=kn(e,n,r,i,u,o)));return(c||!u)&amp;&amp;!o["*"]&amp;&amp;(u=kn(e,n,r,i,"*",o)),u}function Ln(e,n){var r,i,s=v.ajaxSettings.flatOptions||{};for(r in n)n[r]!==t&amp;&amp;((s[r]?e:i||(i={}))[r]=n[r]);i&amp;&amp;v.extend(!0,e,i)}function An(e,n,r){var i,s,o,u,a=e.contents,f=e.dataTypes,l=e.responseFields;for(s in l)s in r&amp;&amp;(n[l[s]]=r[s]);while(f[0]==="*")f.shift(),i===t&amp;&amp;(i=e.mimeType||n.getResponseHeader("content-type"));if(i)for(s in a)if(a[s]&amp;&amp;a[s].test(i)){f.unshift(s);break}if(f[0]in r)o=f[0];else{for(s in r){if(!f[0]||e.converters[s+" "+f[0]]){o=s;break}u||(u=s)}o=o||u}if(o)return o!==f[0]&amp;&amp;f.unshift(o),r[o]}function On(e,t){var n,r,i,s,o=e.dataTypes.slice(),u=o[0],a={},f=0;e.dataFilter&amp;&amp;(t=e.dataFilter(t,e.dataType));if(o[1])for(n in e.converters)a[n.toLowerCase()]=e.converters[n];for(;i=o[++f];)if(i!=="*"){if(u!=="*"&amp;&amp;u!==i){n=a[u+" "+i]||a["* "+i];if(!n)for(r in a){s=r.split(" ");if(s[1]===i){n=a[u+" "+s[0]]||a["* "+s[0]];if(n){n===!0?n=a[r]:a[r]!==!0&amp;&amp;(i=s[0],o.splice(f--,0,i));break}}}if(n!==!0)if(n&amp;&amp;e["throws"])t=n(t);else try{t=n(t)}catch(l){return{state:"parsererror",error:n?l:"No conversion from "+u+" to "+i}}}u=i}return{state:"success",data:t}}function Fn(){try{return new e.XMLHttpRequest}catch(t){}}function In(){try{return new e.ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}function $n(){return setTimeout(function(){qn=t},0),qn=v.now()}function Jn(e,t){v.each(t,function(t,n){var r=(Vn[t]||[]).concat(Vn["*"]),i=0,s=r.length;for(;i&lt;s;i++)if(r[i].call(e,t,n))return})}function Kn(e,t,n){var r,i=0,s=0,o=Xn.length,u=v.Deferred().always(function(){delete a.elem}),a=function(){var t=qn||$n(),n=Math.max(0,f.startTime+f.duration-t),r=n/f.duration||0,i=1-r,s=0,o=f.tweens.length;for(;s&lt;o;s++)f.tweens[s].run(i);return u.notifyWith(e,[f,i,n]),i&lt;1&amp;&amp;o?n:(u.resolveWith(e,[f]),!1)},f=u.promise({elem:e,props:v.extend({},t),opts:v.extend(!0,{specialEasing:{}},n),originalProperties:t,originalOptions:n,startTime:qn||$n(),duration:n.duration,tweens:[],createTween:function(t,n,r){var i=v.Tween(e,f.opts,t,n,f.opts.specialEasing[t]||f.opts.easing);return f.tweens.push(i),i},stop:function(t){var n=0,r=t?f.tweens.length:0;for(;n&lt;r;n++)f.tweens[n].run(1);return t?u.resolveWith(e,[f,t]):u.rejectWith(e,[f,t]),this}}),l=f.props;Qn(l,f.opts.specialEasing);for(;i&lt;o;i++){r=Xn[i].call(f,e,l,f.opts);if(r)return r}return Jn(f,l),v.isFunction(f.opts.start)&amp;&amp;f.opts.start.call(e,f),v.fx.timer(v.extend(a,{anim:f,queue:f.opts.queue,elem:e})),f.progress(f.opts.progress).done(f.opts.done,f.opts.complete).fail(f.opts.fail).always(f.opts.always)}function Qn(e,t){var n,r,i,s,o;for(n in e){r=v.camelCase(n),i=t[r],s=e[n],v.isArray(s)&amp;&amp;(i=s[1],s=e[n]=s[0]),n!==r&amp;&amp;(e[r]=s,delete e[n]),o=v.cssHooks[r];if(o&amp;&amp;"expand"in o){s=o.expand(s),delete e[r];for(n in s)n in e||(e[n]=s[n],t[n]=i)}else t[r]=i}}function Gn(e,t,n){var r,i,s,o,u,a,f,l,c,h=this,p=e.style,d={},m=[],g=e.nodeType&amp;&amp;Gt(e);n.queue||(l=v._queueHooks(e,"fx"),l.unqueued==null&amp;&amp;(l.unqueued=0,c=l.empty.fire,l.empty.fire=function(){l.unqueued||c()}),l.unqueued++,h.always(function(){h.always(function(){l.unqueued--,v.queue(e,"fx").length||l.empty.fire()})})),e.nodeType===1&amp;&amp;("height"in t||"width"in t)&amp;&amp;(n.overflow=[p.overflow,p.overflowX,p.overflowY],v.css(e,"display")==="inline"&amp;&amp;v.css(e,"float")==="none"&amp;&amp;(!v.support.inlineBlockNeedsLayout||nn(e.nodeName)==="inline"?p.display="inline-block":p.zoom=1)),n.overflow&amp;&amp;(p.overflow="hidden",v.support.shrinkWrapBlocks||h.done(function(){p.overflow=n.overflow[0],p.overflowX=n.overflow[1],p.overflowY=n.overflow[2]}));for(r in t){s=t[r];if(Un.exec(s)){delete t[r],a=a||s==="toggle";if(s===(g?"hide":"show"))continue;m.push(r)}}o=m.length;if(o){u=v._data(e,"fxshow")||v._data(e,"fxshow",{}),"hidden"in u&amp;&amp;(g=u.hidden),a&amp;&amp;(u.hidden=!g),g?v(e).show():h.done(function(){v(e).hide()}),h.done(function(){var t;v.removeData(e,"fxshow",!0);for(t in d)v.style(e,t,d[t])});for(r=0;r&lt;o;r++)i=m[r],f=h.createTween(i,g?u[i]:0),d[i]=u[i]||v.style(e,i),i in u||(u[i]=f.start,g&amp;&amp;(f.end=f.start,f.start=i==="width"||i==="height"?1:0))}}function Yn(e,t,n,r,i){return new Yn.prototype.init(e,t,n,r,i)}function Zn(e,t){var n,r={height:e},i=0;t=t?1:0;for(;i&lt;4;i+=2-t)n=$t[i],r["margin"+n]=r["padding"+n]=e;return t&amp;&amp;(r.opacity=r.width=e),r}function tr(e){return v.isWindow(e)?e:e.nodeType===9?e.defaultView||e.parentWindow:!1}var n,r,i=e.document,s=e.location,o=e.navigator,u=e.jQuery,a=e.$,f=Array.prototype.push,l=Array.prototype.slice,c=Array.prototype.indexOf,h=Object.prototype.toString,p=Object.prototype.hasOwnProperty,d=String.prototype.trim,v=function(e,t){return new v.fn.init(e,t,n)},m=/[\-+]?(?:\d*\.|)\d+(?:[eE][\-+]?\d+|)/.source,g=/\S/,y=/\s+/,b=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,w=/^(?:[^#&lt;]*(&lt;[\w\W]+&gt;)[^&gt;]*$|#([\w\-]*)$)/,E=/^&lt;(\w+)\s*\/?&gt;(?:&lt;\/\1&gt;|)$/,S=/^[\],:{}\s]*$/,x=/(?:^|:|,)(?:\s*\[)+/g,T=/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,N=/"[^"\\\r\n]*"|true|false|null|-?(?:\d\d*\.|)\d+(?:[eE][\-+]?\d+|)/g,C=/^-ms-/,k=/-([\da-z])/gi,L=function(e,t){return(t+"").toUpperCase()},A=function(){i.addEventListener?(i.removeEventListener("DOMContentLoaded",A,!1),v.ready()):i.readyState==="complete"&amp;&amp;(i.detachEvent("onreadystatechange",A),v.ready())},O={};v.fn=v.prototype={constructor:v,init:function(e,n,r){var s,o,u,a;if(!e)return this;if(e.nodeType)return this.context=this[0]=e,this.length=1,this;if(typeof e=="string"){e.charAt(0)==="&lt;"&amp;&amp;e.charAt(e.length-1)==="&gt;"&amp;&amp;e.length&gt;=3?s=[null,e,null]:s=w.exec(e);if(s&amp;&amp;(s[1]||!n)){if(s[1])return n=n instanceof v?n[0]:n,a=n&amp;&amp;n.nodeType?n.ownerDocument||n:i,e=v.parseHTML(s[1],a,!0),E.test(s[1])&amp;&amp;v.isPlainObject(n)&amp;&amp;this.attr.call(e,n,!0),v.merge(this,e);o=i.getElementById(s[2]);if(o&amp;&amp;o.parentNode){if(o.id!==s[2])return r.find(e);this.length=1,this[0]=o}return this.context=i,this.selector=e,this}return!n||n.jquery?(n||r).find(e):this.constructor(n).find(e)}return v.isFunction(e)?r.ready(e):(e.selector!==t&amp;&amp;(this.selector=e.selector,this.context=e.context),v.makeArray(e,this))},selector:"",jquery:"1.8.3",length:0,size:function(){return this.length},toArray:function(){return l.call(this)},get:function(e){return e==null?this.toArray():e&lt;0?this[this.length+e]:this[e]},pushStack:function(e,t,n){var r=v.merge(this.constructor(),e);return r.prevObject=this,r.context=this.context,t==="find"?r.selector=this.selector+(this.selector?" ":"")+n:t&amp;&amp;(r.selector=this.selector+"."+t+"("+n+")"),r},each:function(e,t){return v.each(this,e,t)},ready:function(e){return v.ready.promise().done(e),this},eq:function(e){return e=+e,e===-1?this.slice(e):this.slice(e,e+1)},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},slice:function(){return this.pushStack(l.apply(this,arguments),"slice",l.call(arguments).join(","))},map:function(e){return this.pushStack(v.map(this,function(t,n){return e.call(t,n,t)}))},end:function(){return this.prevObject||this.constructor(null)},push:f,sort:[].sort,splice:[].splice},v.fn.init.prototype=v.fn,v.extend=v.fn.extend=function(){var e,n,r,i,s,o,u=arguments[0]||{},a=1,f=arguments.length,l=!1;typeof u=="boolean"&amp;&amp;(l=u,u=arguments[1]||{},a=2),typeof u!="object"&amp;&amp;!v.isFunction(u)&amp;&amp;(u={}),f===a&amp;&amp;(u=this,--a);for(;a&lt;f;a++)if((e=arguments[a])!=null)for(n in e){r=u[n],i=e[n];if(u===i)continue;l&amp;&amp;i&amp;&amp;(v.isPlainObject(i)||(s=v.isArray(i)))?(s?(s=!1,o=r&amp;&amp;v.isArray(r)?r:[]):o=r&amp;&amp;v.isPlainObject(r)?r:{},u[n]=v.extend(l,o,i)):i!==t&amp;&amp;(u[n]=i)}return u},v.extend({noConflict:function(t){return e.$===v&amp;&amp;(e.$=a),t&amp;&amp;e.jQuery===v&amp;&amp;(e.jQuery=u),v},isReady:!1,readyWait:1,holdReady:function(e){e?v.readyWait++:v.ready(!0)},ready:function(e){if(e===!0?--v.readyWait:v.isReady)return;if(!i.body)return setTimeout(v.ready,1);v.isReady=!0;if(e!==!0&amp;&amp;--v.readyWait&gt;0)return;r.resolveWith(i,[v]),v.fn.trigger&amp;&amp;v(i).trigger("ready").off("ready")},isFunction:function(e){return v.type(e)==="function"},isArray:Array.isArray||function(e){return v.type(e)==="array"},isWindow:function(e){return e!=null&amp;&amp;e==e.window},isNumeric:function(e){return!isNaN(parseFloat(e))&amp;&amp;isFinite(e)},type:function(e){return e==null?String(e):O[h.call(e)]||"object"},isPlainObject:function(e){if(!e||v.type(e)!=="object"||e.nodeType||v.isWindow(e))return!1;try{if(e.constructor&amp;&amp;!p.call(e,"constructor")&amp;&amp;!p.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(n){return!1}var r;for(r in e);return r===t||p.call(e,r)},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},error:function(e){throw new Error(e)},parseHTML:function(e,t,n){var r;return!e||typeof e!="string"?null:(typeof t=="boolean"&amp;&amp;(n=t,t=0),t=t||i,(r=E.exec(e))?[t.createElement(r[1])]:(r=v.buildFragment([e],t,n?null:[]),v.merge([],(r.cacheable?v.clone(r.fragment):r.fragment).childNodes)))},parseJSON:function(t){if(!t||typeof t!="string")return null;t=v.trim(t);if(e.JSON&amp;&amp;e.JSON.parse)return e.JSON.parse(t);if(S.test(t.replace(T,"@").replace(N,"]").replace(x,"")))return(new Function("return "+t))();v.error("Invalid JSON: "+t)},parseXML:function(n){var r,i;if(!n||typeof n!="string")return null;try{e.DOMParser?(i=new DOMParser,r=i.parseFromString(n,"text/xml")):(r=new ActiveXObject("Microsoft.XMLDOM"),r.async="false",r.loadXML(n))}catch(s){r=t}return(!r||!r.documentElement||r.getElementsByTagName("parsererror").length)&amp;&amp;v.error("Invalid XML: "+n),r},noop:function(){},globalEval:function(t){t&amp;&amp;g.test(t)&amp;&amp;(e.execScript||function(t){e.eval.call(e,t)})(t)},camelCase:function(e){return e.replace(C,"ms-").replace(k,L)},nodeName:function(e,t){return e.nodeName&amp;&amp;e.nodeName.toLowerCase()===t.toLowerCase()},each:function(e,n,r){var i,s=0,o=e.length,u=o===t||v.isFunction(e);if(r){if(u){for(i in e)if(n.apply(e[i],r)===!1)break}else for(;s&lt;o;)if(n.apply(e[s++],r)===!1)break}else if(u){for(i in e)if(n.call(e[i],i,e[i])===!1)break}else for(;s&lt;o;)if(n.call(e[s],s,e[s++])===!1)break;return e},trim:d&amp;&amp;!d.call("\ufeff\u00a0")?function(e){return e==null?"":d.call(e)}:function(e){return e==null?"":(e+"").replace(b,"")},makeArray:function(e,t){var n,r=t||[];return e!=null&amp;&amp;(n=v.type(e),e.length==null||n==="string"||n==="function"||n==="regexp"||v.isWindow(e)?f.call(r,e):v.merge(r,e)),r},inArray:function(e,t,n){var r;if(t){if(c)return c.call(t,e,n);r=t.length,n=n?n&lt;0?Math.max(0,r+n):n:0;for(;n&lt;r;n++)if(n in t&amp;&amp;t[n]===e)return n}return-1},merge:function(e,n){var r=n.length,i=e.length,s=0;if(typeof r=="number")for(;s&lt;r;s++)e[i++]=n[s];else while(n[s]!==t)e[i++]=n[s++];return e.length=i,e},grep:function(e,t,n){var r,i=[],s=0,o=e.length;n=!!n;for(;s&lt;o;s++)r=!!t(e[s],s),n!==r&amp;&amp;i.push(e[s]);return i},map:function(e,n,r){var i,s,o=[],u=0,a=e.length,f=e instanceof v||a!==t&amp;&amp;typeof a=="number"&amp;&amp;(a&gt;0&amp;&amp;e[0]&amp;&amp;e[a-1]||a===0||v.isArray(e));if(f)for(;u&lt;a;u++)i=n(e[u],u,r),i!=null&amp;&amp;(o[o.length]=i);else for(s in e)i=n(e[s],s,r),i!=null&amp;&amp;(o[o.length]=i);return o.concat.apply([],o)},guid:1,proxy:function(e,n){var r,i,s;return typeof n=="string"&amp;&amp;(r=e[n],n=e,e=r),v.isFunction(e)?(i=l.call(arguments,2),s=function(){return e.apply(n,i.concat(l.call(arguments)))},s.guid=e.guid=e.guid||v.guid++,s):t},access:function(e,n,r,i,s,o,u){var a,f=r==null,l=0,c=e.length;if(r&amp;&amp;typeof r=="object"){for(l in r)v.access(e,n,l,r[l],1,o,i);s=1}else if(i!==t){a=u===t&amp;&amp;v.isFunction(i),f&amp;&amp;(a?(a=n,n=function(e,t,n){return a.call(v(e),n)}):(n.call(e,i),n=null));if(n)for(;l&lt;c;l++)n(e[l],r,a?i.call(e[l],l,n(e[l],r)):i,u);s=1}return s?e:f?n.call(e):c?n(e[0],r):o},now:function(){return(new Date).getTime()}}),v.ready.promise=function(t){if(!r){r=v.Deferred();if(i.readyState==="complete")setTimeout(v.ready,1);else if(i.addEventListener)i.addEventListener("DOMContentLoaded",A,!1),e.addEventListener("load",v.ready,!1);else{i.attachEvent("onreadystatechange",A),e.attachEvent("onload",v.ready);var n=!1;try{n=e.frameElement==null&amp;&amp;i.documentElement}catch(s){}n&amp;&amp;n.doScroll&amp;&amp;function o(){if(!v.isReady){try{n.doScroll("left")}catch(e){return setTimeout(o,50)}v.ready()}}()}}return r.promise(t)},v.each("Boolean Number String Function Array Date RegExp Object".split(" "),function(e,t){O["[object "+t+"]"]=t.toLowerCase()}),n=v(i);var M={};v.Callbacks=function(e){e=typeof e=="string"?M[e]||_(e):v.extend({},e);var n,r,i,s,o,u,a=[],f=!e.once&amp;&amp;[],l=function(t){n=e.memory&amp;&amp;t,r=!0,u=s||0,s=0,o=a.length,i=!0;for(;a&amp;&amp;u&lt;o;u++)if(a[u].apply(t[0],t[1])===!1&amp;&amp;e.stopOnFalse){n=!1;break}i=!1,a&amp;&amp;(f?f.length&amp;&amp;l(f.shift()):n?a=[]:c.disable())},c={add:function(){if(a){var t=a.length;(function r(t){v.each(t,function(t,n){var i=v.type(n);i==="function"?(!e.unique||!c.has(n))&amp;&amp;a.push(n):n&amp;&amp;n.length&amp;&amp;i!=="string"&amp;&amp;r(n)})})(arguments),i?o=a.length:n&amp;&amp;(s=t,l(n))}return this},remove:function(){return a&amp;&amp;v.each(arguments,function(e,t){var n;while((n=v.inArray(t,a,n))&gt;-1)a.splice(n,1),i&amp;&amp;(n&lt;=o&amp;&amp;o--,n&lt;=u&amp;&amp;u--)}),this},has:function(e){return v.inArray(e,a)&gt;-1},empty:function(){return a=[],this},disable:function(){return a=f=n=t,this},disabled:function(){return!a},lock:function(){return f=t,n||c.disable(),this},locked:function(){return!f},fireWith:function(e,t){return t=t||[],t=[e,t.slice?t.slice():t],a&amp;&amp;(!r||f)&amp;&amp;(i?f.push(t):l(t)),this},fire:function(){return c.fireWith(this,arguments),this},fired:function(){return!!r}};return c},v.extend({Deferred:function(e){var t=[["resolve","done",v.Callbacks("once memory"),"resolved"],["reject","fail",v.Callbacks("once memory"),"rejected"],["notify","progress",v.Callbacks("memory")]],n="pending",r={state:function(){return n},always:function(){return i.done(arguments).fail(arguments),this},then:function(){var e=arguments;return v.Deferred(function(n){v.each(t,function(t,r){var s=r[0],o=e[t];i[r[1]](v.isFunction(o)?function(){var e=o.apply(this,arguments);e&amp;&amp;v.isFunction(e.promise)?e.promise().done(n.resolve).fail(n.reject).progress(n.notify):n[s+"With"](this===i?n:this,[e])}:n[s])}),e=null}).promise()},promise:function(e){return e!=null?v.extend(e,r):r}},i={};return r.pipe=r.then,v.each(t,function(e,s){var o=s[2],u=s[3];r[s[1]]=o.add,u&amp;&amp;o.add(function(){n=u},t[e^1][2].disable,t[2][2].lock),i[s[0]]=o.fire,i[s[0]+"With"]=o.fireWith}),r.promise(i),e&amp;&amp;e.call(i,i),i},when:function(e){var t=0,n=l.call(arguments),r=n.length,i=r!==1||e&amp;&amp;v.isFunction(e.promise)?r:0,s=i===1?e:v.Deferred(),o=function(e,t,n){return function(r){t[e]=this,n[e]=arguments.length&gt;1?l.call(arguments):r,n===u?s.notifyWith(t,n):--i||s.resolveWith(t,n)}},u,a,f;if(r&gt;1){u=new Array(r),a=new Array(r),f=new Array(r);for(;t&lt;r;t++)n[t]&amp;&amp;v.isFunction(n[t].promise)?n[t].promise().done(o(t,f,n)).fail(s.reject).progress(o(t,a,u)):--i}return i||s.resolveWith(f,n),s.promise()}}),v.support=function(){var t,n,r,s,o,u,a,f,l,c,h,p=i.createElement("div");p.setAttribute("className","t"),p.innerHTML="  &lt;link/&gt;&lt;table&gt;&lt;/table&gt;&lt;a href='/a'&gt;a&lt;/a&gt;&lt;input type='checkbox'/&gt;",n=p.getElementsByTagName("*"),r=p.getElementsByTagName("a")[0];if(!n||!r||!n.length)return{};s=i.createElement("select"),o=s.appendChild(i.createElement("option")),u=p.getElementsByTagName("input")[0],r.style.cssText="top:1px;float:left;opacity:.5",t={leadingWhitespace:p.firstChild.nodeType===3,tbody:!p.getElementsByTagName("tbody").length,htmlSerialize:!!p.getElementsByTagName("link").length,style:/top/.test(r.getAttribute("style")),hrefNormalized:r.getAttribute("href")==="/a",opacity:/^0.5/.test(r.style.opacity),cssFloat:!!r.style.cssFloat,checkOn:u.value==="on",optSelected:o.selected,getSetAttribute:p.className!=="t",enctype:!!i.createElement("form").enctype,html5Clone:i.createElement("nav").cloneNode(!0).outerHTML!=="&lt;:nav&gt;&lt;/:nav&gt;",boxModel:i.compatMode==="CSS1Compat",submitBubbles:!0,changeBubbles:!0,focusinBubbles:!1,deleteExpando:!0,noCloneEvent:!0,inlineBlockNeedsLayout:!1,shrinkWrapBlocks:!1,reliableMarginRight:!0,boxSizingReliable:!0,pixelPosition:!1},u.checked=!0,t.noCloneChecked=u.cloneNode(!0).checked,s.disabled=!0,t.optDisabled=!o.disabled;try{delete p.test}catch(d){t.deleteExpando=!1}!p.addEventListener&amp;&amp;p.attachEvent&amp;&amp;p.fireEvent&amp;&amp;(p.attachEvent("onclick",h=function(){t.noCloneEvent=!1}),p.cloneNode(!0).fireEvent("onclick"),p.detachEvent("onclick",h)),u=i.createElement("input"),u.value="t",u.setAttribute("type","radio"),t.radioValue=u.value==="t",u.setAttribute("checked","checked"),u.setAttribute("name","t"),p.appendChild(u),a=i.createDocumentFragment(),a.appendChild(p.lastChild),t.checkClone=a.cloneNode(!0).cloneNode(!0).lastChild.checked,t.appendChecked=u.checked,a.removeChild(u),a.appendChild(p);if(p.attachEvent)for(l in{submit:!0,change:!0,focusin:!0})f="on"+l,c=f in p,c||(p.setAttribute(f,"return;"),c=typeof p[f]=="function"),t[l+"Bubbles"]=c;return v(function(){var n,r,s,o,u="padding:0;margin:0;border:0;display:block;overflow:hidden;",a=i.getElementsByTagName("body")[0];if(!a)return;n=i.createElement("div"),n.style.cssText="visibility:hidden;border:0;width:0;height:0;position:static;top:0;margin-top:1px",a.insertBefore(n,a.firstChild),r=i.createElement("div"),n.appendChild(r),r.innerHTML="&lt;table&gt;&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;t&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;",s=r.getElementsByTagName("td"),s[0].style.cssText="padding:0;margin:0;border:0;display:none",c=s[0].offsetHeight===0,s[0].style.display="",s[1].style.display="none",t.reliableHiddenOffsets=c&amp;&amp;s[0].offsetHeight===0,r.innerHTML="",r.style.cssText="box-sizing:border-box;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;padding:1px;border:1px;display:block;width:4px;margin-top:1%;position:absolute;top:1%;",t.boxSizing=r.offsetWidth===4,t.doesNotIncludeMarginInBodyOffset=a.offsetTop!==1,e.getComputedStyle&amp;&amp;(t.pixelPosition=(e.getComputedStyle(r,null)||{}).top!=="1%",t.boxSizingReliable=(e.getComputedStyle(r,null)||{width:"4px"}).width==="4px",o=i.createElement("div"),o.style.cssText=r.style.cssText=u,o.style.marginRight=o.style.width="0",r.style.width="1px",r.appendChild(o),t.reliableMarginRight=!parseFloat((e.getComputedStyle(o,null)||{}).marginRight)),typeof r.style.zoom!="undefined"&amp;&amp;(r.innerHTML="",r.style.cssText=u+"width:1px;padding:1px;display:inline;zoom:1",t.inlineBlockNeedsLayout=r.offsetWidth===3,r.style.display="block",r.style.overflow="visible",r.innerHTML="&lt;div&gt;&lt;/div&gt;",r.firstChild.style.width="5px",t.shrinkWrapBlocks=r.offsetWidth!==3,n.style.zoom=1),a.removeChild(n),n=r=s=o=null}),a.removeChild(p),n=r=s=o=u=a=p=null,t}();var D=/(?:\{[\s\S]*\}|\[[\s\S]*\])$/,P=/([A-Z])/g;v.extend({cache:{},deletedIds:[],uuid:0,expando:"jQuery"+(v.fn.jquery+Math.random()).replace(/\D/g,""),noData:{embed:!0,object:"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000",applet:!0},hasData:function(e){return e=e.nodeType?v.cache[e[v.expando]]:e[v.expando],!!e&amp;&amp;!B(e)},data:function(e,n,r,i){if(!v.acceptData(e))return;var s,o,u=v.expando,a=typeof n=="string",f=e.nodeType,l=f?v.cache:e,c=f?e[u]:e[u]&amp;&amp;u;if((!c||!l[c]||!i&amp;&amp;!l[c].data)&amp;&amp;a&amp;&amp;r===t)return;c||(f?e[u]=c=v.deletedIds.pop()||v.guid++:c=u),l[c]||(l[c]={},f||(l[c].toJSON=v.noop));if(typeof n=="object"||typeof n=="function")i?l[c]=v.extend(l[c],n):l[c].data=v.extend(l[c].data,n);return s=l[c],i||(s.data||(s.data={}),s=s.data),r!==t&amp;&amp;(s[v.camelCase(n)]=r),a?(o=s[n],o==null&amp;&amp;(o=s[v.camelCase(n)])):o=s,o},removeData:function(e,t,n){if(!v.acceptData(e))return;var r,i,s,o=e.nodeType,u=o?v.cache:e,a=o?e[v.expando]:v.expando;if(!u[a])return;if(t){r=n?u[a]:u[a].data;if(r){v.isArray(t)||(t in r?t=[t]:(t=v.camelCase(t),t in r?t=[t]:t=t.split(" ")));for(i=0,s=t.length;i&lt;s;i++)delete r[t[i]];if(!(n?B:v.isEmptyObject)(r))return}}if(!n){delete u[a].data;if(!B(u[a]))return}o?v.cleanData([e],!0):v.support.deleteExpando||u!=u.window?delete u[a]:u[a]=null},_data:function(e,t,n){return v.data(e,t,n,!0)},acceptData:function(e){var t=e.nodeName&amp;&amp;v.noData[e.nodeName.toLowerCase()];return!t||t!==!0&amp;&amp;e.getAttribute("classid")===t}}),v.fn.extend({data:function(e,n){var r,i,s,o,u,a=this[0],f=0,l=null;if(e===t){if(this.length){l=v.data(a);if(a.nodeType===1&amp;&amp;!v._data(a,"parsedAttrs")){s=a.attributes;for(u=s.length;f&lt;u;f++)o=s[f].name,o.indexOf("data-")||(o=v.camelCase(o.substring(5)),H(a,o,l[o]));v._data(a,"parsedAttrs",!0)}}return l}return typeof e=="object"?this.each(function(){v.data(this,e)}):(r=e.split(".",2),r[1]=r[1]?"."+r[1]:"",i=r[1]+"!",v.access(this,function(n){if(n===t)return l=this.triggerHandler("getData"+i,[r[0]]),l===t&amp;&amp;a&amp;&amp;(l=v.data(a,e),l=H(a,e,l)),l===t&amp;&amp;r[1]?this.data(r[0]):l;r[1]=n,this.each(function(){var t=v(this);t.triggerHandler("setData"+i,r),v.data(this,e,n),t.triggerHandler("changeData"+i,r)})},null,n,arguments.length&gt;1,null,!1))},removeData:function(e){return this.each(function(){v.removeData(this,e)})}}),v.extend({queue:function(e,t,n){var r;if(e)return t=(t||"fx")+"queue",r=v._data(e,t),n&amp;&amp;(!r||v.isArray(n)?r=v._data(e,t,v.makeArray(n)):r.push(n)),r||[]},dequeue:function(e,t){t=t||"fx";var n=v.queue(e,t),r=n.length,i=n.shift(),s=v._queueHooks(e,t),o=function(){v.dequeue(e,t)};i==="inprogress"&amp;&amp;(i=n.shift(),r--),i&amp;&amp;(t==="fx"&amp;&amp;n.unshift("inprogress"),delete s.stop,i.call(e,o,s)),!r&amp;&amp;s&amp;&amp;s.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return v._data(e,n)||v._data(e,n,{empty:v.Callbacks("once memory").add(function(){v.removeData(e,t+"queue",!0),v.removeData(e,n,!0)})})}}),v.fn.extend({queue:function(e,n){var r=2;return typeof e!="string"&amp;&amp;(n=e,e="fx",r--),arguments.length&lt;r?v.queue(this[0],e):n===t?this:this.each(function(){var t=v.queue(this,e,n);v._queueHooks(this,e),e==="fx"&amp;&amp;t[0]!=="inprogress"&amp;&amp;v.dequeue(this,e)})},dequeue:function(e){return this.each(function(){v.dequeue(this,e)})},delay:function(e,t){return e=v.fx?v.fx.speeds[e]||e:e,t=t||"fx",this.queue(t,function(t,n){var r=setTimeout(t,e);n.stop=function(){clearTimeout(r)}})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,n){var r,i=1,s=v.Deferred(),o=this,u=this.length,a=function(){--i||s.resolveWith(o,[o])};typeof e!="string"&amp;&amp;(n=e,e=t),e=e||"fx";while(u--)r=v._data(o[u],e+"queueHooks"),r&amp;&amp;r.empty&amp;&amp;(i++,r.empty.add(a));return a(),s.promise(n)}});var j,F,I,q=/[\t\r\n]/g,R=/\r/g,U=/^(?:button|input)$/i,z=/^(?:button|input|object|select|textarea)$/i,W=/^a(?:rea|)$/i,X=/^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,V=v.support.getSetAttribute;v.fn.extend({attr:function(e,t){return v.access(this,v.attr,e,t,arguments.length&gt;1)},removeAttr:function(e){return this.each(function(){v.removeAttr(this,e)})},prop:function(e,t){return v.access(this,v.prop,e,t,arguments.length&gt;1)},removeProp:function(e){return e=v.propFix[e]||e,this.each(function(){try{this[e]=t,delete this[e]}catch(n){}})},addClass:function(e){var t,n,r,i,s,o,u;if(v.isFunction(e))return this.each(function(t){v(this).addClass(e.call(this,t,this.className))});if(e&amp;&amp;typeof e=="string"){t=e.split(y);for(n=0,r=this.length;n&lt;r;n++){i=this[n];if(i.nodeType===1)if(!i.className&amp;&amp;t.length===1)i.className=e;else{s=" "+i.className+" ";for(o=0,u=t.length;o&lt;u;o++)s.indexOf(" "+t[o]+" ")&lt;0&amp;&amp;(s+=t[o]+" ");i.className=v.trim(s)}}}return this},removeClass:function(e){var n,r,i,s,o,u,a;if(v.isFunction(e))return this.each(function(t){v(this).removeClass(e.call(this,t,this.className))});if(e&amp;&amp;typeof e=="string"||e===t){n=(e||"").split(y);for(u=0,a=this.length;u&lt;a;u++){i=this[u];if(i.nodeType===1&amp;&amp;i.className){r=(" "+i.className+" ").replace(q," ");for(s=0,o=n.length;s&lt;o;s++)while(r.indexOf(" "+n[s]+" ")&gt;=0)r=r.replace(" "+n[s]+" "," ");i.className=e?v.trim(r):""}}}return this},toggleClass:function(e,t){var n=typeof e,r=typeof t=="boolean";return v.isFunction(e)?this.each(function(n){v(this).toggleClass(e.call(this,n,this.className,t),t)}):this.each(function(){if(n==="string"){var i,s=0,o=v(this),u=t,a=e.split(y);while(i=a[s++])u=r?u:!o.hasClass(i),o[u?"addClass":"removeClass"](i)}else if(n==="undefined"||n==="boolean")this.className&amp;&amp;v._data(this,"__className__",this.className),this.className=this.className||e===!1?"":v._data(this,"__className__")||""})},hasClass:function(e){var t=" "+e+" ",n=0,r=this.length;for(;n&lt;r;n++)if(this[n].nodeType===1&amp;&amp;(" "+this[n].className+" ").replace(q," ").indexOf(t)&gt;=0)return!0;return!1},val:function(e){var n,r,i,s=this[0];if(!arguments.length){if(s)return n=v.valHooks[s.type]||v.valHooks[s.nodeName.toLowerCase()],n&amp;&amp;"get"in n&amp;&amp;(r=n.get(s,"value"))!==t?r:(r=s.value,typeof r=="string"?r.replace(R,""):r==null?"":r);return}return i=v.isFunction(e),this.each(function(r){var s,o=v(this);if(this.nodeType!==1)return;i?s=e.call(this,r,o.val()):s=e,s==null?s="":typeof s=="number"?s+="":v.isArray(s)&amp;&amp;(s=v.map(s,function(e){return e==null?"":e+""})),n=v.valHooks[this.type]||v.valHooks[this.nodeName.toLowerCase()];if(!n||!("set"in n)||n.set(this,s,"value")===t)this.value=s})}}),v.extend({valHooks:{option:{get:function(e){var t=e.attributes.value;return!t||t.specified?e.value:e.text}},select:{get:function(e){var t,n,r=e.options,i=e.selectedIndex,s=e.type==="select-one"||i&lt;0,o=s?null:[],u=s?i+1:r.length,a=i&lt;0?u:s?i:0;for(;a&lt;u;a++){n=r[a];if((n.selected||a===i)&amp;&amp;(v.support.optDisabled?!n.disabled:n.getAttribute("disabled")===null)&amp;&amp;(!n.parentNode.disabled||!v.nodeName(n.parentNode,"optgroup"))){t=v(n).val();if(s)return t;o.push(t)}}return o},set:function(e,t){var n=v.makeArray(t);return v(e).find("option").each(function(){this.selected=v.inArray(v(this).val(),n)&gt;=0}),n.length||(e.selectedIndex=-1),n}}},attrFn:{},attr:function(e,n,r,i){var s,o,u,a=e.nodeType;if(!e||a===3||a===8||a===2)return;if(i&amp;&amp;v.isFunction(v.fn[n]))return v(e)[n](r);if(typeof e.getAttribute=="undefined")return v.prop(e,n,r);u=a!==1||!v.isXMLDoc(e),u&amp;&amp;(n=n.toLowerCase(),o=v.attrHooks[n]||(X.test(n)?F:j));if(r!==t){if(r===null){v.removeAttr(e,n);return}return o&amp;&amp;"set"in o&amp;&amp;u&amp;&amp;(s=o.set(e,r,n))!==t?s:(e.setAttribute(n,r+""),r)}return o&amp;&amp;"get"in o&amp;&amp;u&amp;&amp;(s=o.get(e,n))!==null?s:(s=e.getAttribute(n),s===null?t:s)},removeAttr:function(e,t){var n,r,i,s,o=0;if(t&amp;&amp;e.nodeType===1){r=t.split(y);for(;o&lt;r.length;o++)i=r[o],i&amp;&amp;(n=v.propFix[i]||i,s=X.test(i),s||v.attr(e,i,""),e.removeAttribute(V?i:n),s&amp;&amp;n in e&amp;&amp;(e[n]=!1))}},attrHooks:{type:{set:function(e,t){if(U.test(e.nodeName)&amp;&amp;e.parentNode)v.error("type property can't be changed");else if(!v.support.radioValue&amp;&amp;t==="radio"&amp;&amp;v.nodeName(e,"input")){var n=e.value;return e.setAttribute("type",t),n&amp;&amp;(e.value=n),t}}},value:{get:function(e,t){return j&amp;&amp;v.nodeName(e,"button")?j.get(e,t):t in e?e.value:null},set:function(e,t,n){if(j&amp;&amp;v.nodeName(e,"button"))return j.set(e,t,n);e.value=t}}},propFix:{tabindex:"tabIndex",readonly:"readOnly","for":"htmlFor","class":"className",maxlength:"maxLength",cellspacing:"cellSpacing",cellpadding:"cellPadding",rowspan:"rowSpan",colspan:"colSpan",usemap:"useMap",frameborder:"frameBorder",contenteditable:"contentEditable"},prop:function(e,n,r){var i,s,o,u=e.nodeType;if(!e||u===3||u===8||u===2)return;return o=u!==1||!v.isXMLDoc(e),o&amp;&amp;(n=v.propFix[n]||n,s=v.propHooks[n]),r!==t?s&amp;&amp;"set"in s&amp;&amp;(i=s.set(e,r,n))!==t?i:e[n]=r:s&amp;&amp;"get"in s&amp;&amp;(i=s.get(e,n))!==null?i:e[n]},propHooks:{tabIndex:{get:function(e){var n=e.getAttributeNode("tabindex");return n&amp;&amp;n.specified?parseInt(n.value,10):z.test(e.nodeName)||W.test(e.nodeName)&amp;&amp;e.href?0:t}}}}),F={get:function(e,n){var r,i=v.prop(e,n);return i===!0||typeof i!="boolean"&amp;&amp;(r=e.getAttributeNode(n))&amp;&amp;r.nodeValue!==!1?n.toLowerCase():t},set:function(e,t,n){var r;return t===!1?v.removeAttr(e,n):(r=v.propFix[n]||n,r in e&amp;&amp;(e[r]=!0),e.setAttribute(n,n.toLowerCase())),n}},V||(I={name:!0,id:!0,coords:!0},j=v.valHooks.button={get:function(e,n){var r;return r=e.getAttributeNode(n),r&amp;&amp;(I[n]?r.value!=="":r.specified)?r.value:t},set:function(e,t,n){var r=e.getAttributeNode(n);return r||(r=i.createAttribute(n),e.setAttributeNode(r)),r.value=t+""}},v.each(["width","height"],function(e,t){v.attrHooks[t]=v.extend(v.attrHooks[t],{set:function(e,n){if(n==="")return e.setAttribute(t,"auto"),n}})}),v.attrHooks.contenteditable={get:j.get,set:function(e,t,n){t===""&amp;&amp;(t="false"),j.set(e,t,n)}}),v.support.hrefNormalized||v.each(["href","src","width","height"],function(e,n){v.attrHooks[n]=v.extend(v.attrHooks[n],{get:function(e){var r=e.getAttribute(n,2);return r===null?t:r}})}),v.support.style||(v.attrHooks.style={get:function(e){return e.style.cssText.toLowerCase()||t},set:function(e,t){return e.style.cssText=t+""}}),v.support.optSelected||(v.propHooks.selected=v.extend(v.propHooks.selected,{get:function(e){var t=e.parentNode;return t&amp;&amp;(t.selectedIndex,t.parentNode&amp;&amp;t.parentNode.selectedIndex),null}})),v.support.enctype||(v.propFix.enctype="encoding"),v.support.checkOn||v.each(["radio","checkbox"],function(){v.valHooks[this]={get:function(e){return e.getAttribute("value")===null?"on":e.value}}}),v.each(["radio","checkbox"],function(){v.valHooks[this]=v.extend(v.valHooks[this],{set:function(e,t){if(v.isArray(t))return e.checked=v.inArray(v(e).val(),t)&gt;=0}})});var $=/^(?:textarea|input|select)$/i,J=/^([^\.]*|)(?:\.(.+)|)$/,K=/(?:^|\s)hover(\.\S+|)\b/,Q=/^key/,G=/^(?:mouse|contextmenu)|click/,Y=/^(?:focusinfocus|focusoutblur)$/,Z=function(e){return v.event.special.hover?e:e.replace(K,"mouseenter$1 mouseleave$1")};v.event={add:function(e,n,r,i,s){var o,u,a,f,l,c,h,p,d,m,g;if(e.nodeType===3||e.nodeType===8||!n||!r||!(o=v._data(e)))return;r.handler&amp;&amp;(d=r,r=d.handler,s=d.selector),r.guid||(r.guid=v.guid++),a=o.events,a||(o.events=a={}),u=o.handle,u||(o.handle=u=function(e){return typeof v=="undefined"||!!e&amp;&amp;v.event.triggered===e.type?t:v.event.dispatch.apply(u.elem,arguments)},u.elem=e),n=v.trim(Z(n)).split(" ");for(f=0;f&lt;n.length;f++){l=J.exec(n[f])||[],c=l[1],h=(l[2]||"").split(".").sort(),g=v.event.special[c]||{},c=(s?g.delegateType:g.bindType)||c,g=v.event.special[c]||{},p=v.extend({type:c,origType:l[1],data:i,handler:r,guid:r.guid,selector:s,needsContext:s&amp;&amp;v.expr.match.needsContext.test(s),namespace:h.join(".")},d),m=a[c];if(!m){m=a[c]=[],m.delegateCount=0;if(!g.setup||g.setup.call(e,i,h,u)===!1)e.addEventListener?e.addEventListener(c,u,!1):e.attachEvent&amp;&amp;e.attachEvent("on"+c,u)}g.add&amp;&amp;(g.add.call(e,p),p.handler.guid||(p.handler.guid=r.guid)),s?m.splice(m.delegateCount++,0,p):m.push(p),v.event.global[c]=!0}e=null},global:{},remove:function(e,t,n,r,i){var s,o,u,a,f,l,c,h,p,d,m,g=v.hasData(e)&amp;&amp;v._data(e);if(!g||!(h=g.events))return;t=v.trim(Z(t||"")).split(" ");for(s=0;s&lt;t.length;s++){o=J.exec(t[s])||[],u=a=o[1],f=o[2];if(!u){for(u in h)v.event.remove(e,u+t[s],n,r,!0);continue}p=v.event.special[u]||{},u=(r?p.delegateType:p.bindType)||u,d=h[u]||[],l=d.length,f=f?new RegExp("(^|\\.)"+f.split(".").sort().join("\\.(?:.*\\.|)")+"(\\.|$)"):null;for(c=0;c&lt;d.length;c++)m=d[c],(i||a===m.origType)&amp;&amp;(!n||n.guid===m.guid)&amp;&amp;(!f||f.test(m.namespace))&amp;&amp;(!r||r===m.selector||r==="**"&amp;&amp;m.selector)&amp;&amp;(d.splice(c--,1),m.selector&amp;&amp;d.delegateCount--,p.remove&amp;&amp;p.remove.call(e,m));d.length===0&amp;&amp;l!==d.length&amp;&amp;((!p.teardown||p.teardown.call(e,f,g.handle)===!1)&amp;&amp;v.removeEvent(e,u,g.handle),delete h[u])}v.isEmptyObject(h)&amp;&amp;(delete g.handle,v.removeData(e,"events",!0))},customEvent:{getData:!0,setData:!0,changeData:!0},trigger:function(n,r,s,o){if(!s||s.nodeType!==3&amp;&amp;s.nodeType!==8){var u,a,f,l,c,h,p,d,m,g,y=n.type||n,b=[];if(Y.test(y+v.event.triggered))return;y.indexOf("!")&gt;=0&amp;&amp;(y=y.slice(0,-1),a=!0),y.indexOf(".")&gt;=0&amp;&amp;(b=y.split("."),y=b.shift(),b.sort());if((!s||v.event.customEvent[y])&amp;&amp;!v.event.global[y])return;n=typeof n=="object"?n[v.expando]?n:new v.Event(y,n):new v.Event(y),n.type=y,n.isTrigger=!0,n.exclusive=a,n.namespace=b.join("."),n.namespace_re=n.namespace?new RegExp("(^|\\.)"+b.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,h=y.indexOf(":")&lt;0?"on"+y:"";if(!s){u=v.cache;for(f in u)u[f].events&amp;&amp;u[f].events[y]&amp;&amp;v.event.trigger(n,r,u[f].handle.elem,!0);return}n.result=t,n.target||(n.target=s),r=r!=null?v.makeArray(r):[],r.unshift(n),p=v.event.special[y]||{};if(p.trigger&amp;&amp;p.trigger.apply(s,r)===!1)return;m=[[s,p.bindType||y]];if(!o&amp;&amp;!p.noBubble&amp;&amp;!v.isWindow(s)){g=p.delegateType||y,l=Y.test(g+y)?s:s.parentNode;for(c=s;l;l=l.parentNode)m.push([l,g]),c=l;c===(s.ownerDocument||i)&amp;&amp;m.push([c.defaultView||c.parentWindow||e,g])}for(f=0;f&lt;m.length&amp;&amp;!n.isPropagationStopped();f++)l=m[f][0],n.type=m[f][1],d=(v._data(l,"events")||{})[n.type]&amp;&amp;v._data(l,"handle"),d&amp;&amp;d.apply(l,r),d=h&amp;&amp;l[h],d&amp;&amp;v.acceptData(l)&amp;&amp;d.apply&amp;&amp;d.apply(l,r)===!1&amp;&amp;n.preventDefault();return n.type=y,!o&amp;&amp;!n.isDefaultPrevented()&amp;&amp;(!p._default||p._default.apply(s.ownerDocument,r)===!1)&amp;&amp;(y!=="click"||!v.nodeName(s,"a"))&amp;&amp;v.acceptData(s)&amp;&amp;h&amp;&amp;s[y]&amp;&amp;(y!=="focus"&amp;&amp;y!=="blur"||n.target.offsetWidth!==0)&amp;&amp;!v.isWindow(s)&amp;&amp;(c=s[h],c&amp;&amp;(s[h]=null),v.event.triggered=y,s[y](),v.event.triggered=t,c&amp;&amp;(s[h]=c)),n.result}return},dispatch:function(n){n=v.event.fix(n||e.event);var r,i,s,o,u,a,f,c,h,p,d=(v._data(this,"events")||{})[n.type]||[],m=d.delegateCount,g=l.call(arguments),y=!n.exclusive&amp;&amp;!n.namespace,b=v.event.special[n.type]||{},w=[];g[0]=n,n.delegateTarget=this;if(b.preDispatch&amp;&amp;b.preDispatch.call(this,n)===!1)return;if(m&amp;&amp;(!n.button||n.type!=="click"))for(s=n.target;s!=this;s=s.parentNode||this)if(s.disabled!==!0||n.type!=="click"){u={},f=[];for(r=0;r&lt;m;r++)c=d[r],h=c.selector,u[h]===t&amp;&amp;(u[h]=c.needsContext?v(h,this).index(s)&gt;=0:v.find(h,this,null,[s]).length),u[h]&amp;&amp;f.push(c);f.length&amp;&amp;w.push({elem:s,matches:f})}d.length&gt;m&amp;&amp;w.push({elem:this,matches:d.slice(m)});for(r=0;r&lt;w.length&amp;&amp;!n.isPropagationStopped();r++){a=w[r],n.currentTarget=a.elem;for(i=0;i&lt;a.matches.length&amp;&amp;!n.isImmediatePropagationStopped();i++){c=a.matches[i];if(y||!n.namespace&amp;&amp;!c.namespace||n.namespace_re&amp;&amp;n.namespace_re.test(c.namespace))n.data=c.data,n.handleObj=c,o=((v.event.special[c.origType]||{}).handle||c.handler).apply(a.elem,g),o!==t&amp;&amp;(n.result=o,o===!1&amp;&amp;(n.preventDefault(),n.stopPropagation()))}}return b.postDispatch&amp;&amp;b.postDispatch.call(this,n),n.result},props:"attrChange attrName relatedNode srcElement altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(e,t){return e.which==null&amp;&amp;(e.which=t.charCode!=null?t.charCode:t.keyCode),e}},mouseHooks:{props:"button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(e,n){var r,s,o,u=n.button,a=n.fromElement;return e.pageX==null&amp;&amp;n.clientX!=null&amp;&amp;(r=e.target.ownerDocument||i,s=r.documentElement,o=r.body,e.pageX=n.clientX+(s&amp;&amp;s.scrollLeft||o&amp;&amp;o.scrollLeft||0)-(s&amp;&amp;s.clientLeft||o&amp;&amp;o.clientLeft||0),e.pageY=n.clientY+(s&amp;&amp;s.scrollTop||o&amp;&amp;o.scrollTop||0)-(s&amp;&amp;s.clientTop||o&amp;&amp;o.clientTop||0)),!e.relatedTarget&amp;&amp;a&amp;&amp;(e.relatedTarget=a===e.target?n.toElement:a),!e.which&amp;&amp;u!==t&amp;&amp;(e.which=u&amp;1?1:u&amp;2?3:u&amp;4?2:0),e}},fix:function(e){if(e[v.expando])return e;var t,n,r=e,s=v.event.fixHooks[e.type]||{},o=s.props?this.props.concat(s.props):this.props;e=v.Event(r);for(t=o.length;t;)n=o[--t],e[n]=r[n];return e.target||(e.target=r.srcElement||i),e.target.nodeType===3&amp;&amp;(e.target=e.target.parentNode),e.metaKey=!!e.metaKey,s.filter?s.filter(e,r):e},special:{load:{noBubble:!0},focus:{delegateType:"focusin"},blur:{delegateType:"focusout"},beforeunload:{setup:function(e,t,n){v.isWindow(this)&amp;&amp;(this.onbeforeunload=n)},teardown:function(e,t){this.onbeforeunload===t&amp;&amp;(this.onbeforeunload=null)}}},simulate:function(e,t,n,r){var i=v.extend(new v.Event,n,{type:e,isSimulated:!0,originalEvent:{}});r?v.event.trigger(i,null,t):v.event.dispatch.call(t,i),i.isDefaultPrevented()&amp;&amp;n.preventDefault()}},v.event.handle=v.event.dispatch,v.removeEvent=i.removeEventListener?function(e,t,n){e.removeEventListener&amp;&amp;e.removeEventListener(t,n,!1)}:function(e,t,n){var r="on"+t;e.detachEvent&amp;&amp;(typeof e[r]=="undefined"&amp;&amp;(e[r]=null),e.detachEvent(r,n))},v.Event=function(e,t){if(!(this instanceof v.Event))return new v.Event(e,t);e&amp;&amp;e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||e.returnValue===!1||e.getPreventDefault&amp;&amp;e.getPreventDefault()?tt:et):this.type=e,t&amp;&amp;v.extend(this,t),this.timeStamp=e&amp;&amp;e.timeStamp||v.now(),this[v.expando]=!0},v.Event.prototype={preventDefault:function(){this.isDefaultPrevented=tt;var e=this.originalEvent;if(!e)return;e.preventDefault?e.preventDefault():e.returnValue=!1},stopPropagation:function(){this.isPropagationStopped=tt;var e=this.originalEvent;if(!e)return;e.stopPropagation&amp;&amp;e.stopPropagation(),e.cancelBubble=!0},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=tt,this.stopPropagation()},isDefaultPrevented:et,isPropagationStopped:et,isImmediatePropagationStopped:et},v.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(e,t){v.event.special[e]={delegateType:t,bindType:t,handle:function(e){var n,r=this,i=e.relatedTarget,s=e.handleObj,o=s.selector;if(!i||i!==r&amp;&amp;!v.contains(r,i))e.type=s.origType,n=s.handler.apply(this,arguments),e.type=t;return n}}}),v.support.submitBubbles||(v.event.special.submit={setup:function(){if(v.nodeName(this,"form"))return!1;v.event.add(this,"click._submit keypress._submit",function(e){var n=e.target,r=v.nodeName(n,"input")||v.nodeName(n,"button")?n.form:t;r&amp;&amp;!v._data(r,"_submit_attached")&amp;&amp;(v.event.add(r,"submit._submit",function(e){e._submit_bubble=!0}),v._data(r,"_submit_attached",!0))})},postDispatch:function(e){e._submit_bubble&amp;&amp;(delete e._submit_bubble,this.parentNode&amp;&amp;!e.isTrigger&amp;&amp;v.event.simulate("submit",this.parentNode,e,!0))},teardown:function(){if(v.nodeName(this,"form"))return!1;v.event.remove(this,"._submit")}}),v.support.changeBubbles||(v.event.special.change={setup:function(){if($.test(this.nodeName)){if(this.type==="checkbox"||this.type==="radio")v.event.add(this,"propertychange._change",function(e){e.originalEvent.propertyName==="checked"&amp;&amp;(this._just_changed=!0)}),v.event.add(this,"click._change",function(e){this._just_changed&amp;&amp;!e.isTrigger&amp;&amp;(this._just_changed=!1),v.event.simulate("change",this,e,!0)});return!1}v.event.add(this,"beforeactivate._change",function(e){var t=e.target;$.test(t.nodeName)&amp;&amp;!v._data(t,"_change_attached")&amp;&amp;(v.event.add(t,"change._change",function(e){this.parentNode&amp;&amp;!e.isSimulated&amp;&amp;!e.isTrigger&amp;&amp;v.event.simulate("change",this.parentNode,e,!0)}),v._data(t,"_change_attached",!0))})},handle:function(e){var t=e.target;if(this!==t||e.isSimulated||e.isTrigger||t.type!=="radio"&amp;&amp;t.type!=="checkbox")return e.handleObj.handler.apply(this,arguments)},teardown:function(){return v.event.remove(this,"._change"),!$.test(this.nodeName)}}),v.support.focusinBubbles||v.each({focus:"focusin",blur:"focusout"},function(e,t){var n=0,r=function(e){v.event.simulate(t,e.target,v.event.fix(e),!0)};v.event.special[t]={setup:function(){n++===0&amp;&amp;i.addEventListener(e,r,!0)},teardown:function(){--n===0&amp;&amp;i.removeEventListener(e,r,!0)}}}),v.fn.extend({on:function(e,n,r,i,s){var o,u;if(typeof e=="object"){typeof n!="string"&amp;&amp;(r=r||n,n=t);for(u in e)this.on(u,n,r,e[u],s);return this}r==null&amp;&amp;i==null?(i=n,r=n=t):i==null&amp;&amp;(typeof n=="string"?(i=r,r=t):(i=r,r=n,n=t));if(i===!1)i=et;else if(!i)return this;return s===1&amp;&amp;(o=i,i=function(e){return v().off(e),o.apply(this,arguments)},i.guid=o.guid||(o.guid=v.guid++)),this.each(function(){v.event.add(this,e,i,r,n)})},one:function(e,t,n,r){return this.on(e,t,n,r,1)},off:function(e,n,r){var i,s;if(e&amp;&amp;e.preventDefault&amp;&amp;e.handleObj)return i=e.handleObj,v(e.delegateTarget).off(i.namespace?i.origType+"."+i.namespace:i.origType,i.selector,i.handler),this;if(typeof e=="object"){for(s in e)this.off(s,n,e[s]);return this}if(n===!1||typeof n=="function")r=n,n=t;return r===!1&amp;&amp;(r=et),this.each(function(){v.event.remove(this,e,r,n)})},bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},live:function(e,t,n){return v(this.context).on(e,this.selector,t,n),this},die:function(e,t){return v(this.context).off(e,this.selector||"**",t),this},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return arguments.length===1?this.off(e,"**"):this.off(t,e||"**",n)},trigger:function(e,t){return this.each(function(){v.event.trigger(e,t,this)})},triggerHandler:function(e,t){if(this[0])return v.event.trigger(e,t,this[0],!0)},toggle:function(e){var t=arguments,n=e.guid||v.guid++,r=0,i=function(n){var i=(v._data(this,"lastToggle"+e.guid)||0)%r;return v._data(this,"lastToggle"+e.guid,i+1),n.preventDefault(),t[i].apply(this,arguments)||!1};i.guid=n;while(r&lt;t.length)t[r++].guid=n;return this.click(i)},hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)}}),v.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(e,t){v.fn[t]=function(e,n){return n==null&amp;&amp;(n=e,e=null),arguments.length&gt;0?this.on(t,null,e,n):this.trigger(t)},Q.test(t)&amp;&amp;(v.event.fixHooks[t]=v.event.keyHooks),G.test(t)&amp;&amp;(v.event.fixHooks[t]=v.event.mouseHooks)}),function(e,t){function nt(e,t,n,r){n=n||[],t=t||g;var i,s,a,f,l=t.nodeType;if(!e||typeof e!="string")return n;if(l!==1&amp;&amp;l!==9)return[];a=o(t);if(!a&amp;&amp;!r)if(i=R.exec(e))if(f=i[1]){if(l===9){s=t.getElementById(f);if(!s||!s.parentNode)return n;if(s.id===f)return n.push(s),n}else if(t.ownerDocument&amp;&amp;(s=t.ownerDocument.getElementById(f))&amp;&amp;u(t,s)&amp;&amp;s.id===f)return n.push(s),n}else{if(i[2])return S.apply(n,x.call(t.getElementsByTagName(e),0)),n;if((f=i[3])&amp;&amp;Z&amp;&amp;t.getElementsByClassName)return S.apply(n,x.call(t.getElementsByClassName(f),0)),n}return vt(e.replace(j,"$1"),t,n,r,a)}function rt(e){return function(t){var n=t.nodeName.toLowerCase();return n==="input"&amp;&amp;t.type===e}}function it(e){return function(t){var n=t.nodeName.toLowerCase();return(n==="input"||n==="button")&amp;&amp;t.type===e}}function st(e){return N(function(t){return t=+t,N(function(n,r){var i,s=e([],n.length,t),o=s.length;while(o--)n[i=s[o]]&amp;&amp;(n[i]=!(r[i]=n[i]))})})}function ot(e,t,n){if(e===t)return n;var r=e.nextSibling;while(r){if(r===t)return-1;r=r.nextSibling}return 1}function ut(e,t){var n,r,s,o,u,a,f,l=L[d][e+" "];if(l)return t?0:l.slice(0);u=e,a=[],f=i.preFilter;while(u){if(!n||(r=F.exec(u)))r&amp;&amp;(u=u.slice(r[0].length)||u),a.push(s=[]);n=!1;if(r=I.exec(u))s.push(n=new m(r.shift())),u=u.slice(n.length),n.type=r[0].replace(j," ");for(o in i.filter)(r=J[o].exec(u))&amp;&amp;(!f[o]||(r=f[o](r)))&amp;&amp;(s.push(n=new m(r.shift())),u=u.slice(n.length),n.type=o,n.matches=r);if(!n)break}return t?u.length:u?nt.error(e):L(e,a).slice(0)}function at(e,t,r){var i=t.dir,s=r&amp;&amp;t.dir==="parentNode",o=w++;return t.first?function(t,n,r){while(t=t[i])if(s||t.nodeType===1)return e(t,n,r)}:function(t,r,u){if(!u){var a,f=b+" "+o+" ",l=f+n;while(t=t[i])if(s||t.nodeType===1){if((a=t[d])===l)return t.sizset;if(typeof a=="string"&amp;&amp;a.indexOf(f)===0){if(t.sizset)return t}else{t[d]=l;if(e(t,r,u))return t.sizset=!0,t;t.sizset=!1}}}else while(t=t[i])if(s||t.nodeType===1)if(e(t,r,u))return t}}function ft(e){return e.length&gt;1?function(t,n,r){var i=e.length;while(i--)if(!e[i](t,n,r))return!1;return!0}:e[0]}function lt(e,t,n,r,i){var s,o=[],u=0,a=e.length,f=t!=null;for(;u&lt;a;u++)if(s=e[u])if(!n||n(s,r,i))o.push(s),f&amp;&amp;t.push(u);return o}function ct(e,t,n,r,i,s){return r&amp;&amp;!r[d]&amp;&amp;(r=ct(r)),i&amp;&amp;!i[d]&amp;&amp;(i=ct(i,s)),N(function(s,o,u,a){var f,l,c,h=[],p=[],d=o.length,v=s||dt(t||"*",u.nodeType?[u]:u,[]),m=e&amp;&amp;(s||!t)?lt(v,h,e,u,a):v,g=n?i||(s?e:d||r)?[]:o:m;n&amp;&amp;n(m,g,u,a);if(r){f=lt(g,p),r(f,[],u,a),l=f.length;while(l--)if(c=f[l])g[p[l]]=!(m[p[l]]=c)}if(s){if(i||e){if(i){f=[],l=g.length;while(l--)(c=g[l])&amp;&amp;f.push(m[l]=c);i(null,g=[],f,a)}l=g.length;while(l--)(c=g[l])&amp;&amp;(f=i?T.call(s,c):h[l])&gt;-1&amp;&amp;(s[f]=!(o[f]=c))}}else g=lt(g===o?g.splice(d,g.length):g),i?i(null,o,g,a):S.apply(o,g)})}function ht(e){var t,n,r,s=e.length,o=i.relative[e[0].type],u=o||i.relative[" "],a=o?1:0,f=at(function(e){return e===t},u,!0),l=at(function(e){return T.call(t,e)&gt;-1},u,!0),h=[function(e,n,r){return!o&amp;&amp;(r||n!==c)||((t=n).nodeType?f(e,n,r):l(e,n,r))}];for(;a&lt;s;a++)if(n=i.relative[e[a].type])h=[at(ft(h),n)];else{n=i.filter[e[a].type].apply(null,e[a].matches);if(n[d]){r=++a;for(;r&lt;s;r++)if(i.relative[e[r].type])break;return ct(a&gt;1&amp;&amp;ft(h),a&gt;1&amp;&amp;e.slice(0,a-1).join("").replace(j,"$1"),n,a&lt;r&amp;&amp;ht(e.slice(a,r)),r&lt;s&amp;&amp;ht(e=e.slice(r)),r&lt;s&amp;&amp;e.join(""))}h.push(n)}return ft(h)}function pt(e,t){var r=t.length&gt;0,s=e.length&gt;0,o=function(u,a,f,l,h){var p,d,v,m=[],y=0,w="0",x=u&amp;&amp;[],T=h!=null,N=c,C=u||s&amp;&amp;i.find.TAG("*",h&amp;&amp;a.parentNode||a),k=b+=N==null?1:Math.E;T&amp;&amp;(c=a!==g&amp;&amp;a,n=o.el);for(;(p=C[w])!=null;w++){if(s&amp;&amp;p){for(d=0;v=e[d];d++)if(v(p,a,f)){l.push(p);break}T&amp;&amp;(b=k,n=++o.el)}r&amp;&amp;((p=!v&amp;&amp;p)&amp;&amp;y--,u&amp;&amp;x.push(p))}y+=w;if(r&amp;&amp;w!==y){for(d=0;v=t[d];d++)v(x,m,a,f);if(u){if(y&gt;0)while(w--)!x[w]&amp;&amp;!m[w]&amp;&amp;(m[w]=E.call(l));m=lt(m)}S.apply(l,m),T&amp;&amp;!u&amp;&amp;m.length&gt;0&amp;&amp;y+t.length&gt;1&amp;&amp;nt.uniqueSort(l)}return T&amp;&amp;(b=k,c=N),x};return o.el=0,r?N(o):o}function dt(e,t,n){var r=0,i=t.length;for(;r&lt;i;r++)nt(e,t[r],n);return n}function vt(e,t,n,r,s){var o,u,f,l,c,h=ut(e),p=h.length;if(!r&amp;&amp;h.length===1){u=h[0]=h[0].slice(0);if(u.length&gt;2&amp;&amp;(f=u[0]).type==="ID"&amp;&amp;t.nodeType===9&amp;&amp;!s&amp;&amp;i.relative[u[1].type]){t=i.find.ID(f.matches[0].replace($,""),t,s)[0];if(!t)return n;e=e.slice(u.shift().length)}for(o=J.POS.test(e)?-1:u.length-1;o&gt;=0;o--){f=u[o];if(i.relative[l=f.type])break;if(c=i.find[l])if(r=c(f.matches[0].replace($,""),z.test(u[0].type)&amp;&amp;t.parentNode||t,s)){u.splice(o,1),e=r.length&amp;&amp;u.join("");if(!e)return S.apply(n,x.call(r,0)),n;break}}}return a(e,h)(r,t,s,n,z.test(e)),n}function mt(){}var n,r,i,s,o,u,a,f,l,c,h=!0,p="undefined",d=("sizcache"+Math.random()).replace(".",""),m=String,g=e.document,y=g.documentElement,b=0,w=0,E=[].pop,S=[].push,x=[].slice,T=[].indexOf||function(e){var t=0,n=this.length;for(;t&lt;n;t++)if(this[t]===e)return t;return-1},N=function(e,t){return e[d]=t==null||t,e},C=function(){var e={},t=[];return N(function(n,r){return t.push(n)&gt;i.cacheLength&amp;&amp;delete e[t.shift()],e[n+" "]=r},e)},k=C(),L=C(),A=C(),O="[\\x20\\t\\r\\n\\f]",M="(?:\\\\.|[-\\w]|[^\\x00-\\xa0])+",_=M.replace("w","w#"),D="([*^$|!~]?=)",P="\\["+O+"*("+M+")"+O+"*(?:"+D+O+"*(?:(['\"])((?:\\\\.|[^\\\\])*?)\\3|("+_+")|)|)"+O+"*\\]",H=":("+M+")(?:\\((?:(['\"])((?:\\\\.|[^\\\\])*?)\\2|([^()[\\]]*|(?:(?:"+P+")|[^:]|\\\\.)*|.*))\\)|)",B=":(even|odd|eq|gt|lt|nth|first|last)(?:\\("+O+"*((?:-\\d)?\\d*)"+O+"*\\)|)(?=[^-]|$)",j=new RegExp("^"+O+"+|((?:^|[^\\\\])(?:\\\\.)*)"+O+"+$","g"),F=new RegExp("^"+O+"*,"+O+"*"),I=new RegExp("^"+O+"*([\\x20\\t\\r\\n\\f&gt;+~])"+O+"*"),q=new RegExp(H),R=/^(?:#([\w\-]+)|(\w+)|\.([\w\-]+))$/,U=/^:not/,z=/[\x20\t\r\n\f]*[+~]/,W=/:not\($/,X=/h\d/i,V=/input|select|textarea|button/i,$=/\\(?!\\)/g,J={ID:new RegExp("^#("+M+")"),CLASS:new RegExp("^\\.("+M+")"),NAME:new RegExp("^\\[name=['\"]?("+M+")['\"]?\\]"),TAG:new RegExp("^("+M.replace("w","w*")+")"),ATTR:new RegExp("^"+P),PSEUDO:new RegExp("^"+H),POS:new RegExp(B,"i"),CHILD:new RegExp("^:(only|nth|first|last)-child(?:\\("+O+"*(even|odd|(([+-]|)(\\d*)n|)"+O+"*(?:([+-]|)"+O+"*(\\d+)|))"+O+"*\\)|)","i"),needsContext:new RegExp("^"+O+"*[&gt;+~]|"+B,"i")},K=function(e){var t=g.createElement("div");try{return e(t)}catch(n){return!1}finally{t=null}},Q=K(function(e){return e.appendChild(g.createComment("")),!e.getElementsByTagName("*").length}),G=K(function(e){return e.innerHTML="&lt;a href='#'&gt;&lt;/a&gt;",e.firstChild&amp;&amp;typeof e.firstChild.getAttribute!==p&amp;&amp;e.firstChild.getAttribute("href")==="#"}),Y=K(function(e){e.innerHTML="&lt;select&gt;&lt;/select&gt;";var t=typeof e.lastChild.getAttribute("multiple");return t!=="boolean"&amp;&amp;t!=="string"}),Z=K(function(e){return e.innerHTML="&lt;div class='hidden e'&gt;&lt;/div&gt;&lt;div class='hidden'&gt;&lt;/div&gt;",!e.getElementsByClassName||!e.getElementsByClassName("e").length?!1:(e.lastChild.className="e",e.getElementsByClassName("e").length===2)}),et=K(function(e){e.id=d+0,e.innerHTML="&lt;a name='"+d+"'&gt;&lt;/a&gt;&lt;div name='"+d+"'&gt;&lt;/div&gt;",y.insertBefore(e,y.firstChild);var t=g.getElementsByName&amp;&amp;g.getElementsByName(d).length===2+g.getElementsByName(d+0).length;return r=!g.getElementById(d),y.removeChild(e),t});try{x.call(y.childNodes,0)[0].nodeType}catch(tt){x=function(e){var t,n=[];for(;t=this[e];e++)n.push(t);return n}}nt.matches=function(e,t){return nt(e,null,null,t)},nt.matchesSelector=function(e,t){return nt(t,null,null,[e]).length&gt;0},s=nt.getText=function(e){var t,n="",r=0,i=e.nodeType;if(i){if(i===1||i===9||i===11){if(typeof e.textContent=="string")return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)n+=s(e)}else if(i===3||i===4)return e.nodeValue}else for(;t=e[r];r++)n+=s(t);return n},o=nt.isXML=function(e){var t=e&amp;&amp;(e.ownerDocument||e).documentElement;return t?t.nodeName!=="HTML":!1},u=nt.contains=y.contains?function(e,t){var n=e.nodeType===9?e.documentElement:e,r=t&amp;&amp;t.parentNode;return e===r||!!(r&amp;&amp;r.nodeType===1&amp;&amp;n.contains&amp;&amp;n.contains(r))}:y.compareDocumentPosition?function(e,t){return t&amp;&amp;!!(e.compareDocumentPosition(t)&amp;16)}:function(e,t){while(t=t.parentNode)if(t===e)return!0;return!1},nt.attr=function(e,t){var n,r=o(e);return r||(t=t.toLowerCase()),(n=i.attrHandle[t])?n(e):r||Y?e.getAttribute(t):(n=e.getAttributeNode(t),n?typeof e[t]=="boolean"?e[t]?t:null:n.specified?n.value:null:null)},i=nt.selectors={cacheLength:50,createPseudo:N,match:J,attrHandle:G?{}:{href:function(e){return e.getAttribute("href",2)},type:function(e){return e.getAttribute("type")}},find:{ID:r?function(e,t,n){if(typeof t.getElementById!==p&amp;&amp;!n){var r=t.getElementById(e);return r&amp;&amp;r.parentNode?[r]:[]}}:function(e,n,r){if(typeof n.getElementById!==p&amp;&amp;!r){var i=n.getElementById(e);return i?i.id===e||typeof i.getAttributeNode!==p&amp;&amp;i.getAttributeNode("id").value===e?[i]:t:[]}},TAG:Q?function(e,t){if(typeof t.getElementsByTagName!==p)return t.getElementsByTagName(e)}:function(e,t){var n=t.getElementsByTagName(e);if(e==="*"){var r,i=[],s=0;for(;r=n[s];s++)r.nodeType===1&amp;&amp;i.push(r);return i}return n},NAME:et&amp;&amp;function(e,t){if(typeof t.getElementsByName!==p)return t.getElementsByName(name)},CLASS:Z&amp;&amp;function(e,t,n){if(typeof t.getElementsByClassName!==p&amp;&amp;!n)return t.getElementsByClassName(e)}},relative:{"&gt;":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace($,""),e[3]=(e[4]||e[5]||"").replace($,""),e[2]==="~="&amp;&amp;(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),e[1]==="nth"?(e[2]||nt.error(e[0]),e[3]=+(e[3]?e[4]+(e[5]||1):2*(e[2]==="even"||e[2]==="odd")),e[4]=+(e[6]+e[7]||e[2]==="odd")):e[2]&amp;&amp;nt.error(e[0]),e},PSEUDO:function(e){var t,n;if(J.CHILD.test(e[0]))return null;if(e[3])e[2]=e[3];else if(t=e[4])q.test(t)&amp;&amp;(n=ut(t,!0))&amp;&amp;(n=t.indexOf(")",t.length-n)-t.length)&amp;&amp;(t=t.slice(0,n),e[0]=e[0].slice(0,n)),e[2]=t;return e.slice(0,3)}},filter:{ID:r?function(e){return e=e.replace($,""),function(t){return t.getAttribute("id")===e}}:function(e){return e=e.replace($,""),function(t){var n=typeof t.getAttributeNode!==p&amp;&amp;t.getAttributeNode("id");return n&amp;&amp;n.value===e}},TAG:function(e){return e==="*"?function(){return!0}:(e=e.replace($,"").toLowerCase(),function(t){return t.nodeName&amp;&amp;t.nodeName.toLowerCase()===e})},CLASS:function(e){var t=k[d][e+" "];return t||(t=new RegExp("(^|"+O+")"+e+"("+O+"|$)"))&amp;&amp;k(e,function(e){return t.test(e.className||typeof e.getAttribute!==p&amp;&amp;e.getAttribute("class")||"")})},ATTR:function(e,t,n){return function(r,i){var s=nt.attr(r,e);return s==null?t==="!=":t?(s+="",t==="="?s===n:t==="!="?s!==n:t==="^="?n&amp;&amp;s.indexOf(n)===0:t==="*="?n&amp;&amp;s.indexOf(n)&gt;-1:t==="$="?n&amp;&amp;s.substr(s.length-n.length)===n:t==="~="?(" "+s+" ").indexOf(n)&gt;-1:t==="|="?s===n||s.substr(0,n.length+1)===n+"-":!1):!0}},CHILD:function(e,t,n,r){return e==="nth"?function(e){var t,i,s=e.parentNode;if(n===1&amp;&amp;r===0)return!0;if(s){i=0;for(t=s.firstChild;t;t=t.nextSibling)if(t.nodeType===1){i++;if(e===t)break}}return i-=r,i===n||i%n===0&amp;&amp;i/n&gt;=0}:function(t){var n=t;switch(e){case"only":case"first":while(n=n.previousSibling)if(n.nodeType===1)return!1;if(e==="first")return!0;n=t;case"last":while(n=n.nextSibling)if(n.nodeType===1)return!1;return!0}}},PSEUDO:function(e,t){var n,r=i.pseudos[e]||i.setFilters[e.toLowerCase()]||nt.error("unsupported pseudo: "+e);return r[d]?r(t):r.length&gt;1?(n=[e,e,"",t],i.setFilters.hasOwnProperty(e.toLowerCase())?N(function(e,n){var i,s=r(e,t),o=s.length;while(o--)i=T.call(e,s[o]),e[i]=!(n[i]=s[o])}):function(e){return r(e,0,n)}):r}},pseudos:{not:N(function(e){var t=[],n=[],r=a(e.replace(j,"$1"));return r[d]?N(function(e,t,n,i){var s,o=r(e,null,i,[]),u=e.length;while(u--)if(s=o[u])e[u]=!(t[u]=s)}):function(e,i,s){return t[0]=e,r(t,null,s,n),!n.pop()}}),has:N(function(e){return function(t){return nt(e,t).length&gt;0}}),contains:N(function(e){return function(t){return(t.textContent||t.innerText||s(t)).indexOf(e)&gt;-1}}),enabled:function(e){return e.disabled===!1},disabled:function(e){return e.disabled===!0},checked:function(e){var t=e.nodeName.toLowerCase();return t==="input"&amp;&amp;!!e.checked||t==="option"&amp;&amp;!!e.selected},selected:function(e){return e.parentNode&amp;&amp;e.parentNode.selectedIndex,e.selected===!0},parent:function(e){return!i.pseudos.empty(e)},empty:function(e){var t;e=e.firstChild;while(e){if(e.nodeName&gt;"@"||(t=e.nodeType)===3||t===4)return!1;e=e.nextSibling}return!0},header:function(e){return X.test(e.nodeName)},text:function(e){var t,n;return e.nodeName.toLowerCase()==="input"&amp;&amp;(t=e.type)==="text"&amp;&amp;((n=e.getAttribute("type"))==null||n.toLowerCase()===t)},radio:rt("radio"),checkbox:rt("checkbox"),file:rt("file"),password:rt("password"),image:rt("image"),submit:it("submit"),reset:it("reset"),button:function(e){var t=e.nodeName.toLowerCase();return t==="input"&amp;&amp;e.type==="button"||t==="button"},input:function(e){return V.test(e.nodeName)},focus:function(e){var t=e.ownerDocument;return e===t.activeElement&amp;&amp;(!t.hasFocus||t.hasFocus())&amp;&amp;!!(e.type||e.href||~e.tabIndex)},active:function(e){return e===e.ownerDocument.activeElement},first:st(function(){return[0]}),last:st(function(e,t){return[t-1]}),eq:st(function(e,t,n){return[n&lt;0?n+t:n]}),even:st(function(e,t){for(var n=0;n&lt;t;n+=2)e.push(n);return e}),odd:st(function(e,t){for(var n=1;n&lt;t;n+=2)e.push(n);return e}),lt:st(function(e,t,n){for(var r=n&lt;0?n+t:n;--r&gt;=0;)e.push(r);return e}),gt:st(function(e,t,n){for(var r=n&lt;0?n+t:n;++r&lt;t;)e.push(r);return e})}},f=y.compareDocumentPosition?function(e,t){return e===t?(l=!0,0):(!e.compareDocumentPosition||!t.compareDocumentPosition?e.compareDocumentPosition:e.compareDocumentPosition(t)&amp;4)?-1:1}:function(e,t){if(e===t)return l=!0,0;if(e.sourceIndex&amp;&amp;t.sourceIndex)return e.sourceIndex-t.sourceIndex;var n,r,i=[],s=[],o=e.parentNode,u=t.parentNode,a=o;if(o===u)return ot(e,t);if(!o)return-1;if(!u)return 1;while(a)i.unshift(a),a=a.parentNode;a=u;while(a)s.unshift(a),a=a.parentNode;n=i.length,r=s.length;for(var f=0;f&lt;n&amp;&amp;f&lt;r;f++)if(i[f]!==s[f])return ot(i[f],s[f]);return f===n?ot(e,s[f],-1):ot(i[f],t,1)},[0,0].sort(f),h=!l,nt.uniqueSort=function(e){var t,n=[],r=1,i=0;l=h,e.sort(f);if(l){for(;t=e[r];r++)t===e[r-1]&amp;&amp;(i=n.push(r));while(i--)e.splice(n[i],1)}return e},nt.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)},a=nt.compile=function(e,t){var n,r=[],i=[],s=A[d][e+" "];if(!s){t||(t=ut(e)),n=t.length;while(n--)s=ht(t[n]),s[d]?r.push(s):i.push(s);s=A(e,pt(i,r))}return s},g.querySelectorAll&amp;&amp;function(){var e,t=vt,n=/'|\\/g,r=/\=[\x20\t\r\n\f]*([^'"\]]*)[\x20\t\r\n\f]*\]/g,i=[":focus"],s=[":active"],u=y.matchesSelector||y.mozMatchesSelector||y.webkitMatchesSelector||y.oMatchesSelector||y.msMatchesSelector;K(function(e){e.innerHTML="&lt;select&gt;&lt;option selected=''&gt;&lt;/option&gt;&lt;/select&gt;",e.querySelectorAll("[selected]").length||i.push("\\["+O+"*(?:checked|disabled|ismap|multiple|readonly|selected|value)"),e.querySelectorAll(":checked").length||i.push(":checked")}),K(function(e){e.innerHTML="&lt;p test=''&gt;&lt;/p&gt;",e.querySelectorAll("[test^='']").length&amp;&amp;i.push("[*^$]="+O+"*(?:\"\"|'')"),e.innerHTML="&lt;input type='hidden'/&gt;",e.querySelectorAll(":enabled").length||i.push(":enabled",":disabled")}),i=new RegExp(i.join("|")),vt=function(e,r,s,o,u){if(!o&amp;&amp;!u&amp;&amp;!i.test(e)){var a,f,l=!0,c=d,h=r,p=r.nodeType===9&amp;&amp;e;if(r.nodeType===1&amp;&amp;r.nodeName.toLowerCase()!=="object"){a=ut(e),(l=r.getAttribute("id"))?c=l.replace(n,"\\$&amp;"):r.setAttribute("id",c),c="[id='"+c+"'] ",f=a.length;while(f--)a[f]=c+a[f].join("");h=z.test(e)&amp;&amp;r.parentNode||r,p=a.join(",")}if(p)try{return S.apply(s,x.call(h.querySelectorAll(p),0)),s}catch(v){}finally{l||r.removeAttribute("id")}}return t(e,r,s,o,u)},u&amp;&amp;(K(function(t){e=u.call(t,"div");try{u.call(t,"[test!='']:sizzle"),s.push("!=",H)}catch(n){}}),s=new RegExp(s.join("|")),nt.matchesSelector=function(t,n){n=n.replace(r,"='$1']");if(!o(t)&amp;&amp;!s.test(n)&amp;&amp;!i.test(n))try{var a=u.call(t,n);if(a||e||t.document&amp;&amp;t.document.nodeType!==11)return a}catch(f){}return nt(n,null,null,[t]).length&gt;0})}(),i.pseudos.nth=i.pseudos.eq,i.filters=mt.prototype=i.pseudos,i.setFilters=new mt,nt.attr=v.attr,v.find=nt,v.expr=nt.selectors,v.expr[":"]=v.expr.pseudos,v.unique=nt.uniqueSort,v.text=nt.getText,v.isXMLDoc=nt.isXML,v.contains=nt.contains}(e);var nt=/Until$/,rt=/^(?:parents|prev(?:Until|All))/,it=/^.[^:#\[\.,]*$/,st=v.expr.match.needsContext,ot={children:!0,contents:!0,next:!0,prev:!0};v.fn.extend({find:function(e){var t,n,r,i,s,o,u=this;if(typeof e!="string")return v(e).filter(function(){for(t=0,n=u.length;t&lt;n;t++)if(v.contains(u[t],this))return!0});o=this.pushStack("","find",e);for(t=0,n=this.length;t&lt;n;t++){r=o.length,v.find(e,this[t],o);if(t&gt;0)for(i=r;i&lt;o.length;i++)for(s=0;s&lt;r;s++)if(o[s]===o[i]){o.splice(i--,1);break}}return o},has:function(e){var t,n=v(e,this),r=n.length;return this.filter(function(){for(t=0;t&lt;r;t++)if(v.contains(this,n[t]))return!0})},not:function(e){return this.pushStack(ft(this,e,!1),"not",e)},filter:function(e){return this.pushStack(ft(this,e,!0),"filter",e)},is:function(e){return!!e&amp;&amp;(typeof e=="string"?st.test(e)?v(e,this.context).index(this[0])&gt;=0:v.filter(e,this).length&gt;0:this.filter(e).length&gt;0)},closest:function(e,t){var n,r=0,i=this.length,s=[],o=st.test(e)||typeof e!="string"?v(e,t||this.context):0;for(;r&lt;i;r++){n=this[r];while(n&amp;&amp;n.ownerDocument&amp;&amp;n!==t&amp;&amp;n.nodeType!==11){if(o?o.index(n)&gt;-1:v.find.matchesSelector(n,e)){s.push(n);break}n=n.parentNode}}return s=s.length&gt;1?v.unique(s):s,this.pushStack(s,"closest",e)},index:function(e){return e?typeof e=="string"?v.inArray(this[0],v(e)):v.inArray(e.jquery?e[0]:e,this):this[0]&amp;&amp;this[0].parentNode?this.prevAll().length:-1},add:function(e,t){var n=typeof e=="string"?v(e,t):v.makeArray(e&amp;&amp;e.nodeType?[e]:e),r=v.merge(this.get(),n);return this.pushStack(ut(n[0])||ut(r[0])?r:v.unique(r))},addBack:function(e){return this.add(e==null?this.prevObject:this.prevObject.filter(e))}}),v.fn.andSelf=v.fn.addBack,v.each({parent:function(e){var t=e.parentNode;return t&amp;&amp;t.nodeType!==11?t:null},parents:function(e){return v.dir(e,"parentNode")},parentsUntil:function(e,t,n){return v.dir(e,"parentNode",n)},next:function(e){return at(e,"nextSibling")},prev:function(e){return at(e,"previousSibling")},nextAll:function(e){return v.dir(e,"nextSibling")},prevAll:function(e){return v.dir(e,"previousSibling")},nextUntil:function(e,t,n){return v.dir(e,"nextSibling",n)},prevUntil:function(e,t,n){return v.dir(e,"previousSibling",n)},siblings:function(e){return v.sibling((e.parentNode||{}).firstChild,e)},children:function(e){return v.sibling(e.firstChild)},contents:function(e){return v.nodeName(e,"iframe")?e.contentDocument||e.contentWindow.document:v.merge([],e.childNodes)}},function(e,t){v.fn[e]=function(n,r){var i=v.map(this,t,n);return nt.test(e)||(r=n),r&amp;&amp;typeof r=="string"&amp;&amp;(i=v.filter(r,i)),i=this.length&gt;1&amp;&amp;!ot[e]?v.unique(i):i,this.length&gt;1&amp;&amp;rt.test(e)&amp;&amp;(i=i.reverse()),this.pushStack(i,e,l.call(arguments).join(","))}}),v.extend({filter:function(e,t,n){return n&amp;&amp;(e=":not("+e+")"),t.length===1?v.find.matchesSelector(t[0],e)?[t[0]]:[]:v.find.matches(e,t)},dir:function(e,n,r){var i=[],s=e[n];while(s&amp;&amp;s.nodeType!==9&amp;&amp;(r===t||s.nodeType!==1||!v(s).is(r)))s.nodeType===1&amp;&amp;i.push(s),s=s[n];return i},sibling:function(e,t){var n=[];for(;e;e=e.nextSibling)e.nodeType===1&amp;&amp;e!==t&amp;&amp;n.push(e);return n}});var ct="abbr|article|aside|audio|bdi|canvas|data|datalist|details|figcaption|figure|footer|header|hgroup|mark|meter|nav|output|progress|section|summary|time|video",ht=/ jQuery\d+="(?:null|\d+)"/g,pt=/^\s+/,dt=/&lt;(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^&gt;]*)\/&gt;/gi,vt=/&lt;([\w:]+)/,mt=/&lt;tbody/i,gt=/&lt;|&amp;#?\w+;/,yt=/&lt;(?:script|style|link)/i,bt=/&lt;(?:script|object|embed|option|style)/i,wt=new RegExp("&lt;(?:"+ct+")[\\s/&gt;]","i"),Et=/^(?:checkbox|radio)$/,St=/checked\s*(?:[^=]|=\s*.checked.)/i,xt=/\/(java|ecma)script/i,Tt=/^\s*&lt;!(?:\[CDATA\[|\-\-)|[\]\-]{2}&gt;\s*$/g,Nt={option:[1,"&lt;select multiple='multiple'&gt;","&lt;/select&gt;"],legend:[1,"&lt;fieldset&gt;","&lt;/fieldset&gt;"],thead:[1,"&lt;table&gt;","&lt;/table&gt;"],tr:[2,"&lt;table&gt;&lt;tbody&gt;","&lt;/tbody&gt;&lt;/table&gt;"],td:[3,"&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;","&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;"],col:[2,"&lt;table&gt;&lt;tbody&gt;&lt;/tbody&gt;&lt;colgroup&gt;","&lt;/colgroup&gt;&lt;/table&gt;"],area:[1,"&lt;map&gt;","&lt;/map&gt;"],_default:[0,"",""]},Ct=lt(i),kt=Ct.appendChild(i.createElement("div"));Nt.optgroup=Nt.option,Nt.tbody=Nt.tfoot=Nt.colgroup=Nt.caption=Nt.thead,Nt.th=Nt.td,v.support.htmlSerialize||(Nt._default=[1,"X&lt;div&gt;","&lt;/div&gt;"]),v.fn.extend({text:function(e){return v.access(this,function(e){return e===t?v.text(this):this.empty().append((this[0]&amp;&amp;this[0].ownerDocument||i).createTextNode(e))},null,e,arguments.length)},wrapAll:function(e){if(v.isFunction(e))return this.each(function(t){v(this).wrapAll(e.call(this,t))});if(this[0]){var t=v(e,this[0].ownerDocument).eq(0).clone(!0);this[0].parentNode&amp;&amp;t.insertBefore(this[0]),t.map(function(){var e=this;while(e.firstChild&amp;&amp;e.firstChild.nodeType===1)e=e.firstChild;return e}).append(this)}return this},wrapInner:function(e){return v.isFunction(e)?this.each(function(t){v(this).wrapInner(e.call(this,t))}):this.each(function(){var t=v(this),n=t.contents();n.length?n.wrapAll(e):t.append(e)})},wrap:function(e){var t=v.isFunction(e);return this.each(function(n){v(this).wrapAll(t?e.call(this,n):e)})},unwrap:function(){return this.parent().each(function(){v.nodeName(this,"body")||v(this).replaceWith(this.childNodes)}).end()},append:function(){return this.domManip(arguments,!0,function(e){(this.nodeType===1||this.nodeType===11)&amp;&amp;this.appendChild(e)})},prepend:function(){return this.domManip(arguments,!0,function(e){(this.nodeType===1||this.nodeType===11)&amp;&amp;this.insertBefore(e,this.firstChild)})},before:function(){if(!ut(this[0]))return this.domManip(arguments,!1,function(e){this.parentNode.insertBefore(e,this)});if(arguments.length){var e=v.clean(arguments);return this.pushStack(v.merge(e,this),"before",this.selector)}},after:function(){if(!ut(this[0]))return this.domManip(arguments,!1,function(e){this.parentNode.insertBefore(e,this.nextSibling)});if(arguments.length){var e=v.clean(arguments);return this.pushStack(v.merge(this,e),"after",this.selector)}},remove:function(e,t){var n,r=0;for(;(n=this[r])!=null;r++)if(!e||v.filter(e,[n]).length)!t&amp;&amp;n.nodeType===1&amp;&amp;(v.cleanData(n.getElementsByTagName("*")),v.cleanData([n])),n.parentNode&amp;&amp;n.parentNode.removeChild(n);return this},empty:function(){var e,t=0;for(;(e=this[t])!=null;t++){e.nodeType===1&amp;&amp;v.cleanData(e.getElementsByTagName("*"));while(e.firstChild)e.removeChild(e.firstChild)}return this},clone:function(e,t){return e=e==null?!1:e,t=t==null?e:t,this.map(function(){return v.clone(this,e,t)})},html:function(e){return v.access(this,function(e){var n=this[0]||{},r=0,i=this.length;if(e===t)return n.nodeType===1?n.innerHTML.replace(ht,""):t;if(typeof e=="string"&amp;&amp;!yt.test(e)&amp;&amp;(v.support.htmlSerialize||!wt.test(e))&amp;&amp;(v.support.leadingWhitespace||!pt.test(e))&amp;&amp;!Nt[(vt.exec(e)||["",""])[1].toLowerCase()]){e=e.replace(dt,"&lt;$1&gt;&lt;/$2&gt;");try{for(;r&lt;i;r++)n=this[r]||{},n.nodeType===1&amp;&amp;(v.cleanData(n.getElementsByTagName("*")),n.innerHTML=e);n=0}catch(s){}}n&amp;&amp;this.empty().append(e)},null,e,arguments.length)},replaceWith:function(e){return ut(this[0])?this.length?this.pushStack(v(v.isFunction(e)?e():e),"replaceWith",e):this:v.isFunction(e)?this.each(function(t){var n=v(this),r=n.html();n.replaceWith(e.call(this,t,r))}):(typeof e!="string"&amp;&amp;(e=v(e).detach()),this.each(function(){var t=this.nextSibling,n=this.parentNode;v(this).remove(),t?v(t).before(e):v(n).append(e)}))},detach:function(e){return this.remove(e,!0)},domManip:function(e,n,r){e=[].concat.apply([],e);var i,s,o,u,a=0,f=e[0],l=[],c=this.length;if(!v.support.checkClone&amp;&amp;c&gt;1&amp;&amp;typeof f=="string"&amp;&amp;St.test(f))return this.each(function(){v(this).domManip(e,n,r)});if(v.isFunction(f))return this.each(function(i){var s=v(this);e[0]=f.call(this,i,n?s.html():t),s.domManip(e,n,r)});if(this[0]){i=v.buildFragment(e,this,l),o=i.fragment,s=o.firstChild,o.childNodes.length===1&amp;&amp;(o=s);if(s){n=n&amp;&amp;v.nodeName(s,"tr");for(u=i.cacheable||c-1;a&lt;c;a++)r.call(n&amp;&amp;v.nodeName(this[a],"table")?Lt(this[a],"tbody"):this[a],a===u?o:v.clone(o,!0,!0))}o=s=null,l.length&amp;&amp;v.each(l,function(e,t){t.src?v.ajax?v.ajax({url:t.src,type:"GET",dataType:"script",async:!1,global:!1,"throws":!0}):v.error("no ajax"):v.globalEval((t.text||t.textContent||t.innerHTML||"").replace(Tt,"")),t.parentNode&amp;&amp;t.parentNode.removeChild(t)})}return this}}),v.buildFragment=function(e,n,r){var s,o,u,a=e[0];return n=n||i,n=!n.nodeType&amp;&amp;n[0]||n,n=n.ownerDocument||n,e.length===1&amp;&amp;typeof a=="string"&amp;&amp;a.length&lt;512&amp;&amp;n===i&amp;&amp;a.charAt(0)==="&lt;"&amp;&amp;!bt.test(a)&amp;&amp;(v.support.checkClone||!St.test(a))&amp;&amp;(v.support.html5Clone||!wt.test(a))&amp;&amp;(o=!0,s=v.fragments[a],u=s!==t),s||(s=n.createDocumentFragment(),v.clean(e,n,s,r),o&amp;&amp;(v.fragments[a]=u&amp;&amp;s)),{fragment:s,cacheable:o}},v.fragments={},v.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,t){v.fn[e]=function(n){var r,i=0,s=[],o=v(n),u=o.length,a=this.length===1&amp;&amp;this[0].parentNode;if((a==null||a&amp;&amp;a.nodeType===11&amp;&amp;a.childNodes.length===1)&amp;&amp;u===1)return o[t](this[0]),this;for(;i&lt;u;i++)r=(i&gt;0?this.clone(!0):this).get(),v(o[i])[t](r),s=s.concat(r);return this.pushStack(s,e,o.selector)}}),v.extend({clone:function(e,t,n){var r,i,s,o;v.support.html5Clone||v.isXMLDoc(e)||!wt.test("&lt;"+e.nodeName+"&gt;")?o=e.cloneNode(!0):(kt.innerHTML=e.outerHTML,kt.removeChild(o=kt.firstChild));if((!v.support.noCloneEvent||!v.support.noCloneChecked)&amp;&amp;(e.nodeType===1||e.nodeType===11)&amp;&amp;!v.isXMLDoc(e)){Ot(e,o),r=Mt(e),i=Mt(o);for(s=0;r[s];++s)i[s]&amp;&amp;Ot(r[s],i[s])}if(t){At(e,o);if(n){r=Mt(e),i=Mt(o);for(s=0;r[s];++s)At(r[s],i[s])}}return r=i=null,o},clean:function(e,t,n,r){var s,o,u,a,f,l,c,h,p,d,m,g,y=t===i&amp;&amp;Ct,b=[];if(!t||typeof t.createDocumentFragment=="undefined")t=i;for(s=0;(u=e[s])!=null;s++){typeof u=="number"&amp;&amp;(u+="");if(!u)continue;if(typeof u=="string")if(!gt.test(u))u=t.createTextNode(u);else{y=y||lt(t),c=t.createElement("div"),y.appendChild(c),u=u.replace(dt,"&lt;$1&gt;&lt;/$2&gt;"),a=(vt.exec(u)||["",""])[1].toLowerCase(),f=Nt[a]||Nt._default,l=f[0],c.innerHTML=f[1]+u+f[2];while(l--)c=c.lastChild;if(!v.support.tbody){h=mt.test(u),p=a==="table"&amp;&amp;!h?c.firstChild&amp;&amp;c.firstChild.childNodes:f[1]==="&lt;table&gt;"&amp;&amp;!h?c.childNodes:[];for(o=p.length-1;o&gt;=0;--o)v.nodeName(p[o],"tbody")&amp;&amp;!p[o].childNodes.length&amp;&amp;p[o].parentNode.removeChild(p[o])}!v.support.leadingWhitespace&amp;&amp;pt.test(u)&amp;&amp;c.insertBefore(t.createTextNode(pt.exec(u)[0]),c.firstChild),u=c.childNodes,c.parentNode.removeChild(c)}u.nodeType?b.push(u):v.merge(b,u)}c&amp;&amp;(u=c=y=null);if(!v.support.appendChecked)for(s=0;(u=b[s])!=null;s++)v.nodeName(u,"input")?_t(u):typeof u.getElementsByTagName!="undefined"&amp;&amp;v.grep(u.getElementsByTagName("input"),_t);if(n){m=function(e){if(!e.type||xt.test(e.type))return r?r.push(e.parentNode?e.parentNode.removeChild(e):e):n.appendChild(e)};for(s=0;(u=b[s])!=null;s++)if(!v.nodeName(u,"script")||!m(u))n.appendChild(u),typeof u.getElementsByTagName!="undefined"&amp;&amp;(g=v.grep(v.merge([],u.getElementsByTagName("script")),m),b.splice.apply(b,[s+1,0].concat(g)),s+=g.length)}return b},cleanData:function(e,t){var n,r,i,s,o=0,u=v.expando,a=v.cache,f=v.support.deleteExpando,l=v.event.special;for(;(i=e[o])!=null;o++)if(t||v.acceptData(i)){r=i[u],n=r&amp;&amp;a[r];if(n){if(n.events)for(s in n.events)l[s]?v.event.remove(i,s):v.removeEvent(i,s,n.handle);a[r]&amp;&amp;(delete a[r],f?delete i[u]:i.removeAttribute?i.removeAttribute(u):i[u]=null,v.deletedIds.push(r))}}}}),function(){var e,t;v.uaMatch=function(e){e=e.toLowerCase();var t=/(chrome)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||e.indexOf("compatible")&lt;0&amp;&amp;/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[];return{browser:t[1]||"",version:t[2]||"0"}},e=v.uaMatch(o.userAgent),t={},e.browser&amp;&amp;(t[e.browser]=!0,t.version=e.version),t.chrome?t.webkit=!0:t.webkit&amp;&amp;(t.safari=!0),v.browser=t,v.sub=function(){function e(t,n){return new e.fn.init(t,n)}v.extend(!0,e,this),e.superclass=this,e.fn=e.prototype=this(),e.fn.constructor=e,e.sub=this.sub,e.fn.init=function(r,i){return i&amp;&amp;i instanceof v&amp;&amp;!(i instanceof e)&amp;&amp;(i=e(i)),v.fn.init.call(this,r,i,t)},e.fn.init.prototype=e.fn;var t=e(i);return e}}();var Dt,Pt,Ht,Bt=/alpha\([^)]*\)/i,jt=/opacity=([^)]*)/,Ft=/^(top|right|bottom|left)$/,It=/^(none|table(?!-c[ea]).+)/,qt=/^margin/,Rt=new RegExp("^("+m+")(.*)$","i"),Ut=new RegExp("^("+m+")(?!px)[a-z%]+$","i"),zt=new RegExp("^([-+])=("+m+")","i"),Wt={BODY:"block"},Xt={position:"absolute",visibility:"hidden",display:"block"},Vt={letterSpacing:0,fontWeight:400},$t=["Top","Right","Bottom","Left"],Jt=["Webkit","O","Moz","ms"],Kt=v.fn.toggle;v.fn.extend({css:function(e,n){return v.access(this,function(e,n,r){return r!==t?v.style(e,n,r):v.css(e,n)},e,n,arguments.length&gt;1)},show:function(){return Yt(this,!0)},hide:function(){return Yt(this)},toggle:function(e,t){var n=typeof e=="boolean";return v.isFunction(e)&amp;&amp;v.isFunction(t)?Kt.apply(this,arguments):this.each(function(){(n?e:Gt(this))?v(this).show():v(this).hide()})}}),v.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=Dt(e,"opacity");return n===""?"1":n}}}},cssNumber:{fillOpacity:!0,fontWeight:!0,lineHeight:!0,opacity:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":v.support.cssFloat?"cssFloat":"styleFloat"},style:function(e,n,r,i){if(!e||e.nodeType===3||e.nodeType===8||!e.style)return;var s,o,u,a=v.camelCase(n),f=e.style;n=v.cssProps[a]||(v.cssProps[a]=Qt(f,a)),u=v.cssHooks[n]||v.cssHooks[a];if(r===t)return u&amp;&amp;"get"in u&amp;&amp;(s=u.get(e,!1,i))!==t?s:f[n];o=typeof r,o==="string"&amp;&amp;(s=zt.exec(r))&amp;&amp;(r=(s[1]+1)*s[2]+parseFloat(v.css(e,n)),o="number");if(r==null||o==="number"&amp;&amp;isNaN(r))return;o==="number"&amp;&amp;!v.cssNumber[a]&amp;&amp;(r+="px");if(!u||!("set"in u)||(r=u.set(e,r,i))!==t)try{f[n]=r}catch(l){}},css:function(e,n,r,i){var s,o,u,a=v.camelCase(n);return n=v.cssProps[a]||(v.cssProps[a]=Qt(e.style,a)),u=v.cssHooks[n]||v.cssHooks[a],u&amp;&amp;"get"in u&amp;&amp;(s=u.get(e,!0,i)),s===t&amp;&amp;(s=Dt(e,n)),s==="normal"&amp;&amp;n in Vt&amp;&amp;(s=Vt[n]),r||i!==t?(o=parseFloat(s),r||v.isNumeric(o)?o||0:s):s},swap:function(e,t,n){var r,i,s={};for(i in t)s[i]=e.style[i],e.style[i]=t[i];r=n.call(e);for(i in t)e.style[i]=s[i];return r}}),e.getComputedStyle?Dt=function(t,n){var r,i,s,o,u=e.getComputedStyle(t,null),a=t.style;return u&amp;&amp;(r=u.getPropertyValue(n)||u[n],r===""&amp;&amp;!v.contains(t.ownerDocument,t)&amp;&amp;(r=v.style(t,n)),Ut.test(r)&amp;&amp;qt.test(n)&amp;&amp;(i=a.width,s=a.minWidth,o=a.maxWidth,a.minWidth=a.maxWidth=a.width=r,r=u.width,a.width=i,a.minWidth=s,a.maxWidth=o)),r}:i.documentElement.currentStyle&amp;&amp;(Dt=function(e,t){var n,r,i=e.currentStyle&amp;&amp;e.currentStyle[t],s=e.style;return i==null&amp;&amp;s&amp;&amp;s[t]&amp;&amp;(i=s[t]),Ut.test(i)&amp;&amp;!Ft.test(t)&amp;&amp;(n=s.left,r=e.runtimeStyle&amp;&amp;e.runtimeStyle.left,r&amp;&amp;(e.runtimeStyle.left=e.currentStyle.left),s.left=t==="fontSize"?"1em":i,i=s.pixelLeft+"px",s.left=n,r&amp;&amp;(e.runtimeStyle.left=r)),i===""?"auto":i}),v.each(["height","width"],function(e,t){v.cssHooks[t]={get:function(e,n,r){if(n)return e.offsetWidth===0&amp;&amp;It.test(Dt(e,"display"))?v.swap(e,Xt,function(){return tn(e,t,r)}):tn(e,t,r)},set:function(e,n,r){return Zt(e,n,r?en(e,t,r,v.support.boxSizing&amp;&amp;v.css(e,"boxSizing")==="border-box"):0)}}}),v.support.opacity||(v.cssHooks.opacity={get:function(e,t){return jt.test((t&amp;&amp;e.currentStyle?e.currentStyle.filter:e.style.filter)||"")?.01*parseFloat(RegExp.$1)+"":t?"1":""},set:function(e,t){var n=e.style,r=e.currentStyle,i=v.isNumeric(t)?"alpha(opacity="+t*100+")":"",s=r&amp;&amp;r.filter||n.filter||"";n.zoom=1;if(t&gt;=1&amp;&amp;v.trim(s.replace(Bt,""))===""&amp;&amp;n.removeAttribute){n.removeAttribute("filter");if(r&amp;&amp;!r.filter)return}n.filter=Bt.test(s)?s.replace(Bt,i):s+" "+i}}),v(function(){v.support.reliableMarginRight||(v.cssHooks.marginRight={get:function(e,t){return v.swap(e,{display:"inline-block"},function(){if(t)return Dt(e,"marginRight")})}}),!v.support.pixelPosition&amp;&amp;v.fn.position&amp;&amp;v.each(["top","left"],function(e,t){v.cssHooks[t]={get:function(e,n){if(n){var r=Dt(e,t);return Ut.test(r)?v(e).position()[t]+"px":r}}}})}),v.expr&amp;&amp;v.expr.filters&amp;&amp;(v.expr.filters.hidden=function(e){return e.offsetWidth===0&amp;&amp;e.offsetHeight===0||!v.support.reliableHiddenOffsets&amp;&amp;(e.style&amp;&amp;e.style.display||Dt(e,"display"))==="none"},v.expr.filters.visible=function(e){return!v.expr.filters.hidden(e)}),v.each({margin:"",padding:"",border:"Width"},function(e,t){v.cssHooks[e+t]={expand:function(n){var r,i=typeof n=="string"?n.split(" "):[n],s={};for(r=0;r&lt;4;r++)s[e+$t[r]+t]=i[r]||i[r-2]||i[0];return s}},qt.test(e)||(v.cssHooks[e+t].set=Zt)});var rn=/%20/g,sn=/\[\]$/,on=/\r?\n/g,un=/^(?:color|date|datetime|datetime-local|email|hidden|month|number|password|range|search|tel|text|time|url|week)$/i,an=/^(?:select|textarea)/i;v.fn.extend({serialize:function(){return v.param(this.serializeArray())},serializeArray:function(){return this.map(function(){return this.elements?v.makeArray(this.elements):this}).filter(function(){return this.name&amp;&amp;!this.disabled&amp;&amp;(this.checked||an.test(this.nodeName)||un.test(this.type))}).map(function(e,t){var n=v(this).val();return n==null?null:v.isArray(n)?v.map(n,function(e,n){return{name:t.name,value:e.replace(on,"\r\n")}}):{name:t.name,value:n.replace(on,"\r\n")}}).get()}}),v.param=function(e,n){var r,i=[],s=function(e,t){t=v.isFunction(t)?t():t==null?"":t,i[i.length]=encodeURIComponent(e)+"="+encodeURIComponent(t)};n===t&amp;&amp;(n=v.ajaxSettings&amp;&amp;v.ajaxSettings.traditional);if(v.isArray(e)||e.jquery&amp;&amp;!v.isPlainObject(e))v.each(e,function(){s(this.name,this.value)});else for(r in e)fn(r,e[r],n,s);return i.join("&amp;").replace(rn,"+")};var ln,cn,hn=/#.*$/,pn=/^(.*?):[ \t]*([^\r\n]*)\r?$/mg,dn=/^(?:about|app|app\-storage|.+\-extension|file|res|widget):$/,vn=/^(?:GET|HEAD)$/,mn=/^\/\//,gn=/\?/,yn=/&lt;script\b[^&lt;]*(?:(?!&lt;\/script&gt;)&lt;[^&lt;]*)*&lt;\/script&gt;/gi,bn=/([?&amp;])_=[^&amp;]*/,wn=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+)|)|)/,En=v.fn.load,Sn={},xn={},Tn=["*/"]+["*"];try{cn=s.href}catch(Nn){cn=i.createElement("a"),cn.href="",cn=cn.href}ln=wn.exec(cn.toLowerCase())||[],v.fn.load=function(e,n,r){if(typeof e!="string"&amp;&amp;En)return En.apply(this,arguments);if(!this.length)return this;var i,s,o,u=this,a=e.indexOf(" ");return a&gt;=0&amp;&amp;(i=e.slice(a,e.length),e=e.slice(0,a)),v.isFunction(n)?(r=n,n=t):n&amp;&amp;typeof n=="object"&amp;&amp;(s="POST"),v.ajax({url:e,type:s,dataType:"html",data:n,complete:function(e,t){r&amp;&amp;u.each(r,o||[e.responseText,t,e])}}).done(function(e){o=arguments,u.html(i?v("&lt;div&gt;").append(e.replace(yn,"")).find(i):e)}),this},v.each("ajaxStart ajaxStop ajaxComplete ajaxError ajaxSuccess ajaxSend".split(" "),function(e,t){v.fn[t]=function(e){return this.on(t,e)}}),v.each(["get","post"],function(e,n){v[n]=function(e,r,i,s){return v.isFunction(r)&amp;&amp;(s=s||i,i=r,r=t),v.ajax({type:n,url:e,data:r,success:i,dataType:s})}}),v.extend({getScript:function(e,n){return v.get(e,t,n,"script")},getJSON:function(e,t,n){return v.get(e,t,n,"json")},ajaxSetup:function(e,t){return t?Ln(e,v.ajaxSettings):(t=e,e=v.ajaxSettings),Ln(e,t),e},ajaxSettings:{url:cn,isLocal:dn.test(ln[1]),global:!0,type:"GET",contentType:"application/x-www-form-urlencoded; charset=UTF-8",processData:!0,async:!0,accepts:{xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript","*":Tn},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText"},converters:{"* text":e.String,"text html":!0,"text json":v.parseJSON,"text xml":v.parseXML},flatOptions:{context:!0,url:!0}},ajaxPrefilter:Cn(Sn),ajaxTransport:Cn(xn),ajax:function(e,n){function T(e,n,s,a){var l,y,b,w,S,T=n;if(E===2)return;E=2,u&amp;&amp;clearTimeout(u),o=t,i=a||"",x.readyState=e&gt;0?4:0,s&amp;&amp;(w=An(c,x,s));if(e&gt;=200&amp;&amp;e&lt;300||e===304)c.ifModified&amp;&amp;(S=x.getResponseHeader("Last-Modified"),S&amp;&amp;(v.lastModified[r]=S),S=x.getResponseHeader("Etag"),S&amp;&amp;(v.etag[r]=S)),e===304?(T="notmodified",l=!0):(l=On(c,w),T=l.state,y=l.data,b=l.error,l=!b);else{b=T;if(!T||e)T="error",e&lt;0&amp;&amp;(e=0)}x.status=e,x.statusText=(n||T)+"",l?d.resolveWith(h,[y,T,x]):d.rejectWith(h,[x,T,b]),x.statusCode(g),g=t,f&amp;&amp;p.trigger("ajax"+(l?"Success":"Error"),[x,c,l?y:b]),m.fireWith(h,[x,T]),f&amp;&amp;(p.trigger("ajaxComplete",[x,c]),--v.active||v.event.trigger("ajaxStop"))}typeof e=="object"&amp;&amp;(n=e,e=t),n=n||{};var r,i,s,o,u,a,f,l,c=v.ajaxSetup({},n),h=c.context||c,p=h!==c&amp;&amp;(h.nodeType||h instanceof v)?v(h):v.event,d=v.Deferred(),m=v.Callbacks("once memory"),g=c.statusCode||{},b={},w={},E=0,S="canceled",x={readyState:0,setRequestHeader:function(e,t){if(!E){var n=e.toLowerCase();e=w[n]=w[n]||e,b[e]=t}return this},getAllResponseHeaders:function(){return E===2?i:null},getResponseHeader:function(e){var n;if(E===2){if(!s){s={};while(n=pn.exec(i))s[n[1].toLowerCase()]=n[2]}n=s[e.toLowerCase()]}return n===t?null:n},overrideMimeType:function(e){return E||(c.mimeType=e),this},abort:function(e){return e=e||S,o&amp;&amp;o.abort(e),T(0,e),this}};d.promise(x),x.success=x.done,x.error=x.fail,x.complete=m.add,x.statusCode=function(e){if(e){var t;if(E&lt;2)for(t in e)g[t]=[g[t],e[t]];else t=e[x.status],x.always(t)}return this},c.url=((e||c.url)+"").replace(hn,"").replace(mn,ln[1]+"//"),c.dataTypes=v.trim(c.dataType||"*").toLowerCase().split(y),c.crossDomain==null&amp;&amp;(a=wn.exec(c.url.toLowerCase()),c.crossDomain=!(!a||a[1]===ln[1]&amp;&amp;a[2]===ln[2]&amp;&amp;(a[3]||(a[1]==="http:"?80:443))==(ln[3]||(ln[1]==="http:"?80:443)))),c.data&amp;&amp;c.processData&amp;&amp;typeof c.data!="string"&amp;&amp;(c.data=v.param(c.data,c.traditional)),kn(Sn,c,n,x);if(E===2)return x;f=c.global,c.type=c.type.toUpperCase(),c.hasContent=!vn.test(c.type),f&amp;&amp;v.active++===0&amp;&amp;v.event.trigger("ajaxStart");if(!c.hasContent){c.data&amp;&amp;(c.url+=(gn.test(c.url)?"&amp;":"?")+c.data,delete c.data),r=c.url;if(c.cache===!1){var N=v.now(),C=c.url.replace(bn,"$1_="+N);c.url=C+(C===c.url?(gn.test(c.url)?"&amp;":"?")+"_="+N:"")}}(c.data&amp;&amp;c.hasContent&amp;&amp;c.contentType!==!1||n.contentType)&amp;&amp;x.setRequestHeader("Content-Type",c.contentType),c.ifModified&amp;&amp;(r=r||c.url,v.lastModified[r]&amp;&amp;x.setRequestHeader("If-Modified-Since",v.lastModified[r]),v.etag[r]&amp;&amp;x.setRequestHeader("If-None-Match",v.etag[r])),x.setRequestHeader("Accept",c.dataTypes[0]&amp;&amp;c.accepts[c.dataTypes[0]]?c.accepts[c.dataTypes[0]]+(c.dataTypes[0]!=="*"?", "+Tn+"; q=0.01":""):c.accepts["*"]);for(l in c.headers)x.setRequestHeader(l,c.headers[l]);if(!c.beforeSend||c.beforeSend.call(h,x,c)!==!1&amp;&amp;E!==2){S="abort";for(l in{success:1,error:1,complete:1})x[l](c[l]);o=kn(xn,c,n,x);if(!o)T(-1,"No Transport");else{x.readyState=1,f&amp;&amp;p.trigger("ajaxSend",[x,c]),c.async&amp;&amp;c.timeout&gt;0&amp;&amp;(u=setTimeout(function(){x.abort("timeout")},c.timeout));try{E=1,o.send(b,T)}catch(k){if(!(E&lt;2))throw k;T(-1,k)}}return x}return x.abort()},active:0,lastModified:{},etag:{}});var Mn=[],_n=/\?/,Dn=/(=)\?(?=&amp;|$)|\?\?/,Pn=v.now();v.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=Mn.pop()||v.expando+"_"+Pn++;return this[e]=!0,e}}),v.ajaxPrefilter("json jsonp",function(n,r,i){var s,o,u,a=n.data,f=n.url,l=n.jsonp!==!1,c=l&amp;&amp;Dn.test(f),h=l&amp;&amp;!c&amp;&amp;typeof a=="string"&amp;&amp;!(n.contentType||"").indexOf("application/x-www-form-urlencoded")&amp;&amp;Dn.test(a);if(n.dataTypes[0]==="jsonp"||c||h)return s=n.jsonpCallback=v.isFunction(n.jsonpCallback)?n.jsonpCallback():n.jsonpCallback,o=e[s],c?n.url=f.replace(Dn,"$1"+s):h?n.data=a.replace(Dn,"$1"+s):l&amp;&amp;(n.url+=(_n.test(f)?"&amp;":"?")+n.jsonp+"="+s),n.converters["script json"]=function(){return u||v.error(s+" was not called"),u[0]},n.dataTypes[0]="json",e[s]=function(){u=arguments},i.always(function(){e[s]=o,n[s]&amp;&amp;(n.jsonpCallback=r.jsonpCallback,Mn.push(s)),u&amp;&amp;v.isFunction(o)&amp;&amp;o(u[0]),u=o=t}),"script"}),v.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/javascript|ecmascript/},converters:{"text script":function(e){return v.globalEval(e),e}}}),v.ajaxPrefilter("script",function(e){e.cache===t&amp;&amp;(e.cache=!1),e.crossDomain&amp;&amp;(e.type="GET",e.global=!1)}),v.ajaxTransport("script",function(e){if(e.crossDomain){var n,r=i.head||i.getElementsByTagName("head")[0]||i.documentElement;return{send:function(s,o){n=i.createElement("script"),n.async="async",e.scriptCharset&amp;&amp;(n.charset=e.scriptCharset),n.src=e.url,n.onload=n.onreadystatechange=function(e,i){if(i||!n.readyState||/loaded|complete/.test(n.readyState))n.onload=n.onreadystatechange=null,r&amp;&amp;n.parentNode&amp;&amp;r.removeChild(n),n=t,i||o(200,"success")},r.insertBefore(n,r.firstChild)},abort:function(){n&amp;&amp;n.onload(0,1)}}}});var Hn,Bn=e.ActiveXObject?function(){for(var e in Hn)Hn[e](0,1)}:!1,jn=0;v.ajaxSettings.xhr=e.ActiveXObject?function(){return!this.isLocal&amp;&amp;Fn()||In()}:Fn,function(e){v.extend(v.support,{ajax:!!e,cors:!!e&amp;&amp;"withCredentials"in e})}(v.ajaxSettings.xhr()),v.support.ajax&amp;&amp;v.ajaxTransport(function(n){if(!n.crossDomain||v.support.cors){var r;return{send:function(i,s){var o,u,a=n.xhr();n.username?a.open(n.type,n.url,n.async,n.username,n.password):a.open(n.type,n.url,n.async);if(n.xhrFields)for(u in n.xhrFields)a[u]=n.xhrFields[u];n.mimeType&amp;&amp;a.overrideMimeType&amp;&amp;a.overrideMimeType(n.mimeType),!n.crossDomain&amp;&amp;!i["X-Requested-With"]&amp;&amp;(i["X-Requested-With"]="XMLHttpRequest");try{for(u in i)a.setRequestHeader(u,i[u])}catch(f){}a.send(n.hasContent&amp;&amp;n.data||null),r=function(e,i){var u,f,l,c,h;try{if(r&amp;&amp;(i||a.readyState===4)){r=t,o&amp;&amp;(a.onreadystatechange=v.noop,Bn&amp;&amp;delete Hn[o]);if(i)a.readyState!==4&amp;&amp;a.abort();else{u=a.status,l=a.getAllResponseHeaders(),c={},h=a.responseXML,h&amp;&amp;h.documentElement&amp;&amp;(c.xml=h);try{c.text=a.responseText}catch(p){}try{f=a.statusText}catch(p){f=""}!u&amp;&amp;n.isLocal&amp;&amp;!n.crossDomain?u=c.text?200:404:u===1223&amp;&amp;(u=204)}}}catch(d){i||s(-1,d)}c&amp;&amp;s(u,f,c,l)},n.async?a.readyState===4?setTimeout(r,0):(o=++jn,Bn&amp;&amp;(Hn||(Hn={},v(e).unload(Bn)),Hn[o]=r),a.onreadystatechange=r):r()},abort:function(){r&amp;&amp;r(0,1)}}}});var qn,Rn,Un=/^(?:toggle|show|hide)$/,zn=new RegExp("^(?:([-+])=|)("+m+")([a-z%]*)$","i"),Wn=/queueHooks$/,Xn=[Gn],Vn={"*":[function(e,t){var n,r,i=this.createTween(e,t),s=zn.exec(t),o=i.cur(),u=+o||0,a=1,f=20;if(s){n=+s[2],r=s[3]||(v.cssNumber[e]?"":"px");if(r!=="px"&amp;&amp;u){u=v.css(i.elem,e,!0)||n||1;do a=a||".5",u/=a,v.style(i.elem,e,u+r);while(a!==(a=i.cur()/o)&amp;&amp;a!==1&amp;&amp;--f)}i.unit=r,i.start=u,i.end=s[1]?u+(s[1]+1)*n:n}return i}]};v.Animation=v.extend(Kn,{tweener:function(e,t){v.isFunction(e)?(t=e,e=["*"]):e=e.split(" ");var n,r=0,i=e.length;for(;r&lt;i;r++)n=e[r],Vn[n]=Vn[n]||[],Vn[n].unshift(t)},prefilter:function(e,t){t?Xn.unshift(e):Xn.push(e)}}),v.Tween=Yn,Yn.prototype={constructor:Yn,init:function(e,t,n,r,i,s){this.elem=e,this.prop=n,this.easing=i||"swing",this.options=t,this.start=this.now=this.cur(),this.end=r,this.unit=s||(v.cssNumber[n]?"":"px")},cur:function(){var e=Yn.propHooks[this.prop];return e&amp;&amp;e.get?e.get(this):Yn.propHooks._default.get(this)},run:function(e){var t,n=Yn.propHooks[this.prop];return this.options.duration?this.pos=t=v.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):this.pos=t=e,this.now=(this.end-this.start)*t+this.start,this.options.step&amp;&amp;this.options.step.call(this.elem,this.now,this),n&amp;&amp;n.set?n.set(this):Yn.propHooks._default.set(this),this}},Yn.prototype.init.prototype=Yn.prototype,Yn.propHooks={_default:{get:function(e){var t;return e.elem[e.prop]==null||!!e.elem.style&amp;&amp;e.elem.style[e.prop]!=null?(t=v.css(e.elem,e.prop,!1,""),!t||t==="auto"?0:t):e.elem[e.prop]},set:function(e){v.fx.step[e.prop]?v.fx.step[e.prop](e):e.elem.style&amp;&amp;(e.elem.style[v.cssProps[e.prop]]!=null||v.cssHooks[e.prop])?v.style(e.elem,e.prop,e.now+e.unit):e.elem[e.prop]=e.now}}},Yn.propHooks.scrollTop=Yn.propHooks.scrollLeft={set:function(e){e.elem.nodeType&amp;&amp;e.elem.parentNode&amp;&amp;(e.elem[e.prop]=e.now)}},v.each(["toggle","show","hide"],function(e,t){var n=v.fn[t];v.fn[t]=function(r,i,s){return r==null||typeof r=="boolean"||!e&amp;&amp;v.isFunction(r)&amp;&amp;v.isFunction(i)?n.apply(this,arguments):this.animate(Zn(t,!0),r,i,s)}}),v.fn.extend({fadeTo:function(e,t,n,r){return this.filter(Gt).css("opacity",0).show().end().animate({opacity:t},e,n,r)},animate:function(e,t,n,r){var i=v.isEmptyObject(e),s=v.speed(t,n,r),o=function(){var t=Kn(this,v.extend({},e),s);i&amp;&amp;t.stop(!0)};return i||s.queue===!1?this.each(o):this.queue(s.queue,o)},stop:function(e,n,r){var i=function(e){var t=e.stop;delete e.stop,t(r)};return typeof e!="string"&amp;&amp;(r=n,n=e,e=t),n&amp;&amp;e!==!1&amp;&amp;this.queue(e||"fx",[]),this.each(function(){var t=!0,n=e!=null&amp;&amp;e+"queueHooks",s=v.timers,o=v._data(this);if(n)o[n]&amp;&amp;o[n].stop&amp;&amp;i(o[n]);else for(n in o)o[n]&amp;&amp;o[n].stop&amp;&amp;Wn.test(n)&amp;&amp;i(o[n]);for(n=s.length;n--;)s[n].elem===this&amp;&amp;(e==null||s[n].queue===e)&amp;&amp;(s[n].anim.stop(r),t=!1,s.splice(n,1));(t||!r)&amp;&amp;v.dequeue(this,e)})}}),v.each({slideDown:Zn("show"),slideUp:Zn("hide"),slideToggle:Zn("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,t){v.fn[e]=function(e,n,r){return this.animate(t,e,n,r)}}),v.speed=function(e,t,n){var r=e&amp;&amp;typeof e=="object"?v.extend({},e):{complete:n||!n&amp;&amp;t||v.isFunction(e)&amp;&amp;e,duration:e,easing:n&amp;&amp;t||t&amp;&amp;!v.isFunction(t)&amp;&amp;t};r.duration=v.fx.off?0:typeof r.duration=="number"?r.duration:r.duration in v.fx.speeds?v.fx.speeds[r.duration]:v.fx.speeds._default;if(r.queue==null||r.queue===!0)r.queue="fx";return r.old=r.complete,r.complete=function(){v.isFunction(r.old)&amp;&amp;r.old.call(this),r.queue&amp;&amp;v.dequeue(this,r.queue)},r},v.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2}},v.timers=[],v.fx=Yn.prototype.init,v.fx.tick=function(){var e,n=v.timers,r=0;qn=v.now();for(;r&lt;n.length;r++)e=n[r],!e()&amp;&amp;n[r]===e&amp;&amp;n.splice(r--,1);n.length||v.fx.stop(),qn=t},v.fx.timer=function(e){e()&amp;&amp;v.timers.push(e)&amp;&amp;!Rn&amp;&amp;(Rn=setInterval(v.fx.tick,v.fx.interval))},v.fx.interval=13,v.fx.stop=function(){clearInterval(Rn),Rn=null},v.fx.speeds={slow:600,fast:200,_default:400},v.fx.step={},v.expr&amp;&amp;v.expr.filters&amp;&amp;(v.expr.filters.animated=function(e){return v.grep(v.timers,function(t){return e===t.elem}).length});var er=/^(?:body|html)$/i;v.fn.offset=function(e){if(arguments.length)return e===t?this:this.each(function(t){v.offset.setOffset(this,e,t)});var n,r,i,s,o,u,a,f={top:0,left:0},l=this[0],c=l&amp;&amp;l.ownerDocument;if(!c)return;return(r=c.body)===l?v.offset.bodyOffset(l):(n=c.documentElement,v.contains(n,l)?(typeof l.getBoundingClientRect!="undefined"&amp;&amp;(f=l.getBoundingClientRect()),i=tr(c),s=n.clientTop||r.clientTop||0,o=n.clientLeft||r.clientLeft||0,u=i.pageYOffset||n.scrollTop,a=i.pageXOffset||n.scrollLeft,{top:f.top+u-s,left:f.left+a-o}):f)},v.offset={bodyOffset:function(e){var t=e.offsetTop,n=e.offsetLeft;return v.support.doesNotIncludeMarginInBodyOffset&amp;&amp;(t+=parseFloat(v.css(e,"marginTop"))||0,n+=parseFloat(v.css(e,"marginLeft"))||0),{top:t,left:n}},setOffset:function(e,t,n){var r=v.css(e,"position");r==="static"&amp;&amp;(e.style.position="relative");var i=v(e),s=i.offset(),o=v.css(e,"top"),u=v.css(e,"left"),a=(r==="absolute"||r==="fixed")&amp;&amp;v.inArray("auto",[o,u])&gt;-1,f={},l={},c,h;a?(l=i.position(),c=l.top,h=l.left):(c=parseFloat(o)||0,h=parseFloat(u)||0),v.isFunction(t)&amp;&amp;(t=t.call(e,n,s)),t.top!=null&amp;&amp;(f.top=t.top-s.top+c),t.left!=null&amp;&amp;(f.left=t.left-s.left+h),"using"in t?t.using.call(e,f):i.css(f)}},v.fn.extend({position:function(){if(!this[0])return;var e=this[0],t=this.offsetParent(),n=this.offset(),r=er.test(t[0].nodeName)?{top:0,left:0}:t.offset();return n.top-=parseFloat(v.css(e,"marginTop"))||0,n.left-=parseFloat(v.css(e,"marginLeft"))||0,r.top+=parseFloat(v.css(t[0],"borderTopWidth"))||0,r.left+=parseFloat(v.css(t[0],"borderLeftWidth"))||0,{top:n.top-r.top,left:n.left-r.left}},offsetParent:function(){return this.map(function(){var e=this.offsetParent||i.body;while(e&amp;&amp;!er.test(e.nodeName)&amp;&amp;v.css(e,"position")==="static")e=e.offsetParent;return e||i.body})}}),v.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(e,n){var r=/Y/.test(n);v.fn[e]=function(i){return v.access(this,function(e,i,s){var o=tr(e);if(s===t)return o?n in o?o[n]:o.document.documentElement[i]:e[i];o?o.scrollTo(r?v(o).scrollLeft():s,r?s:v(o).scrollTop()):e[i]=s},e,i,arguments.length,null)}}),v.each({Height:"height",Width:"width"},function(e,n){v.each({padding:"inner"+e,content:n,"":"outer"+e},function(r,i){v.fn[i]=function(i,s){var o=arguments.length&amp;&amp;(r||typeof i!="boolean"),u=r||(i===!0||s===!0?"margin":"border");return v.access(this,function(n,r,i){var s;return v.isWindow(n)?n.document.documentElement["client"+e]:n.nodeType===9?(s=n.documentElement,Math.max(n.body["scroll"+e],s["scroll"+e],n.body["offset"+e],s["offset"+e],s["client"+e])):i===t?v.css(n,r,i,u):v.style(n,r,i,u)},n,o?i:t,o,null)}})}),e.jQuery=e.$=v,typeof define=="function"&amp;&amp;define.amd&amp;&amp;define.amd.jQuery&amp;&amp;define("jquery",[],function(){return v})})(window);
/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/. */

define('jqueryPlugins',["jquery"], function ($) {</pre></div></div>
              
            </li>
          
            <li id="section-37">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-37">&#182;</a>
                </div>
                <p>This isn&#39;t really a &quot;module&quot; since it just patches jQuery itself</p>
<p>FIX ME Animations TO DO
walkthrough animations go here
animate participant cursor and box popping in when they enter the session
animate participant cursor and box popping out when they leave the session
animate the participant cursor -&gt; rotate down when they&#39;re down the page</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  $.fn.rotateCursorDown = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    $(<span class="string">'svg'</span>).animate({borderSpacing: -<span class="number">150</span>, opacity: <span class="number">1</span>}, {
      step: <span class="keyword">function</span>(now, fx) {
        <span class="keyword">if</span> (fx.prop == <span class="string">"borderSpacing"</span>) {
          $(<span class="keyword">this</span>).css(<span class="string">'-webkit-transform'</span>, <span class="string">'rotate('</span>+now+<span class="string">'deg)'</span>)
            .css(<span class="string">'-moz-transform'</span>, <span class="string">'rotate('</span>+now+<span class="string">'deg)'</span>)
            .css(<span class="string">'-ms-transform'</span>, <span class="string">'rotate('</span>+now+<span class="string">'deg)'</span>)
            .css(<span class="string">'-o-transform'</span>, <span class="string">'rotate('</span>+now+<span class="string">'deg)'</span>)
            .css(<span class="string">'transform'</span>, <span class="string">'rotate('</span>+now+<span class="string">'deg)'</span>);
        } <span class="keyword">else</span> {
          $(<span class="keyword">this</span>).css(fx.prop, now);
        }
      },
      duration: <span class="number">500</span>
    }, <span class="string">'linear'</span>).promise().then(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">this</span>.css(<span class="string">'-webkit-transform'</span>, <span class="string">''</span>);
      <span class="keyword">this</span>.css(<span class="string">'-moz-transform'</span>, <span class="string">''</span>);
      <span class="keyword">this</span>.css(<span class="string">'-ms-transform'</span>, <span class="string">''</span>);
      <span class="keyword">this</span>.css(<span class="string">'-o-transform'</span>, <span class="string">''</span>);
      <span class="keyword">this</span>.css(<span class="string">'transform'</span>, <span class="string">''</span>);
      <span class="keyword">this</span>.css(<span class="string">"opacity"</span>, <span class="string">""</span>);
    });
  };</pre></div></div>
              
            </li>
          
            <li id="section-38">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-38">&#182;</a>
                </div>
                <p>animate the participant cursor -&gt; rotate up when they&#39;re on the same frame as the user</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  $.fn.rotateCursorDown = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    $(<span class="string">'.towtruck-cursor svg'</span>).animate({borderSpacing: <span class="number">0</span>, opacity: <span class="number">1</span>}, {
      step: <span class="keyword">function</span>(now, fx) {
        <span class="keyword">if</span> (fx.prop == <span class="string">"borderSpacing"</span>) {
          $(<span class="keyword">this</span>).css(<span class="string">'-webkit-transform'</span>, <span class="string">'rotate('</span>+now+<span class="string">'deg)'</span>)
            .css(<span class="string">'-moz-transform'</span>, <span class="string">'rotate('</span>+now+<span class="string">'deg)'</span>)
            .css(<span class="string">'-ms-transform'</span>, <span class="string">'rotate('</span>+now+<span class="string">'deg)'</span>)
            .css(<span class="string">'-o-transform'</span>, <span class="string">'rotate('</span>+now+<span class="string">'deg)'</span>)
            .css(<span class="string">'transform'</span>, <span class="string">'rotate('</span>+now+<span class="string">'deg)'</span>);
        } <span class="keyword">else</span> {
          $(<span class="keyword">this</span>).css(fx.prop, now);
        }
      },
      duration: <span class="number">500</span>
    }, <span class="string">'linear'</span>).promise().then(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">this</span>.css(<span class="string">'-webkit-transform'</span>, <span class="string">''</span>);
      <span class="keyword">this</span>.css(<span class="string">'-moz-transform'</span>, <span class="string">''</span>);
      <span class="keyword">this</span>.css(<span class="string">'-ms-transform'</span>, <span class="string">''</span>);
      <span class="keyword">this</span>.css(<span class="string">'-o-transform'</span>, <span class="string">''</span>);
      <span class="keyword">this</span>.css(<span class="string">'transform'</span>, <span class="string">''</span>);
      <span class="keyword">this</span>.css(<span class="string">"opacity"</span>, <span class="string">""</span>);
    });
  };</pre></div></div>
              
            </li>
          
            <li id="section-39">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-39">&#182;</a>
                </div>
                <p>Move notification when another notification slides in //</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="comment">/* Pop in window from dock button: */</span>
  $.fn.popinWindow = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-40">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-40">&#182;</a>
                </div>
                <p>mobile popout window with no animation</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span>($.browser.mobile) {</pre></div></div>
              
            </li>
          
            <li id="section-41">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-41">&#182;</a>
                </div>
                <p>starting position</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.css({
          left: <span class="string">"0px"</span>,
          opacity: <span class="number">1</span>,
          <span class="string">"zIndex"</span>: <span class="number">8888</span>
        });</pre></div></div>
              
            </li>
          
            <li id="section-42">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-42">&#182;</a>
                </div>
                <p>starting position for arrow</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        $(<span class="string">'#towtruck-window-pointer-right'</span>).css({
          left: <span class="string">"+=74px"</span>,
          opacity: <span class="number">1</span>,
          <span class="string">"zIndex"</span>: <span class="number">8888</span>
        });</pre></div></div>
              
            </li>
          
            <li id="section-43">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-43">&#182;</a>
                </div>
                <p>animate arrow out</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        $(<span class="string">'#towtruck-window-pointer-right'</span>).animate({
          opacity: <span class="number">1</span>,
          left: <span class="string">"-=78px"</span>
        }, {
          duration:<span class="number">60</span>, easing:<span class="string">"linear"</span>
        });
        $(<span class="string">'#towtruck-window-pointer-right'</span>).queue();</pre></div></div>
              
            </li>
          
            <li id="section-44">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-44">&#182;</a>
                </div>
                <p>bounce arrow back</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        $(<span class="string">'#towtruck-window-pointer-right'</span>).animate({
          left:<span class="string">'+=4px'</span>
        }, {
          duration:<span class="number">60</span>, easing:<span class="string">"linear"</span>
        });</pre></div></div>
              
            </li>
          
            <li id="section-45">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-45">&#182;</a>
                </div>
                <p>animate window out</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.animate({
          opacity: <span class="number">1</span>,
          left: <span class="string">"0px"</span>
        }, {
          duration:<span class="number">60</span>, easing:<span class="string">"linear"</span>
        });
        <span class="keyword">this</span>.queue();</pre></div></div>
              
            </li>
          
            <li id="section-46">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-46">&#182;</a>
                </div>
                <p>bounce window back</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.animate({
          left:<span class="string">'0px'</span>
        }, {
          duration:<span class="number">60</span>, easing:<span class="string">"linear"</span>
        });
    }

    <span class="keyword">else</span> {</pre></div></div>
              
            </li>
          
            <li id="section-47">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-47">&#182;</a>
                </div>
                <p>starting position</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">this</span>.css({
        left: <span class="string">"+=74px"</span>,
        opacity: <span class="number">1</span>,
        <span class="string">"zIndex"</span>: <span class="number">8888</span>
      });</pre></div></div>
              
            </li>
          
            <li id="section-48">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-48">&#182;</a>
                </div>
                <p>starting position for arrow</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      $(<span class="string">'#towtruck-window-pointer-right'</span>).css({
        left: <span class="string">"+=74px"</span>,
        opacity: <span class="number">1</span>,
        <span class="string">"zIndex"</span>: <span class="number">8888</span>
      });</pre></div></div>
              
            </li>
          
            <li id="section-49">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-49">&#182;</a>
                </div>
                <p>animate arrow out</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      $(<span class="string">'#towtruck-window-pointer-right'</span>).animate({
        opacity: <span class="number">1</span>,
        left: <span class="string">"-=78px"</span>
      }, {
        duration:<span class="number">60</span>, easing:<span class="string">"linear"</span>
      });
      $(<span class="string">'#towtruck-window-pointer-right'</span>).queue();</pre></div></div>
              
            </li>
          
            <li id="section-50">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-50">&#182;</a>
                </div>
                <p>bounce arrow back</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      $(<span class="string">'#towtruck-window-pointer-right'</span>).animate({
        left:<span class="string">'+=4px'</span>
      }, {
        duration:<span class="number">60</span>, easing:<span class="string">"linear"</span>
      });</pre></div></div>
              
            </li>
          
            <li id="section-51">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-51">&#182;</a>
                </div>
                <p>animate window out</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">this</span>.animate({
        opacity: <span class="number">1</span>,
        left: <span class="string">"-=78px"</span>
      }, {
        duration:<span class="number">60</span>, easing:<span class="string">"linear"</span>
      });
      <span class="keyword">this</span>.queue();</pre></div></div>
              
            </li>
          
            <li id="section-52">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-52">&#182;</a>
                </div>
                <p>bounce window back</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">this</span>.animate({
        left:<span class="string">'+=4px'</span>
      }, {
        duration:<span class="number">60</span>, easing:<span class="string">"linear"</span>
      });
      
    }

  };

  <span class="comment">/* Slide in notification window: */</span>
  $.fn.slideIn = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">this</span>.css({</pre></div></div>
              
            </li>
          
            <li id="section-53">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-53">&#182;</a>
                </div>
                <p>top: &quot;240px&quot;,</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      left: <span class="string">"+=74px"</span>,
      opacity: <span class="number">0</span>,
      <span class="string">"zIndex"</span>: <span class="number">8888</span>
    });
    <span class="keyword">return</span> <span class="keyword">this</span>.animate({
      <span class="string">"left"</span>: <span class="string">"-=74px"</span>,
      opacity: <span class="number">1</span>,
      <span class="string">"zIndex"</span>: <span class="number">9999</span>
    }, <span class="string">"fast"</span>);
  };

  <span class="comment">/* Used to fade away notification windows + flip the bottom of them out: */</span>
  $.fn.fadeOut = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">this</span>.animate({borderSpacing: -<span class="number">90</span>, opacity: <span class="number">0.5</span>}, {
      step: <span class="keyword">function</span>(now, fx) {
        <span class="keyword">if</span> (fx.prop == <span class="string">"borderSpacing"</span>) {
          $(<span class="keyword">this</span>).css(<span class="string">'-webkit-transform'</span>, <span class="string">'perspective( 600px ) rotateX('</span>+now+<span class="string">'deg)'</span>)
            .css(<span class="string">'-moz-transform'</span>, <span class="string">'perspective( 600px ) rotateX('</span>+now+<span class="string">'deg)'</span>)
            .css(<span class="string">'-ms-transform'</span>, <span class="string">'perspective( 600px ) rotateX('</span>+now+<span class="string">'deg)'</span>)
            .css(<span class="string">'-o-transform'</span>, <span class="string">'perspective( 600px ) rotateX('</span>+now+<span class="string">'deg)'</span>)
            .css(<span class="string">'transform'</span>, <span class="string">'perspective( 600px ) rotateX('</span>+now+<span class="string">'deg)'</span>);
        } <span class="keyword">else</span> {
          $(<span class="keyword">this</span>).css(fx.prop, now);
        }
      },
      duration: <span class="number">500</span>
    }, <span class="string">'linear'</span>).promise().then(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">this</span>.css(<span class="string">'-webkit-transform'</span>, <span class="string">''</span>);
      <span class="keyword">this</span>.css(<span class="string">'-moz-transform'</span>, <span class="string">''</span>);
      <span class="keyword">this</span>.css(<span class="string">'-ms-transform'</span>, <span class="string">''</span>);
      <span class="keyword">this</span>.css(<span class="string">'-o-transform'</span>, <span class="string">''</span>);
      <span class="keyword">this</span>.css(<span class="string">'transform'</span>, <span class="string">''</span>);
      <span class="keyword">this</span>.css(<span class="string">"opacity"</span>, <span class="string">""</span>);
    });
    <span class="keyword">return</span> <span class="keyword">this</span>;
  };

  <span class="comment">/* used when user goes down to participant cursor location on screen */</span>
  $.fn.easeTo = <span class="function"><span class="keyword">function</span> <span class="params">(y)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.animate({
      scrollTop: y
    }, {
      duration: <span class="number">400</span>,
      easing: <span class="string">"swing"</span>
    });
  };</pre></div></div>
              
            </li>
          
            <li id="section-54">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-54">&#182;</a>
                </div>
                <p>avatar animate in</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  $.fn.animateDockEntry = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">var</span> height = <span class="keyword">this</span>.height();
    <span class="keyword">var</span> width = <span class="keyword">this</span>.width();
    <span class="keyword">var</span> backgroundSize = height + <span class="number">4</span>;
    <span class="keyword">var</span> margin = parseInt(<span class="keyword">this</span>.css(<span class="string">"marginLeft"</span>), <span class="number">10</span>);</pre></div></div>
              
            </li>
          
            <li id="section-55">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-55">&#182;</a>
                </div>
                <p>set starting position CSS for avatar</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">this</span>.css({
      marginLeft: margin + width/<span class="number">2</span>,
      height: <span class="number">0</span>,
      width: <span class="number">0</span>,
      backgroundSize: <span class="string">"0 0"</span>
    });

    <span class="keyword">var</span> self = <span class="keyword">this</span>;</pre></div></div>
              
            </li>
          
            <li id="section-56">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-56">&#182;</a>
                </div>
                <p>then animate avatar to the actual dimensions, and reset the values</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">this</span>.animate({
      marginLeft: margin,
      height: height,
      width: width,
      backgroundSize: backgroundSize
    }, {
      duration: <span class="number">600</span>
    }).promise().then(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      self.css({
        marginLeft: <span class="string">""</span>,
        height: <span class="string">""</span>,
        width: <span class="string">""</span>,
        backgroundSize: <span class="string">""</span>
      });
    });
    <span class="keyword">return</span> <span class="keyword">this</span>;
  };</pre></div></div>
              
            </li>
          
            <li id="section-57">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-57">&#182;</a>
                </div>
                <p>avatar animate out, reverse of above</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  $.fn.animateDockExit = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-58">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-58">&#182;</a>
                </div>
                <p>get the current avatar dimenensions</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> height = <span class="keyword">this</span>.height();
    <span class="keyword">var</span> width = <span class="keyword">this</span>.width();
    <span class="keyword">var</span> backgroundSize = height + <span class="number">4</span>;
    <span class="keyword">var</span> margin = parseInt(<span class="keyword">this</span>.css(<span class="string">"marginLeft"</span>), <span class="number">10</span>);</pre></div></div>
              
            </li>
          
            <li id="section-59">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-59">&#182;</a>
                </div>
                <p>then animate avatar to shrink to nothing, and reset the values again
FIXME this needs to animate from the CENTER</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">this</span>.animate({
      marginLeft: margin + width/<span class="number">2</span>,
      height: <span class="number">0</span>,
      width: <span class="number">0</span>,
      backgroundSize: <span class="string">"0 0"</span>,
      opacity: <span class="number">0</span>
    }, <span class="number">600</span> );

    <span class="keyword">return</span> <span class="keyword">this</span>;

  };

  $.fn.animateCursorEntry = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-60">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-60">&#182;</a>
                </div>
                <p>Make the cursor bubble pop in</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  };</pre></div></div>
              
            </li>
          
            <li id="section-61">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-61">&#182;</a>
                </div>
                <p>keyboard typing animation</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  $.fn.animateKeyboard = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">var</span> one = <span class="keyword">this</span>.find(<span class="string">".towtruck-typing-ellipse-one"</span>);
    <span class="keyword">var</span> two = <span class="keyword">this</span>.find(<span class="string">".towtruck-typing-ellipse-two"</span>);
    <span class="keyword">var</span> three = <span class="keyword">this</span>.find(<span class="string">".towtruck-typing-ellipse-three"</span>);
    <span class="keyword">var</span> count = -<span class="number">1</span>;
    <span class="keyword">var</span> run = (<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      count = (count+<span class="number">1</span>) % <span class="number">4</span>;
      <span class="keyword">if</span> (count === <span class="number">0</span>) {
        one.css(<span class="string">"opacity"</span>, <span class="number">0.5</span>);
        two.css(<span class="string">"opacity"</span>, <span class="number">0.5</span>);
        three.css(<span class="string">"opacity"</span>, <span class="number">0.5</span>);
      } <span class="keyword">else</span> <span class="keyword">if</span> (count == <span class="number">1</span>) {
        one.css(<span class="string">"opacity"</span>, <span class="number">1</span>);
      } <span class="keyword">else</span> <span class="keyword">if</span> (count == <span class="number">2</span>) {
        two.css(<span class="string">"opacity"</span>, <span class="number">1</span>);
      } <span class="keyword">else</span> { <span class="comment">// count==3</span>
        three.css(<span class="string">"opacity"</span>, <span class="number">1</span>);
      }
    }).bind(<span class="keyword">this</span>);
    run();
    <span class="keyword">var</span> interval = setInterval(run, <span class="number">300</span>);
    <span class="keyword">this</span>.data(<span class="string">"animateKeyboard"</span>, interval);
  };

  $.fn.stopKeyboardAnimation = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    clearTimeout(<span class="keyword">this</span>.data(<span class="string">"animateKeyboard"</span>));
    <span class="keyword">this</span>.data(<span class="string">"animateKeyboard"</span>, <span class="literal">null</span>);
  };</pre></div></div>
              
            </li>
          
            <li id="section-62">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-62">&#182;</a>
                </div>
                <p>FIXME: not sure if this is legit, but at least the modern mobile devices we
care about should have this defined:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  $.browser.mobile = window.orientation !== <span class="literal">undefined</span>;
  <span class="keyword">if</span> (navigator.userAgent.search(<span class="regexp">/mobile/i</span>) != -<span class="number">1</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-63">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-63">&#182;</a>
                </div>
                <p>FIXME: At least on the Firefox OS simulator I need this</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    $.browser.mobile = <span class="literal">true</span>;
  }

  <span class="keyword">if</span> ($.browser.mobile &amp;&amp; window.matchMedia &amp;&amp; ! window.matchMedia(<span class="string">"screen and (max-screen-width: 480px)"</span>).matches) {</pre></div></div>
              
            </li>
          
            <li id="section-64">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-64">&#182;</a>
                </div>
                <p>FIXME: for Firefox OS simulator really:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    document.body.className += <span class="string">" towtruck-mobile-browser"</span>;
  }

});

<span class="comment">/*! jQuery UI - v1.8.21 - 2012-06-05
* https://github.com/jquery/jquery-ui
* Includes: jquery.ui.core.js, jquery.ui.widget.js, jquery.ui.mouse.js, jquery.ui.draggable.js, jquery.ui.droppable.js, jquery.ui.resizable.js, jquery.ui.selectable.js, jquery.ui.sortable.js, jquery.effects.core.js, jquery.effects.blind.js, jquery.effects.bounce.js, jquery.effects.clip.js, jquery.effects.drop.js, jquery.effects.explode.js, jquery.effects.fade.js, jquery.effects.fold.js, jquery.effects.highlight.js, jquery.effects.pulsate.js, jquery.effects.scale.js, jquery.effects.shake.js, jquery.effects.slide.js, jquery.effects.transfer.js, jquery.ui.accordion.js, jquery.ui.autocomplete.js, jquery.ui.button.js, jquery.ui.datepicker.js, jquery.ui.dialog.js, jquery.ui.position.js, jquery.ui.progressbar.js, jquery.ui.slider.js, jquery.ui.tabs.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */</span>
(<span class="keyword">function</span>(a,b){<span class="function"><span class="keyword">function</span> <span class="title">c</span><span class="params">(b,c)</span>{</span><span class="keyword">var</span> e=b.nodeName.toLowerCase();<span class="keyword">if</span>(<span class="string">"area"</span>===e){<span class="keyword">var</span> f=b.parentNode,g=f.name,h;<span class="keyword">return</span>!b.href||!g||f.nodeName.toLowerCase()!==<span class="string">"map"</span>?!<span class="number">1</span>:(h=a(<span class="string">"img[usemap=#"</span>+g+<span class="string">"]"</span>)[<span class="number">0</span>],!!h&amp;&amp;d(h))}<span class="keyword">return</span>(<span class="regexp">/input|select|textarea|button|object/</span>.test(e)?!b.disabled:<span class="string">"a"</span>==e?b.href||c:c)&amp;&amp;d(b)}<span class="function"><span class="keyword">function</span> <span class="title">d</span><span class="params">(b)</span>{</span><span class="keyword">return</span>!a(b).parents().andSelf().filter(<span class="keyword">function</span>(){<span class="keyword">return</span> a.curCSS(<span class="keyword">this</span>,<span class="string">"visibility"</span>)===<span class="string">"hidden"</span>||a.expr.filters.hidden(<span class="keyword">this</span>)}).length}a.ui=a.ui||{};<span class="keyword">if</span>(a.ui.version)<span class="keyword">return</span>;a.extend(a.ui,{version:<span class="string">"1.8.21"</span>,keyCode:{ALT:<span class="number">18</span>,BACKSPACE:<span class="number">8</span>,CAPS_LOCK:<span class="number">20</span>,COMMA:<span class="number">188</span>,COMMAND:<span class="number">91</span>,COMMAND_LEFT:<span class="number">91</span>,COMMAND_RIGHT:<span class="number">93</span>,CONTROL:<span class="number">17</span>,DELETE:<span class="number">46</span>,DOWN:<span class="number">40</span>,END:<span class="number">35</span>,ENTER:<span class="number">13</span>,ESCAPE:<span class="number">27</span>,HOME:<span class="number">36</span>,INSERT:<span class="number">45</span>,LEFT:<span class="number">37</span>,MENU:<span class="number">93</span>,NUMPAD_ADD:<span class="number">107</span>,NUMPAD_DECIMAL:<span class="number">110</span>,NUMPAD_DIVIDE:<span class="number">111</span>,NUMPAD_ENTER:<span class="number">108</span>,NUMPAD_MULTIPLY:<span class="number">106</span>,NUMPAD_SUBTRACT:<span class="number">109</span>,PAGE_DOWN:<span class="number">34</span>,PAGE_UP:<span class="number">33</span>,PERIOD:<span class="number">190</span>,RIGHT:<span class="number">39</span>,SHIFT:<span class="number">16</span>,SPACE:<span class="number">32</span>,TAB:<span class="number">9</span>,UP:<span class="number">38</span>,WINDOWS:<span class="number">91</span>}}),a.fn.extend({propAttr:a.fn.prop||a.fn.attr,_focus:a.fn.focus,focus:<span class="keyword">function</span>(b,c){<span class="keyword">return</span> <span class="keyword">typeof</span> b==<span class="string">"number"</span>?<span class="keyword">this</span>.each(<span class="keyword">function</span>(){<span class="keyword">var</span> d=<span class="keyword">this</span>;setTimeout(<span class="keyword">function</span>(){a(d).focus(),c&amp;&amp;c.call(d)},b)}):<span class="keyword">this</span>._focus.apply(<span class="keyword">this</span>,arguments)},scrollParent:<span class="keyword">function</span>(){<span class="keyword">var</span> b;<span class="keyword">return</span> a.browser.msie&amp;&amp;<span class="regexp">/(static|relative)/</span>.test(<span class="keyword">this</span>.css(<span class="string">"position"</span>))||<span class="regexp">/absolute/</span>.test(<span class="keyword">this</span>.css(<span class="string">"position"</span>))?b=<span class="keyword">this</span>.parents().filter(<span class="keyword">function</span>(){<span class="keyword">return</span><span class="regexp">/(relative|absolute|fixed)/</span>.test(a.curCSS(<span class="keyword">this</span>,<span class="string">"position"</span>,<span class="number">1</span>))&amp;&amp;<span class="regexp">/(auto|scroll)/</span>.test(a.curCSS(<span class="keyword">this</span>,<span class="string">"overflow"</span>,<span class="number">1</span>)+a.curCSS(<span class="keyword">this</span>,<span class="string">"overflow-y"</span>,<span class="number">1</span>)+a.curCSS(<span class="keyword">this</span>,<span class="string">"overflow-x"</span>,<span class="number">1</span>))}).eq(<span class="number">0</span>):b=<span class="keyword">this</span>.parents().filter(<span class="keyword">function</span>(){<span class="keyword">return</span><span class="regexp">/(auto|scroll)/</span>.test(a.curCSS(<span class="keyword">this</span>,<span class="string">"overflow"</span>,<span class="number">1</span>)+a.curCSS(<span class="keyword">this</span>,<span class="string">"overflow-y"</span>,<span class="number">1</span>)+a.curCSS(<span class="keyword">this</span>,<span class="string">"overflow-x"</span>,<span class="number">1</span>))}).eq(<span class="number">0</span>),<span class="regexp">/fixed/</span>.test(<span class="keyword">this</span>.css(<span class="string">"position"</span>))||!b.length?a(document):b},zIndex:<span class="keyword">function</span>(c){<span class="keyword">if</span>(c!==b)<span class="keyword">return</span> <span class="keyword">this</span>.css(<span class="string">"zIndex"</span>,c);<span class="keyword">if</span>(<span class="keyword">this</span>.length){<span class="keyword">var</span> d=a(<span class="keyword">this</span>[<span class="number">0</span>]),e,f;<span class="keyword">while</span>(d.length&amp;&amp;d[<span class="number">0</span>]!==document){e=d.css(<span class="string">"position"</span>);<span class="keyword">if</span>(e===<span class="string">"absolute"</span>||e===<span class="string">"relative"</span>||e===<span class="string">"fixed"</span>){f=parseInt(d.css(<span class="string">"zIndex"</span>),<span class="number">10</span>);<span class="keyword">if</span>(!isNaN(f)&amp;&amp;f!==<span class="number">0</span>)<span class="keyword">return</span> f}d=d.parent()}}<span class="keyword">return</span> <span class="number">0</span>},disableSelection:<span class="keyword">function</span>(){<span class="keyword">return</span> <span class="keyword">this</span>.bind((a.support.selectstart?<span class="string">"selectstart"</span>:<span class="string">"mousedown"</span>)+<span class="string">".ui-disableSelection"</span>,<span class="keyword">function</span>(a){a.preventDefault()})},enableSelection:<span class="keyword">function</span>(){<span class="keyword">return</span> <span class="keyword">this</span>.unbind(<span class="string">".ui-disableSelection"</span>)}}),a.each([<span class="string">"Width"</span>,<span class="string">"Height"</span>],<span class="keyword">function</span>(c,d){<span class="function"><span class="keyword">function</span> <span class="title">h</span><span class="params">(b,c,d,f)</span>{</span><span class="keyword">return</span> a.each(e,<span class="keyword">function</span>(){c-=parseFloat(a.curCSS(b,<span class="string">"padding"</span>+<span class="keyword">this</span>,!<span class="number">0</span>))||<span class="number">0</span>,d&amp;&amp;(c-=parseFloat(a.curCSS(b,<span class="string">"border"</span>+<span class="keyword">this</span>+<span class="string">"Width"</span>,!<span class="number">0</span>))||<span class="number">0</span>),f&amp;&amp;(c-=parseFloat(a.curCSS(b,<span class="string">"margin"</span>+<span class="keyword">this</span>,!<span class="number">0</span>))||<span class="number">0</span>)}),c}<span class="keyword">var</span> e=d===<span class="string">"Width"</span>?[<span class="string">"Left"</span>,<span class="string">"Right"</span>]:[<span class="string">"Top"</span>,<span class="string">"Bottom"</span>],f=d.toLowerCase(),g={innerWidth:a.fn.innerWidth,innerHeight:a.fn.innerHeight,outerWidth:a.fn.outerWidth,outerHeight:a.fn.outerHeight};a.fn[<span class="string">"inner"</span>+d]=<span class="keyword">function</span>(c){<span class="keyword">return</span> c===b?g[<span class="string">"inner"</span>+d].call(<span class="keyword">this</span>):<span class="keyword">this</span>.each(<span class="keyword">function</span>(){a(<span class="keyword">this</span>).css(f,h(<span class="keyword">this</span>,c)+<span class="string">"px"</span>)})},a.fn[<span class="string">"outer"</span>+d]=<span class="keyword">function</span>(b,c){<span class="keyword">return</span> <span class="keyword">typeof</span> b!=<span class="string">"number"</span>?g[<span class="string">"outer"</span>+d].call(<span class="keyword">this</span>,b):<span class="keyword">this</span>.each(<span class="keyword">function</span>(){a(<span class="keyword">this</span>).css(f,h(<span class="keyword">this</span>,b,!<span class="number">0</span>,c)+<span class="string">"px"</span>)})}}),a.extend(a.expr[<span class="string">":"</span>],{data:<span class="keyword">function</span>(b,c,d){<span class="keyword">return</span>!!a.data(b,d[<span class="number">3</span>])},focusable:<span class="keyword">function</span>(b){<span class="keyword">return</span> c(b,!isNaN(a.attr(b,<span class="string">"tabindex"</span>)))},tabbable:<span class="keyword">function</span>(b){<span class="keyword">var</span> d=a.attr(b,<span class="string">"tabindex"</span>),e=isNaN(d);<span class="keyword">return</span>(e||d&gt;=<span class="number">0</span>)&amp;&amp;c(b,!e)}}),a(<span class="keyword">function</span>(){<span class="keyword">var</span> b=document.body,c=b.appendChild(c=document.createElement(<span class="string">"div"</span>));c.offsetHeight,a.extend(c.style,{minHeight:<span class="string">"100px"</span>,height:<span class="string">"auto"</span>,padding:<span class="number">0</span>,borderWidth:<span class="number">0</span>}),a.support.minHeight=c.offsetHeight===<span class="number">100</span>,a.support.selectstart=<span class="string">"onselectstart"</span><span class="keyword">in</span> c,b.removeChild(c).style.display=<span class="string">"none"</span>}),a.extend(a.ui,{plugin:{add:<span class="keyword">function</span>(b,c,d){<span class="keyword">var</span> e=a.ui[b].prototype;<span class="keyword">for</span>(<span class="keyword">var</span> f <span class="keyword">in</span> d)e.plugins[f]=e.plugins[f]||[],e.plugins[f].push([c,d[f]])},call:<span class="keyword">function</span>(a,b,c){<span class="keyword">var</span> d=a.plugins[b];<span class="keyword">if</span>(!d||!a.element[<span class="number">0</span>].parentNode)<span class="keyword">return</span>;<span class="keyword">for</span>(<span class="keyword">var</span> e=<span class="number">0</span>;e&lt;d.length;e++)a.options[d[e][<span class="number">0</span>]]&amp;&amp;d[e][<span class="number">1</span>].apply(a.element,c)}},contains:<span class="keyword">function</span>(a,b){<span class="keyword">return</span> document.compareDocumentPosition?a.compareDocumentPosition(b)&amp;<span class="number">16</span>:a!==b&amp;&amp;a.contains(b)},hasScroll:<span class="keyword">function</span>(b,c){<span class="keyword">if</span>(a(b).css(<span class="string">"overflow"</span>)===<span class="string">"hidden"</span>)<span class="keyword">return</span>!<span class="number">1</span>;<span class="keyword">var</span> d=c&amp;&amp;c===<span class="string">"left"</span>?<span class="string">"scrollLeft"</span>:<span class="string">"scrollTop"</span>,e=!<span class="number">1</span>;<span class="keyword">return</span> b[d]&gt;<span class="number">0</span>?!<span class="number">0</span>:(b[d]=<span class="number">1</span>,e=b[d]&gt;<span class="number">0</span>,b[d]=<span class="number">0</span>,e)},isOverAxis:<span class="keyword">function</span>(a,b,c){<span class="keyword">return</span> a&gt;b&amp;&amp;a&lt;b+c},isOver:<span class="keyword">function</span>(b,c,d,e,f,g){<span class="keyword">return</span> a.ui.isOverAxis(b,d,f)&amp;&amp;a.ui.isOverAxis(c,e,g)}})})(jQuery),<span class="keyword">function</span>(a,b){<span class="keyword">if</span>(a.cleanData){<span class="keyword">var</span> c=a.cleanData;a.cleanData=<span class="keyword">function</span>(b){<span class="keyword">for</span>(<span class="keyword">var</span> d=<span class="number">0</span>,e;(e=b[d])!=<span class="literal">null</span>;d++)<span class="keyword">try</span>{a(e).triggerHandler(<span class="string">"remove"</span>)}<span class="keyword">catch</span>(f){}c(b)}}<span class="keyword">else</span>{<span class="keyword">var</span> d=a.fn.remove;a.fn.remove=<span class="keyword">function</span>(b,c){<span class="keyword">return</span> <span class="keyword">this</span>.each(<span class="keyword">function</span>(){<span class="keyword">return</span> c||(!b||a.filter(b,[<span class="keyword">this</span>]).length)&amp;&amp;a(<span class="string">"*"</span>,<span class="keyword">this</span>).add([<span class="keyword">this</span>]).each(<span class="keyword">function</span>(){<span class="keyword">try</span>{a(<span class="keyword">this</span>).triggerHandler(<span class="string">"remove"</span>)}<span class="keyword">catch</span>(b){}}),d.call(a(<span class="keyword">this</span>),b,c)})}}a.widget=<span class="keyword">function</span>(b,c,d){<span class="keyword">var</span> e=b.split(<span class="string">"."</span>)[<span class="number">0</span>],f;b=b.split(<span class="string">"."</span>)[<span class="number">1</span>],f=e+<span class="string">"-"</span>+b,d||(d=c,c=a.Widget),a.expr[<span class="string">":"</span>][f]=<span class="keyword">function</span>(c){<span class="keyword">return</span>!!a.data(c,b)},a[e]=a[e]||{},a[e][b]=<span class="keyword">function</span>(a,b){arguments.length&amp;&amp;<span class="keyword">this</span>._createWidget(a,b)};<span class="keyword">var</span> g=<span class="keyword">new</span> c;g.options=a.extend(!<span class="number">0</span>,{},g.options),a[e][b].prototype=a.extend(!<span class="number">0</span>,g,{namespace:e,widgetName:b,widgetEventPrefix:a[e][b].prototype.widgetEventPrefix||b,widgetBaseClass:f},d),a.widget.bridge(b,a[e][b])},a.widget.bridge=<span class="keyword">function</span>(c,d){a.fn[c]=<span class="keyword">function</span>(e){<span class="keyword">var</span> f=<span class="keyword">typeof</span> e==<span class="string">"string"</span>,g=Array.prototype.slice.call(arguments,<span class="number">1</span>),h=<span class="keyword">this</span>;<span class="keyword">return</span> e=!f&amp;&amp;g.length?a.extend.apply(<span class="literal">null</span>,[!<span class="number">0</span>,e].concat(g)):e,f&amp;&amp;e.charAt(<span class="number">0</span>)===<span class="string">"_"</span>?h:(f?<span class="keyword">this</span>.each(<span class="keyword">function</span>(){<span class="keyword">var</span> d=a.data(<span class="keyword">this</span>,c),f=d&amp;&amp;a.isFunction(d[e])?d[e].apply(d,g):d;<span class="keyword">if</span>(f!==d&amp;&amp;f!==b)<span class="keyword">return</span> h=f,!<span class="number">1</span>}):<span class="keyword">this</span>.each(<span class="keyword">function</span>(){<span class="keyword">var</span> b=a.data(<span class="keyword">this</span>,c);b?b.option(e||{})._init():a.data(<span class="keyword">this</span>,c,<span class="keyword">new</span> d(e,<span class="keyword">this</span>))}),h)}},a.Widget=<span class="keyword">function</span>(a,b){arguments.length&amp;&amp;<span class="keyword">this</span>._createWidget(a,b)},a.Widget.prototype={widgetName:<span class="string">"widget"</span>,widgetEventPrefix:<span class="string">""</span>,options:{disabled:!<span class="number">1</span>},_createWidget:<span class="keyword">function</span>(b,c){a.data(c,<span class="keyword">this</span>.widgetName,<span class="keyword">this</span>),<span class="keyword">this</span>.element=a(c),<span class="keyword">this</span>.options=a.extend(!<span class="number">0</span>,{},<span class="keyword">this</span>.options,<span class="keyword">this</span>._getCreateOptions(),b);<span class="keyword">var</span> d=<span class="keyword">this</span>;<span class="keyword">this</span>.element.bind(<span class="string">"remove."</span>+<span class="keyword">this</span>.widgetName,<span class="keyword">function</span>(){d.destroy()}),<span class="keyword">this</span>._create(),<span class="keyword">this</span>._trigger(<span class="string">"create"</span>),<span class="keyword">this</span>._init()},_getCreateOptions:<span class="keyword">function</span>(){<span class="keyword">return</span> a.metadata&amp;&amp;a.metadata.get(<span class="keyword">this</span>.element[<span class="number">0</span>])[<span class="keyword">this</span>.widgetName]},_create:<span class="keyword">function</span>(){},_init:<span class="keyword">function</span>(){},destroy:<span class="keyword">function</span>(){<span class="keyword">this</span>.element.unbind(<span class="string">"."</span>+<span class="keyword">this</span>.widgetName).removeData(<span class="keyword">this</span>.widgetName),<span class="keyword">this</span>.widget().unbind(<span class="string">"."</span>+<span class="keyword">this</span>.widgetName).removeAttr(<span class="string">"aria-disabled"</span>).removeClass(<span class="keyword">this</span>.widgetBaseClass+<span class="string">"-disabled "</span>+<span class="string">"ui-state-disabled"</span>)},widget:<span class="keyword">function</span>(){<span class="keyword">return</span> <span class="keyword">this</span>.element},option:<span class="keyword">function</span>(c,d){<span class="keyword">var</span> e=c;<span class="keyword">if</span>(arguments.length===<span class="number">0</span>)<span class="keyword">return</span> a.extend({},<span class="keyword">this</span>.options);<span class="keyword">if</span>(<span class="keyword">typeof</span> c==<span class="string">"string"</span>){<span class="keyword">if</span>(d===b)<span class="keyword">return</span> <span class="keyword">this</span>.options[c];e={},e[c]=d}<span class="keyword">return</span> <span class="keyword">this</span>._setOptions(e),<span class="keyword">this</span>},_setOptions:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=<span class="keyword">this</span>;<span class="keyword">return</span> a.each(b,<span class="keyword">function</span>(a,b){c._setOption(a,b)}),<span class="keyword">this</span>},_setOption:<span class="keyword">function</span>(a,b){<span class="keyword">return</span> <span class="keyword">this</span>.options[a]=b,a===<span class="string">"disabled"</span>&amp;&amp;<span class="keyword">this</span>.widget()[b?<span class="string">"addClass"</span>:<span class="string">"removeClass"</span>](<span class="keyword">this</span>.widgetBaseClass+<span class="string">"-disabled"</span>+<span class="string">" "</span>+<span class="string">"ui-state-disabled"</span>).attr(<span class="string">"aria-disabled"</span>,b),<span class="keyword">this</span>},enable:<span class="keyword">function</span>(){<span class="keyword">return</span> <span class="keyword">this</span>._setOption(<span class="string">"disabled"</span>,!<span class="number">1</span>)},disable:<span class="keyword">function</span>(){<span class="keyword">return</span> <span class="keyword">this</span>._setOption(<span class="string">"disabled"</span>,!<span class="number">0</span>)},_trigger:<span class="keyword">function</span>(b,c,d){<span class="keyword">var</span> e,f,g=<span class="keyword">this</span>.options[b];d=d||{},c=a.Event(c),c.type=(b===<span class="keyword">this</span>.widgetEventPrefix?b:<span class="keyword">this</span>.widgetEventPrefix+b).toLowerCase(),c.target=<span class="keyword">this</span>.element[<span class="number">0</span>],f=c.originalEvent;<span class="keyword">if</span>(f)<span class="keyword">for</span>(e <span class="keyword">in</span> f)e <span class="keyword">in</span> c||(c[e]=f[e]);<span class="keyword">return</span> <span class="keyword">this</span>.element.trigger(c,d),!(a.isFunction(g)&amp;&amp;g.call(<span class="keyword">this</span>.element[<span class="number">0</span>],c,d)===!<span class="number">1</span>||c.isDefaultPrevented())}}}(jQuery),<span class="keyword">function</span>(a,b){<span class="keyword">var</span> c=!<span class="number">1</span>;a(document).mouseup(<span class="keyword">function</span>(a){c=!<span class="number">1</span>}),a.widget(<span class="string">"ui.mouse"</span>,{options:{cancel:<span class="string">":input,option"</span>,distance:<span class="number">1</span>,delay:<span class="number">0</span>},_mouseInit:<span class="keyword">function</span>(){<span class="keyword">var</span> b=<span class="keyword">this</span>;<span class="keyword">this</span>.element.bind(<span class="string">"mousedown."</span>+<span class="keyword">this</span>.widgetName,<span class="keyword">function</span>(a){<span class="keyword">return</span> b._mouseDown(a)}).bind(<span class="string">"click."</span>+<span class="keyword">this</span>.widgetName,<span class="keyword">function</span>(c){<span class="keyword">if</span>(!<span class="number">0</span>===a.data(c.target,b.widgetName+<span class="string">".preventClickEvent"</span>))<span class="keyword">return</span> a.removeData(c.target,b.widgetName+<span class="string">".preventClickEvent"</span>),c.stopImmediatePropagation(),!<span class="number">1</span>}),<span class="keyword">this</span>.started=!<span class="number">1</span>},_mouseDestroy:<span class="keyword">function</span>(){<span class="keyword">this</span>.element.unbind(<span class="string">"."</span>+<span class="keyword">this</span>.widgetName),a(document).unbind(<span class="string">"mousemove."</span>+<span class="keyword">this</span>.widgetName,<span class="keyword">this</span>._mouseMoveDelegate).unbind(<span class="string">"mouseup."</span>+<span class="keyword">this</span>.widgetName,<span class="keyword">this</span>._mouseUpDelegate)},_mouseDown:<span class="keyword">function</span>(b){<span class="keyword">if</span>(c)<span class="keyword">return</span>;<span class="keyword">this</span>._mouseStarted&amp;&amp;<span class="keyword">this</span>._mouseUp(b),<span class="keyword">this</span>._mouseDownEvent=b;<span class="keyword">var</span> d=<span class="keyword">this</span>,e=b.which==<span class="number">1</span>,f=<span class="keyword">typeof</span> <span class="keyword">this</span>.options.cancel==<span class="string">"string"</span>&amp;&amp;b.target.nodeName?a(b.target).closest(<span class="keyword">this</span>.options.cancel).length:!<span class="number">1</span>;<span class="keyword">if</span>(!e||f||!<span class="keyword">this</span>._mouseCapture(b))<span class="keyword">return</span>!<span class="number">0</span>;<span class="keyword">this</span>.mouseDelayMet=!<span class="keyword">this</span>.options.delay,<span class="keyword">this</span>.mouseDelayMet||(<span class="keyword">this</span>._mouseDelayTimer=setTimeout(<span class="keyword">function</span>(){d.mouseDelayMet=!<span class="number">0</span>},<span class="keyword">this</span>.options.delay));<span class="keyword">if</span>(<span class="keyword">this</span>._mouseDistanceMet(b)&amp;&amp;<span class="keyword">this</span>._mouseDelayMet(b)){<span class="keyword">this</span>._mouseStarted=<span class="keyword">this</span>._mouseStart(b)!==!<span class="number">1</span>;<span class="keyword">if</span>(!<span class="keyword">this</span>._mouseStarted)<span class="keyword">return</span> b.preventDefault(),!<span class="number">0</span>}<span class="keyword">return</span>!<span class="number">0</span>===a.data(b.target,<span class="keyword">this</span>.widgetName+<span class="string">".preventClickEvent"</span>)&amp;&amp;a.removeData(b.target,<span class="keyword">this</span>.widgetName+<span class="string">".preventClickEvent"</span>),<span class="keyword">this</span>._mouseMoveDelegate=<span class="keyword">function</span>(a){<span class="keyword">return</span> d._mouseMove(a)},<span class="keyword">this</span>._mouseUpDelegate=<span class="keyword">function</span>(a){<span class="keyword">return</span> d._mouseUp(a)},a(document).bind(<span class="string">"mousemove."</span>+<span class="keyword">this</span>.widgetName,<span class="keyword">this</span>._mouseMoveDelegate).bind(<span class="string">"mouseup."</span>+<span class="keyword">this</span>.widgetName,<span class="keyword">this</span>._mouseUpDelegate),b.preventDefault(),c=!<span class="number">0</span>,!<span class="number">0</span>},_mouseMove:<span class="keyword">function</span>(b){<span class="keyword">return</span>!a.browser.msie||document.documentMode&gt;=<span class="number">9</span>||!!b.button?<span class="keyword">this</span>._mouseStarted?(<span class="keyword">this</span>._mouseDrag(b),b.preventDefault()):(<span class="keyword">this</span>._mouseDistanceMet(b)&amp;&amp;<span class="keyword">this</span>._mouseDelayMet(b)&amp;&amp;(<span class="keyword">this</span>._mouseStarted=<span class="keyword">this</span>._mouseStart(<span class="keyword">this</span>._mouseDownEvent,b)!==!<span class="number">1</span>,<span class="keyword">this</span>._mouseStarted?<span class="keyword">this</span>._mouseDrag(b):<span class="keyword">this</span>._mouseUp(b)),!<span class="keyword">this</span>._mouseStarted):<span class="keyword">this</span>._mouseUp(b)},_mouseUp:<span class="keyword">function</span>(b){<span class="keyword">return</span> a(document).unbind(<span class="string">"mousemove."</span>+<span class="keyword">this</span>.widgetName,<span class="keyword">this</span>._mouseMoveDelegate).unbind(<span class="string">"mouseup."</span>+<span class="keyword">this</span>.widgetName,<span class="keyword">this</span>._mouseUpDelegate),<span class="keyword">this</span>._mouseStarted&amp;&amp;(<span class="keyword">this</span>._mouseStarted=!<span class="number">1</span>,b.target==<span class="keyword">this</span>._mouseDownEvent.target&amp;&amp;a.data(b.target,<span class="keyword">this</span>.widgetName+<span class="string">".preventClickEvent"</span>,!<span class="number">0</span>),<span class="keyword">this</span>._mouseStop(b)),!<span class="number">1</span>},_mouseDistanceMet:<span class="keyword">function</span>(a){<span class="keyword">return</span> Math.max(Math.abs(<span class="keyword">this</span>._mouseDownEvent.pageX-a.pageX),Math.abs(<span class="keyword">this</span>._mouseDownEvent.pageY-a.pageY))&gt;=<span class="keyword">this</span>.options.distance},_mouseDelayMet:<span class="keyword">function</span>(a){<span class="keyword">return</span> <span class="keyword">this</span>.mouseDelayMet},_mouseStart:<span class="keyword">function</span>(a){},_mouseDrag:<span class="keyword">function</span>(a){},_mouseStop:<span class="keyword">function</span>(a){},_mouseCapture:<span class="keyword">function</span>(a){<span class="keyword">return</span>!<span class="number">0</span>}})}(jQuery),<span class="keyword">function</span>(a,b){a.widget(<span class="string">"ui.draggable"</span>,a.ui.mouse,{widgetEventPrefix:<span class="string">"drag"</span>,options:{addClasses:!<span class="number">0</span>,appendTo:<span class="string">"parent"</span>,axis:!<span class="number">1</span>,connectToSortable:!<span class="number">1</span>,containment:!<span class="number">1</span>,cursor:<span class="string">"auto"</span>,cursorAt:!<span class="number">1</span>,grid:!<span class="number">1</span>,handle:!<span class="number">1</span>,helper:<span class="string">"original"</span>,iframeFix:!<span class="number">1</span>,opacity:!<span class="number">1</span>,refreshPositions:!<span class="number">1</span>,revert:!<span class="number">1</span>,revertDuration:<span class="number">500</span>,scope:<span class="string">"default"</span>,scroll:!<span class="number">0</span>,scrollSensitivity:<span class="number">20</span>,scrollSpeed:<span class="number">20</span>,snap:!<span class="number">1</span>,snapMode:<span class="string">"both"</span>,snapTolerance:<span class="number">20</span>,stack:!<span class="number">1</span>,zIndex:!<span class="number">1</span>},_create:<span class="keyword">function</span>(){<span class="keyword">this</span>.options.helper==<span class="string">"original"</span>&amp;&amp;!<span class="regexp">/^(?:r|a|f)/</span>.test(<span class="keyword">this</span>.element.css(<span class="string">"position"</span>))&amp;&amp;(<span class="keyword">this</span>.element[<span class="number">0</span>].style.position=<span class="string">"relative"</span>),<span class="keyword">this</span>.options.addClasses&amp;&amp;<span class="keyword">this</span>.element.addClass(<span class="string">"ui-draggable"</span>),<span class="keyword">this</span>.options.disabled&amp;&amp;<span class="keyword">this</span>.element.addClass(<span class="string">"ui-draggable-disabled"</span>),<span class="keyword">this</span>._mouseInit()},destroy:<span class="keyword">function</span>(){<span class="keyword">if</span>(!<span class="keyword">this</span>.element.data(<span class="string">"draggable"</span>))<span class="keyword">return</span>;<span class="keyword">return</span> <span class="keyword">this</span>.element.removeData(<span class="string">"draggable"</span>).unbind(<span class="string">".draggable"</span>).removeClass(<span class="string">"ui-draggable ui-draggable-dragging ui-draggable-disabled"</span>),<span class="keyword">this</span>._mouseDestroy(),<span class="keyword">this</span>},_mouseCapture:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=<span class="keyword">this</span>.options;<span class="keyword">return</span> <span class="keyword">this</span>.helper||c.disabled||a(b.target).is(<span class="string">".ui-resizable-handle"</span>)?!<span class="number">1</span>:(<span class="keyword">this</span>.handle=<span class="keyword">this</span>._getHandle(b),<span class="keyword">this</span>.handle?(c.iframeFix&amp;&amp;a(c.iframeFix===!<span class="number">0</span>?<span class="string">"iframe"</span>:c.iframeFix).each(<span class="keyword">function</span>(){a(<span class="string">'&lt;div class="ui-draggable-iframeFix" style="background: #fff;"&gt;&lt;/div&gt;'</span>).css({width:<span class="keyword">this</span>.offsetWidth+<span class="string">"px"</span>,height:<span class="keyword">this</span>.offsetHeight+<span class="string">"px"</span>,position:<span class="string">"absolute"</span>,opacity:<span class="string">"0.001"</span>,zIndex:<span class="number">1e3</span>}).css(a(<span class="keyword">this</span>).offset()).appendTo(<span class="string">"body"</span>)}),!<span class="number">0</span>):!<span class="number">1</span>)},_mouseStart:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=<span class="keyword">this</span>.options;<span class="keyword">return</span> <span class="keyword">this</span>.helper=<span class="keyword">this</span>._createHelper(b),<span class="keyword">this</span>.helper.addClass(<span class="string">"ui-draggable-dragging"</span>),<span class="keyword">this</span>._cacheHelperProportions(),a.ui.ddmanager&amp;&amp;(a.ui.ddmanager.current=<span class="keyword">this</span>),<span class="keyword">this</span>._cacheMargins(),<span class="keyword">this</span>.cssPosition=<span class="keyword">this</span>.helper.css(<span class="string">"position"</span>),<span class="keyword">this</span>.scrollParent=<span class="keyword">this</span>.helper.scrollParent(),<span class="keyword">this</span>.offset=<span class="keyword">this</span>.positionAbs=<span class="keyword">this</span>.element.offset(),<span class="keyword">this</span>.offset={top:<span class="keyword">this</span>.offset.top-<span class="keyword">this</span>.margins.top,left:<span class="keyword">this</span>.offset.left-<span class="keyword">this</span>.margins.left},a.extend(<span class="keyword">this</span>.offset,{click:{left:b.pageX-<span class="keyword">this</span>.offset.left,top:b.pageY-<span class="keyword">this</span>.offset.top},parent:<span class="keyword">this</span>._getParentOffset(),relative:<span class="keyword">this</span>._getRelativeOffset()}),<span class="keyword">this</span>.originalPosition=<span class="keyword">this</span>.position=<span class="keyword">this</span>._generatePosition(b),<span class="keyword">this</span>.originalPageX=b.pageX,<span class="keyword">this</span>.originalPageY=b.pageY,c.cursorAt&amp;&amp;<span class="keyword">this</span>._adjustOffsetFromHelper(c.cursorAt),c.containment&amp;&amp;<span class="keyword">this</span>._setContainment(),<span class="keyword">this</span>._trigger(<span class="string">"start"</span>,b)===!<span class="number">1</span>?(<span class="keyword">this</span>._clear(),!<span class="number">1</span>):(<span class="keyword">this</span>._cacheHelperProportions(),a.ui.ddmanager&amp;&amp;!c.dropBehaviour&amp;&amp;a.ui.ddmanager.prepareOffsets(<span class="keyword">this</span>,b),<span class="keyword">this</span>._mouseDrag(b,!<span class="number">0</span>),a.ui.ddmanager&amp;&amp;a.ui.ddmanager.dragStart(<span class="keyword">this</span>,b),!<span class="number">0</span>)},_mouseDrag:<span class="keyword">function</span>(b,c){<span class="keyword">this</span>.position=<span class="keyword">this</span>._generatePosition(b),<span class="keyword">this</span>.positionAbs=<span class="keyword">this</span>._convertPositionTo(<span class="string">"absolute"</span>);<span class="keyword">if</span>(!c){<span class="keyword">var</span> d=<span class="keyword">this</span>._uiHash();<span class="keyword">if</span>(<span class="keyword">this</span>._trigger(<span class="string">"drag"</span>,b,d)===!<span class="number">1</span>)<span class="keyword">return</span> <span class="keyword">this</span>._mouseUp({}),!<span class="number">1</span>;<span class="keyword">this</span>.position=d.position}<span class="keyword">if</span>(!<span class="keyword">this</span>.options.axis||<span class="keyword">this</span>.options.axis!=<span class="string">"y"</span>)<span class="keyword">this</span>.helper[<span class="number">0</span>].style.left=<span class="keyword">this</span>.position.left+<span class="string">"px"</span>;<span class="keyword">if</span>(!<span class="keyword">this</span>.options.axis||<span class="keyword">this</span>.options.axis!=<span class="string">"x"</span>)<span class="keyword">this</span>.helper[<span class="number">0</span>].style.top=<span class="keyword">this</span>.position.top+<span class="string">"px"</span>;<span class="keyword">return</span> a.ui.ddmanager&amp;&amp;a.ui.ddmanager.drag(<span class="keyword">this</span>,b),!<span class="number">1</span>},_mouseStop:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=!<span class="number">1</span>;a.ui.ddmanager&amp;&amp;!<span class="keyword">this</span>.options.dropBehaviour&amp;&amp;(c=a.ui.ddmanager.drop(<span class="keyword">this</span>,b)),<span class="keyword">this</span>.dropped&amp;&amp;(c=<span class="keyword">this</span>.dropped,<span class="keyword">this</span>.dropped=!<span class="number">1</span>);<span class="keyword">var</span> d=<span class="keyword">this</span>.element[<span class="number">0</span>],e=!<span class="number">1</span>;<span class="keyword">while</span>(d&amp;&amp;(d=d.parentNode))d==document&amp;&amp;(e=!<span class="number">0</span>);<span class="keyword">if</span>(!e&amp;&amp;<span class="keyword">this</span>.options.helper===<span class="string">"original"</span>)<span class="keyword">return</span>!<span class="number">1</span>;<span class="keyword">if</span>(<span class="keyword">this</span>.options.revert==<span class="string">"invalid"</span>&amp;&amp;!c||<span class="keyword">this</span>.options.revert==<span class="string">"valid"</span>&amp;&amp;c||<span class="keyword">this</span>.options.revert===!<span class="number">0</span>||a.isFunction(<span class="keyword">this</span>.options.revert)&amp;&amp;<span class="keyword">this</span>.options.revert.call(<span class="keyword">this</span>.element,c)){<span class="keyword">var</span> f=<span class="keyword">this</span>;a(<span class="keyword">this</span>.helper).animate(<span class="keyword">this</span>.originalPosition,parseInt(<span class="keyword">this</span>.options.revertDuration,<span class="number">10</span>),<span class="keyword">function</span>(){f._trigger(<span class="string">"stop"</span>,b)!==!<span class="number">1</span>&amp;&amp;f._clear()})}<span class="keyword">else</span> <span class="keyword">this</span>._trigger(<span class="string">"stop"</span>,b)!==!<span class="number">1</span>&amp;&amp;<span class="keyword">this</span>._clear();<span class="keyword">return</span>!<span class="number">1</span>},_mouseUp:<span class="keyword">function</span>(b){<span class="keyword">return</span> <span class="keyword">this</span>.options.iframeFix===!<span class="number">0</span>&amp;&amp;a(<span class="string">"div.ui-draggable-iframeFix"</span>).each(<span class="keyword">function</span>(){<span class="keyword">this</span>.parentNode.removeChild(<span class="keyword">this</span>)}),a.ui.ddmanager&amp;&amp;a.ui.ddmanager.dragStop(<span class="keyword">this</span>,b),a.ui.mouse.prototype._mouseUp.call(<span class="keyword">this</span>,b)},cancel:<span class="keyword">function</span>(){<span class="keyword">return</span> <span class="keyword">this</span>.helper.is(<span class="string">".ui-draggable-dragging"</span>)?<span class="keyword">this</span>._mouseUp({}):<span class="keyword">this</span>._clear(),<span class="keyword">this</span>},_getHandle:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=!<span class="keyword">this</span>.options.handle||!a(<span class="keyword">this</span>.options.handle,<span class="keyword">this</span>.element).length?!<span class="number">0</span>:!<span class="number">1</span>;<span class="keyword">return</span> a(<span class="keyword">this</span>.options.handle,<span class="keyword">this</span>.element).find(<span class="string">"*"</span>).andSelf().each(<span class="keyword">function</span>(){<span class="keyword">this</span>==b.target&amp;&amp;(c=!<span class="number">0</span>)}),c},_createHelper:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=<span class="keyword">this</span>.options,d=a.isFunction(c.helper)?a(c.helper.apply(<span class="keyword">this</span>.element[<span class="number">0</span>],[b])):c.helper==<span class="string">"clone"</span>?<span class="keyword">this</span>.element.clone().removeAttr(<span class="string">"id"</span>):<span class="keyword">this</span>.element;<span class="keyword">return</span> d.parents(<span class="string">"body"</span>).length||d.appendTo(c.appendTo==<span class="string">"parent"</span>?<span class="keyword">this</span>.element[<span class="number">0</span>].parentNode:c.appendTo),d[<span class="number">0</span>]!=<span class="keyword">this</span>.element[<span class="number">0</span>]&amp;&amp;!<span class="regexp">/(fixed|absolute)/</span>.test(d.css(<span class="string">"position"</span>))&amp;&amp;d.css(<span class="string">"position"</span>,<span class="string">"absolute"</span>),d},_adjustOffsetFromHelper:<span class="keyword">function</span>(b){<span class="keyword">typeof</span> b==<span class="string">"string"</span>&amp;&amp;(b=b.split(<span class="string">" "</span>)),a.isArray(b)&amp;&amp;(b={left:+b[<span class="number">0</span>],top:+b[<span class="number">1</span>]||<span class="number">0</span>}),<span class="string">"left"</span><span class="keyword">in</span> b&amp;&amp;(<span class="keyword">this</span>.offset.click.left=b.left+<span class="keyword">this</span>.margins.left),<span class="string">"right"</span><span class="keyword">in</span> b&amp;&amp;(<span class="keyword">this</span>.offset.click.left=<span class="keyword">this</span>.helperProportions.width-b.right+<span class="keyword">this</span>.margins.left),<span class="string">"top"</span><span class="keyword">in</span> b&amp;&amp;(<span class="keyword">this</span>.offset.click.top=b.top+<span class="keyword">this</span>.margins.top),<span class="string">"bottom"</span><span class="keyword">in</span> b&amp;&amp;(<span class="keyword">this</span>.offset.click.top=<span class="keyword">this</span>.helperProportions.height-b.bottom+<span class="keyword">this</span>.margins.top)},_getParentOffset:<span class="keyword">function</span>(){<span class="keyword">this</span>.offsetParent=<span class="keyword">this</span>.helper.offsetParent();<span class="keyword">var</span> b=<span class="keyword">this</span>.offsetParent.offset();<span class="keyword">this</span>.cssPosition==<span class="string">"absolute"</span>&amp;&amp;<span class="keyword">this</span>.scrollParent[<span class="number">0</span>]!=document&amp;&amp;a.ui.contains(<span class="keyword">this</span>.scrollParent[<span class="number">0</span>],<span class="keyword">this</span>.offsetParent[<span class="number">0</span>])&amp;&amp;(b.left+=<span class="keyword">this</span>.scrollParent.scrollLeft(),b.top+=<span class="keyword">this</span>.scrollParent.scrollTop());<span class="keyword">if</span>(<span class="keyword">this</span>.offsetParent[<span class="number">0</span>]==document.body||<span class="keyword">this</span>.offsetParent[<span class="number">0</span>].tagName&amp;&amp;<span class="keyword">this</span>.offsetParent[<span class="number">0</span>].tagName.toLowerCase()==<span class="string">"html"</span>&amp;&amp;a.browser.msie)b={top:<span class="number">0</span>,left:<span class="number">0</span>};<span class="keyword">return</span>{top:b.top+(parseInt(<span class="keyword">this</span>.offsetParent.css(<span class="string">"borderTopWidth"</span>),<span class="number">10</span>)||<span class="number">0</span>),left:b.left+(parseInt(<span class="keyword">this</span>.offsetParent.css(<span class="string">"borderLeftWidth"</span>),<span class="number">10</span>)||<span class="number">0</span>)}},_getRelativeOffset:<span class="keyword">function</span>(){<span class="keyword">if</span>(<span class="keyword">this</span>.cssPosition==<span class="string">"relative"</span>){<span class="keyword">var</span> a=<span class="keyword">this</span>.element.position();<span class="keyword">return</span>{top:a.top-(parseInt(<span class="keyword">this</span>.helper.css(<span class="string">"top"</span>),<span class="number">10</span>)||<span class="number">0</span>)+<span class="keyword">this</span>.scrollParent.scrollTop(),left:a.left-(parseInt(<span class="keyword">this</span>.helper.css(<span class="string">"left"</span>),<span class="number">10</span>)||<span class="number">0</span>)+<span class="keyword">this</span>.scrollParent.scrollLeft()}}<span class="keyword">return</span>{top:<span class="number">0</span>,left:<span class="number">0</span>}},_cacheMargins:<span class="keyword">function</span>(){<span class="keyword">this</span>.margins={left:parseInt(<span class="keyword">this</span>.element.css(<span class="string">"marginLeft"</span>),<span class="number">10</span>)||<span class="number">0</span>,top:parseInt(<span class="keyword">this</span>.element.css(<span class="string">"marginTop"</span>),<span class="number">10</span>)||<span class="number">0</span>,right:parseInt(<span class="keyword">this</span>.element.css(<span class="string">"marginRight"</span>),<span class="number">10</span>)||<span class="number">0</span>,bottom:parseInt(<span class="keyword">this</span>.element.css(<span class="string">"marginBottom"</span>),<span class="number">10</span>)||<span class="number">0</span>}},_cacheHelperProportions:<span class="keyword">function</span>(){<span class="keyword">this</span>.helperProportions={width:<span class="keyword">this</span>.helper.outerWidth(),height:<span class="keyword">this</span>.helper.outerHeight()}},_setContainment:<span class="keyword">function</span>(){<span class="keyword">var</span> b=<span class="keyword">this</span>.options;b.containment==<span class="string">"parent"</span>&amp;&amp;(b.containment=<span class="keyword">this</span>.helper[<span class="number">0</span>].parentNode);<span class="keyword">if</span>(b.containment==<span class="string">"document"</span>||b.containment==<span class="string">"window"</span>)<span class="keyword">this</span>.containment=[b.containment==<span class="string">"document"</span>?<span class="number">0</span>:a(window).scrollLeft()-<span class="keyword">this</span>.offset.relative.left-<span class="keyword">this</span>.offset.parent.left,b.containment==<span class="string">"document"</span>?<span class="number">0</span>:a(window).scrollTop()-<span class="keyword">this</span>.offset.relative.top-<span class="keyword">this</span>.offset.parent.top,(b.containment==<span class="string">"document"</span>?<span class="number">0</span>:a(window).scrollLeft())+a(b.containment==<span class="string">"document"</span>?document:window).width()-<span class="keyword">this</span>.helperProportions.width-<span class="keyword">this</span>.margins.left,(b.containment==<span class="string">"document"</span>?<span class="number">0</span>:a(window).scrollTop())+(a(b.containment==<span class="string">"document"</span>?document:window).height()||document.body.parentNode.scrollHeight)-<span class="keyword">this</span>.helperProportions.height-<span class="keyword">this</span>.margins.top];<span class="keyword">if</span>(!<span class="regexp">/^(document|window|parent)$/</span>.test(b.containment)&amp;&amp;b.containment.constructor!=Array){<span class="keyword">var</span> c=a(b.containment),d=c[<span class="number">0</span>];<span class="keyword">if</span>(!d)<span class="keyword">return</span>;<span class="keyword">var</span> e=c.offset(),f=a(d).css(<span class="string">"overflow"</span>)!=<span class="string">"hidden"</span>;<span class="keyword">this</span>.containment=[(parseInt(a(d).css(<span class="string">"borderLeftWidth"</span>),<span class="number">10</span>)||<span class="number">0</span>)+(parseInt(a(d).css(<span class="string">"paddingLeft"</span>),<span class="number">10</span>)||<span class="number">0</span>),(parseInt(a(d).css(<span class="string">"borderTopWidth"</span>),<span class="number">10</span>)||<span class="number">0</span>)+(parseInt(a(d).css(<span class="string">"paddingTop"</span>),<span class="number">10</span>)||<span class="number">0</span>),(f?Math.max(d.scrollWidth,d.offsetWidth):d.offsetWidth)-(parseInt(a(d).css(<span class="string">"borderLeftWidth"</span>),<span class="number">10</span>)||<span class="number">0</span>)-(parseInt(a(d).css(<span class="string">"paddingRight"</span>),<span class="number">10</span>)||<span class="number">0</span>)-<span class="keyword">this</span>.helperProportions.width-<span class="keyword">this</span>.margins.left-<span class="keyword">this</span>.margins.right,(f?Math.max(d.scrollHeight,d.offsetHeight):d.offsetHeight)-(parseInt(a(d).css(<span class="string">"borderTopWidth"</span>),<span class="number">10</span>)||<span class="number">0</span>)-(parseInt(a(d).css(<span class="string">"paddingBottom"</span>),<span class="number">10</span>)||<span class="number">0</span>)-<span class="keyword">this</span>.helperProportions.height-<span class="keyword">this</span>.margins.top-<span class="keyword">this</span>.margins.bottom],<span class="keyword">this</span>.relative_container=c}<span class="keyword">else</span> b.containment.constructor==Array&amp;&amp;(<span class="keyword">this</span>.containment=b.containment)},_convertPositionTo:<span class="keyword">function</span>(b,c){c||(c=<span class="keyword">this</span>.position);<span class="keyword">var</span> d=b==<span class="string">"absolute"</span>?<span class="number">1</span>:-<span class="number">1</span>,e=<span class="keyword">this</span>.options,f=<span class="keyword">this</span>.cssPosition==<span class="string">"absolute"</span>&amp;&amp;(<span class="keyword">this</span>.scrollParent[<span class="number">0</span>]==document||!a.ui.contains(<span class="keyword">this</span>.scrollParent[<span class="number">0</span>],<span class="keyword">this</span>.offsetParent[<span class="number">0</span>]))?<span class="keyword">this</span>.offsetParent:<span class="keyword">this</span>.scrollParent,g=<span class="regexp">/(html|body)/i</span>.test(f[<span class="number">0</span>].tagName);<span class="keyword">return</span>{top:c.top+<span class="keyword">this</span>.offset.relative.top*d+<span class="keyword">this</span>.offset.parent.top*d-(a.browser.safari&amp;&amp;a.browser.version&lt;<span class="number">526</span>&amp;&amp;<span class="keyword">this</span>.cssPosition==<span class="string">"fixed"</span>?<span class="number">0</span>:(<span class="keyword">this</span>.cssPosition==<span class="string">"fixed"</span>?-<span class="keyword">this</span>.scrollParent.scrollTop():g?<span class="number">0</span>:f.scrollTop())*d),left:c.left+<span class="keyword">this</span>.offset.relative.left*d+<span class="keyword">this</span>.offset.parent.left*d-(a.browser.safari&amp;&amp;a.browser.version&lt;<span class="number">526</span>&amp;&amp;<span class="keyword">this</span>.cssPosition==<span class="string">"fixed"</span>?<span class="number">0</span>:(<span class="keyword">this</span>.cssPosition==<span class="string">"fixed"</span>?-<span class="keyword">this</span>.scrollParent.scrollLeft():g?<span class="number">0</span>:f.scrollLeft())*d)}},_generatePosition:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=<span class="keyword">this</span>.options,d=<span class="keyword">this</span>.cssPosition==<span class="string">"absolute"</span>&amp;&amp;(<span class="keyword">this</span>.scrollParent[<span class="number">0</span>]==document||!a.ui.contains(<span class="keyword">this</span>.scrollParent[<span class="number">0</span>],<span class="keyword">this</span>.offsetParent[<span class="number">0</span>]))?<span class="keyword">this</span>.offsetParent:<span class="keyword">this</span>.scrollParent,e=<span class="regexp">/(html|body)/i</span>.test(d[<span class="number">0</span>].tagName),f=b.pageX,g=b.pageY;<span class="keyword">if</span>(<span class="keyword">this</span>.originalPosition){<span class="keyword">var</span> h;<span class="keyword">if</span>(<span class="keyword">this</span>.containment){<span class="keyword">if</span>(<span class="keyword">this</span>.relative_container){<span class="keyword">var</span> i=<span class="keyword">this</span>.relative_container.offset();h=[<span class="keyword">this</span>.containment[<span class="number">0</span>]+i.left,<span class="keyword">this</span>.containment[<span class="number">1</span>]+i.top,<span class="keyword">this</span>.containment[<span class="number">2</span>]+i.left,<span class="keyword">this</span>.containment[<span class="number">3</span>]+i.top]}<span class="keyword">else</span> h=<span class="keyword">this</span>.containment;b.pageX-<span class="keyword">this</span>.offset.click.left&lt;h[<span class="number">0</span>]&amp;&amp;(f=h[<span class="number">0</span>]+<span class="keyword">this</span>.offset.click.left),b.pageY-<span class="keyword">this</span>.offset.click.top&lt;h[<span class="number">1</span>]&amp;&amp;(g=h[<span class="number">1</span>]+<span class="keyword">this</span>.offset.click.top),b.pageX-<span class="keyword">this</span>.offset.click.left&gt;h[<span class="number">2</span>]&amp;&amp;(f=h[<span class="number">2</span>]+<span class="keyword">this</span>.offset.click.left),b.pageY-<span class="keyword">this</span>.offset.click.top&gt;h[<span class="number">3</span>]&amp;&amp;(g=h[<span class="number">3</span>]+<span class="keyword">this</span>.offset.click.top)}<span class="keyword">if</span>(c.grid){<span class="keyword">var</span> j=c.grid[<span class="number">1</span>]?<span class="keyword">this</span>.originalPageY+Math.round((g-<span class="keyword">this</span>.originalPageY)/c.grid[<span class="number">1</span>])*c.grid[<span class="number">1</span>]:<span class="keyword">this</span>.originalPageY;g=h?j-<span class="keyword">this</span>.offset.click.top&lt;h[<span class="number">1</span>]||j-<span class="keyword">this</span>.offset.click.top&gt;h[<span class="number">3</span>]?j-<span class="keyword">this</span>.offset.click.top&lt;h[<span class="number">1</span>]?j+c.grid[<span class="number">1</span>]:j-c.grid[<span class="number">1</span>]:j:j;<span class="keyword">var</span> k=c.grid[<span class="number">0</span>]?<span class="keyword">this</span>.originalPageX+Math.round((f-<span class="keyword">this</span>.originalPageX)/c.grid[<span class="number">0</span>])*c.grid[<span class="number">0</span>]:<span class="keyword">this</span>.originalPageX;f=h?k-<span class="keyword">this</span>.offset.click.left&lt;h[<span class="number">0</span>]||k-<span class="keyword">this</span>.offset.click.left&gt;h[<span class="number">2</span>]?k-<span class="keyword">this</span>.offset.click.left&lt;h[<span class="number">0</span>]?k+c.grid[<span class="number">0</span>]:k-c.grid[<span class="number">0</span>]:k:k}}<span class="keyword">return</span>{top:g-<span class="keyword">this</span>.offset.click.top-<span class="keyword">this</span>.offset.relative.top-<span class="keyword">this</span>.offset.parent.top+(a.browser.safari&amp;&amp;a.browser.version&lt;<span class="number">526</span>&amp;&amp;<span class="keyword">this</span>.cssPosition==<span class="string">"fixed"</span>?<span class="number">0</span>:<span class="keyword">this</span>.cssPosition==<span class="string">"fixed"</span>?-<span class="keyword">this</span>.scrollParent.scrollTop():e?<span class="number">0</span>:d.scrollTop()),left:f-<span class="keyword">this</span>.offset.click.left-<span class="keyword">this</span>.offset.relative.left-<span class="keyword">this</span>.offset.parent.left+(a.browser.safari&amp;&amp;a.browser.version&lt;<span class="number">526</span>&amp;&amp;<span class="keyword">this</span>.cssPosition==<span class="string">"fixed"</span>?<span class="number">0</span>:<span class="keyword">this</span>.cssPosition==<span class="string">"fixed"</span>?-<span class="keyword">this</span>.scrollParent.scrollLeft():e?<span class="number">0</span>:d.scrollLeft())}},_clear:<span class="keyword">function</span>(){<span class="keyword">this</span>.helper.removeClass(<span class="string">"ui-draggable-dragging"</span>),<span class="keyword">this</span>.helper[<span class="number">0</span>]!=<span class="keyword">this</span>.element[<span class="number">0</span>]&amp;&amp;!<span class="keyword">this</span>.cancelHelperRemoval&amp;&amp;<span class="keyword">this</span>.helper.remove(),<span class="keyword">this</span>.helper=<span class="literal">null</span>,<span class="keyword">this</span>.cancelHelperRemoval=!<span class="number">1</span>},_trigger:<span class="keyword">function</span>(b,c,d){<span class="keyword">return</span> d=d||<span class="keyword">this</span>._uiHash(),a.ui.plugin.call(<span class="keyword">this</span>,b,[c,d]),b==<span class="string">"drag"</span>&amp;&amp;(<span class="keyword">this</span>.positionAbs=<span class="keyword">this</span>._convertPositionTo(<span class="string">"absolute"</span>)),a.Widget.prototype._trigger.call(<span class="keyword">this</span>,b,c,d)},plugins:{},_uiHash:<span class="keyword">function</span>(a){<span class="keyword">return</span>{helper:<span class="keyword">this</span>.helper,position:<span class="keyword">this</span>.position,originalPosition:<span class="keyword">this</span>.originalPosition,offset:<span class="keyword">this</span>.positionAbs}}}),a.extend(a.ui.draggable,{version:<span class="string">"1.8.21"</span>}),a.ui.plugin.add(<span class="string">"draggable"</span>,<span class="string">"connectToSortable"</span>,{start:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=a(<span class="keyword">this</span>).data(<span class="string">"draggable"</span>),e=d.options,f=a.extend({},c,{item:d.element});d.sortables=[],a(e.connectToSortable).each(<span class="keyword">function</span>(){<span class="keyword">var</span> c=a.data(<span class="keyword">this</span>,<span class="string">"sortable"</span>);c&amp;&amp;!c.options.disabled&amp;&amp;(d.sortables.push({instance:c,shouldRevert:c.options.revert}),c.refreshPositions(),c._trigger(<span class="string">"activate"</span>,b,f))})},stop:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=a(<span class="keyword">this</span>).data(<span class="string">"draggable"</span>),e=a.extend({},c,{item:d.element});a.each(d.sortables,<span class="keyword">function</span>(){<span class="keyword">this</span>.instance.isOver?(<span class="keyword">this</span>.instance.isOver=<span class="number">0</span>,d.cancelHelperRemoval=!<span class="number">0</span>,<span class="keyword">this</span>.instance.cancelHelperRemoval=!<span class="number">1</span>,<span class="keyword">this</span>.shouldRevert&amp;&amp;(<span class="keyword">this</span>.instance.options.revert=!<span class="number">0</span>),<span class="keyword">this</span>.instance._mouseStop(b),<span class="keyword">this</span>.instance.options.helper=<span class="keyword">this</span>.instance.options._helper,d.options.helper==<span class="string">"original"</span>&amp;&amp;<span class="keyword">this</span>.instance.currentItem.css({top:<span class="string">"auto"</span>,left:<span class="string">"auto"</span>})):(<span class="keyword">this</span>.instance.cancelHelperRemoval=!<span class="number">1</span>,<span class="keyword">this</span>.instance._trigger(<span class="string">"deactivate"</span>,b,e))})},drag:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=a(<span class="keyword">this</span>).data(<span class="string">"draggable"</span>),e=<span class="keyword">this</span>,f=<span class="keyword">function</span>(b){<span class="keyword">var</span> c=<span class="keyword">this</span>.offset.click.top,d=<span class="keyword">this</span>.offset.click.left,e=<span class="keyword">this</span>.positionAbs.top,f=<span class="keyword">this</span>.positionAbs.left,g=b.height,h=b.width,i=b.top,j=b.left;<span class="keyword">return</span> a.ui.isOver(e+c,f+d,i,j,g,h)};a.each(d.sortables,<span class="keyword">function</span>(f){<span class="keyword">this</span>.instance.positionAbs=d.positionAbs,<span class="keyword">this</span>.instance.helperProportions=d.helperProportions,<span class="keyword">this</span>.instance.offset.click=d.offset.click,<span class="keyword">this</span>.instance._intersectsWith(<span class="keyword">this</span>.instance.containerCache)?(<span class="keyword">this</span>.instance.isOver||(<span class="keyword">this</span>.instance.isOver=<span class="number">1</span>,<span class="keyword">this</span>.instance.currentItem=a(e).clone().removeAttr(<span class="string">"id"</span>).appendTo(<span class="keyword">this</span>.instance.element).data(<span class="string">"sortable-item"</span>,!<span class="number">0</span>),<span class="keyword">this</span>.instance.options._helper=<span class="keyword">this</span>.instance.options.helper,<span class="keyword">this</span>.instance.options.helper=<span class="keyword">function</span>(){<span class="keyword">return</span> c.helper[<span class="number">0</span>]},b.target=<span class="keyword">this</span>.instance.currentItem[<span class="number">0</span>],<span class="keyword">this</span>.instance._mouseCapture(b,!<span class="number">0</span>),<span class="keyword">this</span>.instance._mouseStart(b,!<span class="number">0</span>,!<span class="number">0</span>),<span class="keyword">this</span>.instance.offset.click.top=d.offset.click.top,<span class="keyword">this</span>.instance.offset.click.left=d.offset.click.left,<span class="keyword">this</span>.instance.offset.parent.left-=d.offset.parent.left-<span class="keyword">this</span>.instance.offset.parent.left,<span class="keyword">this</span>.instance.offset.parent.top-=d.offset.parent.top-<span class="keyword">this</span>.instance.offset.parent.top,d._trigger(<span class="string">"toSortable"</span>,b),d.dropped=<span class="keyword">this</span>.instance.element,d.currentItem=d.element,<span class="keyword">this</span>.instance.fromOutside=d),<span class="keyword">this</span>.instance.currentItem&amp;&amp;<span class="keyword">this</span>.instance._mouseDrag(b)):<span class="keyword">this</span>.instance.isOver&amp;&amp;(<span class="keyword">this</span>.instance.isOver=<span class="number">0</span>,<span class="keyword">this</span>.instance.cancelHelperRemoval=!<span class="number">0</span>,<span class="keyword">this</span>.instance.options.revert=!<span class="number">1</span>,<span class="keyword">this</span>.instance._trigger(<span class="string">"out"</span>,b,<span class="keyword">this</span>.instance._uiHash(<span class="keyword">this</span>.instance)),<span class="keyword">this</span>.instance._mouseStop(b,!<span class="number">0</span>),<span class="keyword">this</span>.instance.options.helper=<span class="keyword">this</span>.instance.options._helper,<span class="keyword">this</span>.instance.currentItem.remove(),<span class="keyword">this</span>.instance.placeholder&amp;&amp;<span class="keyword">this</span>.instance.placeholder.remove(),d._trigger(<span class="string">"fromSortable"</span>,b),d.dropped=!<span class="number">1</span>)})}}),a.ui.plugin.add(<span class="string">"draggable"</span>,<span class="string">"cursor"</span>,{start:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=a(<span class="string">"body"</span>),e=a(<span class="keyword">this</span>).data(<span class="string">"draggable"</span>).options;d.css(<span class="string">"cursor"</span>)&amp;&amp;(e._cursor=d.css(<span class="string">"cursor"</span>)),d.css(<span class="string">"cursor"</span>,e.cursor)},stop:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=a(<span class="keyword">this</span>).data(<span class="string">"draggable"</span>).options;d._cursor&amp;&amp;a(<span class="string">"body"</span>).css(<span class="string">"cursor"</span>,d._cursor)}}),a.ui.plugin.add(<span class="string">"draggable"</span>,<span class="string">"opacity"</span>,{start:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=a(c.helper),e=a(<span class="keyword">this</span>).data(<span class="string">"draggable"</span>).options;d.css(<span class="string">"opacity"</span>)&amp;&amp;(e._opacity=d.css(<span class="string">"opacity"</span>)),d.css(<span class="string">"opacity"</span>,e.opacity)},stop:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=a(<span class="keyword">this</span>).data(<span class="string">"draggable"</span>).options;d._opacity&amp;&amp;a(c.helper).css(<span class="string">"opacity"</span>,d._opacity)}}),a.ui.plugin.add(<span class="string">"draggable"</span>,<span class="string">"scroll"</span>,{start:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=a(<span class="keyword">this</span>).data(<span class="string">"draggable"</span>);d.scrollParent[<span class="number">0</span>]!=document&amp;&amp;d.scrollParent[<span class="number">0</span>].tagName!=<span class="string">"HTML"</span>&amp;&amp;(d.overflowOffset=d.scrollParent.offset())},drag:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=a(<span class="keyword">this</span>).data(<span class="string">"draggable"</span>),e=d.options,f=!<span class="number">1</span>;<span class="keyword">if</span>(d.scrollParent[<span class="number">0</span>]!=document&amp;&amp;d.scrollParent[<span class="number">0</span>].tagName!=<span class="string">"HTML"</span>){<span class="keyword">if</span>(!e.axis||e.axis!=<span class="string">"x"</span>)d.overflowOffset.top+d.scrollParent[<span class="number">0</span>].offsetHeight-b.pageY&lt;e.scrollSensitivity?d.scrollParent[<span class="number">0</span>].scrollTop=f=d.scrollParent[<span class="number">0</span>].scrollTop+e.scrollSpeed:b.pageY-d.overflowOffset.top&lt;e.scrollSensitivity&amp;&amp;(d.scrollParent[<span class="number">0</span>].scrollTop=f=d.scrollParent[<span class="number">0</span>].scrollTop-e.scrollSpeed);<span class="keyword">if</span>(!e.axis||e.axis!=<span class="string">"y"</span>)d.overflowOffset.left+d.scrollParent[<span class="number">0</span>].offsetWidth-b.pageX&lt;e.scrollSensitivity?d.scrollParent[<span class="number">0</span>].scrollLeft=f=d.scrollParent[<span class="number">0</span>].scrollLeft+e.scrollSpeed:b.pageX-d.overflowOffset.left&lt;e.scrollSensitivity&amp;&amp;(d.scrollParent[<span class="number">0</span>].scrollLeft=f=d.scrollParent[<span class="number">0</span>].scrollLeft-e.scrollSpeed)}<span class="keyword">else</span>{<span class="keyword">if</span>(!e.axis||e.axis!=<span class="string">"x"</span>)b.pageY-a(document).scrollTop()&lt;e.scrollSensitivity?f=a(document).scrollTop(a(document).scrollTop()-e.scrollSpeed):a(window).height()-(b.pageY-a(document).scrollTop())&lt;e.scrollSensitivity&amp;&amp;(f=a(document).scrollTop(a(document).scrollTop()+e.scrollSpeed));<span class="keyword">if</span>(!e.axis||e.axis!=<span class="string">"y"</span>)b.pageX-a(document).scrollLeft()&lt;e.scrollSensitivity?f=a(document).scrollLeft(a(document).scrollLeft()-e.scrollSpeed):a(window).width()-(b.pageX-a(document).scrollLeft())&lt;e.scrollSensitivity&amp;&amp;(f=a(document).scrollLeft(a(document).scrollLeft()+e.scrollSpeed))}f!==!<span class="number">1</span>&amp;&amp;a.ui.ddmanager&amp;&amp;!e.dropBehaviour&amp;&amp;a.ui.ddmanager.prepareOffsets(d,b)}}),a.ui.plugin.add(<span class="string">"draggable"</span>,<span class="string">"snap"</span>,{start:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=a(<span class="keyword">this</span>).data(<span class="string">"draggable"</span>),e=d.options;d.snapElements=[],a(e.snap.constructor!=String?e.snap.items||<span class="string">":data(draggable)"</span>:e.snap).each(<span class="keyword">function</span>(){<span class="keyword">var</span> b=a(<span class="keyword">this</span>),c=b.offset();<span class="keyword">this</span>!=d.element[<span class="number">0</span>]&amp;&amp;d.snapElements.push({item:<span class="keyword">this</span>,width:b.outerWidth(),height:b.outerHeight(),top:c.top,left:c.left})})},drag:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=a(<span class="keyword">this</span>).data(<span class="string">"draggable"</span>),e=d.options,f=e.snapTolerance,g=c.offset.left,h=g+d.helperProportions.width,i=c.offset.top,j=i+d.helperProportions.height;<span class="keyword">for</span>(<span class="keyword">var</span> k=d.snapElements.length-<span class="number">1</span>;k&gt;=<span class="number">0</span>;k--){<span class="keyword">var</span> l=d.snapElements[k].left,m=l+d.snapElements[k].width,n=d.snapElements[k].top,o=n+d.snapElements[k].height;<span class="keyword">if</span>(!(l-f&lt;g&amp;&amp;g&lt;m+f&amp;&amp;n-f&lt;i&amp;&amp;i&lt;o+f||l-f&lt;g&amp;&amp;g&lt;m+f&amp;&amp;n-f&lt;j&amp;&amp;j&lt;o+f||l-f&lt;h&amp;&amp;h&lt;m+f&amp;&amp;n-f&lt;i&amp;&amp;i&lt;o+f||l-f&lt;h&amp;&amp;h&lt;m+f&amp;&amp;n-f&lt;j&amp;&amp;j&lt;o+f)){d.snapElements[k].snapping&amp;&amp;d.options.snap.release&amp;&amp;d.options.snap.release.call(d.element,b,a.extend(d._uiHash(),{snapItem:d.snapElements[k].item})),d.snapElements[k].snapping=!<span class="number">1</span>;<span class="keyword">continue</span>}<span class="keyword">if</span>(e.snapMode!=<span class="string">"inner"</span>){<span class="keyword">var</span> p=Math.abs(n-j)&lt;=f,q=Math.abs(o-i)&lt;=f,r=Math.abs(l-h)&lt;=f,s=Math.abs(m-g)&lt;=f;p&amp;&amp;(c.position.top=d._convertPositionTo(<span class="string">"relative"</span>,{top:n-d.helperProportions.height,left:<span class="number">0</span>}).top-d.margins.top),q&amp;&amp;(c.position.top=d._convertPositionTo(<span class="string">"relative"</span>,{top:o,left:<span class="number">0</span>}).top-d.margins.top),r&amp;&amp;(c.position.left=d._convertPositionTo(<span class="string">"relative"</span>,{top:<span class="number">0</span>,left:l-d.helperProportions.width}).left-d.margins.left),s&amp;&amp;(c.position.left=d._convertPositionTo(<span class="string">"relative"</span>,{top:<span class="number">0</span>,left:m}).left-d.margins.left)}<span class="keyword">var</span> t=p||q||r||s;<span class="keyword">if</span>(e.snapMode!=<span class="string">"outer"</span>){<span class="keyword">var</span> p=Math.abs(n-i)&lt;=f,q=Math.abs(o-j)&lt;=f,r=Math.abs(l-g)&lt;=f,s=Math.abs(m-h)&lt;=f;p&amp;&amp;(c.position.top=d._convertPositionTo(<span class="string">"relative"</span>,{top:n,left:<span class="number">0</span>}).top-d.margins.top),q&amp;&amp;(c.position.top=d._convertPositionTo(<span class="string">"relative"</span>,{top:o-d.helperProportions.height,left:<span class="number">0</span>}).top-d.margins.top),r&amp;&amp;(c.position.left=d._convertPositionTo(<span class="string">"relative"</span>,{top:<span class="number">0</span>,left:l}).left-d.margins.left),s&amp;&amp;(c.position.left=d._convertPositionTo(<span class="string">"relative"</span>,{top:<span class="number">0</span>,left:m-d.helperProportions.width}).left-d.margins.left)}!d.snapElements[k].snapping&amp;&amp;(p||q||r||s||t)&amp;&amp;d.options.snap.snap&amp;&amp;d.options.snap.snap.call(d.element,b,a.extend(d._uiHash(),{snapItem:d.snapElements[k].item})),d.snapElements[k].snapping=p||q||r||s||t}}}),a.ui.plugin.add(<span class="string">"draggable"</span>,<span class="string">"stack"</span>,{start:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=a(<span class="keyword">this</span>).data(<span class="string">"draggable"</span>).options,e=a.makeArray(a(d.stack)).sort(<span class="keyword">function</span>(b,c){<span class="keyword">return</span>(parseInt(a(b).css(<span class="string">"zIndex"</span>),<span class="number">10</span>)||<span class="number">0</span>)-(parseInt(a(c).css(<span class="string">"zIndex"</span>),<span class="number">10</span>)||<span class="number">0</span>)});<span class="keyword">if</span>(!e.length)<span class="keyword">return</span>;<span class="keyword">var</span> f=parseInt(e[<span class="number">0</span>].style.zIndex)||<span class="number">0</span>;a(e).each(<span class="keyword">function</span>(a){<span class="keyword">this</span>.style.zIndex=f+a}),<span class="keyword">this</span>[<span class="number">0</span>].style.zIndex=f+e.length}}),a.ui.plugin.add(<span class="string">"draggable"</span>,<span class="string">"zIndex"</span>,{start:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=a(c.helper),e=a(<span class="keyword">this</span>).data(<span class="string">"draggable"</span>).options;d.css(<span class="string">"zIndex"</span>)&amp;&amp;(e._zIndex=d.css(<span class="string">"zIndex"</span>)),d.css(<span class="string">"zIndex"</span>,e.zIndex)},stop:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=a(<span class="keyword">this</span>).data(<span class="string">"draggable"</span>).options;d._zIndex&amp;&amp;a(c.helper).css(<span class="string">"zIndex"</span>,d._zIndex)}})}(jQuery),<span class="keyword">function</span>(a,b){a.widget(<span class="string">"ui.droppable"</span>,{widgetEventPrefix:<span class="string">"drop"</span>,options:{accept:<span class="string">"*"</span>,activeClass:!<span class="number">1</span>,addClasses:!<span class="number">0</span>,greedy:!<span class="number">1</span>,hoverClass:!<span class="number">1</span>,scope:<span class="string">"default"</span>,tolerance:<span class="string">"intersect"</span>},_create:<span class="keyword">function</span>(){<span class="keyword">var</span> b=<span class="keyword">this</span>.options,c=b.accept;<span class="keyword">this</span>.isover=<span class="number">0</span>,<span class="keyword">this</span>.isout=<span class="number">1</span>,<span class="keyword">this</span>.accept=a.isFunction(c)?c:<span class="keyword">function</span>(a){<span class="keyword">return</span> a.is(c)},<span class="keyword">this</span>.proportions={width:<span class="keyword">this</span>.element[<span class="number">0</span>].offsetWidth,height:<span class="keyword">this</span>.element[<span class="number">0</span>].offsetHeight},a.ui.ddmanager.droppables[b.scope]=a.ui.ddmanager.droppables[b.scope]||[],a.ui.ddmanager.droppables[b.scope].push(<span class="keyword">this</span>),b.addClasses&amp;&amp;<span class="keyword">this</span>.element.addClass(<span class="string">"ui-droppable"</span>)},destroy:<span class="keyword">function</span>(){<span class="keyword">var</span> b=a.ui.ddmanager.droppables[<span class="keyword">this</span>.options.scope];<span class="keyword">for</span>(<span class="keyword">var</span> c=<span class="number">0</span>;c&lt;b.length;c++)b[c]==<span class="keyword">this</span>&amp;&amp;b.splice(c,<span class="number">1</span>);<span class="keyword">return</span> <span class="keyword">this</span>.element.removeClass(<span class="string">"ui-droppable ui-droppable-disabled"</span>).removeData(<span class="string">"droppable"</span>).unbind(<span class="string">".droppable"</span>),<span class="keyword">this</span>},_setOption:<span class="keyword">function</span>(b,c){b==<span class="string">"accept"</span>&amp;&amp;(<span class="keyword">this</span>.accept=a.isFunction(c)?c:<span class="keyword">function</span>(a){<span class="keyword">return</span> a.is(c)}),a.Widget.prototype._setOption.apply(<span class="keyword">this</span>,arguments)},_activate:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=a.ui.ddmanager.current;<span class="keyword">this</span>.options.activeClass&amp;&amp;<span class="keyword">this</span>.element.addClass(<span class="keyword">this</span>.options.activeClass),c&amp;&amp;<span class="keyword">this</span>._trigger(<span class="string">"activate"</span>,b,<span class="keyword">this</span>.ui(c))},_deactivate:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=a.ui.ddmanager.current;<span class="keyword">this</span>.options.activeClass&amp;&amp;<span class="keyword">this</span>.element.removeClass(<span class="keyword">this</span>.options.activeClass),c&amp;&amp;<span class="keyword">this</span>._trigger(<span class="string">"deactivate"</span>,b,<span class="keyword">this</span>.ui(c))},_over:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=a.ui.ddmanager.current;<span class="keyword">if</span>(!c||(c.currentItem||c.element)[<span class="number">0</span>]==<span class="keyword">this</span>.element[<span class="number">0</span>])<span class="keyword">return</span>;<span class="keyword">this</span>.accept.call(<span class="keyword">this</span>.element[<span class="number">0</span>],c.currentItem||c.element)&amp;&amp;(<span class="keyword">this</span>.options.hoverClass&amp;&amp;<span class="keyword">this</span>.element.addClass(<span class="keyword">this</span>.options.hoverClass),<span class="keyword">this</span>._trigger(<span class="string">"over"</span>,b,<span class="keyword">this</span>.ui(c)))},_out:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=a.ui.ddmanager.current;<span class="keyword">if</span>(!c||(c.currentItem||c.element)[<span class="number">0</span>]==<span class="keyword">this</span>.element[<span class="number">0</span>])<span class="keyword">return</span>;<span class="keyword">this</span>.accept.call(<span class="keyword">this</span>.element[<span class="number">0</span>],c.currentItem||c.element)&amp;&amp;(<span class="keyword">this</span>.options.hoverClass&amp;&amp;<span class="keyword">this</span>.element.removeClass(<span class="keyword">this</span>.options.hoverClass),<span class="keyword">this</span>._trigger(<span class="string">"out"</span>,b,<span class="keyword">this</span>.ui(c)))},_drop:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=c||a.ui.ddmanager.current;<span class="keyword">if</span>(!d||(d.currentItem||d.element)[<span class="number">0</span>]==<span class="keyword">this</span>.element[<span class="number">0</span>])<span class="keyword">return</span>!<span class="number">1</span>;<span class="keyword">var</span> e=!<span class="number">1</span>;<span class="keyword">return</span> <span class="keyword">this</span>.element.find(<span class="string">":data(droppable)"</span>).not(<span class="string">".ui-draggable-dragging"</span>).each(<span class="keyword">function</span>(){<span class="keyword">var</span> b=a.data(<span class="keyword">this</span>,<span class="string">"droppable"</span>);<span class="keyword">if</span>(b.options.greedy&amp;&amp;!b.options.disabled&amp;&amp;b.options.scope==d.options.scope&amp;&amp;b.accept.call(b.element[<span class="number">0</span>],d.currentItem||d.element)&amp;&amp;a.ui.intersect(d,a.extend(b,{offset:b.element.offset()}),b.options.tolerance))<span class="keyword">return</span> e=!<span class="number">0</span>,!<span class="number">1</span>}),e?!<span class="number">1</span>:<span class="keyword">this</span>.accept.call(<span class="keyword">this</span>.element[<span class="number">0</span>],d.currentItem||d.element)?(<span class="keyword">this</span>.options.activeClass&amp;&amp;<span class="keyword">this</span>.element.removeClass(<span class="keyword">this</span>.options.activeClass),<span class="keyword">this</span>.options.hoverClass&amp;&amp;<span class="keyword">this</span>.element.removeClass(<span class="keyword">this</span>.options.hoverClass),<span class="keyword">this</span>._trigger(<span class="string">"drop"</span>,b,<span class="keyword">this</span>.ui(d)),<span class="keyword">this</span>.element):!<span class="number">1</span>},ui:<span class="keyword">function</span>(a){<span class="keyword">return</span>{draggable:a.currentItem||a.element,helper:a.helper,position:a.position,offset:a.positionAbs}}}),a.extend(a.ui.droppable,{version:<span class="string">"1.8.21"</span>}),a.ui.intersect=<span class="keyword">function</span>(b,c,d){<span class="keyword">if</span>(!c.offset)<span class="keyword">return</span>!<span class="number">1</span>;<span class="keyword">var</span> e=(b.positionAbs||b.position.absolute).left,f=e+b.helperProportions.width,g=(b.positionAbs||b.position.absolute).top,h=g+b.helperProportions.height,i=c.offset.left,j=i+c.proportions.width,k=c.offset.top,l=k+c.proportions.height;<span class="keyword">switch</span>(d){<span class="keyword">case</span><span class="string">"fit"</span>:<span class="keyword">return</span> i&lt;=e&amp;&amp;f&lt;=j&amp;&amp;k&lt;=g&amp;&amp;h&lt;=l;<span class="keyword">case</span><span class="string">"intersect"</span>:<span class="keyword">return</span> i&lt;e+b.helperProportions.width/<span class="number">2</span>&amp;&amp;f-b.helperProportions.width/<span class="number">2</span>&lt;j&amp;&amp;k&lt;g+b.helperProportions.height/<span class="number">2</span>&amp;&amp;h-b.helperProportions.height/<span class="number">2</span>&lt;l;<span class="keyword">case</span><span class="string">"pointer"</span>:<span class="keyword">var</span> m=(b.positionAbs||b.position.absolute).left+(b.clickOffset||b.offset.click).left,n=(b.positionAbs||b.position.absolute).top+(b.clickOffset||b.offset.click).top,o=a.ui.isOver(n,m,k,i,c.proportions.height,c.proportions.width);<span class="keyword">return</span> o;<span class="keyword">case</span><span class="string">"touch"</span>:<span class="keyword">return</span>(g&gt;=k&amp;&amp;g&lt;=l||h&gt;=k&amp;&amp;h&lt;=l||g&lt;k&amp;&amp;h&gt;l)&amp;&amp;(e&gt;=i&amp;&amp;e&lt;=j||f&gt;=i&amp;&amp;f&lt;=j||e&lt;i&amp;&amp;f&gt;j);<span class="keyword">default</span>:<span class="keyword">return</span>!<span class="number">1</span>}},a.ui.ddmanager={current:<span class="literal">null</span>,droppables:{<span class="string">"default"</span>:[]},prepareOffsets:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=a.ui.ddmanager.droppables[b.options.scope]||[],e=c?c.type:<span class="literal">null</span>,f=(b.currentItem||b.element).find(<span class="string">":data(droppable)"</span>).andSelf();g:<span class="keyword">for</span>(<span class="keyword">var</span> h=<span class="number">0</span>;h&lt;d.length;h++){<span class="keyword">if</span>(d[h].options.disabled||b&amp;&amp;!d[h].accept.call(d[h].element[<span class="number">0</span>],b.currentItem||b.element))<span class="keyword">continue</span>;<span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;f.length;i++)<span class="keyword">if</span>(f[i]==d[h].element[<span class="number">0</span>]){d[h].proportions.height=<span class="number">0</span>;<span class="keyword">continue</span> g}d[h].visible=d[h].element.css(<span class="string">"display"</span>)!=<span class="string">"none"</span>;<span class="keyword">if</span>(!d[h].visible)<span class="keyword">continue</span>;e==<span class="string">"mousedown"</span>&amp;&amp;d[h]._activate.call(d[h],c),d[h].offset=d[h].element.offset(),d[h].proportions={width:d[h].element[<span class="number">0</span>].offsetWidth,height:d[h].element[<span class="number">0</span>].offsetHeight}}},drop:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=!<span class="number">1</span>;<span class="keyword">return</span> a.each(a.ui.ddmanager.droppables[b.options.scope]||[],<span class="keyword">function</span>(){<span class="keyword">if</span>(!<span class="keyword">this</span>.options)<span class="keyword">return</span>;!<span class="keyword">this</span>.options.disabled&amp;&amp;<span class="keyword">this</span>.visible&amp;&amp;a.ui.intersect(b,<span class="keyword">this</span>,<span class="keyword">this</span>.options.tolerance)&amp;&amp;(d=<span class="keyword">this</span>._drop.call(<span class="keyword">this</span>,c)||d),!<span class="keyword">this</span>.options.disabled&amp;&amp;<span class="keyword">this</span>.visible&amp;&amp;<span class="keyword">this</span>.accept.call(<span class="keyword">this</span>.element[<span class="number">0</span>],b.currentItem||b.element)&amp;&amp;(<span class="keyword">this</span>.isout=<span class="number">1</span>,<span class="keyword">this</span>.isover=<span class="number">0</span>,<span class="keyword">this</span>._deactivate.call(<span class="keyword">this</span>,c))}),d},dragStart:<span class="keyword">function</span>(b,c){b.element.parents(<span class="string">":not(body,html)"</span>).bind(<span class="string">"scroll.droppable"</span>,<span class="keyword">function</span>(){b.options.refreshPositions||a.ui.ddmanager.prepareOffsets(b,c)})},drag:<span class="keyword">function</span>(b,c){b.options.refreshPositions&amp;&amp;a.ui.ddmanager.prepareOffsets(b,c),a.each(a.ui.ddmanager.droppables[b.options.scope]||[],<span class="keyword">function</span>(){<span class="keyword">if</span>(<span class="keyword">this</span>.options.disabled||<span class="keyword">this</span>.greedyChild||!<span class="keyword">this</span>.visible)<span class="keyword">return</span>;<span class="keyword">var</span> d=a.ui.intersect(b,<span class="keyword">this</span>,<span class="keyword">this</span>.options.tolerance),e=!d&amp;&amp;<span class="keyword">this</span>.isover==<span class="number">1</span>?<span class="string">"isout"</span>:d&amp;&amp;<span class="keyword">this</span>.isover==<span class="number">0</span>?<span class="string">"isover"</span>:<span class="literal">null</span>;<span class="keyword">if</span>(!e)<span class="keyword">return</span>;<span class="keyword">var</span> f;<span class="keyword">if</span>(<span class="keyword">this</span>.options.greedy){<span class="keyword">var</span> g=<span class="keyword">this</span>.element.parents(<span class="string">":data(droppable):eq(0)"</span>);g.length&amp;&amp;(f=a.data(g[<span class="number">0</span>],<span class="string">"droppable"</span>),f.greedyChild=e==<span class="string">"isover"</span>?<span class="number">1</span>:<span class="number">0</span>)}f&amp;&amp;e==<span class="string">"isover"</span>&amp;&amp;(f.isover=<span class="number">0</span>,f.isout=<span class="number">1</span>,f._out.call(f,c)),<span class="keyword">this</span>[e]=<span class="number">1</span>,<span class="keyword">this</span>[e==<span class="string">"isout"</span>?<span class="string">"isover"</span>:<span class="string">"isout"</span>]=<span class="number">0</span>,<span class="keyword">this</span>[e==<span class="string">"isover"</span>?<span class="string">"_over"</span>:<span class="string">"_out"</span>].call(<span class="keyword">this</span>,c),f&amp;&amp;e==<span class="string">"isout"</span>&amp;&amp;(f.isout=<span class="number">0</span>,f.isover=<span class="number">1</span>,f._over.call(f,c))})},dragStop:<span class="keyword">function</span>(b,c){b.element.parents(<span class="string">":not(body,html)"</span>).unbind(<span class="string">"scroll.droppable"</span>),b.options.refreshPositions||a.ui.ddmanager.prepareOffsets(b,c)}}}(jQuery),<span class="keyword">function</span>(a,b){a.widget(<span class="string">"ui.resizable"</span>,a.ui.mouse,{widgetEventPrefix:<span class="string">"resize"</span>,options:{alsoResize:!<span class="number">1</span>,animate:!<span class="number">1</span>,animateDuration:<span class="string">"slow"</span>,animateEasing:<span class="string">"swing"</span>,aspectRatio:!<span class="number">1</span>,autoHide:!<span class="number">1</span>,containment:!<span class="number">1</span>,ghost:!<span class="number">1</span>,grid:!<span class="number">1</span>,handles:<span class="string">"e,s,se"</span>,helper:!<span class="number">1</span>,maxHeight:<span class="literal">null</span>,maxWidth:<span class="literal">null</span>,minHeight:<span class="number">10</span>,minWidth:<span class="number">10</span>,zIndex:<span class="number">1e3</span>},_create:<span class="keyword">function</span>(){<span class="keyword">var</span> b=<span class="keyword">this</span>,c=<span class="keyword">this</span>.options;<span class="keyword">this</span>.element.addClass(<span class="string">"ui-resizable"</span>),a.extend(<span class="keyword">this</span>,{_aspectRatio:!!c.aspectRatio,aspectRatio:c.aspectRatio,originalElement:<span class="keyword">this</span>.element,_proportionallyResizeElements:[],_helper:c.helper||c.ghost||c.animate?c.helper||<span class="string">"ui-resizable-helper"</span>:<span class="literal">null</span>}),<span class="keyword">this</span>.element[<span class="number">0</span>].nodeName.match(<span class="regexp">/canvas|textarea|input|select|button|img/i</span>)&amp;&amp;(<span class="keyword">this</span>.element.wrap(a(<span class="string">'&lt;div class="ui-wrapper" style="overflow: hidden;"&gt;&lt;/div&gt;'</span>).css({position:<span class="keyword">this</span>.element.css(<span class="string">"position"</span>),width:<span class="keyword">this</span>.element.outerWidth(),height:<span class="keyword">this</span>.element.outerHeight(),top:<span class="keyword">this</span>.element.css(<span class="string">"top"</span>),left:<span class="keyword">this</span>.element.css(<span class="string">"left"</span>)})),<span class="keyword">this</span>.element=<span class="keyword">this</span>.element.parent().data(<span class="string">"resizable"</span>,<span class="keyword">this</span>.element.data(<span class="string">"resizable"</span>)),<span class="keyword">this</span>.elementIsWrapper=!<span class="number">0</span>,<span class="keyword">this</span>.element.css({marginLeft:<span class="keyword">this</span>.originalElement.css(<span class="string">"marginLeft"</span>),marginTop:<span class="keyword">this</span>.originalElement.css(<span class="string">"marginTop"</span>),marginRight:<span class="keyword">this</span>.originalElement.css(<span class="string">"marginRight"</span>),marginBottom:<span class="keyword">this</span>.originalElement.css(<span class="string">"marginBottom"</span>)}),<span class="keyword">this</span>.originalElement.css({marginLeft:<span class="number">0</span>,marginTop:<span class="number">0</span>,marginRight:<span class="number">0</span>,marginBottom:<span class="number">0</span>}),<span class="keyword">this</span>.originalResizeStyle=<span class="keyword">this</span>.originalElement.css(<span class="string">"resize"</span>),<span class="keyword">this</span>.originalElement.css(<span class="string">"resize"</span>,<span class="string">"none"</span>),<span class="keyword">this</span>._proportionallyResizeElements.push(<span class="keyword">this</span>.originalElement.css({position:<span class="string">"static"</span>,zoom:<span class="number">1</span>,display:<span class="string">"block"</span>})),<span class="keyword">this</span>.originalElement.css({margin:<span class="keyword">this</span>.originalElement.css(<span class="string">"margin"</span>)}),<span class="keyword">this</span>._proportionallyResize()),<span class="keyword">this</span>.handles=c.handles||(a(<span class="string">".ui-resizable-handle"</span>,<span class="keyword">this</span>.element).length?{n:<span class="string">".ui-resizable-n"</span>,e:<span class="string">".ui-resizable-e"</span>,s:<span class="string">".ui-resizable-s"</span>,w:<span class="string">".ui-resizable-w"</span>,se:<span class="string">".ui-resizable-se"</span>,sw:<span class="string">".ui-resizable-sw"</span>,ne:<span class="string">".ui-resizable-ne"</span>,nw:<span class="string">".ui-resizable-nw"</span>}:<span class="string">"e,s,se"</span>);<span class="keyword">if</span>(<span class="keyword">this</span>.handles.constructor==String){<span class="keyword">this</span>.handles==<span class="string">"all"</span>&amp;&amp;(<span class="keyword">this</span>.handles=<span class="string">"n,e,s,w,se,sw,ne,nw"</span>);<span class="keyword">var</span> d=<span class="keyword">this</span>.handles.split(<span class="string">","</span>);<span class="keyword">this</span>.handles={};<span class="keyword">for</span>(<span class="keyword">var</span> e=<span class="number">0</span>;e&lt;d.length;e++){<span class="keyword">var</span> f=a.trim(d[e]),g=<span class="string">"ui-resizable-"</span>+f,h=a(<span class="string">'&lt;div class="ui-resizable-handle '</span>+g+<span class="string">'"&gt;&lt;/div&gt;'</span>);h.css({zIndex:c.zIndex}),<span class="string">"se"</span>==f&amp;&amp;h.addClass(<span class="string">"ui-icon ui-icon-gripsmall-diagonal-se"</span>),<span class="keyword">this</span>.handles[f]=<span class="string">".ui-resizable-"</span>+f,<span class="keyword">this</span>.element.append(h)}}<span class="keyword">this</span>._renderAxis=<span class="keyword">function</span>(b){b=b||<span class="keyword">this</span>.element;<span class="keyword">for</span>(<span class="keyword">var</span> c <span class="keyword">in</span> <span class="keyword">this</span>.handles){<span class="keyword">this</span>.handles[c].constructor==String&amp;&amp;(<span class="keyword">this</span>.handles[c]=a(<span class="keyword">this</span>.handles[c],<span class="keyword">this</span>.element).show());<span class="keyword">if</span>(<span class="keyword">this</span>.elementIsWrapper&amp;&amp;<span class="keyword">this</span>.originalElement[<span class="number">0</span>].nodeName.match(<span class="regexp">/textarea|input|select|button/i</span>)){<span class="keyword">var</span> d=a(<span class="keyword">this</span>.handles[c],<span class="keyword">this</span>.element),e=<span class="number">0</span>;e=<span class="regexp">/sw|ne|nw|se|n|s/</span>.test(c)?d.outerHeight():d.outerWidth();<span class="keyword">var</span> f=[<span class="string">"padding"</span>,<span class="regexp">/ne|nw|n/</span>.test(c)?<span class="string">"Top"</span>:<span class="regexp">/se|sw|s/</span>.test(c)?<span class="string">"Bottom"</span>:<span class="regexp">/^e$/</span>.test(c)?<span class="string">"Right"</span>:<span class="string">"Left"</span>].join(<span class="string">""</span>);b.css(f,e),<span class="keyword">this</span>._proportionallyResize()}<span class="keyword">if</span>(!a(<span class="keyword">this</span>.handles[c]).length)<span class="keyword">continue</span>}},<span class="keyword">this</span>._renderAxis(<span class="keyword">this</span>.element),<span class="keyword">this</span>._handles=a(<span class="string">".ui-resizable-handle"</span>,<span class="keyword">this</span>.element).disableSelection(),<span class="keyword">this</span>._handles.mouseover(<span class="keyword">function</span>(){<span class="keyword">if</span>(!b.resizing){<span class="keyword">if</span>(<span class="keyword">this</span>.className)<span class="keyword">var</span> a=<span class="keyword">this</span>.className.match(<span class="regexp">/ui-resizable-(se|sw|ne|nw|n|e|s|w)/i</span>);b.axis=a&amp;&amp;a[<span class="number">1</span>]?a[<span class="number">1</span>]:<span class="string">"se"</span>}}),c.autoHide&amp;&amp;(<span class="keyword">this</span>._handles.hide(),a(<span class="keyword">this</span>.element).addClass(<span class="string">"ui-resizable-autohide"</span>).hover(<span class="keyword">function</span>(){<span class="keyword">if</span>(c.disabled)<span class="keyword">return</span>;a(<span class="keyword">this</span>).removeClass(<span class="string">"ui-resizable-autohide"</span>),b._handles.show()},<span class="keyword">function</span>(){<span class="keyword">if</span>(c.disabled)<span class="keyword">return</span>;b.resizing||(a(<span class="keyword">this</span>).addClass(<span class="string">"ui-resizable-autohide"</span>),b._handles.hide())})),<span class="keyword">this</span>._mouseInit()},destroy:<span class="keyword">function</span>(){<span class="keyword">this</span>._mouseDestroy();<span class="keyword">var</span> b=<span class="keyword">function</span>(b){a(b).removeClass(<span class="string">"ui-resizable ui-resizable-disabled ui-resizable-resizing"</span>).removeData(<span class="string">"resizable"</span>).unbind(<span class="string">".resizable"</span>).find(<span class="string">".ui-resizable-handle"</span>).remove()};<span class="keyword">if</span>(<span class="keyword">this</span>.elementIsWrapper){b(<span class="keyword">this</span>.element);<span class="keyword">var</span> c=<span class="keyword">this</span>.element;c.after(<span class="keyword">this</span>.originalElement.css({position:c.css(<span class="string">"position"</span>),width:c.outerWidth(),height:c.outerHeight(),top:c.css(<span class="string">"top"</span>),left:c.css(<span class="string">"left"</span>)})).remove()}<span class="keyword">return</span> <span class="keyword">this</span>.originalElement.css(<span class="string">"resize"</span>,<span class="keyword">this</span>.originalResizeStyle),b(<span class="keyword">this</span>.originalElement),<span class="keyword">this</span>},_mouseCapture:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=!<span class="number">1</span>;<span class="keyword">for</span>(<span class="keyword">var</span> d <span class="keyword">in</span> <span class="keyword">this</span>.handles)a(<span class="keyword">this</span>.handles[d])[<span class="number">0</span>]==b.target&amp;&amp;(c=!<span class="number">0</span>);<span class="keyword">return</span>!<span class="keyword">this</span>.options.disabled&amp;&amp;c},_mouseStart:<span class="keyword">function</span>(b){<span class="keyword">var</span> d=<span class="keyword">this</span>.options,e=<span class="keyword">this</span>.element.position(),f=<span class="keyword">this</span>.element;<span class="keyword">this</span>.resizing=!<span class="number">0</span>,<span class="keyword">this</span>.documentScroll={top:a(document).scrollTop(),left:a(document).scrollLeft()},(f.is(<span class="string">".ui-draggable"</span>)||<span class="regexp">/absolute/</span>.test(f.css(<span class="string">"position"</span>)))&amp;&amp;f.css({position:<span class="string">"absolute"</span>,top:e.top,left:e.left}),<span class="keyword">this</span>._renderProxy();<span class="keyword">var</span> g=c(<span class="keyword">this</span>.helper.css(<span class="string">"left"</span>)),h=c(<span class="keyword">this</span>.helper.css(<span class="string">"top"</span>));d.containment&amp;&amp;(g+=a(d.containment).scrollLeft()||<span class="number">0</span>,h+=a(d.containment).scrollTop()||<span class="number">0</span>),<span class="keyword">this</span>.offset=<span class="keyword">this</span>.helper.offset(),<span class="keyword">this</span>.position={left:g,top:h},<span class="keyword">this</span>.size=<span class="keyword">this</span>._helper?{width:f.outerWidth(),height:f.outerHeight()}:{width:f.width(),height:f.height()},<span class="keyword">this</span>.originalSize=<span class="keyword">this</span>._helper?{width:f.outerWidth(),height:f.outerHeight()}:{width:f.width(),height:f.height()},<span class="keyword">this</span>.originalPosition={left:g,top:h},<span class="keyword">this</span>.sizeDiff={width:f.outerWidth()-f.width(),height:f.outerHeight()-f.height()},<span class="keyword">this</span>.originalMousePosition={left:b.pageX,top:b.pageY},<span class="keyword">this</span>.aspectRatio=<span class="keyword">typeof</span> d.aspectRatio==<span class="string">"number"</span>?d.aspectRatio:<span class="keyword">this</span>.originalSize.width/<span class="keyword">this</span>.originalSize.height||<span class="number">1</span>;<span class="keyword">var</span> i=a(<span class="string">".ui-resizable-"</span>+<span class="keyword">this</span>.axis).css(<span class="string">"cursor"</span>);<span class="keyword">return</span> a(<span class="string">"body"</span>).css(<span class="string">"cursor"</span>,i==<span class="string">"auto"</span>?<span class="keyword">this</span>.axis+<span class="string">"-resize"</span>:i),f.addClass(<span class="string">"ui-resizable-resizing"</span>),<span class="keyword">this</span>._propagate(<span class="string">"start"</span>,b),!<span class="number">0</span>},_mouseDrag:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=<span class="keyword">this</span>.helper,d=<span class="keyword">this</span>.options,e={},f=<span class="keyword">this</span>,g=<span class="keyword">this</span>.originalMousePosition,h=<span class="keyword">this</span>.axis,i=b.pageX-g.left||<span class="number">0</span>,j=b.pageY-g.top||<span class="number">0</span>,k=<span class="keyword">this</span>._change[h];<span class="keyword">if</span>(!k)<span class="keyword">return</span>!<span class="number">1</span>;<span class="keyword">var</span> l=k.apply(<span class="keyword">this</span>,[b,i,j]),m=a.browser.msie&amp;&amp;a.browser.version&lt;<span class="number">7</span>,n=<span class="keyword">this</span>.sizeDiff;<span class="keyword">this</span>._updateVirtualBoundaries(b.shiftKey);<span class="keyword">if</span>(<span class="keyword">this</span>._aspectRatio||b.shiftKey)l=<span class="keyword">this</span>._updateRatio(l,b);<span class="keyword">return</span> l=<span class="keyword">this</span>._respectSize(l,b),<span class="keyword">this</span>._propagate(<span class="string">"resize"</span>,b),c.css({top:<span class="keyword">this</span>.position.top+<span class="string">"px"</span>,left:<span class="keyword">this</span>.position.left+<span class="string">"px"</span>,width:<span class="keyword">this</span>.size.width+<span class="string">"px"</span>,height:<span class="keyword">this</span>.size.height+<span class="string">"px"</span>}),!<span class="keyword">this</span>._helper&amp;&amp;<span class="keyword">this</span>._proportionallyResizeElements.length&amp;&amp;<span class="keyword">this</span>._proportionallyResize(),<span class="keyword">this</span>._updateCache(l),<span class="keyword">this</span>._trigger(<span class="string">"resize"</span>,b,<span class="keyword">this</span>.ui()),!<span class="number">1</span>},_mouseStop:<span class="keyword">function</span>(b){<span class="keyword">this</span>.resizing=!<span class="number">1</span>;<span class="keyword">var</span> c=<span class="keyword">this</span>.options,d=<span class="keyword">this</span>;<span class="keyword">if</span>(<span class="keyword">this</span>._helper){<span class="keyword">var</span> e=<span class="keyword">this</span>._proportionallyResizeElements,f=e.length&amp;&amp;<span class="regexp">/textarea/i</span>.test(e[<span class="number">0</span>].nodeName),g=f&amp;&amp;a.ui.hasScroll(e[<span class="number">0</span>],<span class="string">"left"</span>)?<span class="number">0</span>:d.sizeDiff.height,h=f?<span class="number">0</span>:d.sizeDiff.width,i={width:d.helper.width()-h,height:d.helper.height()-g},j=parseInt(d.element.css(<span class="string">"left"</span>),<span class="number">10</span>)+(d.position.left-d.originalPosition.left)||<span class="literal">null</span>,k=parseInt(d.element.css(<span class="string">"top"</span>),<span class="number">10</span>)+(d.position.top-d.originalPosition.top)||<span class="literal">null</span>;c.animate||<span class="keyword">this</span>.element.css(a.extend(i,{top:k,left:j})),d.helper.height(d.size.height),d.helper.width(d.size.width),<span class="keyword">this</span>._helper&amp;&amp;!c.animate&amp;&amp;<span class="keyword">this</span>._proportionallyResize()}<span class="keyword">return</span> a(<span class="string">"body"</span>).css(<span class="string">"cursor"</span>,<span class="string">"auto"</span>),<span class="keyword">this</span>.element.removeClass(<span class="string">"ui-resizable-resizing"</span>),<span class="keyword">this</span>._propagate(<span class="string">"stop"</span>,b),<span class="keyword">this</span>._helper&amp;&amp;<span class="keyword">this</span>.helper.remove(),!<span class="number">1</span>},_updateVirtualBoundaries:<span class="keyword">function</span>(a){<span class="keyword">var</span> b=<span class="keyword">this</span>.options,c,e,f,g,h;h={minWidth:d(b.minWidth)?b.minWidth:<span class="number">0</span>,maxWidth:d(b.maxWidth)?b.maxWidth:<span class="literal">Infinity</span>,minHeight:d(b.minHeight)?b.minHeight:<span class="number">0</span>,maxHeight:d(b.maxHeight)?b.maxHeight:<span class="literal">Infinity</span>};<span class="keyword">if</span>(<span class="keyword">this</span>._aspectRatio||a)c=h.minHeight*<span class="keyword">this</span>.aspectRatio,f=h.minWidth/<span class="keyword">this</span>.aspectRatio,e=h.maxHeight*<span class="keyword">this</span>.aspectRatio,g=h.maxWidth/<span class="keyword">this</span>.aspectRatio,c&gt;h.minWidth&amp;&amp;(h.minWidth=c),f&gt;h.minHeight&amp;&amp;(h.minHeight=f),e&lt;h.maxWidth&amp;&amp;(h.maxWidth=e),g&lt;h.maxHeight&amp;&amp;(h.maxHeight=g);<span class="keyword">this</span>._vBoundaries=h},_updateCache:<span class="keyword">function</span>(a){<span class="keyword">var</span> b=<span class="keyword">this</span>.options;<span class="keyword">this</span>.offset=<span class="keyword">this</span>.helper.offset(),d(a.left)&amp;&amp;(<span class="keyword">this</span>.position.left=a.left),d(a.top)&amp;&amp;(<span class="keyword">this</span>.position.top=a.top),d(a.height)&amp;&amp;(<span class="keyword">this</span>.size.height=a.height),d(a.width)&amp;&amp;(<span class="keyword">this</span>.size.width=a.width)},_updateRatio:<span class="keyword">function</span>(a,b){<span class="keyword">var</span> c=<span class="keyword">this</span>.options,e=<span class="keyword">this</span>.position,f=<span class="keyword">this</span>.size,g=<span class="keyword">this</span>.axis;<span class="keyword">return</span> d(a.height)?a.width=a.height*<span class="keyword">this</span>.aspectRatio:d(a.width)&amp;&amp;(a.height=a.width/<span class="keyword">this</span>.aspectRatio),g==<span class="string">"sw"</span>&amp;&amp;(a.left=e.left+(f.width-a.width),a.top=<span class="literal">null</span>),g==<span class="string">"nw"</span>&amp;&amp;(a.top=e.top+(f.height-a.height),a.left=e.left+(f.width-a.width)),a},_respectSize:<span class="keyword">function</span>(a,b){<span class="keyword">var</span> c=<span class="keyword">this</span>.helper,e=<span class="keyword">this</span>._vBoundaries,f=<span class="keyword">this</span>._aspectRatio||b.shiftKey,g=<span class="keyword">this</span>.axis,h=d(a.width)&amp;&amp;e.maxWidth&amp;&amp;e.maxWidth&lt;a.width,i=d(a.height)&amp;&amp;e.maxHeight&amp;&amp;e.maxHeight&lt;a.height,j=d(a.width)&amp;&amp;e.minWidth&amp;&amp;e.minWidth&gt;a.width,k=d(a.height)&amp;&amp;e.minHeight&amp;&amp;e.minHeight&gt;a.height;j&amp;&amp;(a.width=e.minWidth),k&amp;&amp;(a.height=e.minHeight),h&amp;&amp;(a.width=e.maxWidth),i&amp;&amp;(a.height=e.maxHeight);<span class="keyword">var</span> l=<span class="keyword">this</span>.originalPosition.left+<span class="keyword">this</span>.originalSize.width,m=<span class="keyword">this</span>.position.top+<span class="keyword">this</span>.size.height,n=<span class="regexp">/sw|nw|w/</span>.test(g),o=<span class="regexp">/nw|ne|n/</span>.test(g);j&amp;&amp;n&amp;&amp;(a.left=l-e.minWidth),h&amp;&amp;n&amp;&amp;(a.left=l-e.maxWidth),k&amp;&amp;o&amp;&amp;(a.top=m-e.minHeight),i&amp;&amp;o&amp;&amp;(a.top=m-e.maxHeight);<span class="keyword">var</span> p=!a.width&amp;&amp;!a.height;<span class="keyword">return</span> p&amp;&amp;!a.left&amp;&amp;a.top?a.top=<span class="literal">null</span>:p&amp;&amp;!a.top&amp;&amp;a.left&amp;&amp;(a.left=<span class="literal">null</span>),a},_proportionallyResize:<span class="keyword">function</span>(){<span class="keyword">var</span> b=<span class="keyword">this</span>.options;<span class="keyword">if</span>(!<span class="keyword">this</span>._proportionallyResizeElements.length)<span class="keyword">return</span>;<span class="keyword">var</span> c=<span class="keyword">this</span>.helper||<span class="keyword">this</span>.element;<span class="keyword">for</span>(<span class="keyword">var</span> d=<span class="number">0</span>;d&lt;<span class="keyword">this</span>._proportionallyResizeElements.length;d++){<span class="keyword">var</span> e=<span class="keyword">this</span>._proportionallyResizeElements[d];<span class="keyword">if</span>(!<span class="keyword">this</span>.borderDif){<span class="keyword">var</span> f=[e.css(<span class="string">"borderTopWidth"</span>),e.css(<span class="string">"borderRightWidth"</span>),e.css(<span class="string">"borderBottomWidth"</span>),e.css(<span class="string">"borderLeftWidth"</span>)],g=[e.css(<span class="string">"paddingTop"</span>),e.css(<span class="string">"paddingRight"</span>),e.css(<span class="string">"paddingBottom"</span>),e.css(<span class="string">"paddingLeft"</span>)];<span class="keyword">this</span>.borderDif=a.map(f,<span class="keyword">function</span>(a,b){<span class="keyword">var</span> c=parseInt(a,<span class="number">10</span>)||<span class="number">0</span>,d=parseInt(g[b],<span class="number">10</span>)||<span class="number">0</span>;<span class="keyword">return</span> c+d})}<span class="keyword">if</span>(!a.browser.msie||!a(c).is(<span class="string">":hidden"</span>)&amp;&amp;!a(c).parents(<span class="string">":hidden"</span>).length)e.css({height:c.height()-<span class="keyword">this</span>.borderDif[<span class="number">0</span>]-<span class="keyword">this</span>.borderDif[<span class="number">2</span>]||<span class="number">0</span>,width:c.width()-<span class="keyword">this</span>.borderDif[<span class="number">1</span>]-<span class="keyword">this</span>.borderDif[<span class="number">3</span>]||<span class="number">0</span>});<span class="keyword">else</span> <span class="keyword">continue</span>}},_renderProxy:<span class="keyword">function</span>(){<span class="keyword">var</span> b=<span class="keyword">this</span>.element,c=<span class="keyword">this</span>.options;<span class="keyword">this</span>.elementOffset=b.offset();<span class="keyword">if</span>(<span class="keyword">this</span>._helper){<span class="keyword">this</span>.helper=<span class="keyword">this</span>.helper||a(<span class="string">'&lt;div style="overflow:hidden;"&gt;&lt;/div&gt;'</span>);<span class="keyword">var</span> d=a.browser.msie&amp;&amp;a.browser.version&lt;<span class="number">7</span>,e=d?<span class="number">1</span>:<span class="number">0</span>,f=d?<span class="number">2</span>:-<span class="number">1</span>;<span class="keyword">this</span>.helper.addClass(<span class="keyword">this</span>._helper).css({width:<span class="keyword">this</span>.element.outerWidth()+f,height:<span class="keyword">this</span>.element.outerHeight()+f,position:<span class="string">"absolute"</span>,left:<span class="keyword">this</span>.elementOffset.left-e+<span class="string">"px"</span>,top:<span class="keyword">this</span>.elementOffset.top-e+<span class="string">"px"</span>,zIndex:++c.zIndex}),<span class="keyword">this</span>.helper.appendTo(<span class="string">"body"</span>).disableSelection()}<span class="keyword">else</span> <span class="keyword">this</span>.helper=<span class="keyword">this</span>.element},_change:{e:<span class="keyword">function</span>(a,b,c){<span class="keyword">return</span>{width:<span class="keyword">this</span>.originalSize.width+b}},w:<span class="keyword">function</span>(a,b,c){<span class="keyword">var</span> d=<span class="keyword">this</span>.options,e=<span class="keyword">this</span>.originalSize,f=<span class="keyword">this</span>.originalPosition;<span class="keyword">return</span>{left:f.left+b,width:e.width-b}},n:<span class="keyword">function</span>(a,b,c){<span class="keyword">var</span> d=<span class="keyword">this</span>.options,e=<span class="keyword">this</span>.originalSize,f=<span class="keyword">this</span>.originalPosition;<span class="keyword">return</span>{top:f.top+c,height:e.height-c}},s:<span class="keyword">function</span>(a,b,c){<span class="keyword">return</span>{height:<span class="keyword">this</span>.originalSize.height+c}},se:<span class="keyword">function</span>(b,c,d){<span class="keyword">return</span> a.extend(<span class="keyword">this</span>._change.s.apply(<span class="keyword">this</span>,arguments),<span class="keyword">this</span>._change.e.apply(<span class="keyword">this</span>,[b,c,d]))},sw:<span class="keyword">function</span>(b,c,d){<span class="keyword">return</span> a.extend(<span class="keyword">this</span>._change.s.apply(<span class="keyword">this</span>,arguments),<span class="keyword">this</span>._change.w.apply(<span class="keyword">this</span>,[b,c,d]))},ne:<span class="keyword">function</span>(b,c,d){<span class="keyword">return</span> a.extend(<span class="keyword">this</span>._change.n.apply(<span class="keyword">this</span>,arguments),<span class="keyword">this</span>._change.e.apply(<span class="keyword">this</span>,[b,c,d]))},nw:<span class="keyword">function</span>(b,c,d){<span class="keyword">return</span> a.extend(<span class="keyword">this</span>._change.n.apply(<span class="keyword">this</span>,arguments),<span class="keyword">this</span>._change.w.apply(<span class="keyword">this</span>,[b,c,d]))}},_propagate:<span class="keyword">function</span>(b,c){a.ui.plugin.call(<span class="keyword">this</span>,b,[c,<span class="keyword">this</span>.ui()]),b!=<span class="string">"resize"</span>&amp;&amp;<span class="keyword">this</span>._trigger(b,c,<span class="keyword">this</span>.ui())},plugins:{},ui:<span class="keyword">function</span>(){<span class="keyword">return</span>{originalElement:<span class="keyword">this</span>.originalElement,element:<span class="keyword">this</span>.element,helper:<span class="keyword">this</span>.helper,position:<span class="keyword">this</span>.position,size:<span class="keyword">this</span>.size,originalSize:<span class="keyword">this</span>.originalSize,originalPosition:<span class="keyword">this</span>.originalPosition}}}),a.extend(a.ui.resizable,{version:<span class="string">"1.8.21"</span>}),a.ui.plugin.add(<span class="string">"resizable"</span>,<span class="string">"alsoResize"</span>,{start:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=a(<span class="keyword">this</span>).data(<span class="string">"resizable"</span>),e=d.options,f=<span class="keyword">function</span>(b){a(b).each(<span class="keyword">function</span>(){<span class="keyword">var</span> b=a(<span class="keyword">this</span>);b.data(<span class="string">"resizable-alsoresize"</span>,{width:parseInt(b.width(),<span class="number">10</span>),height:parseInt(b.height(),<span class="number">10</span>),left:parseInt(b.css(<span class="string">"left"</span>),<span class="number">10</span>),top:parseInt(b.css(<span class="string">"top"</span>),<span class="number">10</span>)})})};<span class="keyword">typeof</span> e.alsoResize==<span class="string">"object"</span>&amp;&amp;!e.alsoResize.parentNode?e.alsoResize.length?(e.alsoResize=e.alsoResize[<span class="number">0</span>],f(e.alsoResize)):a.each(e.alsoResize,<span class="keyword">function</span>(a){f(a)}):f(e.alsoResize)},resize:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=a(<span class="keyword">this</span>).data(<span class="string">"resizable"</span>),e=d.options,f=d.originalSize,g=d.originalPosition,h={height:d.size.height-f.height||<span class="number">0</span>,width:d.size.width-f.width||<span class="number">0</span>,top:d.position.top-g.top||<span class="number">0</span>,left:d.position.left-g.left||<span class="number">0</span>},i=<span class="keyword">function</span>(b,d){a(b).each(<span class="keyword">function</span>(){<span class="keyword">var</span> b=a(<span class="keyword">this</span>),e=a(<span class="keyword">this</span>).data(<span class="string">"resizable-alsoresize"</span>),f={},g=d&amp;&amp;d.length?d:b.parents(c.originalElement[<span class="number">0</span>]).length?[<span class="string">"width"</span>,<span class="string">"height"</span>]:[<span class="string">"width"</span>,<span class="string">"height"</span>,<span class="string">"top"</span>,<span class="string">"left"</span>];a.each(g,<span class="keyword">function</span>(a,b){<span class="keyword">var</span> c=(e[b]||<span class="number">0</span>)+(h[b]||<span class="number">0</span>);c&amp;&amp;c&gt;=<span class="number">0</span>&amp;&amp;(f[b]=c||<span class="literal">null</span>)}),b.css(f)})};<span class="keyword">typeof</span> e.alsoResize==<span class="string">"object"</span>&amp;&amp;!e.alsoResize.nodeType?a.each(e.alsoResize,<span class="keyword">function</span>(a,b){i(a,b)}):i(e.alsoResize)},stop:<span class="keyword">function</span>(b,c){a(<span class="keyword">this</span>).removeData(<span class="string">"resizable-alsoresize"</span>)}}),a.ui.plugin.add(<span class="string">"resizable"</span>,<span class="string">"animate"</span>,{stop:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=a(<span class="keyword">this</span>).data(<span class="string">"resizable"</span>),e=d.options,f=d._proportionallyResizeElements,g=f.length&amp;&amp;<span class="regexp">/textarea/i</span>.test(f[<span class="number">0</span>].nodeName),h=g&amp;&amp;a.ui.hasScroll(f[<span class="number">0</span>],<span class="string">"left"</span>)?<span class="number">0</span>:d.sizeDiff.height,i=g?<span class="number">0</span>:d.sizeDiff.width,j={width:d.size.width-i,height:d.size.height-h},k=parseInt(d.element.css(<span class="string">"left"</span>),<span class="number">10</span>)+(d.position.left-d.originalPosition.left)||<span class="literal">null</span>,l=parseInt(d.element.css(<span class="string">"top"</span>),<span class="number">10</span>)+(d.position.top-d.originalPosition.top)||<span class="literal">null</span>;d.element.animate(a.extend(j,l&amp;&amp;k?{top:l,left:k}:{}),{duration:e.animateDuration,easing:e.animateEasing,step:<span class="keyword">function</span>(){<span class="keyword">var</span> c={width:parseInt(d.element.css(<span class="string">"width"</span>),<span class="number">10</span>),height:parseInt(d.element.css(<span class="string">"height"</span>),<span class="number">10</span>),top:parseInt(d.element.css(<span class="string">"top"</span>),<span class="number">10</span>),left:parseInt(d.element.css(<span class="string">"left"</span>),<span class="number">10</span>)};f&amp;&amp;f.length&amp;&amp;a(f[<span class="number">0</span>]).css({width:c.width,height:c.height}),d._updateCache(c),d._propagate(<span class="string">"resize"</span>,b)}})}}),a.ui.plugin.add(<span class="string">"resizable"</span>,<span class="string">"containment"</span>,{start:<span class="keyword">function</span>(b,d){<span class="keyword">var</span> e=a(<span class="keyword">this</span>).data(<span class="string">"resizable"</span>),f=e.options,g=e.element,h=f.containment,i=h <span class="keyword">instanceof</span> a?h.get(<span class="number">0</span>):<span class="regexp">/parent/</span>.test(h)?g.parent().get(<span class="number">0</span>):h;<span class="keyword">if</span>(!i)<span class="keyword">return</span>;e.containerElement=a(i);<span class="keyword">if</span>(<span class="regexp">/document/</span>.test(h)||h==document)e.containerOffset={left:<span class="number">0</span>,top:<span class="number">0</span>},e.containerPosition={left:<span class="number">0</span>,top:<span class="number">0</span>},e.parentData={element:a(document),left:<span class="number">0</span>,top:<span class="number">0</span>,width:a(document).width(),height:a(document).height()||document.body.parentNode.scrollHeight};<span class="keyword">else</span>{<span class="keyword">var</span> j=a(i),k=[];a([<span class="string">"Top"</span>,<span class="string">"Right"</span>,<span class="string">"Left"</span>,<span class="string">"Bottom"</span>]).each(<span class="keyword">function</span>(a,b){k[a]=c(j.css(<span class="string">"padding"</span>+b))}),e.containerOffset=j.offset(),e.containerPosition=j.position(),e.containerSize={height:j.innerHeight()-k[<span class="number">3</span>],width:j.innerWidth()-k[<span class="number">1</span>]};<span class="keyword">var</span> l=e.containerOffset,m=e.containerSize.height,n=e.containerSize.width,o=a.ui.hasScroll(i,<span class="string">"left"</span>)?i.scrollWidth:n,p=a.ui.hasScroll(i)?i.scrollHeight:m;e.parentData={element:i,left:l.left,top:l.top,width:o,height:p}}},resize:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=a(<span class="keyword">this</span>).data(<span class="string">"resizable"</span>),e=d.options,f=d.containerSize,g=d.containerOffset,h=d.size,i=d.position,j=d._aspectRatio||b.shiftKey,k={top:<span class="number">0</span>,left:<span class="number">0</span>},l=d.containerElement;l[<span class="number">0</span>]!=document&amp;&amp;<span class="regexp">/static/</span>.test(l.css(<span class="string">"position"</span>))&amp;&amp;(k=g),i.left&lt;(d._helper?g.left:<span class="number">0</span>)&amp;&amp;(d.size.width=d.size.width+(d._helper?d.position.left-g.left:d.position.left-k.left),j&amp;&amp;(d.size.height=d.size.width/d.aspectRatio),d.position.left=e.helper?g.left:<span class="number">0</span>),i.top&lt;(d._helper?g.top:<span class="number">0</span>)&amp;&amp;(d.size.height=d.size.height+(d._helper?d.position.top-g.top:d.position.top),j&amp;&amp;(d.size.width=d.size.height*d.aspectRatio),d.position.top=d._helper?g.top:<span class="number">0</span>),d.offset.left=d.parentData.left+d.position.left,d.offset.top=d.parentData.top+d.position.top;<span class="keyword">var</span> m=Math.abs((d._helper?d.offset.left-k.left:d.offset.left-k.left)+d.sizeDiff.width),n=Math.abs((d._helper?d.offset.top-k.top:d.offset.top-g.top)+d.sizeDiff.height),o=d.containerElement.get(<span class="number">0</span>)==d.element.parent().get(<span class="number">0</span>),p=<span class="regexp">/relative|absolute/</span>.test(d.containerElement.css(<span class="string">"position"</span>));o&amp;&amp;p&amp;&amp;(m-=d.parentData.left),m+d.size.width&gt;=d.parentData.width&amp;&amp;(d.size.width=d.parentData.width-m,j&amp;&amp;(d.size.height=d.size.width/d.aspectRatio)),n+d.size.height&gt;=d.parentData.height&amp;&amp;(d.size.height=d.parentData.height-n,j&amp;&amp;(d.size.width=d.size.height*d.aspectRatio))},stop:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=a(<span class="keyword">this</span>).data(<span class="string">"resizable"</span>),e=d.options,f=d.position,g=d.containerOffset,h=d.containerPosition,i=d.containerElement,j=a(d.helper),k=j.offset(),l=j.outerWidth()-d.sizeDiff.width,m=j.outerHeight()-d.sizeDiff.height;d._helper&amp;&amp;!e.animate&amp;&amp;<span class="regexp">/relative/</span>.test(i.css(<span class="string">"position"</span>))&amp;&amp;a(<span class="keyword">this</span>).css({left:k.left-h.left-g.left,width:l,height:m}),d._helper&amp;&amp;!e.animate&amp;&amp;<span class="regexp">/static/</span>.test(i.css(<span class="string">"position"</span>))&amp;&amp;a(<span class="keyword">this</span>).css({left:k.left-h.left-g.left,width:l,height:m})}}),a.ui.plugin.add(<span class="string">"resizable"</span>,<span class="string">"ghost"</span>,{start:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=a(<span class="keyword">this</span>).data(<span class="string">"resizable"</span>),e=d.options,f=d.size;d.ghost=d.originalElement.clone(),d.ghost.css({opacity:<span class="number">.25</span>,display:<span class="string">"block"</span>,position:<span class="string">"relative"</span>,height:f.height,width:f.width,margin:<span class="number">0</span>,left:<span class="number">0</span>,top:<span class="number">0</span>}).addClass(<span class="string">"ui-resizable-ghost"</span>).addClass(<span class="keyword">typeof</span> e.ghost==<span class="string">"string"</span>?e.ghost:<span class="string">""</span>),d.ghost.appendTo(d.helper)},resize:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=a(<span class="keyword">this</span>).data(<span class="string">"resizable"</span>),e=d.options;d.ghost&amp;&amp;d.ghost.css({position:<span class="string">"relative"</span>,height:d.size.height,width:d.size.width})},stop:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=a(<span class="keyword">this</span>).data(<span class="string">"resizable"</span>),e=d.options;d.ghost&amp;&amp;d.helper&amp;&amp;d.helper.get(<span class="number">0</span>).removeChild(d.ghost.get(<span class="number">0</span>))}}),a.ui.plugin.add(<span class="string">"resizable"</span>,<span class="string">"grid"</span>,{resize:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=a(<span class="keyword">this</span>).data(<span class="string">"resizable"</span>),e=d.options,f=d.size,g=d.originalSize,h=d.originalPosition,i=d.axis,j=e._aspectRatio||b.shiftKey;e.grid=<span class="keyword">typeof</span> e.grid==<span class="string">"number"</span>?[e.grid,e.grid]:e.grid;<span class="keyword">var</span> k=Math.round((f.width-g.width)/(e.grid[<span class="number">0</span>]||<span class="number">1</span>))*(e.grid[<span class="number">0</span>]||<span class="number">1</span>),l=Math.round((f.height-g.height)/(e.grid[<span class="number">1</span>]||<span class="number">1</span>))*(e.grid[<span class="number">1</span>]||<span class="number">1</span>);<span class="regexp">/^(se|s|e)$/</span>.test(i)?(d.size.width=g.width+k,d.size.height=g.height+l):<span class="regexp">/^(ne)$/</span>.test(i)?(d.size.width=g.width+k,d.size.height=g.height+l,d.position.top=h.top-l):<span class="regexp">/^(sw)$/</span>.test(i)?(d.size.width=g.width+k,d.size.height=g.height+l,d.position.left=h.left-k):(d.size.width=g.width+k,d.size.height=g.height+l,d.position.top=h.top-l,d.position.left=h.left-k)}});<span class="keyword">var</span> c=<span class="keyword">function</span>(a){<span class="keyword">return</span> parseInt(a,<span class="number">10</span>)||<span class="number">0</span>},d=<span class="keyword">function</span>(a){<span class="keyword">return</span>!isNaN(parseInt(a,<span class="number">10</span>))}}(jQuery),<span class="keyword">function</span>(a,b){a.widget(<span class="string">"ui.selectable"</span>,a.ui.mouse,{options:{appendTo:<span class="string">"body"</span>,autoRefresh:!<span class="number">0</span>,distance:<span class="number">0</span>,filter:<span class="string">"*"</span>,tolerance:<span class="string">"touch"</span>},_create:<span class="keyword">function</span>(){<span class="keyword">var</span> b=<span class="keyword">this</span>;<span class="keyword">this</span>.element.addClass(<span class="string">"ui-selectable"</span>),<span class="keyword">this</span>.dragged=!<span class="number">1</span>;<span class="keyword">var</span> c;<span class="keyword">this</span>.refresh=<span class="keyword">function</span>(){c=a(b.options.filter,b.element[<span class="number">0</span>]),c.addClass(<span class="string">"ui-selectee"</span>),c.each(<span class="keyword">function</span>(){<span class="keyword">var</span> b=a(<span class="keyword">this</span>),c=b.offset();a.data(<span class="keyword">this</span>,<span class="string">"selectable-item"</span>,{element:<span class="keyword">this</span>,$element:b,left:c.left,top:c.top,right:c.left+b.outerWidth(),bottom:c.top+b.outerHeight(),startselected:!<span class="number">1</span>,selected:b.hasClass(<span class="string">"ui-selected"</span>),selecting:b.hasClass(<span class="string">"ui-selecting"</span>),unselecting:b.hasClass(<span class="string">"ui-unselecting"</span>)})})},<span class="keyword">this</span>.refresh(),<span class="keyword">this</span>.selectees=c.addClass(<span class="string">"ui-selectee"</span>),<span class="keyword">this</span>._mouseInit(),<span class="keyword">this</span>.helper=a(<span class="string">"&lt;div class='ui-selectable-helper'&gt;&lt;/div&gt;"</span>)},destroy:<span class="keyword">function</span>(){<span class="keyword">return</span> <span class="keyword">this</span>.selectees.removeClass(<span class="string">"ui-selectee"</span>).removeData(<span class="string">"selectable-item"</span>),<span class="keyword">this</span>.element.removeClass(<span class="string">"ui-selectable ui-selectable-disabled"</span>).removeData(<span class="string">"selectable"</span>).unbind(<span class="string">".selectable"</span>),<span class="keyword">this</span>._mouseDestroy(),<span class="keyword">this</span>},_mouseStart:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=<span class="keyword">this</span>;<span class="keyword">this</span>.opos=[b.pageX,b.pageY];<span class="keyword">if</span>(<span class="keyword">this</span>.options.disabled)<span class="keyword">return</span>;<span class="keyword">var</span> d=<span class="keyword">this</span>.options;<span class="keyword">this</span>.selectees=a(d.filter,<span class="keyword">this</span>.element[<span class="number">0</span>]),<span class="keyword">this</span>._trigger(<span class="string">"start"</span>,b),a(d.appendTo).append(<span class="keyword">this</span>.helper),<span class="keyword">this</span>.helper.css({left:b.clientX,top:b.clientY,width:<span class="number">0</span>,height:<span class="number">0</span>}),d.autoRefresh&amp;&amp;<span class="keyword">this</span>.refresh(),<span class="keyword">this</span>.selectees.filter(<span class="string">".ui-selected"</span>).each(<span class="keyword">function</span>(){<span class="keyword">var</span> d=a.data(<span class="keyword">this</span>,<span class="string">"selectable-item"</span>);d.startselected=!<span class="number">0</span>,!b.metaKey&amp;&amp;!b.ctrlKey&amp;&amp;(d.$element.removeClass(<span class="string">"ui-selected"</span>),d.selected=!<span class="number">1</span>,d.$element.addClass(<span class="string">"ui-unselecting"</span>),d.unselecting=!<span class="number">0</span>,c._trigger(<span class="string">"unselecting"</span>,b,{unselecting:d.element}))}),a(b.target).parents().andSelf().each(<span class="keyword">function</span>(){<span class="keyword">var</span> d=a.data(<span class="keyword">this</span>,<span class="string">"selectable-item"</span>);<span class="keyword">if</span>(d){<span class="keyword">var</span> e=!b.metaKey&amp;&amp;!b.ctrlKey||!d.$element.hasClass(<span class="string">"ui-selected"</span>);<span class="keyword">return</span> d.$element.removeClass(e?<span class="string">"ui-unselecting"</span>:<span class="string">"ui-selected"</span>).addClass(e?<span class="string">"ui-selecting"</span>:<span class="string">"ui-unselecting"</span>),d.unselecting=!e,d.selecting=e,d.selected=e,e?c._trigger(<span class="string">"selecting"</span>,b,{selecting:d.element}):c._trigger(<span class="string">"unselecting"</span>,b,{unselecting:d.element}),!<span class="number">1</span>}})},_mouseDrag:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=<span class="keyword">this</span>;<span class="keyword">this</span>.dragged=!<span class="number">0</span>;<span class="keyword">if</span>(<span class="keyword">this</span>.options.disabled)<span class="keyword">return</span>;<span class="keyword">var</span> d=<span class="keyword">this</span>.options,e=<span class="keyword">this</span>.opos[<span class="number">0</span>],f=<span class="keyword">this</span>.opos[<span class="number">1</span>],g=b.pageX,h=b.pageY;<span class="keyword">if</span>(e&gt;g){<span class="keyword">var</span> i=g;g=e,e=i}<span class="keyword">if</span>(f&gt;h){<span class="keyword">var</span> i=h;h=f,f=i}<span class="keyword">return</span> <span class="keyword">this</span>.helper.css({left:e,top:f,width:g-e,height:h-f}),<span class="keyword">this</span>.selectees.each(<span class="keyword">function</span>(){<span class="keyword">var</span> i=a.data(<span class="keyword">this</span>,<span class="string">"selectable-item"</span>);<span class="keyword">if</span>(!i||i.element==c.element[<span class="number">0</span>])<span class="keyword">return</span>;<span class="keyword">var</span> j=!<span class="number">1</span>;d.tolerance==<span class="string">"touch"</span>?j=!(i.left&gt;g||i.right&lt;e||i.top&gt;h||i.bottom&lt;f):d.tolerance==<span class="string">"fit"</span>&amp;&amp;(j=i.left&gt;e&amp;&amp;i.right&lt;g&amp;&amp;i.top&gt;f&amp;&amp;i.bottom&lt;h),j?(i.selected&amp;&amp;(i.$element.removeClass(<span class="string">"ui-selected"</span>),i.selected=!<span class="number">1</span>),i.unselecting&amp;&amp;(i.$element.removeClass(<span class="string">"ui-unselecting"</span>),i.unselecting=!<span class="number">1</span>),i.selecting||(i.$element.addClass(<span class="string">"ui-selecting"</span>),i.selecting=!<span class="number">0</span>,c._trigger(<span class="string">"selecting"</span>,b,{selecting:i.element}))):(i.selecting&amp;&amp;((b.metaKey||b.ctrlKey)&amp;&amp;i.startselected?(i.$element.removeClass(<span class="string">"ui-selecting"</span>),i.selecting=!<span class="number">1</span>,i.$element.addClass(<span class="string">"ui-selected"</span>),i.selected=!<span class="number">0</span>):(i.$element.removeClass(<span class="string">"ui-selecting"</span>),i.selecting=!<span class="number">1</span>,i.startselected&amp;&amp;(i.$element.addClass(<span class="string">"ui-unselecting"</span>),i.unselecting=!<span class="number">0</span>),c._trigger(<span class="string">"unselecting"</span>,b,{unselecting:i.element}))),i.selected&amp;&amp;!b.metaKey&amp;&amp;!b.ctrlKey&amp;&amp;!i.startselected&amp;&amp;(i.$element.removeClass(<span class="string">"ui-selected"</span>),i.selected=!<span class="number">1</span>,i.$element.addClass(<span class="string">"ui-unselecting"</span>),i.unselecting=!<span class="number">0</span>,c._trigger(<span class="string">"unselecting"</span>,b,{unselecting:i.element})))}),!<span class="number">1</span>},_mouseStop:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=<span class="keyword">this</span>;<span class="keyword">this</span>.dragged=!<span class="number">1</span>;<span class="keyword">var</span> d=<span class="keyword">this</span>.options;<span class="keyword">return</span> a(<span class="string">".ui-unselecting"</span>,<span class="keyword">this</span>.element[<span class="number">0</span>]).each(<span class="keyword">function</span>(){<span class="keyword">var</span> d=a.data(<span class="keyword">this</span>,<span class="string">"selectable-item"</span>);d.$element.removeClass(<span class="string">"ui-unselecting"</span>),d.unselecting=!<span class="number">1</span>,d.startselected=!<span class="number">1</span>,c._trigger(<span class="string">"unselected"</span>,b,{unselected:d.element})}),a(<span class="string">".ui-selecting"</span>,<span class="keyword">this</span>.element[<span class="number">0</span>]).each(<span class="keyword">function</span>(){<span class="keyword">var</span> d=a.data(<span class="keyword">this</span>,<span class="string">"selectable-item"</span>);d.$element.removeClass(<span class="string">"ui-selecting"</span>).addClass(<span class="string">"ui-selected"</span>),d.selecting=!<span class="number">1</span>,d.selected=!<span class="number">0</span>,d.startselected=!<span class="number">0</span>,c._trigger(<span class="string">"selected"</span>,b,{selected:d.element})}),<span class="keyword">this</span>._trigger(<span class="string">"stop"</span>,b),<span class="keyword">this</span>.helper.remove(),!<span class="number">1</span>}}),a.extend(a.ui.selectable,{version:<span class="string">"1.8.21"</span>})}(jQuery),<span class="keyword">function</span>(a,b){a.widget(<span class="string">"ui.sortable"</span>,a.ui.mouse,{widgetEventPrefix:<span class="string">"sort"</span>,ready:!<span class="number">1</span>,options:{appendTo:<span class="string">"parent"</span>,axis:!<span class="number">1</span>,connectWith:!<span class="number">1</span>,containment:!<span class="number">1</span>,cursor:<span class="string">"auto"</span>,cursorAt:!<span class="number">1</span>,dropOnEmpty:!<span class="number">0</span>,forcePlaceholderSize:!<span class="number">1</span>,forceHelperSize:!<span class="number">1</span>,grid:!<span class="number">1</span>,handle:!<span class="number">1</span>,helper:<span class="string">"original"</span>,items:<span class="string">"&gt; *"</span>,opacity:!<span class="number">1</span>,placeholder:!<span class="number">1</span>,revert:!<span class="number">1</span>,scroll:!<span class="number">0</span>,scrollSensitivity:<span class="number">20</span>,scrollSpeed:<span class="number">20</span>,scope:<span class="string">"default"</span>,tolerance:<span class="string">"intersect"</span>,zIndex:<span class="number">1e3</span>},_create:<span class="keyword">function</span>(){<span class="keyword">var</span> a=<span class="keyword">this</span>.options;<span class="keyword">this</span>.containerCache={},<span class="keyword">this</span>.element.addClass(<span class="string">"ui-sortable"</span>),<span class="keyword">this</span>.refresh(),<span class="keyword">this</span>.floating=<span class="keyword">this</span>.items.length?a.axis===<span class="string">"x"</span>||<span class="regexp">/left|right/</span>.test(<span class="keyword">this</span>.items[<span class="number">0</span>].item.css(<span class="string">"float"</span>))||<span class="regexp">/inline|table-cell/</span>.test(<span class="keyword">this</span>.items[<span class="number">0</span>].item.css(<span class="string">"display"</span>)):!<span class="number">1</span>,<span class="keyword">this</span>.offset=<span class="keyword">this</span>.element.offset(),<span class="keyword">this</span>._mouseInit(),<span class="keyword">this</span>.ready=!<span class="number">0</span>},destroy:<span class="keyword">function</span>(){a.Widget.prototype.destroy.call(<span class="keyword">this</span>),<span class="keyword">this</span>.element.removeClass(<span class="string">"ui-sortable ui-sortable-disabled"</span>),<span class="keyword">this</span>._mouseDestroy();<span class="keyword">for</span>(<span class="keyword">var</span> b=<span class="keyword">this</span>.items.length-<span class="number">1</span>;b&gt;=<span class="number">0</span>;b--)<span class="keyword">this</span>.items[b].item.removeData(<span class="keyword">this</span>.widgetName+<span class="string">"-item"</span>);<span class="keyword">return</span> <span class="keyword">this</span>},_setOption:<span class="keyword">function</span>(b,c){b===<span class="string">"disabled"</span>?(<span class="keyword">this</span>.options[b]=c,<span class="keyword">this</span>.widget()[c?<span class="string">"addClass"</span>:<span class="string">"removeClass"</span>](<span class="string">"ui-sortable-disabled"</span>)):a.Widget.prototype._setOption.apply(<span class="keyword">this</span>,arguments)},_mouseCapture:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=<span class="keyword">this</span>;<span class="keyword">if</span>(<span class="keyword">this</span>.reverting)<span class="keyword">return</span>!<span class="number">1</span>;<span class="keyword">if</span>(<span class="keyword">this</span>.options.disabled||<span class="keyword">this</span>.options.type==<span class="string">"static"</span>)<span class="keyword">return</span>!<span class="number">1</span>;<span class="keyword">this</span>._refreshItems(b);<span class="keyword">var</span> e=<span class="literal">null</span>,f=<span class="keyword">this</span>,g=a(b.target).parents().each(<span class="keyword">function</span>(){<span class="keyword">if</span>(a.data(<span class="keyword">this</span>,d.widgetName+<span class="string">"-item"</span>)==f)<span class="keyword">return</span> e=a(<span class="keyword">this</span>),!<span class="number">1</span>});a.data(b.target,d.widgetName+<span class="string">"-item"</span>)==f&amp;&amp;(e=a(b.target));<span class="keyword">if</span>(!e)<span class="keyword">return</span>!<span class="number">1</span>;<span class="keyword">if</span>(<span class="keyword">this</span>.options.handle&amp;&amp;!c){<span class="keyword">var</span> h=!<span class="number">1</span>;a(<span class="keyword">this</span>.options.handle,e).find(<span class="string">"*"</span>).andSelf().each(<span class="keyword">function</span>(){<span class="keyword">this</span>==b.target&amp;&amp;(h=!<span class="number">0</span>)});<span class="keyword">if</span>(!h)<span class="keyword">return</span>!<span class="number">1</span>}<span class="keyword">return</span> <span class="keyword">this</span>.currentItem=e,<span class="keyword">this</span>._removeCurrentsFromItems(),!<span class="number">0</span>},_mouseStart:<span class="keyword">function</span>(b,c,d){<span class="keyword">var</span> e=<span class="keyword">this</span>.options,f=<span class="keyword">this</span>;<span class="keyword">this</span>.currentContainer=<span class="keyword">this</span>,<span class="keyword">this</span>.refreshPositions(),<span class="keyword">this</span>.helper=<span class="keyword">this</span>._createHelper(b),<span class="keyword">this</span>._cacheHelperProportions(),<span class="keyword">this</span>._cacheMargins(),<span class="keyword">this</span>.scrollParent=<span class="keyword">this</span>.helper.scrollParent(),<span class="keyword">this</span>.offset=<span class="keyword">this</span>.currentItem.offset(),<span class="keyword">this</span>.offset={top:<span class="keyword">this</span>.offset.top-<span class="keyword">this</span>.margins.top,left:<span class="keyword">this</span>.offset.left-<span class="keyword">this</span>.margins.left},a.extend(<span class="keyword">this</span>.offset,{click:{left:b.pageX-<span class="keyword">this</span>.offset.left,top:b.pageY-<span class="keyword">this</span>.offset.top},parent:<span class="keyword">this</span>._getParentOffset(),relative:<span class="keyword">this</span>._getRelativeOffset()}),<span class="keyword">this</span>.helper.css(<span class="string">"position"</span>,<span class="string">"absolute"</span>),<span class="keyword">this</span>.cssPosition=<span class="keyword">this</span>.helper.css(<span class="string">"position"</span>),<span class="keyword">this</span>.originalPosition=<span class="keyword">this</span>._generatePosition(b),<span class="keyword">this</span>.originalPageX=b.pageX,<span class="keyword">this</span>.originalPageY=b.pageY,e.cursorAt&amp;&amp;<span class="keyword">this</span>._adjustOffsetFromHelper(e.cursorAt),<span class="keyword">this</span>.domPosition={prev:<span class="keyword">this</span>.currentItem.prev()[<span class="number">0</span>],parent:<span class="keyword">this</span>.currentItem.parent()[<span class="number">0</span>]},<span class="keyword">this</span>.helper[<span class="number">0</span>]!=<span class="keyword">this</span>.currentItem[<span class="number">0</span>]&amp;&amp;<span class="keyword">this</span>.currentItem.hide(),<span class="keyword">this</span>._createPlaceholder(),e.containment&amp;&amp;<span class="keyword">this</span>._setContainment(),e.cursor&amp;&amp;(a(<span class="string">"body"</span>).css(<span class="string">"cursor"</span>)&amp;&amp;(<span class="keyword">this</span>._storedCursor=a(<span class="string">"body"</span>).css(<span class="string">"cursor"</span>)),a(<span class="string">"body"</span>).css(<span class="string">"cursor"</span>,e.cursor)),e.opacity&amp;&amp;(<span class="keyword">this</span>.helper.css(<span class="string">"opacity"</span>)&amp;&amp;(<span class="keyword">this</span>._storedOpacity=<span class="keyword">this</span>.helper.css(<span class="string">"opacity"</span>)),<span class="keyword">this</span>.helper.css(<span class="string">"opacity"</span>,e.opacity)),e.zIndex&amp;&amp;(<span class="keyword">this</span>.helper.css(<span class="string">"zIndex"</span>)&amp;&amp;(<span class="keyword">this</span>._storedZIndex=<span class="keyword">this</span>.helper.css(<span class="string">"zIndex"</span>)),<span class="keyword">this</span>.helper.css(<span class="string">"zIndex"</span>,e.zIndex)),<span class="keyword">this</span>.scrollParent[<span class="number">0</span>]!=document&amp;&amp;<span class="keyword">this</span>.scrollParent[<span class="number">0</span>].tagName!=<span class="string">"HTML"</span>&amp;&amp;(<span class="keyword">this</span>.overflowOffset=<span class="keyword">this</span>.scrollParent.offset()),<span class="keyword">this</span>._trigger(<span class="string">"start"</span>,b,<span class="keyword">this</span>._uiHash()),<span class="keyword">this</span>._preserveHelperProportions||<span class="keyword">this</span>._cacheHelperProportions();<span class="keyword">if</span>(!d)<span class="keyword">for</span>(<span class="keyword">var</span> g=<span class="keyword">this</span>.containers.length-<span class="number">1</span>;g&gt;=<span class="number">0</span>;g--)<span class="keyword">this</span>.containers[g]._trigger(<span class="string">"activate"</span>,b,f._uiHash(<span class="keyword">this</span>));<span class="keyword">return</span> a.ui.ddmanager&amp;&amp;(a.ui.ddmanager.current=<span class="keyword">this</span>),a.ui.ddmanager&amp;&amp;!e.dropBehaviour&amp;&amp;a.ui.ddmanager.prepareOffsets(<span class="keyword">this</span>,b),<span class="keyword">this</span>.dragging=!<span class="number">0</span>,<span class="keyword">this</span>.helper.addClass(<span class="string">"ui-sortable-helper"</span>),<span class="keyword">this</span>._mouseDrag(b),!<span class="number">0</span>},_mouseDrag:<span class="keyword">function</span>(b){<span class="keyword">this</span>.position=<span class="keyword">this</span>._generatePosition(b),<span class="keyword">this</span>.positionAbs=<span class="keyword">this</span>._convertPositionTo(<span class="string">"absolute"</span>),<span class="keyword">this</span>.lastPositionAbs||(<span class="keyword">this</span>.lastPositionAbs=<span class="keyword">this</span>.positionAbs);<span class="keyword">if</span>(<span class="keyword">this</span>.options.scroll){<span class="keyword">var</span> c=<span class="keyword">this</span>.options,d=!<span class="number">1</span>;<span class="keyword">this</span>.scrollParent[<span class="number">0</span>]!=document&amp;&amp;<span class="keyword">this</span>.scrollParent[<span class="number">0</span>].tagName!=<span class="string">"HTML"</span>?(<span class="keyword">this</span>.overflowOffset.top+<span class="keyword">this</span>.scrollParent[<span class="number">0</span>].offsetHeight-b.pageY&lt;c.scrollSensitivity?<span class="keyword">this</span>.scrollParent[<span class="number">0</span>].scrollTop=d=<span class="keyword">this</span>.scrollParent[<span class="number">0</span>].scrollTop+c.scrollSpeed:b.pageY-<span class="keyword">this</span>.overflowOffset.top&lt;c.scrollSensitivity&amp;&amp;(<span class="keyword">this</span>.scrollParent[<span class="number">0</span>].scrollTop=d=<span class="keyword">this</span>.scrollParent[<span class="number">0</span>].scrollTop-c.scrollSpeed),<span class="keyword">this</span>.overflowOffset.left+<span class="keyword">this</span>.scrollParent[<span class="number">0</span>].offsetWidth-b.pageX&lt;c.scrollSensitivity?<span class="keyword">this</span>.scrollParent[<span class="number">0</span>].scrollLeft=d=<span class="keyword">this</span>.scrollParent[<span class="number">0</span>].scrollLeft+c.scrollSpeed:b.pageX-<span class="keyword">this</span>.overflowOffset.left&lt;c.scrollSensitivity&amp;&amp;(<span class="keyword">this</span>.scrollParent[<span class="number">0</span>].scrollLeft=d=<span class="keyword">this</span>.scrollParent[<span class="number">0</span>].scrollLeft-c.scrollSpeed)):(b.pageY-a(document).scrollTop()&lt;c.scrollSensitivity?d=a(document).scrollTop(a(document).scrollTop()-c.scrollSpeed):a(window).height()-(b.pageY-a(document).scrollTop())&lt;c.scrollSensitivity&amp;&amp;(d=a(document).scrollTop(a(document).scrollTop()+c.scrollSpeed)),b.pageX-a(document).scrollLeft()&lt;c.scrollSensitivity?d=a(document).scrollLeft(a(document).scrollLeft()-c.scrollSpeed):a(window).width()-(b.pageX-a(document).scrollLeft())&lt;c.scrollSensitivity&amp;&amp;(d=a(document).scrollLeft(a(document).scrollLeft()+c.scrollSpeed))),d!==!<span class="number">1</span>&amp;&amp;a.ui.ddmanager&amp;&amp;!c.dropBehaviour&amp;&amp;a.ui.ddmanager.prepareOffsets(<span class="keyword">this</span>,b)}<span class="keyword">this</span>.positionAbs=<span class="keyword">this</span>._convertPositionTo(<span class="string">"absolute"</span>);<span class="keyword">if</span>(!<span class="keyword">this</span>.options.axis||<span class="keyword">this</span>.options.axis!=<span class="string">"y"</span>)<span class="keyword">this</span>.helper[<span class="number">0</span>].style.left=<span class="keyword">this</span>.position.left+<span class="string">"px"</span>;<span class="keyword">if</span>(!<span class="keyword">this</span>.options.axis||<span class="keyword">this</span>.options.axis!=<span class="string">"x"</span>)<span class="keyword">this</span>.helper[<span class="number">0</span>].style.top=<span class="keyword">this</span>.position.top+<span class="string">"px"</span>;<span class="keyword">for</span>(<span class="keyword">var</span> e=<span class="keyword">this</span>.items.length-<span class="number">1</span>;e&gt;=<span class="number">0</span>;e--){<span class="keyword">var</span> f=<span class="keyword">this</span>.items[e],g=f.item[<span class="number">0</span>],h=<span class="keyword">this</span>._intersectsWithPointer(f);<span class="keyword">if</span>(!h)<span class="keyword">continue</span>;<span class="keyword">if</span>(g!=<span class="keyword">this</span>.currentItem[<span class="number">0</span>]&amp;&amp;<span class="keyword">this</span>.placeholder[h==<span class="number">1</span>?<span class="string">"next"</span>:<span class="string">"prev"</span>]()[<span class="number">0</span>]!=g&amp;&amp;!a.ui.contains(<span class="keyword">this</span>.placeholder[<span class="number">0</span>],g)&amp;&amp;(<span class="keyword">this</span>.options.type==<span class="string">"semi-dynamic"</span>?!a.ui.contains(<span class="keyword">this</span>.element[<span class="number">0</span>],g):!<span class="number">0</span>)){<span class="keyword">this</span>.direction=h==<span class="number">1</span>?<span class="string">"down"</span>:<span class="string">"up"</span>;<span class="keyword">if</span>(<span class="keyword">this</span>.options.tolerance==<span class="string">"pointer"</span>||<span class="keyword">this</span>._intersectsWithSides(f))<span class="keyword">this</span>._rearrange(b,f);<span class="keyword">else</span> <span class="keyword">break</span>;<span class="keyword">this</span>._trigger(<span class="string">"change"</span>,b,<span class="keyword">this</span>._uiHash());<span class="keyword">break</span>}}<span class="keyword">return</span> <span class="keyword">this</span>._contactContainers(b),a.ui.ddmanager&amp;&amp;a.ui.ddmanager.drag(<span class="keyword">this</span>,b),<span class="keyword">this</span>._trigger(<span class="string">"sort"</span>,b,<span class="keyword">this</span>._uiHash()),<span class="keyword">this</span>.lastPositionAbs=<span class="keyword">this</span>.positionAbs,!<span class="number">1</span>},_mouseStop:<span class="keyword">function</span>(b,c){<span class="keyword">if</span>(!b)<span class="keyword">return</span>;a.ui.ddmanager&amp;&amp;!<span class="keyword">this</span>.options.dropBehaviour&amp;&amp;a.ui.ddmanager.drop(<span class="keyword">this</span>,b);<span class="keyword">if</span>(<span class="keyword">this</span>.options.revert){<span class="keyword">var</span> d=<span class="keyword">this</span>,e=d.placeholder.offset();d.reverting=!<span class="number">0</span>,a(<span class="keyword">this</span>.helper).animate({left:e.left-<span class="keyword">this</span>.offset.parent.left-d.margins.left+(<span class="keyword">this</span>.offsetParent[<span class="number">0</span>]==document.body?<span class="number">0</span>:<span class="keyword">this</span>.offsetParent[<span class="number">0</span>].scrollLeft),top:e.top-<span class="keyword">this</span>.offset.parent.top-d.margins.top+(<span class="keyword">this</span>.offsetParent[<span class="number">0</span>]==document.body?<span class="number">0</span>:<span class="keyword">this</span>.offsetParent[<span class="number">0</span>].scrollTop)},parseInt(<span class="keyword">this</span>.options.revert,<span class="number">10</span>)||<span class="number">500</span>,<span class="keyword">function</span>(){d._clear(b)})}<span class="keyword">else</span> <span class="keyword">this</span>._clear(b,c);<span class="keyword">return</span>!<span class="number">1</span>},cancel:<span class="keyword">function</span>(){<span class="keyword">var</span> b=<span class="keyword">this</span>;<span class="keyword">if</span>(<span class="keyword">this</span>.dragging){<span class="keyword">this</span>._mouseUp({target:<span class="literal">null</span>}),<span class="keyword">this</span>.options.helper==<span class="string">"original"</span>?<span class="keyword">this</span>.currentItem.css(<span class="keyword">this</span>._storedCSS).removeClass(<span class="string">"ui-sortable-helper"</span>):<span class="keyword">this</span>.currentItem.show();<span class="keyword">for</span>(<span class="keyword">var</span> c=<span class="keyword">this</span>.containers.length-<span class="number">1</span>;c&gt;=<span class="number">0</span>;c--)<span class="keyword">this</span>.containers[c]._trigger(<span class="string">"deactivate"</span>,<span class="literal">null</span>,b._uiHash(<span class="keyword">this</span>)),<span class="keyword">this</span>.containers[c].containerCache.over&amp;&amp;(<span class="keyword">this</span>.containers[c]._trigger(<span class="string">"out"</span>,<span class="literal">null</span>,b._uiHash(<span class="keyword">this</span>)),<span class="keyword">this</span>.containers[c].containerCache.over=<span class="number">0</span>)}<span class="keyword">return</span> <span class="keyword">this</span>.placeholder&amp;&amp;(<span class="keyword">this</span>.placeholder[<span class="number">0</span>].parentNode&amp;&amp;<span class="keyword">this</span>.placeholder[<span class="number">0</span>].parentNode.removeChild(<span class="keyword">this</span>.placeholder[<span class="number">0</span>]),<span class="keyword">this</span>.options.helper!=<span class="string">"original"</span>&amp;&amp;<span class="keyword">this</span>.helper&amp;&amp;<span class="keyword">this</span>.helper[<span class="number">0</span>].parentNode&amp;&amp;<span class="keyword">this</span>.helper.remove(),a.extend(<span class="keyword">this</span>,{helper:<span class="literal">null</span>,dragging:!<span class="number">1</span>,reverting:!<span class="number">1</span>,_noFinalSort:<span class="literal">null</span>}),<span class="keyword">this</span>.domPosition.prev?a(<span class="keyword">this</span>.domPosition.prev).after(<span class="keyword">this</span>.currentItem):a(<span class="keyword">this</span>.domPosition.parent).prepend(<span class="keyword">this</span>.currentItem)),<span class="keyword">this</span>},serialize:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=<span class="keyword">this</span>._getItemsAsjQuery(b&amp;&amp;b.connected),d=[];<span class="keyword">return</span> b=b||{},a(c).each(<span class="keyword">function</span>(){<span class="keyword">var</span> c=(a(b.item||<span class="keyword">this</span>).attr(b.attribute||<span class="string">"id"</span>)||<span class="string">""</span>).match(b.expression||<span class="regexp">/(.+)[-=_](.+)/</span>);c&amp;&amp;d.push((b.key||c[<span class="number">1</span>]+<span class="string">"[]"</span>)+<span class="string">"="</span>+(b.key&amp;&amp;b.expression?c[<span class="number">1</span>]:c[<span class="number">2</span>]))}),!d.length&amp;&amp;b.key&amp;&amp;d.push(b.key+<span class="string">"="</span>),d.join(<span class="string">"&amp;"</span>)},toArray:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=<span class="keyword">this</span>._getItemsAsjQuery(b&amp;&amp;b.connected),d=[];<span class="keyword">return</span> b=b||{},c.each(<span class="keyword">function</span>(){d.push(a(b.item||<span class="keyword">this</span>).attr(b.attribute||<span class="string">"id"</span>)||<span class="string">""</span>)}),d},_intersectsWith:<span class="keyword">function</span>(a){<span class="keyword">var</span> b=<span class="keyword">this</span>.positionAbs.left,c=b+<span class="keyword">this</span>.helperProportions.width,d=<span class="keyword">this</span>.positionAbs.top,e=d+<span class="keyword">this</span>.helperProportions.height,f=a.left,g=f+a.width,h=a.top,i=h+a.height,j=<span class="keyword">this</span>.offset.click.top,k=<span class="keyword">this</span>.offset.click.left,l=d+j&gt;h&amp;&amp;d+j&lt;i&amp;&amp;b+k&gt;f&amp;&amp;b+k&lt;g;<span class="keyword">return</span> <span class="keyword">this</span>.options.tolerance==<span class="string">"pointer"</span>||<span class="keyword">this</span>.options.forcePointerForContainers||<span class="keyword">this</span>.options.tolerance!=<span class="string">"pointer"</span>&amp;&amp;<span class="keyword">this</span>.helperProportions[<span class="keyword">this</span>.floating?<span class="string">"width"</span>:<span class="string">"height"</span>]&gt;a[<span class="keyword">this</span>.floating?<span class="string">"width"</span>:<span class="string">"height"</span>]?l:f&lt;b+<span class="keyword">this</span>.helperProportions.width/<span class="number">2</span>&amp;&amp;c-<span class="keyword">this</span>.helperProportions.width/<span class="number">2</span>&lt;g&amp;&amp;h&lt;d+<span class="keyword">this</span>.helperProportions.height/<span class="number">2</span>&amp;&amp;e-<span class="keyword">this</span>.helperProportions.height/<span class="number">2</span>&lt;i},_intersectsWithPointer:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=<span class="keyword">this</span>.options.axis===<span class="string">"x"</span>||a.ui.isOverAxis(<span class="keyword">this</span>.positionAbs.top+<span class="keyword">this</span>.offset.click.top,b.top,b.height),d=<span class="keyword">this</span>.options.axis===<span class="string">"y"</span>||a.ui.isOverAxis(<span class="keyword">this</span>.positionAbs.left+<span class="keyword">this</span>.offset.click.left,b.left,b.width),e=c&amp;&amp;d,f=<span class="keyword">this</span>._getDragVerticalDirection(),g=<span class="keyword">this</span>._getDragHorizontalDirection();<span class="keyword">return</span> e?<span class="keyword">this</span>.floating?g&amp;&amp;g==<span class="string">"right"</span>||f==<span class="string">"down"</span>?<span class="number">2</span>:<span class="number">1</span>:f&amp;&amp;(f==<span class="string">"down"</span>?<span class="number">2</span>:<span class="number">1</span>):!<span class="number">1</span>},_intersectsWithSides:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=a.ui.isOverAxis(<span class="keyword">this</span>.positionAbs.top+<span class="keyword">this</span>.offset.click.top,b.top+b.height/<span class="number">2</span>,b.height),d=a.ui.isOverAxis(<span class="keyword">this</span>.positionAbs.left+<span class="keyword">this</span>.offset.click.left,b.left+b.width/<span class="number">2</span>,b.width),e=<span class="keyword">this</span>._getDragVerticalDirection(),f=<span class="keyword">this</span>._getDragHorizontalDirection();<span class="keyword">return</span> <span class="keyword">this</span>.floating&amp;&amp;f?f==<span class="string">"right"</span>&amp;&amp;d||f==<span class="string">"left"</span>&amp;&amp;!d:e&amp;&amp;(e==<span class="string">"down"</span>&amp;&amp;c||e==<span class="string">"up"</span>&amp;&amp;!c)},_getDragVerticalDirection:<span class="keyword">function</span>(){<span class="keyword">var</span> a=<span class="keyword">this</span>.positionAbs.top-<span class="keyword">this</span>.lastPositionAbs.top;<span class="keyword">return</span> a!=<span class="number">0</span>&amp;&amp;(a&gt;<span class="number">0</span>?<span class="string">"down"</span>:<span class="string">"up"</span>)},_getDragHorizontalDirection:<span class="keyword">function</span>(){<span class="keyword">var</span> a=<span class="keyword">this</span>.positionAbs.left-<span class="keyword">this</span>.lastPositionAbs.left;<span class="keyword">return</span> a!=<span class="number">0</span>&amp;&amp;(a&gt;<span class="number">0</span>?<span class="string">"right"</span>:<span class="string">"left"</span>)},refresh:<span class="keyword">function</span>(a){<span class="keyword">return</span> <span class="keyword">this</span>._refreshItems(a),<span class="keyword">this</span>.refreshPositions(),<span class="keyword">this</span>},_connectWith:<span class="keyword">function</span>(){<span class="keyword">var</span> a=<span class="keyword">this</span>.options;<span class="keyword">return</span> a.connectWith.constructor==String?[a.connectWith]:a.connectWith},_getItemsAsjQuery:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=<span class="keyword">this</span>,d=[],e=[],f=<span class="keyword">this</span>._connectWith();<span class="keyword">if</span>(f&amp;&amp;b)<span class="keyword">for</span>(<span class="keyword">var</span> g=f.length-<span class="number">1</span>;g&gt;=<span class="number">0</span>;g--){<span class="keyword">var</span> h=a(f[g]);<span class="keyword">for</span>(<span class="keyword">var</span> i=h.length-<span class="number">1</span>;i&gt;=<span class="number">0</span>;i--){<span class="keyword">var</span> j=a.data(h[i],<span class="keyword">this</span>.widgetName);j&amp;&amp;j!=<span class="keyword">this</span>&amp;&amp;!j.options.disabled&amp;&amp;e.push([a.isFunction(j.options.items)?j.options.items.call(j.element):a(j.options.items,j.element).not(<span class="string">".ui-sortable-helper"</span>).not(<span class="string">".ui-sortable-placeholder"</span>),j])}}e.push([a.isFunction(<span class="keyword">this</span>.options.items)?<span class="keyword">this</span>.options.items.call(<span class="keyword">this</span>.element,<span class="literal">null</span>,{options:<span class="keyword">this</span>.options,item:<span class="keyword">this</span>.currentItem}):a(<span class="keyword">this</span>.options.items,<span class="keyword">this</span>.element).not(<span class="string">".ui-sortable-helper"</span>).not(<span class="string">".ui-sortable-placeholder"</span>),<span class="keyword">this</span>]);<span class="keyword">for</span>(<span class="keyword">var</span> g=e.length-<span class="number">1</span>;g&gt;=<span class="number">0</span>;g--)e[g][<span class="number">0</span>].each(<span class="keyword">function</span>(){d.push(<span class="keyword">this</span>)});<span class="keyword">return</span> a(d)},_removeCurrentsFromItems:<span class="keyword">function</span>(){<span class="keyword">var</span> a=<span class="keyword">this</span>.currentItem.find(<span class="string">":data("</span>+<span class="keyword">this</span>.widgetName+<span class="string">"-item)"</span>);<span class="keyword">for</span>(<span class="keyword">var</span> b=<span class="number">0</span>;b&lt;<span class="keyword">this</span>.items.length;b++)<span class="keyword">for</span>(<span class="keyword">var</span> c=<span class="number">0</span>;c&lt;a.length;c++)a[c]==<span class="keyword">this</span>.items[b].item[<span class="number">0</span>]&amp;&amp;<span class="keyword">this</span>.items.splice(b,<span class="number">1</span>)},_refreshItems:<span class="keyword">function</span>(b){<span class="keyword">this</span>.items=[],<span class="keyword">this</span>.containers=[<span class="keyword">this</span>];<span class="keyword">var</span> c=<span class="keyword">this</span>.items,d=<span class="keyword">this</span>,e=[[a.isFunction(<span class="keyword">this</span>.options.items)?<span class="keyword">this</span>.options.items.call(<span class="keyword">this</span>.element[<span class="number">0</span>],b,{item:<span class="keyword">this</span>.currentItem}):a(<span class="keyword">this</span>.options.items,<span class="keyword">this</span>.element),<span class="keyword">this</span>]],f=<span class="keyword">this</span>._connectWith();<span class="keyword">if</span>(f&amp;&amp;<span class="keyword">this</span>.ready)<span class="keyword">for</span>(<span class="keyword">var</span> g=f.length-<span class="number">1</span>;g&gt;=<span class="number">0</span>;g--){<span class="keyword">var</span> h=a(f[g]);<span class="keyword">for</span>(<span class="keyword">var</span> i=h.length-<span class="number">1</span>;i&gt;=<span class="number">0</span>;i--){<span class="keyword">var</span> j=a.data(h[i],<span class="keyword">this</span>.widgetName);j&amp;&amp;j!=<span class="keyword">this</span>&amp;&amp;!j.options.disabled&amp;&amp;(e.push([a.isFunction(j.options.items)?j.options.items.call(j.element[<span class="number">0</span>],b,{item:<span class="keyword">this</span>.currentItem}):a(j.options.items,j.element),j]),<span class="keyword">this</span>.containers.push(j))}}<span class="keyword">for</span>(<span class="keyword">var</span> g=e.length-<span class="number">1</span>;g&gt;=<span class="number">0</span>;g--){<span class="keyword">var</span> k=e[g][<span class="number">1</span>],l=e[g][<span class="number">0</span>];<span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>,m=l.length;i&lt;m;i++){<span class="keyword">var</span> n=a(l[i]);n.data(<span class="keyword">this</span>.widgetName+<span class="string">"-item"</span>,k),c.push({item:n,instance:k,width:<span class="number">0</span>,height:<span class="number">0</span>,left:<span class="number">0</span>,top:<span class="number">0</span>})}}},refreshPositions:<span class="keyword">function</span>(b){<span class="keyword">this</span>.offsetParent&amp;&amp;<span class="keyword">this</span>.helper&amp;&amp;(<span class="keyword">this</span>.offset.parent=<span class="keyword">this</span>._getParentOffset());<span class="keyword">for</span>(<span class="keyword">var</span> c=<span class="keyword">this</span>.items.length-<span class="number">1</span>;c&gt;=<span class="number">0</span>;c--){<span class="keyword">var</span> d=<span class="keyword">this</span>.items[c];<span class="keyword">if</span>(d.instance!=<span class="keyword">this</span>.currentContainer&amp;&amp;<span class="keyword">this</span>.currentContainer&amp;&amp;d.item[<span class="number">0</span>]!=<span class="keyword">this</span>.currentItem[<span class="number">0</span>])<span class="keyword">continue</span>;<span class="keyword">var</span> e=<span class="keyword">this</span>.options.toleranceElement?a(<span class="keyword">this</span>.options.toleranceElement,d.item):d.item;b||(d.width=e.outerWidth(),d.height=e.outerHeight());<span class="keyword">var</span> f=e.offset();d.left=f.left,d.top=f.top}<span class="keyword">if</span>(<span class="keyword">this</span>.options.custom&amp;&amp;<span class="keyword">this</span>.options.custom.refreshContainers)<span class="keyword">this</span>.options.custom.refreshContainers.call(<span class="keyword">this</span>);<span class="keyword">else</span> <span class="keyword">for</span>(<span class="keyword">var</span> c=<span class="keyword">this</span>.containers.length-<span class="number">1</span>;c&gt;=<span class="number">0</span>;c--){<span class="keyword">var</span> f=<span class="keyword">this</span>.containers[c].element.offset();<span class="keyword">this</span>.containers[c].containerCache.left=f.left,<span class="keyword">this</span>.containers[c].containerCache.top=f.top,<span class="keyword">this</span>.containers[c].containerCache.width=<span class="keyword">this</span>.containers[c].element.outerWidth(),<span class="keyword">this</span>.containers[c].containerCache.height=<span class="keyword">this</span>.containers[c].element.outerHeight()}<span class="keyword">return</span> <span class="keyword">this</span>},_createPlaceholder:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=b||<span class="keyword">this</span>,d=c.options;<span class="keyword">if</span>(!d.placeholder||d.placeholder.constructor==String){<span class="keyword">var</span> e=d.placeholder;d.placeholder={element:<span class="keyword">function</span>(){<span class="keyword">var</span> b=a(document.createElement(c.currentItem[<span class="number">0</span>].nodeName)).addClass(e||c.currentItem[<span class="number">0</span>].className+<span class="string">" ui-sortable-placeholder"</span>).removeClass(<span class="string">"ui-sortable-helper"</span>)[<span class="number">0</span>];<span class="keyword">return</span> e||(b.style.visibility=<span class="string">"hidden"</span>),b},update:<span class="keyword">function</span>(a,b){<span class="keyword">if</span>(e&amp;&amp;!d.forcePlaceholderSize)<span class="keyword">return</span>;b.height()||b.height(c.currentItem.innerHeight()-parseInt(c.currentItem.css(<span class="string">"paddingTop"</span>)||<span class="number">0</span>,<span class="number">10</span>)-parseInt(c.currentItem.css(<span class="string">"paddingBottom"</span>)||<span class="number">0</span>,<span class="number">10</span>)),b.width()||b.width(c.currentItem.innerWidth()-parseInt(c.currentItem.css(<span class="string">"paddingLeft"</span>)||<span class="number">0</span>,<span class="number">10</span>)-parseInt(c.currentItem.css(<span class="string">"paddingRight"</span>)||<span class="number">0</span>,<span class="number">10</span>))}}}c.placeholder=a(d.placeholder.element.call(c.element,c.currentItem)),c.currentItem.after(c.placeholder),d.placeholder.update(c,c.placeholder)},_contactContainers:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=<span class="literal">null</span>,d=<span class="literal">null</span>;<span class="keyword">for</span>(<span class="keyword">var</span> e=<span class="keyword">this</span>.containers.length-<span class="number">1</span>;e&gt;=<span class="number">0</span>;e--){<span class="keyword">if</span>(a.ui.contains(<span class="keyword">this</span>.currentItem[<span class="number">0</span>],<span class="keyword">this</span>.containers[e].element[<span class="number">0</span>]))<span class="keyword">continue</span>;<span class="keyword">if</span>(<span class="keyword">this</span>._intersectsWith(<span class="keyword">this</span>.containers[e].containerCache)){<span class="keyword">if</span>(c&amp;&amp;a.ui.contains(<span class="keyword">this</span>.containers[e].element[<span class="number">0</span>],c.element[<span class="number">0</span>]))<span class="keyword">continue</span>;c=<span class="keyword">this</span>.containers[e],d=e}<span class="keyword">else</span> <span class="keyword">this</span>.containers[e].containerCache.over&amp;&amp;(<span class="keyword">this</span>.containers[e]._trigger(<span class="string">"out"</span>,b,<span class="keyword">this</span>._uiHash(<span class="keyword">this</span>)),<span class="keyword">this</span>.containers[e].containerCache.over=<span class="number">0</span>)}<span class="keyword">if</span>(!c)<span class="keyword">return</span>;<span class="keyword">if</span>(<span class="keyword">this</span>.containers.length===<span class="number">1</span>)<span class="keyword">this</span>.containers[d]._trigger(<span class="string">"over"</span>,b,<span class="keyword">this</span>._uiHash(<span class="keyword">this</span>)),<span class="keyword">this</span>.containers[d].containerCache.over=<span class="number">1</span>;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.currentContainer!=<span class="keyword">this</span>.containers[d]){<span class="keyword">var</span> f=<span class="number">1e4</span>,g=<span class="literal">null</span>,h=<span class="keyword">this</span>.positionAbs[<span class="keyword">this</span>.containers[d].floating?<span class="string">"left"</span>:<span class="string">"top"</span>];<span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="keyword">this</span>.items.length-<span class="number">1</span>;i&gt;=<span class="number">0</span>;i--){<span class="keyword">if</span>(!a.ui.contains(<span class="keyword">this</span>.containers[d].element[<span class="number">0</span>],<span class="keyword">this</span>.items[i].item[<span class="number">0</span>]))<span class="keyword">continue</span>;<span class="keyword">var</span> j=<span class="keyword">this</span>.containers[d].floating?<span class="keyword">this</span>.items[i].item.offset().left:<span class="keyword">this</span>.items[i].item.offset().top;Math.abs(j-h)&lt;f&amp;&amp;(f=Math.abs(j-h),g=<span class="keyword">this</span>.items[i],<span class="keyword">this</span>.direction=j-h&gt;<span class="number">0</span>?<span class="string">"down"</span>:<span class="string">"up"</span>)}<span class="keyword">if</span>(!g&amp;&amp;!<span class="keyword">this</span>.options.dropOnEmpty)<span class="keyword">return</span>;<span class="keyword">this</span>.currentContainer=<span class="keyword">this</span>.containers[d],g?<span class="keyword">this</span>._rearrange(b,g,<span class="literal">null</span>,!<span class="number">0</span>):<span class="keyword">this</span>._rearrange(b,<span class="literal">null</span>,<span class="keyword">this</span>.containers[d].element,!<span class="number">0</span>),<span class="keyword">this</span>._trigger(<span class="string">"change"</span>,b,<span class="keyword">this</span>._uiHash()),<span class="keyword">this</span>.containers[d]._trigger(<span class="string">"change"</span>,b,<span class="keyword">this</span>._uiHash(<span class="keyword">this</span>)),<span class="keyword">this</span>.options.placeholder.update(<span class="keyword">this</span>.currentContainer,<span class="keyword">this</span>.placeholder),<span class="keyword">this</span>.containers[d]._trigger(<span class="string">"over"</span>,b,<span class="keyword">this</span>._uiHash(<span class="keyword">this</span>)),<span class="keyword">this</span>.containers[d].containerCache.over=<span class="number">1</span>}},_createHelper:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=<span class="keyword">this</span>.options,d=a.isFunction(c.helper)?a(c.helper.apply(<span class="keyword">this</span>.element[<span class="number">0</span>],[b,<span class="keyword">this</span>.currentItem])):c.helper==<span class="string">"clone"</span>?<span class="keyword">this</span>.currentItem.clone():<span class="keyword">this</span>.currentItem;<span class="keyword">return</span> d.parents(<span class="string">"body"</span>).length||a(c.appendTo!=<span class="string">"parent"</span>?c.appendTo:<span class="keyword">this</span>.currentItem[<span class="number">0</span>].parentNode)[<span class="number">0</span>].appendChild(d[<span class="number">0</span>]),d[<span class="number">0</span>]==<span class="keyword">this</span>.currentItem[<span class="number">0</span>]&amp;&amp;(<span class="keyword">this</span>._storedCSS={width:<span class="keyword">this</span>.currentItem[<span class="number">0</span>].style.width,height:<span class="keyword">this</span>.currentItem[<span class="number">0</span>].style.height,position:<span class="keyword">this</span>.currentItem.css(<span class="string">"position"</span>),top:<span class="keyword">this</span>.currentItem.css(<span class="string">"top"</span>),left:<span class="keyword">this</span>.currentItem.css(<span class="string">"left"</span>)}),(d[<span class="number">0</span>].style.width==<span class="string">""</span>||c.forceHelperSize)&amp;&amp;d.width(<span class="keyword">this</span>.currentItem.width()),(d[<span class="number">0</span>].style.height==<span class="string">""</span>||c.forceHelperSize)&amp;&amp;d.height(<span class="keyword">this</span>.currentItem.height()),d},_adjustOffsetFromHelper:<span class="keyword">function</span>(b){<span class="keyword">typeof</span> b==<span class="string">"string"</span>&amp;&amp;(b=b.split(<span class="string">" "</span>)),a.isArray(b)&amp;&amp;(b={left:+b[<span class="number">0</span>],top:+b[<span class="number">1</span>]||<span class="number">0</span>}),<span class="string">"left"</span><span class="keyword">in</span> b&amp;&amp;(<span class="keyword">this</span>.offset.click.left=b.left+<span class="keyword">this</span>.margins.left),<span class="string">"right"</span><span class="keyword">in</span> b&amp;&amp;(<span class="keyword">this</span>.offset.click.left=<span class="keyword">this</span>.helperProportions.width-b.right+<span class="keyword">this</span>.margins.left),<span class="string">"top"</span><span class="keyword">in</span> b&amp;&amp;(<span class="keyword">this</span>.offset.click.top=b.top+<span class="keyword">this</span>.margins.top),<span class="string">"bottom"</span><span class="keyword">in</span> b&amp;&amp;(<span class="keyword">this</span>.offset.click.top=<span class="keyword">this</span>.helperProportions.height-b.bottom+<span class="keyword">this</span>.margins.top)},_getParentOffset:<span class="keyword">function</span>(){<span class="keyword">this</span>.offsetParent=<span class="keyword">this</span>.helper.offsetParent();<span class="keyword">var</span> b=<span class="keyword">this</span>.offsetParent.offset();<span class="keyword">this</span>.cssPosition==<span class="string">"absolute"</span>&amp;&amp;<span class="keyword">this</span>.scrollParent[<span class="number">0</span>]!=document&amp;&amp;a.ui.contains(<span class="keyword">this</span>.scrollParent[<span class="number">0</span>],<span class="keyword">this</span>.offsetParent[<span class="number">0</span>])&amp;&amp;(b.left+=<span class="keyword">this</span>.scrollParent.scrollLeft(),b.top+=<span class="keyword">this</span>.scrollParent.scrollTop());<span class="keyword">if</span>(<span class="keyword">this</span>.offsetParent[<span class="number">0</span>]==document.body||<span class="keyword">this</span>.offsetParent[<span class="number">0</span>].tagName&amp;&amp;<span class="keyword">this</span>.offsetParent[<span class="number">0</span>].tagName.toLowerCase()==<span class="string">"html"</span>&amp;&amp;a.browser.msie)b={top:<span class="number">0</span>,left:<span class="number">0</span>};<span class="keyword">return</span>{top:b.top+(parseInt(<span class="keyword">this</span>.offsetParent.css(<span class="string">"borderTopWidth"</span>),<span class="number">10</span>)||<span class="number">0</span>),left:b.left+(parseInt(<span class="keyword">this</span>.offsetParent.css(<span class="string">"borderLeftWidth"</span>),<span class="number">10</span>)||<span class="number">0</span>)}},_getRelativeOffset:<span class="keyword">function</span>(){<span class="keyword">if</span>(<span class="keyword">this</span>.cssPosition==<span class="string">"relative"</span>){<span class="keyword">var</span> a=<span class="keyword">this</span>.currentItem.position();<span class="keyword">return</span>{top:a.top-(parseInt(<span class="keyword">this</span>.helper.css(<span class="string">"top"</span>),<span class="number">10</span>)||<span class="number">0</span>)+<span class="keyword">this</span>.scrollParent.scrollTop(),left:a.left-(parseInt(<span class="keyword">this</span>.helper.css(<span class="string">"left"</span>),<span class="number">10</span>)||<span class="number">0</span>)+<span class="keyword">this</span>.scrollParent.scrollLeft()}}<span class="keyword">return</span>{top:<span class="number">0</span>,left:<span class="number">0</span>}},_cacheMargins:<span class="keyword">function</span>(){<span class="keyword">this</span>.margins={left:parseInt(<span class="keyword">this</span>.currentItem.css(<span class="string">"marginLeft"</span>),<span class="number">10</span>)||<span class="number">0</span>,top:parseInt(<span class="keyword">this</span>.currentItem.css(<span class="string">"marginTop"</span>),<span class="number">10</span>)||<span class="number">0</span>}},_cacheHelperProportions:<span class="keyword">function</span>(){<span class="keyword">this</span>.helperProportions={width:<span class="keyword">this</span>.helper.outerWidth(),height:<span class="keyword">this</span>.helper.outerHeight()}},_setContainment:<span class="keyword">function</span>(){<span class="keyword">var</span> b=<span class="keyword">this</span>.options;b.containment==<span class="string">"parent"</span>&amp;&amp;(b.containment=<span class="keyword">this</span>.helper[<span class="number">0</span>].parentNode);<span class="keyword">if</span>(b.containment==<span class="string">"document"</span>||b.containment==<span class="string">"window"</span>)<span class="keyword">this</span>.containment=[<span class="number">0</span>-<span class="keyword">this</span>.offset.relative.left-<span class="keyword">this</span>.offset.parent.left,<span class="number">0</span>-<span class="keyword">this</span>.offset.relative.top-<span class="keyword">this</span>.offset.parent.top,a(b.containment==<span class="string">"document"</span>?document:window).width()-<span class="keyword">this</span>.helperProportions.width-<span class="keyword">this</span>.margins.left,(a(b.containment==<span class="string">"document"</span>?document:window).height()||document.body.parentNode.scrollHeight)-<span class="keyword">this</span>.helperProportions.height-<span class="keyword">this</span>.margins.top];<span class="keyword">if</span>(!<span class="regexp">/^(document|window|parent)$/</span>.test(b.containment)){<span class="keyword">var</span> c=a(b.containment)[<span class="number">0</span>],d=a(b.containment).offset(),e=a(c).css(<span class="string">"overflow"</span>)!=<span class="string">"hidden"</span>;<span class="keyword">this</span>.containment=[d.left+(parseInt(a(c).css(<span class="string">"borderLeftWidth"</span>),<span class="number">10</span>)||<span class="number">0</span>)+(parseInt(a(c).css(<span class="string">"paddingLeft"</span>),<span class="number">10</span>)||<span class="number">0</span>)-<span class="keyword">this</span>.margins.left,d.top+(parseInt(a(c).css(<span class="string">"borderTopWidth"</span>),<span class="number">10</span>)||<span class="number">0</span>)+(parseInt(a(c).css(<span class="string">"paddingTop"</span>),<span class="number">10</span>)||<span class="number">0</span>)-<span class="keyword">this</span>.margins.top,d.left+(e?Math.max(c.scrollWidth,c.offsetWidth):c.offsetWidth)-(parseInt(a(c).css(<span class="string">"borderLeftWidth"</span>),<span class="number">10</span>)||<span class="number">0</span>)-(parseInt(a(c).css(<span class="string">"paddingRight"</span>),<span class="number">10</span>)||<span class="number">0</span>)-<span class="keyword">this</span>.helperProportions.width-<span class="keyword">this</span>.margins.left,d.top+(e?Math.max(c.scrollHeight,c.offsetHeight):c.offsetHeight)-(parseInt(a(c).css(<span class="string">"borderTopWidth"</span>),<span class="number">10</span>)||<span class="number">0</span>)-(parseInt(a(c).css(<span class="string">"paddingBottom"</span>),<span class="number">10</span>)||<span class="number">0</span>)-<span class="keyword">this</span>.helperProportions.height-<span class="keyword">this</span>.margins.top]}},_convertPositionTo:<span class="keyword">function</span>(b,c){c||(c=<span class="keyword">this</span>.position);<span class="keyword">var</span> d=b==<span class="string">"absolute"</span>?<span class="number">1</span>:-<span class="number">1</span>,e=<span class="keyword">this</span>.options,f=<span class="keyword">this</span>.cssPosition==<span class="string">"absolute"</span>&amp;&amp;(<span class="keyword">this</span>.scrollParent[<span class="number">0</span>]==document||!a.ui.contains(<span class="keyword">this</span>.scrollParent[<span class="number">0</span>],<span class="keyword">this</span>.offsetParent[<span class="number">0</span>]))?<span class="keyword">this</span>.offsetParent:<span class="keyword">this</span>.scrollParent,g=<span class="regexp">/(html|body)/i</span>.test(f[<span class="number">0</span>].tagName);<span class="keyword">return</span>{top:c.top+<span class="keyword">this</span>.offset.relative.top*d+<span class="keyword">this</span>.offset.parent.top*d-(a.browser.safari&amp;&amp;<span class="keyword">this</span>.cssPosition==<span class="string">"fixed"</span>?<span class="number">0</span>:(<span class="keyword">this</span>.cssPosition==<span class="string">"fixed"</span>?-<span class="keyword">this</span>.scrollParent.scrollTop():g?<span class="number">0</span>:f.scrollTop())*d),left:c.left+<span class="keyword">this</span>.offset.relative.left*d+<span class="keyword">this</span>.offset.parent.left*d-(a.browser.safari&amp;&amp;<span class="keyword">this</span>.cssPosition==<span class="string">"fixed"</span>?<span class="number">0</span>:(<span class="keyword">this</span>.cssPosition==<span class="string">"fixed"</span>?-<span class="keyword">this</span>.scrollParent.scrollLeft():g?<span class="number">0</span>:f.scrollLeft())*d)}},_generatePosition:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=<span class="keyword">this</span>.options,d=<span class="keyword">this</span>.cssPosition==<span class="string">"absolute"</span>&amp;&amp;(<span class="keyword">this</span>.scrollParent[<span class="number">0</span>]==document||!a.ui.contains(<span class="keyword">this</span>.scrollParent[<span class="number">0</span>],<span class="keyword">this</span>.offsetParent[<span class="number">0</span>]))?<span class="keyword">this</span>.offsetParent:<span class="keyword">this</span>.scrollParent,e=<span class="regexp">/(html|body)/i</span>.test(d[<span class="number">0</span>].tagName);<span class="keyword">this</span>.cssPosition==<span class="string">"relative"</span>&amp;&amp;(<span class="keyword">this</span>.scrollParent[<span class="number">0</span>]==document||<span class="keyword">this</span>.scrollParent[<span class="number">0</span>]==<span class="keyword">this</span>.offsetParent[<span class="number">0</span>])&amp;&amp;(<span class="keyword">this</span>.offset.relative=<span class="keyword">this</span>._getRelativeOffset());<span class="keyword">var</span> f=b.pageX,g=b.pageY;<span class="keyword">if</span>(<span class="keyword">this</span>.originalPosition){<span class="keyword">this</span>.containment&amp;&amp;(b.pageX-<span class="keyword">this</span>.offset.click.left&lt;<span class="keyword">this</span>.containment[<span class="number">0</span>]&amp;&amp;(f=<span class="keyword">this</span>.containment[<span class="number">0</span>]+<span class="keyword">this</span>.offset.click.left),b.pageY-<span class="keyword">this</span>.offset.click.top&lt;<span class="keyword">this</span>.containment[<span class="number">1</span>]&amp;&amp;(g=<span class="keyword">this</span>.containment[<span class="number">1</span>]+<span class="keyword">this</span>.offset.click.top),b.pageX-<span class="keyword">this</span>.offset.click.left&gt;<span class="keyword">this</span>.containment[<span class="number">2</span>]&amp;&amp;(f=<span class="keyword">this</span>.containment[<span class="number">2</span>]+<span class="keyword">this</span>.offset.click.left),b.pageY-<span class="keyword">this</span>.offset.click.top&gt;<span class="keyword">this</span>.containment[<span class="number">3</span>]&amp;&amp;(g=<span class="keyword">this</span>.containment[<span class="number">3</span>]+<span class="keyword">this</span>.offset.click.top));<span class="keyword">if</span>(c.grid){<span class="keyword">var</span> h=<span class="keyword">this</span>.originalPageY+Math.round((g-<span class="keyword">this</span>.originalPageY)/c.grid[<span class="number">1</span>])*c.grid[<span class="number">1</span>];g=<span class="keyword">this</span>.containment?h-<span class="keyword">this</span>.offset.click.top&lt;<span class="keyword">this</span>.containment[<span class="number">1</span>]||h-<span class="keyword">this</span>.offset.click.top&gt;<span class="keyword">this</span>.containment[<span class="number">3</span>]?h-<span class="keyword">this</span>.offset.click.top&lt;<span class="keyword">this</span>.containment[<span class="number">1</span>]?h+c.grid[<span class="number">1</span>]:h-c.grid[<span class="number">1</span>]:h:h;<span class="keyword">var</span> i=<span class="keyword">this</span>.originalPageX+Math.round((f-<span class="keyword">this</span>.originalPageX)/c.grid[<span class="number">0</span>])*c.grid[<span class="number">0</span>];f=<span class="keyword">this</span>.containment?i-<span class="keyword">this</span>.offset.click.left&lt;<span class="keyword">this</span>.containment[<span class="number">0</span>]||i-<span class="keyword">this</span>.offset.click.left&gt;<span class="keyword">this</span>.containment[<span class="number">2</span>]?i-<span class="keyword">this</span>.offset.click.left&lt;<span class="keyword">this</span>.containment[<span class="number">0</span>]?i+c.grid[<span class="number">0</span>]:i-c.grid[<span class="number">0</span>]:i:i}}<span class="keyword">return</span>{top:g-<span class="keyword">this</span>.offset.click.top-<span class="keyword">this</span>.offset.relative.top-<span class="keyword">this</span>.offset.parent.top+(a.browser.safari&amp;&amp;<span class="keyword">this</span>.cssPosition==<span class="string">"fixed"</span>?<span class="number">0</span>:<span class="keyword">this</span>.cssPosition==<span class="string">"fixed"</span>?-<span class="keyword">this</span>.scrollParent.scrollTop():e?<span class="number">0</span>:d.scrollTop()),left:f-<span class="keyword">this</span>.offset.click.left-<span class="keyword">this</span>.offset.relative.left-<span class="keyword">this</span>.offset.parent.left+(a.browser.safari&amp;&amp;<span class="keyword">this</span>.cssPosition==<span class="string">"fixed"</span>?<span class="number">0</span>:<span class="keyword">this</span>.cssPosition==<span class="string">"fixed"</span>?-<span class="keyword">this</span>.scrollParent.scrollLeft():e?<span class="number">0</span>:d.scrollLeft())}},_rearrange:<span class="keyword">function</span>(a,b,c,d){c?c[<span class="number">0</span>].appendChild(<span class="keyword">this</span>.placeholder[<span class="number">0</span>]):b.item[<span class="number">0</span>].parentNode.insertBefore(<span class="keyword">this</span>.placeholder[<span class="number">0</span>],<span class="keyword">this</span>.direction==<span class="string">"down"</span>?b.item[<span class="number">0</span>]:b.item[<span class="number">0</span>].nextSibling),<span class="keyword">this</span>.counter=<span class="keyword">this</span>.counter?++<span class="keyword">this</span>.counter:<span class="number">1</span>;<span class="keyword">var</span> e=<span class="keyword">this</span>,f=<span class="keyword">this</span>.counter;window.setTimeout(<span class="keyword">function</span>(){f==e.counter&amp;&amp;e.refreshPositions(!d)},<span class="number">0</span>)},_clear:<span class="keyword">function</span>(b,c){<span class="keyword">this</span>.reverting=!<span class="number">1</span>;<span class="keyword">var</span> d=[],e=<span class="keyword">this</span>;!<span class="keyword">this</span>._noFinalSort&amp;&amp;<span class="keyword">this</span>.currentItem.parent().length&amp;&amp;<span class="keyword">this</span>.placeholder.before(<span class="keyword">this</span>.currentItem),<span class="keyword">this</span>._noFinalSort=<span class="literal">null</span>;<span class="keyword">if</span>(<span class="keyword">this</span>.helper[<span class="number">0</span>]==<span class="keyword">this</span>.currentItem[<span class="number">0</span>]){<span class="keyword">for</span>(<span class="keyword">var</span> f <span class="keyword">in</span> <span class="keyword">this</span>._storedCSS)<span class="keyword">if</span>(<span class="keyword">this</span>._storedCSS[f]==<span class="string">"auto"</span>||<span class="keyword">this</span>._storedCSS[f]==<span class="string">"static"</span>)<span class="keyword">this</span>._storedCSS[f]=<span class="string">""</span>;<span class="keyword">this</span>.currentItem.css(<span class="keyword">this</span>._storedCSS).removeClass(<span class="string">"ui-sortable-helper"</span>)}<span class="keyword">else</span> <span class="keyword">this</span>.currentItem.show();<span class="keyword">this</span>.fromOutside&amp;&amp;!c&amp;&amp;d.push(<span class="keyword">function</span>(a){<span class="keyword">this</span>._trigger(<span class="string">"receive"</span>,a,<span class="keyword">this</span>._uiHash(<span class="keyword">this</span>.fromOutside))}),(<span class="keyword">this</span>.fromOutside||<span class="keyword">this</span>.domPosition.prev!=<span class="keyword">this</span>.currentItem.prev().not(<span class="string">".ui-sortable-helper"</span>)[<span class="number">0</span>]||<span class="keyword">this</span>.domPosition.parent!=<span class="keyword">this</span>.currentItem.parent()[<span class="number">0</span>])&amp;&amp;!c&amp;&amp;d.push(<span class="keyword">function</span>(a){<span class="keyword">this</span>._trigger(<span class="string">"update"</span>,a,<span class="keyword">this</span>._uiHash())});<span class="keyword">if</span>(!a.ui.contains(<span class="keyword">this</span>.element[<span class="number">0</span>],<span class="keyword">this</span>.currentItem[<span class="number">0</span>])){c||d.push(<span class="keyword">function</span>(a){<span class="keyword">this</span>._trigger(<span class="string">"remove"</span>,a,<span class="keyword">this</span>._uiHash())});<span class="keyword">for</span>(<span class="keyword">var</span> f=<span class="keyword">this</span>.containers.length-<span class="number">1</span>;f&gt;=<span class="number">0</span>;f--)a.ui.contains(<span class="keyword">this</span>.containers[f].element[<span class="number">0</span>],<span class="keyword">this</span>.currentItem[<span class="number">0</span>])&amp;&amp;!c&amp;&amp;(d.push(<span class="keyword">function</span>(a){<span class="keyword">return</span> <span class="keyword">function</span>(b){a._trigger(<span class="string">"receive"</span>,b,<span class="keyword">this</span>._uiHash(<span class="keyword">this</span>))}}.call(<span class="keyword">this</span>,<span class="keyword">this</span>.containers[f])),d.push(<span class="keyword">function</span>(a){<span class="keyword">return</span> <span class="keyword">function</span>(b){a._trigger(<span class="string">"update"</span>,b,<span class="keyword">this</span>._uiHash(<span class="keyword">this</span>))}}.call(<span class="keyword">this</span>,<span class="keyword">this</span>.containers[f])))}<span class="keyword">for</span>(<span class="keyword">var</span> f=<span class="keyword">this</span>.containers.length-<span class="number">1</span>;f&gt;=<span class="number">0</span>;f--)c||d.push(<span class="keyword">function</span>(a){<span class="keyword">return</span> <span class="keyword">function</span>(b){a._trigger(<span class="string">"deactivate"</span>,b,<span class="keyword">this</span>._uiHash(<span class="keyword">this</span>))}}.call(<span class="keyword">this</span>,<span class="keyword">this</span>.containers[f])),<span class="keyword">this</span>.containers[f].containerCache.over&amp;&amp;(d.push(<span class="keyword">function</span>(a){<span class="keyword">return</span> <span class="keyword">function</span>(b){a._trigger(<span class="string">"out"</span>,b,<span class="keyword">this</span>._uiHash(<span class="keyword">this</span>))}}.call(<span class="keyword">this</span>,<span class="keyword">this</span>.containers[f])),<span class="keyword">this</span>.containers[f].containerCache.over=<span class="number">0</span>);<span class="keyword">this</span>._storedCursor&amp;&amp;a(<span class="string">"body"</span>).css(<span class="string">"cursor"</span>,<span class="keyword">this</span>._storedCursor),<span class="keyword">this</span>._storedOpacity&amp;&amp;<span class="keyword">this</span>.helper.css(<span class="string">"opacity"</span>,<span class="keyword">this</span>._storedOpacity),<span class="keyword">this</span>._storedZIndex&amp;&amp;<span class="keyword">this</span>.helper.css(<span class="string">"zIndex"</span>,<span class="keyword">this</span>._storedZIndex==<span class="string">"auto"</span>?<span class="string">""</span>:<span class="keyword">this</span>._storedZIndex),<span class="keyword">this</span>.dragging=!<span class="number">1</span>;<span class="keyword">if</span>(<span class="keyword">this</span>.cancelHelperRemoval){<span class="keyword">if</span>(!c){<span class="keyword">this</span>._trigger(<span class="string">"beforeStop"</span>,b,<span class="keyword">this</span>._uiHash());<span class="keyword">for</span>(<span class="keyword">var</span> f=<span class="number">0</span>;f&lt;d.length;f++)d[f].call(<span class="keyword">this</span>,b);<span class="keyword">this</span>._trigger(<span class="string">"stop"</span>,b,<span class="keyword">this</span>._uiHash())}<span class="keyword">return</span>!<span class="number">1</span>}c||<span class="keyword">this</span>._trigger(<span class="string">"beforeStop"</span>,b,<span class="keyword">this</span>._uiHash()),<span class="keyword">this</span>.placeholder[<span class="number">0</span>].parentNode.removeChild(<span class="keyword">this</span>.placeholder[<span class="number">0</span>]),<span class="keyword">this</span>.helper[<span class="number">0</span>]!=<span class="keyword">this</span>.currentItem[<span class="number">0</span>]&amp;&amp;<span class="keyword">this</span>.helper.remove(),<span class="keyword">this</span>.helper=<span class="literal">null</span>;<span class="keyword">if</span>(!c){<span class="keyword">for</span>(<span class="keyword">var</span> f=<span class="number">0</span>;f&lt;d.length;f++)d[f].call(<span class="keyword">this</span>,b);<span class="keyword">this</span>._trigger(<span class="string">"stop"</span>,b,<span class="keyword">this</span>._uiHash())}<span class="keyword">return</span> <span class="keyword">this</span>.fromOutside=!<span class="number">1</span>,!<span class="number">0</span>},_trigger:<span class="keyword">function</span>(){a.Widget.prototype._trigger.apply(<span class="keyword">this</span>,arguments)===!<span class="number">1</span>&amp;&amp;<span class="keyword">this</span>.cancel()},_uiHash:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=b||<span class="keyword">this</span>;<span class="keyword">return</span>{helper:c.helper,placeholder:c.placeholder||a([]),position:c.position,originalPosition:c.originalPosition,offset:c.positionAbs,item:c.currentItem,sender:b?b.element:<span class="literal">null</span>}}}),a.extend(a.ui.sortable,{version:<span class="string">"1.8.21"</span>})}(jQuery),jQuery.effects||<span class="keyword">function</span>(a,b){<span class="function"><span class="keyword">function</span> <span class="title">c</span><span class="params">(b)</span>{</span><span class="keyword">var</span> c;<span class="keyword">return</span> b&amp;&amp;b.constructor==Array&amp;&amp;b.length==<span class="number">3</span>?b:(c=<span class="regexp">/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/</span>.exec(b))?[parseInt(c[<span class="number">1</span>],<span class="number">10</span>),parseInt(c[<span class="number">2</span>],<span class="number">10</span>),parseInt(c[<span class="number">3</span>],<span class="number">10</span>)]:(c=<span class="regexp">/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/</span>.exec(b))?[parseFloat(c[<span class="number">1</span>])*<span class="number">2.55</span>,parseFloat(c[<span class="number">2</span>])*<span class="number">2.55</span>,parseFloat(c[<span class="number">3</span>])*<span class="number">2.55</span>]:(c=<span class="regexp">/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/</span>.exec(b))?[parseInt(c[<span class="number">1</span>],<span class="number">16</span>),parseInt(c[<span class="number">2</span>],<span class="number">16</span>),parseInt(c[<span class="number">3</span>],<span class="number">16</span>)]:(c=<span class="regexp">/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/</span>.exec(b))?[parseInt(c[<span class="number">1</span>]+c[<span class="number">1</span>],<span class="number">16</span>),parseInt(c[<span class="number">2</span>]+c[<span class="number">2</span>],<span class="number">16</span>),parseInt(c[<span class="number">3</span>]+c[<span class="number">3</span>],<span class="number">16</span>)]:(c=<span class="regexp">/rgba\(0, 0, 0, 0\)/</span>.exec(b))?e.transparent:e[a.trim(b).toLowerCase()]}<span class="function"><span class="keyword">function</span> <span class="title">d</span><span class="params">(b,d)</span>{</span><span class="keyword">var</span> e;<span class="keyword">do</span>{e=a.curCSS(b,d);<span class="keyword">if</span>(e!=<span class="string">""</span>&amp;&amp;e!=<span class="string">"transparent"</span>||a.nodeName(b,<span class="string">"body"</span>))<span class="keyword">break</span>;d=<span class="string">"backgroundColor"</span>}<span class="keyword">while</span>(b=b.parentNode);<span class="keyword">return</span> c(e)}<span class="function"><span class="keyword">function</span> <span class="title">h</span><span class="params">()</span>{</span><span class="keyword">var</span> a=document.defaultView?document.defaultView.getComputedStyle(<span class="keyword">this</span>,<span class="literal">null</span>):<span class="keyword">this</span>.currentStyle,b={},c,d;<span class="keyword">if</span>(a&amp;&amp;a.length&amp;&amp;a[<span class="number">0</span>]&amp;&amp;a[a[<span class="number">0</span>]]){<span class="keyword">var</span> e=a.length;<span class="keyword">while</span>(e--)c=a[e],<span class="keyword">typeof</span> a[c]==<span class="string">"string"</span>&amp;&amp;(d=c.replace(<span class="regexp">/\-(\w)/g</span>,<span class="keyword">function</span>(a,b){<span class="keyword">return</span> b.toUpperCase()}),b[d]=a[c])}<span class="keyword">else</span> <span class="keyword">for</span>(c <span class="keyword">in</span> a)<span class="keyword">typeof</span> a[c]==<span class="string">"string"</span>&amp;&amp;(b[c]=a[c]);<span class="keyword">return</span> b}<span class="function"><span class="keyword">function</span> <span class="title">i</span><span class="params">(b)</span>{</span><span class="keyword">var</span> c,d;<span class="keyword">for</span>(c <span class="keyword">in</span> b)d=b[c],(d==<span class="literal">null</span>||a.isFunction(d)||c <span class="keyword">in</span> g||<span class="regexp">/scrollbar/</span>.test(c)||!<span class="regexp">/color/i</span>.test(c)&amp;&amp;isNaN(parseFloat(d)))&amp;&amp;<span class="keyword">delete</span> b[c];<span class="keyword">return</span> b}<span class="function"><span class="keyword">function</span> <span class="title">j</span><span class="params">(a,b)</span>{</span><span class="keyword">var</span> c={_:<span class="number">0</span>},d;<span class="keyword">for</span>(d <span class="keyword">in</span> b)a[d]!=b[d]&amp;&amp;(c[d]=b[d]);<span class="keyword">return</span> c}<span class="function"><span class="keyword">function</span> <span class="title">k</span><span class="params">(b,c,d,e)</span>{</span><span class="keyword">typeof</span> b==<span class="string">"object"</span>&amp;&amp;(e=c,d=<span class="literal">null</span>,c=b,b=c.effect),a.isFunction(c)&amp;&amp;(e=c,d=<span class="literal">null</span>,c={});<span class="keyword">if</span>(<span class="keyword">typeof</span> c==<span class="string">"number"</span>||a.fx.speeds[c])e=d,d=c,c={};<span class="keyword">return</span> a.isFunction(d)&amp;&amp;(e=d,d=<span class="literal">null</span>),c=c||{},d=d||c.duration,d=a.fx.off?<span class="number">0</span>:<span class="keyword">typeof</span> d==<span class="string">"number"</span>?d:d <span class="keyword">in</span> a.fx.speeds?a.fx.speeds[d]:a.fx.speeds._<span class="keyword">default</span>,e=e||c.complete,[b,c,d,e]}<span class="function"><span class="keyword">function</span> <span class="title">l</span><span class="params">(b)</span>{</span><span class="keyword">return</span>!b||<span class="keyword">typeof</span> b==<span class="string">"number"</span>||a.fx.speeds[b]?!<span class="number">0</span>:<span class="keyword">typeof</span> b==<span class="string">"string"</span>&amp;&amp;!a.effects[b]?!<span class="number">0</span>:!<span class="number">1</span>}a.effects={},a.each([<span class="string">"backgroundColor"</span>,<span class="string">"borderBottomColor"</span>,<span class="string">"borderLeftColor"</span>,<span class="string">"borderRightColor"</span>,<span class="string">"borderTopColor"</span>,<span class="string">"borderColor"</span>,<span class="string">"color"</span>,<span class="string">"outlineColor"</span>],<span class="keyword">function</span>(b,e){a.fx.step[e]=<span class="keyword">function</span>(a){a.colorInit||(a.start=d(a.elem,e),a.end=c(a.end),a.colorInit=!<span class="number">0</span>),a.elem.style[e]=<span class="string">"rgb("</span>+Math.max(Math.min(parseInt(a.pos*(a.end[<span class="number">0</span>]-a.start[<span class="number">0</span>])+a.start[<span class="number">0</span>],<span class="number">10</span>),<span class="number">255</span>),<span class="number">0</span>)+<span class="string">","</span>+Math.max(Math.min(parseInt(a.pos*(a.end[<span class="number">1</span>]-a.start[<span class="number">1</span>])+a.start[<span class="number">1</span>],<span class="number">10</span>),<span class="number">255</span>),<span class="number">0</span>)+<span class="string">","</span>+Math.max(Math.min(parseInt(a.pos*(a.end[<span class="number">2</span>]-a.start[<span class="number">2</span>])+a.start[<span class="number">2</span>],<span class="number">10</span>),<span class="number">255</span>),<span class="number">0</span>)+<span class="string">")"</span>}});<span class="keyword">var</span> e={aqua:[<span class="number">0</span>,<span class="number">255</span>,<span class="number">255</span>],azure:[<span class="number">240</span>,<span class="number">255</span>,<span class="number">255</span>],beige:[<span class="number">245</span>,<span class="number">245</span>,<span class="number">220</span>],black:[<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>],blue:[<span class="number">0</span>,<span class="number">0</span>,<span class="number">255</span>],brown:[<span class="number">165</span>,<span class="number">42</span>,<span class="number">42</span>],cyan:[<span class="number">0</span>,<span class="number">255</span>,<span class="number">255</span>],darkblue:[<span class="number">0</span>,<span class="number">0</span>,<span class="number">139</span>],darkcyan:[<span class="number">0</span>,<span class="number">139</span>,<span class="number">139</span>],darkgrey:[<span class="number">169</span>,<span class="number">169</span>,<span class="number">169</span>],darkgreen:[<span class="number">0</span>,<span class="number">100</span>,<span class="number">0</span>],darkkhaki:[<span class="number">189</span>,<span class="number">183</span>,<span class="number">107</span>],darkmagenta:[<span class="number">139</span>,<span class="number">0</span>,<span class="number">139</span>],darkolivegreen:[<span class="number">85</span>,<span class="number">107</span>,<span class="number">47</span>],darkorange:[<span class="number">255</span>,<span class="number">140</span>,<span class="number">0</span>],darkorchid:[<span class="number">153</span>,<span class="number">50</span>,<span class="number">204</span>],darkred:[<span class="number">139</span>,<span class="number">0</span>,<span class="number">0</span>],darksalmon:[<span class="number">233</span>,<span class="number">150</span>,<span class="number">122</span>],darkviolet:[<span class="number">148</span>,<span class="number">0</span>,<span class="number">211</span>],fuchsia:[<span class="number">255</span>,<span class="number">0</span>,<span class="number">255</span>],gold:[<span class="number">255</span>,<span class="number">215</span>,<span class="number">0</span>],green:[<span class="number">0</span>,<span class="number">128</span>,<span class="number">0</span>],indigo:[<span class="number">75</span>,<span class="number">0</span>,<span class="number">130</span>],khaki:[<span class="number">240</span>,<span class="number">230</span>,<span class="number">140</span>],lightblue:[<span class="number">173</span>,<span class="number">216</span>,<span class="number">230</span>],lightcyan:[<span class="number">224</span>,<span class="number">255</span>,<span class="number">255</span>],lightgreen:[<span class="number">144</span>,<span class="number">238</span>,<span class="number">144</span>],lightgrey:[<span class="number">211</span>,<span class="number">211</span>,<span class="number">211</span>],lightpink:[<span class="number">255</span>,<span class="number">182</span>,<span class="number">193</span>],lightyellow:[<span class="number">255</span>,<span class="number">255</span>,<span class="number">224</span>],lime:[<span class="number">0</span>,<span class="number">255</span>,<span class="number">0</span>],magenta:[<span class="number">255</span>,<span class="number">0</span>,<span class="number">255</span>],maroon:[<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>],navy:[<span class="number">0</span>,<span class="number">0</span>,<span class="number">128</span>],olive:[<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>],orange:[<span class="number">255</span>,<span class="number">165</span>,<span class="number">0</span>],pink:[<span class="number">255</span>,<span class="number">192</span>,<span class="number">203</span>],purple:[<span class="number">128</span>,<span class="number">0</span>,<span class="number">128</span>],violet:[<span class="number">128</span>,<span class="number">0</span>,<span class="number">128</span>],red:[<span class="number">255</span>,<span class="number">0</span>,<span class="number">0</span>],silver:[<span class="number">192</span>,<span class="number">192</span>,<span class="number">192</span>],white:[<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span>],yellow:[<span class="number">255</span>,<span class="number">255</span>,<span class="number">0</span>],transparent:[<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span>]},f=[<span class="string">"add"</span>,<span class="string">"remove"</span>,<span class="string">"toggle"</span>],g={border:<span class="number">1</span>,borderBottom:<span class="number">1</span>,borderColor:<span class="number">1</span>,borderLeft:<span class="number">1</span>,borderRight:<span class="number">1</span>,borderTop:<span class="number">1</span>,borderWidth:<span class="number">1</span>,margin:<span class="number">1</span>,padding:<span class="number">1</span>};a.effects.animateClass=<span class="keyword">function</span>(b,c,d,e){<span class="keyword">return</span> a.isFunction(d)&amp;&amp;(e=d,d=<span class="literal">null</span>),<span class="keyword">this</span>.queue(<span class="keyword">function</span>(){<span class="keyword">var</span> g=a(<span class="keyword">this</span>),k=g.attr(<span class="string">"style"</span>)||<span class="string">" "</span>,l=i(h.call(<span class="keyword">this</span>)),m,n=g.attr(<span class="string">"class"</span>)||<span class="string">""</span>;a.each(f,<span class="keyword">function</span>(a,c){b[c]&amp;&amp;g[c+<span class="string">"Class"</span>](b[c])}),m=i(h.call(<span class="keyword">this</span>)),g.attr(<span class="string">"class"</span>,n),g.animate(j(l,m),{queue:!<span class="number">1</span>,duration:c,easing:d,complete:<span class="keyword">function</span>(){a.each(f,<span class="keyword">function</span>(a,c){b[c]&amp;&amp;g[c+<span class="string">"Class"</span>](b[c])}),<span class="keyword">typeof</span> g.attr(<span class="string">"style"</span>)==<span class="string">"object"</span>?(g.attr(<span class="string">"style"</span>).cssText=<span class="string">""</span>,g.attr(<span class="string">"style"</span>).cssText=k):g.attr(<span class="string">"style"</span>,k),e&amp;&amp;e.apply(<span class="keyword">this</span>,arguments),a.dequeue(<span class="keyword">this</span>)}})})},a.fn.extend({_addClass:a.fn.addClass,addClass:<span class="keyword">function</span>(b,c,d,e){<span class="keyword">return</span> c?a.effects.animateClass.apply(<span class="keyword">this</span>,[{add:b},c,d,e]):<span class="keyword">this</span>._addClass(b)},_removeClass:a.fn.removeClass,removeClass:<span class="keyword">function</span>(b,c,d,e){<span class="keyword">return</span> c?a.effects.animateClass.apply(<span class="keyword">this</span>,[{remove:b},c,d,e]):<span class="keyword">this</span>._removeClass(b)},_toggleClass:a.fn.toggleClass,toggleClass:<span class="keyword">function</span>(c,d,e,f,g){<span class="keyword">return</span> <span class="keyword">typeof</span> d==<span class="string">"boolean"</span>||d===b?e?a.effects.animateClass.apply(<span class="keyword">this</span>,[d?{add:c}:{remove:c},e,f,g]):<span class="keyword">this</span>._toggleClass(c,d):a.effects.animateClass.apply(<span class="keyword">this</span>,[{toggle:c},d,e,f])},switchClass:<span class="keyword">function</span>(b,c,d,e,f){<span class="keyword">return</span> a.effects.animateClass.apply(<span class="keyword">this</span>,[{add:c,remove:b},d,e,f])}}),a.extend(a.effects,{version:<span class="string">"1.8.21"</span>,save:<span class="keyword">function</span>(a,b){<span class="keyword">for</span>(<span class="keyword">var</span> c=<span class="number">0</span>;c&lt;b.length;c++)b[c]!==<span class="literal">null</span>&amp;&amp;a.data(<span class="string">"ec.storage."</span>+b[c],a[<span class="number">0</span>].style[b[c]])},restore:<span class="keyword">function</span>(a,b){<span class="keyword">for</span>(<span class="keyword">var</span> c=<span class="number">0</span>;c&lt;b.length;c++)b[c]!==<span class="literal">null</span>&amp;&amp;a.css(b[c],a.data(<span class="string">"ec.storage."</span>+b[c]))},setMode:<span class="keyword">function</span>(a,b){<span class="keyword">return</span> b==<span class="string">"toggle"</span>&amp;&amp;(b=a.is(<span class="string">":hidden"</span>)?<span class="string">"show"</span>:<span class="string">"hide"</span>),b},getBaseline:<span class="keyword">function</span>(a,b){<span class="keyword">var</span> c,d;<span class="keyword">switch</span>(a[<span class="number">0</span>]){<span class="keyword">case</span><span class="string">"top"</span>:c=<span class="number">0</span>;<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"middle"</span>:c=<span class="number">.5</span>;<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"bottom"</span>:c=<span class="number">1</span>;<span class="keyword">break</span>;<span class="keyword">default</span>:c=a[<span class="number">0</span>]/b.height}<span class="keyword">switch</span>(a[<span class="number">1</span>]){<span class="keyword">case</span><span class="string">"left"</span>:d=<span class="number">0</span>;<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"center"</span>:d=<span class="number">.5</span>;<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"right"</span>:d=<span class="number">1</span>;<span class="keyword">break</span>;<span class="keyword">default</span>:d=a[<span class="number">1</span>]/b.width}<span class="keyword">return</span>{x:d,y:c}},createWrapper:<span class="keyword">function</span>(b){<span class="keyword">if</span>(b.parent().is(<span class="string">".ui-effects-wrapper"</span>))<span class="keyword">return</span> b.parent();<span class="keyword">var</span> c={width:b.outerWidth(!<span class="number">0</span>),height:b.outerHeight(!<span class="number">0</span>),<span class="string">"float"</span>:b.css(<span class="string">"float"</span>)},d=a(<span class="string">"&lt;div&gt;&lt;/div&gt;"</span>).addClass(<span class="string">"ui-effects-wrapper"</span>).css({fontSize:<span class="string">"100%"</span>,background:<span class="string">"transparent"</span>,border:<span class="string">"none"</span>,margin:<span class="number">0</span>,padding:<span class="number">0</span>}),e=document.activeElement;<span class="keyword">try</span>{e.id}<span class="keyword">catch</span>(f){e=document.body}<span class="keyword">return</span> b.wrap(d),(b[<span class="number">0</span>]===e||a.contains(b[<span class="number">0</span>],e))&amp;&amp;a(e).focus(),d=b.parent(),b.css(<span class="string">"position"</span>)==<span class="string">"static"</span>?(d.css({position:<span class="string">"relative"</span>}),b.css({position:<span class="string">"relative"</span>})):(a.extend(c,{position:b.css(<span class="string">"position"</span>),zIndex:b.css(<span class="string">"z-index"</span>)}),a.each([<span class="string">"top"</span>,<span class="string">"left"</span>,<span class="string">"bottom"</span>,<span class="string">"right"</span>],<span class="keyword">function</span>(a,d){c[d]=b.css(d),isNaN(parseInt(c[d],<span class="number">10</span>))&amp;&amp;(c[d]=<span class="string">"auto"</span>)}),b.css({position:<span class="string">"relative"</span>,top:<span class="number">0</span>,left:<span class="number">0</span>,right:<span class="string">"auto"</span>,bottom:<span class="string">"auto"</span>})),d.css(c).show()},removeWrapper:<span class="keyword">function</span>(b){<span class="keyword">var</span> c,d=document.activeElement;<span class="keyword">return</span> b.parent().is(<span class="string">".ui-effects-wrapper"</span>)?(c=b.parent().replaceWith(b),(b[<span class="number">0</span>]===d||a.contains(b[<span class="number">0</span>],d))&amp;&amp;a(d).focus(),c):b},setTransition:<span class="keyword">function</span>(b,c,d,e){<span class="keyword">return</span> e=e||{},a.each(c,<span class="keyword">function</span>(a,c){<span class="keyword">var</span> f=b.cssUnit(c);f[<span class="number">0</span>]&gt;<span class="number">0</span>&amp;&amp;(e[c]=f[<span class="number">0</span>]*d+f[<span class="number">1</span>])}),e}}),a.fn.extend({effect:<span class="keyword">function</span>(b,c,d,e){<span class="keyword">var</span> f=k.apply(<span class="keyword">this</span>,arguments),g={options:f[<span class="number">1</span>],duration:f[<span class="number">2</span>],callback:f[<span class="number">3</span>]},h=g.options.mode,i=a.effects[b];<span class="keyword">return</span> a.fx.off||!i?h?<span class="keyword">this</span>[h](g.duration,g.callback):<span class="keyword">this</span>.each(<span class="keyword">function</span>(){g.callback&amp;&amp;g.callback.call(<span class="keyword">this</span>)}):i.call(<span class="keyword">this</span>,g)},_show:a.fn.show,show:<span class="keyword">function</span>(a){<span class="keyword">if</span>(l(a))<span class="keyword">return</span> <span class="keyword">this</span>._show.apply(<span class="keyword">this</span>,arguments);<span class="keyword">var</span> b=k.apply(<span class="keyword">this</span>,arguments);<span class="keyword">return</span> b[<span class="number">1</span>].mode=<span class="string">"show"</span>,<span class="keyword">this</span>.effect.apply(<span class="keyword">this</span>,b)},_hide:a.fn.hide,hide:<span class="keyword">function</span>(a){<span class="keyword">if</span>(l(a))<span class="keyword">return</span> <span class="keyword">this</span>._hide.apply(<span class="keyword">this</span>,arguments);<span class="keyword">var</span> b=k.apply(<span class="keyword">this</span>,arguments);<span class="keyword">return</span> b[<span class="number">1</span>].mode=<span class="string">"hide"</span>,<span class="keyword">this</span>.effect.apply(<span class="keyword">this</span>,b)},__toggle:a.fn.toggle,toggle:<span class="keyword">function</span>(b){<span class="keyword">if</span>(l(b)||<span class="keyword">typeof</span> b==<span class="string">"boolean"</span>||a.isFunction(b))<span class="keyword">return</span> <span class="keyword">this</span>.__toggle.apply(<span class="keyword">this</span>,arguments);<span class="keyword">var</span> c=k.apply(<span class="keyword">this</span>,arguments);<span class="keyword">return</span> c[<span class="number">1</span>].mode=<span class="string">"toggle"</span>,<span class="keyword">this</span>.effect.apply(<span class="keyword">this</span>,c)},cssUnit:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=<span class="keyword">this</span>.css(b),d=[];<span class="keyword">return</span> a.each([<span class="string">"em"</span>,<span class="string">"px"</span>,<span class="string">"%"</span>,<span class="string">"pt"</span>],<span class="keyword">function</span>(a,b){c.indexOf(b)&gt;<span class="number">0</span>&amp;&amp;(d=[parseFloat(c),b])}),d}}),a.easing.jswing=a.easing.swing,a.extend(a.easing,{def:<span class="string">"easeOutQuad"</span>,swing:<span class="keyword">function</span>(b,c,d,e,f){<span class="keyword">return</span> a.easing[a.easing.def](b,c,d,e,f)},easeInQuad:<span class="keyword">function</span>(a,b,c,d,e){<span class="keyword">return</span> d*(b/=e)*b+c},easeOutQuad:<span class="keyword">function</span>(a,b,c,d,e){<span class="keyword">return</span>-d*(b/=e)*(b-<span class="number">2</span>)+c},easeInOutQuad:<span class="keyword">function</span>(a,b,c,d,e){<span class="keyword">return</span>(b/=e/<span class="number">2</span>)&lt;<span class="number">1</span>?d/<span class="number">2</span>*b*b+c:-d/<span class="number">2</span>*(--b*(b-<span class="number">2</span>)-<span class="number">1</span>)+c},easeInCubic:<span class="keyword">function</span>(a,b,c,d,e){<span class="keyword">return</span> d*(b/=e)*b*b+c},easeOutCubic:<span class="keyword">function</span>(a,b,c,d,e){<span class="keyword">return</span> d*((b=b/e-<span class="number">1</span>)*b*b+<span class="number">1</span>)+c},easeInOutCubic:<span class="keyword">function</span>(a,b,c,d,e){<span class="keyword">return</span>(b/=e/<span class="number">2</span>)&lt;<span class="number">1</span>?d/<span class="number">2</span>*b*b*b+c:d/<span class="number">2</span>*((b-=<span class="number">2</span>)*b*b+<span class="number">2</span>)+c},easeInQuart:<span class="keyword">function</span>(a,b,c,d,e){<span class="keyword">return</span> d*(b/=e)*b*b*b+c},easeOutQuart:<span class="keyword">function</span>(a,b,c,d,e){<span class="keyword">return</span>-d*((b=b/e-<span class="number">1</span>)*b*b*b-<span class="number">1</span>)+c},easeInOutQuart:<span class="keyword">function</span>(a,b,c,d,e){<span class="keyword">return</span>(b/=e/<span class="number">2</span>)&lt;<span class="number">1</span>?d/<span class="number">2</span>*b*b*b*b+c:-d/<span class="number">2</span>*((b-=<span class="number">2</span>)*b*b*b-<span class="number">2</span>)+c},easeInQuint:<span class="keyword">function</span>(a,b,c,d,e){<span class="keyword">return</span> d*(b/=e)*b*b*b*b+c},easeOutQuint:<span class="keyword">function</span>(a,b,c,d,e){<span class="keyword">return</span> d*((b=b/e-<span class="number">1</span>)*b*b*b*b+<span class="number">1</span>)+c},easeInOutQuint:<span class="keyword">function</span>(a,b,c,d,e){<span class="keyword">return</span>(b/=e/<span class="number">2</span>)&lt;<span class="number">1</span>?d/<span class="number">2</span>*b*b*b*b*b+c:d/<span class="number">2</span>*((b-=<span class="number">2</span>)*b*b*b*b+<span class="number">2</span>)+c},easeInSine:<span class="keyword">function</span>(a,b,c,d,e){<span class="keyword">return</span>-d*Math.cos(b/e*(Math.PI/<span class="number">2</span>))+d+c},easeOutSine:<span class="keyword">function</span>(a,b,c,d,e){<span class="keyword">return</span> d*Math.sin(b/e*(Math.PI/<span class="number">2</span>))+c},easeInOutSine:<span class="keyword">function</span>(a,b,c,d,e){<span class="keyword">return</span>-d/<span class="number">2</span>*(Math.cos(Math.PI*b/e)-<span class="number">1</span>)+c},easeInExpo:<span class="keyword">function</span>(a,b,c,d,e){<span class="keyword">return</span> b==<span class="number">0</span>?c:d*Math.pow(<span class="number">2</span>,<span class="number">10</span>*(b/e-<span class="number">1</span>))+c},easeOutExpo:<span class="keyword">function</span>(a,b,c,d,e){<span class="keyword">return</span> b==e?c+d:d*(-Math.pow(<span class="number">2</span>,-<span class="number">10</span>*b/e)+<span class="number">1</span>)+c},easeInOutExpo:<span class="keyword">function</span>(a,b,c,d,e){<span class="keyword">return</span> b==<span class="number">0</span>?c:b==e?c+d:(b/=e/<span class="number">2</span>)&lt;<span class="number">1</span>?d/<span class="number">2</span>*Math.pow(<span class="number">2</span>,<span class="number">10</span>*(b-<span class="number">1</span>))+c:d/<span class="number">2</span>*(-Math.pow(<span class="number">2</span>,-<span class="number">10</span>*--b)+<span class="number">2</span>)+c},easeInCirc:<span class="keyword">function</span>(a,b,c,d,e){<span class="keyword">return</span>-d*(Math.sqrt(<span class="number">1</span>-(b/=e)*b)-<span class="number">1</span>)+c},easeOutCirc:<span class="keyword">function</span>(a,b,c,d,e){<span class="keyword">return</span> d*Math.sqrt(<span class="number">1</span>-(b=b/e-<span class="number">1</span>)*b)+c},easeInOutCirc:<span class="keyword">function</span>(a,b,c,d,e){<span class="keyword">return</span>(b/=e/<span class="number">2</span>)&lt;<span class="number">1</span>?-d/<span class="number">2</span>*(Math.sqrt(<span class="number">1</span>-b*b)-<span class="number">1</span>)+c:d/<span class="number">2</span>*(Math.sqrt(<span class="number">1</span>-(b-=<span class="number">2</span>)*b)+<span class="number">1</span>)+c},easeInElastic:<span class="keyword">function</span>(a,b,c,d,e){<span class="keyword">var</span> f=<span class="number">1.70158</span>,g=<span class="number">0</span>,h=d;<span class="keyword">if</span>(b==<span class="number">0</span>)<span class="keyword">return</span> c;<span class="keyword">if</span>((b/=e)==<span class="number">1</span>)<span class="keyword">return</span> c+d;g||(g=e*<span class="number">.3</span>);<span class="keyword">if</span>(h&lt;Math.abs(d)){h=d;<span class="keyword">var</span> f=g/<span class="number">4</span>}<span class="keyword">else</span> <span class="keyword">var</span> f=g/(<span class="number">2</span>*Math.PI)*Math.asin(d/h);<span class="keyword">return</span>-(h*Math.pow(<span class="number">2</span>,<span class="number">10</span>*(b-=<span class="number">1</span>))*Math.sin((b*e-f)*<span class="number">2</span>*Math.PI/g))+c},easeOutElastic:<span class="keyword">function</span>(a,b,c,d,e){<span class="keyword">var</span> f=<span class="number">1.70158</span>,g=<span class="number">0</span>,h=d;<span class="keyword">if</span>(b==<span class="number">0</span>)<span class="keyword">return</span> c;<span class="keyword">if</span>((b/=e)==<span class="number">1</span>)<span class="keyword">return</span> c+d;g||(g=e*<span class="number">.3</span>);<span class="keyword">if</span>(h&lt;Math.abs(d)){h=d;<span class="keyword">var</span> f=g/<span class="number">4</span>}<span class="keyword">else</span> <span class="keyword">var</span> f=g/(<span class="number">2</span>*Math.PI)*Math.asin(d/h);<span class="keyword">return</span> h*Math.pow(<span class="number">2</span>,-<span class="number">10</span>*b)*Math.sin((b*e-f)*<span class="number">2</span>*Math.PI/g)+d+c},easeInOutElastic:<span class="keyword">function</span>(a,b,c,d,e){<span class="keyword">var</span> f=<span class="number">1.70158</span>,g=<span class="number">0</span>,h=d;<span class="keyword">if</span>(b==<span class="number">0</span>)<span class="keyword">return</span> c;<span class="keyword">if</span>((b/=e/<span class="number">2</span>)==<span class="number">2</span>)<span class="keyword">return</span> c+d;g||(g=e*<span class="number">.3</span>*<span class="number">1.5</span>);<span class="keyword">if</span>(h&lt;Math.abs(d)){h=d;<span class="keyword">var</span> f=g/<span class="number">4</span>}<span class="keyword">else</span> <span class="keyword">var</span> f=g/(<span class="number">2</span>*Math.PI)*Math.asin(d/h);<span class="keyword">return</span> b&lt;<span class="number">1</span>?-<span class="number">0.5</span>*h*Math.pow(<span class="number">2</span>,<span class="number">10</span>*(b-=<span class="number">1</span>))*Math.sin((b*e-f)*<span class="number">2</span>*Math.PI/g)+c:h*Math.pow(<span class="number">2</span>,-<span class="number">10</span>*(b-=<span class="number">1</span>))*Math.sin((b*e-f)*<span class="number">2</span>*Math.PI/g)*<span class="number">.5</span>+d+c},easeInBack:<span class="keyword">function</span>(a,c,d,e,f,g){<span class="keyword">return</span> g==b&amp;&amp;(g=<span class="number">1.70158</span>),e*(c/=f)*c*((g+<span class="number">1</span>)*c-g)+d},easeOutBack:<span class="keyword">function</span>(a,c,d,e,f,g){<span class="keyword">return</span> g==b&amp;&amp;(g=<span class="number">1.70158</span>),e*((c=c/f-<span class="number">1</span>)*c*((g+<span class="number">1</span>)*c+g)+<span class="number">1</span>)+d},easeInOutBack:<span class="keyword">function</span>(a,c,d,e,f,g){<span class="keyword">return</span> g==b&amp;&amp;(g=<span class="number">1.70158</span>),(c/=f/<span class="number">2</span>)&lt;<span class="number">1</span>?e/<span class="number">2</span>*c*c*(((g*=<span class="number">1.525</span>)+<span class="number">1</span>)*c-g)+d:e/<span class="number">2</span>*((c-=<span class="number">2</span>)*c*(((g*=<span class="number">1.525</span>)+<span class="number">1</span>)*c+g)+<span class="number">2</span>)+d},easeInBounce:<span class="keyword">function</span>(b,c,d,e,f){<span class="keyword">return</span> e-a.easing.easeOutBounce(b,f-c,<span class="number">0</span>,e,f)+d},easeOutBounce:<span class="keyword">function</span>(a,b,c,d,e){<span class="keyword">return</span>(b/=e)&lt;<span class="number">1</span>/<span class="number">2.75</span>?d*<span class="number">7.5625</span>*b*b+c:b&lt;<span class="number">2</span>/<span class="number">2.75</span>?d*(<span class="number">7.5625</span>*(b-=<span class="number">1.5</span>/<span class="number">2.75</span>)*b+<span class="number">.75</span>)+c:b&lt;<span class="number">2.5</span>/<span class="number">2.75</span>?d*(<span class="number">7.5625</span>*(b-=<span class="number">2.25</span>/<span class="number">2.75</span>)*b+<span class="number">.9375</span>)+c:d*(<span class="number">7.5625</span>*(b-=<span class="number">2.625</span>/<span class="number">2.75</span>)*b+<span class="number">.984375</span>)+c},easeInOutBounce:<span class="keyword">function</span>(b,c,d,e,f){<span class="keyword">return</span> c&lt;f/<span class="number">2</span>?a.easing.easeInBounce(b,c*<span class="number">2</span>,<span class="number">0</span>,e,f)*<span class="number">.5</span>+d:a.easing.easeOutBounce(b,c*<span class="number">2</span>-f,<span class="number">0</span>,e,f)*<span class="number">.5</span>+e*<span class="number">.5</span>+d}})}(jQuery),<span class="keyword">function</span>(a,b){a.effects.blind=<span class="keyword">function</span>(b){<span class="keyword">return</span> <span class="keyword">this</span>.queue(<span class="keyword">function</span>(){<span class="keyword">var</span> c=a(<span class="keyword">this</span>),d=[<span class="string">"position"</span>,<span class="string">"top"</span>,<span class="string">"bottom"</span>,<span class="string">"left"</span>,<span class="string">"right"</span>],e=a.effects.setMode(c,b.options.mode||<span class="string">"hide"</span>),f=b.options.direction||<span class="string">"vertical"</span>;a.effects.save(c,d),c.show();<span class="keyword">var</span> g=a.effects.createWrapper(c).css({overflow:<span class="string">"hidden"</span>}),h=f==<span class="string">"vertical"</span>?<span class="string">"height"</span>:<span class="string">"width"</span>,i=f==<span class="string">"vertical"</span>?g.height():g.width();e==<span class="string">"show"</span>&amp;&amp;g.css(h,<span class="number">0</span>);<span class="keyword">var</span> j={};j[h]=e==<span class="string">"show"</span>?i:<span class="number">0</span>,g.animate(j,b.duration,b.options.easing,<span class="keyword">function</span>(){e==<span class="string">"hide"</span>&amp;&amp;c.hide(),a.effects.restore(c,d),a.effects.removeWrapper(c),b.callback&amp;&amp;b.callback.apply(c[<span class="number">0</span>],arguments),c.dequeue()})})}}(jQuery),<span class="keyword">function</span>(a,b){a.effects.bounce=<span class="keyword">function</span>(b){<span class="keyword">return</span> <span class="keyword">this</span>.queue(<span class="keyword">function</span>(){<span class="keyword">var</span> c=a(<span class="keyword">this</span>),d=[<span class="string">"position"</span>,<span class="string">"top"</span>,<span class="string">"bottom"</span>,<span class="string">"left"</span>,<span class="string">"right"</span>],e=a.effects.setMode(c,b.options.mode||<span class="string">"effect"</span>),f=b.options.direction||<span class="string">"up"</span>,g=b.options.distance||<span class="number">20</span>,h=b.options.times||<span class="number">5</span>,i=b.duration||<span class="number">250</span>;<span class="regexp">/show|hide/</span>.test(e)&amp;&amp;d.push(<span class="string">"opacity"</span>),a.effects.save(c,d),c.show(),a.effects.createWrapper(c);<span class="keyword">var</span> j=f==<span class="string">"up"</span>||f==<span class="string">"down"</span>?<span class="string">"top"</span>:<span class="string">"left"</span>,k=f==<span class="string">"up"</span>||f==<span class="string">"left"</span>?<span class="string">"pos"</span>:<span class="string">"neg"</span>,g=b.options.distance||(j==<span class="string">"top"</span>?c.outerHeight({margin:!<span class="number">0</span>})/<span class="number">3</span>:c.outerWidth({margin:!<span class="number">0</span>})/<span class="number">3</span>);e==<span class="string">"show"</span>&amp;&amp;c.css(<span class="string">"opacity"</span>,<span class="number">0</span>).css(j,k==<span class="string">"pos"</span>?-g:g),e==<span class="string">"hide"</span>&amp;&amp;(g=g/(h*<span class="number">2</span>)),e!=<span class="string">"hide"</span>&amp;&amp;h--;<span class="keyword">if</span>(e==<span class="string">"show"</span>){<span class="keyword">var</span> l={opacity:<span class="number">1</span>};l[j]=(k==<span class="string">"pos"</span>?<span class="string">"+="</span>:<span class="string">"-="</span>)+g,c.animate(l,i/<span class="number">2</span>,b.options.easing),g=g/<span class="number">2</span>,h--}<span class="keyword">for</span>(<span class="keyword">var</span> m=<span class="number">0</span>;m&lt;h;m++){<span class="keyword">var</span> n={},p={};n[j]=(k==<span class="string">"pos"</span>?<span class="string">"-="</span>:<span class="string">"+="</span>)+g,p[j]=(k==<span class="string">"pos"</span>?<span class="string">"+="</span>:<span class="string">"-="</span>)+g,c.animate(n,i/<span class="number">2</span>,b.options.easing).animate(p,i/<span class="number">2</span>,b.options.easing),g=e==<span class="string">"hide"</span>?g*<span class="number">2</span>:g/<span class="number">2</span>}<span class="keyword">if</span>(e==<span class="string">"hide"</span>){<span class="keyword">var</span> l={opacity:<span class="number">0</span>};l[j]=(k==<span class="string">"pos"</span>?<span class="string">"-="</span>:<span class="string">"+="</span>)+g,c.animate(l,i/<span class="number">2</span>,b.options.easing,<span class="keyword">function</span>(){c.hide(),a.effects.restore(c,d),a.effects.removeWrapper(c),b.callback&amp;&amp;b.callback.apply(<span class="keyword">this</span>,arguments)})}<span class="keyword">else</span>{<span class="keyword">var</span> n={},p={};n[j]=(k==<span class="string">"pos"</span>?<span class="string">"-="</span>:<span class="string">"+="</span>)+g,p[j]=(k==<span class="string">"pos"</span>?<span class="string">"+="</span>:<span class="string">"-="</span>)+g,c.animate(n,i/<span class="number">2</span>,b.options.easing).animate(p,i/<span class="number">2</span>,b.options.easing,<span class="keyword">function</span>(){a.effects.restore(c,d),a.effects.removeWrapper(c),b.callback&amp;&amp;b.callback.apply(<span class="keyword">this</span>,arguments)})}c.queue(<span class="string">"fx"</span>,<span class="keyword">function</span>(){c.dequeue()}),c.dequeue()})}}(jQuery),<span class="keyword">function</span>(a,b){a.effects.clip=<span class="keyword">function</span>(b){<span class="keyword">return</span> <span class="keyword">this</span>.queue(<span class="keyword">function</span>(){<span class="keyword">var</span> c=a(<span class="keyword">this</span>),d=[<span class="string">"position"</span>,<span class="string">"top"</span>,<span class="string">"bottom"</span>,<span class="string">"left"</span>,<span class="string">"right"</span>,<span class="string">"height"</span>,<span class="string">"width"</span>],e=a.effects.setMode(c,b.options.mode||<span class="string">"hide"</span>),f=b.options.direction||<span class="string">"vertical"</span>;a.effects.save(c,d),c.show();<span class="keyword">var</span> g=a.effects.createWrapper(c).css({overflow:<span class="string">"hidden"</span>}),h=c[<span class="number">0</span>].tagName==<span class="string">"IMG"</span>?g:c,i={size:f==<span class="string">"vertical"</span>?<span class="string">"height"</span>:<span class="string">"width"</span>,position:f==<span class="string">"vertical"</span>?<span class="string">"top"</span>:<span class="string">"left"</span>},j=f==<span class="string">"vertical"</span>?h.height():h.width();e==<span class="string">"show"</span>&amp;&amp;(h.css(i.size,<span class="number">0</span>),h.css(i.position,j/<span class="number">2</span>));<span class="keyword">var</span> k={};k[i.size]=e==<span class="string">"show"</span>?j:<span class="number">0</span>,k[i.position]=e==<span class="string">"show"</span>?<span class="number">0</span>:j/<span class="number">2</span>,h.animate(k,{queue:!<span class="number">1</span>,duration:b.duration,easing:b.options.easing,complete:<span class="keyword">function</span>(){e==<span class="string">"hide"</span>&amp;&amp;c.hide(),a.effects.restore(c,d),a.effects.removeWrapper(c),b.callback&amp;&amp;b.callback.apply(c[<span class="number">0</span>],arguments),c.dequeue()}})})}}(jQuery),<span class="keyword">function</span>(a,b){a.effects.drop=<span class="keyword">function</span>(b){<span class="keyword">return</span> <span class="keyword">this</span>.queue(<span class="keyword">function</span>(){<span class="keyword">var</span> c=a(<span class="keyword">this</span>),d=[<span class="string">"position"</span>,<span class="string">"top"</span>,<span class="string">"bottom"</span>,<span class="string">"left"</span>,<span class="string">"right"</span>,<span class="string">"opacity"</span>],e=a.effects.setMode(c,b.options.mode||<span class="string">"hide"</span>),f=b.options.direction||<span class="string">"left"</span>;a.effects.save(c,d),c.show(),a.effects.createWrapper(c);<span class="keyword">var</span> g=f==<span class="string">"up"</span>||f==<span class="string">"down"</span>?<span class="string">"top"</span>:<span class="string">"left"</span>,h=f==<span class="string">"up"</span>||f==<span class="string">"left"</span>?<span class="string">"pos"</span>:<span class="string">"neg"</span>,i=b.options.distance||(g==<span class="string">"top"</span>?c.outerHeight({margin:!<span class="number">0</span>})/<span class="number">2</span>:c.outerWidth({margin:!<span class="number">0</span>})/<span class="number">2</span>);e==<span class="string">"show"</span>&amp;&amp;c.css(<span class="string">"opacity"</span>,<span class="number">0</span>).css(g,h==<span class="string">"pos"</span>?-i:i);<span class="keyword">var</span> j={opacity:e==<span class="string">"show"</span>?<span class="number">1</span>:<span class="number">0</span>};j[g]=(e==<span class="string">"show"</span>?h==<span class="string">"pos"</span>?<span class="string">"+="</span>:<span class="string">"-="</span>:h==<span class="string">"pos"</span>?<span class="string">"-="</span>:<span class="string">"+="</span>)+i,c.animate(j,{queue:!<span class="number">1</span>,duration:b.duration,easing:b.options.easing,complete:<span class="keyword">function</span>(){e==<span class="string">"hide"</span>&amp;&amp;c.hide(),a.effects.restore(c,d),a.effects.removeWrapper(c),b.callback&amp;&amp;b.callback.apply(<span class="keyword">this</span>,arguments),c.dequeue()}})})}}(jQuery),<span class="keyword">function</span>(a,b){a.effects.explode=<span class="keyword">function</span>(b){<span class="keyword">return</span> <span class="keyword">this</span>.queue(<span class="keyword">function</span>(){<span class="keyword">var</span> c=b.options.pieces?Math.round(Math.sqrt(b.options.pieces)):<span class="number">3</span>,d=b.options.pieces?Math.round(Math.sqrt(b.options.pieces)):<span class="number">3</span>;b.options.mode=b.options.mode==<span class="string">"toggle"</span>?a(<span class="keyword">this</span>).is(<span class="string">":visible"</span>)?<span class="string">"hide"</span>:<span class="string">"show"</span>:b.options.mode;<span class="keyword">var</span> e=a(<span class="keyword">this</span>).show().css(<span class="string">"visibility"</span>,<span class="string">"hidden"</span>),f=e.offset();f.top-=parseInt(e.css(<span class="string">"marginTop"</span>),<span class="number">10</span>)||<span class="number">0</span>,f.left-=parseInt(e.css(<span class="string">"marginLeft"</span>),<span class="number">10</span>)||<span class="number">0</span>;<span class="keyword">var</span> g=e.outerWidth(!<span class="number">0</span>),h=e.outerHeight(!<span class="number">0</span>);<span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;c;i++)<span class="keyword">for</span>(<span class="keyword">var</span> j=<span class="number">0</span>;j&lt;d;j++)e.clone().appendTo(<span class="string">"body"</span>).wrap(<span class="string">"&lt;div&gt;&lt;/div&gt;"</span>).css({position:<span class="string">"absolute"</span>,visibility:<span class="string">"visible"</span>,left:-j*(g/d),top:-i*(h/c)}).parent().addClass(<span class="string">"ui-effects-explode"</span>).css({position:<span class="string">"absolute"</span>,overflow:<span class="string">"hidden"</span>,width:g/d,height:h/c,left:f.left+j*(g/d)+(b.options.mode==<span class="string">"show"</span>?(j-Math.floor(d/<span class="number">2</span>))*(g/d):<span class="number">0</span>),top:f.top+i*(h/c)+(b.options.mode==<span class="string">"show"</span>?(i-Math.floor(c/<span class="number">2</span>))*(h/c):<span class="number">0</span>),opacity:b.options.mode==<span class="string">"show"</span>?<span class="number">0</span>:<span class="number">1</span>}).animate({left:f.left+j*(g/d)+(b.options.mode==<span class="string">"show"</span>?<span class="number">0</span>:(j-Math.floor(d/<span class="number">2</span>))*(g/d)),top:f.top+i*(h/c)+(b.options.mode==<span class="string">"show"</span>?<span class="number">0</span>:(i-Math.floor(c/<span class="number">2</span>))*(h/c)),opacity:b.options.mode==<span class="string">"show"</span>?<span class="number">1</span>:<span class="number">0</span>},b.duration||<span class="number">500</span>);setTimeout(<span class="keyword">function</span>(){b.options.mode==<span class="string">"show"</span>?e.css({visibility:<span class="string">"visible"</span>}):e.css({visibility:<span class="string">"visible"</span>}).hide(),b.callback&amp;&amp;b.callback.apply(e[<span class="number">0</span>]),e.dequeue(),a(<span class="string">"div.ui-effects-explode"</span>).remove()},b.duration||<span class="number">500</span>)})}}(jQuery),<span class="keyword">function</span>(a,b){a.effects.fade=<span class="keyword">function</span>(b){<span class="keyword">return</span> <span class="keyword">this</span>.queue(<span class="keyword">function</span>(){<span class="keyword">var</span> c=a(<span class="keyword">this</span>),d=a.effects.setMode(c,b.options.mode||<span class="string">"hide"</span>);c.animate({opacity:d},{queue:!<span class="number">1</span>,duration:b.duration,easing:b.options.easing,complete:<span class="keyword">function</span>(){b.callback&amp;&amp;b.callback.apply(<span class="keyword">this</span>,arguments),c.dequeue()}})})}}(jQuery),<span class="keyword">function</span>(a,b){a.effects.fold=<span class="keyword">function</span>(b){<span class="keyword">return</span> <span class="keyword">this</span>.queue(<span class="keyword">function</span>(){<span class="keyword">var</span> c=a(<span class="keyword">this</span>),d=[<span class="string">"position"</span>,<span class="string">"top"</span>,<span class="string">"bottom"</span>,<span class="string">"left"</span>,<span class="string">"right"</span>],e=a.effects.setMode(c,b.options.mode||<span class="string">"hide"</span>),f=b.options.size||<span class="number">15</span>,g=!!b.options.horizFirst,h=b.duration?b.duration/<span class="number">2</span>:a.fx.speeds._<span class="keyword">default</span>/<span class="number">2</span>;a.effects.save(c,d),c.show();<span class="keyword">var</span> i=a.effects.createWrapper(c).css({overflow:<span class="string">"hidden"</span>}),j=e==<span class="string">"show"</span>!=g,k=j?[<span class="string">"width"</span>,<span class="string">"height"</span>]:[<span class="string">"height"</span>,<span class="string">"width"</span>],l=j?[i.width(),i.height()]:[i.height(),i.width()],m=<span class="regexp">/([0-9]+)%/</span>.exec(f);m&amp;&amp;(f=parseInt(m[<span class="number">1</span>],<span class="number">10</span>)/<span class="number">100</span>*l[e==<span class="string">"hide"</span>?<span class="number">0</span>:<span class="number">1</span>]),e==<span class="string">"show"</span>&amp;&amp;i.css(g?{height:<span class="number">0</span>,width:f}:{height:f,width:<span class="number">0</span>});<span class="keyword">var</span> n={},p={};n[k[<span class="number">0</span>]]=e==<span class="string">"show"</span>?l[<span class="number">0</span>]:f,p[k[<span class="number">1</span>]]=e==<span class="string">"show"</span>?l[<span class="number">1</span>]:<span class="number">0</span>,i.animate(n,h,b.options.easing).animate(p,h,b.options.easing,<span class="keyword">function</span>(){e==<span class="string">"hide"</span>&amp;&amp;c.hide(),a.effects.restore(c,d),a.effects.removeWrapper(c),b.callback&amp;&amp;b.callback.apply(c[<span class="number">0</span>],arguments),c.dequeue()})})}}(jQuery),<span class="keyword">function</span>(a,b){a.effects.highlight=<span class="keyword">function</span>(b){<span class="keyword">return</span> <span class="keyword">this</span>.queue(<span class="keyword">function</span>(){<span class="keyword">var</span> c=a(<span class="keyword">this</span>),d=[<span class="string">"backgroundImage"</span>,<span class="string">"backgroundColor"</span>,<span class="string">"opacity"</span>],e=a.effects.setMode(c,b.options.mode||<span class="string">"show"</span>),f={backgroundColor:c.css(<span class="string">"backgroundColor"</span>)};e==<span class="string">"hide"</span>&amp;&amp;(f.opacity=<span class="number">0</span>),a.effects.save(c,d),c.show().css({backgroundImage:<span class="string">"none"</span>,backgroundColor:b.options.color||<span class="string">"#ffff99"</span>}).animate(f,{queue:!<span class="number">1</span>,duration:b.duration,easing:b.options.easing,complete:<span class="keyword">function</span>(){e==<span class="string">"hide"</span>&amp;&amp;c.hide(),a.effects.restore(c,d),e==<span class="string">"show"</span>&amp;&amp;!a.support.opacity&amp;&amp;<span class="keyword">this</span>.style.removeAttribute(<span class="string">"filter"</span>),b.callback&amp;&amp;b.callback.apply(<span class="keyword">this</span>,arguments),c.dequeue()}})})}}(jQuery),<span class="keyword">function</span>(a,b){a.effects.pulsate=<span class="keyword">function</span>(b){<span class="keyword">return</span> <span class="keyword">this</span>.queue(<span class="keyword">function</span>(){<span class="keyword">var</span> c=a(<span class="keyword">this</span>),d=a.effects.setMode(c,b.options.mode||<span class="string">"show"</span>),e=(b.options.times||<span class="number">5</span>)*<span class="number">2</span>-<span class="number">1</span>,f=b.duration?b.duration/<span class="number">2</span>:a.fx.speeds._<span class="keyword">default</span>/<span class="number">2</span>,g=c.is(<span class="string">":visible"</span>),h=<span class="number">0</span>;g||(c.css(<span class="string">"opacity"</span>,<span class="number">0</span>).show(),h=<span class="number">1</span>),(d==<span class="string">"hide"</span>&amp;&amp;g||d==<span class="string">"show"</span>&amp;&amp;!g)&amp;&amp;e--;<span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;e;i++)c.animate({opacity:h},f,b.options.easing),h=(h+<span class="number">1</span>)%<span class="number">2</span>;c.animate({opacity:h},f,b.options.easing,<span class="keyword">function</span>(){h==<span class="number">0</span>&amp;&amp;c.hide(),b.callback&amp;&amp;b.callback.apply(<span class="keyword">this</span>,arguments)}),c.queue(<span class="string">"fx"</span>,<span class="keyword">function</span>(){c.dequeue()}).dequeue()})}}(jQuery),<span class="keyword">function</span>(a,b){a.effects.puff=<span class="keyword">function</span>(b){<span class="keyword">return</span> <span class="keyword">this</span>.queue(<span class="keyword">function</span>(){<span class="keyword">var</span> c=a(<span class="keyword">this</span>),d=a.effects.setMode(c,b.options.mode||<span class="string">"hide"</span>),e=parseInt(b.options.percent,<span class="number">10</span>)||<span class="number">150</span>,f=e/<span class="number">100</span>,g={height:c.height(),width:c.width()};a.extend(b.options,{fade:!<span class="number">0</span>,mode:d,percent:d==<span class="string">"hide"</span>?e:<span class="number">100</span>,from:d==<span class="string">"hide"</span>?g:{height:g.height*f,width:g.width*f}}),c.effect(<span class="string">"scale"</span>,b.options,b.duration,b.callback),c.dequeue()})},a.effects.scale=<span class="keyword">function</span>(b){<span class="keyword">return</span> <span class="keyword">this</span>.queue(<span class="keyword">function</span>(){<span class="keyword">var</span> c=a(<span class="keyword">this</span>),d=a.extend(!<span class="number">0</span>,{},b.options),e=a.effects.setMode(c,b.options.mode||<span class="string">"effect"</span>),f=parseInt(b.options.percent,<span class="number">10</span>)||(parseInt(b.options.percent,<span class="number">10</span>)==<span class="number">0</span>?<span class="number">0</span>:e==<span class="string">"hide"</span>?<span class="number">0</span>:<span class="number">100</span>),g=b.options.direction||<span class="string">"both"</span>,h=b.options.origin;e!=<span class="string">"effect"</span>&amp;&amp;(d.origin=h||[<span class="string">"middle"</span>,<span class="string">"center"</span>],d.restore=!<span class="number">0</span>);<span class="keyword">var</span> i={height:c.height(),width:c.width()};c.from=b.options.from||(e==<span class="string">"show"</span>?{height:<span class="number">0</span>,width:<span class="number">0</span>}:i);<span class="keyword">var</span> j={y:g!=<span class="string">"horizontal"</span>?f/<span class="number">100</span>:<span class="number">1</span>,x:g!=<span class="string">"vertical"</span>?f/<span class="number">100</span>:<span class="number">1</span>};c.to={height:i.height*j.y,width:i.width*j.x},b.options.fade&amp;&amp;(e==<span class="string">"show"</span>&amp;&amp;(c.from.opacity=<span class="number">0</span>,c.to.opacity=<span class="number">1</span>),e==<span class="string">"hide"</span>&amp;&amp;(c.from.opacity=<span class="number">1</span>,c.to.opacity=<span class="number">0</span>)),d.from=c.from,d.to=c.to,d.mode=e,c.effect(<span class="string">"size"</span>,d,b.duration,b.callback),c.dequeue()})},a.effects.size=<span class="keyword">function</span>(b){<span class="keyword">return</span> <span class="keyword">this</span>.queue(<span class="keyword">function</span>(){<span class="keyword">var</span> c=a(<span class="keyword">this</span>),d=[<span class="string">"position"</span>,<span class="string">"top"</span>,<span class="string">"bottom"</span>,<span class="string">"left"</span>,<span class="string">"right"</span>,<span class="string">"width"</span>,<span class="string">"height"</span>,<span class="string">"overflow"</span>,<span class="string">"opacity"</span>],e=[<span class="string">"position"</span>,<span class="string">"top"</span>,<span class="string">"bottom"</span>,<span class="string">"left"</span>,<span class="string">"right"</span>,<span class="string">"overflow"</span>,<span class="string">"opacity"</span>],f=[<span class="string">"width"</span>,<span class="string">"height"</span>,<span class="string">"overflow"</span>],g=[<span class="string">"fontSize"</span>],h=[<span class="string">"borderTopWidth"</span>,<span class="string">"borderBottomWidth"</span>,<span class="string">"paddingTop"</span>,<span class="string">"paddingBottom"</span>],i=[<span class="string">"borderLeftWidth"</span>,<span class="string">"borderRightWidth"</span>,<span class="string">"paddingLeft"</span>,<span class="string">"paddingRight"</span>],j=a.effects.setMode(c,b.options.mode||<span class="string">"effect"</span>),k=b.options.restore||!<span class="number">1</span>,l=b.options.scale||<span class="string">"both"</span>,m=b.options.origin,n={height:c.height(),width:c.width()};c.from=b.options.from||n,c.to=b.options.to||n;<span class="keyword">if</span>(m){<span class="keyword">var</span> p=a.effects.getBaseline(m,n);c.from.top=(n.height-c.from.height)*p.y,c.from.left=(n.width-c.from.width)*p.x,c.to.top=(n.height-c.to.height)*p.y,c.to.left=(n.width-c.to.width)*p.x}<span class="keyword">var</span> q={from:{y:c.from.height/n.height,x:c.from.width/n.width},to:{y:c.to.height/n.height,x:c.to.width/n.width}};<span class="keyword">if</span>(l==<span class="string">"box"</span>||l==<span class="string">"both"</span>)q.from.y!=q.to.y&amp;&amp;(d=d.concat(h),c.from=a.effects.setTransition(c,h,q.from.y,c.from),c.to=a.effects.setTransition(c,h,q.to.y,c.to)),q.from.x!=q.to.x&amp;&amp;(d=d.concat(i),c.from=a.effects.setTransition(c,i,q.from.x,c.from),c.to=a.effects.setTransition(c,i,q.to.x,c.to));(l==<span class="string">"content"</span>||l==<span class="string">"both"</span>)&amp;&amp;q.from.y!=q.to.y&amp;&amp;(d=d.concat(g),c.from=a.effects.setTransition(c,g,q.from.y,c.from),c.to=a.effects.setTransition(c,g,q.to.y,c.to)),a.effects.save(c,k?d:e),c.show(),a.effects.createWrapper(c),c.css(<span class="string">"overflow"</span>,<span class="string">"hidden"</span>).css(c.from);<span class="keyword">if</span>(l==<span class="string">"content"</span>||l==<span class="string">"both"</span>)h=h.concat([<span class="string">"marginTop"</span>,<span class="string">"marginBottom"</span>]).concat(g),i=i.concat([<span class="string">"marginLeft"</span>,<span class="string">"marginRight"</span>]),f=d.concat(h).concat(i),c.find(<span class="string">"*[width]"</span>).each(<span class="keyword">function</span>(){<span class="keyword">var</span> c=a(<span class="keyword">this</span>);k&amp;&amp;a.effects.save(c,f);<span class="keyword">var</span> d={height:c.height(),width:c.width()};c.from={height:d.height*q.from.y,width:d.width*q.from.x},c.to={height:d.height*q.to.y,width:d.width*q.to.x},q.from.y!=q.to.y&amp;&amp;(c.from=a.effects.setTransition(c,h,q.from.y,c.from),c.to=a.effects.setTransition(c,h,q.to.y,c.to)),q.from.x!=q.to.x&amp;&amp;(c.from=a.effects.setTransition(c,i,q.from.x,c.from),c.to=a.effects.setTransition(c,i,q.to.x,c.to)),c.css(c.from),c.animate(c.to,b.duration,b.options.easing,<span class="keyword">function</span>(){k&amp;&amp;a.effects.restore(c,f)})});c.animate(c.to,{queue:!<span class="number">1</span>,duration:b.duration,easing:b.options.easing,complete:<span class="keyword">function</span>(){c.to.opacity===<span class="number">0</span>&amp;&amp;c.css(<span class="string">"opacity"</span>,c.from.opacity),j==<span class="string">"hide"</span>&amp;&amp;c.hide(),a.effects.restore(c,k?d:e),a.effects.removeWrapper(c),b.callback&amp;&amp;b.callback.apply(<span class="keyword">this</span>,arguments),c.dequeue()}})})}}(jQuery),<span class="keyword">function</span>(a,b){a.effects.shake=<span class="keyword">function</span>(b){<span class="keyword">return</span> <span class="keyword">this</span>.queue(<span class="keyword">function</span>(){<span class="keyword">var</span> c=a(<span class="keyword">this</span>),d=[<span class="string">"position"</span>,<span class="string">"top"</span>,<span class="string">"bottom"</span>,<span class="string">"left"</span>,<span class="string">"right"</span>],e=a.effects.setMode(c,b.options.mode||<span class="string">"effect"</span>),f=b.options.direction||<span class="string">"left"</span>,g=b.options.distance||<span class="number">20</span>,h=b.options.times||<span class="number">3</span>,i=b.duration||b.options.duration||<span class="number">140</span>;a.effects.save(c,d),c.show(),a.effects.createWrapper(c);<span class="keyword">var</span> j=f==<span class="string">"up"</span>||f==<span class="string">"down"</span>?<span class="string">"top"</span>:<span class="string">"left"</span>,k=f==<span class="string">"up"</span>||f==<span class="string">"left"</span>?<span class="string">"pos"</span>:<span class="string">"neg"</span>,l={},m={},n={};l[j]=(k==<span class="string">"pos"</span>?<span class="string">"-="</span>:<span class="string">"+="</span>)+g,m[j]=(k==<span class="string">"pos"</span>?<span class="string">"+="</span>:<span class="string">"-="</span>)+g*<span class="number">2</span>,n[j]=(k==<span class="string">"pos"</span>?<span class="string">"-="</span>:<span class="string">"+="</span>)+g*<span class="number">2</span>,c.animate(l,i,b.options.easing);<span class="keyword">for</span>(<span class="keyword">var</span> p=<span class="number">1</span>;p&lt;h;p++)c.animate(m,i,b.options.easing).animate(n,i,b.options.easing);c.animate(m,i,b.options.easing).animate(l,i/<span class="number">2</span>,b.options.easing,<span class="keyword">function</span>(){a.effects.restore(c,d),a.effects.removeWrapper(c),b.callback&amp;&amp;b.callback.apply(<span class="keyword">this</span>,arguments)}),c.queue(<span class="string">"fx"</span>,<span class="keyword">function</span>(){c.dequeue()}),c.dequeue()})}}(jQuery),<span class="keyword">function</span>(a,b){a.effects.slide=<span class="keyword">function</span>(b){<span class="keyword">return</span> <span class="keyword">this</span>.queue(<span class="keyword">function</span>(){<span class="keyword">var</span> c=a(<span class="keyword">this</span>),d=[<span class="string">"position"</span>,<span class="string">"top"</span>,<span class="string">"bottom"</span>,<span class="string">"left"</span>,<span class="string">"right"</span>],e=a.effects.setMode(c,b.options.mode||<span class="string">"show"</span>),f=b.options.direction||<span class="string">"left"</span>;a.effects.save(c,d),c.show(),a.effects.createWrapper(c).css({overflow:<span class="string">"hidden"</span>});<span class="keyword">var</span> g=f==<span class="string">"up"</span>||f==<span class="string">"down"</span>?<span class="string">"top"</span>:<span class="string">"left"</span>,h=f==<span class="string">"up"</span>||f==<span class="string">"left"</span>?<span class="string">"pos"</span>:<span class="string">"neg"</span>,i=b.options.distance||(g==<span class="string">"top"</span>?c.outerHeight({margin:!<span class="number">0</span>}):c.outerWidth({margin:!<span class="number">0</span>}));e==<span class="string">"show"</span>&amp;&amp;c.css(g,h==<span class="string">"pos"</span>?isNaN(i)?<span class="string">"-"</span>+i:-i:i);<span class="keyword">var</span> j={};j[g]=(e==<span class="string">"show"</span>?h==<span class="string">"pos"</span>?<span class="string">"+="</span>:<span class="string">"-="</span>:h==<span class="string">"pos"</span>?<span class="string">"-="</span>:<span class="string">"+="</span>)+i,c.animate(j,{queue:!<span class="number">1</span>,duration:b.duration,easing:b.options.easing,complete:<span class="keyword">function</span>(){e==<span class="string">"hide"</span>&amp;&amp;c.hide(),a.effects.restore(c,d),a.effects.removeWrapper(c),b.callback&amp;&amp;b.callback.apply(<span class="keyword">this</span>,arguments),c.dequeue()}})})}}(jQuery),<span class="keyword">function</span>(a,b){a.effects.transfer=<span class="keyword">function</span>(b){<span class="keyword">return</span> <span class="keyword">this</span>.queue(<span class="keyword">function</span>(){<span class="keyword">var</span> c=a(<span class="keyword">this</span>),d=a(b.options.to),e=d.offset(),f={top:e.top,left:e.left,height:d.innerHeight(),width:d.innerWidth()},g=c.offset(),h=a(<span class="string">'&lt;div class="ui-effects-transfer"&gt;&lt;/div&gt;'</span>).appendTo(document.body).addClass(b.options.className).css({top:g.top,left:g.left,height:c.innerHeight(),width:c.innerWidth(),position:<span class="string">"absolute"</span>}).animate(f,b.duration,b.options.easing,<span class="keyword">function</span>(){h.remove(),b.callback&amp;&amp;b.callback.apply(c[<span class="number">0</span>],arguments),c.dequeue()})})}}(jQuery),<span class="keyword">function</span>(a,b){a.widget(<span class="string">"ui.accordion"</span>,{options:{active:<span class="number">0</span>,animated:<span class="string">"slide"</span>,autoHeight:!<span class="number">0</span>,clearStyle:!<span class="number">1</span>,collapsible:!<span class="number">1</span>,event:<span class="string">"click"</span>,fillSpace:!<span class="number">1</span>,header:<span class="string">"&gt; li &gt; :first-child,&gt; :not(li):even"</span>,icons:{header:<span class="string">"ui-icon-triangle-1-e"</span>,headerSelected:<span class="string">"ui-icon-triangle-1-s"</span>},navigation:!<span class="number">1</span>,navigationFilter:<span class="keyword">function</span>(){<span class="keyword">return</span> <span class="keyword">this</span>.href.toLowerCase()===location.href.toLowerCase()}},_create:<span class="keyword">function</span>(){<span class="keyword">var</span> b=<span class="keyword">this</span>,c=b.options;b.running=<span class="number">0</span>,b.element.addClass(<span class="string">"ui-accordion ui-widget ui-helper-reset"</span>).children(<span class="string">"li"</span>).addClass(<span class="string">"ui-accordion-li-fix"</span>),b.headers=b.element.find(c.header).addClass(<span class="string">"ui-accordion-header ui-helper-reset ui-state-default ui-corner-all"</span>).bind(<span class="string">"mouseenter.accordion"</span>,<span class="keyword">function</span>(){<span class="keyword">if</span>(c.disabled)<span class="keyword">return</span>;a(<span class="keyword">this</span>).addClass(<span class="string">"ui-state-hover"</span>)}).bind(<span class="string">"mouseleave.accordion"</span>,<span class="keyword">function</span>(){<span class="keyword">if</span>(c.disabled)<span class="keyword">return</span>;a(<span class="keyword">this</span>).removeClass(<span class="string">"ui-state-hover"</span>)}).bind(<span class="string">"focus.accordion"</span>,<span class="keyword">function</span>(){<span class="keyword">if</span>(c.disabled)<span class="keyword">return</span>;a(<span class="keyword">this</span>).addClass(<span class="string">"ui-state-focus"</span>)}).bind(<span class="string">"blur.accordion"</span>,<span class="keyword">function</span>(){<span class="keyword">if</span>(c.disabled)<span class="keyword">return</span>;a(<span class="keyword">this</span>).removeClass(<span class="string">"ui-state-focus"</span>)}),b.headers.next().addClass(<span class="string">"ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom"</span>);<span class="keyword">if</span>(c.navigation){<span class="keyword">var</span> d=b.element.find(<span class="string">"a"</span>).filter(c.navigationFilter).eq(<span class="number">0</span>);<span class="keyword">if</span>(d.length){<span class="keyword">var</span> e=d.closest(<span class="string">".ui-accordion-header"</span>);e.length?b.active=e:b.active=d.closest(<span class="string">".ui-accordion-content"</span>).prev()}}b.active=b._findActive(b.active||c.active).addClass(<span class="string">"ui-state-default ui-state-active"</span>).toggleClass(<span class="string">"ui-corner-all"</span>).toggleClass(<span class="string">"ui-corner-top"</span>),b.active.next().addClass(<span class="string">"ui-accordion-content-active"</span>),b._createIcons(),b.resize(),b.element.attr(<span class="string">"role"</span>,<span class="string">"tablist"</span>),b.headers.attr(<span class="string">"role"</span>,<span class="string">"tab"</span>).bind(<span class="string">"keydown.accordion"</span>,<span class="keyword">function</span>(a){<span class="keyword">return</span> b._keydown(a)}).next().attr(<span class="string">"role"</span>,<span class="string">"tabpanel"</span>),b.headers.not(b.active||<span class="string">""</span>).attr({<span class="string">"aria-expanded"</span>:<span class="string">"false"</span>,<span class="string">"aria-selected"</span>:<span class="string">"false"</span>,tabIndex:-<span class="number">1</span>}).next().hide(),b.active.length?b.active.attr({<span class="string">"aria-expanded"</span>:<span class="string">"true"</span>,<span class="string">"aria-selected"</span>:<span class="string">"true"</span>,tabIndex:<span class="number">0</span>}):b.headers.eq(<span class="number">0</span>).attr(<span class="string">"tabIndex"</span>,<span class="number">0</span>),a.browser.safari||b.headers.find(<span class="string">"a"</span>).attr(<span class="string">"tabIndex"</span>,-<span class="number">1</span>),c.event&amp;&amp;b.headers.bind(c.event.split(<span class="string">" "</span>).join(<span class="string">".accordion "</span>)+<span class="string">".accordion"</span>,<span class="keyword">function</span>(a){b._clickHandler.call(b,a,<span class="keyword">this</span>),a.preventDefault()})},_createIcons:<span class="keyword">function</span>(){<span class="keyword">var</span> b=<span class="keyword">this</span>.options;b.icons&amp;&amp;(a(<span class="string">"&lt;span&gt;&lt;/span&gt;"</span>).addClass(<span class="string">"ui-icon "</span>+b.icons.header).prependTo(<span class="keyword">this</span>.headers),<span class="keyword">this</span>.active.children(<span class="string">".ui-icon"</span>).toggleClass(b.icons.header).toggleClass(b.icons.headerSelected),<span class="keyword">this</span>.element.addClass(<span class="string">"ui-accordion-icons"</span>))},_destroyIcons:<span class="keyword">function</span>(){<span class="keyword">this</span>.headers.children(<span class="string">".ui-icon"</span>).remove(),<span class="keyword">this</span>.element.removeClass(<span class="string">"ui-accordion-icons"</span>)},destroy:<span class="keyword">function</span>(){<span class="keyword">var</span> b=<span class="keyword">this</span>.options;<span class="keyword">this</span>.element.removeClass(<span class="string">"ui-accordion ui-widget ui-helper-reset"</span>).removeAttr(<span class="string">"role"</span>),<span class="keyword">this</span>.headers.unbind(<span class="string">".accordion"</span>).removeClass(<span class="string">"ui-accordion-header ui-accordion-disabled ui-helper-reset ui-state-default ui-corner-all ui-state-active ui-state-disabled ui-corner-top"</span>).removeAttr(<span class="string">"role"</span>).removeAttr(<span class="string">"aria-expanded"</span>).removeAttr(<span class="string">"aria-selected"</span>).removeAttr(<span class="string">"tabIndex"</span>),<span class="keyword">this</span>.headers.find(<span class="string">"a"</span>).removeAttr(<span class="string">"tabIndex"</span>),<span class="keyword">this</span>._destroyIcons();<span class="keyword">var</span> c=<span class="keyword">this</span>.headers.next().css(<span class="string">"display"</span>,<span class="string">""</span>).removeAttr(<span class="string">"role"</span>).removeClass(<span class="string">"ui-helper-reset ui-widget-content ui-corner-bottom ui-accordion-content ui-accordion-content-active ui-accordion-disabled ui-state-disabled"</span>);<span class="keyword">return</span>(b.autoHeight||b.fillHeight)&amp;&amp;c.css(<span class="string">"height"</span>,<span class="string">""</span>),a.Widget.prototype.destroy.call(<span class="keyword">this</span>)},_setOption:<span class="keyword">function</span>(b,c){a.Widget.prototype._setOption.apply(<span class="keyword">this</span>,arguments),b==<span class="string">"active"</span>&amp;&amp;<span class="keyword">this</span>.activate(c),b==<span class="string">"icons"</span>&amp;&amp;(<span class="keyword">this</span>._destroyIcons(),c&amp;&amp;<span class="keyword">this</span>._createIcons()),b==<span class="string">"disabled"</span>&amp;&amp;<span class="keyword">this</span>.headers.add(<span class="keyword">this</span>.headers.next())[c?<span class="string">"addClass"</span>:<span class="string">"removeClass"</span>](<span class="string">"ui-accordion-disabled ui-state-disabled"</span>)},_keydown:<span class="keyword">function</span>(b){<span class="keyword">if</span>(<span class="keyword">this</span>.options.disabled||b.altKey||b.ctrlKey)<span class="keyword">return</span>;<span class="keyword">var</span> c=a.ui.keyCode,d=<span class="keyword">this</span>.headers.length,e=<span class="keyword">this</span>.headers.index(b.target),f=!<span class="number">1</span>;<span class="keyword">switch</span>(b.keyCode){<span class="keyword">case</span> c.RIGHT:<span class="keyword">case</span> c.DOWN:f=<span class="keyword">this</span>.headers[(e+<span class="number">1</span>)%d];<span class="keyword">break</span>;<span class="keyword">case</span> c.LEFT:<span class="keyword">case</span> c.UP:f=<span class="keyword">this</span>.headers[(e-<span class="number">1</span>+d)%d];<span class="keyword">break</span>;<span class="keyword">case</span> c.SPACE:<span class="keyword">case</span> c.ENTER:<span class="keyword">this</span>._clickHandler({target:b.target},b.target),b.preventDefault()}<span class="keyword">return</span> f?(a(b.target).attr(<span class="string">"tabIndex"</span>,-<span class="number">1</span>),a(f).attr(<span class="string">"tabIndex"</span>,<span class="number">0</span>),f.focus(),!<span class="number">1</span>):!<span class="number">0</span>},resize:<span class="keyword">function</span>(){<span class="keyword">var</span> b=<span class="keyword">this</span>.options,c;<span class="keyword">if</span>(b.fillSpace){<span class="keyword">if</span>(a.browser.msie){<span class="keyword">var</span> d=<span class="keyword">this</span>.element.parent().css(<span class="string">"overflow"</span>);<span class="keyword">this</span>.element.parent().css(<span class="string">"overflow"</span>,<span class="string">"hidden"</span>)}c=<span class="keyword">this</span>.element.parent().height(),a.browser.msie&amp;&amp;<span class="keyword">this</span>.element.parent().css(<span class="string">"overflow"</span>,d),<span class="keyword">this</span>.headers.each(<span class="keyword">function</span>(){c-=a(<span class="keyword">this</span>).outerHeight(!<span class="number">0</span>)}),<span class="keyword">this</span>.headers.next().each(<span class="keyword">function</span>(){a(<span class="keyword">this</span>).height(Math.max(<span class="number">0</span>,c-a(<span class="keyword">this</span>).innerHeight()+a(<span class="keyword">this</span>).height()))}).css(<span class="string">"overflow"</span>,<span class="string">"auto"</span>)}<span class="keyword">else</span> b.autoHeight&amp;&amp;(c=<span class="number">0</span>,<span class="keyword">this</span>.headers.next().each(<span class="keyword">function</span>(){c=Math.max(c,a(<span class="keyword">this</span>).height(<span class="string">""</span>).height())}).height(c));<span class="keyword">return</span> <span class="keyword">this</span>},activate:<span class="keyword">function</span>(a){<span class="keyword">this</span>.options.active=a;<span class="keyword">var</span> b=<span class="keyword">this</span>._findActive(a)[<span class="number">0</span>];<span class="keyword">return</span> <span class="keyword">this</span>._clickHandler({target:b},b),<span class="keyword">this</span>},_findActive:<span class="keyword">function</span>(b){<span class="keyword">return</span> b?<span class="keyword">typeof</span> b==<span class="string">"number"</span>?<span class="keyword">this</span>.headers.filter(<span class="string">":eq("</span>+b+<span class="string">")"</span>):<span class="keyword">this</span>.headers.not(<span class="keyword">this</span>.headers.not(b)):b===!<span class="number">1</span>?a([]):<span class="keyword">this</span>.headers.filter(<span class="string">":eq(0)"</span>)},_clickHandler:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=<span class="keyword">this</span>.options;<span class="keyword">if</span>(d.disabled)<span class="keyword">return</span>;<span class="keyword">if</span>(!b.target){<span class="keyword">if</span>(!d.collapsible)<span class="keyword">return</span>;<span class="keyword">this</span>.active.removeClass(<span class="string">"ui-state-active ui-corner-top"</span>).addClass(<span class="string">"ui-state-default ui-corner-all"</span>).children(<span class="string">".ui-icon"</span>).removeClass(d.icons.headerSelected).addClass(d.icons.header),<span class="keyword">this</span>.active.next().addClass(<span class="string">"ui-accordion-content-active"</span>);<span class="keyword">var</span> e=<span class="keyword">this</span>.active.next(),f={options:d,newHeader:a([]),oldHeader:d.active,newContent:a([]),oldContent:e},g=<span class="keyword">this</span>.active=a([]);<span class="keyword">this</span>._toggle(g,e,f);<span class="keyword">return</span>}<span class="keyword">var</span> h=a(b.currentTarget||c),i=h[<span class="number">0</span>]===<span class="keyword">this</span>.active[<span class="number">0</span>];d.active=d.collapsible&amp;&amp;i?!<span class="number">1</span>:<span class="keyword">this</span>.headers.index(h);<span class="keyword">if</span>(<span class="keyword">this</span>.running||!d.collapsible&amp;&amp;i)<span class="keyword">return</span>;<span class="keyword">var</span> j=<span class="keyword">this</span>.active,g=h.next(),e=<span class="keyword">this</span>.active.next(),f={options:d,newHeader:i&amp;&amp;d.collapsible?a([]):h,oldHeader:<span class="keyword">this</span>.active,newContent:i&amp;&amp;d.collapsible?a([]):g,oldContent:e},k=<span class="keyword">this</span>.headers.index(<span class="keyword">this</span>.active[<span class="number">0</span>])&gt;<span class="keyword">this</span>.headers.index(h[<span class="number">0</span>]);<span class="keyword">this</span>.active=i?a([]):h,<span class="keyword">this</span>._toggle(g,e,f,i,k),j.removeClass(<span class="string">"ui-state-active ui-corner-top"</span>).addClass(<span class="string">"ui-state-default ui-corner-all"</span>).children(<span class="string">".ui-icon"</span>).removeClass(d.icons.headerSelected).addClass(d.icons.header),i||(h.removeClass(<span class="string">"ui-state-default ui-corner-all"</span>).addClass(<span class="string">"ui-state-active ui-corner-top"</span>).children(<span class="string">".ui-icon"</span>).removeClass(d.icons.header).addClass(d.icons.headerSelected),h.next().addClass(<span class="string">"ui-accordion-content-active"</span>));<span class="keyword">return</span>},_toggle:<span class="keyword">function</span>(b,c,d,e,f){<span class="keyword">var</span> g=<span class="keyword">this</span>,h=g.options;g.toShow=b,g.toHide=c,g.data=d;<span class="keyword">var</span> i=<span class="keyword">function</span>(){<span class="keyword">if</span>(!g)<span class="keyword">return</span>;<span class="keyword">return</span> g._completed.apply(g,arguments)};g._trigger(<span class="string">"changestart"</span>,<span class="literal">null</span>,g.data),g.running=c.size()===<span class="number">0</span>?b.size():c.size();<span class="keyword">if</span>(h.animated){<span class="keyword">var</span> j={};h.collapsible&amp;&amp;e?j={toShow:a([]),toHide:c,complete:i,down:f,autoHeight:h.autoHeight||h.fillSpace}:j={toShow:b,toHide:c,complete:i,down:f,autoHeight:h.autoHeight||h.fillSpace},h.proxied||(h.proxied=h.animated),h.proxiedDuration||(h.proxiedDuration=h.duration),h.animated=a.isFunction(h.proxied)?h.proxied(j):h.proxied,h.duration=a.isFunction(h.proxiedDuration)?h.proxiedDuration(j):h.proxiedDuration;<span class="keyword">var</span> k=a.ui.accordion.animations,l=h.duration,m=h.animated;m&amp;&amp;!k[m]&amp;&amp;!a.easing[m]&amp;&amp;(m=<span class="string">"slide"</span>),k[m]||(k[m]=<span class="keyword">function</span>(a){<span class="keyword">this</span>.slide(a,{easing:m,duration:l||<span class="number">700</span>})}),k[m](j)}<span class="keyword">else</span> h.collapsible&amp;&amp;e?b.toggle():(c.hide(),b.show()),i(!<span class="number">0</span>);c.prev().attr({<span class="string">"aria-expanded"</span>:<span class="string">"false"</span>,<span class="string">"aria-selected"</span>:<span class="string">"false"</span>,tabIndex:-<span class="number">1</span>}).blur(),b.prev().attr({<span class="string">"aria-expanded"</span>:<span class="string">"true"</span>,<span class="string">"aria-selected"</span>:<span class="string">"true"</span>,tabIndex:<span class="number">0</span>}).focus()},_completed:<span class="keyword">function</span>(a){<span class="keyword">this</span>.running=a?<span class="number">0</span>:--<span class="keyword">this</span>.running;<span class="keyword">if</span>(<span class="keyword">this</span>.running)<span class="keyword">return</span>;<span class="keyword">this</span>.options.clearStyle&amp;&amp;<span class="keyword">this</span>.toShow.add(<span class="keyword">this</span>.toHide).css({height:<span class="string">""</span>,overflow:<span class="string">""</span>}),<span class="keyword">this</span>.toHide.removeClass(<span class="string">"ui-accordion-content-active"</span>),<span class="keyword">this</span>.toHide.length&amp;&amp;(<span class="keyword">this</span>.toHide.parent()[<span class="number">0</span>].className=<span class="keyword">this</span>.toHide.parent()[<span class="number">0</span>].className),<span class="keyword">this</span>._trigger(<span class="string">"change"</span>,<span class="literal">null</span>,<span class="keyword">this</span>.data)}}),a.extend(a.ui.accordion,{version:<span class="string">"1.8.21"</span>,animations:{slide:<span class="keyword">function</span>(b,c){b=a.extend({easing:<span class="string">"swing"</span>,duration:<span class="number">300</span>},b,c);<span class="keyword">if</span>(!b.toHide.size()){b.toShow.animate({height:<span class="string">"show"</span>,paddingTop:<span class="string">"show"</span>,paddingBottom:<span class="string">"show"</span>},b);<span class="keyword">return</span>}<span class="keyword">if</span>(!b.toShow.size()){b.toHide.animate({height:<span class="string">"hide"</span>,paddingTop:<span class="string">"hide"</span>,paddingBottom:<span class="string">"hide"</span>},b);<span class="keyword">return</span>}<span class="keyword">var</span> d=b.toShow.css(<span class="string">"overflow"</span>),e=<span class="number">0</span>,f={},g={},h=[<span class="string">"height"</span>,<span class="string">"paddingTop"</span>,<span class="string">"paddingBottom"</span>],i,j=b.toShow;i=j[<span class="number">0</span>].style.width,j.width(j.parent().width()-parseFloat(j.css(<span class="string">"paddingLeft"</span>))-parseFloat(j.css(<span class="string">"paddingRight"</span>))-(parseFloat(j.css(<span class="string">"borderLeftWidth"</span>))||<span class="number">0</span>)-(parseFloat(j.css(<span class="string">"borderRightWidth"</span>))||<span class="number">0</span>)),a.each(h,<span class="keyword">function</span>(c,d){g[d]=<span class="string">"hide"</span>;<span class="keyword">var</span> e=(<span class="string">""</span>+a.css(b.toShow[<span class="number">0</span>],d)).match(<span class="regexp">/^([\d+-.]+)(.*)$/</span>);f[d]={value:e[<span class="number">1</span>],unit:e[<span class="number">2</span>]||<span class="string">"px"</span>}}),b.toShow.css({height:<span class="number">0</span>,overflow:<span class="string">"hidden"</span>}).show(),b.toHide.filter(<span class="string">":hidden"</span>).each(b.complete).end().filter(<span class="string">":visible"</span>).animate(g,{step:<span class="keyword">function</span>(a,c){c.prop==<span class="string">"height"</span>&amp;&amp;(e=c.end-c.start===<span class="number">0</span>?<span class="number">0</span>:(c.now-c.start)/(c.end-c.start)),b.toShow[<span class="number">0</span>].style[c.prop]=e*f[c.prop].value+f[c.prop].unit},duration:b.duration,easing:b.easing,complete:<span class="keyword">function</span>(){b.autoHeight||b.toShow.css(<span class="string">"height"</span>,<span class="string">""</span>),b.toShow.css({width:i,overflow:d}),b.complete()}})},bounceslide:<span class="keyword">function</span>(a){<span class="keyword">this</span>.slide(a,{easing:a.down?<span class="string">"easeOutBounce"</span>:<span class="string">"swing"</span>,duration:a.down?<span class="number">1e3</span>:<span class="number">200</span>})}}})}(jQuery),<span class="keyword">function</span>(a,b){<span class="keyword">var</span> c=<span class="number">0</span>;a.widget(<span class="string">"ui.autocomplete"</span>,{options:{appendTo:<span class="string">"body"</span>,autoFocus:!<span class="number">1</span>,delay:<span class="number">300</span>,minLength:<span class="number">1</span>,position:{my:<span class="string">"left top"</span>,at:<span class="string">"left bottom"</span>,collision:<span class="string">"none"</span>},source:<span class="literal">null</span>},pending:<span class="number">0</span>,_create:<span class="keyword">function</span>(){<span class="keyword">var</span> b=<span class="keyword">this</span>,c=<span class="keyword">this</span>.element[<span class="number">0</span>].ownerDocument,d;<span class="keyword">this</span>.isMultiLine=<span class="keyword">this</span>.element.is(<span class="string">"textarea"</span>),<span class="keyword">this</span>.element.addClass(<span class="string">"ui-autocomplete-input"</span>).attr(<span class="string">"autocomplete"</span>,<span class="string">"off"</span>).attr({role:<span class="string">"textbox"</span>,<span class="string">"aria-autocomplete"</span>:<span class="string">"list"</span>,<span class="string">"aria-haspopup"</span>:<span class="string">"true"</span>}).bind(<span class="string">"keydown.autocomplete"</span>,<span class="keyword">function</span>(c){<span class="keyword">if</span>(b.options.disabled||b.element.propAttr(<span class="string">"readOnly"</span>))<span class="keyword">return</span>;d=!<span class="number">1</span>;<span class="keyword">var</span> e=a.ui.keyCode;<span class="keyword">switch</span>(c.keyCode){<span class="keyword">case</span> e.PAGE_UP:b._move(<span class="string">"previousPage"</span>,c);<span class="keyword">break</span>;<span class="keyword">case</span> e.PAGE_DOWN:b._move(<span class="string">"nextPage"</span>,c);<span class="keyword">break</span>;<span class="keyword">case</span> e.UP:b._keyEvent(<span class="string">"previous"</span>,c);<span class="keyword">break</span>;<span class="keyword">case</span> e.DOWN:b._keyEvent(<span class="string">"next"</span>,c);<span class="keyword">break</span>;<span class="keyword">case</span> e.ENTER:<span class="keyword">case</span> e.NUMPAD_ENTER:b.menu.active&amp;&amp;(d=!<span class="number">0</span>,c.preventDefault());<span class="keyword">case</span> e.TAB:<span class="keyword">if</span>(!b.menu.active)<span class="keyword">return</span>;b.menu.select(c);<span class="keyword">break</span>;<span class="keyword">case</span> e.ESCAPE:b.element.val(b.term),b.close(c);<span class="keyword">break</span>;<span class="keyword">default</span>:clearTimeout(b.searching),b.searching=setTimeout(<span class="keyword">function</span>(){b.term!=b.element.val()&amp;&amp;(b.selectedItem=<span class="literal">null</span>,b.search(<span class="literal">null</span>,c))},b.options.delay)}}).bind(<span class="string">"keypress.autocomplete"</span>,<span class="keyword">function</span>(a){d&amp;&amp;(d=!<span class="number">1</span>,a.preventDefault())}).bind(<span class="string">"focus.autocomplete"</span>,<span class="keyword">function</span>(){<span class="keyword">if</span>(b.options.disabled)<span class="keyword">return</span>;b.selectedItem=<span class="literal">null</span>,b.previous=b.element.val()}).bind(<span class="string">"blur.autocomplete"</span>,<span class="keyword">function</span>(a){<span class="keyword">if</span>(b.options.disabled)<span class="keyword">return</span>;clearTimeout(b.searching),b.closing=setTimeout(<span class="keyword">function</span>(){b.close(a),b._change(a)},<span class="number">150</span>)}),<span class="keyword">this</span>._initSource(),<span class="keyword">this</span>.menu=a(<span class="string">"&lt;ul&gt;&lt;/ul&gt;"</span>).addClass(<span class="string">"ui-autocomplete"</span>).appendTo(a(<span class="keyword">this</span>.options.appendTo||<span class="string">"body"</span>,c)[<span class="number">0</span>]).mousedown(<span class="keyword">function</span>(c){<span class="keyword">var</span> d=b.menu.element[<span class="number">0</span>];a(c.target).closest(<span class="string">".ui-menu-item"</span>).length||setTimeout(<span class="keyword">function</span>(){a(document).one(<span class="string">"mousedown"</span>,<span class="keyword">function</span>(c){c.target!==b.element[<span class="number">0</span>]&amp;&amp;c.target!==d&amp;&amp;!a.ui.contains(d,c.target)&amp;&amp;b.close()})},<span class="number">1</span>),setTimeout(<span class="keyword">function</span>(){clearTimeout(b.closing)},<span class="number">13</span>)}).menu({focus:<span class="keyword">function</span>(a,c){<span class="keyword">var</span> d=c.item.data(<span class="string">"item.autocomplete"</span>);!<span class="number">1</span>!==b._trigger(<span class="string">"focus"</span>,a,{item:d})&amp;&amp;<span class="regexp">/^key/</span>.test(a.originalEvent.type)&amp;&amp;b.element.val(d.value)},selected:<span class="keyword">function</span>(a,d){<span class="keyword">var</span> e=d.item.data(<span class="string">"item.autocomplete"</span>),f=b.previous;b.element[<span class="number">0</span>]!==c.activeElement&amp;&amp;(b.element.focus(),b.previous=f,setTimeout(<span class="keyword">function</span>(){b.previous=f,b.selectedItem=e},<span class="number">1</span>)),!<span class="number">1</span>!==b._trigger(<span class="string">"select"</span>,a,{item:e})&amp;&amp;b.element.val(e.value),b.term=b.element.val(),b.close(a),b.selectedItem=e},blur:<span class="keyword">function</span>(a,c){b.menu.element.is(<span class="string">":visible"</span>)&amp;&amp;b.element.val()!==b.term&amp;&amp;b.element.val(b.term)}}).zIndex(<span class="keyword">this</span>.element.zIndex()+<span class="number">1</span>).css({top:<span class="number">0</span>,left:<span class="number">0</span>}).hide().data(<span class="string">"menu"</span>),a.fn.bgiframe&amp;&amp;<span class="keyword">this</span>.menu.element.bgiframe(),b.beforeunloadHandler=<span class="keyword">function</span>(){b.element.removeAttr(<span class="string">"autocomplete"</span>)},a(window).bind(<span class="string">"beforeunload"</span>,b.beforeunloadHandler)},destroy:<span class="keyword">function</span>(){<span class="keyword">this</span>.element.removeClass(<span class="string">"ui-autocomplete-input"</span>).removeAttr(<span class="string">"autocomplete"</span>).removeAttr(<span class="string">"role"</span>).removeAttr(<span class="string">"aria-autocomplete"</span>).removeAttr(<span class="string">"aria-haspopup"</span>),<span class="keyword">this</span>.menu.element.remove(),a(window).unbind(<span class="string">"beforeunload"</span>,<span class="keyword">this</span>.beforeunloadHandler),a.Widget.prototype.destroy.call(<span class="keyword">this</span>)},_setOption:<span class="keyword">function</span>(b,c){a.Widget.prototype._setOption.apply(<span class="keyword">this</span>,arguments),b===<span class="string">"source"</span>&amp;&amp;<span class="keyword">this</span>._initSource(),b===<span class="string">"appendTo"</span>&amp;&amp;<span class="keyword">this</span>.menu.element.appendTo(a(c||<span class="string">"body"</span>,<span class="keyword">this</span>.element[<span class="number">0</span>].ownerDocument)[<span class="number">0</span>]),b===<span class="string">"disabled"</span>&amp;&amp;c&amp;&amp;<span class="keyword">this</span>.xhr&amp;&amp;<span class="keyword">this</span>.xhr.abort()},_initSource:<span class="keyword">function</span>(){<span class="keyword">var</span> b=<span class="keyword">this</span>,c,d;a.isArray(<span class="keyword">this</span>.options.source)?(c=<span class="keyword">this</span>.options.source,<span class="keyword">this</span>.source=<span class="keyword">function</span>(b,d){d(a.ui.autocomplete.filter(c,b.term))}):<span class="keyword">typeof</span> <span class="keyword">this</span>.options.source==<span class="string">"string"</span>?(d=<span class="keyword">this</span>.options.source,<span class="keyword">this</span>.source=<span class="keyword">function</span>(c,e){b.xhr&amp;&amp;b.xhr.abort(),b.xhr=a.ajax({url:d,data:c,dataType:<span class="string">"json"</span>,success:<span class="keyword">function</span>(a,b){e(a)},error:<span class="keyword">function</span>(){e([])}})}):<span class="keyword">this</span>.source=<span class="keyword">this</span>.options.source},search:<span class="keyword">function</span>(a,b){a=a!=<span class="literal">null</span>?a:<span class="keyword">this</span>.element.val(),<span class="keyword">this</span>.term=<span class="keyword">this</span>.element.val();<span class="keyword">if</span>(a.length&lt;<span class="keyword">this</span>.options.minLength)<span class="keyword">return</span> <span class="keyword">this</span>.close(b);clearTimeout(<span class="keyword">this</span>.closing);<span class="keyword">if</span>(<span class="keyword">this</span>._trigger(<span class="string">"search"</span>,b)===!<span class="number">1</span>)<span class="keyword">return</span>;<span class="keyword">return</span> <span class="keyword">this</span>._search(a)},_search:<span class="keyword">function</span>(a){<span class="keyword">this</span>.pending++,<span class="keyword">this</span>.element.addClass(<span class="string">"ui-autocomplete-loading"</span>),<span class="keyword">this</span>.source({term:a},<span class="keyword">this</span>._response())},_response:<span class="keyword">function</span>(){<span class="keyword">var</span> a=<span class="keyword">this</span>,b=++c;<span class="keyword">return</span> <span class="keyword">function</span>(d){b===c&amp;&amp;a.__response(d),a.pending--,a.pending||a.element.removeClass(<span class="string">"ui-autocomplete-loading"</span>)}},__response:<span class="keyword">function</span>(a){!<span class="keyword">this</span>.options.disabled&amp;&amp;a&amp;&amp;a.length?(a=<span class="keyword">this</span>._normalize(a),<span class="keyword">this</span>._suggest(a),<span class="keyword">this</span>._trigger(<span class="string">"open"</span>)):<span class="keyword">this</span>.close()},close:<span class="keyword">function</span>(a){clearTimeout(<span class="keyword">this</span>.closing),<span class="keyword">this</span>.menu.element.is(<span class="string">":visible"</span>)&amp;&amp;(<span class="keyword">this</span>.menu.element.hide(),<span class="keyword">this</span>.menu.deactivate(),<span class="keyword">this</span>._trigger(<span class="string">"close"</span>,a))},_change:<span class="keyword">function</span>(a){<span class="keyword">this</span>.previous!==<span class="keyword">this</span>.element.val()&amp;&amp;<span class="keyword">this</span>._trigger(<span class="string">"change"</span>,a,{item:<span class="keyword">this</span>.selectedItem})},_normalize:<span class="keyword">function</span>(b){<span class="keyword">return</span> b.length&amp;&amp;b[<span class="number">0</span>].label&amp;&amp;b[<span class="number">0</span>].value?b:a.map(b,<span class="keyword">function</span>(b){<span class="keyword">return</span> <span class="keyword">typeof</span> b==<span class="string">"string"</span>?{label:b,value:b}:a.extend({label:b.label||b.value,value:b.value||b.label},b)})},_suggest:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=<span class="keyword">this</span>.menu.element.empty().zIndex(<span class="keyword">this</span>.element.zIndex()+<span class="number">1</span>);<span class="keyword">this</span>._renderMenu(c,b),<span class="keyword">this</span>.menu.deactivate(),<span class="keyword">this</span>.menu.refresh(),c.show(),<span class="keyword">this</span>._resizeMenu(),c.position(a.extend({of:<span class="keyword">this</span>.element},<span class="keyword">this</span>.options.position)),<span class="keyword">this</span>.options.autoFocus&amp;&amp;<span class="keyword">this</span>.menu.next(<span class="keyword">new</span> a.Event(<span class="string">"mouseover"</span>))},_resizeMenu:<span class="keyword">function</span>(){<span class="keyword">var</span> a=<span class="keyword">this</span>.menu.element;a.outerWidth(Math.max(a.width(<span class="string">""</span>).outerWidth()+<span class="number">1</span>,<span class="keyword">this</span>.element.outerWidth()))},_renderMenu:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=<span class="keyword">this</span>;a.each(c,<span class="keyword">function</span>(a,c){d._renderItem(b,c)})},_renderItem:<span class="keyword">function</span>(b,c){<span class="keyword">return</span> a(<span class="string">"&lt;li&gt;&lt;/li&gt;"</span>).data(<span class="string">"item.autocomplete"</span>,c).append(a(<span class="string">"&lt;a&gt;&lt;/a&gt;"</span>).text(c.label)).appendTo(b)},_move:<span class="keyword">function</span>(a,b){<span class="keyword">if</span>(!<span class="keyword">this</span>.menu.element.is(<span class="string">":visible"</span>)){<span class="keyword">this</span>.search(<span class="literal">null</span>,b);<span class="keyword">return</span>}<span class="keyword">if</span>(<span class="keyword">this</span>.menu.first()&amp;&amp;<span class="regexp">/^previous/</span>.test(a)||<span class="keyword">this</span>.menu.last()&amp;&amp;<span class="regexp">/^next/</span>.test(a)){<span class="keyword">this</span>.element.val(<span class="keyword">this</span>.term),<span class="keyword">this</span>.menu.deactivate();<span class="keyword">return</span>}<span class="keyword">this</span>.menu[a](b)},widget:<span class="keyword">function</span>(){<span class="keyword">return</span> <span class="keyword">this</span>.menu.element},_keyEvent:<span class="keyword">function</span>(a,b){<span class="keyword">if</span>(!<span class="keyword">this</span>.isMultiLine||<span class="keyword">this</span>.menu.element.is(<span class="string">":visible"</span>))<span class="keyword">this</span>._move(a,b),b.preventDefault()}}),a.extend(a.ui.autocomplete,{escapeRegex:<span class="keyword">function</span>(a){<span class="keyword">return</span> a.replace(<span class="regexp">/[-[\]{}()*+?.,\\^$|#\s]/g</span>,<span class="string">"\\$&amp;"</span>)},filter:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=<span class="keyword">new</span> RegExp(a.ui.autocomplete.escapeRegex(c),<span class="string">"i"</span>);<span class="keyword">return</span> a.grep(b,<span class="keyword">function</span>(a){<span class="keyword">return</span> d.test(a.label||a.value||a)})}})}(jQuery),<span class="keyword">function</span>(a){a.widget(<span class="string">"ui.menu"</span>,{_create:<span class="keyword">function</span>(){<span class="keyword">var</span> b=<span class="keyword">this</span>;<span class="keyword">this</span>.element.addClass(<span class="string">"ui-menu ui-widget ui-widget-content ui-corner-all"</span>).attr({role:<span class="string">"listbox"</span>,<span class="string">"aria-activedescendant"</span>:<span class="string">"ui-active-menuitem"</span>}).click(<span class="keyword">function</span>(c){<span class="keyword">if</span>(!a(c.target).closest(<span class="string">".ui-menu-item a"</span>).length)<span class="keyword">return</span>;c.preventDefault(),b.select(c)}),<span class="keyword">this</span>.refresh()},refresh:<span class="keyword">function</span>(){<span class="keyword">var</span> b=<span class="keyword">this</span>,c=<span class="keyword">this</span>.element.children(<span class="string">"li:not(.ui-menu-item):has(a)"</span>).addClass(<span class="string">"ui-menu-item"</span>).attr(<span class="string">"role"</span>,<span class="string">"menuitem"</span>);c.children(<span class="string">"a"</span>).addClass(<span class="string">"ui-corner-all"</span>).attr(<span class="string">"tabindex"</span>,-<span class="number">1</span>).mouseenter(<span class="keyword">function</span>(c){b.activate(c,a(<span class="keyword">this</span>).parent())}).mouseleave(<span class="keyword">function</span>(){b.deactivate()})},activate:<span class="keyword">function</span>(a,b){<span class="keyword">this</span>.deactivate();<span class="keyword">if</span>(<span class="keyword">this</span>.hasScroll()){<span class="keyword">var</span> c=b.offset().top-<span class="keyword">this</span>.element.offset().top,d=<span class="keyword">this</span>.element.scrollTop(),e=<span class="keyword">this</span>.element.height();c&lt;<span class="number">0</span>?<span class="keyword">this</span>.element.scrollTop(d+c):c&gt;=e&amp;&amp;<span class="keyword">this</span>.element.scrollTop(d+c-e+b.height())}<span class="keyword">this</span>.active=b.eq(<span class="number">0</span>).children(<span class="string">"a"</span>).addClass(<span class="string">"ui-state-hover"</span>).attr(<span class="string">"id"</span>,<span class="string">"ui-active-menuitem"</span>).end(),<span class="keyword">this</span>._trigger(<span class="string">"focus"</span>,a,{item:b})},deactivate:<span class="keyword">function</span>(){<span class="keyword">if</span>(!<span class="keyword">this</span>.active)<span class="keyword">return</span>;<span class="keyword">this</span>.active.children(<span class="string">"a"</span>).removeClass(<span class="string">"ui-state-hover"</span>).removeAttr(<span class="string">"id"</span>),<span class="keyword">this</span>._trigger(<span class="string">"blur"</span>),<span class="keyword">this</span>.active=<span class="literal">null</span>},next:<span class="keyword">function</span>(a){<span class="keyword">this</span>.move(<span class="string">"next"</span>,<span class="string">".ui-menu-item:first"</span>,a)},previous:<span class="keyword">function</span>(a){<span class="keyword">this</span>.move(<span class="string">"prev"</span>,<span class="string">".ui-menu-item:last"</span>,a)},first:<span class="keyword">function</span>(){<span class="keyword">return</span> <span class="keyword">this</span>.active&amp;&amp;!<span class="keyword">this</span>.active.prevAll(<span class="string">".ui-menu-item"</span>).length},last:<span class="keyword">function</span>(){<span class="keyword">return</span> <span class="keyword">this</span>.active&amp;&amp;!<span class="keyword">this</span>.active.nextAll(<span class="string">".ui-menu-item"</span>).length},move:<span class="keyword">function</span>(a,b,c){<span class="keyword">if</span>(!<span class="keyword">this</span>.active){<span class="keyword">this</span>.activate(c,<span class="keyword">this</span>.element.children(b));<span class="keyword">return</span>}<span class="keyword">var</span> d=<span class="keyword">this</span>.active[a+<span class="string">"All"</span>](<span class="string">".ui-menu-item"</span>).eq(<span class="number">0</span>);d.length?<span class="keyword">this</span>.activate(c,d):<span class="keyword">this</span>.activate(c,<span class="keyword">this</span>.element.children(b))},nextPage:<span class="keyword">function</span>(b){<span class="keyword">if</span>(<span class="keyword">this</span>.hasScroll()){<span class="keyword">if</span>(!<span class="keyword">this</span>.active||<span class="keyword">this</span>.last()){<span class="keyword">this</span>.activate(b,<span class="keyword">this</span>.element.children(<span class="string">".ui-menu-item:first"</span>));<span class="keyword">return</span>}<span class="keyword">var</span> c=<span class="keyword">this</span>.active.offset().top,d=<span class="keyword">this</span>.element.height(),e=<span class="keyword">this</span>.element.children(<span class="string">".ui-menu-item"</span>).filter(<span class="keyword">function</span>(){<span class="keyword">var</span> b=a(<span class="keyword">this</span>).offset().top-c-d+a(<span class="keyword">this</span>).height();<span class="keyword">return</span> b&lt;<span class="number">10</span>&amp;&amp;b&gt;-<span class="number">10</span>});e.length||(e=<span class="keyword">this</span>.element.children(<span class="string">".ui-menu-item:last"</span>)),<span class="keyword">this</span>.activate(b,e)}<span class="keyword">else</span> <span class="keyword">this</span>.activate(b,<span class="keyword">this</span>.element.children(<span class="string">".ui-menu-item"</span>).filter(!<span class="keyword">this</span>.active||<span class="keyword">this</span>.last()?<span class="string">":first"</span>:<span class="string">":last"</span>))},previousPage:<span class="keyword">function</span>(b){<span class="keyword">if</span>(<span class="keyword">this</span>.hasScroll()){<span class="keyword">if</span>(!<span class="keyword">this</span>.active||<span class="keyword">this</span>.first()){<span class="keyword">this</span>.activate(b,<span class="keyword">this</span>.element.children(<span class="string">".ui-menu-item:last"</span>));<span class="keyword">return</span>}<span class="keyword">var</span> c=<span class="keyword">this</span>.active.offset().top,d=<span class="keyword">this</span>.element.height(),e=<span class="keyword">this</span>.element.children(<span class="string">".ui-menu-item"</span>).filter(<span class="keyword">function</span>(){<span class="keyword">var</span> b=a(<span class="keyword">this</span>).offset().top-c+d-a(<span class="keyword">this</span>).height();<span class="keyword">return</span> b&lt;<span class="number">10</span>&amp;&amp;b&gt;-<span class="number">10</span>});e.length||(e=<span class="keyword">this</span>.element.children(<span class="string">".ui-menu-item:first"</span>)),<span class="keyword">this</span>.activate(b,e)}<span class="keyword">else</span> <span class="keyword">this</span>.activate(b,<span class="keyword">this</span>.element.children(<span class="string">".ui-menu-item"</span>).filter(!<span class="keyword">this</span>.active||<span class="keyword">this</span>.first()?<span class="string">":last"</span>:<span class="string">":first"</span>))},hasScroll:<span class="keyword">function</span>(){<span class="keyword">return</span> <span class="keyword">this</span>.element.height()&lt;<span class="keyword">this</span>.element[a.fn.prop?<span class="string">"prop"</span>:<span class="string">"attr"</span>](<span class="string">"scrollHeight"</span>)},select:<span class="keyword">function</span>(a){<span class="keyword">this</span>._trigger(<span class="string">"selected"</span>,a,{item:<span class="keyword">this</span>.active})}})}(jQuery),<span class="keyword">function</span>(a,b){<span class="keyword">var</span> c,d,e,f,g=<span class="string">"ui-button ui-widget ui-state-default ui-corner-all"</span>,h=<span class="string">"ui-state-hover ui-state-active "</span>,i=<span class="string">"ui-button-icons-only ui-button-icon-only ui-button-text-icons ui-button-text-icon-primary ui-button-text-icon-secondary ui-button-text-only"</span>,j=<span class="keyword">function</span>(){<span class="keyword">var</span> b=a(<span class="keyword">this</span>).find(<span class="string">":ui-button"</span>);setTimeout(<span class="keyword">function</span>(){b.button(<span class="string">"refresh"</span>)},<span class="number">1</span>)},k=<span class="keyword">function</span>(b){<span class="keyword">var</span> c=b.name,d=b.form,e=a([]);<span class="keyword">return</span> c&amp;&amp;(d?e=a(d).find(<span class="string">"[name='"</span>+c+<span class="string">"']"</span>):e=a(<span class="string">"[name='"</span>+c+<span class="string">"']"</span>,b.ownerDocument).filter(<span class="keyword">function</span>(){<span class="keyword">return</span>!<span class="keyword">this</span>.form})),e};a.widget(<span class="string">"ui.button"</span>,{options:{disabled:<span class="literal">null</span>,text:!<span class="number">0</span>,label:<span class="literal">null</span>,icons:{primary:<span class="literal">null</span>,secondary:<span class="literal">null</span>}},_create:<span class="keyword">function</span>(){<span class="keyword">this</span>.element.closest(<span class="string">"form"</span>).unbind(<span class="string">"reset.button"</span>).bind(<span class="string">"reset.button"</span>,j),<span class="keyword">typeof</span> <span class="keyword">this</span>.options.disabled!=<span class="string">"boolean"</span>?<span class="keyword">this</span>.options.disabled=!!<span class="keyword">this</span>.element.propAttr(<span class="string">"disabled"</span>):<span class="keyword">this</span>.element.propAttr(<span class="string">"disabled"</span>,<span class="keyword">this</span>.options.disabled),<span class="keyword">this</span>._determineButtonType(),<span class="keyword">this</span>.hasTitle=!!<span class="keyword">this</span>.buttonElement.attr(<span class="string">"title"</span>);<span class="keyword">var</span> b=<span class="keyword">this</span>,h=<span class="keyword">this</span>.options,i=<span class="keyword">this</span>.type===<span class="string">"checkbox"</span>||<span class="keyword">this</span>.type===<span class="string">"radio"</span>,l=<span class="string">"ui-state-hover"</span>+(i?<span class="string">""</span>:<span class="string">" ui-state-active"</span>),m=<span class="string">"ui-state-focus"</span>;h.label===<span class="literal">null</span>&amp;&amp;(h.label=<span class="keyword">this</span>.buttonElement.html()),<span class="keyword">this</span>.buttonElement.addClass(g).attr(<span class="string">"role"</span>,<span class="string">"button"</span>).bind(<span class="string">"mouseenter.button"</span>,<span class="keyword">function</span>(){<span class="keyword">if</span>(h.disabled)<span class="keyword">return</span>;a(<span class="keyword">this</span>).addClass(<span class="string">"ui-state-hover"</span>),<span class="keyword">this</span>===c&amp;&amp;a(<span class="keyword">this</span>).addClass(<span class="string">"ui-state-active"</span>)}).bind(<span class="string">"mouseleave.button"</span>,<span class="keyword">function</span>(){<span class="keyword">if</span>(h.disabled)<span class="keyword">return</span>;a(<span class="keyword">this</span>).removeClass(l)}).bind(<span class="string">"click.button"</span>,<span class="keyword">function</span>(a){h.disabled&amp;&amp;(a.preventDefault(),a.stopImmediatePropagation())}),<span class="keyword">this</span>.element.bind(<span class="string">"focus.button"</span>,<span class="keyword">function</span>(){b.buttonElement.addClass(m)}).bind(<span class="string">"blur.button"</span>,<span class="keyword">function</span>(){b.buttonElement.removeClass(m)}),i&amp;&amp;(<span class="keyword">this</span>.element.bind(<span class="string">"change.button"</span>,<span class="keyword">function</span>(){<span class="keyword">if</span>(f)<span class="keyword">return</span>;b.refresh()}),<span class="keyword">this</span>.buttonElement.bind(<span class="string">"mousedown.button"</span>,<span class="keyword">function</span>(a){<span class="keyword">if</span>(h.disabled)<span class="keyword">return</span>;f=!<span class="number">1</span>,d=a.pageX,e=a.pageY}).bind(<span class="string">"mouseup.button"</span>,<span class="keyword">function</span>(a){<span class="keyword">if</span>(h.disabled)<span class="keyword">return</span>;<span class="keyword">if</span>(d!==a.pageX||e!==a.pageY)f=!<span class="number">0</span>})),<span class="keyword">this</span>.type===<span class="string">"checkbox"</span>?<span class="keyword">this</span>.buttonElement.bind(<span class="string">"click.button"</span>,<span class="keyword">function</span>(){<span class="keyword">if</span>(h.disabled||f)<span class="keyword">return</span>!<span class="number">1</span>;a(<span class="keyword">this</span>).toggleClass(<span class="string">"ui-state-active"</span>),b.buttonElement.attr(<span class="string">"aria-pressed"</span>,b.element[<span class="number">0</span>].checked)}):<span class="keyword">this</span>.type===<span class="string">"radio"</span>?<span class="keyword">this</span>.buttonElement.bind(<span class="string">"click.button"</span>,<span class="keyword">function</span>(){<span class="keyword">if</span>(h.disabled||f)<span class="keyword">return</span>!<span class="number">1</span>;a(<span class="keyword">this</span>).addClass(<span class="string">"ui-state-active"</span>),b.buttonElement.attr(<span class="string">"aria-pressed"</span>,<span class="string">"true"</span>);<span class="keyword">var</span> c=b.element[<span class="number">0</span>];k(c).not(c).map(<span class="keyword">function</span>(){<span class="keyword">return</span> a(<span class="keyword">this</span>).button(<span class="string">"widget"</span>)[<span class="number">0</span>]}).removeClass(<span class="string">"ui-state-active"</span>).attr(<span class="string">"aria-pressed"</span>,<span class="string">"false"</span>)}):(<span class="keyword">this</span>.buttonElement.bind(<span class="string">"mousedown.button"</span>,<span class="keyword">function</span>(){<span class="keyword">if</span>(h.disabled)<span class="keyword">return</span>!<span class="number">1</span>;a(<span class="keyword">this</span>).addClass(<span class="string">"ui-state-active"</span>),c=<span class="keyword">this</span>,a(document).one(<span class="string">"mouseup"</span>,<span class="keyword">function</span>(){c=<span class="literal">null</span>})}).bind(<span class="string">"mouseup.button"</span>,<span class="keyword">function</span>(){<span class="keyword">if</span>(h.disabled)<span class="keyword">return</span>!<span class="number">1</span>;a(<span class="keyword">this</span>).removeClass(<span class="string">"ui-state-active"</span>)}).bind(<span class="string">"keydown.button"</span>,<span class="keyword">function</span>(b){<span class="keyword">if</span>(h.disabled)<span class="keyword">return</span>!<span class="number">1</span>;(b.keyCode==a.ui.keyCode.SPACE||b.keyCode==a.ui.keyCode.ENTER)&amp;&amp;a(<span class="keyword">this</span>).addClass(<span class="string">"ui-state-active"</span>)}).bind(<span class="string">"keyup.button"</span>,<span class="keyword">function</span>(){a(<span class="keyword">this</span>).removeClass(<span class="string">"ui-state-active"</span>)}),<span class="keyword">this</span>.buttonElement.is(<span class="string">"a"</span>)&amp;&amp;<span class="keyword">this</span>.buttonElement.keyup(<span class="keyword">function</span>(b){b.keyCode===a.ui.keyCode.SPACE&amp;&amp;a(<span class="keyword">this</span>).click()})),<span class="keyword">this</span>._setOption(<span class="string">"disabled"</span>,h.disabled),<span class="keyword">this</span>._resetButton()},_determineButtonType:<span class="keyword">function</span>(){<span class="keyword">this</span>.element.is(<span class="string">":checkbox"</span>)?<span class="keyword">this</span>.type=<span class="string">"checkbox"</span>:<span class="keyword">this</span>.element.is(<span class="string">":radio"</span>)?<span class="keyword">this</span>.type=<span class="string">"radio"</span>:<span class="keyword">this</span>.element.is(<span class="string">"input"</span>)?<span class="keyword">this</span>.type=<span class="string">"input"</span>:<span class="keyword">this</span>.type=<span class="string">"button"</span>;<span class="keyword">if</span>(<span class="keyword">this</span>.type===<span class="string">"checkbox"</span>||<span class="keyword">this</span>.type===<span class="string">"radio"</span>){<span class="keyword">var</span> a=<span class="keyword">this</span>.element.parents().filter(<span class="string">":last"</span>),b=<span class="string">"label[for='"</span>+<span class="keyword">this</span>.element.attr(<span class="string">"id"</span>)+<span class="string">"']"</span>;<span class="keyword">this</span>.buttonElement=a.find(b),<span class="keyword">this</span>.buttonElement.length||(a=a.length?a.siblings():<span class="keyword">this</span>.element.siblings(),<span class="keyword">this</span>.buttonElement=a.filter(b),<span class="keyword">this</span>.buttonElement.length||(<span class="keyword">this</span>.buttonElement=a.find(b))),<span class="keyword">this</span>.element.addClass(<span class="string">"ui-helper-hidden-accessible"</span>);<span class="keyword">var</span> c=<span class="keyword">this</span>.element.is(<span class="string">":checked"</span>);c&amp;&amp;<span class="keyword">this</span>.buttonElement.addClass(<span class="string">"ui-state-active"</span>),<span class="keyword">this</span>.buttonElement.attr(<span class="string">"aria-pressed"</span>,c)}<span class="keyword">else</span> <span class="keyword">this</span>.buttonElement=<span class="keyword">this</span>.element},widget:<span class="keyword">function</span>(){<span class="keyword">return</span> <span class="keyword">this</span>.buttonElement},destroy:<span class="keyword">function</span>(){<span class="keyword">this</span>.element.removeClass(<span class="string">"ui-helper-hidden-accessible"</span>),<span class="keyword">this</span>.buttonElement.removeClass(g+<span class="string">" "</span>+h+<span class="string">" "</span>+i).removeAttr(<span class="string">"role"</span>).removeAttr(<span class="string">"aria-pressed"</span>).html(<span class="keyword">this</span>.buttonElement.find(<span class="string">".ui-button-text"</span>).html()),<span class="keyword">this</span>.hasTitle||<span class="keyword">this</span>.buttonElement.removeAttr(<span class="string">"title"</span>),a.Widget.prototype.destroy.call(<span class="keyword">this</span>)},_setOption:<span class="keyword">function</span>(b,c){a.Widget.prototype._setOption.apply(<span class="keyword">this</span>,arguments);<span class="keyword">if</span>(b===<span class="string">"disabled"</span>){c?<span class="keyword">this</span>.element.propAttr(<span class="string">"disabled"</span>,!<span class="number">0</span>):<span class="keyword">this</span>.element.propAttr(<span class="string">"disabled"</span>,!<span class="number">1</span>);<span class="keyword">return</span>}<span class="keyword">this</span>._resetButton()},refresh:<span class="keyword">function</span>(){<span class="keyword">var</span> b=<span class="keyword">this</span>.element.is(<span class="string">":disabled"</span>);b!==<span class="keyword">this</span>.options.disabled&amp;&amp;<span class="keyword">this</span>._setOption(<span class="string">"disabled"</span>,b),<span class="keyword">this</span>.type===<span class="string">"radio"</span>?k(<span class="keyword">this</span>.element[<span class="number">0</span>]).each(<span class="keyword">function</span>(){a(<span class="keyword">this</span>).is(<span class="string">":checked"</span>)?a(<span class="keyword">this</span>).button(<span class="string">"widget"</span>).addClass(<span class="string">"ui-state-active"</span>).attr(<span class="string">"aria-pressed"</span>,<span class="string">"true"</span>):a(<span class="keyword">this</span>).button(<span class="string">"widget"</span>).removeClass(<span class="string">"ui-state-active"</span>).attr(<span class="string">"aria-pressed"</span>,<span class="string">"false"</span>)}):<span class="keyword">this</span>.type===<span class="string">"checkbox"</span>&amp;&amp;(<span class="keyword">this</span>.element.is(<span class="string">":checked"</span>)?<span class="keyword">this</span>.buttonElement.addClass(<span class="string">"ui-state-active"</span>).attr(<span class="string">"aria-pressed"</span>,<span class="string">"true"</span>):<span class="keyword">this</span>.buttonElement.removeClass(<span class="string">"ui-state-active"</span>).attr(<span class="string">"aria-pressed"</span>,<span class="string">"false"</span>))},_resetButton:<span class="keyword">function</span>(){<span class="keyword">if</span>(<span class="keyword">this</span>.type===<span class="string">"input"</span>){<span class="keyword">this</span>.options.label&amp;&amp;<span class="keyword">this</span>.element.val(<span class="keyword">this</span>.options.label);<span class="keyword">return</span>}<span class="keyword">var</span> b=<span class="keyword">this</span>.buttonElement.removeClass(i),c=a(<span class="string">"&lt;span&gt;&lt;/span&gt;"</span>,<span class="keyword">this</span>.element[<span class="number">0</span>].ownerDocument).addClass(<span class="string">"ui-button-text"</span>).html(<span class="keyword">this</span>.options.label).appendTo(b.empty()).text(),d=<span class="keyword">this</span>.options.icons,e=d.primary&amp;&amp;d.secondary,f=[];d.primary||d.secondary?(<span class="keyword">this</span>.options.text&amp;&amp;f.push(<span class="string">"ui-button-text-icon"</span>+(e?<span class="string">"s"</span>:d.primary?<span class="string">"-primary"</span>:<span class="string">"-secondary"</span>)),d.primary&amp;&amp;b.prepend(<span class="string">"&lt;span class='ui-button-icon-primary ui-icon "</span>+d.primary+<span class="string">"'&gt;&lt;/span&gt;"</span>),d.secondary&amp;&amp;b.append(<span class="string">"&lt;span class='ui-button-icon-secondary ui-icon "</span>+d.secondary+<span class="string">"'&gt;&lt;/span&gt;"</span>),<span class="keyword">this</span>.options.text||(f.push(e?<span class="string">"ui-button-icons-only"</span>:<span class="string">"ui-button-icon-only"</span>),<span class="keyword">this</span>.hasTitle||b.attr(<span class="string">"title"</span>,c))):f.push(<span class="string">"ui-button-text-only"</span>),b.addClass(f.join(<span class="string">" "</span>))}}),a.widget(<span class="string">"ui.buttonset"</span>,{options:{items:<span class="string">":button, :submit, :reset, :checkbox, :radio, a, :data(button)"</span>},_create:<span class="keyword">function</span>(){<span class="keyword">this</span>.element.addClass(<span class="string">"ui-buttonset"</span>)},_init:<span class="keyword">function</span>(){<span class="keyword">this</span>.refresh()},_setOption:<span class="keyword">function</span>(b,c){b===<span class="string">"disabled"</span>&amp;&amp;<span class="keyword">this</span>.buttons.button(<span class="string">"option"</span>,b,c),a.Widget.prototype._setOption.apply(<span class="keyword">this</span>,arguments)},refresh:<span class="keyword">function</span>(){<span class="keyword">var</span> b=<span class="keyword">this</span>.element.css(<span class="string">"direction"</span>)===<span class="string">"rtl"</span>;<span class="keyword">this</span>.buttons=<span class="keyword">this</span>.element.find(<span class="keyword">this</span>.options.items).filter(<span class="string">":ui-button"</span>).button(<span class="string">"refresh"</span>).end().not(<span class="string">":ui-button"</span>).button().end().map(<span class="keyword">function</span>(){<span class="keyword">return</span> a(<span class="keyword">this</span>).button(<span class="string">"widget"</span>)[<span class="number">0</span>]}).removeClass(<span class="string">"ui-corner-all ui-corner-left ui-corner-right"</span>).filter(<span class="string">":first"</span>).addClass(b?<span class="string">"ui-corner-right"</span>:<span class="string">"ui-corner-left"</span>).end().filter(<span class="string">":last"</span>).addClass(b?<span class="string">"ui-corner-left"</span>:<span class="string">"ui-corner-right"</span>).end().end()},destroy:<span class="keyword">function</span>(){<span class="keyword">this</span>.element.removeClass(<span class="string">"ui-buttonset"</span>),<span class="keyword">this</span>.buttons.map(<span class="keyword">function</span>(){<span class="keyword">return</span> a(<span class="keyword">this</span>).button(<span class="string">"widget"</span>)[<span class="number">0</span>]}).removeClass(<span class="string">"ui-corner-left ui-corner-right"</span>).end().button(<span class="string">"destroy"</span>),a.Widget.prototype.destroy.call(<span class="keyword">this</span>)}})}(jQuery),<span class="keyword">function</span>($,<span class="literal">undefined</span>){<span class="function"><span class="keyword">function</span> <span class="title">Datepicker</span><span class="params">()</span>{</span><span class="keyword">this</span>.debug=!<span class="number">1</span>,<span class="keyword">this</span>._curInst=<span class="literal">null</span>,<span class="keyword">this</span>._keyEvent=!<span class="number">1</span>,<span class="keyword">this</span>._disabledInputs=[],<span class="keyword">this</span>._datepickerShowing=!<span class="number">1</span>,<span class="keyword">this</span>._inDialog=!<span class="number">1</span>,<span class="keyword">this</span>._mainDivId=<span class="string">"ui-datepicker-div"</span>,<span class="keyword">this</span>._inlineClass=<span class="string">"ui-datepicker-inline"</span>,<span class="keyword">this</span>._appendClass=<span class="string">"ui-datepicker-append"</span>,<span class="keyword">this</span>._triggerClass=<span class="string">"ui-datepicker-trigger"</span>,<span class="keyword">this</span>._dialogClass=<span class="string">"ui-datepicker-dialog"</span>,<span class="keyword">this</span>._disableClass=<span class="string">"ui-datepicker-disabled"</span>,<span class="keyword">this</span>._unselectableClass=<span class="string">"ui-datepicker-unselectable"</span>,<span class="keyword">this</span>._currentClass=<span class="string">"ui-datepicker-current-day"</span>,<span class="keyword">this</span>._dayOverClass=<span class="string">"ui-datepicker-days-cell-over"</span>,<span class="keyword">this</span>.regional=[],<span class="keyword">this</span>.regional[<span class="string">""</span>]={closeText:<span class="string">"Done"</span>,prevText:<span class="string">"Prev"</span>,nextText:<span class="string">"Next"</span>,currentText:<span class="string">"Today"</span>,monthNames:[<span class="string">"January"</span>,<span class="string">"February"</span>,<span class="string">"March"</span>,<span class="string">"April"</span>,<span class="string">"May"</span>,<span class="string">"June"</span>,<span class="string">"July"</span>,<span class="string">"August"</span>,<span class="string">"September"</span>,<span class="string">"October"</span>,<span class="string">"November"</span>,<span class="string">"December"</span>],monthNamesShort:[<span class="string">"Jan"</span>,<span class="string">"Feb"</span>,<span class="string">"Mar"</span>,<span class="string">"Apr"</span>,<span class="string">"May"</span>,<span class="string">"Jun"</span>,<span class="string">"Jul"</span>,<span class="string">"Aug"</span>,<span class="string">"Sep"</span>,<span class="string">"Oct"</span>,<span class="string">"Nov"</span>,<span class="string">"Dec"</span>],dayNames:[<span class="string">"Sunday"</span>,<span class="string">"Monday"</span>,<span class="string">"Tuesday"</span>,<span class="string">"Wednesday"</span>,<span class="string">"Thursday"</span>,<span class="string">"Friday"</span>,<span class="string">"Saturday"</span>],dayNamesShort:[<span class="string">"Sun"</span>,<span class="string">"Mon"</span>,<span class="string">"Tue"</span>,<span class="string">"Wed"</span>,<span class="string">"Thu"</span>,<span class="string">"Fri"</span>,<span class="string">"Sat"</span>],dayNamesMin:[<span class="string">"Su"</span>,<span class="string">"Mo"</span>,<span class="string">"Tu"</span>,<span class="string">"We"</span>,<span class="string">"Th"</span>,<span class="string">"Fr"</span>,<span class="string">"Sa"</span>],weekHeader:<span class="string">"Wk"</span>,dateFormat:<span class="string">"mm/dd/yy"</span>,firstDay:<span class="number">0</span>,isRTL:!<span class="number">1</span>,showMonthAfterYear:!<span class="number">1</span>,yearSuffix:<span class="string">""</span>},<span class="keyword">this</span>._defaults={showOn:<span class="string">"focus"</span>,showAnim:<span class="string">"fadeIn"</span>,showOptions:{},defaultDate:<span class="literal">null</span>,appendText:<span class="string">""</span>,buttonText:<span class="string">"..."</span>,buttonImage:<span class="string">""</span>,buttonImageOnly:!<span class="number">1</span>,hideIfNoPrevNext:!<span class="number">1</span>,navigationAsDateFormat:!<span class="number">1</span>,gotoCurrent:!<span class="number">1</span>,changeMonth:!<span class="number">1</span>,changeYear:!<span class="number">1</span>,yearRange:<span class="string">"c-10:c+10"</span>,showOtherMonths:!<span class="number">1</span>,selectOtherMonths:!<span class="number">1</span>,showWeek:!<span class="number">1</span>,calculateWeek:<span class="keyword">this</span>.iso8601Week,shortYearCutoff:<span class="string">"+10"</span>,minDate:<span class="literal">null</span>,maxDate:<span class="literal">null</span>,duration:<span class="string">"fast"</span>,beforeShowDay:<span class="literal">null</span>,beforeShow:<span class="literal">null</span>,onSelect:<span class="literal">null</span>,onChangeMonthYear:<span class="literal">null</span>,onClose:<span class="literal">null</span>,numberOfMonths:<span class="number">1</span>,showCurrentAtPos:<span class="number">0</span>,stepMonths:<span class="number">1</span>,stepBigMonths:<span class="number">12</span>,altField:<span class="string">""</span>,altFormat:<span class="string">""</span>,constrainInput:!<span class="number">0</span>,showButtonPanel:!<span class="number">1</span>,autoSize:!<span class="number">1</span>,disabled:!<span class="number">1</span>},$.extend(<span class="keyword">this</span>._defaults,<span class="keyword">this</span>.regional[<span class="string">""</span>]),<span class="keyword">this</span>.dpDiv=bindHover($(<span class="string">'&lt;div id="'</span>+<span class="keyword">this</span>._mainDivId+<span class="string">'" class="ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all"&gt;&lt;/div&gt;'</span>))}<span class="function"><span class="keyword">function</span> <span class="title">bindHover</span><span class="params">(a)</span>{</span><span class="keyword">var</span> b=<span class="string">"button, .ui-datepicker-prev, .ui-datepicker-next, .ui-datepicker-calendar td a"</span>;<span class="keyword">return</span> a.bind(<span class="string">"mouseout"</span>,<span class="keyword">function</span>(a){<span class="keyword">var</span> c=$(a.target).closest(b);<span class="keyword">if</span>(!c.length)<span class="keyword">return</span>;c.removeClass(<span class="string">"ui-state-hover ui-datepicker-prev-hover ui-datepicker-next-hover"</span>)}).bind(<span class="string">"mouseover"</span>,<span class="keyword">function</span>(c){<span class="keyword">var</span> d=$(c.target).closest(b);<span class="keyword">if</span>($.datepicker._isDisabledDatepicker(instActive.inline?a.parent()[<span class="number">0</span>]:instActive.input[<span class="number">0</span>])||!d.length)<span class="keyword">return</span>;d.parents(<span class="string">".ui-datepicker-calendar"</span>).find(<span class="string">"a"</span>).removeClass(<span class="string">"ui-state-hover"</span>),d.addClass(<span class="string">"ui-state-hover"</span>),d.hasClass(<span class="string">"ui-datepicker-prev"</span>)&amp;&amp;d.addClass(<span class="string">"ui-datepicker-prev-hover"</span>),d.hasClass(<span class="string">"ui-datepicker-next"</span>)&amp;&amp;d.addClass(<span class="string">"ui-datepicker-next-hover"</span>)})}<span class="function"><span class="keyword">function</span> <span class="title">extendRemove</span><span class="params">(a,b)</span>{</span>$.extend(a,b);<span class="keyword">for</span>(<span class="keyword">var</span> c <span class="keyword">in</span> b)<span class="keyword">if</span>(b[c]==<span class="literal">null</span>||b[c]==<span class="literal">undefined</span>)a[c]=b[c];<span class="keyword">return</span> a}<span class="function"><span class="keyword">function</span> <span class="title">isArray</span><span class="params">(a)</span>{</span><span class="keyword">return</span> a&amp;&amp;($.browser.safari&amp;&amp;<span class="keyword">typeof</span> a==<span class="string">"object"</span>&amp;&amp;a.length||a.constructor&amp;&amp;a.constructor.toString().match(<span class="regexp">/\Array\(\)/</span>))}$.extend($.ui,{datepicker:{version:<span class="string">"1.8.21"</span>}});<span class="keyword">var</span> PROP_NAME=<span class="string">"datepicker"</span>,dpuuid=(<span class="keyword">new</span> Date).getTime(),instActive;$.extend(Datepicker.prototype,{markerClassName:<span class="string">"hasDatepicker"</span>,maxRows:<span class="number">4</span>,log:<span class="keyword">function</span>(){<span class="keyword">this</span>.debug&amp;&amp;console.log.apply(<span class="string">""</span>,arguments)},_widgetDatepicker:<span class="keyword">function</span>(){<span class="keyword">return</span> <span class="keyword">this</span>.dpDiv},setDefaults:<span class="keyword">function</span>(a){<span class="keyword">return</span> extendRemove(<span class="keyword">this</span>._defaults,a||{}),<span class="keyword">this</span>},_attachDatepicker:<span class="keyword">function</span>(target,settings){<span class="keyword">var</span> inlineSettings=<span class="literal">null</span>;<span class="keyword">for</span>(<span class="keyword">var</span> attrName <span class="keyword">in</span> <span class="keyword">this</span>._defaults){<span class="keyword">var</span> attrValue=target.getAttribute(<span class="string">"date:"</span>+attrName);<span class="keyword">if</span>(attrValue){inlineSettings=inlineSettings||{};<span class="keyword">try</span>{inlineSettings[attrName]=eval(attrValue)}<span class="keyword">catch</span>(err){inlineSettings[attrName]=attrValue}}}<span class="keyword">var</span> nodeName=target.nodeName.toLowerCase(),inline=nodeName==<span class="string">"div"</span>||nodeName==<span class="string">"span"</span>;target.id||(<span class="keyword">this</span>.uuid+=<span class="number">1</span>,target.id=<span class="string">"dp"</span>+<span class="keyword">this</span>.uuid);<span class="keyword">var</span> inst=<span class="keyword">this</span>._newInst($(target),inline);inst.settings=$.extend({},settings||{},inlineSettings||{}),nodeName==<span class="string">"input"</span>?<span class="keyword">this</span>._connectDatepicker(target,inst):inline&amp;&amp;<span class="keyword">this</span>._inlineDatepicker(target,inst)},_newInst:<span class="keyword">function</span>(a,b){<span class="keyword">var</span> c=a[<span class="number">0</span>].id.replace(<span class="regexp">/([^A-Za-z0-9_-])/g</span>,<span class="string">"\\\\$1"</span>);<span class="keyword">return</span>{id:c,input:a,selectedDay:<span class="number">0</span>,selectedMonth:<span class="number">0</span>,selectedYear:<span class="number">0</span>,drawMonth:<span class="number">0</span>,drawYear:<span class="number">0</span>,inline:b,dpDiv:b?bindHover($(<span class="string">'&lt;div class="'</span>+<span class="keyword">this</span>._inlineClass+<span class="string">' ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all"&gt;&lt;/div&gt;'</span>)):<span class="keyword">this</span>.dpDiv}},_connectDatepicker:<span class="keyword">function</span>(a,b){<span class="keyword">var</span> c=$(a);b.append=$([]),b.trigger=$([]);<span class="keyword">if</span>(c.hasClass(<span class="keyword">this</span>.markerClassName))<span class="keyword">return</span>;<span class="keyword">this</span>._attachments(c,b),c.addClass(<span class="keyword">this</span>.markerClassName).keydown(<span class="keyword">this</span>._doKeyDown).keypress(<span class="keyword">this</span>._doKeyPress).keyup(<span class="keyword">this</span>._doKeyUp).bind(<span class="string">"setData.datepicker"</span>,<span class="keyword">function</span>(a,c,d){b.settings[c]=d}).bind(<span class="string">"getData.datepicker"</span>,<span class="keyword">function</span>(a,c){<span class="keyword">return</span> <span class="keyword">this</span>._get(b,c)}),<span class="keyword">this</span>._autoSize(b),$.data(a,PROP_NAME,b),b.settings.disabled&amp;&amp;<span class="keyword">this</span>._disableDatepicker(a)},_attachments:<span class="keyword">function</span>(a,b){<span class="keyword">var</span> c=<span class="keyword">this</span>._get(b,<span class="string">"appendText"</span>),d=<span class="keyword">this</span>._get(b,<span class="string">"isRTL"</span>);b.append&amp;&amp;b.append.remove(),c&amp;&amp;(b.append=$(<span class="string">'&lt;span class="'</span>+<span class="keyword">this</span>._appendClass+<span class="string">'"&gt;'</span>+c+<span class="string">"&lt;/span&gt;"</span>),a[d?<span class="string">"before"</span>:<span class="string">"after"</span>](b.append)),a.unbind(<span class="string">"focus"</span>,<span class="keyword">this</span>._showDatepicker),b.trigger&amp;&amp;b.trigger.remove();<span class="keyword">var</span> e=<span class="keyword">this</span>._get(b,<span class="string">"showOn"</span>);(e==<span class="string">"focus"</span>||e==<span class="string">"both"</span>)&amp;&amp;a.focus(<span class="keyword">this</span>._showDatepicker);<span class="keyword">if</span>(e==<span class="string">"button"</span>||e==<span class="string">"both"</span>){<span class="keyword">var</span> f=<span class="keyword">this</span>._get(b,<span class="string">"buttonText"</span>),g=<span class="keyword">this</span>._get(b,<span class="string">"buttonImage"</span>);b.trigger=$(<span class="keyword">this</span>._get(b,<span class="string">"buttonImageOnly"</span>)?$(<span class="string">"&lt;img/&gt;"</span>).addClass(<span class="keyword">this</span>._triggerClass).attr({src:g,alt:f,title:f}):$(<span class="string">'&lt;button type="button"&gt;&lt;/button&gt;'</span>).addClass(<span class="keyword">this</span>._triggerClass).html(g==<span class="string">""</span>?f:$(<span class="string">"&lt;img/&gt;"</span>).attr({src:g,alt:f,title:f}))),a[d?<span class="string">"before"</span>:<span class="string">"after"</span>](b.trigger),b.trigger.click(<span class="keyword">function</span>(){<span class="keyword">return</span> $.datepicker._datepickerShowing&amp;&amp;$.datepicker._lastInput==a[<span class="number">0</span>]?$.datepicker._hideDatepicker():$.datepicker._datepickerShowing&amp;&amp;$.datepicker._lastInput!=a[<span class="number">0</span>]?($.datepicker._hideDatepicker(),$.datepicker._showDatepicker(a[<span class="number">0</span>])):$.datepicker._showDatepicker(a[<span class="number">0</span>]),!<span class="number">1</span>})}},_autoSize:<span class="keyword">function</span>(a){<span class="keyword">if</span>(<span class="keyword">this</span>._get(a,<span class="string">"autoSize"</span>)&amp;&amp;!a.inline){<span class="keyword">var</span> b=<span class="keyword">new</span> Date(<span class="number">2009</span>,<span class="number">11</span>,<span class="number">20</span>),c=<span class="keyword">this</span>._get(a,<span class="string">"dateFormat"</span>);<span class="keyword">if</span>(c.match(<span class="regexp">/[DM]/</span>)){<span class="keyword">var</span> d=<span class="keyword">function</span>(a){<span class="keyword">var</span> b=<span class="number">0</span>,c=<span class="number">0</span>;<span class="keyword">for</span>(<span class="keyword">var</span> d=<span class="number">0</span>;d&lt;a.length;d++)a[d].length&gt;b&amp;&amp;(b=a[d].length,c=d);<span class="keyword">return</span> c};b.setMonth(d(<span class="keyword">this</span>._get(a,c.match(<span class="regexp">/MM/</span>)?<span class="string">"monthNames"</span>:<span class="string">"monthNamesShort"</span>))),b.setDate(d(<span class="keyword">this</span>._get(a,c.match(<span class="regexp">/DD/</span>)?<span class="string">"dayNames"</span>:<span class="string">"dayNamesShort"</span>))+<span class="number">20</span>-b.getDay())}a.input.attr(<span class="string">"size"</span>,<span class="keyword">this</span>._formatDate(a,b).length)}},_inlineDatepicker:<span class="keyword">function</span>(a,b){<span class="keyword">var</span> c=$(a);<span class="keyword">if</span>(c.hasClass(<span class="keyword">this</span>.markerClassName))<span class="keyword">return</span>;c.addClass(<span class="keyword">this</span>.markerClassName).append(b.dpDiv).bind(<span class="string">"setData.datepicker"</span>,<span class="keyword">function</span>(a,c,d){b.settings[c]=d}).bind(<span class="string">"getData.datepicker"</span>,<span class="keyword">function</span>(a,c){<span class="keyword">return</span> <span class="keyword">this</span>._get(b,c)}),$.data(a,PROP_NAME,b),<span class="keyword">this</span>._setDate(b,<span class="keyword">this</span>._getDefaultDate(b),!<span class="number">0</span>),<span class="keyword">this</span>._updateDatepicker(b),<span class="keyword">this</span>._updateAlternate(b),b.settings.disabled&amp;&amp;<span class="keyword">this</span>._disableDatepicker(a),b.dpDiv.css(<span class="string">"display"</span>,<span class="string">"block"</span>)},_dialogDatepicker:<span class="keyword">function</span>(a,b,c,d,e){<span class="keyword">var</span> f=<span class="keyword">this</span>._dialogInst;<span class="keyword">if</span>(!f){<span class="keyword">this</span>.uuid+=<span class="number">1</span>;<span class="keyword">var</span> g=<span class="string">"dp"</span>+<span class="keyword">this</span>.uuid;<span class="keyword">this</span>._dialogInput=$(<span class="string">'&lt;input type="text" id="'</span>+g+<span class="string">'" style="position: absolute; top: -100px; width: 0px; z-index: -10;"/&gt;'</span>),<span class="keyword">this</span>._dialogInput.keydown(<span class="keyword">this</span>._doKeyDown),$(<span class="string">"body"</span>).append(<span class="keyword">this</span>._dialogInput),f=<span class="keyword">this</span>._dialogInst=<span class="keyword">this</span>._newInst(<span class="keyword">this</span>._dialogInput,!<span class="number">1</span>),f.settings={},$.data(<span class="keyword">this</span>._dialogInput[<span class="number">0</span>],PROP_NAME,f)}extendRemove(f.settings,d||{}),b=b&amp;&amp;b.constructor==Date?<span class="keyword">this</span>._formatDate(f,b):b,<span class="keyword">this</span>._dialogInput.val(b),<span class="keyword">this</span>._pos=e?e.length?e:[e.pageX,e.pageY]:<span class="literal">null</span>;<span class="keyword">if</span>(!<span class="keyword">this</span>._pos){<span class="keyword">var</span> h=document.documentElement.clientWidth,i=document.documentElement.clientHeight,j=document.documentElement.scrollLeft||document.body.scrollLeft,k=document.documentElement.scrollTop||document.body.scrollTop;<span class="keyword">this</span>._pos=[h/<span class="number">2</span>-<span class="number">100</span>+j,i/<span class="number">2</span>-<span class="number">150</span>+k]}<span class="keyword">return</span> <span class="keyword">this</span>._dialogInput.css(<span class="string">"left"</span>,<span class="keyword">this</span>._pos[<span class="number">0</span>]+<span class="number">20</span>+<span class="string">"px"</span>).css(<span class="string">"top"</span>,<span class="keyword">this</span>._pos[<span class="number">1</span>]+<span class="string">"px"</span>),f.settings.onSelect=c,<span class="keyword">this</span>._inDialog=!<span class="number">0</span>,<span class="keyword">this</span>.dpDiv.addClass(<span class="keyword">this</span>._dialogClass),<span class="keyword">this</span>._showDatepicker(<span class="keyword">this</span>._dialogInput[<span class="number">0</span>]),$.blockUI&amp;&amp;$.blockUI(<span class="keyword">this</span>.dpDiv),$.data(<span class="keyword">this</span>._dialogInput[<span class="number">0</span>],PROP_NAME,f),<span class="keyword">this</span>},_destroyDatepicker:<span class="keyword">function</span>(a){<span class="keyword">var</span> b=$(a),c=$.data(a,PROP_NAME);<span class="keyword">if</span>(!b.hasClass(<span class="keyword">this</span>.markerClassName))<span class="keyword">return</span>;<span class="keyword">var</span> d=a.nodeName.toLowerCase();$.removeData(a,PROP_NAME),d==<span class="string">"input"</span>?(c.append.remove(),c.trigger.remove(),b.removeClass(<span class="keyword">this</span>.markerClassName).unbind(<span class="string">"focus"</span>,<span class="keyword">this</span>._showDatepicker).unbind(<span class="string">"keydown"</span>,<span class="keyword">this</span>._doKeyDown).unbind(<span class="string">"keypress"</span>,<span class="keyword">this</span>._doKeyPress).unbind(<span class="string">"keyup"</span>,<span class="keyword">this</span>._doKeyUp)):(d==<span class="string">"div"</span>||d==<span class="string">"span"</span>)&amp;&amp;b.removeClass(<span class="keyword">this</span>.markerClassName).empty()},_enableDatepicker:<span class="keyword">function</span>(a){<span class="keyword">var</span> b=$(a),c=$.data(a,PROP_NAME);<span class="keyword">if</span>(!b.hasClass(<span class="keyword">this</span>.markerClassName))<span class="keyword">return</span>;<span class="keyword">var</span> d=a.nodeName.toLowerCase();<span class="keyword">if</span>(d==<span class="string">"input"</span>)a.disabled=!<span class="number">1</span>,c.trigger.filter(<span class="string">"button"</span>).each(<span class="keyword">function</span>(){<span class="keyword">this</span>.disabled=!<span class="number">1</span>}).end().filter(<span class="string">"img"</span>).css({opacity:<span class="string">"1.0"</span>,cursor:<span class="string">""</span>});<span class="keyword">else</span> <span class="keyword">if</span>(d==<span class="string">"div"</span>||d==<span class="string">"span"</span>){<span class="keyword">var</span> e=b.children(<span class="string">"."</span>+<span class="keyword">this</span>._inlineClass);e.children().removeClass(<span class="string">"ui-state-disabled"</span>),e.find(<span class="string">"select.ui-datepicker-month, select.ui-datepicker-year"</span>).removeAttr(<span class="string">"disabled"</span>)}<span class="keyword">this</span>._disabledInputs=$.map(<span class="keyword">this</span>._disabledInputs,<span class="keyword">function</span>(b){<span class="keyword">return</span> b==a?<span class="literal">null</span>:b})},_disableDatepicker:<span class="keyword">function</span>(a){<span class="keyword">var</span> b=$(a),c=$.data(a,PROP_NAME);<span class="keyword">if</span>(!b.hasClass(<span class="keyword">this</span>.markerClassName))<span class="keyword">return</span>;<span class="keyword">var</span> d=a.nodeName.toLowerCase();<span class="keyword">if</span>(d==<span class="string">"input"</span>)a.disabled=!<span class="number">0</span>,c.trigger.filter(<span class="string">"button"</span>).each(<span class="keyword">function</span>(){<span class="keyword">this</span>.disabled=!<span class="number">0</span>}).end().filter(<span class="string">"img"</span>).css({opacity:<span class="string">"0.5"</span>,cursor:<span class="string">"default"</span>});<span class="keyword">else</span> <span class="keyword">if</span>(d==<span class="string">"div"</span>||d==<span class="string">"span"</span>){<span class="keyword">var</span> e=b.children(<span class="string">"."</span>+<span class="keyword">this</span>._inlineClass);e.children().addClass(<span class="string">"ui-state-disabled"</span>),e.find(<span class="string">"select.ui-datepicker-month, select.ui-datepicker-year"</span>).attr(<span class="string">"disabled"</span>,<span class="string">"disabled"</span>)}<span class="keyword">this</span>._disabledInputs=$.map(<span class="keyword">this</span>._disabledInputs,<span class="keyword">function</span>(b){<span class="keyword">return</span> b==a?<span class="literal">null</span>:b}),<span class="keyword">this</span>._disabledInputs[<span class="keyword">this</span>._disabledInputs.length]=a},_isDisabledDatepicker:<span class="keyword">function</span>(a){<span class="keyword">if</span>(!a)<span class="keyword">return</span>!<span class="number">1</span>;<span class="keyword">for</span>(<span class="keyword">var</span> b=<span class="number">0</span>;b&lt;<span class="keyword">this</span>._disabledInputs.length;b++)<span class="keyword">if</span>(<span class="keyword">this</span>._disabledInputs[b]==a)<span class="keyword">return</span>!<span class="number">0</span>;<span class="keyword">return</span>!<span class="number">1</span>},_getInst:<span class="keyword">function</span>(a){<span class="keyword">try</span>{<span class="keyword">return</span> $.data(a,PROP_NAME)}<span class="keyword">catch</span>(b){<span class="keyword">throw</span><span class="string">"Missing instance data for this datepicker"</span>}},_optionDatepicker:<span class="keyword">function</span>(a,b,c){<span class="keyword">var</span> d=<span class="keyword">this</span>._getInst(a);<span class="keyword">if</span>(arguments.length==<span class="number">2</span>&amp;&amp;<span class="keyword">typeof</span> b==<span class="string">"string"</span>)<span class="keyword">return</span> b==<span class="string">"defaults"</span>?$.extend({},$.datepicker._defaults):d?b==<span class="string">"all"</span>?$.extend({},d.settings):<span class="keyword">this</span>._get(d,b):<span class="literal">null</span>;<span class="keyword">var</span> e=b||{};<span class="keyword">typeof</span> b==<span class="string">"string"</span>&amp;&amp;(e={},e[b]=c);<span class="keyword">if</span>(d){<span class="keyword">this</span>._curInst==d&amp;&amp;<span class="keyword">this</span>._hideDatepicker();<span class="keyword">var</span> f=<span class="keyword">this</span>._getDateDatepicker(a,!<span class="number">0</span>),g=<span class="keyword">this</span>._getMinMaxDate(d,<span class="string">"min"</span>),h=<span class="keyword">this</span>._getMinMaxDate(d,<span class="string">"max"</span>);extendRemove(d.settings,e),g!==<span class="literal">null</span>&amp;&amp;e.dateFormat!==<span class="literal">undefined</span>&amp;&amp;e.minDate===<span class="literal">undefined</span>&amp;&amp;(d.settings.minDate=<span class="keyword">this</span>._formatDate(d,g)),h!==<span class="literal">null</span>&amp;&amp;e.dateFormat!==<span class="literal">undefined</span>&amp;&amp;e.maxDate===<span class="literal">undefined</span>&amp;&amp;(d.settings.maxDate=<span class="keyword">this</span>._formatDate(d,h)),<span class="keyword">this</span>._attachments($(a),d),<span class="keyword">this</span>._autoSize(d),<span class="keyword">this</span>._setDate(d,f),<span class="keyword">this</span>._updateAlternate(d),<span class="keyword">this</span>._updateDatepicker(d)}},_changeDatepicker:<span class="keyword">function</span>(a,b,c){<span class="keyword">this</span>._optionDatepicker(a,b,c)},_refreshDatepicker:<span class="keyword">function</span>(a){<span class="keyword">var</span> b=<span class="keyword">this</span>._getInst(a);b&amp;&amp;<span class="keyword">this</span>._updateDatepicker(b)},_setDateDatepicker:<span class="keyword">function</span>(a,b){<span class="keyword">var</span> c=<span class="keyword">this</span>._getInst(a);c&amp;&amp;(<span class="keyword">this</span>._setDate(c,b),<span class="keyword">this</span>._updateDatepicker(c),<span class="keyword">this</span>._updateAlternate(c))},_getDateDatepicker:<span class="keyword">function</span>(a,b){<span class="keyword">var</span> c=<span class="keyword">this</span>._getInst(a);<span class="keyword">return</span> c&amp;&amp;!c.inline&amp;&amp;<span class="keyword">this</span>._setDateFromField(c,b),c?<span class="keyword">this</span>._getDate(c):<span class="literal">null</span>},_doKeyDown:<span class="keyword">function</span>(a){<span class="keyword">var</span> b=$.datepicker._getInst(a.target),c=!<span class="number">0</span>,d=b.dpDiv.is(<span class="string">".ui-datepicker-rtl"</span>);b._keyEvent=!<span class="number">0</span>;<span class="keyword">if</span>($.datepicker._datepickerShowing)<span class="keyword">switch</span>(a.keyCode){<span class="keyword">case</span> <span class="number">9</span>:$.datepicker._hideDatepicker(),c=!<span class="number">1</span>;<span class="keyword">break</span>;<span class="keyword">case</span> <span class="number">13</span>:<span class="keyword">var</span> e=$(<span class="string">"td."</span>+$.datepicker._dayOverClass+<span class="string">":not(."</span>+$.datepicker._currentClass+<span class="string">")"</span>,b.dpDiv);e[<span class="number">0</span>]&amp;&amp;$.datepicker._selectDay(a.target,b.selectedMonth,b.selectedYear,e[<span class="number">0</span>]);<span class="keyword">var</span> f=$.datepicker._get(b,<span class="string">"onSelect"</span>);<span class="keyword">if</span>(f){<span class="keyword">var</span> g=$.datepicker._formatDate(b);f.apply(b.input?b.input[<span class="number">0</span>]:<span class="literal">null</span>,[g,b])}<span class="keyword">else</span> $.datepicker._hideDatepicker();<span class="keyword">return</span>!<span class="number">1</span>;<span class="keyword">case</span> <span class="number">27</span>:$.datepicker._hideDatepicker();<span class="keyword">break</span>;<span class="keyword">case</span> <span class="number">33</span>:$.datepicker._adjustDate(a.target,a.ctrlKey?-$.datepicker._get(b,<span class="string">"stepBigMonths"</span>):-$.datepicker._get(b,<span class="string">"stepMonths"</span>),<span class="string">"M"</span>);<span class="keyword">break</span>;<span class="keyword">case</span> <span class="number">34</span>:$.datepicker._adjustDate(a.target,a.ctrlKey?+$.datepicker._get(b,<span class="string">"stepBigMonths"</span>):+$.datepicker._get(b,<span class="string">"stepMonths"</span>),<span class="string">"M"</span>);<span class="keyword">break</span>;<span class="keyword">case</span> <span class="number">35</span>:(a.ctrlKey||a.metaKey)&amp;&amp;$.datepicker._clearDate(a.target),c=a.ctrlKey||a.metaKey;<span class="keyword">break</span>;<span class="keyword">case</span> <span class="number">36</span>:(a.ctrlKey||a.metaKey)&amp;&amp;$.datepicker._gotoToday(a.target),c=a.ctrlKey||a.metaKey;<span class="keyword">break</span>;<span class="keyword">case</span> <span class="number">37</span>:(a.ctrlKey||a.metaKey)&amp;&amp;$.datepicker._adjustDate(a.target,d?<span class="number">1</span>:-<span class="number">1</span>,<span class="string">"D"</span>),c=a.ctrlKey||a.metaKey,a.originalEvent.altKey&amp;&amp;$.datepicker._adjustDate(a.target,a.ctrlKey?-$.datepicker._get(b,<span class="string">"stepBigMonths"</span>):-$.datepicker._get(b,<span class="string">"stepMonths"</span>),<span class="string">"M"</span>);<span class="keyword">break</span>;<span class="keyword">case</span> <span class="number">38</span>:(a.ctrlKey||a.metaKey)&amp;&amp;$.datepicker._adjustDate(a.target,-<span class="number">7</span>,<span class="string">"D"</span>),c=a.ctrlKey||a.metaKey;<span class="keyword">break</span>;<span class="keyword">case</span> <span class="number">39</span>:(a.ctrlKey||a.metaKey)&amp;&amp;$.datepicker._adjustDate(a.target,d?-<span class="number">1</span>:<span class="number">1</span>,<span class="string">"D"</span>),c=a.ctrlKey||a.metaKey,a.originalEvent.altKey&amp;&amp;$.datepicker._adjustDate(a.target,a.ctrlKey?+$.datepicker._get(b,<span class="string">"stepBigMonths"</span>):+$.datepicker._get(b,<span class="string">"stepMonths"</span>),<span class="string">"M"</span>);<span class="keyword">break</span>;<span class="keyword">case</span> <span class="number">40</span>:(a.ctrlKey||a.metaKey)&amp;&amp;$.datepicker._adjustDate(a.target,<span class="number">7</span>,<span class="string">"D"</span>),c=a.ctrlKey||a.metaKey;<span class="keyword">break</span>;<span class="keyword">default</span>:c=!<span class="number">1</span>}<span class="keyword">else</span> a.keyCode==<span class="number">36</span>&amp;&amp;a.ctrlKey?$.datepicker._showDatepicker(<span class="keyword">this</span>):c=!<span class="number">1</span>;c&amp;&amp;(a.preventDefault(),a.stopPropagation())},_doKeyPress:<span class="keyword">function</span>(a){<span class="keyword">var</span> b=$.datepicker._getInst(a.target);<span class="keyword">if</span>($.datepicker._get(b,<span class="string">"constrainInput"</span>)){<span class="keyword">var</span> c=$.datepicker._possibleChars($.datepicker._get(b,<span class="string">"dateFormat"</span>)),d=String.fromCharCode(a.charCode==<span class="literal">undefined</span>?a.keyCode:a.charCode);<span class="keyword">return</span> a.ctrlKey||a.metaKey||d&lt;<span class="string">" "</span>||!c||c.indexOf(d)&gt;-<span class="number">1</span>}},_doKeyUp:<span class="keyword">function</span>(a){<span class="keyword">var</span> b=$.datepicker._getInst(a.target);<span class="keyword">if</span>(b.input.val()!=b.lastVal)<span class="keyword">try</span>{<span class="keyword">var</span> c=$.datepicker.parseDate($.datepicker._get(b,<span class="string">"dateFormat"</span>),b.input?b.input.val():<span class="literal">null</span>,$.datepicker._getFormatConfig(b));c&amp;&amp;($.datepicker._setDateFromField(b),$.datepicker._updateAlternate(b),$.datepicker._updateDatepicker(b))}<span class="keyword">catch</span>(d){$.datepicker.log(d)}<span class="keyword">return</span>!<span class="number">0</span>},_showDatepicker:<span class="keyword">function</span>(a){a=a.target||a,a.nodeName.toLowerCase()!=<span class="string">"input"</span>&amp;&amp;(a=$(<span class="string">"input"</span>,a.parentNode)[<span class="number">0</span>]);<span class="keyword">if</span>($.datepicker._isDisabledDatepicker(a)||$.datepicker._lastInput==a)<span class="keyword">return</span>;<span class="keyword">var</span> b=$.datepicker._getInst(a);$.datepicker._curInst&amp;&amp;$.datepicker._curInst!=b&amp;&amp;($.datepicker._curInst.dpDiv.stop(!<span class="number">0</span>,!<span class="number">0</span>),b&amp;&amp;$.datepicker._datepickerShowing&amp;&amp;$.datepicker._hideDatepicker($.datepicker._curInst.input[<span class="number">0</span>]));<span class="keyword">var</span> c=$.datepicker._get(b,<span class="string">"beforeShow"</span>),d=c?c.apply(a,[a,b]):{};<span class="keyword">if</span>(d===!<span class="number">1</span>)<span class="keyword">return</span>;extendRemove(b.settings,d),b.lastVal=<span class="literal">null</span>,$.datepicker._lastInput=a,$.datepicker._setDateFromField(b),$.datepicker._inDialog&amp;&amp;(a.value=<span class="string">""</span>),$.datepicker._pos||($.datepicker._pos=$.datepicker._findPos(a),$.datepicker._pos[<span class="number">1</span>]+=a.offsetHeight);<span class="keyword">var</span> e=!<span class="number">1</span>;$(a).parents().each(<span class="keyword">function</span>(){<span class="keyword">return</span> e|=$(<span class="keyword">this</span>).css(<span class="string">"position"</span>)==<span class="string">"fixed"</span>,!e}),e&amp;&amp;$.browser.opera&amp;&amp;($.datepicker._pos[<span class="number">0</span>]-=document.documentElement.scrollLeft,$.datepicker._pos[<span class="number">1</span>]-=document.documentElement.scrollTop);<span class="keyword">var</span> f={left:$.datepicker._pos[<span class="number">0</span>],top:$.datepicker._pos[<span class="number">1</span>]};$.datepicker._pos=<span class="literal">null</span>,b.dpDiv.empty(),b.dpDiv.css({position:<span class="string">"absolute"</span>,display:<span class="string">"block"</span>,top:<span class="string">"-1000px"</span>}),$.datepicker._updateDatepicker(b),f=$.datepicker._checkOffset(b,f,e),b.dpDiv.css({position:$.datepicker._inDialog&amp;&amp;$.blockUI?<span class="string">"static"</span>:e?<span class="string">"fixed"</span>:<span class="string">"absolute"</span>,display:<span class="string">"none"</span>,left:f.left+<span class="string">"px"</span>,top:f.top+<span class="string">"px"</span>});<span class="keyword">if</span>(!b.inline){<span class="keyword">var</span> g=$.datepicker._get(b,<span class="string">"showAnim"</span>),h=$.datepicker._get(b,<span class="string">"duration"</span>),i=<span class="keyword">function</span>(){<span class="keyword">var</span> a=b.dpDiv.find(<span class="string">"iframe.ui-datepicker-cover"</span>);<span class="keyword">if</span>(!!a.length){<span class="keyword">var</span> c=$.datepicker._getBorders(b.dpDiv);a.css({left:-c[<span class="number">0</span>],top:-c[<span class="number">1</span>],width:b.dpDiv.outerWidth(),height:b.dpDiv.outerHeight()})}};b.dpDiv.zIndex($(a).zIndex()+<span class="number">1</span>),$.datepicker._datepickerShowing=!<span class="number">0</span>,$.effects&amp;&amp;$.effects[g]?b.dpDiv.show(g,$.datepicker._get(b,<span class="string">"showOptions"</span>),h,i):b.dpDiv[g||<span class="string">"show"</span>](g?h:<span class="literal">null</span>,i),(!g||!h)&amp;&amp;i(),b.input.is(<span class="string">":visible"</span>)&amp;&amp;!b.input.is(<span class="string">":disabled"</span>)&amp;&amp;b.input.focus(),$.datepicker._curInst=b}},_updateDatepicker:<span class="keyword">function</span>(a){<span class="keyword">var</span> b=<span class="keyword">this</span>;b.maxRows=<span class="number">4</span>;<span class="keyword">var</span> c=$.datepicker._getBorders(a.dpDiv);instActive=a,a.dpDiv.empty().append(<span class="keyword">this</span>._generateHTML(a));<span class="keyword">var</span> d=a.dpDiv.find(<span class="string">"iframe.ui-datepicker-cover"</span>);!d.length||d.css({left:-c[<span class="number">0</span>],top:-c[<span class="number">1</span>],width:a.dpDiv.outerWidth(),height:a.dpDiv.outerHeight()}),a.dpDiv.find(<span class="string">"."</span>+<span class="keyword">this</span>._dayOverClass+<span class="string">" a"</span>).mouseover();<span class="keyword">var</span> e=<span class="keyword">this</span>._getNumberOfMonths(a),f=e[<span class="number">1</span>],g=<span class="number">17</span>;a.dpDiv.removeClass(<span class="string">"ui-datepicker-multi-2 ui-datepicker-multi-3 ui-datepicker-multi-4"</span>).width(<span class="string">""</span>),f&gt;<span class="number">1</span>&amp;&amp;a.dpDiv.addClass(<span class="string">"ui-datepicker-multi-"</span>+f).css(<span class="string">"width"</span>,g*f+<span class="string">"em"</span>),a.dpDiv[(e[<span class="number">0</span>]!=<span class="number">1</span>||e[<span class="number">1</span>]!=<span class="number">1</span>?<span class="string">"add"</span>:<span class="string">"remove"</span>)+<span class="string">"Class"</span>](<span class="string">"ui-datepicker-multi"</span>),a.dpDiv[(<span class="keyword">this</span>._get(a,<span class="string">"isRTL"</span>)?<span class="string">"add"</span>:<span class="string">"remove"</span>)+<span class="string">"Class"</span>](<span class="string">"ui-datepicker-rtl"</span>),a==$.datepicker._curInst&amp;&amp;$.datepicker._datepickerShowing&amp;&amp;a.input&amp;&amp;a.input.is(<span class="string">":visible"</span>)&amp;&amp;!a.input.is(<span class="string">":disabled"</span>)&amp;&amp;a.input[<span class="number">0</span>]!=document.activeElement&amp;&amp;a.input.focus();<span class="keyword">if</span>(a.yearshtml){<span class="keyword">var</span> h=a.yearshtml;setTimeout(<span class="keyword">function</span>(){h===a.yearshtml&amp;&amp;a.yearshtml&amp;&amp;a.dpDiv.find(<span class="string">"select.ui-datepicker-year:first"</span>).replaceWith(a.yearshtml),h=a.yearshtml=<span class="literal">null</span>},<span class="number">0</span>)}},_getBorders:<span class="keyword">function</span>(a){<span class="keyword">var</span> b=<span class="keyword">function</span>(a){<span class="keyword">return</span>{thin:<span class="number">1</span>,medium:<span class="number">2</span>,thick:<span class="number">3</span>}[a]||a};<span class="keyword">return</span>[parseFloat(b(a.css(<span class="string">"border-left-width"</span>))),parseFloat(b(a.css(<span class="string">"border-top-width"</span>)))]},_checkOffset:<span class="keyword">function</span>(a,b,c){<span class="keyword">var</span> d=a.dpDiv.outerWidth(),e=a.dpDiv.outerHeight(),f=a.input?a.input.outerWidth():<span class="number">0</span>,g=a.input?a.input.outerHeight():<span class="number">0</span>,h=document.documentElement.clientWidth+$(document).scrollLeft(),i=document.documentElement.clientHeight+$(document).scrollTop();<span class="keyword">return</span> b.left-=<span class="keyword">this</span>._get(a,<span class="string">"isRTL"</span>)?d-f:<span class="number">0</span>,b.left-=c&amp;&amp;b.left==a.input.offset().left?$(document).scrollLeft():<span class="number">0</span>,b.top-=c&amp;&amp;b.top==a.input.offset().top+g?$(document).scrollTop():<span class="number">0</span>,b.left-=Math.min(b.left,b.left+d&gt;h&amp;&amp;h&gt;d?Math.abs(b.left+d-h):<span class="number">0</span>),b.top-=Math.min(b.top,b.top+e&gt;i&amp;&amp;i&gt;e?Math.abs(e+g):<span class="number">0</span>),b},_findPos:<span class="keyword">function</span>(a){<span class="keyword">var</span> b=<span class="keyword">this</span>._getInst(a),c=<span class="keyword">this</span>._get(b,<span class="string">"isRTL"</span>);<span class="keyword">while</span>(a&amp;&amp;(a.type==<span class="string">"hidden"</span>||a.nodeType!=<span class="number">1</span>||$.expr.filters.hidden(a)))a=a[c?<span class="string">"previousSibling"</span>:<span class="string">"nextSibling"</span>];<span class="keyword">var</span> d=$(a).offset();<span class="keyword">return</span>[d.left,d.top]},_hideDatepicker:<span class="keyword">function</span>(a){<span class="keyword">var</span> b=<span class="keyword">this</span>._curInst;<span class="keyword">if</span>(!b||a&amp;&amp;b!=$.data(a,PROP_NAME))<span class="keyword">return</span>;<span class="keyword">if</span>(<span class="keyword">this</span>._datepickerShowing){<span class="keyword">var</span> c=<span class="keyword">this</span>._get(b,<span class="string">"showAnim"</span>),d=<span class="keyword">this</span>._get(b,<span class="string">"duration"</span>),e=<span class="keyword">function</span>(){$.datepicker._tidyDialog(b)};$.effects&amp;&amp;$.effects[c]?b.dpDiv.hide(c,$.datepicker._get(b,<span class="string">"showOptions"</span>),d,e):b.dpDiv[c==<span class="string">"slideDown"</span>?<span class="string">"slideUp"</span>:c==<span class="string">"fadeIn"</span>?<span class="string">"fadeOut"</span>:<span class="string">"hide"</span>](c?d:<span class="literal">null</span>,e),c||e(),<span class="keyword">this</span>._datepickerShowing=!<span class="number">1</span>;<span class="keyword">var</span> f=<span class="keyword">this</span>._get(b,<span class="string">"onClose"</span>);f&amp;&amp;f.apply(b.input?b.input[<span class="number">0</span>]:<span class="literal">null</span>,[b.input?b.input.val():<span class="string">""</span>,b]),<span class="keyword">this</span>._lastInput=<span class="literal">null</span>,<span class="keyword">this</span>._inDialog&amp;&amp;(<span class="keyword">this</span>._dialogInput.css({position:<span class="string">"absolute"</span>,left:<span class="string">"0"</span>,top:<span class="string">"-100px"</span>}),$.blockUI&amp;&amp;($.unblockUI(),$(<span class="string">"body"</span>).append(<span class="keyword">this</span>.dpDiv))),<span class="keyword">this</span>._inDialog=!<span class="number">1</span>}},_tidyDialog:<span class="keyword">function</span>(a){a.dpDiv.removeClass(<span class="keyword">this</span>._dialogClass).unbind(<span class="string">".ui-datepicker-calendar"</span>)},_checkExternalClick:<span class="keyword">function</span>(a){<span class="keyword">if</span>(!$.datepicker._curInst)<span class="keyword">return</span>;<span class="keyword">var</span> b=$(a.target),c=$.datepicker._getInst(b[<span class="number">0</span>]);(b[<span class="number">0</span>].id!=$.datepicker._mainDivId&amp;&amp;b.parents(<span class="string">"#"</span>+$.datepicker._mainDivId).length==<span class="number">0</span>&amp;&amp;!b.hasClass($.datepicker.markerClassName)&amp;&amp;!b.closest(<span class="string">"."</span>+$.datepicker._triggerClass).length&amp;&amp;$.datepicker._datepickerShowing&amp;&amp;(!$.datepicker._inDialog||!$.blockUI)||b.hasClass($.datepicker.markerClassName)&amp;&amp;$.datepicker._curInst!=c)&amp;&amp;$.datepicker._hideDatepicker()},_adjustDate:<span class="keyword">function</span>(a,b,c){<span class="keyword">var</span> d=$(a),e=<span class="keyword">this</span>._getInst(d[<span class="number">0</span>]);<span class="keyword">if</span>(<span class="keyword">this</span>._isDisabledDatepicker(d[<span class="number">0</span>]))<span class="keyword">return</span>;<span class="keyword">this</span>._adjustInstDate(e,b+(c==<span class="string">"M"</span>?<span class="keyword">this</span>._get(e,<span class="string">"showCurrentAtPos"</span>):<span class="number">0</span>),c),<span class="keyword">this</span>._updateDatepicker(e)},_gotoToday:<span class="keyword">function</span>(a){<span class="keyword">var</span> b=$(a),c=<span class="keyword">this</span>._getInst(b[<span class="number">0</span>]);<span class="keyword">if</span>(<span class="keyword">this</span>._get(c,<span class="string">"gotoCurrent"</span>)&amp;&amp;c.currentDay)c.selectedDay=c.currentDay,c.drawMonth=c.selectedMonth=c.currentMonth,c.drawYear=c.selectedYear=c.currentYear;<span class="keyword">else</span>{<span class="keyword">var</span> d=<span class="keyword">new</span> Date;c.selectedDay=d.getDate(),c.drawMonth=c.selectedMonth=d.getMonth(),c.drawYear=c.selectedYear=d.getFullYear()}<span class="keyword">this</span>._notifyChange(c),<span class="keyword">this</span>._adjustDate(b)},_selectMonthYear:<span class="keyword">function</span>(a,b,c){<span class="keyword">var</span> d=$(a),e=<span class="keyword">this</span>._getInst(d[<span class="number">0</span>]);e[<span class="string">"selected"</span>+(c==<span class="string">"M"</span>?<span class="string">"Month"</span>:<span class="string">"Year"</span>)]=e[<span class="string">"draw"</span>+(c==<span class="string">"M"</span>?<span class="string">"Month"</span>:<span class="string">"Year"</span>)]=parseInt(b.options[b.selectedIndex].value,<span class="number">10</span>),<span class="keyword">this</span>._notifyChange(e),<span class="keyword">this</span>._adjustDate(d)},_selectDay:<span class="keyword">function</span>(a,b,c,d){<span class="keyword">var</span> e=$(a);<span class="keyword">if</span>($(d).hasClass(<span class="keyword">this</span>._unselectableClass)||<span class="keyword">this</span>._isDisabledDatepicker(e[<span class="number">0</span>]))<span class="keyword">return</span>;<span class="keyword">var</span> f=<span class="keyword">this</span>._getInst(e[<span class="number">0</span>]);f.selectedDay=f.currentDay=$(<span class="string">"a"</span>,d).html(),f.selectedMonth=f.currentMonth=b,f.selectedYear=f.currentYear=c,<span class="keyword">this</span>._selectDate(a,<span class="keyword">this</span>._formatDate(f,f.currentDay,f.currentMonth,f.currentYear))},_clearDate:<span class="keyword">function</span>(a){<span class="keyword">var</span> b=$(a),c=<span class="keyword">this</span>._getInst(b[<span class="number">0</span>]);<span class="keyword">this</span>._selectDate(b,<span class="string">""</span>)},_selectDate:<span class="keyword">function</span>(a,b){<span class="keyword">var</span> c=$(a),d=<span class="keyword">this</span>._getInst(c[<span class="number">0</span>]);b=b!=<span class="literal">null</span>?b:<span class="keyword">this</span>._formatDate(d),d.input&amp;&amp;d.input.val(b),<span class="keyword">this</span>._updateAlternate(d);<span class="keyword">var</span> e=<span class="keyword">this</span>._get(d,<span class="string">"onSelect"</span>);e?e.apply(d.input?d.input[<span class="number">0</span>]:<span class="literal">null</span>,[b,d]):d.input&amp;&amp;d.input.trigger(<span class="string">"change"</span>),d.inline?<span class="keyword">this</span>._updateDatepicker(d):(<span class="keyword">this</span>._hideDatepicker(),<span class="keyword">this</span>._lastInput=d.input[<span class="number">0</span>],<span class="keyword">typeof</span> d.input[<span class="number">0</span>]!=<span class="string">"object"</span>&amp;&amp;d.input.focus(),<span class="keyword">this</span>._lastInput=<span class="literal">null</span>)},_updateAlternate:<span class="keyword">function</span>(a){<span class="keyword">var</span> b=<span class="keyword">this</span>._get(a,<span class="string">"altField"</span>);<span class="keyword">if</span>(b){<span class="keyword">var</span> c=<span class="keyword">this</span>._get(a,<span class="string">"altFormat"</span>)||<span class="keyword">this</span>._get(a,<span class="string">"dateFormat"</span>),d=<span class="keyword">this</span>._getDate(a),e=<span class="keyword">this</span>.formatDate(c,d,<span class="keyword">this</span>._getFormatConfig(a));$(b).each(<span class="keyword">function</span>(){$(<span class="keyword">this</span>).val(e)})}},noWeekends:<span class="keyword">function</span>(a){<span class="keyword">var</span> b=a.getDay();<span class="keyword">return</span>[b&gt;<span class="number">0</span>&amp;&amp;b&lt;<span class="number">6</span>,<span class="string">""</span>]},iso8601Week:<span class="keyword">function</span>(a){<span class="keyword">var</span> b=<span class="keyword">new</span> Date(a.getTime());b.setDate(b.getDate()+<span class="number">4</span>-(b.getDay()||<span class="number">7</span>));<span class="keyword">var</span> c=b.getTime();<span class="keyword">return</span> b.setMonth(<span class="number">0</span>),b.setDate(<span class="number">1</span>),Math.floor(Math.round((c-b)/<span class="number">864e5</span>)/<span class="number">7</span>)+<span class="number">1</span>},parseDate:<span class="keyword">function</span>(a,b,c){<span class="keyword">if</span>(a==<span class="literal">null</span>||b==<span class="literal">null</span>)<span class="keyword">throw</span><span class="string">"Invalid arguments"</span>;b=<span class="keyword">typeof</span> b==<span class="string">"object"</span>?b.toString():b+<span class="string">""</span>;<span class="keyword">if</span>(b==<span class="string">""</span>)<span class="keyword">return</span> <span class="literal">null</span>;<span class="keyword">var</span> d=(c?c.shortYearCutoff:<span class="literal">null</span>)||<span class="keyword">this</span>._defaults.shortYearCutoff;d=<span class="keyword">typeof</span> d!=<span class="string">"string"</span>?d:(<span class="keyword">new</span> Date).getFullYear()%<span class="number">100</span>+parseInt(d,<span class="number">10</span>);<span class="keyword">var</span> e=(c?c.dayNamesShort:<span class="literal">null</span>)||<span class="keyword">this</span>._defaults.dayNamesShort,f=(c?c.dayNames:<span class="literal">null</span>)||<span class="keyword">this</span>._defaults.dayNames,g=(c?c.monthNamesShort:<span class="literal">null</span>)||<span class="keyword">this</span>._defaults.monthNamesShort,h=(c?c.monthNames:<span class="literal">null</span>)||<span class="keyword">this</span>._defaults.monthNames,i=-<span class="number">1</span>,j=-<span class="number">1</span>,k=-<span class="number">1</span>,l=-<span class="number">1</span>,m=!<span class="number">1</span>,n=<span class="keyword">function</span>(b){<span class="keyword">var</span> c=s+<span class="number">1</span>&lt;a.length&amp;&amp;a.charAt(s+<span class="number">1</span>)==b;<span class="keyword">return</span> c&amp;&amp;s++,c},o=<span class="keyword">function</span>(a){<span class="keyword">var</span> c=n(a),d=a==<span class="string">"@"</span>?<span class="number">14</span>:a==<span class="string">"!"</span>?<span class="number">20</span>:a==<span class="string">"y"</span>&amp;&amp;c?<span class="number">4</span>:a==<span class="string">"o"</span>?<span class="number">3</span>:<span class="number">2</span>,e=<span class="keyword">new</span> RegExp(<span class="string">"^\\d{1,"</span>+d+<span class="string">"}"</span>),f=b.substring(r).match(e);<span class="keyword">if</span>(!f)<span class="keyword">throw</span><span class="string">"Missing number at position "</span>+r;<span class="keyword">return</span> r+=f[<span class="number">0</span>].length,parseInt(f[<span class="number">0</span>],<span class="number">10</span>)},p=<span class="keyword">function</span>(a,c,d){<span class="keyword">var</span> e=$.map(n(a)?d:c,<span class="keyword">function</span>(a,b){<span class="keyword">return</span>[[b,a]]}).sort(<span class="keyword">function</span>(a,b){<span class="keyword">return</span>-(a[<span class="number">1</span>].length-b[<span class="number">1</span>].length)}),f=-<span class="number">1</span>;$.each(e,<span class="keyword">function</span>(a,c){<span class="keyword">var</span> d=c[<span class="number">1</span>];<span class="keyword">if</span>(b.substr(r,d.length).toLowerCase()==d.toLowerCase())<span class="keyword">return</span> f=c[<span class="number">0</span>],r+=d.length,!<span class="number">1</span>});<span class="keyword">if</span>(f!=-<span class="number">1</span>)<span class="keyword">return</span> f+<span class="number">1</span>;<span class="keyword">throw</span><span class="string">"Unknown name at position "</span>+r},q=<span class="keyword">function</span>(){<span class="keyword">if</span>(b.charAt(r)!=a.charAt(s))<span class="keyword">throw</span><span class="string">"Unexpected literal at position "</span>+r;r++},r=<span class="number">0</span>;<span class="keyword">for</span>(<span class="keyword">var</span> s=<span class="number">0</span>;s&lt;a.length;s++)<span class="keyword">if</span>(m)a.charAt(s)==<span class="string">"'"</span>&amp;&amp;!n(<span class="string">"'"</span>)?m=!<span class="number">1</span>:q();<span class="keyword">else</span> <span class="keyword">switch</span>(a.charAt(s)){<span class="keyword">case</span><span class="string">"d"</span>:k=o(<span class="string">"d"</span>);<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"D"</span>:p(<span class="string">"D"</span>,e,f);<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"o"</span>:l=o(<span class="string">"o"</span>);<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"m"</span>:j=o(<span class="string">"m"</span>);<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"M"</span>:j=p(<span class="string">"M"</span>,g,h);<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"y"</span>:i=o(<span class="string">"y"</span>);<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"@"</span>:<span class="keyword">var</span> t=<span class="keyword">new</span> Date(o(<span class="string">"@"</span>));i=t.getFullYear(),j=t.getMonth()+<span class="number">1</span>,k=t.getDate();<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"!"</span>:<span class="keyword">var</span> t=<span class="keyword">new</span> Date((o(<span class="string">"!"</span>)-<span class="keyword">this</span>._ticksTo1970)/<span class="number">1e4</span>);i=t.getFullYear(),j=t.getMonth()+<span class="number">1</span>,k=t.getDate();<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"'"</span>:n(<span class="string">"'"</span>)?q():m=!<span class="number">0</span>;<span class="keyword">break</span>;<span class="keyword">default</span>:q()}<span class="keyword">if</span>(r&lt;b.length)<span class="keyword">throw</span><span class="string">"Extra/unparsed characters found in date: "</span>+b.substring(r);i==-<span class="number">1</span>?i=(<span class="keyword">new</span> Date).getFullYear():i&lt;<span class="number">100</span>&amp;&amp;(i+=(<span class="keyword">new</span> Date).getFullYear()-(<span class="keyword">new</span> Date).getFullYear()%<span class="number">100</span>+(i&lt;=d?<span class="number">0</span>:-<span class="number">100</span>));<span class="keyword">if</span>(l&gt;-<span class="number">1</span>){j=<span class="number">1</span>,k=l;<span class="keyword">do</span>{<span class="keyword">var</span> u=<span class="keyword">this</span>._getDaysInMonth(i,j-<span class="number">1</span>);<span class="keyword">if</span>(k&lt;=u)<span class="keyword">break</span>;j++,k-=u}<span class="keyword">while</span>(!<span class="number">0</span>)}<span class="keyword">var</span> t=<span class="keyword">this</span>._daylightSavingAdjust(<span class="keyword">new</span> Date(i,j-<span class="number">1</span>,k));<span class="keyword">if</span>(t.getFullYear()!=i||t.getMonth()+<span class="number">1</span>!=j||t.getDate()!=k)<span class="keyword">throw</span><span class="string">"Invalid date"</span>;<span class="keyword">return</span> t},ATOM:<span class="string">"yy-mm-dd"</span>,COOKIE:<span class="string">"D, dd M yy"</span>,ISO_8601:<span class="string">"yy-mm-dd"</span>,RFC_822:<span class="string">"D, d M y"</span>,RFC_850:<span class="string">"DD, dd-M-y"</span>,RFC_1036:<span class="string">"D, d M y"</span>,RFC_1123:<span class="string">"D, d M yy"</span>,RFC_2822:<span class="string">"D, d M yy"</span>,RSS:<span class="string">"D, d M y"</span>,TICKS:<span class="string">"!"</span>,TIMESTAMP:<span class="string">"@"</span>,W3C:<span class="string">"yy-mm-dd"</span>,_ticksTo1970:(<span class="number">718685</span>+Math.floor(<span class="number">492.5</span>)-Math.floor(<span class="number">19.7</span>)+Math.floor(<span class="number">4.925</span>))*<span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>*<span class="number">1e7</span>,formatDate:<span class="keyword">function</span>(a,b,c){<span class="keyword">if</span>(!b)<span class="keyword">return</span><span class="string">""</span>;<span class="keyword">var</span> d=(c?c.dayNamesShort:<span class="literal">null</span>)||<span class="keyword">this</span>._defaults.dayNamesShort,e=(c?c.dayNames:<span class="literal">null</span>)||<span class="keyword">this</span>._defaults.dayNames,f=(c?c.monthNamesShort:<span class="literal">null</span>)||<span class="keyword">this</span>._defaults.monthNamesShort,g=(c?c.monthNames:<span class="literal">null</span>)||<span class="keyword">this</span>._defaults.monthNames,h=<span class="keyword">function</span>(b){<span class="keyword">var</span> c=m+<span class="number">1</span>&lt;a.length&amp;&amp;a.charAt(m+<span class="number">1</span>)==b;<span class="keyword">return</span> c&amp;&amp;m++,c},i=<span class="keyword">function</span>(a,b,c){<span class="keyword">var</span> d=<span class="string">""</span>+b;<span class="keyword">if</span>(h(a))<span class="keyword">while</span>(d.length&lt;c)d=<span class="string">"0"</span>+d;<span class="keyword">return</span> d},j=<span class="keyword">function</span>(a,b,c,d){<span class="keyword">return</span> h(a)?d[b]:c[b]},k=<span class="string">""</span>,l=!<span class="number">1</span>;<span class="keyword">if</span>(b)<span class="keyword">for</span>(<span class="keyword">var</span> m=<span class="number">0</span>;m&lt;a.length;m++)<span class="keyword">if</span>(l)a.charAt(m)==<span class="string">"'"</span>&amp;&amp;!h(<span class="string">"'"</span>)?l=!<span class="number">1</span>:k+=a.charAt(m);<span class="keyword">else</span> <span class="keyword">switch</span>(a.charAt(m)){<span class="keyword">case</span><span class="string">"d"</span>:k+=i(<span class="string">"d"</span>,b.getDate(),<span class="number">2</span>);<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"D"</span>:k+=j(<span class="string">"D"</span>,b.getDay(),d,e);<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"o"</span>:k+=i(<span class="string">"o"</span>,Math.round(((<span class="keyword">new</span> Date(b.getFullYear(),b.getMonth(),b.getDate())).getTime()-(<span class="keyword">new</span> Date(b.getFullYear(),<span class="number">0</span>,<span class="number">0</span>)).getTime())/<span class="number">864e5</span>),<span class="number">3</span>);<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"m"</span>:k+=i(<span class="string">"m"</span>,b.getMonth()+<span class="number">1</span>,<span class="number">2</span>);<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"M"</span>:k+=j(<span class="string">"M"</span>,b.getMonth(),f,g);<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"y"</span>:k+=h(<span class="string">"y"</span>)?b.getFullYear():(b.getYear()%<span class="number">100</span>&lt;<span class="number">10</span>?<span class="string">"0"</span>:<span class="string">""</span>)+b.getYear()%<span class="number">100</span>;<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"@"</span>:k+=b.getTime();<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"!"</span>:k+=b.getTime()*<span class="number">1e4</span>+<span class="keyword">this</span>._ticksTo1970;<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"'"</span>:h(<span class="string">"'"</span>)?k+=<span class="string">"'"</span>:l=!<span class="number">0</span>;<span class="keyword">break</span>;<span class="keyword">default</span>:k+=a.charAt(m)}<span class="keyword">return</span> k},_possibleChars:<span class="keyword">function</span>(a){<span class="keyword">var</span> b=<span class="string">""</span>,c=!<span class="number">1</span>,d=<span class="keyword">function</span>(b){<span class="keyword">var</span> c=e+<span class="number">1</span>&lt;a.length&amp;&amp;a.charAt(e+<span class="number">1</span>)==b;<span class="keyword">return</span> c&amp;&amp;e++,c};<span class="keyword">for</span>(<span class="keyword">var</span> e=<span class="number">0</span>;e&lt;a.length;e++)<span class="keyword">if</span>(c)a.charAt(e)==<span class="string">"'"</span>&amp;&amp;!d(<span class="string">"'"</span>)?c=!<span class="number">1</span>:b+=a.charAt(e);<span class="keyword">else</span> <span class="keyword">switch</span>(a.charAt(e)){<span class="keyword">case</span><span class="string">"d"</span>:<span class="keyword">case</span><span class="string">"m"</span>:<span class="keyword">case</span><span class="string">"y"</span>:<span class="keyword">case</span><span class="string">"@"</span>:b+=<span class="string">"0123456789"</span>;<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"D"</span>:<span class="keyword">case</span><span class="string">"M"</span>:<span class="keyword">return</span> <span class="literal">null</span>;<span class="keyword">case</span><span class="string">"'"</span>:d(<span class="string">"'"</span>)?b+=<span class="string">"'"</span>:c=!<span class="number">0</span>;<span class="keyword">break</span>;<span class="keyword">default</span>:b+=a.charAt(e)}<span class="keyword">return</span> b},_get:<span class="keyword">function</span>(a,b){<span class="keyword">return</span> a.settings[b]!==<span class="literal">undefined</span>?a.settings[b]:<span class="keyword">this</span>._defaults[b]},_setDateFromField:<span class="keyword">function</span>(a,b){<span class="keyword">if</span>(a.input.val()==a.lastVal)<span class="keyword">return</span>;<span class="keyword">var</span> c=<span class="keyword">this</span>._get(a,<span class="string">"dateFormat"</span>),d=a.lastVal=a.input?a.input.val():<span class="literal">null</span>,e,f;e=f=<span class="keyword">this</span>._getDefaultDate(a);<span class="keyword">var</span> g=<span class="keyword">this</span>._getFormatConfig(a);<span class="keyword">try</span>{e=<span class="keyword">this</span>.parseDate(c,d,g)||f}<span class="keyword">catch</span>(h){<span class="keyword">this</span>.log(h),d=b?<span class="string">""</span>:d}a.selectedDay=e.getDate(),a.drawMonth=a.selectedMonth=e.getMonth(),a.drawYear=a.selectedYear=e.getFullYear(),a.currentDay=d?e.getDate():<span class="number">0</span>,a.currentMonth=d?e.getMonth():<span class="number">0</span>,a.currentYear=d?e.getFullYear():<span class="number">0</span>,<span class="keyword">this</span>._adjustInstDate(a)},_getDefaultDate:<span class="keyword">function</span>(a){<span class="keyword">return</span> <span class="keyword">this</span>._restrictMinMax(a,<span class="keyword">this</span>._determineDate(a,<span class="keyword">this</span>._get(a,<span class="string">"defaultDate"</span>),<span class="keyword">new</span> Date))},_determineDate:<span class="keyword">function</span>(a,b,c){<span class="keyword">var</span> d=<span class="keyword">function</span>(a){<span class="keyword">var</span> b=<span class="keyword">new</span> Date;<span class="keyword">return</span> b.setDate(b.getDate()+a),b},e=<span class="keyword">function</span>(b){<span class="keyword">try</span>{<span class="keyword">return</span> $.datepicker.parseDate($.datepicker._get(a,<span class="string">"dateFormat"</span>),b,$.datepicker._getFormatConfig(a))}<span class="keyword">catch</span>(c){}<span class="keyword">var</span> d=(b.toLowerCase().match(<span class="regexp">/^c/</span>)?$.datepicker._getDate(a):<span class="literal">null</span>)||<span class="keyword">new</span> Date,e=d.getFullYear(),f=d.getMonth(),g=d.getDate(),h=<span class="regexp">/([+-]?[0-9]+)\s*(d|D|w|W|m|M|y|Y)?/g</span>,i=h.exec(b);<span class="keyword">while</span>(i){<span class="keyword">switch</span>(i[<span class="number">2</span>]||<span class="string">"d"</span>){<span class="keyword">case</span><span class="string">"d"</span>:<span class="keyword">case</span><span class="string">"D"</span>:g+=parseInt(i[<span class="number">1</span>],<span class="number">10</span>);<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"w"</span>:<span class="keyword">case</span><span class="string">"W"</span>:g+=parseInt(i[<span class="number">1</span>],<span class="number">10</span>)*<span class="number">7</span>;<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"m"</span>:<span class="keyword">case</span><span class="string">"M"</span>:f+=parseInt(i[<span class="number">1</span>],<span class="number">10</span>),g=Math.min(g,$.datepicker._getDaysInMonth(e,f));<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"y"</span>:<span class="keyword">case</span><span class="string">"Y"</span>:e+=parseInt(i[<span class="number">1</span>],<span class="number">10</span>),g=Math.min(g,$.datepicker._getDaysInMonth(e,f))}i=h.exec(b)}<span class="keyword">return</span> <span class="keyword">new</span> Date(e,f,g)},f=b==<span class="literal">null</span>||b===<span class="string">""</span>?c:<span class="keyword">typeof</span> b==<span class="string">"string"</span>?e(b):<span class="keyword">typeof</span> b==<span class="string">"number"</span>?isNaN(b)?c:d(b):<span class="keyword">new</span> Date(b.getTime());<span class="keyword">return</span> f=f&amp;&amp;f.toString()==<span class="string">"Invalid Date"</span>?c:f,f&amp;&amp;(f.setHours(<span class="number">0</span>),f.setMinutes(<span class="number">0</span>),f.setSeconds(<span class="number">0</span>),f.setMilliseconds(<span class="number">0</span>)),<span class="keyword">this</span>._daylightSavingAdjust(f)},_daylightSavingAdjust:<span class="keyword">function</span>(a){<span class="keyword">return</span> a?(a.setHours(a.getHours()&gt;<span class="number">12</span>?a.getHours()+<span class="number">2</span>:<span class="number">0</span>),a):<span class="literal">null</span>},_setDate:<span class="keyword">function</span>(a,b,c){<span class="keyword">var</span> d=!b,e=a.selectedMonth,f=a.selectedYear,g=<span class="keyword">this</span>._restrictMinMax(a,<span class="keyword">this</span>._determineDate(a,b,<span class="keyword">new</span> Date));a.selectedDay=a.currentDay=g.getDate(),a.drawMonth=a.selectedMonth=a.currentMonth=g.getMonth(),a.drawYear=a.selectedYear=a.currentYear=g.getFullYear(),(e!=a.selectedMonth||f!=a.selectedYear)&amp;&amp;!c&amp;&amp;<span class="keyword">this</span>._notifyChange(a),<span class="keyword">this</span>._adjustInstDate(a),a.input&amp;&amp;a.input.val(d?<span class="string">""</span>:<span class="keyword">this</span>._formatDate(a))},_getDate:<span class="keyword">function</span>(a){<span class="keyword">var</span> b=!a.currentYear||a.input&amp;&amp;a.input.val()==<span class="string">""</span>?<span class="literal">null</span>:<span class="keyword">this</span>._daylightSavingAdjust(<span class="keyword">new</span> Date(a.currentYear,a.currentMonth,a.currentDay));<span class="keyword">return</span> b},_generateHTML:<span class="keyword">function</span>(a){<span class="keyword">var</span> b=<span class="keyword">new</span> Date;b=<span class="keyword">this</span>._daylightSavingAdjust(<span class="keyword">new</span> Date(b.getFullYear(),b.getMonth(),b.getDate()));<span class="keyword">var</span> c=<span class="keyword">this</span>._get(a,<span class="string">"isRTL"</span>),d=<span class="keyword">this</span>._get(a,<span class="string">"showButtonPanel"</span>),e=<span class="keyword">this</span>._get(a,<span class="string">"hideIfNoPrevNext"</span>),f=<span class="keyword">this</span>._get(a,<span class="string">"navigationAsDateFormat"</span>),g=<span class="keyword">this</span>._getNumberOfMonths(a),h=<span class="keyword">this</span>._get(a,<span class="string">"showCurrentAtPos"</span>),i=<span class="keyword">this</span>._get(a,<span class="string">"stepMonths"</span>),j=g[<span class="number">0</span>]!=<span class="number">1</span>||g[<span class="number">1</span>]!=<span class="number">1</span>,k=<span class="keyword">this</span>._daylightSavingAdjust(a.currentDay?<span class="keyword">new</span> Date(a.currentYear,a.currentMonth,a.currentDay):<span class="keyword">new</span> Date(<span class="number">9999</span>,<span class="number">9</span>,<span class="number">9</span>)),l=<span class="keyword">this</span>._getMinMaxDate(a,<span class="string">"min"</span>),m=<span class="keyword">this</span>._getMinMaxDate(a,<span class="string">"max"</span>),n=a.drawMonth-h,o=a.drawYear;n&lt;<span class="number">0</span>&amp;&amp;(n+=<span class="number">12</span>,o--);<span class="keyword">if</span>(m){<span class="keyword">var</span> p=<span class="keyword">this</span>._daylightSavingAdjust(<span class="keyword">new</span> Date(m.getFullYear(),m.getMonth()-g[<span class="number">0</span>]*g[<span class="number">1</span>]+<span class="number">1</span>,m.getDate()));p=l&amp;&amp;p&lt;l?l:p;<span class="keyword">while</span>(<span class="keyword">this</span>._daylightSavingAdjust(<span class="keyword">new</span> Date(o,n,<span class="number">1</span>))&gt;p)n--,n&lt;<span class="number">0</span>&amp;&amp;(n=<span class="number">11</span>,o--)}a.drawMonth=n,a.drawYear=o;<span class="keyword">var</span> q=<span class="keyword">this</span>._get(a,<span class="string">"prevText"</span>);q=f?<span class="keyword">this</span>.formatDate(q,<span class="keyword">this</span>._daylightSavingAdjust(<span class="keyword">new</span> Date(o,n-i,<span class="number">1</span>)),<span class="keyword">this</span>._getFormatConfig(a)):q;<span class="keyword">var</span> r=<span class="keyword">this</span>._canAdjustMonth(a,-<span class="number">1</span>,o,n)?<span class="string">'&lt;a class="ui-datepicker-prev ui-corner-all" onclick="DP_jQuery_'</span>+dpuuid+<span class="string">".datepicker._adjustDate('#"</span>+a.id+<span class="string">"', -"</span>+i+<span class="string">", 'M');\""</span>+<span class="string">' title="'</span>+q+<span class="string">'"&gt;&lt;span class="ui-icon ui-icon-circle-triangle-'</span>+(c?<span class="string">"e"</span>:<span class="string">"w"</span>)+<span class="string">'"&gt;'</span>+q+<span class="string">"&lt;/span&gt;&lt;/a&gt;"</span>:e?<span class="string">""</span>:<span class="string">'&lt;a class="ui-datepicker-prev ui-corner-all ui-state-disabled" title="'</span>+q+<span class="string">'"&gt;&lt;span class="ui-icon ui-icon-circle-triangle-'</span>+(c?<span class="string">"e"</span>:<span class="string">"w"</span>)+<span class="string">'"&gt;'</span>+q+<span class="string">"&lt;/span&gt;&lt;/a&gt;"</span>,s=<span class="keyword">this</span>._get(a,<span class="string">"nextText"</span>);s=f?<span class="keyword">this</span>.formatDate(s,<span class="keyword">this</span>._daylightSavingAdjust(<span class="keyword">new</span> Date(o,n+i,<span class="number">1</span>)),<span class="keyword">this</span>._getFormatConfig(a)):s;<span class="keyword">var</span> t=<span class="keyword">this</span>._canAdjustMonth(a,<span class="number">1</span>,o,n)?<span class="string">'&lt;a class="ui-datepicker-next ui-corner-all" onclick="DP_jQuery_'</span>+dpuuid+<span class="string">".datepicker._adjustDate('#"</span>+a.id+<span class="string">"', +"</span>+i+<span class="string">", 'M');\""</span>+<span class="string">' title="'</span>+s+<span class="string">'"&gt;&lt;span class="ui-icon ui-icon-circle-triangle-'</span>+(c?<span class="string">"w"</span>:<span class="string">"e"</span>)+<span class="string">'"&gt;'</span>+s+<span class="string">"&lt;/span&gt;&lt;/a&gt;"</span>:e?<span class="string">""</span>:<span class="string">'&lt;a class="ui-datepicker-next ui-corner-all ui-state-disabled" title="'</span>+s+<span class="string">'"&gt;&lt;span class="ui-icon ui-icon-circle-triangle-'</span>+(c?<span class="string">"w"</span>:<span class="string">"e"</span>)+<span class="string">'"&gt;'</span>+s+<span class="string">"&lt;/span&gt;&lt;/a&gt;"</span>,u=<span class="keyword">this</span>._get(a,<span class="string">"currentText"</span>),v=<span class="keyword">this</span>._get(a,<span class="string">"gotoCurrent"</span>)&amp;&amp;a.currentDay?k:b;u=f?<span class="keyword">this</span>.formatDate(u,v,<span class="keyword">this</span>._getFormatConfig(a)):u;<span class="keyword">var</span> w=a.inline?<span class="string">""</span>:<span class="string">'&lt;button type="button" class="ui-datepicker-close ui-state-default ui-priority-primary ui-corner-all" onclick="DP_jQuery_'</span>+dpuuid+<span class="string">'.datepicker._hideDatepicker();"&gt;'</span>+<span class="keyword">this</span>._get(a,<span class="string">"closeText"</span>)+<span class="string">"&lt;/button&gt;"</span>,x=d?<span class="string">'&lt;div class="ui-datepicker-buttonpane ui-widget-content"&gt;'</span>+(c?w:<span class="string">""</span>)+(<span class="keyword">this</span>._isInRange(a,v)?<span class="string">'&lt;button type="button" class="ui-datepicker-current ui-state-default ui-priority-secondary ui-corner-all" onclick="DP_jQuery_'</span>+dpuuid+<span class="string">".datepicker._gotoToday('#"</span>+a.id+<span class="string">"');\""</span>+<span class="string">"&gt;"</span>+u+<span class="string">"&lt;/button&gt;"</span>:<span class="string">""</span>)+(c?<span class="string">""</span>:w)+<span class="string">"&lt;/div&gt;"</span>:<span class="string">""</span>,y=parseInt(<span class="keyword">this</span>._get(a,<span class="string">"firstDay"</span>),<span class="number">10</span>);y=isNaN(y)?<span class="number">0</span>:y;<span class="keyword">var</span> z=<span class="keyword">this</span>._get(a,<span class="string">"showWeek"</span>),A=<span class="keyword">this</span>._get(a,<span class="string">"dayNames"</span>),B=<span class="keyword">this</span>._get(a,<span class="string">"dayNamesShort"</span>),C=<span class="keyword">this</span>._get(a,<span class="string">"dayNamesMin"</span>),D=<span class="keyword">this</span>._get(a,<span class="string">"monthNames"</span>),E=<span class="keyword">this</span>._get(a,<span class="string">"monthNamesShort"</span>),F=<span class="keyword">this</span>._get(a,<span class="string">"beforeShowDay"</span>),G=<span class="keyword">this</span>._get(a,<span class="string">"showOtherMonths"</span>),H=<span class="keyword">this</span>._get(a,<span class="string">"selectOtherMonths"</span>),I=<span class="keyword">this</span>._get(a,<span class="string">"calculateWeek"</span>)||<span class="keyword">this</span>.iso8601Week,J=<span class="keyword">this</span>._getDefaultDate(a),K=<span class="string">""</span>;<span class="keyword">for</span>(<span class="keyword">var</span> L=<span class="number">0</span>;L&lt;g[<span class="number">0</span>];L++){<span class="keyword">var</span> M=<span class="string">""</span>;<span class="keyword">this</span>.maxRows=<span class="number">4</span>;<span class="keyword">for</span>(<span class="keyword">var</span> N=<span class="number">0</span>;N&lt;g[<span class="number">1</span>];N++){<span class="keyword">var</span> O=<span class="keyword">this</span>._daylightSavingAdjust(<span class="keyword">new</span> Date(o,n,a.selectedDay)),P=<span class="string">" ui-corner-all"</span>,Q=<span class="string">""</span>;<span class="keyword">if</span>(j){Q+=<span class="string">'&lt;div class="ui-datepicker-group'</span>;<span class="keyword">if</span>(g[<span class="number">1</span>]&gt;<span class="number">1</span>)<span class="keyword">switch</span>(N){<span class="keyword">case</span> <span class="number">0</span>:Q+=<span class="string">" ui-datepicker-group-first"</span>,P=<span class="string">" ui-corner-"</span>+(c?<span class="string">"right"</span>:<span class="string">"left"</span>);<span class="keyword">break</span>;<span class="keyword">case</span> g[<span class="number">1</span>]-<span class="number">1</span>:Q+=<span class="string">" ui-datepicker-group-last"</span>,P=<span class="string">" ui-corner-"</span>+(c?<span class="string">"left"</span>:<span class="string">"right"</span>);<span class="keyword">break</span>;<span class="keyword">default</span>:Q+=<span class="string">" ui-datepicker-group-middle"</span>,P=<span class="string">""</span>}Q+=<span class="string">'"&gt;'</span>}Q+=<span class="string">'&lt;div class="ui-datepicker-header ui-widget-header ui-helper-clearfix'</span>+P+<span class="string">'"&gt;'</span>+(<span class="regexp">/all|left/</span>.test(P)&amp;&amp;L==<span class="number">0</span>?c?t:r:<span class="string">""</span>)+(<span class="regexp">/all|right/</span>.test(P)&amp;&amp;L==<span class="number">0</span>?c?r:t:<span class="string">""</span>)+<span class="keyword">this</span>._generateMonthYearHeader(a,n,o,l,m,L&gt;<span class="number">0</span>||N&gt;<span class="number">0</span>,D,E)+<span class="string">'&lt;/div&gt;&lt;table class="ui-datepicker-calendar"&gt;&lt;thead&gt;'</span>+<span class="string">"&lt;tr&gt;"</span>;<span class="keyword">var</span> R=z?<span class="string">'&lt;th class="ui-datepicker-week-col"&gt;'</span>+<span class="keyword">this</span>._get(a,<span class="string">"weekHeader"</span>)+<span class="string">"&lt;/th&gt;"</span>:<span class="string">""</span>;<span class="keyword">for</span>(<span class="keyword">var</span> S=<span class="number">0</span>;S&lt;<span class="number">7</span>;S++){<span class="keyword">var</span> T=(S+y)%<span class="number">7</span>;R+=<span class="string">"&lt;th"</span>+((S+y+<span class="number">6</span>)%<span class="number">7</span>&gt;=<span class="number">5</span>?<span class="string">' class="ui-datepicker-week-end"'</span>:<span class="string">""</span>)+<span class="string">"&gt;"</span>+<span class="string">'&lt;span title="'</span>+A[T]+<span class="string">'"&gt;'</span>+C[T]+<span class="string">"&lt;/span&gt;&lt;/th&gt;"</span>}Q+=R+<span class="string">"&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;"</span>;<span class="keyword">var</span> U=<span class="keyword">this</span>._getDaysInMonth(o,n);o==a.selectedYear&amp;&amp;n==a.selectedMonth&amp;&amp;(a.selectedDay=Math.min(a.selectedDay,U));<span class="keyword">var</span> V=(<span class="keyword">this</span>._getFirstDayOfMonth(o,n)-y+<span class="number">7</span>)%<span class="number">7</span>,W=Math.ceil((V+U)/<span class="number">7</span>),X=j?<span class="keyword">this</span>.maxRows&gt;W?<span class="keyword">this</span>.maxRows:W:W;<span class="keyword">this</span>.maxRows=X;<span class="keyword">var</span> Y=<span class="keyword">this</span>._daylightSavingAdjust(<span class="keyword">new</span> Date(o,n,<span class="number">1</span>-V));<span class="keyword">for</span>(<span class="keyword">var</span> Z=<span class="number">0</span>;Z&lt;X;Z++){Q+=<span class="string">"&lt;tr&gt;"</span>;<span class="keyword">var</span> _=z?<span class="string">'&lt;td class="ui-datepicker-week-col"&gt;'</span>+<span class="keyword">this</span>._get(a,<span class="string">"calculateWeek"</span>)(Y)+<span class="string">"&lt;/td&gt;"</span>:<span class="string">""</span>;<span class="keyword">for</span>(<span class="keyword">var</span> S=<span class="number">0</span>;S&lt;<span class="number">7</span>;S++){<span class="keyword">var</span> ba=F?F.apply(a.input?a.input[<span class="number">0</span>]:<span class="literal">null</span>,[Y]):[!<span class="number">0</span>,<span class="string">""</span>],bb=Y.getMonth()!=n,bc=bb&amp;&amp;!H||!ba[<span class="number">0</span>]||l&amp;&amp;Y&lt;l||m&amp;&amp;Y&gt;m;_+=<span class="string">'&lt;td class="'</span>+((S+y+<span class="number">6</span>)%<span class="number">7</span>&gt;=<span class="number">5</span>?<span class="string">" ui-datepicker-week-end"</span>:<span class="string">""</span>)+(bb?<span class="string">" ui-datepicker-other-month"</span>:<span class="string">""</span>)+(Y.getTime()==O.getTime()&amp;&amp;n==a.selectedMonth&amp;&amp;a._keyEvent||J.getTime()==Y.getTime()&amp;&amp;J.getTime()==O.getTime()?<span class="string">" "</span>+<span class="keyword">this</span>._dayOverClass:<span class="string">""</span>)+(bc?<span class="string">" "</span>+<span class="keyword">this</span>._unselectableClass+<span class="string">" ui-state-disabled"</span>:<span class="string">""</span>)+(bb&amp;&amp;!G?<span class="string">""</span>:<span class="string">" "</span>+ba[<span class="number">1</span>]+(Y.getTime()==k.getTime()?<span class="string">" "</span>+<span class="keyword">this</span>._currentClass:<span class="string">""</span>)+(Y.getTime()==b.getTime()?<span class="string">" ui-datepicker-today"</span>:<span class="string">""</span>))+<span class="string">'"'</span>+((!bb||G)&amp;&amp;ba[<span class="number">2</span>]?<span class="string">' title="'</span>+ba[<span class="number">2</span>]+<span class="string">'"'</span>:<span class="string">""</span>)+(bc?<span class="string">""</span>:<span class="string">' onclick="DP_jQuery_'</span>+dpuuid+<span class="string">".datepicker._selectDay('#"</span>+a.id+<span class="string">"',"</span>+Y.getMonth()+<span class="string">","</span>+Y.getFullYear()+<span class="string">', this);return false;"'</span>)+<span class="string">"&gt;"</span>+(bb&amp;&amp;!G?<span class="string">"&amp;#xa0;"</span>:bc?<span class="string">'&lt;span class="ui-state-default"&gt;'</span>+Y.getDate()+<span class="string">"&lt;/span&gt;"</span>:<span class="string">'&lt;a class="ui-state-default'</span>+(Y.getTime()==b.getTime()?<span class="string">" ui-state-highlight"</span>:<span class="string">""</span>)+(Y.getTime()==k.getTime()?<span class="string">" ui-state-active"</span>:<span class="string">""</span>)+(bb?<span class="string">" ui-priority-secondary"</span>:<span class="string">""</span>)+<span class="string">'" href="#"&gt;'</span>+Y.getDate()+<span class="string">"&lt;/a&gt;"</span>)+<span class="string">"&lt;/td&gt;"</span>,Y.setDate(Y.getDate()+<span class="number">1</span>),Y=<span class="keyword">this</span>._daylightSavingAdjust(Y)}Q+=_+<span class="string">"&lt;/tr&gt;"</span>}n++,n&gt;<span class="number">11</span>&amp;&amp;(n=<span class="number">0</span>,o++),Q+=<span class="string">"&lt;/tbody&gt;&lt;/table&gt;"</span>+(j?<span class="string">"&lt;/div&gt;"</span>+(g[<span class="number">0</span>]&gt;<span class="number">0</span>&amp;&amp;N==g[<span class="number">1</span>]-<span class="number">1</span>?<span class="string">'&lt;div class="ui-datepicker-row-break"&gt;&lt;/div&gt;'</span>:<span class="string">""</span>):<span class="string">""</span>),M+=Q}K+=M}<span class="keyword">return</span> K+=x+($.browser.msie&amp;&amp;parseInt($.browser.version,<span class="number">10</span>)&lt;<span class="number">7</span>&amp;&amp;!a.inline?<span class="string">'&lt;iframe src="javascript:false;" class="ui-datepicker-cover" frameborder="0"&gt;&lt;/iframe&gt;'</span>:<span class="string">""</span>),a._keyEvent=!<span class="number">1</span>,K},_generateMonthYearHeader:<span class="keyword">function</span>(a,b,c,d,e,f,g,h){<span class="keyword">var</span> i=<span class="keyword">this</span>._get(a,<span class="string">"changeMonth"</span>),j=<span class="keyword">this</span>._get(a,<span class="string">"changeYear"</span>),k=<span class="keyword">this</span>._get(a,<span class="string">"showMonthAfterYear"</span>),l=<span class="string">'&lt;div class="ui-datepicker-title"&gt;'</span>,m=<span class="string">""</span>;<span class="keyword">if</span>(f||!i)m+=<span class="string">'&lt;span class="ui-datepicker-month"&gt;'</span>+g[b]+<span class="string">"&lt;/span&gt;"</span>;<span class="keyword">else</span>{<span class="keyword">var</span> n=d&amp;&amp;d.getFullYear()==c,o=e&amp;&amp;e.getFullYear()==c;m+=<span class="string">'&lt;select class="ui-datepicker-month" onchange="DP_jQuery_'</span>+dpuuid+<span class="string">".datepicker._selectMonthYear('#"</span>+a.id+<span class="string">"', this, 'M');\" "</span>+<span class="string">"&gt;"</span>;<span class="keyword">for</span>(<span class="keyword">var</span> p=<span class="number">0</span>;p&lt;<span class="number">12</span>;p++)(!n||p&gt;=d.getMonth())&amp;&amp;(!o||p&lt;=e.getMonth())&amp;&amp;(m+=<span class="string">'&lt;option value="'</span>+p+<span class="string">'"'</span>+(p==b?<span class="string">' selected="selected"'</span>:<span class="string">""</span>)+<span class="string">"&gt;"</span>+h[p]+<span class="string">"&lt;/option&gt;"</span>);m+=<span class="string">"&lt;/select&gt;"</span>}k||(l+=m+(f||!i||!j?<span class="string">"&amp;#xa0;"</span>:<span class="string">""</span>));<span class="keyword">if</span>(!a.yearshtml){a.yearshtml=<span class="string">""</span>;<span class="keyword">if</span>(f||!j)l+=<span class="string">'&lt;span class="ui-datepicker-year"&gt;'</span>+c+<span class="string">"&lt;/span&gt;"</span>;<span class="keyword">else</span>{<span class="keyword">var</span> q=<span class="keyword">this</span>._get(a,<span class="string">"yearRange"</span>).split(<span class="string">":"</span>),r=(<span class="keyword">new</span> Date).getFullYear(),s=<span class="keyword">function</span>(a){<span class="keyword">var</span> b=a.match(<span class="regexp">/c[+-].*/</span>)?c+parseInt(a.substring(<span class="number">1</span>),<span class="number">10</span>):a.match(<span class="regexp">/[+-].*/</span>)?r+parseInt(a,<span class="number">10</span>):parseInt(a,<span class="number">10</span>);<span class="keyword">return</span> isNaN(b)?r:b},t=s(q[<span class="number">0</span>]),u=Math.max(t,s(q[<span class="number">1</span>]||<span class="string">""</span>));t=d?Math.max(t,d.getFullYear()):t,u=e?Math.min(u,e.getFullYear()):u,a.yearshtml+=<span class="string">'&lt;select class="ui-datepicker-year" onchange="DP_jQuery_'</span>+dpuuid+<span class="string">".datepicker._selectMonthYear('#"</span>+a.id+<span class="string">"', this, 'Y');\" "</span>+<span class="string">"&gt;"</span>;<span class="keyword">for</span>(;t&lt;=u;t++)a.yearshtml+=<span class="string">'&lt;option value="'</span>+t+<span class="string">'"'</span>+(t==c?<span class="string">' selected="selected"'</span>:<span class="string">""</span>)+<span class="string">"&gt;"</span>+t+<span class="string">"&lt;/option&gt;"</span>;a.yearshtml+=<span class="string">"&lt;/select&gt;"</span>,l+=a.yearshtml,a.yearshtml=<span class="literal">null</span>}}<span class="keyword">return</span> l+=<span class="keyword">this</span>._get(a,<span class="string">"yearSuffix"</span>),k&amp;&amp;(l+=(f||!i||!j?<span class="string">"&amp;#xa0;"</span>:<span class="string">""</span>)+m),l+=<span class="string">"&lt;/div&gt;"</span>,l},_adjustInstDate:<span class="keyword">function</span>(a,b,c){<span class="keyword">var</span> d=a.drawYear+(c==<span class="string">"Y"</span>?b:<span class="number">0</span>),e=a.drawMonth+(c==<span class="string">"M"</span>?b:<span class="number">0</span>),f=Math.min(a.selectedDay,<span class="keyword">this</span>._getDaysInMonth(d,e))+(c==<span class="string">"D"</span>?b:<span class="number">0</span>),g=<span class="keyword">this</span>._restrictMinMax(a,<span class="keyword">this</span>._daylightSavingAdjust(<span class="keyword">new</span> Date(d,e,f)));a.selectedDay=g.getDate(),a.drawMonth=a.selectedMonth=g.getMonth(),a.drawYear=a.selectedYear=g.getFullYear(),(c==<span class="string">"M"</span>||c==<span class="string">"Y"</span>)&amp;&amp;<span class="keyword">this</span>._notifyChange(a)},_restrictMinMax:<span class="keyword">function</span>(a,b){<span class="keyword">var</span> c=<span class="keyword">this</span>._getMinMaxDate(a,<span class="string">"min"</span>),d=<span class="keyword">this</span>._getMinMaxDate(a,<span class="string">"max"</span>),e=c&amp;&amp;b&lt;c?c:b;<span class="keyword">return</span> e=d&amp;&amp;e&gt;d?d:e,e},_notifyChange:<span class="keyword">function</span>(a){<span class="keyword">var</span> b=<span class="keyword">this</span>._get(a,<span class="string">"onChangeMonthYear"</span>);b&amp;&amp;b.apply(a.input?a.input[<span class="number">0</span>]:<span class="literal">null</span>,[a.selectedYear,a.selectedMonth+<span class="number">1</span>,a])},_getNumberOfMonths:<span class="keyword">function</span>(a){<span class="keyword">var</span> b=<span class="keyword">this</span>._get(a,<span class="string">"numberOfMonths"</span>);<span class="keyword">return</span> b==<span class="literal">null</span>?[<span class="number">1</span>,<span class="number">1</span>]:<span class="keyword">typeof</span> b==<span class="string">"number"</span>?[<span class="number">1</span>,b]:b},_getMinMaxDate:<span class="keyword">function</span>(a,b){<span class="keyword">return</span> <span class="keyword">this</span>._determineDate(a,<span class="keyword">this</span>._get(a,b+<span class="string">"Date"</span>),<span class="literal">null</span>)},_getDaysInMonth:<span class="keyword">function</span>(a,b){<span class="keyword">return</span> <span class="number">32</span>-<span class="keyword">this</span>._daylightSavingAdjust(<span class="keyword">new</span> Date(a,b,<span class="number">32</span>)).getDate()},_getFirstDayOfMonth:<span class="keyword">function</span>(a,b){<span class="keyword">return</span>(<span class="keyword">new</span> Date(a,b,<span class="number">1</span>)).getDay()},_canAdjustMonth:<span class="keyword">function</span>(a,b,c,d){<span class="keyword">var</span> e=<span class="keyword">this</span>._getNumberOfMonths(a),f=<span class="keyword">this</span>._daylightSavingAdjust(<span class="keyword">new</span> Date(c,d+(b&lt;<span class="number">0</span>?b:e[<span class="number">0</span>]*e[<span class="number">1</span>]),<span class="number">1</span>));<span class="keyword">return</span> b&lt;<span class="number">0</span>&amp;&amp;f.setDate(<span class="keyword">this</span>._getDaysInMonth(f.getFullYear(),f.getMonth())),<span class="keyword">this</span>._isInRange(a,f)},_isInRange:<span class="keyword">function</span>(a,b){<span class="keyword">var</span> c=<span class="keyword">this</span>._getMinMaxDate(a,<span class="string">"min"</span>),d=<span class="keyword">this</span>._getMinMaxDate(a,<span class="string">"max"</span>);<span class="keyword">return</span>(!c||b.getTime()&gt;=c.getTime())&amp;&amp;(!d||b.getTime()&lt;=d.getTime())},_getFormatConfig:<span class="keyword">function</span>(a){<span class="keyword">var</span> b=<span class="keyword">this</span>._get(a,<span class="string">"shortYearCutoff"</span>);<span class="keyword">return</span> b=<span class="keyword">typeof</span> b!=<span class="string">"string"</span>?b:(<span class="keyword">new</span> Date).getFullYear()%<span class="number">100</span>+parseInt(b,<span class="number">10</span>),{shortYearCutoff:b,dayNamesShort:<span class="keyword">this</span>._get(a,<span class="string">"dayNamesShort"</span>),dayNames:<span class="keyword">this</span>._get(a,<span class="string">"dayNames"</span>),monthNamesShort:<span class="keyword">this</span>._get(a,<span class="string">"monthNamesShort"</span>),monthNames:<span class="keyword">this</span>._get(a,<span class="string">"monthNames"</span>)}},_formatDate:<span class="keyword">function</span>(a,b,c,d){b||(a.currentDay=a.selectedDay,a.currentMonth=a.selectedMonth,a.currentYear=a.selectedYear);<span class="keyword">var</span> e=b?<span class="keyword">typeof</span> b==<span class="string">"object"</span>?b:<span class="keyword">this</span>._daylightSavingAdjust(<span class="keyword">new</span> Date(d,c,b)):<span class="keyword">this</span>._daylightSavingAdjust(<span class="keyword">new</span> Date(a.currentYear,a.currentMonth,a.currentDay));<span class="keyword">return</span> <span class="keyword">this</span>.formatDate(<span class="keyword">this</span>._get(a,<span class="string">"dateFormat"</span>),e,<span class="keyword">this</span>._getFormatConfig(a))}}),$.fn.datepicker=<span class="keyword">function</span>(a){<span class="keyword">if</span>(!<span class="keyword">this</span>.length)<span class="keyword">return</span> <span class="keyword">this</span>;$.datepicker.initialized||($(document).mousedown($.datepicker._checkExternalClick).find(<span class="string">"body"</span>).append($.datepicker.dpDiv),$.datepicker.initialized=!<span class="number">0</span>);<span class="keyword">var</span> b=Array.prototype.slice.call(arguments,<span class="number">1</span>);<span class="keyword">return</span> <span class="keyword">typeof</span> a!=<span class="string">"string"</span>||a!=<span class="string">"isDisabled"</span>&amp;&amp;a!=<span class="string">"getDate"</span>&amp;&amp;a!=<span class="string">"widget"</span>?a==<span class="string">"option"</span>&amp;&amp;arguments.length==<span class="number">2</span>&amp;&amp;<span class="keyword">typeof</span> arguments[<span class="number">1</span>]==<span class="string">"string"</span>?$.datepicker[<span class="string">"_"</span>+a+<span class="string">"Datepicker"</span>].apply($.datepicker,[<span class="keyword">this</span>[<span class="number">0</span>]].concat(b)):<span class="keyword">this</span>.each(<span class="keyword">function</span>(){<span class="keyword">typeof</span> a==<span class="string">"string"</span>?$.datepicker[<span class="string">"_"</span>+a+<span class="string">"Datepicker"</span>].apply($.datepicker,[<span class="keyword">this</span>].concat(b)):$.datepicker._attachDatepicker(<span class="keyword">this</span>,a)}):$.datepicker[<span class="string">"_"</span>+a+<span class="string">"Datepicker"</span>].apply($.datepicker,[<span class="keyword">this</span>[<span class="number">0</span>]].concat(b))},$.datepicker=<span class="keyword">new</span> Datepicker,$.datepicker.initialized=!<span class="number">1</span>,$.datepicker.uuid=(<span class="keyword">new</span> Date).getTime(),$.datepicker.version=<span class="string">"1.8.21"</span>,window[<span class="string">"DP_jQuery_"</span>+dpuuid]=$}(jQuery),<span class="keyword">function</span>(a,b){<span class="keyword">var</span> c=<span class="string">"ui-dialog ui-widget ui-widget-content ui-corner-all "</span>,d={buttons:!<span class="number">0</span>,height:!<span class="number">0</span>,maxHeight:!<span class="number">0</span>,maxWidth:!<span class="number">0</span>,minHeight:!<span class="number">0</span>,minWidth:!<span class="number">0</span>,width:!<span class="number">0</span>},e={maxHeight:!<span class="number">0</span>,maxWidth:!<span class="number">0</span>,minHeight:!<span class="number">0</span>,minWidth:!<span class="number">0</span>},f=a.attrFn||{val:!<span class="number">0</span>,css:!<span class="number">0</span>,html:!<span class="number">0</span>,text:!<span class="number">0</span>,data:!<span class="number">0</span>,width:!<span class="number">0</span>,height:!<span class="number">0</span>,offset:!<span class="number">0</span>,click:!<span class="number">0</span>};a.widget(<span class="string">"ui.dialog"</span>,{options:{autoOpen:!<span class="number">0</span>,buttons:{},closeOnEscape:!<span class="number">0</span>,closeText:<span class="string">"close"</span>,dialogClass:<span class="string">""</span>,draggable:!<span class="number">0</span>,hide:<span class="literal">null</span>,height:<span class="string">"auto"</span>,maxHeight:!<span class="number">1</span>,maxWidth:!<span class="number">1</span>,minHeight:<span class="number">150</span>,minWidth:<span class="number">150</span>,modal:!<span class="number">1</span>,position:{my:<span class="string">"center"</span>,at:<span class="string">"center"</span>,collision:<span class="string">"fit"</span>,using:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=a(<span class="keyword">this</span>).css(b).offset().top;c&lt;<span class="number">0</span>&amp;&amp;a(<span class="keyword">this</span>).css(<span class="string">"top"</span>,b.top-c)}},resizable:!<span class="number">0</span>,show:<span class="literal">null</span>,stack:!<span class="number">0</span>,title:<span class="string">""</span>,width:<span class="number">300</span>,zIndex:<span class="number">1e3</span>},_create:<span class="keyword">function</span>(){<span class="keyword">this</span>.originalTitle=<span class="keyword">this</span>.element.attr(<span class="string">"title"</span>),<span class="keyword">typeof</span> <span class="keyword">this</span>.originalTitle!=<span class="string">"string"</span>&amp;&amp;(<span class="keyword">this</span>.originalTitle=<span class="string">""</span>),<span class="keyword">this</span>.options.title=<span class="keyword">this</span>.options.title||<span class="keyword">this</span>.originalTitle;<span class="keyword">var</span> b=<span class="keyword">this</span>,d=b.options,e=d.title||<span class="string">"&amp;#160;"</span>,f=a.ui.dialog.getTitleId(b.element),g=(b.uiDialog=a(<span class="string">"&lt;div&gt;&lt;/div&gt;"</span>)).appendTo(document.body).hide().addClass(c+d.dialogClass).css({zIndex:d.zIndex}).attr(<span class="string">"tabIndex"</span>,-<span class="number">1</span>).css(<span class="string">"outline"</span>,<span class="number">0</span>).keydown(<span class="keyword">function</span>(c){d.closeOnEscape&amp;&amp;!c.isDefaultPrevented()&amp;&amp;c.keyCode&amp;&amp;c.keyCode===a.ui.keyCode.ESCAPE&amp;&amp;(b.close(c),c.preventDefault())}).attr({role:<span class="string">"dialog"</span>,<span class="string">"aria-labelledby"</span>:f}).mousedown(<span class="keyword">function</span>(a){b.moveToTop(!<span class="number">1</span>,a)}),h=b.element.show().removeAttr(<span class="string">"title"</span>).addClass(<span class="string">"ui-dialog-content ui-widget-content"</span>).appendTo(g),i=(b.uiDialogTitlebar=a(<span class="string">"&lt;div&gt;&lt;/div&gt;"</span>)).addClass(<span class="string">"ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"</span>).prependTo(g),j=a(<span class="string">'&lt;a href="#"&gt;&lt;/a&gt;'</span>).addClass(<span class="string">"ui-dialog-titlebar-close ui-corner-all"</span>).attr(<span class="string">"role"</span>,<span class="string">"button"</span>).hover(<span class="keyword">function</span>(){j.addClass(<span class="string">"ui-state-hover"</span>)},<span class="keyword">function</span>(){j.removeClass(<span class="string">"ui-state-hover"</span>)}).focus(<span class="keyword">function</span>(){j.addClass(<span class="string">"ui-state-focus"</span>)}).blur(<span class="keyword">function</span>(){j.removeClass(<span class="string">"ui-state-focus"</span>)}).click(<span class="keyword">function</span>(a){<span class="keyword">return</span> b.close(a),!<span class="number">1</span>}).appendTo(i),k=(b.uiDialogTitlebarCloseText=a(<span class="string">"&lt;span&gt;&lt;/span&gt;"</span>)).addClass(<span class="string">"ui-icon ui-icon-closethick"</span>).text(d.closeText).appendTo(j),l=a(<span class="string">"&lt;span&gt;&lt;/span&gt;"</span>).addClass(<span class="string">"ui-dialog-title"</span>).attr(<span class="string">"id"</span>,f).html(e).prependTo(i);a.isFunction(d.beforeclose)&amp;&amp;!a.isFunction(d.beforeClose)&amp;&amp;(d.beforeClose=d.beforeclose),i.find(<span class="string">"*"</span>).add(i).disableSelection(),d.draggable&amp;&amp;a.fn.draggable&amp;&amp;b._makeDraggable(),d.resizable&amp;&amp;a.fn.resizable&amp;&amp;b._makeResizable(),b._createButtons(d.buttons),b._isOpen=!<span class="number">1</span>,a.fn.bgiframe&amp;&amp;g.bgiframe()},_init:<span class="keyword">function</span>(){<span class="keyword">this</span>.options.autoOpen&amp;&amp;<span class="keyword">this</span>.open()},destroy:<span class="keyword">function</span>(){<span class="keyword">var</span> a=<span class="keyword">this</span>;<span class="keyword">return</span> a.overlay&amp;&amp;a.overlay.destroy(),a.uiDialog.hide(),a.element.unbind(<span class="string">".dialog"</span>).removeData(<span class="string">"dialog"</span>).removeClass(<span class="string">"ui-dialog-content ui-widget-content"</span>).hide().appendTo(<span class="string">"body"</span>),a.uiDialog.remove(),a.originalTitle&amp;&amp;a.element.attr(<span class="string">"title"</span>,a.originalTitle),a},widget:<span class="keyword">function</span>(){<span class="keyword">return</span> <span class="keyword">this</span>.uiDialog},close:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=<span class="keyword">this</span>,d,e;<span class="keyword">if</span>(!<span class="number">1</span>===c._trigger(<span class="string">"beforeClose"</span>,b))<span class="keyword">return</span>;<span class="keyword">return</span> c.overlay&amp;&amp;c.overlay.destroy(),c.uiDialog.unbind(<span class="string">"keypress.ui-dialog"</span>),c._isOpen=!<span class="number">1</span>,c.options.hide?c.uiDialog.hide(c.options.hide,<span class="keyword">function</span>(){c._trigger(<span class="string">"close"</span>,b)}):(c.uiDialog.hide(),c._trigger(<span class="string">"close"</span>,b)),a.ui.dialog.overlay.resize(),c.options.modal&amp;&amp;(d=<span class="number">0</span>,a(<span class="string">".ui-dialog"</span>).each(<span class="keyword">function</span>(){<span class="keyword">this</span>!==c.uiDialog[<span class="number">0</span>]&amp;&amp;(e=a(<span class="keyword">this</span>).css(<span class="string">"z-index"</span>),isNaN(e)||(d=Math.max(d,e)))}),a.ui.dialog.maxZ=d),c},isOpen:<span class="keyword">function</span>(){<span class="keyword">return</span> <span class="keyword">this</span>._isOpen},moveToTop:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=<span class="keyword">this</span>,e=d.options,f;<span class="keyword">return</span> e.modal&amp;&amp;!b||!e.stack&amp;&amp;!e.modal?d._trigger(<span class="string">"focus"</span>,c):(e.zIndex&gt;a.ui.dialog.maxZ&amp;&amp;(a.ui.dialog.maxZ=e.zIndex),d.overlay&amp;&amp;(a.ui.dialog.maxZ+=<span class="number">1</span>,d.overlay.$el.css(<span class="string">"z-index"</span>,a.ui.dialog.overlay.maxZ=a.ui.dialog.maxZ)),f={scrollTop:d.element.scrollTop(),scrollLeft:d.element.scrollLeft()},a.ui.dialog.maxZ+=<span class="number">1</span>,d.uiDialog.css(<span class="string">"z-index"</span>,a.ui.dialog.maxZ),d.element.attr(f),d._trigger(<span class="string">"focus"</span>,c),d)},open:<span class="keyword">function</span>(){<span class="keyword">if</span>(<span class="keyword">this</span>._isOpen)<span class="keyword">return</span>;<span class="keyword">var</span> b=<span class="keyword">this</span>,c=b.options,d=b.uiDialog;<span class="keyword">return</span> b.overlay=c.modal?<span class="keyword">new</span> a.ui.dialog.overlay(b):<span class="literal">null</span>,b._size(),b._position(c.position),d.show(c.show),b.moveToTop(!<span class="number">0</span>),c.modal&amp;&amp;d.bind(<span class="string">"keydown.ui-dialog"</span>,<span class="keyword">function</span>(b){<span class="keyword">if</span>(b.keyCode!==a.ui.keyCode.TAB)<span class="keyword">return</span>;<span class="keyword">var</span> c=a(<span class="string">":tabbable"</span>,<span class="keyword">this</span>),d=c.filter(<span class="string">":first"</span>),e=c.filter(<span class="string">":last"</span>);<span class="keyword">if</span>(b.target===e[<span class="number">0</span>]&amp;&amp;!b.shiftKey)<span class="keyword">return</span> d.focus(<span class="number">1</span>),!<span class="number">1</span>;<span class="keyword">if</span>(b.target===d[<span class="number">0</span>]&amp;&amp;b.shiftKey)<span class="keyword">return</span> e.focus(<span class="number">1</span>),!<span class="number">1</span>}),a(b.element.find(<span class="string">":tabbable"</span>).get().concat(d.find(<span class="string">".ui-dialog-buttonpane :tabbable"</span>).get().concat(d.get()))).eq(<span class="number">0</span>).focus(),b._isOpen=!<span class="number">0</span>,b._trigger(<span class="string">"open"</span>),b},_createButtons:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=<span class="keyword">this</span>,d=!<span class="number">1</span>,e=a(<span class="string">"&lt;div&gt;&lt;/div&gt;"</span>).addClass(<span class="string">"ui-dialog-buttonpane ui-widget-content ui-helper-clearfix"</span>),g=a(<span class="string">"&lt;div&gt;&lt;/div&gt;"</span>).addClass(<span class="string">"ui-dialog-buttonset"</span>).appendTo(e);c.uiDialog.find(<span class="string">".ui-dialog-buttonpane"</span>).remove(),<span class="keyword">typeof</span> b==<span class="string">"object"</span>&amp;&amp;b!==<span class="literal">null</span>&amp;&amp;a.each(b,<span class="keyword">function</span>(){<span class="keyword">return</span>!(d=!<span class="number">0</span>)}),d&amp;&amp;(a.each(b,<span class="keyword">function</span>(b,d){d=a.isFunction(d)?{click:d,text:b}:d;<span class="keyword">var</span> e=a(<span class="string">'&lt;button type="button"&gt;&lt;/button&gt;'</span>).click(<span class="keyword">function</span>(){d.click.apply(c.element[<span class="number">0</span>],arguments)}).appendTo(g);a.each(d,<span class="keyword">function</span>(a,b){<span class="keyword">if</span>(a===<span class="string">"click"</span>)<span class="keyword">return</span>;a <span class="keyword">in</span> f?e[a](b):e.attr(a,b)}),a.fn.button&amp;&amp;e.button()}),e.appendTo(c.uiDialog))},_makeDraggable:<span class="keyword">function</span>(){<span class="function"><span class="keyword">function</span> <span class="title">f</span><span class="params">(a)</span>{</span><span class="keyword">return</span>{position:a.position,offset:a.offset}}<span class="keyword">var</span> b=<span class="keyword">this</span>,c=b.options,d=a(document),e;b.uiDialog.draggable({cancel:<span class="string">".ui-dialog-content, .ui-dialog-titlebar-close"</span>,handle:<span class="string">".ui-dialog-titlebar"</span>,containment:<span class="string">"document"</span>,start:<span class="keyword">function</span>(d,g){e=c.height===<span class="string">"auto"</span>?<span class="string">"auto"</span>:a(<span class="keyword">this</span>).height(),a(<span class="keyword">this</span>).height(a(<span class="keyword">this</span>).height()).addClass(<span class="string">"ui-dialog-dragging"</span>),b._trigger(<span class="string">"dragStart"</span>,d,f(g))},drag:<span class="keyword">function</span>(a,c){b._trigger(<span class="string">"drag"</span>,a,f(c))},stop:<span class="keyword">function</span>(g,h){c.position=[h.position.left-d.scrollLeft(),h.position.top-d.scrollTop()],a(<span class="keyword">this</span>).removeClass(<span class="string">"ui-dialog-dragging"</span>).height(e),b._trigger(<span class="string">"dragStop"</span>,g,f(h)),a.ui.dialog.overlay.resize()}})},_makeResizable:<span class="keyword">function</span>(c){<span class="function"><span class="keyword">function</span> <span class="title">h</span><span class="params">(a)</span>{</span><span class="keyword">return</span>{originalPosition:a.originalPosition,originalSize:a.originalSize,position:a.position,size:a.size}}c=c===b?<span class="keyword">this</span>.options.resizable:c;<span class="keyword">var</span> d=<span class="keyword">this</span>,e=d.options,f=d.uiDialog.css(<span class="string">"position"</span>),g=<span class="keyword">typeof</span> c==<span class="string">"string"</span>?c:<span class="string">"n,e,s,w,se,sw,ne,nw"</span>;d.uiDialog.resizable({cancel:<span class="string">".ui-dialog-content"</span>,containment:<span class="string">"document"</span>,alsoResize:d.element,maxWidth:e.maxWidth,maxHeight:e.maxHeight,minWidth:e.minWidth,minHeight:d._minHeight(),handles:g,start:<span class="keyword">function</span>(b,c){a(<span class="keyword">this</span>).addClass(<span class="string">"ui-dialog-resizing"</span>),d._trigger(<span class="string">"resizeStart"</span>,b,h(c))},resize:<span class="keyword">function</span>(a,b){d._trigger(<span class="string">"resize"</span>,a,h(b))},stop:<span class="keyword">function</span>(b,c){a(<span class="keyword">this</span>).removeClass(<span class="string">"ui-dialog-resizing"</span>),e.height=a(<span class="keyword">this</span>).height(),e.width=a(<span class="keyword">this</span>).width(),d._trigger(<span class="string">"resizeStop"</span>,b,h(c)),a.ui.dialog.overlay.resize()}}).css(<span class="string">"position"</span>,f).find(<span class="string">".ui-resizable-se"</span>).addClass(<span class="string">"ui-icon ui-icon-grip-diagonal-se"</span>)},_minHeight:<span class="keyword">function</span>(){<span class="keyword">var</span> a=<span class="keyword">this</span>.options;<span class="keyword">return</span> a.height===<span class="string">"auto"</span>?a.minHeight:Math.min(a.minHeight,a.height)},_position:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=[],d=[<span class="number">0</span>,<span class="number">0</span>],e;<span class="keyword">if</span>(b){<span class="keyword">if</span>(<span class="keyword">typeof</span> b==<span class="string">"string"</span>||<span class="keyword">typeof</span> b==<span class="string">"object"</span>&amp;&amp;<span class="string">"0"</span><span class="keyword">in</span> b)c=b.split?b.split(<span class="string">" "</span>):[b[<span class="number">0</span>],b[<span class="number">1</span>]],c.length===<span class="number">1</span>&amp;&amp;(c[<span class="number">1</span>]=c[<span class="number">0</span>]),a.each([<span class="string">"left"</span>,<span class="string">"top"</span>],<span class="keyword">function</span>(a,b){+c[a]===c[a]&amp;&amp;(d[a]=c[a],c[a]=b)}),b={my:c.join(<span class="string">" "</span>),at:c.join(<span class="string">" "</span>),offset:d.join(<span class="string">" "</span>)};b=a.extend({},a.ui.dialog.prototype.options.position,b)}<span class="keyword">else</span> b=a.ui.dialog.prototype.options.position;e=<span class="keyword">this</span>.uiDialog.is(<span class="string">":visible"</span>),e||<span class="keyword">this</span>.uiDialog.show(),<span class="keyword">this</span>.uiDialog.css({top:<span class="number">0</span>,left:<span class="number">0</span>}).position(a.extend({of:window},b)),e||<span class="keyword">this</span>.uiDialog.hide()},_setOptions:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=<span class="keyword">this</span>,f={},g=!<span class="number">1</span>;a.each(b,<span class="keyword">function</span>(a,b){c._setOption(a,b),a <span class="keyword">in</span> d&amp;&amp;(g=!<span class="number">0</span>),a <span class="keyword">in</span> e&amp;&amp;(f[a]=b)}),g&amp;&amp;<span class="keyword">this</span>._size(),<span class="keyword">this</span>.uiDialog.is(<span class="string">":data(resizable)"</span>)&amp;&amp;<span class="keyword">this</span>.uiDialog.resizable(<span class="string">"option"</span>,f)},_setOption:<span class="keyword">function</span>(b,d){<span class="keyword">var</span> e=<span class="keyword">this</span>,f=e.uiDialog;<span class="keyword">switch</span>(b){<span class="keyword">case</span><span class="string">"beforeclose"</span>:b=<span class="string">"beforeClose"</span>;<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"buttons"</span>:e._createButtons(d);<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"closeText"</span>:e.uiDialogTitlebarCloseText.text(<span class="string">""</span>+d);<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"dialogClass"</span>:f.removeClass(e.options.dialogClass).addClass(c+d);<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"disabled"</span>:d?f.addClass(<span class="string">"ui-dialog-disabled"</span>):f.removeClass(<span class="string">"ui-dialog-disabled"</span>);<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"draggable"</span>:<span class="keyword">var</span> g=f.is(<span class="string">":data(draggable)"</span>);g&amp;&amp;!d&amp;&amp;f.draggable(<span class="string">"destroy"</span>),!g&amp;&amp;d&amp;&amp;e._makeDraggable();<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"position"</span>:e._position(d);<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"resizable"</span>:<span class="keyword">var</span> h=f.is(<span class="string">":data(resizable)"</span>);h&amp;&amp;!d&amp;&amp;f.resizable(<span class="string">"destroy"</span>),h&amp;&amp;<span class="keyword">typeof</span> d==<span class="string">"string"</span>&amp;&amp;f.resizable(<span class="string">"option"</span>,<span class="string">"handles"</span>,d),!h&amp;&amp;d!==!<span class="number">1</span>&amp;&amp;e._makeResizable(d);<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"title"</span>:a(<span class="string">".ui-dialog-title"</span>,e.uiDialogTitlebar).html(<span class="string">""</span>+(d||<span class="string">"&amp;#160;"</span>))}a.Widget.prototype._setOption.apply(e,arguments)},_size:<span class="keyword">function</span>(){<span class="keyword">var</span> b=<span class="keyword">this</span>.options,c,d,e=<span class="keyword">this</span>.uiDialog.is(<span class="string">":visible"</span>);<span class="keyword">this</span>.element.show().css({width:<span class="string">"auto"</span>,minHeight:<span class="number">0</span>,height:<span class="number">0</span>}),b.minWidth&gt;b.width&amp;&amp;(b.width=b.minWidth),c=<span class="keyword">this</span>.uiDialog.css({height:<span class="string">"auto"</span>,width:b.width}).height(),d=Math.max(<span class="number">0</span>,b.minHeight-c);<span class="keyword">if</span>(b.height===<span class="string">"auto"</span>)<span class="keyword">if</span>(a.support.minHeight)<span class="keyword">this</span>.element.css({minHeight:d,height:<span class="string">"auto"</span>});<span class="keyword">else</span>{<span class="keyword">this</span>.uiDialog.show();<span class="keyword">var</span> f=<span class="keyword">this</span>.element.css(<span class="string">"height"</span>,<span class="string">"auto"</span>).height();e||<span class="keyword">this</span>.uiDialog.hide(),<span class="keyword">this</span>.element.height(Math.max(f,d))}<span class="keyword">else</span> <span class="keyword">this</span>.element.height(Math.max(b.height-c,<span class="number">0</span>));<span class="keyword">this</span>.uiDialog.is(<span class="string">":data(resizable)"</span>)&amp;&amp;<span class="keyword">this</span>.uiDialog.resizable(<span class="string">"option"</span>,<span class="string">"minHeight"</span>,<span class="keyword">this</span>._minHeight())}}),a.extend(a.ui.dialog,{version:<span class="string">"1.8.21"</span>,uuid:<span class="number">0</span>,maxZ:<span class="number">0</span>,getTitleId:<span class="keyword">function</span>(a){<span class="keyword">var</span> b=a.attr(<span class="string">"id"</span>);<span class="keyword">return</span> b||(<span class="keyword">this</span>.uuid+=<span class="number">1</span>,b=<span class="keyword">this</span>.uuid),<span class="string">"ui-dialog-title-"</span>+b},overlay:<span class="keyword">function</span>(b){<span class="keyword">this</span>.$el=a.ui.dialog.overlay.create(b)}}),a.extend(a.ui.dialog.overlay,{instances:[],oldInstances:[],maxZ:<span class="number">0</span>,events:a.map(<span class="string">"focus,mousedown,mouseup,keydown,keypress,click"</span>.split(<span class="string">","</span>),<span class="keyword">function</span>(a){<span class="keyword">return</span> a+<span class="string">".dialog-overlay"</span>}).join(<span class="string">" "</span>),create:<span class="keyword">function</span>(b){<span class="keyword">this</span>.instances.length===<span class="number">0</span>&amp;&amp;(setTimeout(<span class="keyword">function</span>(){a.ui.dialog.overlay.instances.length&amp;&amp;a(document).bind(a.ui.dialog.overlay.events,<span class="keyword">function</span>(b){<span class="keyword">if</span>(a(b.target).zIndex()&lt;a.ui.dialog.overlay.maxZ)<span class="keyword">return</span>!<span class="number">1</span>})},<span class="number">1</span>),a(document).bind(<span class="string">"keydown.dialog-overlay"</span>,<span class="keyword">function</span>(c){b.options.closeOnEscape&amp;&amp;!c.isDefaultPrevented()&amp;&amp;c.keyCode&amp;&amp;c.keyCode===a.ui.keyCode.ESCAPE&amp;&amp;(b.close(c),c.preventDefault())}),a(window).bind(<span class="string">"resize.dialog-overlay"</span>,a.ui.dialog.overlay.resize));<span class="keyword">var</span> c=(<span class="keyword">this</span>.oldInstances.pop()||a(<span class="string">"&lt;div&gt;&lt;/div&gt;"</span>).addClass(<span class="string">"ui-widget-overlay"</span>)).appendTo(document.body).css({width:<span class="keyword">this</span>.width(),height:<span class="keyword">this</span>.height()});<span class="keyword">return</span> a.fn.bgiframe&amp;&amp;c.bgiframe(),<span class="keyword">this</span>.instances.push(c),c},destroy:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=a.inArray(b,<span class="keyword">this</span>.instances);c!=-<span class="number">1</span>&amp;&amp;<span class="keyword">this</span>.oldInstances.push(<span class="keyword">this</span>.instances.splice(c,<span class="number">1</span>)[<span class="number">0</span>]),<span class="keyword">this</span>.instances.length===<span class="number">0</span>&amp;&amp;a([document,window]).unbind(<span class="string">".dialog-overlay"</span>),b.remove();<span class="keyword">var</span> d=<span class="number">0</span>;a.each(<span class="keyword">this</span>.instances,<span class="keyword">function</span>(){d=Math.max(d,<span class="keyword">this</span>.css(<span class="string">"z-index"</span>))}),<span class="keyword">this</span>.maxZ=d},height:<span class="keyword">function</span>(){<span class="keyword">var</span> b,c;<span class="keyword">return</span> a.browser.msie&amp;&amp;a.browser.version&lt;<span class="number">7</span>?(b=Math.max(document.documentElement.scrollHeight,document.body.scrollHeight),c=Math.max(document.documentElement.offsetHeight,document.body.offsetHeight),b&lt;c?a(window).height()+<span class="string">"px"</span>:b+<span class="string">"px"</span>):a(document).height()+<span class="string">"px"</span>},width:<span class="keyword">function</span>(){<span class="keyword">var</span> b,c;<span class="keyword">return</span> a.browser.msie?(b=Math.max(document.documentElement.scrollWidth,document.body.scrollWidth),c=Math.max(document.documentElement.offsetWidth,document.body.offsetWidth),b&lt;c?a(window).width()+<span class="string">"px"</span>:b+<span class="string">"px"</span>):a(document).width()+<span class="string">"px"</span>},resize:<span class="keyword">function</span>(){<span class="keyword">var</span> b=a([]);a.each(a.ui.dialog.overlay.instances,<span class="keyword">function</span>(){b=b.add(<span class="keyword">this</span>)}),b.css({width:<span class="number">0</span>,height:<span class="number">0</span>}).css({width:a.ui.dialog.overlay.width(),height:a.ui.dialog.overlay.height()})}}),a.extend(a.ui.dialog.overlay.prototype,{destroy:<span class="keyword">function</span>(){a.ui.dialog.overlay.destroy(<span class="keyword">this</span>.$el)}})}(jQuery),<span class="keyword">function</span>(a,b){a.ui=a.ui||{};<span class="keyword">var</span> c=<span class="regexp">/left|center|right/</span>,d=<span class="regexp">/top|center|bottom/</span>,e=<span class="string">"center"</span>,f={},g=a.fn.position,h=a.fn.offset;a.fn.position=<span class="keyword">function</span>(b){<span class="keyword">if</span>(!b||!b.of)<span class="keyword">return</span> g.apply(<span class="keyword">this</span>,arguments);b=a.extend({},b);<span class="keyword">var</span> h=a(b.of),i=h[<span class="number">0</span>],j=(b.collision||<span class="string">"flip"</span>).split(<span class="string">" "</span>),k=b.offset?b.offset.split(<span class="string">" "</span>):[<span class="number">0</span>,<span class="number">0</span>],l,m,n;<span class="keyword">return</span> i.nodeType===<span class="number">9</span>?(l=h.width(),m=h.height(),n={top:<span class="number">0</span>,left:<span class="number">0</span>}):i.setTimeout?(l=h.width(),m=h.height(),n={top:h.scrollTop(),left:h.scrollLeft()}):i.preventDefault?(b.at=<span class="string">"left top"</span>,l=m=<span class="number">0</span>,n={top:b.of.pageY,left:b.of.pageX}):(l=h.outerWidth(),m=h.outerHeight(),n=h.offset()),a.each([<span class="string">"my"</span>,<span class="string">"at"</span>],<span class="keyword">function</span>(){<span class="keyword">var</span> a=(b[<span class="keyword">this</span>]||<span class="string">""</span>).split(<span class="string">" "</span>);a.length===<span class="number">1</span>&amp;&amp;(a=c.test(a[<span class="number">0</span>])?a.concat([e]):d.test(a[<span class="number">0</span>])?[e].concat(a):[e,e]),a[<span class="number">0</span>]=c.test(a[<span class="number">0</span>])?a[<span class="number">0</span>]:e,a[<span class="number">1</span>]=d.test(a[<span class="number">1</span>])?a[<span class="number">1</span>]:e,b[<span class="keyword">this</span>]=a}),j.length===<span class="number">1</span>&amp;&amp;(j[<span class="number">1</span>]=j[<span class="number">0</span>]),k[<span class="number">0</span>]=parseInt(k[<span class="number">0</span>],<span class="number">10</span>)||<span class="number">0</span>,k.length===<span class="number">1</span>&amp;&amp;(k[<span class="number">1</span>]=k[<span class="number">0</span>]),k[<span class="number">1</span>]=parseInt(k[<span class="number">1</span>],<span class="number">10</span>)||<span class="number">0</span>,b.at[<span class="number">0</span>]===<span class="string">"right"</span>?n.left+=l:b.at[<span class="number">0</span>]===e&amp;&amp;(n.left+=l/<span class="number">2</span>),b.at[<span class="number">1</span>]===<span class="string">"bottom"</span>?n.top+=m:b.at[<span class="number">1</span>]===e&amp;&amp;(n.top+=m/<span class="number">2</span>),n.left+=k[<span class="number">0</span>],n.top+=k[<span class="number">1</span>],<span class="keyword">this</span>.each(<span class="keyword">function</span>(){<span class="keyword">var</span> c=a(<span class="keyword">this</span>),d=c.outerWidth(),g=c.outerHeight(),h=parseInt(a.curCSS(<span class="keyword">this</span>,<span class="string">"marginLeft"</span>,!<span class="number">0</span>))||<span class="number">0</span>,i=parseInt(a.curCSS(<span class="keyword">this</span>,<span class="string">"marginTop"</span>,!<span class="number">0</span>))||<span class="number">0</span>,o=d+h+(parseInt(a.curCSS(<span class="keyword">this</span>,<span class="string">"marginRight"</span>,!<span class="number">0</span>))||<span class="number">0</span>),p=g+i+(parseInt(a.curCSS(<span class="keyword">this</span>,<span class="string">"marginBottom"</span>,!<span class="number">0</span>))||<span class="number">0</span>),q=a.extend({},n),r;b.my[<span class="number">0</span>]===<span class="string">"right"</span>?q.left-=d:b.my[<span class="number">0</span>]===e&amp;&amp;(q.left-=d/<span class="number">2</span>),b.my[<span class="number">1</span>]===<span class="string">"bottom"</span>?q.top-=g:b.my[<span class="number">1</span>]===e&amp;&amp;(q.top-=g/<span class="number">2</span>),f.fractions||(q.left=Math.round(q.left),q.top=Math.round(q.top)),r={left:q.left-h,top:q.top-i},a.each([<span class="string">"left"</span>,<span class="string">"top"</span>],<span class="keyword">function</span>(c,e){a.ui.position[j[c]]&amp;&amp;a.ui.position[j[c]][e](q,{targetWidth:l,targetHeight:m,elemWidth:d,elemHeight:g,collisionPosition:r,collisionWidth:o,collisionHeight:p,offset:k,my:b.my,at:b.at})}),a.fn.bgiframe&amp;&amp;c.bgiframe(),c.offset(a.extend(q,{using:b.using}))})},a.ui.position={fit:{left:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=a(window),e=c.collisionPosition.left+c.collisionWidth-d.width()-d.scrollLeft();b.left=e&gt;<span class="number">0</span>?b.left-e:Math.max(b.left-c.collisionPosition.left,b.left)},top:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d=a(window),e=c.collisionPosition.top+c.collisionHeight-d.height()-d.scrollTop();b.top=e&gt;<span class="number">0</span>?b.top-e:Math.max(b.top-c.collisionPosition.top,b.top)}},flip:{left:<span class="keyword">function</span>(b,c){<span class="keyword">if</span>(c.at[<span class="number">0</span>]===e)<span class="keyword">return</span>;<span class="keyword">var</span> d=a(window),f=c.collisionPosition.left+c.collisionWidth-d.width()-d.scrollLeft(),g=c.my[<span class="number">0</span>]===<span class="string">"left"</span>?-c.elemWidth:c.my[<span class="number">0</span>]===<span class="string">"right"</span>?c.elemWidth:<span class="number">0</span>,h=c.at[<span class="number">0</span>]===<span class="string">"left"</span>?c.targetWidth:-c.targetWidth,i=-<span class="number">2</span>*c.offset[<span class="number">0</span>];b.left+=c.collisionPosition.left&lt;<span class="number">0</span>?g+h+i:f&gt;<span class="number">0</span>?g+h+i:<span class="number">0</span>},top:<span class="keyword">function</span>(b,c){<span class="keyword">if</span>(c.at[<span class="number">1</span>]===e)<span class="keyword">return</span>;<span class="keyword">var</span> d=a(window),f=c.collisionPosition.top+c.collisionHeight-d.height()-d.scrollTop(),g=c.my[<span class="number">1</span>]===<span class="string">"top"</span>?-c.elemHeight:c.my[<span class="number">1</span>]===<span class="string">"bottom"</span>?c.elemHeight:<span class="number">0</span>,h=c.at[<span class="number">1</span>]===<span class="string">"top"</span>?c.targetHeight:-c.targetHeight,i=-<span class="number">2</span>*c.offset[<span class="number">1</span>];b.top+=c.collisionPosition.top&lt;<span class="number">0</span>?g+h+i:f&gt;<span class="number">0</span>?g+h+i:<span class="number">0</span>}}},a.offset.setOffset||(a.offset.setOffset=<span class="keyword">function</span>(b,c){<span class="regexp">/static/</span>.test(a.curCSS(b,<span class="string">"position"</span>))&amp;&amp;(b.style.position=<span class="string">"relative"</span>);<span class="keyword">var</span> d=a(b),e=d.offset(),f=parseInt(a.curCSS(b,<span class="string">"top"</span>,!<span class="number">0</span>),<span class="number">10</span>)||<span class="number">0</span>,g=parseInt(a.curCSS(b,<span class="string">"left"</span>,!<span class="number">0</span>),<span class="number">10</span>)||<span class="number">0</span>,h={top:c.top-e.top+f,left:c.left-e.left+g};<span class="string">"using"</span><span class="keyword">in</span> c?c.using.call(b,h):d.css(h)},a.fn.offset=<span class="keyword">function</span>(b){<span class="keyword">var</span> c=<span class="keyword">this</span>[<span class="number">0</span>];<span class="keyword">return</span>!c||!c.ownerDocument?<span class="literal">null</span>:b?a.isFunction(b)?<span class="keyword">this</span>.each(<span class="keyword">function</span>(c){a(<span class="keyword">this</span>).offset(b.call(<span class="keyword">this</span>,c,a(<span class="keyword">this</span>).offset()))}):<span class="keyword">this</span>.each(<span class="keyword">function</span>(){a.offset.setOffset(<span class="keyword">this</span>,b)}):h.call(<span class="keyword">this</span>)}),<span class="keyword">function</span>(){<span class="keyword">var</span> b=document.getElementsByTagName(<span class="string">"body"</span>)[<span class="number">0</span>],c=document.createElement(<span class="string">"div"</span>),d,e,g,h,i;d=document.createElement(b?<span class="string">"div"</span>:<span class="string">"body"</span>),g={visibility:<span class="string">"hidden"</span>,width:<span class="number">0</span>,height:<span class="number">0</span>,border:<span class="number">0</span>,margin:<span class="number">0</span>,background:<span class="string">"none"</span>},b&amp;&amp;a.extend(g,{position:<span class="string">"absolute"</span>,left:<span class="string">"-1000px"</span>,top:<span class="string">"-1000px"</span>});<span class="keyword">for</span>(<span class="keyword">var</span> j <span class="keyword">in</span> g)d.style[j]=g[j];d.appendChild(c),e=b||document.documentElement,e.insertBefore(d,e.firstChild),c.style.cssText=<span class="string">"position: absolute; left: 10.7432222px; top: 10.432325px; height: 30px; width: 201px;"</span>,h=a(c).offset(<span class="keyword">function</span>(a,b){<span class="keyword">return</span> b}).offset(),d.innerHTML=<span class="string">""</span>,e.removeChild(d),i=h.top+h.left+(b?<span class="number">2e3</span>:<span class="number">0</span>),f.fractions=i&gt;<span class="number">21</span>&amp;&amp;i&lt;<span class="number">22</span>}()}(jQuery),<span class="keyword">function</span>(a,b){a.widget(<span class="string">"ui.progressbar"</span>,{options:{value:<span class="number">0</span>,max:<span class="number">100</span>},min:<span class="number">0</span>,_create:<span class="keyword">function</span>(){<span class="keyword">this</span>.element.addClass(<span class="string">"ui-progressbar ui-widget ui-widget-content ui-corner-all"</span>).attr({role:<span class="string">"progressbar"</span>,<span class="string">"aria-valuemin"</span>:<span class="keyword">this</span>.min,<span class="string">"aria-valuemax"</span>:<span class="keyword">this</span>.options.max,<span class="string">"aria-valuenow"</span>:<span class="keyword">this</span>._value()}),<span class="keyword">this</span>.valueDiv=a(<span class="string">"&lt;div class='ui-progressbar-value ui-widget-header ui-corner-left'&gt;&lt;/div&gt;"</span>).appendTo(<span class="keyword">this</span>.element),<span class="keyword">this</span>.oldValue=<span class="keyword">this</span>._value(),<span class="keyword">this</span>._refreshValue()},destroy:<span class="keyword">function</span>(){<span class="keyword">this</span>.element.removeClass(<span class="string">"ui-progressbar ui-widget ui-widget-content ui-corner-all"</span>).removeAttr(<span class="string">"role"</span>).removeAttr(<span class="string">"aria-valuemin"</span>).removeAttr(<span class="string">"aria-valuemax"</span>).removeAttr(<span class="string">"aria-valuenow"</span>),<span class="keyword">this</span>.valueDiv.remove(),a.Widget.prototype.destroy.apply(<span class="keyword">this</span>,arguments)},value:<span class="keyword">function</span>(a){<span class="keyword">return</span> a===b?<span class="keyword">this</span>._value():(<span class="keyword">this</span>._setOption(<span class="string">"value"</span>,a),<span class="keyword">this</span>)},_setOption:<span class="keyword">function</span>(b,c){b===<span class="string">"value"</span>&amp;&amp;(<span class="keyword">this</span>.options.value=c,<span class="keyword">this</span>._refreshValue(),<span class="keyword">this</span>._value()===<span class="keyword">this</span>.options.max&amp;&amp;<span class="keyword">this</span>._trigger(<span class="string">"complete"</span>)),a.Widget.prototype._setOption.apply(<span class="keyword">this</span>,arguments)},_value:<span class="keyword">function</span>(){<span class="keyword">var</span> a=<span class="keyword">this</span>.options.value;<span class="keyword">return</span> <span class="keyword">typeof</span> a!=<span class="string">"number"</span>&amp;&amp;(a=<span class="number">0</span>),Math.min(<span class="keyword">this</span>.options.max,Math.max(<span class="keyword">this</span>.min,a))},_percentage:<span class="keyword">function</span>(){<span class="keyword">return</span> <span class="number">100</span>*<span class="keyword">this</span>._value()/<span class="keyword">this</span>.options.max},_refreshValue:<span class="keyword">function</span>(){<span class="keyword">var</span> a=<span class="keyword">this</span>.value(),b=<span class="keyword">this</span>._percentage();<span class="keyword">this</span>.oldValue!==a&amp;&amp;(<span class="keyword">this</span>.oldValue=a,<span class="keyword">this</span>._trigger(<span class="string">"change"</span>)),<span class="keyword">this</span>.valueDiv.toggle(a&gt;<span class="keyword">this</span>.min).toggleClass(<span class="string">"ui-corner-right"</span>,a===<span class="keyword">this</span>.options.max).width(b.toFixed(<span class="number">0</span>)+<span class="string">"%"</span>),<span class="keyword">this</span>.element.attr(<span class="string">"aria-valuenow"</span>,a)}}),a.extend(a.ui.progressbar,{version:<span class="string">"1.8.21"</span>})}(jQuery),<span class="keyword">function</span>(a,b){<span class="keyword">var</span> c=<span class="number">5</span>;a.widget(<span class="string">"ui.slider"</span>,a.ui.mouse,{widgetEventPrefix:<span class="string">"slide"</span>,options:{animate:!<span class="number">1</span>,distance:<span class="number">0</span>,max:<span class="number">100</span>,min:<span class="number">0</span>,orientation:<span class="string">"horizontal"</span>,range:!<span class="number">1</span>,step:<span class="number">1</span>,value:<span class="number">0</span>,values:<span class="literal">null</span>},_create:<span class="keyword">function</span>(){<span class="keyword">var</span> b=<span class="keyword">this</span>,d=<span class="keyword">this</span>.options,e=<span class="keyword">this</span>.element.find(<span class="string">".ui-slider-handle"</span>).addClass(<span class="string">"ui-state-default ui-corner-all"</span>),f=<span class="string">"&lt;a class='ui-slider-handle ui-state-default ui-corner-all' href='#'&gt;&lt;/a&gt;"</span>,g=d.values&amp;&amp;d.values.length||<span class="number">1</span>,h=[];<span class="keyword">this</span>._keySliding=!<span class="number">1</span>,<span class="keyword">this</span>._mouseSliding=!<span class="number">1</span>,<span class="keyword">this</span>._animateOff=!<span class="number">0</span>,<span class="keyword">this</span>._handleIndex=<span class="literal">null</span>,<span class="keyword">this</span>._detectOrientation(),<span class="keyword">this</span>._mouseInit(),<span class="keyword">this</span>.element.addClass(<span class="string">"ui-slider ui-slider-"</span>+<span class="keyword">this</span>.orientation+<span class="string">" ui-widget"</span>+<span class="string">" ui-widget-content"</span>+<span class="string">" ui-corner-all"</span>+(d.disabled?<span class="string">" ui-slider-disabled ui-disabled"</span>:<span class="string">""</span>)),<span class="keyword">this</span>.range=a([]),d.range&amp;&amp;(d.range===!<span class="number">0</span>&amp;&amp;(d.values||(d.values=[<span class="keyword">this</span>._valueMin(),<span class="keyword">this</span>._valueMin()]),d.values.length&amp;&amp;d.values.length!==<span class="number">2</span>&amp;&amp;(d.values=[d.values[<span class="number">0</span>],d.values[<span class="number">0</span>]])),<span class="keyword">this</span>.range=a(<span class="string">"&lt;div&gt;&lt;/div&gt;"</span>).appendTo(<span class="keyword">this</span>.element).addClass(<span class="string">"ui-slider-range ui-widget-header"</span>+(d.range===<span class="string">"min"</span>||d.range===<span class="string">"max"</span>?<span class="string">" ui-slider-range-"</span>+d.range:<span class="string">""</span>)));<span class="keyword">for</span>(<span class="keyword">var</span> i=e.length;i&lt;g;i+=<span class="number">1</span>)h.push(f);<span class="keyword">this</span>.handles=e.add(a(h.join(<span class="string">""</span>)).appendTo(b.element)),<span class="keyword">this</span>.handle=<span class="keyword">this</span>.handles.eq(<span class="number">0</span>),<span class="keyword">this</span>.handles.add(<span class="keyword">this</span>.range).filter(<span class="string">"a"</span>).click(<span class="keyword">function</span>(a){a.preventDefault()}).hover(<span class="keyword">function</span>(){d.disabled||a(<span class="keyword">this</span>).addClass(<span class="string">"ui-state-hover"</span>)},<span class="keyword">function</span>(){a(<span class="keyword">this</span>).removeClass(<span class="string">"ui-state-hover"</span>)}).focus(<span class="keyword">function</span>(){d.disabled?a(<span class="keyword">this</span>).blur():(a(<span class="string">".ui-slider .ui-state-focus"</span>).removeClass(<span class="string">"ui-state-focus"</span>),a(<span class="keyword">this</span>).addClass(<span class="string">"ui-state-focus"</span>))}).blur(<span class="keyword">function</span>(){a(<span class="keyword">this</span>).removeClass(<span class="string">"ui-state-focus"</span>)}),<span class="keyword">this</span>.handles.each(<span class="keyword">function</span>(b){a(<span class="keyword">this</span>).data(<span class="string">"index.ui-slider-handle"</span>,b)}),<span class="keyword">this</span>.handles.keydown(<span class="keyword">function</span>(d){<span class="keyword">var</span> e=a(<span class="keyword">this</span>).data(<span class="string">"index.ui-slider-handle"</span>),f,g,h,i;<span class="keyword">if</span>(b.options.disabled)<span class="keyword">return</span>;<span class="keyword">switch</span>(d.keyCode){<span class="keyword">case</span> a.ui.keyCode.HOME:<span class="keyword">case</span> a.ui.keyCode.END:<span class="keyword">case</span> a.ui.keyCode.PAGE_UP:<span class="keyword">case</span> a.ui.keyCode.PAGE_DOWN:<span class="keyword">case</span> a.ui.keyCode.UP:<span class="keyword">case</span> a.ui.keyCode.RIGHT:<span class="keyword">case</span> a.ui.keyCode.DOWN:<span class="keyword">case</span> a.ui.keyCode.LEFT:d.preventDefault();<span class="keyword">if</span>(!b._keySliding){b._keySliding=!<span class="number">0</span>,a(<span class="keyword">this</span>).addClass(<span class="string">"ui-state-active"</span>),f=b._start(d,e);<span class="keyword">if</span>(f===!<span class="number">1</span>)<span class="keyword">return</span>}}i=b.options.step,b.options.values&amp;&amp;b.options.values.length?g=h=b.values(e):g=h=b.value();<span class="keyword">switch</span>(d.keyCode){<span class="keyword">case</span> a.ui.keyCode.HOME:h=b._valueMin();<span class="keyword">break</span>;<span class="keyword">case</span> a.ui.keyCode.END:h=b._valueMax();<span class="keyword">break</span>;<span class="keyword">case</span> a.ui.keyCode.PAGE_UP:h=b._trimAlignValue(g+(b._valueMax()-b._valueMin())/c);<span class="keyword">break</span>;<span class="keyword">case</span> a.ui.keyCode.PAGE_DOWN:h=b._trimAlignValue(g-(b._valueMax()-b._valueMin())/c);<span class="keyword">break</span>;<span class="keyword">case</span> a.ui.keyCode.UP:<span class="keyword">case</span> a.ui.keyCode.RIGHT:<span class="keyword">if</span>(g===b._valueMax())<span class="keyword">return</span>;h=b._trimAlignValue(g+i);<span class="keyword">break</span>;<span class="keyword">case</span> a.ui.keyCode.DOWN:<span class="keyword">case</span> a.ui.keyCode.LEFT:<span class="keyword">if</span>(g===b._valueMin())<span class="keyword">return</span>;h=b._trimAlignValue(g-i)}b._slide(d,e,h)}).keyup(<span class="keyword">function</span>(c){<span class="keyword">var</span> d=a(<span class="keyword">this</span>).data(<span class="string">"index.ui-slider-handle"</span>);b._keySliding&amp;&amp;(b._keySliding=!<span class="number">1</span>,b._stop(c,d),b._change(c,d),a(<span class="keyword">this</span>).removeClass(<span class="string">"ui-state-active"</span>))}),<span class="keyword">this</span>._refreshValue(),<span class="keyword">this</span>._animateOff=!<span class="number">1</span>},destroy:<span class="keyword">function</span>(){<span class="keyword">return</span> <span class="keyword">this</span>.handles.remove(),<span class="keyword">this</span>.range.remove(),<span class="keyword">this</span>.element.removeClass(<span class="string">"ui-slider ui-slider-horizontal ui-slider-vertical ui-slider-disabled ui-widget ui-widget-content ui-corner-all"</span>).removeData(<span class="string">"slider"</span>).unbind(<span class="string">".slider"</span>),<span class="keyword">this</span>._mouseDestroy(),<span class="keyword">this</span>},_mouseCapture:<span class="keyword">function</span>(b){<span class="keyword">var</span> c=<span class="keyword">this</span>.options,d,e,f,g,h,i,j,k,l;<span class="keyword">return</span> c.disabled?!<span class="number">1</span>:(<span class="keyword">this</span>.elementSize={width:<span class="keyword">this</span>.element.outerWidth(),height:<span class="keyword">this</span>.element.outerHeight()},<span class="keyword">this</span>.elementOffset=<span class="keyword">this</span>.element.offset(),d={x:b.pageX,y:b.pageY},e=<span class="keyword">this</span>._normValueFromMouse(d),f=<span class="keyword">this</span>._valueMax()-<span class="keyword">this</span>._valueMin()+<span class="number">1</span>,h=<span class="keyword">this</span>,<span class="keyword">this</span>.handles.each(<span class="keyword">function</span>(b){<span class="keyword">var</span> c=Math.abs(e-h.values(b));f&gt;c&amp;&amp;(f=c,g=a(<span class="keyword">this</span>),i=b)}),c.range===!<span class="number">0</span>&amp;&amp;<span class="keyword">this</span>.values(<span class="number">1</span>)===c.min&amp;&amp;(i+=<span class="number">1</span>,g=a(<span class="keyword">this</span>.handles[i])),j=<span class="keyword">this</span>._start(b,i),j===!<span class="number">1</span>?!<span class="number">1</span>:(<span class="keyword">this</span>._mouseSliding=!<span class="number">0</span>,h._handleIndex=i,g.addClass(<span class="string">"ui-state-active"</span>).focus(),k=g.offset(),l=!a(b.target).parents().andSelf().is(<span class="string">".ui-slider-handle"</span>),<span class="keyword">this</span>._clickOffset=l?{left:<span class="number">0</span>,top:<span class="number">0</span>}:{left:b.pageX-k.left-g.width()/<span class="number">2</span>,top:b.pageY-k.top-g.height()/<span class="number">2</span>-(parseInt(g.css(<span class="string">"borderTopWidth"</span>),<span class="number">10</span>)||<span class="number">0</span>)-(parseInt(g.css(<span class="string">"borderBottomWidth"</span>),<span class="number">10</span>)||<span class="number">0</span>)+(parseInt(g.css(<span class="string">"marginTop"</span>),<span class="number">10</span>)||<span class="number">0</span>)},<span class="keyword">this</span>.handles.hasClass(<span class="string">"ui-state-hover"</span>)||<span class="keyword">this</span>._slide(b,i,e),<span class="keyword">this</span>._animateOff=!<span class="number">0</span>,!<span class="number">0</span>))},_mouseStart:<span class="keyword">function</span>(a){<span class="keyword">return</span>!<span class="number">0</span>},_mouseDrag:<span class="keyword">function</span>(a){<span class="keyword">var</span> b={x:a.pageX,y:a.pageY},c=<span class="keyword">this</span>._normValueFromMouse(b);<span class="keyword">return</span> <span class="keyword">this</span>._slide(a,<span class="keyword">this</span>._handleIndex,c),!<span class="number">1</span>},_mouseStop:<span class="keyword">function</span>(a){<span class="keyword">return</span> <span class="keyword">this</span>.handles.removeClass(<span class="string">"ui-state-active"</span>),<span class="keyword">this</span>._mouseSliding=!<span class="number">1</span>,<span class="keyword">this</span>._stop(a,<span class="keyword">this</span>._handleIndex),<span class="keyword">this</span>._change(a,<span class="keyword">this</span>._handleIndex),<span class="keyword">this</span>._handleIndex=<span class="literal">null</span>,<span class="keyword">this</span>._clickOffset=<span class="literal">null</span>,<span class="keyword">this</span>._animateOff=!<span class="number">1</span>,!<span class="number">1</span>},_detectOrientation:<span class="keyword">function</span>(){<span class="keyword">this</span>.orientation=<span class="keyword">this</span>.options.orientation===<span class="string">"vertical"</span>?<span class="string">"vertical"</span>:<span class="string">"horizontal"</span>},_normValueFromMouse:<span class="keyword">function</span>(a){<span class="keyword">var</span> b,c,d,e,f;<span class="keyword">return</span> <span class="keyword">this</span>.orientation===<span class="string">"horizontal"</span>?(b=<span class="keyword">this</span>.elementSize.width,c=a.x-<span class="keyword">this</span>.elementOffset.left-(<span class="keyword">this</span>._clickOffset?<span class="keyword">this</span>._clickOffset.left:<span class="number">0</span>)):(b=<span class="keyword">this</span>.elementSize.height,c=a.y-<span class="keyword">this</span>.elementOffset.top-(<span class="keyword">this</span>._clickOffset?<span class="keyword">this</span>._clickOffset.top:<span class="number">0</span>)),d=c/b,d&gt;<span class="number">1</span>&amp;&amp;(d=<span class="number">1</span>),d&lt;<span class="number">0</span>&amp;&amp;(d=<span class="number">0</span>),<span class="keyword">this</span>.orientation===<span class="string">"vertical"</span>&amp;&amp;(d=<span class="number">1</span>-d),e=<span class="keyword">this</span>._valueMax()-<span class="keyword">this</span>._valueMin(),f=<span class="keyword">this</span>._valueMin()+d*e,<span class="keyword">this</span>._trimAlignValue(f)},_start:<span class="keyword">function</span>(a,b){<span class="keyword">var</span> c={handle:<span class="keyword">this</span>.handles[b],value:<span class="keyword">this</span>.value()};<span class="keyword">return</span> <span class="keyword">this</span>.options.values&amp;&amp;<span class="keyword">this</span>.options.values.length&amp;&amp;(c.value=<span class="keyword">this</span>.values(b),c.values=<span class="keyword">this</span>.values()),<span class="keyword">this</span>._trigger(<span class="string">"start"</span>,a,c)},_slide:<span class="keyword">function</span>(a,b,c){<span class="keyword">var</span> d,e,f;<span class="keyword">this</span>.options.values&amp;&amp;<span class="keyword">this</span>.options.values.length?(d=<span class="keyword">this</span>.values(b?<span class="number">0</span>:<span class="number">1</span>),<span class="keyword">this</span>.options.values.length===<span class="number">2</span>&amp;&amp;<span class="keyword">this</span>.options.range===!<span class="number">0</span>&amp;&amp;(b===<span class="number">0</span>&amp;&amp;c&gt;d||b===<span class="number">1</span>&amp;&amp;c&lt;d)&amp;&amp;(c=d),c!==<span class="keyword">this</span>.values(b)&amp;&amp;(e=<span class="keyword">this</span>.values(),e[b]=c,f=<span class="keyword">this</span>._trigger(<span class="string">"slide"</span>,a,{handle:<span class="keyword">this</span>.handles[b],value:c,values:e}),d=<span class="keyword">this</span>.values(b?<span class="number">0</span>:<span class="number">1</span>),f!==!<span class="number">1</span>&amp;&amp;<span class="keyword">this</span>.values(b,c,!<span class="number">0</span>))):c!==<span class="keyword">this</span>.value()&amp;&amp;(f=<span class="keyword">this</span>._trigger(<span class="string">"slide"</span>,a,{handle:<span class="keyword">this</span>.handles[b],value:c}),f!==!<span class="number">1</span>&amp;&amp;<span class="keyword">this</span>.value(c))},_stop:<span class="keyword">function</span>(a,b){<span class="keyword">var</span> c={handle:<span class="keyword">this</span>.handles[b],value:<span class="keyword">this</span>.value()};<span class="keyword">this</span>.options.values&amp;&amp;<span class="keyword">this</span>.options.values.length&amp;&amp;(c.value=<span class="keyword">this</span>.values(b),c.values=<span class="keyword">this</span>.values()),<span class="keyword">this</span>._trigger(<span class="string">"stop"</span>,a,c)},_change:<span class="keyword">function</span>(a,b){<span class="keyword">if</span>(!<span class="keyword">this</span>._keySliding&amp;&amp;!<span class="keyword">this</span>._mouseSliding){<span class="keyword">var</span> c={handle:<span class="keyword">this</span>.handles[b],value:<span class="keyword">this</span>.value()};<span class="keyword">this</span>.options.values&amp;&amp;<span class="keyword">this</span>.options.values.length&amp;&amp;(c.value=<span class="keyword">this</span>.values(b),c.values=<span class="keyword">this</span>.values()),<span class="keyword">this</span>._trigger(<span class="string">"change"</span>,a,c)}},value:<span class="keyword">function</span>(a){<span class="keyword">if</span>(arguments.length){<span class="keyword">this</span>.options.value=<span class="keyword">this</span>._trimAlignValue(a),<span class="keyword">this</span>._refreshValue(),<span class="keyword">this</span>._change(<span class="literal">null</span>,<span class="number">0</span>);<span class="keyword">return</span>}<span class="keyword">return</span> <span class="keyword">this</span>._value()},values:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d,e,f;<span class="keyword">if</span>(arguments.length&gt;<span class="number">1</span>){<span class="keyword">this</span>.options.values[b]=<span class="keyword">this</span>._trimAlignValue(c),<span class="keyword">this</span>._refreshValue(),<span class="keyword">this</span>._change(<span class="literal">null</span>,b);<span class="keyword">return</span>}<span class="keyword">if</span>(!arguments.length)<span class="keyword">return</span> <span class="keyword">this</span>._values();<span class="keyword">if</span>(!a.isArray(arguments[<span class="number">0</span>]))<span class="keyword">return</span> <span class="keyword">this</span>.options.values&amp;&amp;<span class="keyword">this</span>.options.values.length?<span class="keyword">this</span>._values(b):<span class="keyword">this</span>.value();d=<span class="keyword">this</span>.options.values,e=arguments[<span class="number">0</span>];<span class="keyword">for</span>(f=<span class="number">0</span>;f&lt;d.length;f+=<span class="number">1</span>)d[f]=<span class="keyword">this</span>._trimAlignValue(e[f]),<span class="keyword">this</span>._change(<span class="literal">null</span>,f);<span class="keyword">this</span>._refreshValue()},_setOption:<span class="keyword">function</span>(b,c){<span class="keyword">var</span> d,e=<span class="number">0</span>;a.isArray(<span class="keyword">this</span>.options.values)&amp;&amp;(e=<span class="keyword">this</span>.options.values.length),a.Widget.prototype._setOption.apply(<span class="keyword">this</span>,arguments);<span class="keyword">switch</span>(b){<span class="keyword">case</span><span class="string">"disabled"</span>:c?(<span class="keyword">this</span>.handles.filter(<span class="string">".ui-state-focus"</span>).blur(),<span class="keyword">this</span>.handles.removeClass(<span class="string">"ui-state-hover"</span>),<span class="keyword">this</span>.handles.propAttr(<span class="string">"disabled"</span>,!<span class="number">0</span>),<span class="keyword">this</span>.element.addClass(<span class="string">"ui-disabled"</span>)):(<span class="keyword">this</span>.handles.propAttr(<span class="string">"disabled"</span>,!<span class="number">1</span>),<span class="keyword">this</span>.element.removeClass(<span class="string">"ui-disabled"</span>));<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"orientation"</span>:<span class="keyword">this</span>._detectOrientation(),<span class="keyword">this</span>.element.removeClass(<span class="string">"ui-slider-horizontal ui-slider-vertical"</span>).addClass(<span class="string">"ui-slider-"</span>+<span class="keyword">this</span>.orientation),<span class="keyword">this</span>._refreshValue();<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"value"</span>:<span class="keyword">this</span>._animateOff=!<span class="number">0</span>,<span class="keyword">this</span>._refreshValue(),<span class="keyword">this</span>._change(<span class="literal">null</span>,<span class="number">0</span>),<span class="keyword">this</span>._animateOff=!<span class="number">1</span>;<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"values"</span>:<span class="keyword">this</span>._animateOff=!<span class="number">0</span>,<span class="keyword">this</span>._refreshValue();<span class="keyword">for</span>(d=<span class="number">0</span>;d&lt;e;d+=<span class="number">1</span>)<span class="keyword">this</span>._change(<span class="literal">null</span>,d);<span class="keyword">this</span>._animateOff=!<span class="number">1</span>}},_value:<span class="keyword">function</span>(){<span class="keyword">var</span> a=<span class="keyword">this</span>.options.value;<span class="keyword">return</span> a=<span class="keyword">this</span>._trimAlignValue(a),a},_values:<span class="keyword">function</span>(a){<span class="keyword">var</span> b,c,d;<span class="keyword">if</span>(arguments.length)<span class="keyword">return</span> b=<span class="keyword">this</span>.options.values[a],b=<span class="keyword">this</span>._trimAlignValue(b),b;c=<span class="keyword">this</span>.options.values.slice();<span class="keyword">for</span>(d=<span class="number">0</span>;d&lt;c.length;d+=<span class="number">1</span>)c[d]=<span class="keyword">this</span>._trimAlignValue(c[d]);<span class="keyword">return</span> c},_trimAlignValue:<span class="keyword">function</span>(a){<span class="keyword">if</span>(a&lt;=<span class="keyword">this</span>._valueMin())<span class="keyword">return</span> <span class="keyword">this</span>._valueMin();<span class="keyword">if</span>(a&gt;=<span class="keyword">this</span>._valueMax())<span class="keyword">return</span> <span class="keyword">this</span>._valueMax();<span class="keyword">var</span> b=<span class="keyword">this</span>.options.step&gt;<span class="number">0</span>?<span class="keyword">this</span>.options.step:<span class="number">1</span>,c=(a-<span class="keyword">this</span>._valueMin())%b,d=a-c;<span class="keyword">return</span> Math.abs(c)*<span class="number">2</span>&gt;=b&amp;&amp;(d+=c&gt;<span class="number">0</span>?b:-b),parseFloat(d.toFixed(<span class="number">5</span>))},_valueMin:<span class="keyword">function</span>(){<span class="keyword">return</span> <span class="keyword">this</span>.options.min},_valueMax:<span class="keyword">function</span>(){<span class="keyword">return</span> <span class="keyword">this</span>.options.max},_refreshValue:<span class="keyword">function</span>(){<span class="keyword">var</span> b=<span class="keyword">this</span>.options.range,c=<span class="keyword">this</span>.options,d=<span class="keyword">this</span>,e=<span class="keyword">this</span>._animateOff?!<span class="number">1</span>:c.animate,f,g={},h,i,j,k;<span class="keyword">this</span>.options.values&amp;&amp;<span class="keyword">this</span>.options.values.length?<span class="keyword">this</span>.handles.each(<span class="keyword">function</span>(b,i){f=(d.values(b)-d._valueMin())/(d._valueMax()-d._valueMin())*<span class="number">100</span>,g[d.orientation===<span class="string">"horizontal"</span>?<span class="string">"left"</span>:<span class="string">"bottom"</span>]=f+<span class="string">"%"</span>,a(<span class="keyword">this</span>).stop(<span class="number">1</span>,<span class="number">1</span>)[e?<span class="string">"animate"</span>:<span class="string">"css"</span>](g,c.animate),d.options.range===!<span class="number">0</span>&amp;&amp;(d.orientation===<span class="string">"horizontal"</span>?(b===<span class="number">0</span>&amp;&amp;d.range.stop(<span class="number">1</span>,<span class="number">1</span>)[e?<span class="string">"animate"</span>:<span class="string">"css"</span>]({left:f+<span class="string">"%"</span>},c.animate),b===<span class="number">1</span>&amp;&amp;d.range[e?<span class="string">"animate"</span>:<span class="string">"css"</span>]({width:f-h+<span class="string">"%"</span>},{queue:!<span class="number">1</span>,duration:c.animate})):(b===<span class="number">0</span>&amp;&amp;d.range.stop(<span class="number">1</span>,<span class="number">1</span>)[e?<span class="string">"animate"</span>:<span class="string">"css"</span>]({bottom:f+<span class="string">"%"</span>},c.animate),b===<span class="number">1</span>&amp;&amp;d.range[e?<span class="string">"animate"</span>:<span class="string">"css"</span>]({height:f-h+<span class="string">"%"</span>},{queue:!<span class="number">1</span>,duration:c.animate}))),h=f}):(i=<span class="keyword">this</span>.value(),j=<span class="keyword">this</span>._valueMin(),k=<span class="keyword">this</span>._valueMax(),f=k!==j?(i-j)/(k-j)*<span class="number">100</span>:<span class="number">0</span>,g[d.orientation===<span class="string">"horizontal"</span>?<span class="string">"left"</span>:<span class="string">"bottom"</span>]=f+<span class="string">"%"</span>,<span class="keyword">this</span>.handle.stop(<span class="number">1</span>,<span class="number">1</span>)[e?<span class="string">"animate"</span>:<span class="string">"css"</span>](g,c.animate),b===<span class="string">"min"</span>&amp;&amp;<span class="keyword">this</span>.orientation===<span class="string">"horizontal"</span>&amp;&amp;<span class="keyword">this</span>.range.stop(<span class="number">1</span>,<span class="number">1</span>)[e?<span class="string">"animate"</span>:<span class="string">"css"</span>]({width:f+<span class="string">"%"</span>},c.animate),b===<span class="string">"max"</span>&amp;&amp;<span class="keyword">this</span>.orientation===<span class="string">"horizontal"</span>&amp;&amp;<span class="keyword">this</span>.range[e?<span class="string">"animate"</span>:<span class="string">"css"</span>]({width:<span class="number">100</span>-f+<span class="string">"%"</span>},{queue:!<span class="number">1</span>,duration:c.animate}),b===<span class="string">"min"</span>&amp;&amp;<span class="keyword">this</span>.orientation===<span class="string">"vertical"</span>&amp;&amp;<span class="keyword">this</span>.range.stop(<span class="number">1</span>,<span class="number">1</span>)[e?<span class="string">"animate"</span>:<span class="string">"css"</span>]({height:f+<span class="string">"%"</span>},c.animate),b===<span class="string">"max"</span>&amp;&amp;<span class="keyword">this</span>.orientation===<span class="string">"vertical"</span>&amp;&amp;<span class="keyword">this</span>.range[e?<span class="string">"animate"</span>:<span class="string">"css"</span>]({height:<span class="number">100</span>-f+<span class="string">"%"</span>},{queue:!<span class="number">1</span>,duration:c.animate}))}}),a.extend(a.ui.slider,{version:<span class="string">"1.8.21"</span>})}(jQuery),<span class="keyword">function</span>(a,b){<span class="function"><span class="keyword">function</span> <span class="title">e</span><span class="params">()</span>{</span><span class="keyword">return</span>++c}<span class="function"><span class="keyword">function</span> <span class="title">f</span><span class="params">()</span>{</span><span class="keyword">return</span>++d}<span class="keyword">var</span> c=<span class="number">0</span>,d=<span class="number">0</span>;a.widget(<span class="string">"ui.tabs"</span>,{options:{add:<span class="literal">null</span>,ajaxOptions:<span class="literal">null</span>,cache:!<span class="number">1</span>,cookie:<span class="literal">null</span>,collapsible:!<span class="number">1</span>,disable:<span class="literal">null</span>,disabled:[],enable:<span class="literal">null</span>,event:<span class="string">"click"</span>,fx:<span class="literal">null</span>,idPrefix:<span class="string">"ui-tabs-"</span>,load:<span class="literal">null</span>,panelTemplate:<span class="string">"&lt;div&gt;&lt;/div&gt;"</span>,remove:<span class="literal">null</span>,select:<span class="literal">null</span>,show:<span class="literal">null</span>,spinner:<span class="string">"&lt;em&gt;Loading&amp;#8230;&lt;/em&gt;"</span>,tabTemplate:<span class="string">"&lt;li&gt;&lt;a href='#{href}'&gt;&lt;span&gt;#{label}&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;"</span>},_create:<span class="keyword">function</span>(){<span class="keyword">this</span>._tabify(!<span class="number">0</span>)},_setOption:<span class="keyword">function</span>(a,b){<span class="keyword">if</span>(a==<span class="string">"selected"</span>){<span class="keyword">if</span>(<span class="keyword">this</span>.options.collapsible&amp;&amp;b==<span class="keyword">this</span>.options.selected)<span class="keyword">return</span>;<span class="keyword">this</span>.select(b)}<span class="keyword">else</span> <span class="keyword">this</span>.options[a]=b,<span class="keyword">this</span>._tabify()},_tabId:<span class="keyword">function</span>(a){<span class="keyword">return</span> a.title&amp;&amp;a.title.replace(<span class="regexp">/\s/g</span>,<span class="string">"_"</span>).replace(<span class="regexp">/[^\w\u00c0-\uFFFF-]/g</span>,<span class="string">""</span>)||<span class="keyword">this</span>.options.idPrefix+e()},_sanitizeSelector:<span class="keyword">function</span>(a){<span class="keyword">return</span> a.replace(<span class="regexp">/:/g</span>,<span class="string">"\\:"</span>)},_cookie:<span class="keyword">function</span>(){<span class="keyword">var</span> b=<span class="keyword">this</span>.cookie||(<span class="keyword">this</span>.cookie=<span class="keyword">this</span>.options.cookie.name||<span class="string">"ui-tabs-"</span>+f());<span class="keyword">return</span> a.cookie.apply(<span class="literal">null</span>,[b].concat(a.makeArray(arguments)))},_ui:<span class="keyword">function</span>(a,b){<span class="keyword">return</span>{tab:a,panel:b,index:<span class="keyword">this</span>.anchors.index(a)}},_cleanup:<span class="keyword">function</span>(){<span class="keyword">this</span>.lis.filter(<span class="string">".ui-state-processing"</span>).removeClass(<span class="string">"ui-state-processing"</span>).find(<span class="string">"span:data(label.tabs)"</span>).each(<span class="keyword">function</span>(){<span class="keyword">var</span> b=a(<span class="keyword">this</span>);b.html(b.data(<span class="string">"label.tabs"</span>)).removeData(<span class="string">"label.tabs"</span>)})},_tabify:<span class="keyword">function</span>(c){<span class="function"><span class="keyword">function</span> <span class="title">m</span><span class="params">(b,c)</span>{</span>b.css(<span class="string">"display"</span>,<span class="string">""</span>),!a.support.opacity&amp;&amp;c.opacity&amp;&amp;b[<span class="number">0</span>].style.removeAttribute(<span class="string">"filter"</span>)}<span class="keyword">var</span> d=<span class="keyword">this</span>,e=<span class="keyword">this</span>.options,f=<span class="regexp">/^#.+/</span>;<span class="keyword">this</span>.list=<span class="keyword">this</span>.element.find(<span class="string">"ol,ul"</span>).eq(<span class="number">0</span>),<span class="keyword">this</span>.lis=a(<span class="string">" &gt; li:has(a[href])"</span>,<span class="keyword">this</span>.list),<span class="keyword">this</span>.anchors=<span class="keyword">this</span>.lis.map(<span class="keyword">function</span>(){<span class="keyword">return</span> a(<span class="string">"a"</span>,<span class="keyword">this</span>)[<span class="number">0</span>]}),<span class="keyword">this</span>.panels=a([]),<span class="keyword">this</span>.anchors.each(<span class="keyword">function</span>(b,c){<span class="keyword">var</span> g=a(c).attr(<span class="string">"href"</span>),h=g.split(<span class="string">"#"</span>)[<span class="number">0</span>],i;h&amp;&amp;(h===location.toString().split(<span class="string">"#"</span>)[<span class="number">0</span>]||(i=a(<span class="string">"base"</span>)[<span class="number">0</span>])&amp;&amp;h===i.href)&amp;&amp;(g=c.hash,c.href=g);<span class="keyword">if</span>(f.test(g))d.panels=d.panels.add(d.element.find(d._sanitizeSelector(g)));<span class="keyword">else</span> <span class="keyword">if</span>(g&amp;&amp;g!==<span class="string">"#"</span>){a.data(c,<span class="string">"href.tabs"</span>,g),a.data(c,<span class="string">"load.tabs"</span>,g.replace(<span class="regexp">/#.*$/</span>,<span class="string">""</span>));<span class="keyword">var</span> j=d._tabId(c);c.href=<span class="string">"#"</span>+j;<span class="keyword">var</span> k=d.element.find(<span class="string">"#"</span>+j);k.length||(k=a(e.panelTemplate).attr(<span class="string">"id"</span>,j).addClass(<span class="string">"ui-tabs-panel ui-widget-content ui-corner-bottom"</span>).insertAfter(d.panels[b-<span class="number">1</span>]||d.list),k.data(<span class="string">"destroy.tabs"</span>,!<span class="number">0</span>)),d.panels=d.panels.add(k)}<span class="keyword">else</span> e.disabled.push(b)}),c?(<span class="keyword">this</span>.element.addClass(<span class="string">"ui-tabs ui-widget ui-widget-content ui-corner-all"</span>),<span class="keyword">this</span>.list.addClass(<span class="string">"ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all"</span>),<span class="keyword">this</span>.lis.addClass(<span class="string">"ui-state-default ui-corner-top"</span>),<span class="keyword">this</span>.panels.addClass(<span class="string">"ui-tabs-panel ui-widget-content ui-corner-bottom"</span>),e.selected===b?(location.hash&amp;&amp;<span class="keyword">this</span>.anchors.each(<span class="keyword">function</span>(a,b){<span class="keyword">if</span>(b.hash==location.hash)<span class="keyword">return</span> e.selected=a,!<span class="number">1</span>}),<span class="keyword">typeof</span> e.selected!=<span class="string">"number"</span>&amp;&amp;e.cookie&amp;&amp;(e.selected=parseInt(d._cookie(),<span class="number">10</span>)),<span class="keyword">typeof</span> e.selected!=<span class="string">"number"</span>&amp;&amp;<span class="keyword">this</span>.lis.filter(<span class="string">".ui-tabs-selected"</span>).length&amp;&amp;(e.selected=<span class="keyword">this</span>.lis.index(<span class="keyword">this</span>.lis.filter(<span class="string">".ui-tabs-selected"</span>))),e.selected=e.selected||(<span class="keyword">this</span>.lis.length?<span class="number">0</span>:-<span class="number">1</span>)):e.selected===<span class="literal">null</span>&amp;&amp;(e.selected=-<span class="number">1</span>),e.selected=e.selected&gt;=<span class="number">0</span>&amp;&amp;<span class="keyword">this</span>.anchors[e.selected]||e.selected&lt;<span class="number">0</span>?e.selected:<span class="number">0</span>,e.disabled=a.unique(e.disabled.concat(a.map(<span class="keyword">this</span>.lis.filter(<span class="string">".ui-state-disabled"</span>),<span class="keyword">function</span>(a,b){<span class="keyword">return</span> d.lis.index(a)}))).sort(),a.inArray(e.selected,e.disabled)!=-<span class="number">1</span>&amp;&amp;e.disabled.splice(a.inArray(e.selected,e.disabled),<span class="number">1</span>),<span class="keyword">this</span>.panels.addClass(<span class="string">"ui-tabs-hide"</span>),<span class="keyword">this</span>.lis.removeClass(<span class="string">"ui-tabs-selected ui-state-active"</span>),e.selected&gt;=<span class="number">0</span>&amp;&amp;<span class="keyword">this</span>.anchors.length&amp;&amp;(d.element.find(d._sanitizeSelector(d.anchors[e.selected].hash)).removeClass(<span class="string">"ui-tabs-hide"</span>),<span class="keyword">this</span>.lis.eq(e.selected).addClass(<span class="string">"ui-tabs-selected ui-state-active"</span>),d.element.queue(<span class="string">"tabs"</span>,<span class="keyword">function</span>(){d._trigger(<span class="string">"show"</span>,<span class="literal">null</span>,d._ui(d.anchors[e.selected],d.element.find(d._sanitizeSelector(d.anchors[e.selected].hash))[<span class="number">0</span>]))}),<span class="keyword">this</span>.load(e.selected)),a(window).bind(<span class="string">"unload"</span>,<span class="keyword">function</span>(){d.lis.add(d.anchors).unbind(<span class="string">".tabs"</span>),d.lis=d.anchors=d.panels=<span class="literal">null</span>})):e.selected=<span class="keyword">this</span>.lis.index(<span class="keyword">this</span>.lis.filter(<span class="string">".ui-tabs-selected"</span>)),<span class="keyword">this</span>.element[e.collapsible?<span class="string">"addClass"</span>:<span class="string">"removeClass"</span>](<span class="string">"ui-tabs-collapsible"</span>),e.cookie&amp;&amp;<span class="keyword">this</span>._cookie(e.selected,e.cookie);<span class="keyword">for</span>(<span class="keyword">var</span> g=<span class="number">0</span>,h;h=<span class="keyword">this</span>.lis[g];g++)a(h)[a.inArray(g,e.disabled)!=-<span class="number">1</span>&amp;&amp;!a(h).hasClass(<span class="string">"ui-tabs-selected"</span>)?<span class="string">"addClass"</span>:<span class="string">"removeClass"</span>](<span class="string">"ui-state-disabled"</span>);e.cache===!<span class="number">1</span>&amp;&amp;<span class="keyword">this</span>.anchors.removeData(<span class="string">"cache.tabs"</span>),<span class="keyword">this</span>.lis.add(<span class="keyword">this</span>.anchors).unbind(<span class="string">".tabs"</span>);<span class="keyword">if</span>(e.event!==<span class="string">"mouseover"</span>){<span class="keyword">var</span> i=<span class="keyword">function</span>(a,b){b.is(<span class="string">":not(.ui-state-disabled)"</span>)&amp;&amp;b.addClass(<span class="string">"ui-state-"</span>+a)},j=<span class="keyword">function</span>(a,b){b.removeClass(<span class="string">"ui-state-"</span>+a)};<span class="keyword">this</span>.lis.bind(<span class="string">"mouseover.tabs"</span>,<span class="keyword">function</span>(){i(<span class="string">"hover"</span>,a(<span class="keyword">this</span>))}),<span class="keyword">this</span>.lis.bind(<span class="string">"mouseout.tabs"</span>,<span class="keyword">function</span>(){j(<span class="string">"hover"</span>,a(<span class="keyword">this</span>))}),<span class="keyword">this</span>.anchors.bind(<span class="string">"focus.tabs"</span>,<span class="keyword">function</span>(){i(<span class="string">"focus"</span>,a(<span class="keyword">this</span>).closest(<span class="string">"li"</span>))}),<span class="keyword">this</span>.anchors.bind(<span class="string">"blur.tabs"</span>,<span class="keyword">function</span>(){j(<span class="string">"focus"</span>,a(<span class="keyword">this</span>).closest(<span class="string">"li"</span>))})}<span class="keyword">var</span> k,l;e.fx&amp;&amp;(a.isArray(e.fx)?(k=e.fx[<span class="number">0</span>],l=e.fx[<span class="number">1</span>]):k=l=e.fx);<span class="keyword">var</span> n=l?<span class="keyword">function</span>(b,c){a(b).closest(<span class="string">"li"</span>).addClass(<span class="string">"ui-tabs-selected ui-state-active"</span>),c.hide().removeClass(<span class="string">"ui-tabs-hide"</span>).animate(l,l.duration||<span class="string">"normal"</span>,<span class="keyword">function</span>(){m(c,l),d._trigger(<span class="string">"show"</span>,<span class="literal">null</span>,d._ui(b,c[<span class="number">0</span>]))})}:<span class="keyword">function</span>(b,c){a(b).closest(<span class="string">"li"</span>).addClass(<span class="string">"ui-tabs-selected ui-state-active"</span>),c.removeClass(<span class="string">"ui-tabs-hide"</span>),d._trigger(<span class="string">"show"</span>,<span class="literal">null</span>,d._ui(b,c[<span class="number">0</span>]))},o=k?<span class="keyword">function</span>(a,b){b.animate(k,k.duration||<span class="string">"normal"</span>,<span class="keyword">function</span>(){d.lis.removeClass(<span class="string">"ui-tabs-selected ui-state-active"</span>),b.addClass(<span class="string">"ui-tabs-hide"</span>),m(b,k),d.element.dequeue(<span class="string">"tabs"</span>)})}:<span class="keyword">function</span>(a,b,c){d.lis.removeClass(<span class="string">"ui-tabs-selected ui-state-active"</span>),b.addClass(<span class="string">"ui-tabs-hide"</span>),d.element.dequeue(<span class="string">"tabs"</span>)};<span class="keyword">this</span>.anchors.bind(e.event+<span class="string">".tabs"</span>,<span class="keyword">function</span>(){<span class="keyword">var</span> b=<span class="keyword">this</span>,c=a(b).closest(<span class="string">"li"</span>),f=d.panels.filter(<span class="string">":not(.ui-tabs-hide)"</span>),g=d.element.find(d._sanitizeSelector(b.hash));<span class="keyword">if</span>(c.hasClass(<span class="string">"ui-tabs-selected"</span>)&amp;&amp;!e.collapsible||c.hasClass(<span class="string">"ui-state-disabled"</span>)||c.hasClass(<span class="string">"ui-state-processing"</span>)||d.panels.filter(<span class="string">":animated"</span>).length||d._trigger(<span class="string">"select"</span>,<span class="literal">null</span>,d._ui(<span class="keyword">this</span>,g[<span class="number">0</span>]))===!<span class="number">1</span>)<span class="keyword">return</span> <span class="keyword">this</span>.blur(),!<span class="number">1</span>;e.selected=d.anchors.index(<span class="keyword">this</span>),d.abort();<span class="keyword">if</span>(e.collapsible){<span class="keyword">if</span>(c.hasClass(<span class="string">"ui-tabs-selected"</span>))<span class="keyword">return</span> e.selected=-<span class="number">1</span>,e.cookie&amp;&amp;d._cookie(e.selected,e.cookie),d.element.queue(<span class="string">"tabs"</span>,<span class="keyword">function</span>(){o(b,f)}).dequeue(<span class="string">"tabs"</span>),<span class="keyword">this</span>.blur(),!<span class="number">1</span>;<span class="keyword">if</span>(!f.length)<span class="keyword">return</span> e.cookie&amp;&amp;d._cookie(e.selected,e.cookie),d.element.queue(<span class="string">"tabs"</span>,<span class="keyword">function</span>(){n(b,g)}),d.load(d.anchors.index(<span class="keyword">this</span>)),<span class="keyword">this</span>.blur(),!<span class="number">1</span>}e.cookie&amp;&amp;d._cookie(e.selected,e.cookie);<span class="keyword">if</span>(g.length)f.length&amp;&amp;d.element.queue(<span class="string">"tabs"</span>,<span class="keyword">function</span>(){o(b,f)}),d.element.queue(<span class="string">"tabs"</span>,<span class="keyword">function</span>(){n(b,g)}),d.load(d.anchors.index(<span class="keyword">this</span>));<span class="keyword">else</span> <span class="keyword">throw</span><span class="string">"jQuery UI Tabs: Mismatching fragment identifier."</span>;a.browser.msie&amp;&amp;<span class="keyword">this</span>.blur()}),<span class="keyword">this</span>.anchors.bind(<span class="string">"click.tabs"</span>,<span class="keyword">function</span>(){<span class="keyword">return</span>!<span class="number">1</span>})},_getIndex:<span class="keyword">function</span>(a){<span class="keyword">return</span> <span class="keyword">typeof</span> a==<span class="string">"string"</span>&amp;&amp;(a=<span class="keyword">this</span>.anchors.index(<span class="keyword">this</span>.anchors.filter(<span class="string">"[href$='"</span>+a+<span class="string">"']"</span>))),a},destroy:<span class="keyword">function</span>(){<span class="keyword">var</span> b=<span class="keyword">this</span>.options;<span class="keyword">return</span> <span class="keyword">this</span>.abort(),<span class="keyword">this</span>.element.unbind(<span class="string">".tabs"</span>).removeClass(<span class="string">"ui-tabs ui-widget ui-widget-content ui-corner-all ui-tabs-collapsible"</span>).removeData(<span class="string">"tabs"</span>),<span class="keyword">this</span>.list.removeClass(<span class="string">"ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all"</span>),<span class="keyword">this</span>.anchors.each(<span class="keyword">function</span>(){<span class="keyword">var</span> b=a.data(<span class="keyword">this</span>,<span class="string">"href.tabs"</span>);b&amp;&amp;(<span class="keyword">this</span>.href=b);<span class="keyword">var</span> c=a(<span class="keyword">this</span>).unbind(<span class="string">".tabs"</span>);a.each([<span class="string">"href"</span>,<span class="string">"load"</span>,<span class="string">"cache"</span>],<span class="keyword">function</span>(a,b){c.removeData(b+<span class="string">".tabs"</span>)})}),<span class="keyword">this</span>.lis.unbind(<span class="string">".tabs"</span>).add(<span class="keyword">this</span>.panels).each(<span class="keyword">function</span>(){a.data(<span class="keyword">this</span>,<span class="string">"destroy.tabs"</span>)?a(<span class="keyword">this</span>).remove():a(<span class="keyword">this</span>).removeClass([<span class="string">"ui-state-default"</span>,<span class="string">"ui-corner-top"</span>,<span class="string">"ui-tabs-selected"</span>,<span class="string">"ui-state-active"</span>,<span class="string">"ui-state-hover"</span>,<span class="string">"ui-state-focus"</span>,<span class="string">"ui-state-disabled"</span>,<span class="string">"ui-tabs-panel"</span>,<span class="string">"ui-widget-content"</span>,<span class="string">"ui-corner-bottom"</span>,<span class="string">"ui-tabs-hide"</span>].join(<span class="string">" "</span>))}),b.cookie&amp;&amp;<span class="keyword">this</span>._cookie(<span class="literal">null</span>,b.cookie),<span class="keyword">this</span>},add:<span class="keyword">function</span>(c,d,e){e===b&amp;&amp;(e=<span class="keyword">this</span>.anchors.length);<span class="keyword">var</span> f=<span class="keyword">this</span>,g=<span class="keyword">this</span>.options,h=a(g.tabTemplate.replace(<span class="regexp">/#\{href\}/g</span>,c).replace(<span class="regexp">/#\{label\}/g</span>,d)),i=c.indexOf(<span class="string">"#"</span>)?<span class="keyword">this</span>._tabId(a(<span class="string">"a"</span>,h)[<span class="number">0</span>]):c.replace(<span class="string">"#"</span>,<span class="string">""</span>);h.addClass(<span class="string">"ui-state-default ui-corner-top"</span>).data(<span class="string">"destroy.tabs"</span>,!<span class="number">0</span>);<span class="keyword">var</span> j=f.element.find(<span class="string">"#"</span>+i);<span class="keyword">return</span> j.length||(j=a(g.panelTemplate).attr(<span class="string">"id"</span>,i).data(<span class="string">"destroy.tabs"</span>,!<span class="number">0</span>)),j.addClass(<span class="string">"ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide"</span>),e&gt;=<span class="keyword">this</span>.lis.length?(h.appendTo(<span class="keyword">this</span>.list),j.appendTo(<span class="keyword">this</span>.list[<span class="number">0</span>].parentNode)):(h.insertBefore(<span class="keyword">this</span>.lis[e]),j.insertBefore(<span class="keyword">this</span>.panels[e])),g.disabled=a.map(g.disabled,<span class="keyword">function</span>(a,b){<span class="keyword">return</span> a&gt;=e?++a:a}),<span class="keyword">this</span>._tabify(),<span class="keyword">this</span>.anchors.length==<span class="number">1</span>&amp;&amp;(g.selected=<span class="number">0</span>,h.addClass(<span class="string">"ui-tabs-selected ui-state-active"</span>),j.removeClass(<span class="string">"ui-tabs-hide"</span>),<span class="keyword">this</span>.element.queue(<span class="string">"tabs"</span>,<span class="keyword">function</span>(){f._trigger(<span class="string">"show"</span>,<span class="literal">null</span>,f._ui(f.anchors[<span class="number">0</span>],f.panels[<span class="number">0</span>]))}),<span class="keyword">this</span>.load(<span class="number">0</span>)),<span class="keyword">this</span>._trigger(<span class="string">"add"</span>,<span class="literal">null</span>,<span class="keyword">this</span>._ui(<span class="keyword">this</span>.anchors[e],<span class="keyword">this</span>.panels[e])),<span class="keyword">this</span>},remove:<span class="keyword">function</span>(b){b=<span class="keyword">this</span>._getIndex(b);<span class="keyword">var</span> c=<span class="keyword">this</span>.options,d=<span class="keyword">this</span>.lis.eq(b).remove(),e=<span class="keyword">this</span>.panels.eq(b).remove();<span class="keyword">return</span> d.hasClass(<span class="string">"ui-tabs-selected"</span>)&amp;&amp;<span class="keyword">this</span>.anchors.length&gt;<span class="number">1</span>&amp;&amp;<span class="keyword">this</span>.select(b+(b+<span class="number">1</span>&lt;<span class="keyword">this</span>.anchors.length?<span class="number">1</span>:-<span class="number">1</span>)),c.disabled=a.map(a.grep(c.disabled,<span class="keyword">function</span>(a,c){<span class="keyword">return</span> a!=b}),<span class="keyword">function</span>(a,c){<span class="keyword">return</span> a&gt;=b?--a:a}),<span class="keyword">this</span>._tabify(),<span class="keyword">this</span>._trigger(<span class="string">"remove"</span>,<span class="literal">null</span>,<span class="keyword">this</span>._ui(d.find(<span class="string">"a"</span>)[<span class="number">0</span>],e[<span class="number">0</span>])),<span class="keyword">this</span>},enable:<span class="keyword">function</span>(b){b=<span class="keyword">this</span>._getIndex(b);<span class="keyword">var</span> c=<span class="keyword">this</span>.options;<span class="keyword">if</span>(a.inArray(b,c.disabled)==-<span class="number">1</span>)<span class="keyword">return</span>;<span class="keyword">return</span> <span class="keyword">this</span>.lis.eq(b).removeClass(<span class="string">"ui-state-disabled"</span>),c.disabled=a.grep(c.disabled,<span class="keyword">function</span>(a,c){<span class="keyword">return</span> a!=b}),<span class="keyword">this</span>._trigger(<span class="string">"enable"</span>,<span class="literal">null</span>,<span class="keyword">this</span>._ui(<span class="keyword">this</span>.anchors[b],<span class="keyword">this</span>.panels[b])),<span class="keyword">this</span>},disable:<span class="keyword">function</span>(a){a=<span class="keyword">this</span>._getIndex(a);<span class="keyword">var</span> b=<span class="keyword">this</span>,c=<span class="keyword">this</span>.options;<span class="keyword">return</span> a!=c.selected&amp;&amp;(<span class="keyword">this</span>.lis.eq(a).addClass(<span class="string">"ui-state-disabled"</span>),c.disabled.push(a),c.disabled.sort(),<span class="keyword">this</span>._trigger(<span class="string">"disable"</span>,<span class="literal">null</span>,<span class="keyword">this</span>._ui(<span class="keyword">this</span>.anchors[a],<span class="keyword">this</span>.panels[a]))),<span class="keyword">this</span>},select:<span class="keyword">function</span>(a){a=<span class="keyword">this</span>._getIndex(a);<span class="keyword">if</span>(a==-<span class="number">1</span>)<span class="keyword">if</span>(<span class="keyword">this</span>.options.collapsible&amp;&amp;<span class="keyword">this</span>.options.selected!=-<span class="number">1</span>)a=<span class="keyword">this</span>.options.selected;<span class="keyword">else</span> <span class="keyword">return</span> <span class="keyword">this</span>;<span class="keyword">return</span> <span class="keyword">this</span>.anchors.eq(a).trigger(<span class="keyword">this</span>.options.event+<span class="string">".tabs"</span>),<span class="keyword">this</span>},load:<span class="keyword">function</span>(b){b=<span class="keyword">this</span>._getIndex(b);<span class="keyword">var</span> c=<span class="keyword">this</span>,d=<span class="keyword">this</span>.options,e=<span class="keyword">this</span>.anchors.eq(b)[<span class="number">0</span>],f=a.data(e,<span class="string">"load.tabs"</span>);<span class="keyword">this</span>.abort();<span class="keyword">if</span>(!f||<span class="keyword">this</span>.element.queue(<span class="string">"tabs"</span>).length!==<span class="number">0</span>&amp;&amp;a.data(e,<span class="string">"cache.tabs"</span>)){<span class="keyword">this</span>.element.dequeue(<span class="string">"tabs"</span>);<span class="keyword">return</span>}<span class="keyword">this</span>.lis.eq(b).addClass(<span class="string">"ui-state-processing"</span>);<span class="keyword">if</span>(d.spinner){<span class="keyword">var</span> g=a(<span class="string">"span"</span>,e);g.data(<span class="string">"label.tabs"</span>,g.html()).html(d.spinner)}<span class="keyword">return</span> <span class="keyword">this</span>.xhr=a.ajax(a.extend({},d.ajaxOptions,{url:f,success:<span class="keyword">function</span>(f,g){c.element.find(c._sanitizeSelector(e.hash)).html(f),c._cleanup(),d.cache&amp;&amp;a.data(e,<span class="string">"cache.tabs"</span>,!<span class="number">0</span>),c._trigger(<span class="string">"load"</span>,<span class="literal">null</span>,c._ui(c.anchors[b],c.panels[b]));<span class="keyword">try</span>{d.ajaxOptions.success(f,g)}<span class="keyword">catch</span>(h){}},error:<span class="keyword">function</span>(a,f,g){c._cleanup(),c._trigger(<span class="string">"load"</span>,<span class="literal">null</span>,c._ui(c.anchors[b],c.panels[b]));<span class="keyword">try</span>{d.ajaxOptions.error(a,f,b,e)}<span class="keyword">catch</span>(g){}}})),c.element.dequeue(<span class="string">"tabs"</span>),<span class="keyword">this</span>},abort:<span class="keyword">function</span>(){<span class="keyword">return</span> <span class="keyword">this</span>.element.queue([]),<span class="keyword">this</span>.panels.stop(!<span class="number">1</span>,!<span class="number">0</span>),<span class="keyword">this</span>.element.queue(<span class="string">"tabs"</span>,<span class="keyword">this</span>.element.queue(<span class="string">"tabs"</span>).splice(-<span class="number">2</span>,<span class="number">2</span>)),<span class="keyword">this</span>.xhr&amp;&amp;(<span class="keyword">this</span>.xhr.abort(),<span class="keyword">delete</span> <span class="keyword">this</span>.xhr),<span class="keyword">this</span>._cleanup(),<span class="keyword">this</span>},url:<span class="keyword">function</span>(a,b){<span class="keyword">return</span> <span class="keyword">this</span>.anchors.eq(a).removeData(<span class="string">"cache.tabs"</span>).data(<span class="string">"load.tabs"</span>,b),<span class="keyword">this</span>},length:<span class="keyword">function</span>(){<span class="keyword">return</span> <span class="keyword">this</span>.anchors.length}}),a.extend(a.ui.tabs,{version:<span class="string">"1.8.21"</span>}),a.extend(a.ui.tabs.prototype,{rotation:<span class="literal">null</span>,rotate:<span class="keyword">function</span>(a,b){<span class="keyword">var</span> c=<span class="keyword">this</span>,d=<span class="keyword">this</span>.options,e=c._rotate||(c._rotate=<span class="keyword">function</span>(b){clearTimeout(c.rotation),c.rotation=setTimeout(<span class="keyword">function</span>(){<span class="keyword">var</span> a=d.selected;c.select(++a&lt;c.anchors.length?a:<span class="number">0</span>)},a),b&amp;&amp;b.stopPropagation()}),f=c._unrotate||(c._unrotate=b?<span class="keyword">function</span>(a){e()}:<span class="keyword">function</span>(a){a.clientX&amp;&amp;c.rotate(<span class="literal">null</span>)});<span class="keyword">return</span> a?(<span class="keyword">this</span>.element.bind(<span class="string">"tabsshow"</span>,e),<span class="keyword">this</span>.anchors.bind(d.event+<span class="string">".tabs"</span>,f),e()):(clearTimeout(c.rotation),<span class="keyword">this</span>.element.unbind(<span class="string">"tabsshow"</span>,e),<span class="keyword">this</span>.anchors.unbind(d.event+<span class="string">".tabs"</span>,f),<span class="keyword">delete</span> <span class="keyword">this</span>._rotate,<span class="keyword">delete</span> <span class="keyword">this</span>._unrotate),<span class="keyword">this</span>}})}(jQuery);
define(<span class="string">"jqueryui"</span>, <span class="keyword">function</span>(){});

<span class="comment">/*
 * jQuery UI Touch Punch 0.2.2
 *
 * Copyright 2011, Dave Furfero
 * Dual licensed under the MIT or GPL Version 2 licenses.
 *
 * Depends:
 *  jquery.ui.widget.js
 *  jquery.ui.mouse.js
 */</span>
(<span class="keyword">function</span>(b){b.support.touch=<span class="string">"ontouchend"</span> <span class="keyword">in</span> document;<span class="keyword">if</span>(!b.support.touch){<span class="keyword">return</span>;}<span class="keyword">var</span> c=b.ui.mouse.prototype,e=c._mouseInit,a;<span class="function"><span class="keyword">function</span> <span class="title">d</span><span class="params">(g,h)</span>{</span><span class="keyword">if</span>(g.originalEvent.touches.length&gt;<span class="number">1</span>){<span class="keyword">return</span>;}g.preventDefault();<span class="keyword">var</span> i=g.originalEvent.changedTouches[<span class="number">0</span>],f=document.createEvent(<span class="string">"MouseEvents"</span>);f.initMouseEvent(h,<span class="literal">true</span>,<span class="literal">true</span>,window,<span class="number">1</span>,i.screenX,i.screenY,i.clientX,i.clientY,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="number">0</span>,<span class="literal">null</span>);g.target.dispatchEvent(f);}c._touchStart=<span class="keyword">function</span>(g){<span class="keyword">var</span> f=<span class="keyword">this</span>;<span class="keyword">if</span>(a||!f._mouseCapture(g.originalEvent.changedTouches[<span class="number">0</span>])){<span class="keyword">return</span>;}a=<span class="literal">true</span>;f._touchMoved=<span class="literal">false</span>;d(g,<span class="string">"mouseover"</span>);d(g,<span class="string">"mousemove"</span>);d(g,<span class="string">"mousedown"</span>);};c._touchMove=<span class="keyword">function</span>(f){<span class="keyword">if</span>(!a){<span class="keyword">return</span>;}<span class="keyword">this</span>._touchMoved=<span class="literal">true</span>;d(f,<span class="string">"mousemove"</span>);};c._touchEnd=<span class="keyword">function</span>(f){<span class="keyword">if</span>(!a){<span class="keyword">return</span>;}d(f,<span class="string">"mouseup"</span>);d(f,<span class="string">"mouseout"</span>);<span class="keyword">if</span>(!<span class="keyword">this</span>._touchMoved){d(f,<span class="string">"click"</span>);}a=<span class="literal">false</span>;};c._mouseInit=<span class="keyword">function</span>(){<span class="keyword">var</span> f=<span class="keyword">this</span>;f.element.bind(<span class="string">"touchstart"</span>,b.proxy(f,<span class="string">"_touchStart"</span>)).bind(<span class="string">"touchmove"</span>,b.proxy(f,<span class="string">"_touchMove"</span>)).bind(<span class="string">"touchend"</span>,b.proxy(f,<span class="string">"_touchEnd"</span>));e.call(f);};})(jQuery);
define(<span class="string">"jquerypunch"</span>, <span class="keyword">function</span>(){});

<span class="comment">/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>

define(<span class="string">'util'</span>,[<span class="string">"jquery"</span>, <span class="string">"jqueryPlugins"</span>, <span class="string">"jqueryui"</span>, <span class="string">"jquerypunch"</span>], <span class="function"><span class="keyword">function</span> <span class="params">($)</span> {</span>
  <span class="keyword">var</span> util = {};

  util.Deferred = $.Deferred;
  TowTruck.$ = $;

  <span class="comment">/* A simple class pattern, use like:

    var Foo = util.Class({
      constructor: function (a, b) {
        init the class
      },
      otherMethod: ...
    });

  You can also give a superclass as the optional first argument.

  Instantiation does not require "new"

  */</span>
  util.Class = <span class="function"><span class="keyword">function</span> <span class="params">(superClass, prototype)</span> {</span>
    <span class="keyword">var</span> a;
    <span class="keyword">if</span> (prototype === <span class="literal">undefined</span>) {
      prototype = superClass;
    } <span class="keyword">else</span> {
      <span class="keyword">if</span> (superClass.prototype) {
        superClass = superClass.prototype;
      }
      <span class="keyword">var</span> newPrototype = Object.create(superClass);
      <span class="keyword">for</span> (a <span class="keyword">in</span> prototype) {
        <span class="keyword">if</span> (prototype.hasOwnProperty(a)) {
          newPrototype[a] = prototype[a];
        }
      }
      prototype = newPrototype;
    }
    <span class="keyword">var</span> ClassObject = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">var</span> obj = Object.create(prototype);
      obj.constructor.apply(obj, arguments);
      obj.constructor = ClassObject;
      <span class="keyword">return</span> obj;
    };
    ClassObject.prototype = prototype;
    <span class="keyword">if</span> (prototype.constructor.name) {
      ClassObject.className = prototype.constructor.name;
      ClassObject.toString = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">return</span> <span class="string">'[Class '</span> + <span class="keyword">this</span>.className + <span class="string">']'</span>;
      };
    }
    <span class="keyword">if</span> (prototype.classMethods) {
      <span class="keyword">for</span> (a <span class="keyword">in</span> prototype.classMethods) {
        <span class="keyword">if</span> (prototype.classMethods.hasOwnProperty(a)) {
          ClassObject[a] = prototype.classMethods[a];
        }
      }
    }
    <span class="keyword">return</span> ClassObject;
  };

  <span class="comment">/* Extends obj with other, or copies obj if no other is given. */</span>
  util.extend = TowTruck._extend;

  util.forEachAttr = <span class="function"><span class="keyword">function</span> <span class="params">(obj, callback, context)</span> {</span>
    context = context || obj;
    <span class="keyword">for</span> (<span class="keyword">var</span> a <span class="keyword">in</span> obj) {
      <span class="keyword">if</span> (obj.hasOwnProperty(a)) {
        callback.call(context, obj[a], a);
      }
    }
  };

  <span class="comment">/* Trim whitespace from a string */</span>
  util.trim = <span class="function"><span class="keyword">function</span> <span class="title">trim</span><span class="params">(s)</span> {</span>
    <span class="keyword">return</span> s.replace(<span class="regexp">/^\s+/</span>, <span class="string">""</span>).replace(<span class="regexp">/\s+$/</span>, <span class="string">""</span>);
  };

  <span class="comment">/* Convert a string into something safe to use as an HTML class name */</span>
  util.safeClassName = <span class="function"><span class="keyword">function</span> <span class="title">safeClassName</span><span class="params">(name)</span> {</span>
    <span class="keyword">return</span> name.replace(<span class="regexp">/[^a-zA-Z0-9_\-]/g</span>, <span class="string">"_"</span>) || <span class="string">"class"</span>;
  };

  util.AssertionError = <span class="function"><span class="keyword">function</span> <span class="params">(message)</span> {</span>
    <span class="keyword">if</span> (! <span class="keyword">this</span> <span class="keyword">instanceof</span> util.AssertionError) {
      <span class="keyword">return</span> <span class="keyword">new</span> util.AssertionError(message);
    }
    <span class="keyword">this</span>.message = message;
    <span class="keyword">this</span>.name = <span class="string">"AssertionError"</span>;
  };
  util.AssertionError.prototype = Error.prototype;

  util.assert = <span class="function"><span class="keyword">function</span> <span class="params">(cond)</span> {</span>
    <span class="keyword">if</span> (! cond) {
      <span class="keyword">var</span> args = [<span class="string">"Assertion error:"</span>].concat(Array.prototype.slice.call(arguments, <span class="number">1</span>));
      console.error.apply(console, args);
      <span class="keyword">if</span> (console.trace) {
        console.trace();
      }
      <span class="keyword">throw</span> <span class="keyword">new</span> util.AssertionError(args.join(<span class="string">" "</span>));
    }
  };

  <span class="comment">/* Generates a random ID */</span>
  util.generateId = <span class="function"><span class="keyword">function</span> <span class="params">(length)</span> {</span>
    length = length || <span class="number">10</span>;
    <span class="keyword">var</span> letters = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUV0123456789'</span>;
    <span class="keyword">var</span> s = <span class="string">''</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;length; i++) {
      s += letters.charAt(Math.floor(Math.random() * letters.length));
    }
    <span class="keyword">return</span> s;
  };

  util.pickRandom = <span class="function"><span class="keyword">function</span> <span class="params">(array)</span> {</span>
    <span class="keyword">return</span> array[Math.floor(Math.random() * array.length)];
  };

  util.mixinEvents = TowTruck._mixinEvents;

  util.Module = util.Class({
    constructor: <span class="function"><span class="keyword">function</span> <span class="params">(name)</span> {</span>
      <span class="keyword">this</span>._name = name;
    },
    toString: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">return</span> <span class="string">'[Module '</span> + <span class="keyword">this</span>._name + <span class="string">']'</span>;
    }
  });

  util.blobToBase64 = <span class="function"><span class="keyword">function</span> <span class="params">(blob)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-65">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-65">&#182;</a>
                </div>
                <p>Oh this is just terrible</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> binary = <span class="string">''</span>;
    <span class="keyword">var</span> bytes = <span class="keyword">new</span> Uint8Array(blob);
    <span class="keyword">var</span> len = bytes.byteLength;
    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;len; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    <span class="keyword">return</span> btoa(binary);
  };

  util.truncateCommonDomain = <span class="function"><span class="keyword">function</span> <span class="params">(url, base)</span> {</span>
    <span class="comment">/* Remove the scheme and domain from url, if it matches the scheme and domain
       of base */</span>
    <span class="keyword">if</span> (! base) {
      <span class="keyword">return</span> url;
    }
    <span class="keyword">var</span> regex = <span class="regexp">/^https?:\/\/[^\/]*/i</span>;
    <span class="keyword">var</span> match = regex.exec(url);
    <span class="keyword">var</span> matchBase = regex.exec(base);
    <span class="keyword">if</span> (match &amp;&amp; matchBase &amp;&amp; match[<span class="number">0</span>] == matchBase[<span class="number">0</span>]) {</pre></div></div>
              
            </li>
          
            <li id="section-66">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-66">&#182;</a>
                </div>
                <p>There is a common scheme and domain</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">return</span> url.substr(match[<span class="number">0</span>].length);
    }
    <span class="keyword">return</span> url;
  };

  util.resolver = <span class="function"><span class="keyword">function</span> <span class="params">(deferred, func)</span> {</span>
    util.assert(deferred.then, <span class="string">"Bad deferred:"</span>, deferred);
    util.assert(<span class="keyword">typeof</span> func == <span class="string">"function"</span>, <span class="string">"Not a function:"</span>, func);
    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">var</span> result;
      <span class="keyword">try</span> {
        result = func.apply(<span class="keyword">this</span>, arguments);
      } <span class="keyword">catch</span> (e) {
        deferred.reject(e);
        <span class="keyword">throw</span> e;
      }
      <span class="keyword">if</span> (result &amp;&amp; result.then) {
        result.then(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
          deferred.resolveWith(<span class="keyword">this</span>, arguments);
        }, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
          deferred.rejectWith(<span class="keyword">this</span>, arguments);
        });</pre></div></div>
              
            </li>
          
            <li id="section-67">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-67">&#182;</a>
                </div>
                <p>FIXME: doesn&#39;t pass progress through</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      } <span class="keyword">else</span> <span class="keyword">if</span> (result === <span class="literal">undefined</span>) {
        deferred.resolve();
      } <span class="keyword">else</span> {
        deferred.resolve(result);
      }
      <span class="keyword">return</span> result;
    };
  };

  <span class="comment">/* Resolves several promises (the promises are the arguments to the function)
     or the first argument may be an array of promises.

     Returns a promise that will resolve with the results of all the
     promises.  If any promise fails then the returned promise fails.

     FIXME: if a promise has more than one return value (like with
     promise.resolve(a, b)) then the latter arguments will be lost.
     */</span>
  util.resolveMany = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">var</span> args;
    <span class="keyword">if</span> (arguments.length == <span class="number">1</span> &amp;&amp; Array.isArray(arguments[<span class="number">0</span>])) {
      args = arguments[<span class="number">0</span>];
    } <span class="keyword">else</span> {
      args = Array.prototype.slice.call(arguments);
    }
    <span class="keyword">return</span> util.Deferred(<span class="function"><span class="keyword">function</span> <span class="params">(def)</span> {</span>
      <span class="keyword">var</span> count = args.length;
      <span class="keyword">if</span> (! count) {
        def.resolve();
        <span class="keyword">return</span>;
      }
      <span class="keyword">var</span> allResults = [];
      <span class="keyword">var</span> anyError = <span class="literal">false</span>;
      args.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(arg, index)</span> {</span>
        arg.then(<span class="function"><span class="keyword">function</span> <span class="params">(result)</span> {</span>
          allResults[index] = result;
          count--;
          check();
        }, <span class="function"><span class="keyword">function</span> <span class="params">(error)</span> {</span>
          allResults[index] = error;
          anyError = <span class="literal">true</span>;
          count--;
          check();
        });
      });
      <span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">()</span> {</span>
        <span class="keyword">if</span> (! count) {
          <span class="keyword">if</span> (anyError) {
            def.reject.apply(def, allResults);
          } <span class="keyword">else</span> {
            def.resolve.apply(def, allResults);
          }
        }
      }
    });
  };

  util.readFileImage = <span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
    <span class="keyword">return</span> util.Deferred(<span class="function"><span class="keyword">function</span> <span class="params">(def)</span> {</span>
      <span class="keyword">var</span> reader = <span class="keyword">new</span> FileReader();
      reader.onload = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        def.resolve(<span class="string">"data:image/jpeg;base64,"</span> + util.blobToBase64(<span class="keyword">this</span>.result));
      };
      reader.onerror = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        def.reject(<span class="keyword">this</span>.error);
      };
      reader.readAsArrayBuffer(el.files[<span class="number">0</span>]);
    });
  };

  util.testExpose = <span class="function"><span class="keyword">function</span> <span class="params">(objs)</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">typeof</span> TowTruckTestSpy == <span class="string">"undefined"</span>) {
      <span class="keyword">return</span>;
    }
    util.forEachAttr(objs, <span class="function"><span class="keyword">function</span> <span class="params">(value, attr)</span> {</span>
      TowTruckTestSpy[attr] = value;
    });
  };

  <span class="keyword">return</span> util;
});

<span class="comment">/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>

<span class="comment">/* Channel abstraction.  Supported channels:

- WebSocket to an address
- postMessage between windows

In the future:

- XMLHttpRequest to a server (with some form of queuing)

The interface:

  channel = new ChannelName(parameters)

The instantiation is specific to the kind of channel

Methods:

  onmessage: set to function (jsonData)
  rawdata: set to true if you want onmessage to receive raw string data
  onclose: set to function ()
  send: function (string or jsonData)
  close: function ()

.send() will encode the data if it is not a string.

(should I include readyState as an attribute?)

Channels must accept messages immediately, caching if the connection
is not fully established yet.

*/</span>

define(<span class="string">'channels'</span>,[<span class="string">"util"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(util)</span> {</span>

<span class="keyword">var</span> channels = util.Module(<span class="string">"channels"</span>);
<span class="comment">/* Subclasses must define:

- ._send(string)
- ._setupConnection()
- ._ready()
- .close() (and must set this.closed to true)

And must call:

- ._flush() on open
- ._incoming(string) on incoming message
- onclose() (not onmessage - instead _incoming)
- emit("close")
*/</span>

<span class="keyword">var</span> AbstractChannel = util.mixinEvents({
  onmessage: <span class="literal">null</span>,
  rawdata: <span class="literal">false</span>,
  onclose: <span class="literal">null</span>,
  closed: <span class="literal">false</span>,

  baseConstructor: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">this</span>._buffer = [];
    <span class="keyword">this</span>._setupConnection();
  },

  send: <span class="function"><span class="keyword">function</span> <span class="params">(data)</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.closed) {
      <span class="keyword">throw</span> <span class="string">'Cannot send to a closed connection'</span>;
    }
    <span class="keyword">if</span> (<span class="keyword">typeof</span> data != <span class="string">"string"</span>) {
      data = JSON.stringify(data);
    }
    <span class="keyword">if</span> (! <span class="keyword">this</span>._ready()) {
      <span class="keyword">this</span>._buffer.push(data);
      <span class="keyword">return</span>;
    }
    <span class="keyword">this</span>._send(data);
  },

  _flush: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;<span class="keyword">this</span>._buffer.length; i++) {
      <span class="keyword">this</span>._send(<span class="keyword">this</span>._buffer[i]);
    }
    <span class="keyword">this</span>._buffer = [];
  },

  _incoming: <span class="function"><span class="keyword">function</span> <span class="params">(data)</span> {</span>
    <span class="keyword">if</span> (! <span class="keyword">this</span>.rawdata) {
      <span class="keyword">try</span> {
        data = JSON.parse(data);
      } <span class="keyword">catch</span> (e) {
        console.error(<span class="string">"Got invalid JSON data:"</span>, data.substr(<span class="number">0</span>, <span class="number">40</span>));
        <span class="keyword">throw</span> e;
      }
    }
    <span class="keyword">if</span> (<span class="keyword">this</span>.onmessage) {
      <span class="keyword">this</span>.onmessage(data);
    }
    <span class="keyword">this</span>.emit(<span class="string">"message"</span>, data);
  }

});


channels.WebSocketChannel = util.Class(AbstractChannel, {

  constructor: <span class="function"><span class="keyword">function</span> <span class="params">(address)</span> {</span>
    <span class="keyword">if</span> (address.search(<span class="regexp">/^https?:/i</span>) === <span class="number">0</span>) {
      address = address.replace(<span class="regexp">/^http/i</span>, <span class="string">'ws'</span>);
    }
    <span class="keyword">this</span>.address = address;
    <span class="keyword">this</span>.socket = <span class="literal">null</span>;
    <span class="keyword">this</span>._reopening = <span class="literal">false</span>;
    <span class="keyword">this</span>._lastConnectTime = <span class="number">0</span>;
    <span class="keyword">this</span>._backoff = <span class="number">0</span>;
    <span class="keyword">this</span>.baseConstructor();
  },

  backoffTime: <span class="number">50</span>, <span class="comment">// Milliseconds to add to each reconnect time</span>
  maxBackoffTime: <span class="number">1500</span>,
  backoffDetection: <span class="number">2000</span>, <span class="comment">// Amount of time since last connection attempt that shows we need to back off</span>

  toString: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">var</span> s = <span class="string">'[WebSocketChannel to '</span> + <span class="keyword">this</span>.address;
    <span class="keyword">if</span> (! <span class="keyword">this</span>.socket) {
      s += <span class="string">' (socket unopened)'</span>;
    } <span class="keyword">else</span> {
      s += <span class="string">' readyState: '</span> + <span class="keyword">this</span>.socket.readyState;
    }
    <span class="keyword">if</span> (<span class="keyword">this</span>.closed) {
      s += <span class="string">' CLOSED'</span>;
    }
    <span class="keyword">return</span> s + <span class="string">']'</span>;
  },

  close: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">this</span>.closed = <span class="literal">true</span>;
    <span class="keyword">if</span> (<span class="keyword">this</span>.socket) {</pre></div></div>
              
            </li>
          
            <li id="section-68">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-68">&#182;</a>
                </div>
                <p>socket.onclose will call this.onclose:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">this</span>.socket.close();
    } <span class="keyword">else</span> {
      <span class="keyword">if</span> (<span class="keyword">this</span>.onclose) {
        <span class="keyword">this</span>.onclose();
      }
      <span class="keyword">this</span>.emit(<span class="string">"close"</span>);
    }
  },

  _send: <span class="function"><span class="keyword">function</span> <span class="params">(data)</span> {</span>
    <span class="keyword">this</span>.socket.send(data);
  },

  _ready: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.socket &amp;&amp; <span class="keyword">this</span>.socket.readyState == <span class="keyword">this</span>.socket.OPEN;
  },

  _setupConnection: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.closed) {
      <span class="keyword">return</span>;
    }
    <span class="keyword">this</span>._lastConnectTime = Date.now();
    <span class="keyword">this</span>.socket = <span class="keyword">new</span> WebSocket(<span class="keyword">this</span>.address);
    <span class="keyword">this</span>.socket.onopen = (<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">this</span>._flush();
      <span class="keyword">this</span>._reopening = <span class="literal">false</span>;
    }).bind(<span class="keyword">this</span>);
    <span class="keyword">this</span>.socket.onclose = (<span class="function"><span class="keyword">function</span> <span class="params">(event)</span> {</span>
      <span class="keyword">this</span>.socket = <span class="literal">null</span>;
      <span class="keyword">var</span> method = <span class="string">"error"</span>;
      <span class="keyword">if</span> (event.wasClean) {</pre></div></div>
              
            </li>
          
            <li id="section-69">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-69">&#182;</a>
                </div>
                <p>FIXME: should I even log clean closes?</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        method = <span class="string">"log"</span>;
      }
      console[method](<span class="string">'WebSocket close'</span>, event.wasClean ? <span class="string">'clean'</span> : <span class="string">'unclean'</span>,
                      <span class="string">'code:'</span>, event.code, <span class="string">'reason:'</span>, event.reason || <span class="string">'none'</span>);
      <span class="keyword">if</span> (! <span class="keyword">this</span>.closed) {
        <span class="keyword">this</span>._reopening = <span class="literal">true</span>;
        <span class="keyword">if</span> (Date.now() - <span class="keyword">this</span>._lastConnectTime &gt; <span class="keyword">this</span>.backoffDetection) {
          <span class="keyword">this</span>._backoff = <span class="number">0</span>;
        } <span class="keyword">else</span> {
          <span class="keyword">this</span>._backoff++;
        }
        <span class="keyword">var</span> time = Math.min(<span class="keyword">this</span>._backoff * <span class="keyword">this</span>.backoffTime, <span class="keyword">this</span>.maxBackoffTime);
        setTimeout((<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
          <span class="keyword">this</span>._setupConnection();
        }).bind(<span class="keyword">this</span>), time);
      }
    }).bind(<span class="keyword">this</span>);
    <span class="keyword">this</span>.socket.onmessage = (<span class="function"><span class="keyword">function</span> <span class="params">(event)</span> {</span>
      <span class="keyword">this</span>._incoming(event.data);
    }).bind(<span class="keyword">this</span>);
    <span class="keyword">this</span>.socket.onerror = (<span class="function"><span class="keyword">function</span> <span class="params">(event)</span> {</span>
      console.error(<span class="string">'WebSocket error:'</span>, event.data);
    }).bind(<span class="keyword">this</span>);
  }

});


<span class="comment">/* Sends TO a window or iframe */</span>
channels.PostMessageChannel = util.Class(AbstractChannel, {
  _pingPollPeriod: <span class="number">100</span>, <span class="comment">// milliseconds</span>
  _pingPollIncrease: <span class="number">100</span>, <span class="comment">// +100 milliseconds for each failure</span>
  _pingMax: <span class="number">2000</span>, <span class="comment">// up to a max of 2000 milliseconds</span>

  constructor: <span class="function"><span class="keyword">function</span> <span class="params">(win, expectedOrigin)</span> {</span>
    <span class="keyword">this</span>.expectedOrigin = expectedOrigin;
    <span class="keyword">this</span>._pingReceived = <span class="literal">false</span>;
    <span class="keyword">this</span>._receiveMessage = <span class="keyword">this</span>._receiveMessage.bind(<span class="keyword">this</span>);
    <span class="keyword">if</span> (win) {
      <span class="keyword">this</span>.bindWindow(win, <span class="literal">true</span>);
    }
    <span class="keyword">this</span>._pingFailures = <span class="number">0</span>;
    <span class="keyword">this</span>.baseConstructor();
  },

  toString: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">var</span> s = <span class="string">'[PostMessageChannel'</span>;
    <span class="keyword">if</span> (<span class="keyword">this</span>.window) {
      s += <span class="string">' to window '</span> + <span class="keyword">this</span>.window;
    } <span class="keyword">else</span> {
      s += <span class="string">' not bound to a window'</span>;
    }
    <span class="keyword">if</span> (<span class="keyword">this</span>.window &amp;&amp; ! <span class="keyword">this</span>._pingReceived) {
      s += <span class="string">' still establishing'</span>;
    }
    <span class="keyword">return</span> s + <span class="string">']'</span>;
  },

  bindWindow: <span class="function"><span class="keyword">function</span> <span class="params">(win, noSetup)</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.window) {
      <span class="keyword">this</span>.close();</pre></div></div>
              
            </li>
          
            <li id="section-70">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-70">&#182;</a>
                </div>
                <p>Though we deinitialized everything, we aren&#39;t exactly closed:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">this</span>.closed = <span class="literal">false</span>;
    }
    <span class="keyword">if</span> (win &amp;&amp; win.contentWindow) {
      win = win.contentWindow;
    }
    <span class="keyword">this</span>.window = win;</pre></div></div>
              
            </li>
          
            <li id="section-71">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-71">&#182;</a>
                </div>
                <p>FIXME: The distinction between this.window and window seems unimportant
in the case of postMessage</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> w = <span class="keyword">this</span>.window;</pre></div></div>
              
            </li>
          
            <li id="section-72">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-72">&#182;</a>
                </div>
                <p>In a Content context we add the listener to the local window
object, but in the addon context we add the listener to some
other window, like the one we were given:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (<span class="keyword">typeof</span> window != <span class="string">"undefined"</span>) {
      w = window;
    }
    w.addEventListener(<span class="string">"message"</span>, <span class="keyword">this</span>._receiveMessage, <span class="literal">false</span>);
    <span class="keyword">if</span> (! noSetup) {
      <span class="keyword">this</span>._setupConnection();
    }
  },

  _send: <span class="function"><span class="keyword">function</span> <span class="params">(data)</span> {</span>
    <span class="keyword">this</span>.window.postMessage(data, <span class="keyword">this</span>.expectedOrigin || <span class="string">"*"</span>);
  },

  _ready: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.window &amp;&amp; <span class="keyword">this</span>._pingReceived;
  },

  _setupConnection: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.closed || <span class="keyword">this</span>._pingReceived || (! <span class="keyword">this</span>.window)) {
      <span class="keyword">return</span>;
    }
    <span class="keyword">this</span>._pingFailures++;
    <span class="keyword">this</span>._send(<span class="string">"hello"</span>);</pre></div></div>
              
            </li>
          
            <li id="section-73">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-73">&#182;</a>
                </div>
                <p>We&#39;ll keep sending ping messages until we get a reply</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> time = <span class="keyword">this</span>._pingPollPeriod + (<span class="keyword">this</span>._pingPollIncrease * <span class="keyword">this</span>._pingFailures);
    time = time &gt; <span class="keyword">this</span>._pingPollMax ? <span class="keyword">this</span>._pingPollMax : time;
    <span class="keyword">this</span>._pingTimeout = setTimeout(<span class="keyword">this</span>._setupConnection.bind(<span class="keyword">this</span>), time);
  },

  _receiveMessage: <span class="function"><span class="keyword">function</span> <span class="params">(event)</span> {</span>
    <span class="keyword">if</span> (event.source !== <span class="keyword">this</span>.window) {
      <span class="keyword">return</span>;
    }
    <span class="keyword">if</span> (<span class="keyword">this</span>.expectedOrigin &amp;&amp; event.origin != <span class="keyword">this</span>.expectedOrigin) {
      console.info(<span class="string">"Expected message from"</span>, <span class="keyword">this</span>.expectedOrigin,
                   <span class="string">"but got message from"</span>, event.origin);
      <span class="keyword">return</span>;
    }
    <span class="keyword">if</span> (! <span class="keyword">this</span>.expectedOrigin) {
      <span class="keyword">this</span>.expectedOrigin = event.origin;
    }
    <span class="keyword">if</span> (event.data == <span class="string">"hello"</span>) {
      <span class="keyword">this</span>._pingReceived = <span class="literal">true</span>;
      <span class="keyword">if</span> (<span class="keyword">this</span>._pingTimeout) {
        clearTimeout(<span class="keyword">this</span>._pingTimeout);
        <span class="keyword">this</span>._pingTimeout = <span class="literal">null</span>;
      }
      <span class="keyword">this</span>._flush();
      <span class="keyword">return</span>;
    }
    <span class="keyword">this</span>._incoming(event.data);
  },

  close: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">this</span>.closed = <span class="literal">true</span>;
    <span class="keyword">this</span>._pingReceived = <span class="literal">false</span>;
    <span class="keyword">if</span> (<span class="keyword">this</span>._pingTimeout) {
      clearTimeout(<span class="keyword">this</span>._pingTimeout);
    }
    window.removeEventListener(<span class="string">"message"</span>, <span class="keyword">this</span>._receiveMessage, <span class="literal">false</span>);
    <span class="keyword">if</span> (<span class="keyword">this</span>.onclose) {
      <span class="keyword">this</span>.onclose();
    }
    <span class="keyword">this</span>.emit(<span class="string">"close"</span>);
  }

});


<span class="comment">/* Handles message FROM an exterior window/parent */</span>
channels.PostMessageIncomingChannel = util.Class(AbstractChannel, {

  constructor: <span class="function"><span class="keyword">function</span> <span class="params">(expectedOrigin)</span> {</span>
    <span class="keyword">this</span>.source = <span class="literal">null</span>;
    <span class="keyword">this</span>.expectedOrigin = expectedOrigin;
    <span class="keyword">this</span>._receiveMessage = <span class="keyword">this</span>._receiveMessage.bind(<span class="keyword">this</span>);
    window.addEventListener(<span class="string">"message"</span>, <span class="keyword">this</span>._receiveMessage, <span class="literal">false</span>);
    <span class="keyword">this</span>.baseConstructor();
  },

  toString: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">var</span> s = <span class="string">'[PostMessageIncomingChannel'</span>;
    <span class="keyword">if</span> (<span class="keyword">this</span>.source) {
      s += <span class="string">' bound to source '</span> + s;
    } <span class="keyword">else</span> {
      s += <span class="string">' awaiting source'</span>;
    }
    <span class="keyword">return</span> s + <span class="string">']'</span>;
  },

  _send: <span class="function"><span class="keyword">function</span> <span class="params">(data)</span> {</span>
    <span class="keyword">this</span>.source.postMessage(data, <span class="keyword">this</span>.expectedOrigin);
  },

  _ready: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">return</span> !!<span class="keyword">this</span>.source;
  },

  _setupConnection: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  },

  _receiveMessage: <span class="function"><span class="keyword">function</span> <span class="params">(event)</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.expectedOrigin &amp;&amp; <span class="keyword">this</span>.expectedOrigin != <span class="string">"*"</span> &amp;&amp;
        event.origin != <span class="keyword">this</span>.expectedOrigin) {</pre></div></div>
              
            </li>
          
            <li id="section-74">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-74">&#182;</a>
                </div>
                <p>FIXME: Maybe not worth mentioning?</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      console.info(<span class="string">"Expected message from"</span>, <span class="keyword">this</span>.expectedOrigin,
                   <span class="string">"but got message from"</span>, event.origin);
      <span class="keyword">return</span>;
    }
    <span class="keyword">if</span> (! <span class="keyword">this</span>.expectedOrigin) {
      <span class="keyword">this</span>.expectedOrigin = event.origin;
    }
    <span class="keyword">if</span> (! <span class="keyword">this</span>.source) {
      <span class="keyword">this</span>.source = event.source;
    }
    <span class="keyword">if</span> (event.data == <span class="string">"hello"</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-75">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-75">&#182;</a>
                </div>
                <p>Just a ping</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">this</span>.source.postMessage(<span class="string">"hello"</span>, <span class="keyword">this</span>.expectedOrigin);
      <span class="keyword">return</span>;
    }
    <span class="keyword">this</span>._incoming(event.data);
  },

  close: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">this</span>.closed = <span class="literal">true</span>;
    window.removeEventListener(<span class="string">"message"</span>, <span class="keyword">this</span>._receiveMessage, <span class="literal">false</span>);
    <span class="keyword">if</span> (<span class="keyword">this</span>._pingTimeout) {
      clearTimeout(<span class="keyword">this</span>._pingTimeout);
    }
    <span class="keyword">if</span> (<span class="keyword">this</span>.onclose) {
      <span class="keyword">this</span>.onclose();
    }
    <span class="keyword">this</span>.emit(<span class="string">"close"</span>);
  }

});

channels.Router = util.Class(util.mixinEvents({

  constructor: <span class="function"><span class="keyword">function</span> <span class="params">(channel)</span> {</span>
    <span class="keyword">this</span>._channelMessage = <span class="keyword">this</span>._channelMessage.bind(<span class="keyword">this</span>);
    <span class="keyword">this</span>._channelClosed = <span class="keyword">this</span>._channelClosed.bind(<span class="keyword">this</span>);
    <span class="keyword">this</span>._routes = Object.create(<span class="literal">null</span>);
    <span class="keyword">if</span> (channel) {
      <span class="keyword">this</span>.bindChannel(channel);
    }
  },

  bindChannel: <span class="function"><span class="keyword">function</span> <span class="params">(channel)</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.channel) {
      <span class="keyword">this</span>.channel.removeListener(<span class="string">"message"</span>, <span class="keyword">this</span>._channelMessage);
      <span class="keyword">this</span>.channel.removeListener(<span class="string">"close"</span>, <span class="keyword">this</span>._channelClosed);
    }
    <span class="keyword">this</span>.channel = channel;
    <span class="keyword">this</span>.channel.on(<span class="string">"message"</span>, <span class="keyword">this</span>._channelMessage.bind(<span class="keyword">this</span>));
    <span class="keyword">this</span>.channel.on(<span class="string">"close"</span>, <span class="keyword">this</span>._channelClosed.bind(<span class="keyword">this</span>));
  },

  _channelMessage: <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    <span class="keyword">if</span> (msg.type == <span class="string">"route"</span>) {
      <span class="keyword">var</span> id = msg.routeId;
      <span class="keyword">var</span> route = <span class="keyword">this</span>._routes[id];
      <span class="keyword">if</span> (! route) {
        console.warn(<span class="string">"No route with the id"</span>, id);
        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span> (msg.close) {
        <span class="keyword">this</span>._closeRoute(route.id);
      } <span class="keyword">else</span> {
        <span class="keyword">if</span> (route.onmessage) {
          route.onmessage(msg.message);
        }
        route.emit(<span class="string">"message"</span>, msg.message);
      }
    }
  },

  _channelClosed: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">for</span> (<span class="keyword">var</span> id <span class="keyword">in</span> <span class="keyword">this</span>._routes) {
      <span class="keyword">this</span>._closeRoute(id);
    }
  },

  _closeRoute: <span class="function"><span class="keyword">function</span> <span class="params">(id)</span> {</span>
    <span class="keyword">var</span> route = <span class="keyword">this</span>._routes[id];
    <span class="keyword">if</span> (route.onclose) {
      route.onclose();
    }
    route.emit(<span class="string">"close"</span>);
    <span class="keyword">delete</span> <span class="keyword">this</span>._routes[id];
  },

  makeRoute: <span class="function"><span class="keyword">function</span> <span class="params">(id)</span> {</span>
    id = id || util.generateId();
    <span class="keyword">var</span> route = Route(<span class="keyword">this</span>, id);
    <span class="keyword">this</span>._routes[id] = route;
    <span class="keyword">return</span> route;
  }
}));

<span class="keyword">var</span> Route = util.Class(util.mixinEvents({
  constructor: <span class="function"><span class="keyword">function</span> <span class="params">(router, id)</span> {</span>
    <span class="keyword">this</span>.router = router;
    <span class="keyword">this</span>.id = id;
  },

  send: <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    <span class="keyword">this</span>.router.channel.send({
      type: <span class="string">"route"</span>,
      routeId: <span class="keyword">this</span>.id,
      message: msg
    });
  },

  close: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.router._routes[<span class="keyword">this</span>.id] !== <span class="keyword">this</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-76">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-76">&#182;</a>
                </div>
                <p>This route instance has been overwritten, so ignore</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">return</span>;
    }
    <span class="keyword">delete</span> <span class="keyword">this</span>.router._routes[<span class="keyword">this</span>.id];
  }

}));

<span class="keyword">return</span> channels;

});

<span class="comment">/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>

define(<span class="string">'storage'</span>,[<span class="string">"util"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(util)</span> {</span>
  <span class="keyword">var</span> assert = util.assert;
  <span class="keyword">var</span> Deferred = util.Deferred;
  <span class="keyword">var</span> DEFAULT_SETTINGS = {
    name: <span class="string">""</span>,
    defaultName: <span class="string">""</span>,
    avatar: <span class="literal">null</span>,
    stickyShare: <span class="literal">null</span>,
    color: <span class="literal">null</span>,
    seenIntroDialog: <span class="literal">false</span>,
    seenWalkthrough: <span class="literal">false</span>,
    dontShowRtcInfo: <span class="literal">false</span>
  };

  <span class="keyword">var</span> DEBUG_STORAGE = <span class="literal">false</span>;

  <span class="keyword">var</span> Storage = util.Class({
    constructor: <span class="function"><span class="keyword">function</span> <span class="params">(name, storage, prefix)</span> {</span>
      <span class="keyword">this</span>.name = name;
      <span class="keyword">this</span>.storage = storage;
      <span class="keyword">this</span>.prefix = prefix;
    },

    get: <span class="function"><span class="keyword">function</span> <span class="params">(key, defaultValue)</span> {</span>
      <span class="keyword">var</span> self = <span class="keyword">this</span>;
      <span class="keyword">return</span> Deferred(<span class="function"><span class="keyword">function</span> <span class="params">(def)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-77">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-77">&#182;</a>
                </div>
                <p>Strictly this isn&#39;t necessary, but eventually I want to move to something more
async for the storage, and this simulates that much better.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        setTimeout(util.resolver(def, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
          key = self.prefix + key;
          <span class="keyword">var</span> value = self.storage.getItem(key);
          <span class="keyword">if</span> (! value) {
            value = defaultValue;
            <span class="keyword">if</span> (DEBUG_STORAGE) {
              console.debug(<span class="string">"Get storage"</span>, key, <span class="string">"defaults to"</span>, value);
            }
          } <span class="keyword">else</span> {
            value = JSON.parse(value);
            <span class="keyword">if</span> (DEBUG_STORAGE) {
              console.debug(<span class="string">"Get storage"</span>, key, <span class="string">"="</span>, value);
            }
          }
          <span class="keyword">return</span> value;
        }));
      });
    },

    set: <span class="function"><span class="keyword">function</span> <span class="params">(key, value)</span> {</span>
      <span class="keyword">var</span> self = <span class="keyword">this</span>;
      <span class="keyword">if</span> (value !== <span class="literal">undefined</span>) {
        value = JSON.stringify(value);
      }
      <span class="keyword">return</span> Deferred(<span class="function"><span class="keyword">function</span> <span class="params">(def)</span> {</span>
        setTimeout(util.resolver(def, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
          key = self.prefix + key;
          <span class="keyword">if</span> (value === <span class="literal">undefined</span>) {
            self.storage.removeItem(key);
            <span class="keyword">if</span> (DEBUG_STORAGE) {
              console.debug(<span class="string">"Delete storage"</span>, key);
            }
          } <span class="keyword">else</span> {
            self.storage.setItem(key, value);
            <span class="keyword">if</span> (DEBUG_STORAGE) {
              console.debug(<span class="string">"Set storage"</span>, key, value);
            }
          }
        }));
      });
    },

    clear: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">var</span> self = <span class="keyword">this</span>;
      <span class="keyword">var</span> promises = [];
      <span class="keyword">return</span> Deferred((<span class="function"><span class="keyword">function</span> <span class="params">(def)</span> {</span>
        <span class="keyword">this</span>.keys().then(<span class="function"><span class="keyword">function</span> <span class="params">(keys)</span> {</span>
          keys.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(key)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-78">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-78">&#182;</a>
                </div>
                <p>FIXME: technically we&#39;re ignoring the promise returned by all
these sets:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>            promises.push(self.set(key, <span class="literal">undefined</span>));
          });
          util.resolveMany(promises).then(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            def.resolve();
          });
        });
      }).bind(<span class="keyword">this</span>));
    },

    keys: <span class="function"><span class="keyword">function</span> <span class="params">(prefix, excludePrefix)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-79">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-79">&#182;</a>
                </div>
                <p>Returns a list of keys, potentially with the given prefix</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> self = <span class="keyword">this</span>;
      <span class="keyword">return</span> Deferred(<span class="function"><span class="keyword">function</span> <span class="params">(def)</span> {</span>
        setTimeout(util.resolver(def, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
          prefix = prefix || <span class="string">""</span>;
          <span class="keyword">var</span> result = [];
          <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;self.storage.length; i++) {
            <span class="keyword">var</span> key = self.storage.key(i);
            <span class="keyword">if</span> (key.indexOf(self.prefix + prefix) === <span class="number">0</span>) {
              <span class="keyword">var</span> shortKey = key.substr(self.prefix.length);
              <span class="keyword">if</span> (excludePrefix) {
                shortKey = shortKey.substr(prefix.length);
              }
              result.push(shortKey);
            }
          }
          <span class="keyword">return</span> result;
        }));
      });
    },

    toString: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">return</span> <span class="string">'[storage for '</span> + <span class="keyword">this</span>.name + <span class="string">']'</span>;
    }

  });

  <span class="keyword">var</span> storage = Storage(<span class="string">'localStorage'</span>, localStorage, <span class="string">"towtruck."</span>);

  storage.settings = util.mixinEvents({
    defaults: DEFAULT_SETTINGS,

    get: <span class="function"><span class="keyword">function</span> <span class="params">(name)</span> {</span>
      assert(storage.settings.defaults.hasOwnProperty(name), <span class="string">"Unknown setting:"</span>, name);
      <span class="keyword">return</span> storage.get(<span class="string">"settings."</span> + name, storage.settings.defaults[name]);
    },

    set: <span class="function"><span class="keyword">function</span> <span class="params">(name, value)</span> {</span>
      assert(storage.settings.defaults.hasOwnProperty(name), <span class="string">"Unknown setting:"</span>, name);
      <span class="keyword">return</span> storage.set(<span class="string">"settings."</span> + name, value);
    }

  });

  storage.tab = Storage(<span class="string">'sessionStorage'</span>, sessionStorage, <span class="string">"towtruck-session."</span>);

  <span class="keyword">return</span> storage;
});

<span class="comment">/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>

define(<span class="string">'session'</span>,[<span class="string">"require"</span>, <span class="string">"util"</span>, <span class="string">"channels"</span>, <span class="string">"jquery"</span>, <span class="string">"storage"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(require, util, channels, $, storage)</span> {</span>

  <span class="keyword">var</span> DEBUG = <span class="literal">true</span>;</pre></div></div>
              
            </li>
          
            <li id="section-80">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-80">&#182;</a>
                </div>
                <p>This is the amount of time in which a hello-back must be received after a hello
for us to respect a URL change:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> HELLO_BACK_CUTOFF = <span class="number">1500</span>;

  <span class="keyword">var</span> session = util.mixinEvents(util.Module(<span class="string">"session"</span>));
  <span class="keyword">var</span> assert = util.assert;</pre></div></div>
              
            </li>
          
            <li id="section-81">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-81">&#182;</a>
                </div>
                <p>We will load this module later (there&#39;s a circular import):</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> peers;</pre></div></div>
              
            </li>
          
            <li id="section-82">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-82">&#182;</a>
                </div>
                <p>This is the hub we connect to:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  session.shareId = <span class="literal">null</span>;</pre></div></div>
              
            </li>
          
            <li id="section-83">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-83">&#182;</a>
                </div>
                <p>This is the ID that identifies this client:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  session.clientId = <span class="literal">null</span>;
  session.router = channels.Router();</pre></div></div>
              
            </li>
          
            <li id="section-84">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-84">&#182;</a>
                </div>
                <p>Indicates if TowTruck has just started (not continuing from a saved session):</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  session.firstRun = <span class="literal">false</span>;</pre></div></div>
              
            </li>
          
            <li id="section-85">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-85">&#182;</a>
                </div>
                <p>This is the key we use for localStorage:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> localStoragePrefix = <span class="string">"towtruck."</span>;</pre></div></div>
              
            </li>
          
            <li id="section-86">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-86">&#182;</a>
                </div>
                <p>This is the channel to the hub:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> channel = <span class="literal">null</span>;</pre></div></div>
              
            </li>
          
            <li id="section-87">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-87">&#182;</a>
                </div>
                <p>Setting, essentially global:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  session.AVATAR_SIZE = <span class="number">90</span>;

  <span class="keyword">var</span> MAX_SESSION_AGE = <span class="number">30</span>*<span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>*<span class="number">1000</span>; <span class="comment">// 30 days</span>

  <span class="comment">/****************************************
   * URLs
   */</span>

  session.hubUrl = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    assert(session.shareId, <span class="string">"URL cannot be resolved before TowTruck.shareId has been initialized"</span>);
    <span class="keyword">return</span> TowTruck.getConfig(<span class="string">"hubBase"</span>).replace(<span class="regexp">/\/*$/</span>, <span class="string">""</span>) + <span class="string">"/hub/"</span> + session.shareId;
  };

  session.shareUrl = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    assert(session.shareId, <span class="string">"Attempted to access shareUrl() before shareId is set"</span>);
    <span class="keyword">var</span> hash = location.hash;
    <span class="keyword">var</span> m = <span class="regexp">/\?[^#]*/</span>.exec(location.href);
    <span class="keyword">var</span> query = <span class="string">""</span>;
    <span class="keyword">if</span> (m) {
      query = m[<span class="number">0</span>];
    }
    hash = hash.replace(<span class="regexp">/&amp;?towtruck-[a-zA-Z0-9]+/</span>, <span class="string">""</span>);
    hash = hash || <span class="string">"#"</span>;
    <span class="keyword">return</span> location.protocol + <span class="string">"//"</span> + location.host + location.pathname + query +
           hash + <span class="string">"&amp;towtruck="</span> + session.shareId;
  };

  session.recordUrl = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    assert(session.shareId);
    <span class="keyword">var</span> url = TowTruck.baseUrl.replace(<span class="regexp">/\/*$/</span>, <span class="string">""</span>) + <span class="string">"/recorder.html"</span>;
    url += <span class="string">"#&amp;towtruck="</span> + session.shareId + <span class="string">"&amp;hubBase="</span> + TowTruck.getConfig(<span class="string">"hubBase"</span>);
    <span class="keyword">return</span> url;
  };

  <span class="comment">/* location.href without the hash */</span>
  session.currentUrl = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">return</span> location.href.replace(<span class="regexp">/#.*/</span>, <span class="string">""</span>);
  };

  session.siteName = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">return</span> TowTruck.getConfig(<span class="string">"siteName"</span>) || document.title;
  };

  <span class="comment">/****************************************
   * Message handling/dispatching
   */</span>

  session.hub = util.mixinEvents({});

  <span class="keyword">var</span> IGNORE_MESSAGES = [<span class="string">"cursor-update"</span>, <span class="string">"keydown"</span>, <span class="string">"scroll-update"</span>];</pre></div></div>
              
            </li>
          
            <li id="section-88">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-88">&#182;</a>
                </div>
                <p>We ignore incoming messages from the channel until this is true:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> readyForMessages = <span class="literal">false</span>;

  <span class="function"><span class="keyword">function</span> <span class="title">openChannel</span><span class="params">()</span> {</span>
    assert(! channel);
    console.info(<span class="string">"Connecting to"</span>, session.hubUrl(), location.href);
    <span class="keyword">var</span> c = channels.WebSocketChannel(session.hubUrl());
    c.onmessage = <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
      <span class="keyword">if</span> (! readyForMessages) {
        <span class="keyword">if</span> (DEBUG) {
          console.info(<span class="string">"In (but ignored for being early):"</span>, msg);
        }
        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span> (DEBUG &amp;&amp; IGNORE_MESSAGES.indexOf(msg.type) == -<span class="number">1</span>) {
        console.info(<span class="string">"In:"</span>, msg);
      }
      <span class="keyword">if</span> (! peers) {</pre></div></div>
              
            </li>
          
            <li id="section-89">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-89">&#182;</a>
                </div>
                <p>We&#39;re getting messages before everything is fully initialized</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        console.warn(<span class="string">"Message received before all modules loaded (ignoring):"</span>, msg);
        <span class="keyword">return</span>;
      }
      msg.peer = peers.getPeer(msg.clientId, msg);
      <span class="keyword">if</span> (msg.type == <span class="string">"hello"</span> || msg.type == <span class="string">"hello-back"</span> || msg.type == <span class="string">"peer-update"</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-90">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-90">&#182;</a>
                </div>
                <p>We do this here to make sure this is run before any other
hello handlers:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        msg.peer.updateFromHello(msg);
      }
      msg.sameUrl = msg.peer.url == currentUrl;
      <span class="keyword">if</span> (!msg.peer.isSelf) { msg.peer.updateMessageDate(msg); }
      session.hub.emit(msg.type, msg);
      TowTruck._onmessage(msg);
    };
    channel = c;
    session.router.bindChannel(channel);
  }</pre></div></div>
              
            </li>
          
            <li id="section-91">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-91">&#182;</a>
                </div>
                <p>FIXME: once we start looking at window.history we need to update this:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> currentUrl = (location.href + <span class="string">""</span>).replace(<span class="regexp">/\#.*$/</span>, <span class="string">""</span>);

  session.send = <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    <span class="keyword">if</span> (DEBUG &amp;&amp; IGNORE_MESSAGES.indexOf(msg.type) == -<span class="number">1</span>) {
      console.info(<span class="string">"Send:"</span>, msg);
    }
    msg.clientId = session.clientId;
    channel.send(msg);
  };

  session.appSend = <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    <span class="keyword">var</span> type = msg.type;
    <span class="keyword">if</span> (type.search(<span class="regexp">/^towtruck\./</span>) === <span class="number">0</span>) {
      type = type.substr(<span class="string">"towtruck."</span>.length);
    } <span class="keyword">else</span> <span class="keyword">if</span> (type.search(<span class="regexp">/^app\./</span>) === -<span class="number">1</span>) {
      type = <span class="string">"app."</span> + type;
    }
    msg.type = type;
    session.send(msg);
  };

  <span class="comment">/****************************************
   * Standard message responses
   */</span>

  <span class="comment">/* Always say hello back, and keep track of peers: */</span>
  session.hub.on(<span class="string">"hello hello-back"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    <span class="keyword">if</span> (msg.type == <span class="string">"hello"</span>) {
      sendHello(<span class="literal">true</span>);
    }
    <span class="keyword">if</span> (session.isClient &amp;&amp; (! msg.isClient) &amp;&amp;
        session.firstRun &amp;&amp; session.timeHelloSent &amp;&amp;
        Date.now() - session.timeHelloSent &lt; HELLO_BACK_CUTOFF) {
      processFirstHello(msg);
    }
  });

  <span class="function"><span class="keyword">function</span> <span class="title">processFirstHello</span><span class="params">(msg)</span> {</span>
    <span class="keyword">if</span> (! msg.sameUrl) {
      <span class="keyword">var</span> url = msg.url;
      <span class="keyword">if</span> (msg.urlHash) {
        url += msg.urlHash;
      }
      require(<span class="string">"ui"</span>).showUrlChangeMessage(msg.peer, url);
      location.href = url;
    }
  }

  session.timeHelloSent = <span class="literal">null</span>;

  <span class="function"><span class="keyword">function</span> <span class="title">sendHello</span><span class="params">(helloBack)</span> {</span>
    <span class="keyword">var</span> msg = {
      name: peers.Self.name || peers.Self.defaultName,
      avatar: peers.Self.avatar,
      color: peers.Self.color,
      url: session.currentUrl(),
      urlHash: location.hash,</pre></div></div>
              
            </li>
          
            <li id="section-92">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-92">&#182;</a>
                </div>
                <p>FIXME: titles update, we should track those changes:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      title: document.title,
      rtcSupported: session.RTCSupported,
      isClient: session.isClient
    };
    <span class="keyword">if</span> (helloBack) {
      msg.type = <span class="string">"hello-back"</span>;
    } <span class="keyword">else</span> {
      msg.type = <span class="string">"hello"</span>;
      msg.clientVersion = TowTruck.version;
      session.timeHelloSent = Date.now();
      peers.Self.url = msg.url;
    }
    <span class="keyword">if</span> (! TowTruck.startup.continued) {
      msg.starting = <span class="literal">true</span>;
    }</pre></div></div>
              
            </li>
          
            <li id="section-93">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-93">&#182;</a>
                </div>
                <p>This is a chance for other modules to effect the hello message:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    session.emit(<span class="string">"prepare-hello"</span>, msg);
    session.send(msg);
  }

  <span class="comment">/****************************************
   * Lifecycle (start and end)
   */</span></pre></div></div>
              
            </li>
          
            <li id="section-94">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-94">&#182;</a>
                </div>
                <p>These are Javascript files that implement features, and so must
be injected at runtime because they aren&#39;t pulled in naturally
via define().
ui must be the first item:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> features = [<span class="string">"peers"</span>, <span class="string">"ui"</span>, <span class="string">"chat"</span>, <span class="string">"webrtc"</span>, <span class="string">"cursor"</span>, <span class="string">"startup"</span>, <span class="string">"forms"</span>, <span class="string">"visibilityApi"</span>];

  <span class="function"><span class="keyword">function</span> <span class="title">getRoomName</span><span class="params">(prefix, maxSize)</span> {</span>
    <span class="keyword">var</span> findRoom = TowTruck.getConfig(<span class="string">"hubBase"</span>).replace(<span class="regexp">/\/*$/</span>, <span class="string">""</span>) + <span class="string">"/findroom"</span>;
    <span class="keyword">return</span> $.ajax({
      url: findRoom,
      dataType: <span class="string">"json"</span>,
      data: {prefix: prefix, max: maxSize}
    }).then(<span class="function"><span class="keyword">function</span> <span class="params">(resp)</span> {</span>
      <span class="keyword">return</span> resp.name;
    });
  }

  <span class="function"><span class="keyword">function</span> <span class="title">initIdentityId</span><span class="params">()</span> {</span>
    <span class="keyword">return</span> util.Deferred(<span class="function"><span class="keyword">function</span> <span class="params">(def)</span> {</span>
      <span class="keyword">if</span> (session.identityId) {
        def.resolve();
        <span class="keyword">return</span>;
      }
      storage.get(<span class="string">"identityId"</span>).then(<span class="function"><span class="keyword">function</span> <span class="params">(identityId)</span> {</span>
        <span class="keyword">if</span> (! identityId) {
          identityId = util.generateId();
          storage.set(<span class="string">"identityId"</span>, identityId);
        }
        session.identityId = identityId;</pre></div></div>
              
            </li>
          
            <li id="section-95">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-95">&#182;</a>
                </div>
                <p>We don&#39;t actually have to wait for the set to succede, so
long as session.identityId is set</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        def.resolve();
      });
    });
  }

  initIdentityId.done = initIdentityId();

  <span class="function"><span class="keyword">function</span> <span class="title">initShareId</span><span class="params">()</span> {</span>
    <span class="keyword">return</span> util.Deferred(<span class="function"><span class="keyword">function</span> <span class="params">(def)</span> {</span>
      <span class="keyword">var</span> hash = location.hash;
      <span class="keyword">var</span> shareId = session.shareId;
      <span class="keyword">var</span> isClient = <span class="literal">true</span>;
      <span class="keyword">var</span> set = <span class="literal">true</span>;
      <span class="keyword">var</span> sessionId;
      session.firstRun = ! TowTruck.startup.continued;
      <span class="keyword">if</span> (! shareId) {
        <span class="keyword">if</span> (TowTruck.startup._joinShareId) {</pre></div></div>
              
            </li>
          
            <li id="section-96">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-96">&#182;</a>
                </div>
                <p>Like, below, this <em>also</em> means we got the shareId from the hash
(in towtruck.js):</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>          shareId = TowTruck.startup._joinShareId;
        }
      }
      <span class="keyword">if</span> (! shareId) {</pre></div></div>
              
            </li>
          
            <li id="section-97">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-97">&#182;</a>
                </div>
                <p>FIXME: I&#39;m not sure if this will ever happen, because towtruck.js should
handle it</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> m = <span class="regexp">/&amp;?towtruck=([^&amp;]*)/</span>.exec(hash);
        <span class="keyword">if</span> (m) {
          isClient = ! m[<span class="number">1</span>];
          shareId = m[<span class="number">2</span>];
          <span class="keyword">var</span> newHash = hash.substr(<span class="number">0</span>, m.index) + hash.substr(m.index + m[<span class="number">0</span>].length);
          location.hash = newHash;
        }
      }
      <span class="keyword">return</span> storage.tab.get(<span class="string">"status"</span>).then(<span class="function"><span class="keyword">function</span> <span class="params">(saved)</span> {</span>
        <span class="keyword">var</span> findRoom = TowTruck.getConfig(<span class="string">"findRoom"</span>);
        <span class="keyword">if</span> (findRoom &amp;&amp; ! saved) {
          assert(findRoom.prefix &amp;&amp; <span class="keyword">typeof</span> findRoom.prefix == <span class="string">"string"</span>, <span class="string">"Bad findRoom.prefix"</span>, findRoom);
          assert(findRoom.max &amp;&amp; <span class="keyword">typeof</span> findRoom.max == <span class="string">"number"</span> &amp;&amp; findRoom.max &gt; <span class="number">0</span>,
                 <span class="string">"Bad findRoom.max"</span>, findRoom);
          sessionId = util.generateId();
          <span class="keyword">if</span> (findRoom.prefix.search(<span class="regexp">/[^a-zA-Z0-9]/</span>) != -<span class="number">1</span>) {
            console.warn(<span class="string">"Bad value for findRoom.prefix:"</span>, JSON.stringify(findRoom.prefix));
          }
          getRoomName(findRoom.prefix, findRoom.max).then(<span class="function"><span class="keyword">function</span> <span class="params">(shareId)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-98">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-98">&#182;</a>
                </div>
                <p>FIXME: duplicates code below:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>            session.clientId = session.identityId + <span class="string">"."</span> + sessionId;
            storage.tab.set(<span class="string">"status"</span>, {reason: <span class="string">"joined"</span>, shareId: shareId, running: <span class="literal">true</span>, date: Date.now(), sessionId: sessionId});
            session.isClient = <span class="literal">true</span>;
            session.shareId = shareId;
            session.emit(<span class="string">"shareId"</span>);
            def.resolve(session.shareId);
          });
          <span class="keyword">return</span>;
        } <span class="keyword">else</span> <span class="keyword">if</span> (TowTruck.startup._launch) {
          <span class="keyword">if</span> (saved) {
            isClient = saved.reason == <span class="string">"joined"</span>;
            <span class="keyword">if</span> (! shareId) {
              shareId = saved.shareId;
            }
            sessionId = saved.sessionId;
          } <span class="keyword">else</span> {
            isClient = TowTruck.startup.reason == <span class="string">"joined"</span>;
            assert(! sessionId);
            sessionId = util.generateId();
          }
          <span class="keyword">if</span> (! shareId) {
            shareId = util.generateId();
          }
        } <span class="keyword">else</span> <span class="keyword">if</span> (saved) {
          isClient = saved.reason == <span class="string">"joined"</span>;
          TowTruck.startup.reason = saved.reason;
          TowTruck.startup.continued = <span class="literal">true</span>;
          shareId = saved.shareId;
          sessionId = saved.sessionId;</pre></div></div>
              
            </li>
          
            <li id="section-99">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-99">&#182;</a>
                </div>
                <p>The only case when we don&#39;t need to set the storage status again is when
we&#39;re already set to be running</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>          set = ! saved.running;
        } <span class="keyword">else</span> {
          <span class="keyword">throw</span> <span class="keyword">new</span> util.AssertionError(<span class="string">"No saved status, and no startup._launch request; why did TowTruck start?"</span>);
        }
        assert(session.identityId);
        session.clientId = session.identityId + <span class="string">"."</span> + sessionId;
        <span class="keyword">if</span> (set) {
          storage.tab.set(<span class="string">"status"</span>, {reason: TowTruck.startup.reason, shareId: shareId, running: <span class="literal">true</span>, date: Date.now(), sessionId: sessionId});
        }
        session.isClient = isClient;
        session.shareId = shareId;
        session.emit(<span class="string">"shareId"</span>);
        def.resolve(session.shareId);
      });
    });
  }

  <span class="function"><span class="keyword">function</span> <span class="title">initStartTarget</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> id;
    <span class="keyword">if</span> (TowTruck.startup.button) {
      id = TowTruck.startup.button.id;
      <span class="keyword">if</span> (id) {
        storage.set(<span class="string">"startTarget"</span>, id);
      }
      <span class="keyword">return</span>;
    }
    storage.get(<span class="string">"startTarget"</span>).then(<span class="function"><span class="keyword">function</span> <span class="params">(id)</span> {</span>
      <span class="keyword">var</span> el = document.getElementById(id);
      <span class="keyword">if</span> (el) {
        TowTruck.startup.button = el;
      }
    });
  }

  session.start = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    initStartTarget();
    initIdentityId().then(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      initShareId().then(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        readyForMessages = <span class="literal">false</span>;
        openChannel();
        require([<span class="string">"ui"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(ui)</span> {</span>
          TowTruck.running = <span class="literal">true</span>;
          ui.prepareUI();
          require(features, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            $(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
              peers = require(<span class="string">"peers"</span>);
              <span class="keyword">var</span> startup = require(<span class="string">"startup"</span>);
              session.emit(<span class="string">"start"</span>);
              session.once(<span class="string">"ui-ready"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                readyForMessages = <span class="literal">true</span>;
                startup.start();
              });
              ui.activateUI();
              <span class="keyword">if</span> (TowTruck.getConfig(<span class="string">"enableAnalytics"</span>)) {
                require([<span class="string">"analytics"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(analytics)</span> {</span>
                  analytics.activate();
                });
              }
              peers._SelfLoaded.then(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                sendHello(<span class="literal">false</span>);
              });
              TowTruck.emit(<span class="string">"ready"</span>);
            });
          });
        });
      });
    });
  };

  session.close = <span class="function"><span class="keyword">function</span> <span class="params">(reason)</span> {</span>
    TowTruck.running = <span class="literal">false</span>;
    <span class="keyword">var</span> msg = {type: <span class="string">"bye"</span>};
    <span class="keyword">if</span> (reason) {
      msg.reason = reason;
    }
    session.send(msg);
    session.emit(<span class="string">"close"</span>);
    <span class="keyword">var</span> name = window.name;
    storage.tab.get(<span class="string">"status"</span>).then(<span class="function"><span class="keyword">function</span> <span class="params">(saved)</span> {</span>
      <span class="keyword">if</span> (! saved) {
        console.warn(<span class="string">"No session information saved in"</span>, <span class="string">"status."</span> + name);
      } <span class="keyword">else</span> {
        saved.running = <span class="literal">false</span>;
        saved.date = Date.now();
        storage.tab.set(<span class="string">"status"</span>, saved);
      }
      channel.close();
      channel = <span class="literal">null</span>;
      session.shareId = <span class="literal">null</span>;
      session.emit(<span class="string">"shareId"</span>);
      TowTruck.emit(<span class="string">"close"</span>);
      TowTruck._teardown();
    });
  };


  session.on(<span class="string">"start"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    $(window).on(<span class="string">"resize"</span>, resizeEvent);
  });
  session.on(<span class="string">"close"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    $(window).off(<span class="string">"resize"</span>, resizeEvent);
  });
  <span class="function"><span class="keyword">function</span> <span class="title">resizeEvent</span><span class="params">()</span> {</span>
    session.emit(<span class="string">"resize"</span>);
  }

  <span class="keyword">if</span> (TowTruck.startup._launch) {
    setTimeout(session.start);
  }

  util.testExpose({
    getChannel: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">return</span> channel;
    }
  });

  <span class="keyword">return</span> session;
});

<span class="comment">/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>

define(<span class="string">'peers'</span>,[<span class="string">"util"</span>, <span class="string">"session"</span>, <span class="string">"storage"</span>, <span class="string">"require"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(util, session, storage, require)</span> {</span>
  <span class="keyword">var</span> peers = util.Module(<span class="string">"peers"</span>);
  <span class="keyword">var</span> assert = util.assert;
  <span class="keyword">var</span> CHECK_ACTIVITY_INTERVAL = <span class="number">10</span>*<span class="number">1000</span>; <span class="comment">// Every 10 seconds see if someone has gone idle</span>
  <span class="keyword">var</span> IDLE_TIME = <span class="number">3</span>*<span class="number">60</span>*<span class="number">1000</span>; <span class="comment">// Idle time is 3 minutes</span>
  <span class="keyword">var</span> BYE_TIME = <span class="number">10</span>*<span class="number">60</span>*<span class="number">1000</span>; <span class="comment">// After 10 minutes of inactivity the person is considered to be "gone"</span>

  <span class="keyword">var</span> ui;
  require([<span class="string">"ui"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(uiModule)</span> {</span>
    ui = uiModule;
  });

  <span class="keyword">var</span> DEFAULT_NICKNAMES = [
    <span class="string">"Friendly Fox"</span>,
    <span class="string">"Brilliant Beaver"</span>,
	<span class="string">"Observant Owl"</span>,
	<span class="string">"Gregarious Giraffe"</span>,
	<span class="string">"Wild Wolf"</span>,
	<span class="string">"Silent Seal"</span>,
	<span class="string">"Wacky Whale"</span>,
	<span class="string">"Curious Cat"</span>,
	<span class="string">"Intelligent Iguana"</span>
  ];

  <span class="keyword">var</span> Peer = util.Class({

    isSelf: <span class="literal">false</span>,

    constructor: <span class="function"><span class="keyword">function</span> <span class="params">(id, attrs)</span> {</span>
      attrs = attrs || {};
      assert(id);
      assert(! Peer.peers[id]);
      <span class="keyword">this</span>.id = id;
      <span class="keyword">this</span>.identityId = attrs.identityId || <span class="literal">null</span>;
      <span class="keyword">this</span>.status = attrs.status || <span class="string">"live"</span>;
      <span class="keyword">this</span>.idle = attrs.status || <span class="string">"active"</span>;
      <span class="keyword">this</span>.name = attrs.name || <span class="literal">null</span>;
      <span class="keyword">this</span>.avatar = attrs.avatar || <span class="literal">null</span>;
      <span class="keyword">this</span>.color = attrs.color || <span class="string">"#00FF00"</span>;
      <span class="keyword">this</span>.view = ui.PeerView(<span class="keyword">this</span>);
      <span class="keyword">this</span>.lastMessageDate = <span class="number">0</span>;
      <span class="keyword">this</span>.following = attrs.following || <span class="literal">false</span>;
      Peer.peers[id] = <span class="keyword">this</span>;
      <span class="keyword">var</span> joined = attrs.joined || <span class="literal">false</span>;
      <span class="keyword">if</span> (attrs.fromHelloMessage) {
        <span class="keyword">this</span>.updateFromHello(attrs.fromHelloMessage);
        <span class="keyword">if</span> (attrs.fromHelloMessage.type == <span class="string">"hello"</span>) {
          joined = <span class="literal">true</span>;
        }
      }
      peers.emit(<span class="string">"new-peer"</span>, <span class="keyword">this</span>);
      <span class="keyword">if</span> (joined) {
        <span class="keyword">this</span>.view.notifyJoined();
      }
      <span class="keyword">this</span>.view.update();
    },

    repr: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">return</span> <span class="string">"Peer("</span> + JSON.stringify(<span class="keyword">this</span>.id) + <span class="string">")"</span>;
    },

    serialize: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">return</span> {
        id: <span class="keyword">this</span>.id,
        status: <span class="keyword">this</span>.status,
        idle: <span class="keyword">this</span>.idle,
        url: <span class="keyword">this</span>.url,
        hash: <span class="keyword">this</span>.hash,
        title: <span class="keyword">this</span>.title,
        identityId: <span class="keyword">this</span>.identityId,
        rtcSupported: <span class="keyword">this</span>.rtcSupported,
        name: <span class="keyword">this</span>.name,
        avatar: <span class="keyword">this</span>.avatar,
        color: <span class="keyword">this</span>.color,
        following: <span class="keyword">this</span>.following
      };
    },

    destroy: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">this</span>.view.destroy();
      <span class="keyword">delete</span> Peer.peers[<span class="keyword">this</span>.id];
    },

    updateMessageDate: <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
      <span class="keyword">if</span> (<span class="keyword">this</span>.idle == <span class="string">"inactive"</span>) {
        <span class="keyword">this</span>.update({idle: <span class="string">"active"</span>});
      }
      <span class="keyword">if</span> (<span class="keyword">this</span>.status == <span class="string">"bye"</span>) {
        <span class="keyword">this</span>.unbye();
      }
      <span class="keyword">this</span>.lastMessageDate = Date.now();
    },

    updateFromHello: <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
      <span class="keyword">var</span> urlUpdated = <span class="literal">false</span>;
      <span class="keyword">var</span> activeRTC = <span class="literal">false</span>;
      <span class="keyword">var</span> identityUpdated = <span class="literal">false</span>;
      <span class="keyword">if</span> (msg.url &amp;&amp; msg.url != <span class="keyword">this</span>.url) {
        <span class="keyword">this</span>.url = msg.url;
        <span class="keyword">this</span>.hash = <span class="literal">null</span>;
        <span class="keyword">this</span>.title = <span class="literal">null</span>;
        urlUpdated = <span class="literal">true</span>;
      }
      <span class="keyword">if</span> (msg.hash != <span class="keyword">this</span>.hash) {
        <span class="keyword">this</span>.hash = msg.urlHash;
        urlUpdated = <span class="literal">true</span>;
      }
      <span class="keyword">if</span> (msg.title != <span class="keyword">this</span>.title) {
        <span class="keyword">this</span>.title = msg.title;
        urlUpdated = <span class="literal">true</span>;
      }
      <span class="keyword">if</span> (msg.rtcSupported !== <span class="literal">undefined</span>) {
        <span class="keyword">this</span>.rtcSupported = msg.rtcSupported;
      }
      <span class="keyword">if</span> (msg.identityId !== <span class="literal">undefined</span>) {
        <span class="keyword">this</span>.identityId = msg.identityId;
      }
      <span class="keyword">if</span> (msg.name &amp;&amp; msg.name != <span class="keyword">this</span>.name) {
        <span class="keyword">this</span>.name = msg.name;
        identityUpdated = <span class="literal">true</span>;
      }
      <span class="keyword">if</span> (msg.avatar &amp;&amp; msg.avatar != <span class="keyword">this</span>.avatar) {
        <span class="keyword">this</span>.avatar = msg.avatar;
        identityUpdated = <span class="literal">true</span>;
      }
      <span class="keyword">if</span> (msg.color &amp;&amp; msg.color != <span class="keyword">this</span>.color) {
        <span class="keyword">this</span>.color = msg.color;
        identityUpdated = <span class="literal">true</span>;
      }
      <span class="keyword">if</span> (msg.isClient !== <span class="literal">undefined</span>) {
        <span class="keyword">this</span>.isCreator = ! msg.isClient;
      }
      <span class="keyword">if</span> (<span class="keyword">this</span>.status != <span class="string">"live"</span>) {
        <span class="keyword">this</span>.status = <span class="string">"live"</span>;
        peers.emit(<span class="string">"status-updated"</span>, <span class="keyword">this</span>);
      }
      <span class="keyword">if</span> (<span class="keyword">this</span>.idle != <span class="string">"active"</span>) {
        <span class="keyword">this</span>.idle = <span class="string">"active"</span>;
        peers.emit(<span class="string">"idle-updated"</span>, <span class="keyword">this</span>);
      }
      <span class="keyword">if</span> (msg.rtcSupported) {
        peers.emit(<span class="string">"rtc-supported"</span>, <span class="keyword">this</span>);
      }
      <span class="keyword">if</span> (urlUpdated) {
        peers.emit(<span class="string">"url-updated"</span>, <span class="keyword">this</span>);
      }
      <span class="keyword">if</span> (identityUpdated) {
        peers.emit(<span class="string">"identity-updated"</span>, <span class="keyword">this</span>);
      }</pre></div></div>
              
            </li>
          
            <li id="section-100">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-100">&#182;</a>
                </div>
                <p>FIXME: I can&#39;t decide if this is the only time we need to emit
this message (and not .update() or other methods)</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (<span class="keyword">this</span>.following) {
        session.emit(<span class="string">"follow-peer"</span>, <span class="keyword">this</span>);
      }
    },

    update: <span class="function"><span class="keyword">function</span> <span class="params">(attrs)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-101">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-101">&#182;</a>
                </div>
                <p>FIXME: should probably test that only a couple attributes are settable
particularly status and idle</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (attrs.idle) {
        <span class="keyword">this</span>.idle = attrs.idle;
      }
      <span class="keyword">if</span> (attrs.status) {
        <span class="keyword">this</span>.status = attrs.status;
      }
      <span class="keyword">this</span>.view.update();
    },

    className: <span class="function"><span class="keyword">function</span> <span class="params">(prefix)</span> {</span>
      prefix = prefix || <span class="string">""</span>;
      <span class="keyword">return</span> prefix + util.safeClassName(<span class="keyword">this</span>.id);
    },

    bye: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">if</span> (<span class="keyword">this</span>.status != <span class="string">"bye"</span>) {
        <span class="keyword">this</span>.status = <span class="string">"bye"</span>;
        peers.emit(<span class="string">"status-updated"</span>, <span class="keyword">this</span>);
      }
      <span class="keyword">this</span>.view.update();
    },

    unbye: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">if</span> (<span class="keyword">this</span>.status == <span class="string">"bye"</span>) {
        <span class="keyword">this</span>.status = <span class="string">"live"</span>;
        peers.emit(<span class="string">"status-updated"</span>, <span class="keyword">this</span>);
      }
      <span class="keyword">this</span>.view.update();
    },

    nudge: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      session.send({
        type: <span class="string">"url-change-nudge"</span>,
        url: location.href,
        to: <span class="keyword">this</span>.id
      });
    },

    follow: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">if</span> (<span class="keyword">this</span>.following) {
        <span class="keyword">return</span>;
      }
      peers.getAllPeers().forEach(<span class="function"><span class="keyword">function</span> <span class="params">(p)</span> {</span>
        <span class="keyword">if</span> (p.following) {
          p.unfollow();
        }
      });
      <span class="keyword">this</span>.following = <span class="literal">true</span>;</pre></div></div>
              
            </li>
          
            <li id="section-102">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-102">&#182;</a>
                </div>
                <p>We have to make sure we remember this, even if we change URLs:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      storeSerialization();
      <span class="keyword">this</span>.view.update();
      session.emit(<span class="string">"follow-peer"</span>, <span class="keyword">this</span>);
    },

    unfollow: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">this</span>.following = <span class="literal">false</span>;
      storeSerialization();
      <span class="keyword">this</span>.view.update();
    }

  });</pre></div></div>
              
            </li>
          
            <li id="section-103">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-103">&#182;</a>
                </div>
                <p>FIXME: I can&#39;t decide where this should actually go, seems weird
that it is emitted and handled in the same module</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  session.on(<span class="string">"follow-peer"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(peer)</span> {</span>
    <span class="keyword">if</span> (peer.url != session.currentUrl()) {
      <span class="keyword">var</span> url = peer.url;
      <span class="keyword">if</span> (peer.urlHash) {
        url += peer.urlHash;
      }
      location.href = url;
    }
  });

  Peer.peers = {};

  Peer.deserialize = <span class="function"><span class="keyword">function</span> <span class="params">(obj)</span> {</span>
    obj.fromStorage = <span class="literal">true</span>;
    <span class="keyword">var</span> peer = Peer(obj.id, obj);
  };

  peers.Self = <span class="literal">undefined</span>;

  session.on(<span class="string">"start"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">if</span> (peers.Self) {
      <span class="keyword">return</span>;
    }
    <span class="comment">/* Same interface as Peer, represents oneself (local user): */</span>
    peers.Self = util.mixinEvents({
      isSelf: <span class="literal">true</span>,
      id: session.clientId,
      identityId: session.identityId,
      status: <span class="string">"live"</span>,
      idle: <span class="string">"active"</span>,
      name: <span class="literal">null</span>,
      avatar: <span class="literal">null</span>,
      color: <span class="literal">null</span>,
      defaultName: <span class="literal">null</span>,
      loaded: <span class="literal">false</span>,
      isCreator: ! session.isClient,

      update: <span class="function"><span class="keyword">function</span> <span class="params">(attrs)</span> {</span>
        <span class="keyword">var</span> updatePeers = <span class="literal">false</span>;
        <span class="keyword">var</span> updateIdle = <span class="literal">false</span>;
        <span class="keyword">var</span> updateMsg = {type: <span class="string">"peer-update"</span>};
        <span class="keyword">if</span> (<span class="keyword">typeof</span> attrs.name == <span class="string">"string"</span> &amp;&amp; attrs.name != <span class="keyword">this</span>.name) {
          <span class="keyword">this</span>.name = attrs.name;
          updateMsg.name = <span class="keyword">this</span>.name;
          <span class="keyword">if</span> (! attrs.fromLoad) {
            storage.settings.set(<span class="string">"name"</span>, <span class="keyword">this</span>.name);
            updatePeers = <span class="literal">true</span>;
          }
        }
        <span class="keyword">if</span> (attrs.avatar &amp;&amp; attrs.avatar != <span class="keyword">this</span>.avatar) {
          <span class="keyword">this</span>.avatar = attrs.avatar;
          updateMsg.avatar = <span class="keyword">this</span>.avatar;
          <span class="keyword">if</span> (! attrs.fromLoad) {
            storage.settings.set(<span class="string">"avatar"</span>, <span class="keyword">this</span>.avatar);
            updatePeers = <span class="literal">true</span>;
          }
        }
        <span class="keyword">if</span> (attrs.color &amp;&amp; attrs.color != <span class="keyword">this</span>.color) {
          <span class="keyword">this</span>.color = attrs.color;
          updateMsg.color = <span class="keyword">this</span>.color;
          <span class="keyword">if</span> (! attrs.fromLoad) {
            storage.settings.set(<span class="string">"color"</span>, <span class="keyword">this</span>.color);
            updatePeers = <span class="literal">true</span>;
          }
        }
        <span class="keyword">if</span> (attrs.defaultName &amp;&amp; attrs.defaultName != <span class="keyword">this</span>.defaultName) {
          <span class="keyword">this</span>.defaultName = attrs.defaultName;
          <span class="keyword">if</span> (! attrs.fromLoad) {
            storage.settings.set(<span class="string">"defaultName"</span>, <span class="keyword">this</span>.defaultName);
            updatePeers = <span class="literal">true</span>;
          }
        }
        <span class="keyword">if</span> (attrs.status &amp;&amp; attrs.status != <span class="keyword">this</span>.status) {
          <span class="keyword">this</span>.status = attrs.status;
          peers.emit(<span class="string">"status-updated"</span>, <span class="keyword">this</span>);
        }
        <span class="keyword">if</span> (attrs.idle &amp;&amp; attrs.idle != <span class="keyword">this</span>.idle) {
          <span class="keyword">this</span>.idle = attrs.idle;
          updateIdle = <span class="literal">true</span>;
          peers.emit(<span class="string">"idle-updated"</span>, <span class="keyword">this</span>);
        }
        <span class="keyword">this</span>.view.update();
        <span class="keyword">if</span> (updatePeers &amp;&amp; ! attrs.fromLoad) {
          session.send(updateMsg);
        }
        <span class="keyword">if</span> (updateIdle &amp;&amp; ! attrs.fromLoad) {
          session.send({
            type: <span class="string">"idle-status"</span>,
            idle: <span class="keyword">this</span>.idle
          });
        }
      },

      className: <span class="function"><span class="keyword">function</span> <span class="params">(prefix)</span> {</span>
        prefix = prefix || <span class="string">""</span>;
        <span class="keyword">return</span> prefix + <span class="string">"self"</span>;
      },

      _loadFromSettings: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">return</span> util.resolveMany(
          storage.settings.get(<span class="string">"name"</span>),
          storage.settings.get(<span class="string">"avatar"</span>),
          storage.settings.get(<span class="string">"defaultName"</span>),
          storage.settings.get(<span class="string">"color"</span>)).then((<span class="function"><span class="keyword">function</span> <span class="params">(name, avatar, defaultName, color)</span> {</span>
            <span class="keyword">if</span> (! defaultName) {
              defaultName = util.pickRandom(DEFAULT_NICKNAMES);
              storage.settings.set(<span class="string">"defaultName"</span>, defaultName);
            }
            <span class="keyword">if</span> (! color) {
              color = Math.floor(Math.random() * <span class="number">0xffffff</span>).toString(<span class="number">16</span>);
              <span class="keyword">while</span> (color.length &lt; <span class="number">6</span>) {
                color = <span class="string">"0"</span> + color;
              }
              color = <span class="string">"#"</span> + color;
              storage.settings.set(<span class="string">"color"</span>, color);
            }
            <span class="keyword">if</span> (! avatar) {
              avatar = TowTruck.baseUrl + <span class="string">"/towtruck/images/default-avatar.png"</span>;
            }
            <span class="keyword">this</span>.update({
              name: name,
              avatar: avatar,
              defaultName: defaultName,
              color: color,
              fromLoad: <span class="literal">true</span>
            });
            peers._SelfLoaded.resolve();
          }).bind(<span class="keyword">this</span>)); <span class="comment">// FIXME: ignoring error</span>
      },

      _loadFromApp: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-104">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-104">&#182;</a>
                </div>
                <p>FIXME: I wonder if these should be optionally functions?
We could test typeof==function to distinguish between a getter and a concrete value</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> getUserName = TowTruck.getConfig(<span class="string">"getUserName"</span>);
        <span class="keyword">var</span> getUserColor = TowTruck.getConfig(<span class="string">"getUserColor"</span>);
        <span class="keyword">var</span> getUserAvatar = TowTruck.getConfig(<span class="string">"getUserAvatar"</span>);
        <span class="keyword">var</span> name, color, avatar;
        <span class="keyword">if</span> (getUserName) {
          name = getUserName();
          <span class="keyword">if</span> (name &amp;&amp; <span class="keyword">typeof</span> name != <span class="string">"string"</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-105">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-105">&#182;</a>
                </div>
                <p>FIXME: test for HTML safe?  Not that we require it, but
&lt;&gt;&#39;s are probably a sign something is wrong.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>            console.warn(<span class="string">"Error in getUserName(): should return a string (got"</span>, name, <span class="string">")"</span>);
            name = <span class="literal">null</span>;
          }
        }
        <span class="keyword">if</span> (getUserColor) {
          color = getUserColor();
          <span class="keyword">if</span> (color &amp;&amp; <span class="keyword">typeof</span> color != <span class="string">"string"</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-106">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-106">&#182;</a>
                </div>
                <p>FIXME: would be nice to test for color-ness here.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>            console.warn(<span class="string">"Error in getUserColor(): should return a string (got"</span>, color, <span class="string">")"</span>);
            color = <span class="literal">null</span>;
          }
        }
        <span class="keyword">if</span> (getUserAvatar) {
          avatar = getUserAvatar();
          <span class="keyword">if</span> (avatar &amp;&amp; <span class="keyword">typeof</span> avatar != <span class="string">"string"</span>) {
            console.warn(<span class="string">"Error in getUserAvatar(): should return a string (got"</span>, avatar, <span class="string">")"</span>);
            avatar = <span class="literal">null</span>;
          }
        }
        <span class="keyword">if</span> (name || color || avatar) {
          <span class="keyword">this</span>.update({
            name: name,
            color: color,
            avatar: avatar
          });
        }
      }
    });

    peers.Self.view = ui.PeerView(peers.Self);
    storage.tab.get(<span class="string">"peerCache"</span>).then(deserialize);
    peers.Self._loadFromSettings().then(<span class="keyword">function</span>() {
        peers.Self._loadFromApp();
        peers.Self.view.update();
    });
  });

  session.on(<span class="string">"refresh-user-data"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">if</span> (peers.Self) {
      peers.Self._loadFromApp();
    }
  });

  peers._SelfLoaded = util.Deferred();

  <span class="function"><span class="keyword">function</span> <span class="title">serialize</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> peers = [];
    util.forEachAttr(Peer.peers, <span class="function"><span class="keyword">function</span> <span class="params">(peer)</span> {</span>
      peers.push(peer.serialize());
    });
    <span class="keyword">return</span> {
      peers: peers
    };
  }

  <span class="function"><span class="keyword">function</span> <span class="title">deserialize</span><span class="params">(obj)</span> {</span>
    <span class="keyword">if</span> (! obj) {
      <span class="keyword">return</span>;
    }
    obj.peers.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(peer)</span> {</span>
      Peer.deserialize(peer);
    });
  }

  peers.getPeer = <span class="function"><span class="keyword">function</span> <span class="title">getPeer</span><span class="params">(id, message)</span> {</span>
    assert(id);
    <span class="keyword">var</span> peer = Peer.peers[id];
    <span class="keyword">if</span> (id === session.clientId) {
      <span class="keyword">return</span> peers.Self;
    }
    <span class="keyword">if</span> (message &amp;&amp; ! peer) {
      peer = Peer(id, {fromHelloMessage: message});
      <span class="keyword">return</span> peer;
    }
    assert(peer, <span class="string">"No peer with id:"</span>, id);
    <span class="keyword">if</span> (message &amp;&amp;
        (message.type == <span class="string">"hello"</span> || message.type == <span class="string">"hello-back"</span> ||
         message.type == <span class="string">"peer-update"</span>)) {
      peer.updateFromHello(message);
      peer.view.update();
    }
    <span class="keyword">return</span> Peer.peers[id];
  };

  peers.getAllPeers = <span class="function"><span class="keyword">function</span> <span class="params">(liveOnly)</span> {</span>
    <span class="keyword">var</span> result = [];
    util.forEachAttr(Peer.peers, <span class="function"><span class="keyword">function</span> <span class="params">(peer)</span> {</span>
      <span class="keyword">if</span> (liveOnly &amp;&amp; peer.status != <span class="string">"live"</span>) {
        <span class="keyword">return</span>;
      }
      result.push(peer);
    });
    <span class="keyword">return</span> result;
  };

  <span class="function"><span class="keyword">function</span> <span class="title">checkActivity</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> ps = peers.getAllPeers();
    <span class="keyword">var</span> now = Date.now();
    ps.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(p)</span> {</span>
      <span class="keyword">if</span> (p.idle == <span class="string">"active"</span> &amp;&amp; now - p.lastMessageDate &gt; IDLE_TIME) {
        p.update({idle: <span class="string">"inactive"</span>});
      }
      <span class="keyword">if</span> (p.status != <span class="string">"bye"</span> &amp;&amp; now - p.lastMessageDate &gt; BYE_TIME) {
        p.bye();
      }
    });
  }

  session.hub.on(<span class="string">"bye"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    <span class="keyword">var</span> peer = peers.getPeer(msg.clientId);
    peer.bye();
  });

  <span class="keyword">var</span> checkActivityTask = <span class="literal">null</span>;

  session.on(<span class="string">"start"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">if</span> (checkActivityTask) {
      console.warn(<span class="string">"Old peers checkActivityTask left over?"</span>);
      clearTimeout(checkActivityTask);
    }
    checkActivityTask = setInterval(checkActivity, CHECK_ACTIVITY_INTERVAL);
  });

  session.on(<span class="string">"close"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    util.forEachAttr(Peer.peers, <span class="function"><span class="keyword">function</span> <span class="params">(peer)</span> {</span>
      peer.destroy();
    });
    storage.tab.set(<span class="string">"peerCache"</span>, <span class="literal">undefined</span>);
    clearTimeout(checkActivityTask);
    checkActivityTask = <span class="literal">null</span>;
  });

  session.on(<span class="string">"visibility-change"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(hidden)</span> {</span>
    <span class="keyword">if</span> (hidden) {
      peers.Self.update({idle: <span class="string">"inactive"</span>});
    } <span class="keyword">else</span> {
      peers.Self.update({idle: <span class="string">"active"</span>});
    }
  });

  session.hub.on(<span class="string">"idle-status"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    msg.peer.update({idle: msg.idle});
  });</pre></div></div>
              
            </li>
          
            <li id="section-107">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-107">&#182;</a>
                </div>
                <p>Pings are a straight alive check, and contain no more information:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  session.hub.on(<span class="string">"ping"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    session.send({type: <span class="string">"ping-back"</span>});
  });

  window.addEventListener(<span class="string">"pagehide"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-108">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-108">&#182;</a>
                </div>
                <p>FIXME: not certain if this should be tab local or not:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    storeSerialization();
  }, <span class="literal">false</span>);

  <span class="function"><span class="keyword">function</span> <span class="title">storeSerialization</span><span class="params">()</span> {</span>
    storage.tab.set(<span class="string">"peerCache"</span>, serialize());
  }

  util.mixinEvents(peers);

  util.testExpose({
    setIdleTime: <span class="function"><span class="keyword">function</span> <span class="params">(time)</span> {</span>
      IDLE_TIME = time;
      CHECK_ACTIVITY_INTERVAL = time / <span class="number">2</span>;
      <span class="keyword">if</span> (TowTruck.running) {
        clearTimeout(checkActivityTask);
        checkActivityTask = setInterval(checkActivity, CHECK_ACTIVITY_INTERVAL);
      }
    }
  });

  util.testExpose({
    setByeTime: <span class="function"><span class="keyword">function</span> <span class="params">(time)</span> {</span>
      BYE_TIME = time;
      CHECK_ACTIVITY_INTERVAL = Math.min(CHECK_ACTIVITY_INTERVAL, time / <span class="number">2</span>);
      <span class="keyword">if</span> (TowTruck.running) {
        clearTimeout(checkActivityTask);
        checkActivityTask = setInterval(checkActivity, CHECK_ACTIVITY_INTERVAL);
      }
    }
  });

  <span class="keyword">return</span> peers;
});

<span class="comment">/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>

define(<span class="string">'templates'</span>,[<span class="string">"util"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(util)</span> {</span>
  <span class="function"><span class="keyword">function</span> <span class="title">clean</span><span class="params">(t)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-109">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-109">&#182;</a>
                </div>
                <p>Removes &lt;% /<em> ... </em>/ %&gt; comments:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    t = t.replace(<span class="regexp">/[&lt;][%]\s*\/\*[\S\s\r\n]*\*\/\s*[%][&gt;]/</span>, <span class="string">""</span>);
    t = util.trim(t);
    t = t.replace(<span class="regexp">/http:\/\/localhost:8080/g</span>, TowTruck.baseUrl);
    <span class="keyword">return</span> t;
  }
  <span class="keyword">return</span> {
    <span class="string">"interface"</span>: clean(<span class="string">"&lt;div id=\"towtruck-container\" class=\"towtruck\"&gt;\n\n  &lt;!-- This is the main set of buttons: --&gt;\n  &lt;div id=\"towtruck-dock\" class=\"towtruck-dock-right\"&gt;\n    &lt;div id=\"towtruck-dock-anchor\" title=\"Move the dock\"&gt;\n      &lt;span id=\"towtruck-dock-anchor-horizontal\"&gt;\n        &lt;img src=\"http://localhost:8080/towtruck/images/icn-handle-circle@2x.png\" alt=\"drag\"&gt;\n      &lt;/span&gt;\n      &lt;span id=\"towtruck-dock-anchor-vertical\"&gt;\n        &lt;img src=\"http://localhost:8080/towtruck/images/icn-handle-circle@2x.png\" alt=\"drag\"&gt;\n      &lt;/span&gt;\n    &lt;/div&gt;\n    &lt;div id=\"towtruck-buttons\"&gt;\n      &lt;div style=\"display: none\"&gt;\n        &lt;button id=\"towtruck-template-dock-person\" class=\"towtruck-button towtruck-dock-person\"&gt;\n          &lt;div class=\"towtruck-tooltip towtruck-dock-person-tooltip\"&gt;\n            &lt;span class=\"towtruck-person-name\"&gt;&lt;/span&gt;\n            &lt;span class=\"towtruck-person-tooltip-arrow-r\"&gt;&lt;/span&gt;\n          &lt;/div&gt;\n          &lt;div class=\"towtruck-person towtruck-person-status-overlay\"&gt;&lt;/div&gt;\n        &lt;/button&gt;\n      &lt;/div&gt;\n      &lt;button id=\"towtruck-profile-button\" class=\"towtruck-button\" title=\"This is you\"&gt;\n        &lt;div class=\"towtruck-person towtruck-person-self\"&gt;&lt;/div&gt;\n        &lt;div id=\"towtruck-profile-arrow\"&gt;&lt;/div&gt;\n      &lt;/button&gt;\n      &lt;button id=\"towtruck-share-button\" class=\"towtruck-button\" title=\"Add a friend\"&gt;&lt;/button&gt;\n      &lt;button id=\"towtruck-audio-button\" class=\"towtruck-button\" title=\"Turn on microphone\"&gt;\n        &lt;span id=\"towtruck-audio-unavailable\" class=\"towtruck-audio-set\" data-toggles=\".towtruck-audio-set\"&gt;\n        &lt;/span&gt;\n        &lt;span id=\"towtruck-audio-ready\" class=\"towtruck-audio-set\" data-toggles=\".towtruck-audio-set\" style=\"display: none\"&gt;\n        &lt;/span&gt;\n        &lt;span id=\"towtruck-audio-outgoing\" class=\"towtruck-audio-set\" data-toggles=\".towtruck-audio-set\" style=\"display: none\"&gt;\n        &lt;/span&gt;\n        &lt;span id=\"towtruck-audio-incoming\" class=\"towtruck-audio-set\" data-toggles=\".towtruck-audio-set\" style=\"display: none\"&gt;\n        &lt;/span&gt;\n        &lt;span id=\"towtruck-audio-active\" class=\"towtruck-audio-set\" data-toggles=\".towtruck-audio-set\" style=\"display: none\"&gt;\n        &lt;/span&gt;\n        &lt;span id=\"towtruck-audio-muted\" class=\"towtruck-audio-set\" data-toggles=\".towtruck-audio-set\" style=\"display: none\"&gt;\n        &lt;/span&gt;\n        &lt;span id=\"towtruck-audio-error\" class=\"towtruck-audio-set\" data-toggles=\".towtruck-audio-set\" style=\"display: none\"&gt;\n        &lt;/span&gt;\n      &lt;/button&gt;\n      &lt;button id=\"towtruck-chat-button\" class=\"towtruck-button\" title=\"Chat\"&gt;&lt;/button&gt;\n      &lt;div id=\"towtruck-dock-participants\"&gt;&lt;/div&gt;\n    &lt;/div&gt;\n  &lt;/div&gt;\n\n  &lt;!-- The window for editing the avatar: --&gt;\n  &lt;div id=\"towtruck-avatar-edit\" class=\"towtruck-modal\"\n       style=\"display: none\"&gt;\n    &lt;header&gt; Update avatar &lt;/header&gt;\n    &lt;section&gt;\n      &lt;div class=\"towtruck-avatar-preview towtruck-person towtruck-person-self\"&gt;&lt;/div&gt;\n      &lt;div id=\"towtruck-avatar-buttons\"&gt;\n        &lt;input type=\"file\" class=\"towtruck-upload-avatar\"&gt;\n        &lt;!--&lt;button id=\"towtruck-upload-avatar\" class=\"towtruck-primary\"&gt;Upload a picture&lt;/button&gt;--&gt;\n        &lt;!--&lt;button id=\"towtruck-camera-avatar\" class=\"towtruck-default\"&gt;Take a picture&lt;/button&gt;--&gt;\n      &lt;/div&gt;\n    &lt;/section&gt;\n    &lt;section class=\"towtruck-buttons\"&gt;\n      &lt;button class=\"towtruck-cancel towtruck-dismiss\"&gt;Cancel&lt;/button&gt;\n      &lt;span class=\"towtruck-alt-text\"&gt;or&lt;/span&gt;\n      &lt;button class=\"towtruck-avatar-save towtruck-primary\"&gt;Save&lt;/button&gt;\n    &lt;/section&gt;\n  &lt;/div&gt;\n\n  &lt;!-- The window for sharing the link: --&gt;\n  &lt;div id=\"towtruck-share\" class=\"towtruck-window\"\n       data-bind-to=\"#towtruck-share-button\" style=\"display: none\"&gt;\n    &lt;header&gt; Invite a friend &lt;/header&gt;\n    &lt;section&gt;\n      &lt;div class=\"towtruck-not-mobile\"&gt;\n        &lt;p&gt;Copy and paste this link over IM or email:&lt;/p&gt;\n        &lt;input type=\"text\" class=\"towtruck-share-link\"&gt;\n      &lt;/div&gt;\n      &lt;div class=\"towtruck-only-mobile\"&gt;\n        &lt;p&gt;Copy and paste this link over IM or email:&lt;/p&gt;\n        &lt;a class=\"towtruck-share-link\" href=\"#\"&gt;this link&lt;/a&gt;\n      &lt;/div&gt;\n    &lt;/section&gt;\n  &lt;/div&gt;\n\n  &lt;!-- Participant detail template: --&gt;\n  &lt;div id=\"towtruck-template-participant-window\" class=\"towtruck-window\" style=\"display: none\"&gt;\n    &lt;header&gt;&lt;div class=\"towtruck-person towtruck-person-small\"&gt;&lt;/div&gt;&lt;span class=\"towtruck-person-name\"&gt;&lt;/span&gt;&lt;/header&gt;\n\n    &lt;section class=\"towtruck-participant-window-main\"&gt;\n      &lt;p class=\"towtruck-participant-window-row\"&gt;&lt;strong&gt;Role:&lt;/strong&gt;\n        &lt;span class=\"towtruck-person-role\"&gt;&lt;/span&gt;\n      &lt;/p&gt;\n\n      &lt;p class=\"towtruck-participant-window-row\"&gt;&lt;strong&gt;Currently at:&lt;/strong&gt;\n        &lt;a class=\"towtruck-person-url towtruck-person-url-title\"&gt;&lt;/a&gt;\n      &lt;/p&gt;\n\n      &lt;p class=\"towtruck-participant-window-row\"&gt;&lt;strong&gt;Status:&lt;/strong&gt;\n        &lt;span class=\"towtruck-person-status\"&gt;&lt;/span&gt;\n      &lt;/p&gt;\n      \n      &lt;p class=\"towtruck-participant-window-row\"&gt;&lt;strong class=\"towtruck-float-left\"&gt;Follow this participant:&lt;/strong&gt;\n        &lt;label class=\"towtruck-follow-question towtruck-float-left\" for=\"towtruck-person-status-follow\"&gt;\n          &lt;input type=\"checkbox\" id=\"towtruck-person-status-follow\"&gt;\n        &lt;/label&gt;\n        &lt;span class=\"towtruck-clear\"&gt;&lt;/span&gt;\n      &lt;/p&gt;\n\n    &lt;/section&gt;\n\n    &lt;section class=\"towtruck-buttons\"&gt;\n      &lt;!-- Displayed when the peer is at a different URL: --&gt;\n      &lt;div class=\"towtruck-different-url\"&gt;\n        &lt;button class=\"towtruck-nudge towtruck-default\"&gt;Nudge them&lt;/button&gt;\n        &lt;a href=\"#\" class=\"towtruck-follow towtruck-person-url towtruck-primary\"&gt;Join them&lt;/a&gt;\n      &lt;/div&gt;\n      &lt;!-- Displayed when the peer is at your same URL: --&gt;\n      &lt;div class=\"towtruck-same-url\" style=\"display: none\"&gt;\n        &lt;span class=\"towtruck-person-name\"&gt;&lt;/span&gt; is on the same page as you.\n      &lt;/div&gt;\n    &lt;/section&gt;\n  &lt;/div&gt;\n\n  &lt;!-- The chat screen: --&gt;\n  &lt;div id=\"towtruck-chat\" class=\"towtruck-window\" data-bind-to=\"#towtruck-chat-button\"\n       style=\"display: none\"&gt;\n    &lt;header&gt; Chat &lt;/header&gt;\n    &lt;section class=\"towtruck-subtitle\"&gt;\n      &lt;div id=\"towtruck-chat-participants\" data-toggles=\"#towtruck-chat-no-participants\" style=\"display: none\"&gt;\n        &lt;span id=\"towtruck-chat-participant-list\"&gt;&lt;/span&gt;\n        &amp;amp; You\n      &lt;/div&gt;\n      &lt;div id=\"towtruck-chat-no-participants\" data-toggles=\"#towtruck-chat-participants\"&gt;\n        No one else is here.\n      &lt;/div&gt;\n    &lt;/section&gt;\n\n    &lt;div style=\"display: none\"&gt;\n\n      &lt;!-- Template for one message: --&gt;\n      &lt;div id=\"towtruck-template-chat-message\" class=\"towtruck-chat-item towtruck-chat-message\"&gt;\n        &lt;div class=\"towtruck-person\"&gt;&lt;/div&gt;\n        &lt;div class=\"towtruck-timestamp\"&gt;&lt;span class=\"towtruck-time\"&gt;HH:MM&lt;/span&gt; &lt;span class=\"towtruck-ampm\"&gt;AM/PM&lt;/span&gt;&lt;/div&gt;\n        &lt;div class=\"towtruck-person-name-abbrev\"&gt;&lt;/div&gt;\n        &lt;div class=\"towtruck-chat-content towtruck-sub-content\"&gt;&lt;/div&gt;\n      &lt;/div&gt;\n\n      &lt;!-- Template for when a person leaves: --&gt;\n      &lt;div id=\"towtruck-template-chat-left\" class=\"towtruck-chat-item towtruck-chat-left-item\"&gt;\n        &lt;div class=\"towtruck-person\"&gt;&lt;/div&gt;\n        &lt;div class=\"towtruck-ifnot-declinedJoin\"&gt;\n          &lt;div class=\"towtruck-inline-text\"&gt;&lt;span class=\"towtruck-person-name\"&gt;&lt;/span&gt; left the session.&lt;/div&gt;\n        &lt;/div&gt;\n        &lt;div class=\"towtruck-if-declinedJoin\"&gt;\n          &lt;div class=\"towtruck-inline-text\"&gt;&lt;span class=\"towtruck-person-name\"&gt;&lt;/span&gt; declined to join the session.&lt;/div&gt;\n        &lt;/div&gt;\n        &lt;div class=\"towtruck-clear\"&gt;&lt;/div&gt;\n      &lt;/div&gt;\n\n      &lt;!-- Template when a person joins the session: --&gt;\n      &lt;div id=\"towtruck-template-chat-joined\" class=\"towtruck-chat-item towtruck-chat-join-item\"&gt;\n        &lt;div class=\"towtruck-person\"&gt;&lt;/div&gt;\n        &lt;div class=\"towtruck-inline-text\"&gt;&lt;span class=\"towtruck-person-name\"&gt;&lt;/span&gt; joined the session.&lt;/div&gt;\n        &lt;div class=\"towtruck-clear\"&gt;&lt;/div&gt;\n      &lt;/div&gt;\n\n      &lt;!-- Template for system-derived messages: --&gt;\n      &lt;div id=\"towtruck-template-chat-system\" class=\"towtruck-chat-item\"&gt;\n        &lt;span class=\"towtruck-chat-content towtruck-sub-content\"&gt;&lt;/span&gt;\n      &lt;/div&gt;\n\n      &lt;!-- Template when a person joins the session: --&gt;\n      &lt;!-- &lt;div id=\"towtruck-template-chat-joined\" class=\"towtruck-chat-item towtruck-chat-join-item\"&gt;\n        &lt;div class=\"towtruck-person\"&gt;&lt;/div&gt;\n        &lt;div class=\"towtruck-inline-text\"&gt;&lt;span class=\"towtruck-person-name\"&gt;&lt;/span&gt; joined the session.&lt;/div&gt;\n        &lt;div class=\"towtruck-clear\"&gt;&lt;/div&gt;\n      &lt;/div&gt; --&gt;\n\n      &lt;!-- Template for when someone goes to a new URL: --&gt;\n      &lt;div id=\"towtruck-template-url-change\" class=\"towtruck-chat-item towtruck-chat-url-change\"&gt;\n        &lt;div class=\"towtruck-person\"&gt;&lt;/div&gt;\n        &lt;div class=\"towtruck-inline-text\"&gt;\n          &lt;div class=\"towtruck-if-sameUrl\"&gt;\n            &lt;span class=\"towtruck-person-name\"&gt;&lt;/span&gt;\n            is on the same page as you.\n          &lt;/div&gt;\n          &lt;div class=\"towtruck-ifnot-sameUrl\"&gt;\n            &lt;span class=\"towtruck-person-name\"&gt;&lt;/span&gt;\n            has gone to: &lt;a href=\"#\" class=\"towtruck-person-url towtruck-person-url-title\" target=\"_self\"&gt;&lt;/a&gt;\n            &lt;section class=\"towtruck-buttons towtruck-buttons-notification-diff-url\"&gt;\n              &lt;!-- Displayed when the peer is at a different URL: --&gt;\n              &lt;div class=\"towtruck-different-url towtruck-notification-diff-url\"&gt;\n                &lt;button class=\"towtruck-nudge towtruck-default\"&gt;Nudge them&lt;/button&gt;\n                &lt;a href=\"#\" class=\"towtruck-follow towtruck-person-url towtruck-primary\"&gt;Join them&lt;/a&gt;\n              &lt;/div&gt;\n            &lt;/section&gt;\n\n            &lt;!-- &lt;div&gt;\n              &lt;a class=\"towtruck-nudge towtruck-secondary\"&gt;Nudge them&lt;/a&gt;\n              &lt;a href=\"\" class=\"towtruck-person-url towtruck-follow towtruck-primary\"&gt;Join them&lt;/a&gt;\n            &lt;/div&gt; --&gt;\n\n          &lt;/div&gt;\n        &lt;/div&gt;\n        &lt;div class=\"towtruck-clear\"&gt;&lt;/div&gt;\n      &lt;/div&gt;\n    &lt;/div&gt;\n\n    &lt;section id=\"towtruck-chat-messages\"&gt;\n      &lt;!-- FIX ME// need to have some dialogue that says something like - There are no chats yet! --&gt;\n    &lt;/section&gt;\n    &lt;section id=\"towtruck-chat-input-box\"&gt;\n      &lt;input type=\"text\" id=\"towtruck-chat-input\" placeholder=\"Type your message here\"&gt;\n    &lt;/section&gt;\n  &lt;/div&gt;\n\n  &lt;!-- this is a kind of warning popped up when you (successfully) start RTC: --&gt;\n  &lt;div id=\"towtruck-rtc-info\" class=\"towtruck-window\"\n       data-bind-to=\"#towtruck-audio-button\"\n       style=\"display: none\"&gt;\n\n    &lt;header&gt; Audio Chat &lt;/header&gt;\n    &lt;section&gt;\n      &lt;p&gt;\n        Activate your &lt;strong&gt;browser microphone&lt;/strong&gt; near your URL bar above.\n      &lt;/p&gt;\n      &lt;p&gt;\n        Talking on your microphone through your web browser is an experimental feature.\n      &lt;/p&gt;\n      &lt;p&gt;\n        Read more about Audio Chat &lt;a href=\"https://github.com/mozilla/towtruck/wiki/About-Audio-Chat-and-WebRTC\" target=\"_blank\"&gt;here&lt;/a&gt;.\n      &lt;/p&gt;\n    &lt;/section&gt;\n\n    &lt;section class=\"towtruck-buttons\"&gt;\n      &lt;label for=\"towtruck-rtc-info-dismiss\" style=\"display: inline;\"&gt;\n        &lt;input class=\"towtruck-dont-show-again\" id=\"towtruck-rtc-info-dismiss\" type=\"checkbox\"&gt;\n        Don't show again.\n      &lt;/label&gt;\n      &lt;button class=\"towtruck-default towtruck-dismiss\" type=\"button\"&gt;Close&lt;/button&gt;\n    &lt;/section&gt;\n  &lt;/div&gt;\n\n  &lt;!-- this is popped up when you hit the audio button, but RTC isn't\n  supported: --&gt;\n  &lt;div id=\"towtruck-rtc-not-supported\" class=\"towtruck-window\"\n       data-bind-to=\"#towtruck-audio-button\"\n       style=\"display: none\"&gt;\n    &lt;header&gt; Audio Chat &lt;/header&gt;\n\n    &lt;section&gt;\n      &lt;p&gt;Audio chat requires you to use a &lt;a href=\"https://github.com/mozilla/towtruck/wiki/About-Audio-Chat-and-WebRTC\" target=\"_blank\"&gt;\n        newer browser\n      &lt;/a&gt;!&lt;/p&gt;\n      &lt;p&gt;\n        Live audio chat requires a newer (or different) browser than you're using.\n      &lt;/p&gt;\n      &lt;p&gt;\n        See\n        &lt;a href=\"https://github.com/mozilla/towtruck/wiki/About-Audio-Chat-and-WebRTC\" target=\"_blank\"&gt;\n          this page\n        &lt;/a&gt;\n        for more information and a list of supported browsers.\n      &lt;/p&gt;\n    &lt;/section&gt;\n\n    &lt;section class=\"towtruck-buttons\"&gt;\n      &lt;div class=\"towtruck-rtc-dialog-btn\"&gt;\n        &lt;button class=\"towtruck-default towtruck-dismiss\" type=\"button\"&gt;Close&lt;/button&gt;\n      &lt;/div&gt;\n    &lt;/section&gt;\n  &lt;/div&gt;\n\n  &lt;!-- The popup when a chat message comes in and the #towtruck-chat window isn't open --&gt;\n  &lt;div id=\"towtruck-chat-notifier\" class=\"towtruck-notification\"\n       data-bind-to=\"#towtruck-chat-button\"\n       style=\"display: none\"&gt;\n    &lt;img src=\"http://localhost:8080/towtruck/images/notification-towtruck-logo.png\" class=\"towtruck-notification-logo\" alt=\"\"&gt;\n    &lt;img src=\"http://localhost:8080/towtruck/images/notification-btn-close.png\" class=\"towtruck-notification-closebtn towtruck-dismiss\" alt=\"[close]\"&gt;\n    &lt;section id=\"towtruck-chat-notifier-message\"&gt;\n    &lt;/section&gt;\n  &lt;/div&gt;\n\n  &lt;!-- The menu when you click on the profile: --&gt;\n  &lt;div id=\"towtruck-menu\" class=\"towtruck-menu\" style=\"display: none\"&gt;\n    &lt;div class=\"towtruck-menu-item towtruck-menu-disabled\" id=\"towtruck-menu-profile\"&gt;\n      &lt;img id=\"towtruck-menu-avatar\"&gt;\n      &lt;span class=\"towtruck-person-name-self\" id=\"towtruck-self-name-display\" data-toggles=\"#towtruck-menu .towtruck-self-name\"&gt;&lt;/span&gt;\n      &lt;input class=\"towtruck-self-name\" type=\"text\" data-toggles=\"#towtruck-self-name-display\" style=\"display: none\" placeholder=\"Enter your name\"&gt;\n    &lt;/div&gt;\n    &lt;div class=\"towtruck-menu-hr-avatar\"&gt;&lt;/div&gt;\n    &lt;div class=\"towtruck-menu-item\" id=\"towtruck-menu-update-name\"&gt;&lt;img src=\"http://localhost:8080/towtruck/images/button-pencil.png\" alt=\"\"&gt; Update your name&lt;/div&gt;\n    &lt;div class=\"towtruck-menu-item\" id=\"towtruck-menu-update-avatar\"&gt;&lt;img src=\"http://localhost:8080/towtruck/images/btn-menu-change-avatar.png\" alt=\"\"&gt; Change avatar&lt;/div&gt;\n    &lt;div class=\"towtruck-menu-item\" id=\"towtruck-menu-update-color\"&gt;&lt;span class=\"towtruck-person-bgcolor-self\"&gt;&lt;/span&gt; Pick profile color&lt;/div&gt;\n    &lt;div class=\"towtruck-hr\"&gt;&lt;/div&gt;\n    &lt;div class=\"towtruck-menu-item\" id=\"towtruck-menu-help\"&gt;Help&lt;/div&gt;\n    &lt;div class=\"towtruck-menu-item\" id=\"towtruck-menu-feedback\"&gt;Feedback&lt;/div&gt;\n    &lt;div class=\"towtruck-hr\"&gt;&lt;/div&gt;\n    &lt;div class=\"towtruck-menu-item\" id=\"towtruck-menu-end\"&gt;&lt;img src=\"http://localhost:8080/towtruck/images/button-end-session.png\" alt=\"\"&gt; End &lt;span class=\"towtruck-tool-name\"&gt;TogetherJS&lt;/span&gt;&lt;/div&gt;\n  &lt;/div&gt;\n\n  &lt;!-- A window version of #towtruck-menu, for use on mobile --&gt;\n  &lt;div id=\"towtruck-menu-window\" class=\"towtruck-window\" style=\"display: none\"&gt;\n    &lt;header&gt;Settings and Profile&lt;/header&gt;\n    &lt;section&gt;\n    &lt;div class=\"towtruck-menu-item\"&gt;\n      &lt;img class=\"towtruck-menu-avatar\"&gt;\n      &lt;span class=\"towtruck-person-name-self\" id=\"towtruck-self-name-display\"&gt;&lt;/span&gt;\n    &lt;/div&gt;\n    &lt;div class=\"towtruck-menu-hr-avatar\"&gt;&lt;/div&gt;\n    &lt;div class=\"towtruck-menu-item\" id=\"towtruck-menu-update-name-button\"&gt;&lt;img src=\"http://localhost:8080/towtruck/images/button-pencil.png\" alt=\"\"&gt; Update your name&lt;/div&gt;\n    &lt;div class=\"towtruck-menu-item\" id=\"towtruck-menu-update-avatar-button\"&gt;&lt;img src=\"http://localhost:8080/towtruck/images/btn-menu-change-avatar.png\" alt=\"\"&gt; Change avatar&lt;/div&gt;\n    &lt;div class=\"towtruck-menu-item\" id=\"towtruck-menu-update-color-button\"&gt;&lt;span class=\"towtruck-person-bgcolor-self\"&gt;&lt;/span&gt; Pick profile color&lt;/div&gt;\n    &lt;div class=\"towtruck-hr\"&gt;&lt;/div&gt;\n    &lt;div class=\"towtruck-menu-item\" id=\"towtruck-menu-help-button\"&gt;Help&lt;/div&gt;\n    &lt;div class=\"towtruck-menu-item\" id=\"towtruck-menu-feedback-button\"&gt;Feedback&lt;/div&gt;\n    &lt;div class=\"towtruck-hr\"&gt;&lt;/div&gt;\n    &lt;div class=\"towtruck-menu-item\" id=\"towtruck-menu-end-button\"&gt;&lt;img src=\"http://localhost:8080/towtruck/images/button-end-session.png\" alt=\"\"&gt; End &lt;span class=\"towtruck-tool-name\"&gt;TogetherJS&lt;/span&gt;&lt;/div&gt;\n    &lt;/section&gt;\n    &lt;section class=\"towtruck-buttons\"&gt;\n      &lt;button class=\"towtruck-dismiss towtruck-primary\"&gt;OK&lt;/button&gt;\n    &lt;/section&gt;\n  &lt;/div&gt;\n\n  &lt;!-- The name editor, for use on mobile --&gt;\n  &lt;div id=\"towtruck-edit-name-window\" class=\"towtruck-window\" style=\"display: none\"&gt;\n    &lt;header&gt;Update Name&lt;/header&gt;\n    &lt;section&gt;\n      &lt;div&gt;\n        &lt;input class=\"towtruck-self-name\" type=\"text\" placeholder=\"Enter your name\"&gt;\n      &lt;/div&gt;\n    &lt;/section&gt;\n    &lt;section class=\"towtruck-buttons\"&gt;\n      &lt;button class=\"towtruck-dismiss towtruck-primary\"&gt;OK&lt;/button&gt;\n    &lt;/section&gt;\n  &lt;/div&gt;\n\n  &lt;div class=\"towtruck-menu\" id=\"towtruck-pick-color\" style=\"display: none\"&gt;\n    &lt;div class=\"towtruck-triangle-up\"&gt;&lt;img src=\"http://localhost:8080/towtruck/images/icn-triangle-up.png\"&gt;&lt;/div&gt;\n    &lt;div style=\"display: none\"&gt;\n      &lt;div id=\"towtruck-template-swatch\" class=\"towtruck-swatch\"&gt;\n      &lt;/div&gt;\n    &lt;/div&gt;\n  &lt;/div&gt;\n\n  &lt;!-- Invisible elements that handle the RTC audio: --&gt;\n  &lt;audio id=\"towtruck-audio-element\"&gt;&lt;/audio&gt;\n  &lt;audio id=\"towtruck-local-audio\" muted=\"true\"&gt;&lt;/audio&gt;\n\n  &lt;!-- The intro screen for someone who joins a session the first time: --&gt;\n  &lt;div id=\"towtruck-intro\" class=\"towtruck-modal\" style=\"display: none\"&gt;\n    &lt;header&gt;Join &lt;span class=\"towtruck-tool-name\"&gt;TowTruck&lt;/span&gt; session?&lt;/header&gt;\n    &lt;section&gt;\n      &lt;p&gt;Your friend has asked you to join their &lt;a href=\"https://towtruck.mozillalabs.com/\" target=\"_blank\"&gt;&lt;span class=\"towtruck-tool-name\"&gt;TogetherJS&lt;/span&gt;&lt;/a&gt; browser session to collaborate in real-time!&lt;/p&gt;\n\n      &lt;p&gt;Would you like to join their session?&lt;/p&gt;\n    &lt;/section&gt;\n\n    &lt;section class=\"towtruck-buttons\"&gt;\n      &lt;button class=\"towtruck-destructive towtruck-modal-dont-join\"&gt;No, don't join&lt;/button&gt;\n      &lt;button class=\"towtruck-primary towtruck-dismiss\"&gt;Yes, join session&lt;/button&gt;\n    &lt;/section&gt;\n  &lt;/div&gt;\n\n  &lt;!-- Shown when a web browser is completely incapable of running TowTruck: --&gt;\n  &lt;div id=\"towtruck-browser-broken\" class=\"towtruck-modal\" style=\"display: none\"&gt;\n    &lt;header&gt; Sorry &lt;/header&gt;\n\n    &lt;section&gt;\n      &lt;p&gt;\n        We're sorry, &lt;span class=\"towtruck-tool-name\"&gt;TogetherJS&lt;/span&gt; doesn't work with this browser.  Please\n        &lt;a href=\"https://github.com/mozilla/towtruck/wiki/Supported-Browsers#supported-browsers\"&gt;upgrade\n          to a supported browser&lt;/a&gt; to try &lt;span class=\"towtruck-tool-name\"&gt;TogetherJS&lt;/span&gt;.\n      &lt;/p&gt;\n\n      &lt;p id=\"towtruck-browser-broken-is-ie\" style=\"display: none\"&gt;\n        Internet\n        Explorer &lt;a href=\"https://github.com/mozilla/towtruck/wiki/Supported-Browsers#internet-explorer\"&gt;is\n          not supported&lt;/a&gt; and won't be supported in the near term,\n        please use Firefox or Chrome.\n      &lt;/p&gt;\n    &lt;/section&gt;\n\n    &lt;section class=\"towtruck-buttons\"&gt;\n      &lt;button class=\"towtruck-dismiss towtruck-primary\"&gt;End &lt;span class=\"towtruck-tool-name\"&gt;TogetherJS&lt;/span&gt;&lt;/button&gt;\n    &lt;/section&gt;\n\n  &lt;/div&gt;\n\n  &lt;!-- Shown when the browser has WebSockets, but is IE (i.e., IE10) --&gt;\n  &lt;div id=\"towtruck-browser-unsupported\" class=\"towtruck-modal\" style=\"display: none\"&gt;\n    &lt;header&gt; Unsupported Browser &lt;/header&gt;\n\n    &lt;section&gt;\n      &lt;p&gt;\n        We're sorry, Internet Explorer &lt;a href=\"https://github.com/mozilla/towtruck/wiki/Supported-Browsers#internet-explorer\"&gt;is not supported&lt;/a&gt;\n        at this time.  While we may add support later, adding support is\n        not currently on our roadmap.  Please use Firefox or Chrome.\n      &lt;/p&gt;\n\n      &lt;p&gt;You can continue to try to use &lt;span class=\"towtruck-tool-name\"&gt;TogetherJS&lt;/span&gt;, but you are likely to hit\n        lots of bugs.  So be warned.&lt;/p&gt;\n\n    &lt;/section&gt;\n\n    &lt;section class=\"towtruck-buttons\"&gt;\n      &lt;button class=\"towtruck-dismiss towtruck-primary\"&gt;End &lt;span class=\"towtruck-tool-name\"&gt;TogetherJS&lt;/span&gt;&lt;/button&gt;\n      &lt;button class=\"towtruck-dismiss towtruck-secondary towtruck-browser-unsupported-anyway\"&gt;Try &lt;span class=\"towtruck-tool-name\"&gt;TogetherJS&lt;/span&gt; Anyway&lt;/button&gt;\n    &lt;/section&gt;\n\n  &lt;/div&gt;\n\n  &lt;div id=\"towtruck-confirm-end\" class=\"towtruck-modal\" style=\"display: none\"&gt;\n    &lt;header&gt; End session? &lt;/header&gt;\n    &lt;section&gt;\n      &lt;p&gt;\n        Are you sure you'd like to end your &lt;span class=\"towtruck-tool-name\"&gt;TogetherJS&lt;/span&gt; session?\n      &lt;/p&gt;\n    &lt;/section&gt;\n    &lt;section class=\"towtruck-buttons\"&gt;\n      &lt;button class=\"towtruck-cancel towtruck-dismiss\"&gt;Cancel&lt;/button&gt;\n      &lt;span class=\"towtruck-alt-text\"&gt;or&lt;/span&gt;\n      &lt;button id=\"towtruck-end-session\" class=\"towtruck-destructive\"&gt;End session&lt;/button&gt;\n    &lt;/section&gt;\n  &lt;/div&gt;\n\n  &lt;div id=\"towtruck-feedback-form\" class=\"towtruck-modal\" style=\"display: none;\"&gt;\n    &lt;header&gt; Feedback &lt;/header&gt;\n    &lt;iframe src=\"https://docs.google.com/a/mozilla.com/forms/d/1lVE7JyRo_tjakN0mLG1Cd9X9vseBX9wci153z9JcNEs/viewform?embedded=true\" width=\"400\" height=\"300\" frameborder=\"0\" marginheight=\"0\" marginwidth=\"0\"&gt;Loading form...&lt;/iframe&gt;\n    &lt;!-- &lt;p&gt;&lt;button class=\"towtruck-modal-close\"&gt;Close&lt;/button&gt;&lt;/p&gt; --&gt;\n  &lt;/div&gt;\n\n  &lt;div style=\"display: none\"&gt;\n    &lt;!-- This is when you join a session and the other person has already changed to another URL: --&gt;\n    &lt;div id=\"towtruck-template-url-change\" class=\"towtruck-modal\"&gt;\n      &lt;header&gt; Following to new URL... &lt;/header&gt;\n      &lt;section&gt;\n        &lt;div class=\"towtruck-person\"&gt;&lt;/div&gt;\n        Following\n        &lt;span class=\"towtruck-person-name\"&gt;&lt;/span&gt;\n        to &lt;a href=\"\" class=\"towtruck-person-url towtruck-person-url-title\"&gt;&lt;/a&gt;\n      &lt;/section&gt;\n    &lt;/div&gt;\n  &lt;/div&gt;\n\n  &lt;!-- The pointer at the side of a window: --&gt;\n  &lt;div id=\"towtruck-window-pointer-right\" style=\"display: none\"&gt;&lt;/div&gt;\n  &lt;div id=\"towtruck-window-pointer-left\" style=\"display: none\"&gt;&lt;/div&gt;\n\n  &lt;!-- The element that overlaps the background of the page during a modal dialog: --&gt;\n  &lt;div id=\"towtruck-modal-background\" style=\"display: none\"&gt;&lt;/div&gt;\n\n  &lt;!-- Some miscellaneous templates --&gt;\n  &lt;div style=\"display: none\"&gt;\n\n    &lt;!-- This is the cursor: --&gt;\n    &lt;div id=\"towtruck-template-cursor\" class=\"towtruck-cursor towtruck\"&gt;\n      &lt;!-- Note: images/cursor.svg is a copy of this (for editing): --&gt;\n      &lt;!-- crossbrowser svg dropshadow http://demosthenes.info/blog/600/Creating-a-True-CrossBrowser-Drop-Shadow- --&gt;\n      &lt;svg version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" x=\"0px\" y=\"0px\"\n\t       width=\"15.147px\" height=\"19.653px\" viewBox=\"0 0 15.147 19.653\" enable-background=\"new 0 0 15.147 19.653\" xml:space=\"preserve\" &gt;\n        &lt;path fill-rule=\"evenodd\" clip-rule=\"evenodd\" fill=\"#9F1D20\" d=\"M7.85,19.653c0,0,4.886-1.31,6.603-1.769\n\tc-0.373-1.391,1.128-3.674,0.567-5.766c-0.56-2.091-1.167-4.353-1.167-4.353s-0.236-1.055-1.232-0.788S11.498,7.76,11.498,7.76\n\ts-0.427-1.152-1.461-1.266C9.003,6.379,8.555,7.201,8.555,7.201S8.451,5.987,7.146,6.337C5.474,6.785,6.374,9.52,6.374,9.52\n\tL3.571,2.176c0,0-0.92-2.421-1.613-2.156C1.254,0.289,1.414,1.853,1.639,2.694c0.318,1.186,2.904,9.915,2.904,9.915\n\ts-3.856-3.503-4.5-2.5c-0.393,0.688,2.023,4.821,3,5.501c0.978,0.679,3.021,1.998,4.016,3.02c0.995,1.023,0.902,0.97,0.902,0.97\"/&gt;\n      &lt;/svg&gt;\n      &lt;!-- &lt;img class=\"towtruck-cursor-img\" src=\"http://localhost:8080/towtruck/images/cursor.svg\"&gt; --&gt;\n      &lt;span class=\"towtruck-cursor-container\"&gt;\n        &lt;span class=\"towtruck-cursor-name\"&gt;&lt;/span&gt;\n        &lt;span style=\"display:none\" class=\"towtruck-cursor-typing\" id=\"towtruck-cursor-typebox\"&gt;\n          &lt;span class=\"towtruck-typing-ellipse-one\"&gt;&amp;#9679;&lt;/span&gt;&lt;span class=\"towtruck-typing-ellipse-two\"&gt;&amp;#9679;&lt;/span&gt;&lt;span class=\"towtruck-typing-ellipse-three\"&gt;&amp;#9679;&lt;/span&gt;\n        &lt;/span&gt;\n        &lt;!-- Displayed when the cursor is below the screen: --&gt;\n        &lt;span class=\"towtruck-cursor-down\"&gt;\n\n        &lt;/span&gt;\n        &lt;!-- Displayed when the cursor is above the screen: --&gt;\n        &lt;span class=\"towtruck-cursor-up\"&gt;\n\n        &lt;/span&gt;\n      &lt;/span&gt;\n    &lt;/div&gt;\n\n    &lt;!-- This is the element that goes around focused form elements: --&gt;\n    &lt;div id=\"towtruck-template-focus\"&gt;\n      &lt;div class=\"towtruck-focus towtruck-person-bordercolor\"&gt;&lt;/div&gt;\n    &lt;/div&gt;\n\n    &lt;!-- This is a click: --&gt;\n    &lt;div id=\"towtruck-template-click\" class=\"towtruck-click towtruck\"&gt;\n    &lt;/div&gt;\n  &lt;/div&gt;\n&lt;/div&gt;\n"</span>),
    help: clean(<span class="string">"&lt;% /*\n  This is used to show the help when you type /help.  Used in\n  TowTruck.localChatMessage().\n\n*/ %&gt;\n/help : this message\n/test : run an automated/randomized test (or stop one that is in progress)\n  /test start N : run N times (instead of default 100)\n  /test show : show what kind of actions the random test would take (or stop showing)\n  /test describe : describe the possible actions (instead of showing them)\n/clear : clear the chat area\n/record : open up a recorder for the session\n/playback URL : play back a session that was recorded (it's up to you to figure out how to host it)\n  /playback local:NAME : play a locally saved log\n/savelogs NAME : save the currently recorded logs under NAME (recorder must be open)\n/baseurl : set a local baseUrl to load TowTruck from, for debugging a development version of TowTruck.\n/config : override some TowTruck configuration parameters\n  /config VAR VALUE : set TowTruck.config(\"VAR\", VALUE).  VALUE must be a legal Javascript/JSON literal.\n  /config clear : remove all overridden configuration\n"</span>),
    walkthrough: clean(<span class="string">"&lt;!--\n    Any elements with .towtruck-walkthrough-firsttime will only be\n    displayed on during the first-time experience.  Any elements with\n    .towtruck-walkthrough-not-firsttime will only be displayed when\n    the walkthrough is accessed through the Help menu.\n\n    Note you *cannot* use &lt;section class=\"towtruck-walkthrough-slide\n    towtruck-walkthrough-firsttime\"&gt;: the number of sections must be the\n    same regardless.\n  --&gt;\n&lt;div id=\"towtruck-walkthrough\" class=\"towtruck-modal towtruck-modal-wide\"&gt;\n  &lt;header&gt;You're using &lt;span class=\"towtruck-tool-name\"&gt;TogetherJS&lt;/span&gt;!&lt;button class=\"towtruck-close\"&gt;&lt;/button&gt;&lt;/header&gt;\n\n  &lt;div id=\"towtruck-walkthrough-previous\"&gt;&lt;/div&gt;\n  &lt;div id=\"towtruck-walkthrough-next\"&gt;&lt;/div&gt;\n\n  &lt;section class=\"towtruck-walkthrough-slide\"&gt;\n    &lt;p class=\"towtruck-walkthrough-main-image\"&gt;&lt;img src=\"http://localhost:8080/towtruck/images/walkthrough-images-intro.png\"&gt;&lt;/p&gt;\n\t&lt;p&gt;&lt;span class=\"towtruck-tool-name\"&gt;TogetherJS&lt;/span&gt; is a service for your website that makes it easy to collaborate in real-time on: &lt;strong class=\"towtruck-site-name\"&gt;[site name]&lt;/strong&gt;&lt;/p&gt;\n  &lt;/section&gt;\n\n  &lt;section class=\"towtruck-walkthrough-slide\"&gt;\n    &lt;div class=\"towtruck-walkthrough-firsttime\"&gt;\n      &lt;div class=\"towtruck-walkthrough-main-image\"&gt;\n        &lt;div class=\"towtruck-walkthrough-avatar-section\"&gt;\n          &lt;div class=\"towtruck-avatar-preview towtruck-person towtruck-person-self\"&gt;&lt;/div&gt;\n          &lt;div class=\"towtruck-avatar-upload-input\"&gt;&lt;input type=\"file\" class=\"towtruck-upload-avatar\"&gt;&lt;/div&gt;\n        &lt;/div&gt;\n        &lt;input class=\"towtruck-self-name\" type=\"text\" placeholder=\"Enter your name\"&gt;\n        &lt;div class=\"towtruck-swatch towtruck-person-bgcolor-self\"&gt;&lt;/div&gt;\n        &lt;div class=\"towtruck-save-settings\"&gt;\n          &lt;button class=\"towtruck-avatar-save towtruck-primary\"&gt;\n            &lt;span id=\"towtruck-avatar-when-unsaved\"&gt;Save&lt;/span&gt;\n            &lt;span id=\"towtruck-avatar-when-saved\" style=\"display: none\"&gt;Saved!&lt;/span&gt;\n          &lt;/button&gt;\n        &lt;/div&gt;\n      &lt;/div&gt;\n      &lt;p&gt;Set up your avatar, name and user color above.  If you'd like to update it later, you can click your Profile button.&lt;/p&gt;\n    &lt;/div&gt;\n    &lt;div class=\"towtruck-walkthrough-not-firsttime\"&gt;\n      &lt;p class=\"towtruck-walkthrough-main-image\"&gt;&lt;img src=\"http://localhost:8080/towtruck/images/walkthrough-images-profile.png\"&gt;&lt;/p&gt;\n      &lt;p&gt;Change your avatar, name and user color using the Profile button.&lt;/p&gt;\n    &lt;/div&gt;\n  &lt;/section&gt;\n\n  &lt;section class=\"towtruck-walkthrough-slide\"&gt;\n    &lt;p class=\"towtruck-walkthrough-main-image towtruck-ifnot-creator\"&gt;&lt;img src=\"http://localhost:8080/towtruck/images/walkthrough-images-invite.png\"&gt;\n    &lt;/p&gt;\n    &lt;p class=\"towtruck-ifnot-creator\"&gt;You can invite more friends to the session by sending the invite link in the &lt;span class=\"towtruck-tool-name\"&gt;TowTruck&lt;/span&gt; dock.&lt;/p&gt;\n    &lt;p class=\"towtruck-walkthrough-main-image towtruck-if-creator\"&gt;\n      &lt;span class=\"towtruck-walkthrough-sendlink\"&gt;\n        Copy and paste this link into IM or email to invite friends.\n      &lt;/span&gt;\n      &lt;input type=\"text\" class=\"towtruck-share-link\"&gt;\n    &lt;/p&gt;\n    &lt;p class=\"towtruck-if-creator\"&gt;Send the above link to a friend so they can join your session!  You can find this invite link on the &lt;span class=\"towtruck-tool-name\"&gt;TowTruck&lt;/span&gt; dock as well.&lt;/p&gt;\n  &lt;/section&gt;\n\n  &lt;section class=\"towtruck-walkthrough-slide\"&gt;\n    &lt;p class=\"towtruck-walkthrough-main-image\"&gt;&lt;img src=\"http://localhost:8080/towtruck/images/walkthrough-images-participant.png\"&gt;&lt;/p&gt;\n    &lt;p&gt;Friends who join your &lt;span class=\"towtruck-tool-name\"&gt;TogetherJS&lt;/span&gt; session will appear here.  You can click their avatars to see more.&lt;/p&gt;\n  &lt;/section&gt;\n\n  &lt;section class=\"towtruck-walkthrough-slide\"&gt;\n    &lt;p class=\"towtruck-walkthrough-main-image\"&gt;&lt;img src=\"http://localhost:8080/towtruck/images/walkthrough-images-chat.png\"&gt;&lt;/p&gt;\n    &lt;p&gt;When your friends join you in your &lt;span class=\"towtruck-tool-name\"&gt;TogetherJS&lt;/span&gt; session, you can chat with them here!&lt;/p&gt;\n  &lt;/section&gt;\n\n  &lt;section class=\"towtruck-walkthrough-slide\"&gt;\n    &lt;p class=\"towtruck-walkthrough-main-image\"&gt;&lt;img src=\"http://localhost:8080/towtruck/images/walkthrough-images-rtc.png\"&gt;&lt;/p&gt;\n    &lt;p&gt;If your browser supports it, click the microphone icon to begin a audio chat. Learn more about this experimental feature &lt;a href=\"https://github.com/mozilla/towtruck/wiki/About-Audio-Chat-and-WebRTC\" target=\"_blank\"&gt;here&lt;/a&gt;.&lt;/p&gt;\n  &lt;/section&gt;\n\n  &lt;section class=\"towtruck-walkthrough-slide\"&gt;\n    &lt;p class=\"towtruck-walkthrough-main-image\"&gt;&lt;img src=\"http://localhost:8080/towtruck/images/walkthrough-images-logo.png\"&gt;&lt;/p&gt;\n    &lt;p&gt;Alright, you're ready to use &lt;span class=\"towtruck-tool-name\"&gt;TogetherJS&lt;/span&gt;. Now start collaborating on &lt;strong class=\"towtruck-site-name\"&gt;[site name]&lt;/strong&gt;!&lt;/p&gt;\n  &lt;/section&gt;\n\n  &lt;div style=\"display: none\"&gt;\n    &lt;!-- There is one of these created for each slide: --&gt;\n    &lt;span id=\"towtruck-template-walkthrough-slide-progress\" class=\"towtruck-walkthrough-slide-progress\"&gt;&amp;#9679;&lt;/span&gt;\n  &lt;/div&gt;\n  &lt;section id=\"towtruck-walkthrough-progress\"&gt;\n  &lt;/section&gt;\n\n  &lt;section class=\"towtruck-buttons\"&gt;\n    &lt;button class=\"towtruck-primary towtruck-dismiss\"&gt;I'm ready!&lt;/button&gt;\n  &lt;/section&gt;\n\n&lt;/div&gt;&lt;!-- /.towtruck-modal --&gt;\n"</span>)
  };
});

<span class="comment">/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
define(<span class="string">'windowing'</span>,[<span class="string">"jquery"</span>, <span class="string">"util"</span>, <span class="string">"peers"</span>, <span class="string">"session"</span>], <span class="function"><span class="keyword">function</span> <span class="params">($, util, peers, session)</span> {</span>
  <span class="keyword">var</span> assert = util.assert;
  <span class="keyword">var</span> windowing = util.Module(<span class="string">"windowing"</span>);
  <span class="keyword">var</span> $window = $(window);</pre></div></div>
              
            </li>
          
            <li id="section-110">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-110">&#182;</a>
                </div>
                <p>This is also in towtruck.less, under .towtruck-animated</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> ANIMATION_DURATION = <span class="number">1000</span>;

  <span class="comment">/* Displays one window.  A window must already exist.  This hides other windows, and
     positions the window according to its data-bound-to attributes */</span>
  windowing.show = <span class="function"><span class="keyword">function</span> <span class="params">(element, options)</span> {</span>
    element = $(element);
    options = options || {};
    options.bind = options.bind || element.attr(<span class="string">"data-bind-to"</span>);
    <span class="keyword">var</span> notification = element.hasClass(<span class="string">"towtruck-notification"</span>);
    <span class="keyword">var</span> modal = element.hasClass(<span class="string">"towtruck-modal"</span>);
    <span class="keyword">if</span> (options.bind) {
      options.bind = $(options.bind);
    }
    windowing.hide();
    element.stop();
    element.show();</pre></div></div>
              
            </li>
          
            <li id="section-111">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-111">&#182;</a>
                </div>
                <p>In addition to being hidden, the window can be faded out, which we want to undo:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    element.css({opacity: <span class="string">"1"</span>});
    <span class="keyword">if</span> (options.bind) {
      assert(! modal, <span class="string">"Binding does not currently work with modals"</span>);
      bind(element, options.bind);
    }
    <span class="keyword">if</span> (notification) {
      element.slideIn();
    } <span class="keyword">else</span> <span class="keyword">if</span> (! modal) {
      element.popinWindow();
    }
    <span class="keyword">if</span> (modal) {
      getModalBackground().show();
      modalEscape.bind();
    }
    onClose = options.onClose || <span class="literal">null</span>;
    session.emit(<span class="string">"display-window"</span>, element.attr(<span class="string">"id"</span>), element);
  };

  <span class="keyword">var</span> onClose = <span class="literal">null</span>;

  <span class="comment">/* Moves a window to be attached to data-bind-to, e.g., the button
     that opened the window. Or you can provide an element that it should bind to. */</span>
  <span class="function"><span class="keyword">function</span> <span class="title">bind</span><span class="params">(win, bound)</span> {</span>
    <span class="keyword">if</span> ($.browser.mobile) {
      <span class="keyword">return</span>;
    }
    win = $(win);
    assert(bound.length, <span class="string">"Cannot find binding:"</span>, bound.selector, <span class="string">"from:"</span>, win.selector);</pre></div></div>
              
            </li>
          
            <li id="section-112">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-112">&#182;</a>
                </div>
                <p>FIXME: hardcoding</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> ifacePos = <span class="string">"right"</span>;</pre></div></div>
              
            </li>
          
            <li id="section-113">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-113">&#182;</a>
                </div>
                <p>var ifacePos = panelPosition();</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> boundPos = bound.offset();
    boundPos.height = bound.height();
    boundPos.width = bound.width();
    <span class="keyword">var</span> windowHeight = $window.height();
    <span class="keyword">var</span> windowWidth = $window.width();
    boundPos.top -= $window.scrollTop();
    boundPos.left -= $window.scrollLeft();</pre></div></div>
              
            </li>
          
            <li id="section-114">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-114">&#182;</a>
                </div>
                <p>FIXME: I appear to have to add the padding to the width to get a &quot;true&quot;
width.  But it&#39;s still not entirely consistent.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> height = win.height() + <span class="number">5</span>;
    <span class="keyword">var</span> width = win.width() + <span class="number">20</span>;
    <span class="keyword">var</span> left, top;
    <span class="keyword">if</span> (ifacePos == <span class="string">"right"</span>) {
      left = boundPos.left - <span class="number">11</span> - width;
      top = boundPos.top + (boundPos.height / <span class="number">2</span>) - (height / <span class="number">2</span>);
    } <span class="keyword">else</span> <span class="keyword">if</span> (ifacePos == <span class="string">"left"</span>) {
      left = boundPos.left + boundPos.width + <span class="number">15</span>;
      top = boundPos.top + (boundPos.height / <span class="number">2</span>) - (height / <span class="number">2</span>);
    } <span class="keyword">else</span> <span class="keyword">if</span> (ifacePos == <span class="string">"bottom"</span>) {
      left = (boundPos.left + boundPos.width / <span class="number">2</span>) - (width / <span class="number">2</span>);
      top = boundPos.top - <span class="number">10</span> - height;
    }
    top = Math.min(windowHeight - <span class="number">10</span> - height, Math.max(<span class="number">10</span>, top));
    win.css({
      top: top + <span class="string">"px"</span>,
      left: left + <span class="string">"px"</span>
    });
    <span class="keyword">if</span> (win.hasClass(<span class="string">"towtruck-window"</span>)) {
      $(<span class="string">"#towtruck-window-pointer-right, #towtruck-window-pointer-left"</span>).hide();
      <span class="keyword">var</span> pointer = $(<span class="string">"#towtruck-window-pointer-"</span> + ifacePos);
      pointer.show();
      <span class="keyword">if</span> (ifacePos == <span class="string">"right"</span>) {
        pointer.css({
          top: boundPos.top + Math.floor(boundPos.height / <span class="number">2</span>) + <span class="string">"px"</span>,
          left: left + win.width() + <span class="number">9</span> + <span class="string">"px"</span>
        });
      } <span class="keyword">else</span> <span class="keyword">if</span> (ifacePos == <span class="string">"left"</span>) {
        pointer.css({
          top: boundPos.top + Math.floor(boundPos.height / <span class="number">2</span>) + <span class="string">"px"</span>,
          left: (left - <span class="number">5</span>) + <span class="string">"px"</span>
        });
      } <span class="keyword">else</span> {
        console.warn(<span class="string">"don't know how to deal with position:"</span>, ifacePos);
      }
    }
    win.data(<span class="string">"boundTo"</span>, bound.selector || <span class="string">"#"</span> + bound.attr(<span class="string">"id"</span>));
    bound.addClass(<span class="string">"towtruck-active"</span>);
  }

  session.on(<span class="string">"resize"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">var</span> win = $(<span class="string">".towtruck-modal:visible, .towtruck-window:visible"</span>);
    <span class="keyword">if</span> (! win.length) {
      <span class="keyword">return</span>;
    }
    <span class="keyword">var</span> boundTo = win.data(<span class="string">"boundTo"</span>);
    <span class="keyword">if</span> (! boundTo) {
      <span class="keyword">return</span>;
    }
    boundTo = $(boundTo);
    bind(win, boundTo);
  });

  windowing.hide = <span class="function"><span class="keyword">function</span> <span class="params">(els)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-115">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-115">&#182;</a>
                </div>
                <p>FIXME: also hide modals?</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    els = els || <span class="string">".towtruck-window, .towtruck-modal, .towtruck-notification"</span>;
    els = $(els);
    els = els.filter(<span class="string">":visible"</span>);
    els.filter(<span class="string">":not(.towtruck-notification)"</span>).hide();
    getModalBackground().hide();
    <span class="keyword">var</span> windows = [];
    els.each(<span class="function"><span class="keyword">function</span> <span class="params">(index, element)</span> {</span>
      element = $(element);
      windows.push(element);
      <span class="keyword">var</span> bound = element.data(<span class="string">"boundTo"</span>);
      <span class="keyword">if</span> (! bound) {
        <span class="keyword">return</span>;
      }
      bound = $(bound);
      bound.addClass(<span class="string">"towtruck-animated"</span>).addClass(<span class="string">"towtruck-color-pulse"</span>);
      setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        bound.removeClass(<span class="string">"towtruck-color-pulse"</span>).removeClass(<span class="string">"towtruck-animated"</span>);
      }, ANIMATION_DURATION+<span class="number">10</span>);
      element.data(<span class="string">"boundTo"</span>, <span class="literal">null</span>);
      bound.removeClass(<span class="string">"towtruck-active"</span>);
      <span class="keyword">if</span> (element.hasClass(<span class="string">"towtruck-notification"</span>)) {
        element.fadeOut().promise().then(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
          <span class="keyword">this</span>.hide();
        });
      }
    });
    $(<span class="string">"#towtruck-window-pointer-right, #towtruck-window-pointer-left"</span>).hide();
    <span class="keyword">if</span> (onClose) {
      onClose();
      onClose = <span class="literal">null</span>;
    }
    <span class="keyword">if</span> (windows.length) {
      session.emit(<span class="string">"hide-window"</span>, windows);
    }
  };

  windowing.showNotification = <span class="function"><span class="keyword">function</span> <span class="params">(element, options)</span> {</span>
    element = $(element);
    options = options || {};
    assert(<span class="literal">false</span>);
  };

  windowing.toggle = <span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
    el = $(el);
    <span class="keyword">if</span> (el.is(<span class="string">":visible"</span>)) {
      windowing.hide(el);
      console.log(<span class="string">"close window"</span>);
      closeDock();
    } <span class="keyword">else</span> {
      windowing.show(el);
      console.log(<span class="string">"open window"</span>);
    }
  };

  <span class="function"><span class="keyword">function</span> <span class="title">bindEvents</span><span class="params">(el)</span> {</span>
    el.find(<span class="string">".towtruck-close, .towtruck-dismiss"</span>).click(<span class="function"><span class="keyword">function</span> <span class="params">(event)</span> {</span>
      <span class="keyword">var</span> w = $(event.target).closest(<span class="string">".towtruck-window, .towtruck-modal, .towtruck-notification"</span>);
      windowing.hide(w);
      event.stopPropagation();
      <span class="keyword">return</span> <span class="literal">false</span>;
    });
  }

  <span class="function"><span class="keyword">function</span> <span class="title">getModalBackground</span><span class="params">()</span> {</span>
    <span class="keyword">if</span> (getModalBackground.element) {
      <span class="keyword">return</span> getModalBackground.element;
    }
    <span class="keyword">var</span> background = $(<span class="string">"#towtruck-modal-background"</span>);
    assert(background.length);
    getModalBackground.element = background;
    background.click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      windowing.hide();
    });
    <span class="keyword">return</span> background;
  }

  <span class="keyword">var</span> modalEscape = {
    bind: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      $(document).keydown(modalEscape.onKeydown);
    },
    unbind: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      $(document).unbind(<span class="string">"keydown"</span>, modalEscape.onKeydown);
    },
    onKeydown: <span class="function"><span class="keyword">function</span> <span class="params">(event)</span> {</span>
      <span class="keyword">if</span> (event.which == <span class="number">27</span>) {
        windowing.hide();
      }
    }
  };

  session.on(<span class="string">"close"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    modalEscape.unbind();
  });

  session.on(<span class="string">"new-element"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
    bindEvents(el);
  });

  <span class="keyword">return</span> windowing;
});

<span class="comment">/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
define(<span class="string">'templating'</span>,[<span class="string">"jquery"</span>, <span class="string">"util"</span>, <span class="string">"peers"</span>, <span class="string">"windowing"</span>, <span class="string">"session"</span>], <span class="function"><span class="keyword">function</span> <span class="params">($, util, peers, windowing, session)</span> {</span>
  <span class="keyword">var</span> assert = util.assert;
  <span class="keyword">var</span> templating = util.Module(<span class="string">"templating"</span>);

  templating.clone = <span class="function"><span class="keyword">function</span> <span class="params">(templateId)</span> {</span>
    templateId = <span class="string">"#towtruck-template-"</span> + templateId;
    <span class="keyword">var</span> template = $(templateId);
    assert(template.length, <span class="string">"No template found with id:"</span>, templateId);
    template = template.clone();
    template.attr(<span class="string">"id"</span>, <span class="literal">null</span>);</pre></div></div>
              
            </li>
          
            <li id="section-116">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-116">&#182;</a>
                </div>
                <p>FIXME: if called directly, doesn&#39;t emit new-element event:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span> template;
  };

  templating.sub = <span class="function"><span class="keyword">function</span> <span class="params">(templateId, variables)</span> {</span>
    <span class="keyword">var</span> template = templating.clone(templateId);
    variables = variables || {};
    util.forEachAttr(variables, <span class="function"><span class="keyword">function</span> <span class="params">(value, attr)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-117">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-117">&#182;</a>
                </div>
                <p>FIXME: do the substitution... somehow?</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> subs = template.find(<span class="string">".towtruck-sub-"</span> + attr).removeClass(<span class="string">"towtruck-sub-"</span> + attr);
      <span class="keyword">if</span> (subs.length) {
        <span class="keyword">if</span> (<span class="keyword">typeof</span> value == <span class="string">"string"</span>) {
          subs.text(value);
        } <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> $) {
          subs.append(value);
        } <span class="keyword">else</span> {
          assert(<span class="literal">false</span>, <span class="string">"Unknown variable value type:"</span>, attr, <span class="string">"="</span>, value);
        }
      }
      <span class="keyword">var</span> ifs = template.find(<span class="string">".towtruck-if-"</span> + attr).removeClass(<span class="string">"towtruck-sub-"</span> + attr);
      <span class="keyword">if</span> (! value) {
        ifs.hide();
      }
      ifs = template.find(<span class="string">".towtruck-ifnot-"</span> + attr).removeClass(<span class="string">"towtruck-ifnot-"</span> + attr);
      <span class="keyword">if</span> (value) {
        ifs.hide();
      }
      <span class="keyword">var</span> attrName = <span class="string">"data-towtruck-subattr-"</span> + attr;
      <span class="keyword">var</span> attrs = template.find(<span class="string">"["</span> + attrName + <span class="string">"]"</span>);
      attrs.each(<span class="function"><span class="keyword">function</span> <span class="params">(index, element)</span> {</span>
        assert(<span class="keyword">typeof</span> value == <span class="string">"string"</span>);
        element = $(element);
        <span class="keyword">var</span> subAttribute = element.attr(attrName);
        element.attr(attrName, <span class="literal">null</span>);
        element.attr(subAttribute, value);
      });
    });
    <span class="keyword">if</span> (variables.peer) {
      variables.peer.view.setElement(template);
    }
    <span class="keyword">if</span> (variables.date) {
      <span class="keyword">var</span> date = variables.date;
      <span class="keyword">if</span> (<span class="keyword">typeof</span> date == <span class="string">"number"</span>) {
        date = <span class="keyword">new</span> Date(date);
      }
      <span class="keyword">var</span> ampm = <span class="string">"AM"</span>;
      <span class="keyword">var</span> hour = date.getHours();
      <span class="keyword">if</span> (hour &gt; <span class="number">12</span>) {
        hour -= <span class="number">12</span>;
        ampm = <span class="string">"PM"</span>;
      }
      <span class="keyword">var</span> minute = date.getMinutes();
      <span class="keyword">var</span> t = hour + <span class="string">":"</span>;
      <span class="keyword">if</span> (minute &lt; <span class="number">10</span>) {
        t += <span class="string">"0"</span>;
      }
      t += minute;
      template.find(<span class="string">".towtruck-time"</span>).text(t);
      template.find(<span class="string">".towtruck-ampm"</span>).text(ampm);
    }</pre></div></div>
              
            </li>
          
            <li id="section-118">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-118">&#182;</a>
                </div>
                <p>FIXME: silly this is on session:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    session.emit(<span class="string">"new-element"</span>, template);
    <span class="keyword">return</span> template;
  };

  <span class="keyword">return</span> templating;
});

define(<span class="string">'linkify'</span>,[], <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-119">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-119">&#182;</a>
                </div>
                <p>FIXME: this could be moved to a different module, it&#39;s pretty stand-alone</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="comment">/* Finds any links in the text of an element (or its children) and turns them
     into anchors (with target=_blank) */</span>
  <span class="function"><span class="keyword">function</span> <span class="title">linkify</span><span class="params">(el)</span> {</span>
    <span class="keyword">if</span> (el.jquery) {
      el = el[<span class="number">0</span>];
    }
    el.normalize();
    <span class="function"><span class="keyword">function</span> <span class="title">linkifyNode</span><span class="params">(node)</span> {</span>
      <span class="keyword">var</span> _len = node.childNodes.length;
      <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;_len; i++) {
        <span class="keyword">if</span> (node.childNodes[i].nodeType == document.ELEMENT_NODE) {
          linkifyNode(node.childNodes[i]);
        }
      }
      <span class="keyword">var</span> texts = [];
      <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;_len; i++) {
        <span class="keyword">if</span> (node.childNodes[i].nodeType == document.TEXT_NODE) {
          texts.push(node.childNodes[i]);
        }
      }
      texts.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(item)</span> {</span>
        <span class="keyword">if</span> (item.nodeType == document.ELEMENT_NODE) {
          linkifyNode(item);
        } <span class="keyword">else</span> <span class="keyword">if</span> (item.nodeType == document.TEXT_NODE) {
          <span class="keyword">while</span> (<span class="literal">true</span>) {
            <span class="keyword">var</span> text = item.nodeValue;
            <span class="keyword">var</span> regex = <span class="regexp">/\bhttps?:\/\/[a-z0-9\.\-_](:\d+)?[^&lt;&gt;()\[\]]*/i</span>;
            <span class="keyword">var</span> match = regex.exec(text);
            <span class="keyword">if</span> (! match) {
              <span class="keyword">break</span>;
            }
            <span class="keyword">var</span> leadingNode = document.createTextNode(text.substr(<span class="number">0</span>, match.index));
            node.replaceChild(leadingNode, item);
            <span class="keyword">var</span> anchor = document.createElement(<span class="string">"a"</span>);
            anchor.setAttribute(<span class="string">"target"</span>, <span class="string">"_blank"</span>);
            anchor.href = match[<span class="number">0</span>];
            anchor.appendChild(document.createTextNode(match[<span class="number">0</span>]));
            node.insertBefore(anchor, leadingNode.nextSibling);
            <span class="keyword">var</span> trailing = document.createTextNode(text.substr(match.index + match[<span class="number">0</span>].length));
            node.insertBefore(trailing, anchor.nextSibling);
            item = trailing;
          }
        }
      });
    }
    linkifyNode(el);
  }

  <span class="keyword">return</span> linkify;
});</pre></div></div>
              
            </li>
          
            <li id="section-120">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-120">&#182;</a>
                </div>
                <p>TinyColor v0.9.13
<a href="https://github.com/bgrins/TinyColor">https://github.com/bgrins/TinyColor</a>
2012-11-28, Brian Grinstead, MIT License</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>(<span class="keyword">function</span>(root) {

<span class="keyword">var</span> trimLeft = <span class="regexp">/^[\s,#]+/</span>,
    trimRight = <span class="regexp">/\s+$/</span>,
    tinyCounter = <span class="number">0</span>,
    math = Math,
    mathRound = math.round,
    mathMin = math.min,
    mathMax = math.max,
    mathRandom = math.random;

<span class="function"><span class="keyword">function</span> <span class="title">tinycolor</span> <span class="params">(color, opts)</span> {</span>

    color = (color) ? color : <span class="string">''</span>;</pre></div></div>
              
            </li>
          
            <li id="section-121">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-121">&#182;</a>
                </div>
                <p>If input is already a tinycolor, return itself</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (<span class="keyword">typeof</span> color == <span class="string">"object"</span> &amp;&amp; color.hasOwnProperty(<span class="string">"_tc_id"</span>)) {
       <span class="keyword">return</span> color;
    }

    <span class="keyword">var</span> rgb = inputToRGB(color);
    <span class="keyword">var</span> r = rgb.r,
        g = rgb.g,
        b = rgb.b,
        a = rgb.a,
        roundA = mathRound(<span class="number">100</span>*a) / <span class="number">100</span>,
        format = rgb.format;</pre></div></div>
              
            </li>
          
            <li id="section-122">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-122">&#182;</a>
                </div>
                <p>Don&#39;t let the range of [0,255] come back in [0,1].
Potentially lose a little bit of precision here, but will fix issues where
.5 gets interpreted as half of the total, instead of half of 1
If it was supposed to be 128, this was already taken care of by <code>inputToRgb</code></p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (r &lt; <span class="number">1</span>) { r = mathRound(r); }
    <span class="keyword">if</span> (g &lt; <span class="number">1</span>) { g = mathRound(g); }
    <span class="keyword">if</span> (b &lt; <span class="number">1</span>) { b = mathRound(b); }

    <span class="keyword">return</span> {
        ok: rgb.ok,
        format: format,
        _tc_id: tinyCounter++,
        alpha: a,
        toHsv: <span class="keyword">function</span>() {
            <span class="keyword">var</span> hsv = rgbToHsv(r, g, b);
            <span class="keyword">return</span> { h: hsv.h * <span class="number">360</span>, s: hsv.s, v: hsv.v, a: a };
        },
        toHsvString: <span class="keyword">function</span>() {
            <span class="keyword">var</span> hsv = rgbToHsv(r, g, b);
            <span class="keyword">var</span> h = mathRound(hsv.h * <span class="number">360</span>), s = mathRound(hsv.s * <span class="number">100</span>), v = mathRound(hsv.v * <span class="number">100</span>);
            <span class="keyword">return</span> (a == <span class="number">1</span>) ?
              <span class="string">"hsv("</span>  + h + <span class="string">", "</span> + s + <span class="string">"%, "</span> + v + <span class="string">"%)"</span> :
              <span class="string">"hsva("</span> + h + <span class="string">", "</span> + s + <span class="string">"%, "</span> + v + <span class="string">"%, "</span>+ roundA + <span class="string">")"</span>;
        },
        toHsl: <span class="keyword">function</span>() {
            <span class="keyword">var</span> hsl = rgbToHsl(r, g, b);
            <span class="keyword">return</span> { h: hsl.h * <span class="number">360</span>, s: hsl.s, l: hsl.l, a: a };
        },
        toHslString: <span class="keyword">function</span>() {
            <span class="keyword">var</span> hsl = rgbToHsl(r, g, b);
            <span class="keyword">var</span> h = mathRound(hsl.h * <span class="number">360</span>), s = mathRound(hsl.s * <span class="number">100</span>), l = mathRound(hsl.l * <span class="number">100</span>);
            <span class="keyword">return</span> (a == <span class="number">1</span>) ?
              <span class="string">"hsl("</span>  + h + <span class="string">", "</span> + s + <span class="string">"%, "</span> + l + <span class="string">"%)"</span> :
              <span class="string">"hsla("</span> + h + <span class="string">", "</span> + s + <span class="string">"%, "</span> + l + <span class="string">"%, "</span>+ roundA + <span class="string">")"</span>;
        },
        toHex: <span class="keyword">function</span>() {
            <span class="keyword">return</span> rgbToHex(r, g, b);
        },
        toHexString: <span class="keyword">function</span>() {
            <span class="keyword">return</span> <span class="string">'#'</span> + rgbToHex(r, g, b);
        },
        toRgb: <span class="keyword">function</span>() {
            <span class="keyword">return</span> { r: mathRound(r), g: mathRound(g), b: mathRound(b), a: a };
        },
        toRgbString: <span class="keyword">function</span>() {
            <span class="keyword">return</span> (a == <span class="number">1</span>) ?
              <span class="string">"rgb("</span>  + mathRound(r) + <span class="string">", "</span> + mathRound(g) + <span class="string">", "</span> + mathRound(b) + <span class="string">")"</span> :
              <span class="string">"rgba("</span> + mathRound(r) + <span class="string">", "</span> + mathRound(g) + <span class="string">", "</span> + mathRound(b) + <span class="string">", "</span> + roundA + <span class="string">")"</span>;
        },
        toPercentageRgb: <span class="keyword">function</span>() {
            <span class="keyword">return</span> { r: mathRound(bound01(r, <span class="number">255</span>) * <span class="number">100</span>) + <span class="string">"%"</span>, g: mathRound(bound01(g, <span class="number">255</span>) * <span class="number">100</span>) + <span class="string">"%"</span>, b: mathRound(bound01(b, <span class="number">255</span>) * <span class="number">100</span>) + <span class="string">"%"</span>, a: a };
        },
        toPercentageRgbString: <span class="keyword">function</span>() {
            <span class="keyword">return</span> (a == <span class="number">1</span>) ?
              <span class="string">"rgb("</span>  + mathRound(bound01(r, <span class="number">255</span>) * <span class="number">100</span>) + <span class="string">"%, "</span> + mathRound(bound01(g, <span class="number">255</span>) * <span class="number">100</span>) + <span class="string">"%, "</span> + mathRound(bound01(b, <span class="number">255</span>) * <span class="number">100</span>) + <span class="string">"%)"</span> :
              <span class="string">"rgba("</span> + mathRound(bound01(r, <span class="number">255</span>) * <span class="number">100</span>) + <span class="string">"%, "</span> + mathRound(bound01(g, <span class="number">255</span>) * <span class="number">100</span>) + <span class="string">"%, "</span> + mathRound(bound01(b, <span class="number">255</span>) * <span class="number">100</span>) + <span class="string">"%, "</span> + roundA + <span class="string">")"</span>;
        },
        toName: <span class="keyword">function</span>() {
            <span class="keyword">return</span> hexNames[rgbToHex(r, g, b)] || <span class="literal">false</span>;
        },
        toFilter: <span class="keyword">function</span>() {
            <span class="keyword">var</span> hex = rgbToHex(r, g, b);
            <span class="keyword">var</span> secondHex = hex;
            <span class="keyword">var</span> alphaHex = Math.round(parseFloat(a) * <span class="number">255</span>).toString(<span class="number">16</span>);
            <span class="keyword">var</span> secondAlphaHex = alphaHex;
            <span class="keyword">var</span> gradientType = opts &amp;&amp; opts.gradientType ? <span class="string">"GradientType = 1, "</span> : <span class="string">""</span>;

            <span class="keyword">if</span> (secondColor) {
                <span class="keyword">var</span> s = tinycolor(secondColor);
                secondHex = s.toHex();
                secondAlphaHex = Math.round(parseFloat(s.alpha) * <span class="number">255</span>).toString(<span class="number">16</span>);
            }

            <span class="keyword">return</span> <span class="string">"progid:DXImageTransform.Microsoft.gradient("</span>+gradientType+<span class="string">"startColorstr=#"</span> + pad2(alphaHex) + hex + <span class="string">",endColorstr=#"</span> + pad2(secondAlphaHex) + secondHex + <span class="string">")"</span>;
        },
        toString: <span class="keyword">function</span>(format) {
            format = format || <span class="keyword">this</span>.format;
            <span class="keyword">var</span> formattedString = <span class="literal">false</span>;
            <span class="keyword">if</span> (format === <span class="string">"rgb"</span>) {
                formattedString = <span class="keyword">this</span>.toRgbString();
            }
            <span class="keyword">if</span> (format === <span class="string">"prgb"</span>) {
                formattedString = <span class="keyword">this</span>.toPercentageRgbString();
            }
            <span class="keyword">if</span> (format === <span class="string">"hex"</span>) {
                formattedString = <span class="keyword">this</span>.toHexString();
            }
            <span class="keyword">if</span> (format === <span class="string">"name"</span>) {
                formattedString = <span class="keyword">this</span>.toName();
            }
            <span class="keyword">if</span> (format === <span class="string">"hsl"</span>) {
                formattedString = <span class="keyword">this</span>.toHslString();
            }
            <span class="keyword">if</span> (format === <span class="string">"hsv"</span>) {
                formattedString = <span class="keyword">this</span>.toHsvString();
            }

            <span class="keyword">return</span> formattedString || <span class="keyword">this</span>.toHexString();
        }
    };
}</pre></div></div>
              
            </li>
          
            <li id="section-123">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-123">&#182;</a>
                </div>
                <p>If input is an object, force 1 into &quot;1.0&quot; to handle ratios properly
String input requires &quot;1.0&quot; as input, so 1 will be treated as 1</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>tinycolor.fromRatio = <span class="keyword">function</span>(color) {
    <span class="keyword">if</span> (<span class="keyword">typeof</span> color == <span class="string">"object"</span>) {
        <span class="keyword">var</span> newColor = {};
        <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> color) {
            newColor[i] = convertToPercentage(color[i]);
        }
        color = newColor;
    }

    <span class="keyword">return</span> tinycolor(color);
};</pre></div></div>
              
            </li>
          
            <li id="section-124">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-124">&#182;</a>
                </div>
                <p>Given a string or object, convert that input to RGB
Possible string inputs:</p>
<pre><code><span class="string">"red"</span>
<span class="string">"#f00"</span> <span class="keyword">or</span> <span class="string">"f00"</span>
<span class="string">"#ff0000"</span> <span class="keyword">or</span> <span class="string">"ff0000"</span>
<span class="string">"rgb 255 0 0"</span> <span class="keyword">or</span> <span class="string">"rgb (255, 0, 0)"</span>
<span class="string">"rgb 1.0 0 0"</span> <span class="keyword">or</span> <span class="string">"rgb (1, 0, 0)"</span>
<span class="string">"rgba (255, 0, 0, 1)"</span> <span class="keyword">or</span> <span class="string">"rgba 255, 0, 0, 1"</span>
<span class="string">"rgba (1.0, 0, 0, 1)"</span> <span class="keyword">or</span> <span class="string">"rgba 1.0, 0, 0, 1"</span>
<span class="string">"hsl(0, 100<span class="variable">%,</span> 50<span class="variable">%)</span>"</span> <span class="keyword">or</span> <span class="string">"hsl 0 100% 50<span class="variable">%"</span>
"</span>hsla(<span class="number">0</span>, <span class="number">100</span><span class="variable">%,</span> <span class="number">50</span><span class="variable">%,</span> <span class="number">1</span>)<span class="string">" or "</span>hsla <span class="number">0</span> <span class="number">100</span>% <span class="number">50</span><span class="variable">%,</span> <span class="number">1</span><span class="string">"
"</span>hsv(<span class="number">0</span>, <span class="number">100</span><span class="variable">%,</span> <span class="number">100</span><span class="variable">%)</span><span class="string">" or "</span>hsv <span class="number">0</span> <span class="number">100</span>% <span class="number">100</span><span class="variable">%"</span></code></pre>

              </div>
              
                <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">inputToRGB</span><span class="params">(color)</span> {</span>

    <span class="keyword">var</span> rgb = { r: <span class="number">255</span>, g: <span class="number">255</span>, b: <span class="number">255</span> };
    <span class="keyword">var</span> a = <span class="number">1</span>;
    <span class="keyword">var</span> ok = <span class="literal">false</span>;
    <span class="keyword">var</span> format = <span class="literal">false</span>;

    <span class="keyword">if</span> (<span class="keyword">typeof</span> color == <span class="string">"string"</span>) {
        color = stringInputToObject(color);
    }

    <span class="keyword">if</span> (<span class="keyword">typeof</span> color == <span class="string">"object"</span>) {
        <span class="keyword">if</span> (color.hasOwnProperty(<span class="string">"r"</span>) &amp;&amp; color.hasOwnProperty(<span class="string">"g"</span>) &amp;&amp; color.hasOwnProperty(<span class="string">"b"</span>)) {
            rgb = rgbToRgb(color.r, color.g, color.b);
            ok = <span class="literal">true</span>;
            format = String(color.r).substr(-<span class="number">1</span>) === <span class="string">"%"</span> ? <span class="string">"prgb"</span> : <span class="string">"rgb"</span>;
        }
        <span class="keyword">else</span> <span class="keyword">if</span> (color.hasOwnProperty(<span class="string">"h"</span>) &amp;&amp; color.hasOwnProperty(<span class="string">"s"</span>) &amp;&amp; color.hasOwnProperty(<span class="string">"v"</span>)) {
            color.s = convertToPercentage(color.s);
            color.v = convertToPercentage(color.v);
            rgb = hsvToRgb(color.h, color.s, color.v);
            ok = <span class="literal">true</span>;
            format = <span class="string">"hsv"</span>;
        }
        <span class="keyword">else</span> <span class="keyword">if</span> (color.hasOwnProperty(<span class="string">"h"</span>) &amp;&amp; color.hasOwnProperty(<span class="string">"s"</span>) &amp;&amp; color.hasOwnProperty(<span class="string">"l"</span>)) {
            color.s = convertToPercentage(color.s);
            color.l = convertToPercentage(color.l);
            rgb = hslToRgb(color.h, color.s, color.l);
            ok = <span class="literal">true</span>;
            format = <span class="string">"hsl"</span>;
        }

        <span class="keyword">if</span> (color.hasOwnProperty(<span class="string">"a"</span>)) {
            a = color.a;
        }
    }

    a = parseFloat(a);</pre></div></div>
              
            </li>
          
            <li id="section-125">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-125">&#182;</a>
                </div>
                <p>Handle invalid alpha characters by setting to 1</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (isNaN(a) || a &lt; <span class="number">0</span> || a &gt; <span class="number">1</span>) {
        a = <span class="number">1</span>;
    }

    <span class="keyword">return</span> {
        ok: ok,
        format: color.format || format,
        r: mathMin(<span class="number">255</span>, mathMax(rgb.r, <span class="number">0</span>)),
        g: mathMin(<span class="number">255</span>, mathMax(rgb.g, <span class="number">0</span>)),
        b: mathMin(<span class="number">255</span>, mathMax(rgb.b, <span class="number">0</span>)),
        a: a
    };
}</pre></div></div>
              
            </li>
          
            <li id="section-126">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-126">&#182;</a>
                </div>
                <h2>Conversion Functions</h2>

              </div>
              
              
            </li>
          
            <li id="section-127">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-127">&#182;</a>
                </div>
                <p><code>rgbToHsl</code>, <code>rgbToHsv</code>, <code>hslToRgb</code>, <code>hsvToRgb</code> modified from:
<a href="http://mjijackson.com/2008/02/rgb-to-hsl-and-rgb-to-hsv-color-model-conversion-algorithms-in-javascript">http://mjijackson.com/2008/02/rgb-to-hsl-and-rgb-to-hsv-color-model-conversion-algorithms-in-javascript</a></p>
<p><code>rgbToRgb</code>
Handle bounds / percentage checking to conform to CSS color spec
<a href="http://www.w3.org/TR/css3-color/">http://www.w3.org/TR/css3-color/</a>
<em>Assumes:</em> r, g, b in [0, 255] or [0, 1]
<em>Returns:</em> { r, g, b } in [0, 255]</p>

              </div>
              
                <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">rgbToRgb</span><span class="params">(r, g, b)</span>{</span>
    <span class="keyword">return</span> {
        r: bound01(r, <span class="number">255</span>) * <span class="number">255</span>,
        g: bound01(g, <span class="number">255</span>) * <span class="number">255</span>,
        b: bound01(b, <span class="number">255</span>) * <span class="number">255</span>
    };
}</pre></div></div>
              
            </li>
          
            <li id="section-128">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-128">&#182;</a>
                </div>
                <p><code>rgbToHsl</code>
Converts an RGB color value to HSL.
<em>Assumes:</em> r, g, and b are contained in [0, 255] or [0, 1]
<em>Returns:</em> { h, s, l } in [0,1]</p>

              </div>
              
                <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">rgbToHsl</span><span class="params">(r, g, b)</span> {</span>

    r = bound01(r, <span class="number">255</span>);
    g = bound01(g, <span class="number">255</span>);
    b = bound01(b, <span class="number">255</span>);

    <span class="keyword">var</span> max = mathMax(r, g, b), min = mathMin(r, g, b);
    <span class="keyword">var</span> h, s, l = (max + min) / <span class="number">2</span>;

    <span class="keyword">if</span>(max == min) {
        h = s = <span class="number">0</span>; <span class="comment">// achromatic</span>
    }
    <span class="keyword">else</span> {
        <span class="keyword">var</span> d = max - min;
        s = l &gt; <span class="number">0.5</span> ? d / (<span class="number">2</span> - max - min) : d / (max + min);
        <span class="keyword">switch</span>(max) {
            <span class="keyword">case</span> r: h = (g - b) / d + (g &lt; b ? <span class="number">6</span> : <span class="number">0</span>); <span class="keyword">break</span>;
            <span class="keyword">case</span> g: h = (b - r) / d + <span class="number">2</span>; <span class="keyword">break</span>;
            <span class="keyword">case</span> b: h = (r - g) / d + <span class="number">4</span>; <span class="keyword">break</span>;
        }

        h /= <span class="number">6</span>;
    }

    <span class="keyword">return</span> { h: h, s: s, l: l };
}</pre></div></div>
              
            </li>
          
            <li id="section-129">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-129">&#182;</a>
                </div>
                <p><code>hslToRgb</code>
Converts an HSL color value to RGB.
<em>Assumes:</em> h is contained in [0, 1] or [0, 360] and s and l are contained [0, 1] or [0, 100]
<em>Returns:</em> { r, g, b } in the set [0, 255]</p>

              </div>
              
                <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">hslToRgb</span><span class="params">(h, s, l)</span> {</span>
    <span class="keyword">var</span> r, g, b;

    h = bound01(h, <span class="number">360</span>);
    s = bound01(s, <span class="number">100</span>);
    l = bound01(l, <span class="number">100</span>);

    <span class="function"><span class="keyword">function</span> <span class="title">hue2rgb</span><span class="params">(p, q, t)</span> {</span>
        <span class="keyword">if</span>(t &lt; <span class="number">0</span>) t += <span class="number">1</span>;
        <span class="keyword">if</span>(t &gt; <span class="number">1</span>) t -= <span class="number">1</span>;
        <span class="keyword">if</span>(t &lt; <span class="number">1</span>/<span class="number">6</span>) <span class="keyword">return</span> p + (q - p) * <span class="number">6</span> * t;
        <span class="keyword">if</span>(t &lt; <span class="number">1</span>/<span class="number">2</span>) <span class="keyword">return</span> q;
        <span class="keyword">if</span>(t &lt; <span class="number">2</span>/<span class="number">3</span>) <span class="keyword">return</span> p + (q - p) * (<span class="number">2</span>/<span class="number">3</span> - t) * <span class="number">6</span>;
        <span class="keyword">return</span> p;
    }

    <span class="keyword">if</span>(s === <span class="number">0</span>) {
        r = g = b = l; <span class="comment">// achromatic</span>
    }
    <span class="keyword">else</span> {
        <span class="keyword">var</span> q = l &lt; <span class="number">0.5</span> ? l * (<span class="number">1</span> + s) : l + s - l * s;
        <span class="keyword">var</span> p = <span class="number">2</span> * l - q;
        r = hue2rgb(p, q, h + <span class="number">1</span>/<span class="number">3</span>);
        g = hue2rgb(p, q, h);
        b = hue2rgb(p, q, h - <span class="number">1</span>/<span class="number">3</span>);
    }

    <span class="keyword">return</span> { r: r * <span class="number">255</span>, g: g * <span class="number">255</span>, b: b * <span class="number">255</span> };
}</pre></div></div>
              
            </li>
          
            <li id="section-130">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-130">&#182;</a>
                </div>
                <p><code>rgbToHsv</code>
Converts an RGB color value to HSV
<em>Assumes:</em> r, g, and b are contained in the set [0, 255] or [0, 1]
<em>Returns:</em> { h, s, v } in [0,1]</p>

              </div>
              
                <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">rgbToHsv</span><span class="params">(r, g, b)</span> {</span>

    r = bound01(r, <span class="number">255</span>);
    g = bound01(g, <span class="number">255</span>);
    b = bound01(b, <span class="number">255</span>);

    <span class="keyword">var</span> max = mathMax(r, g, b), min = mathMin(r, g, b);
    <span class="keyword">var</span> h, s, v = max;

    <span class="keyword">var</span> d = max - min;
    s = max === <span class="number">0</span> ? <span class="number">0</span> : d / max;

    <span class="keyword">if</span>(max == min) {
        h = <span class="number">0</span>; <span class="comment">// achromatic</span>
    }
    <span class="keyword">else</span> {
        <span class="keyword">switch</span>(max) {
            <span class="keyword">case</span> r: h = (g - b) / d + (g &lt; b ? <span class="number">6</span> : <span class="number">0</span>); <span class="keyword">break</span>;
            <span class="keyword">case</span> g: h = (b - r) / d + <span class="number">2</span>; <span class="keyword">break</span>;
            <span class="keyword">case</span> b: h = (r - g) / d + <span class="number">4</span>; <span class="keyword">break</span>;
        }
        h /= <span class="number">6</span>;
    }
    <span class="keyword">return</span> { h: h, s: s, v: v };
}</pre></div></div>
              
            </li>
          
            <li id="section-131">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-131">&#182;</a>
                </div>
                <p><code>hsvToRgb</code>
Converts an HSV color value to RGB.
<em>Assumes:</em> h is contained in [0, 1] or [0, 360] and s and v are contained in [0, 1] or [0, 100]
<em>Returns:</em> { r, g, b } in the set [0, 255]</p>

              </div>
              
                <div class="content"><div class='highlight'><pre> <span class="function"><span class="keyword">function</span> <span class="title">hsvToRgb</span><span class="params">(h, s, v)</span> {</span>

    h = bound01(h, <span class="number">360</span>) * <span class="number">6</span>;
    s = bound01(s, <span class="number">100</span>);
    v = bound01(v, <span class="number">100</span>);

    <span class="keyword">var</span> i = math.floor(h),
        f = h - i,
        p = v * (<span class="number">1</span> - s),
        q = v * (<span class="number">1</span> - f * s),
        t = v * (<span class="number">1</span> - (<span class="number">1</span> - f) * s),
        mod = i % <span class="number">6</span>,
        r = [v, q, p, p, t, v][mod],
        g = [t, v, v, q, p, p][mod],
        b = [p, p, t, v, v, q][mod];

    <span class="keyword">return</span> { r: r * <span class="number">255</span>, g: g * <span class="number">255</span>, b: b * <span class="number">255</span> };
}</pre></div></div>
              
            </li>
          
            <li id="section-132">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-132">&#182;</a>
                </div>
                <p><code>rgbToHex</code>
Converts an RGB color to hex
Assumes r, g, and b are contained in the set [0, 255]
Returns a 3 or 6 character hex</p>

              </div>
              
                <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">rgbToHex</span><span class="params">(r, g, b)</span> {</span>
    <span class="keyword">var</span> hex = [
        pad2(mathRound(r).toString(<span class="number">16</span>)),
        pad2(mathRound(g).toString(<span class="number">16</span>)),
        pad2(mathRound(b).toString(<span class="number">16</span>))
    ];</pre></div></div>
              
            </li>
          
            <li id="section-133">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-133">&#182;</a>
                </div>
                <p>Return a 3 character hex if possible</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (hex[<span class="number">0</span>].charAt(<span class="number">0</span>) == hex[<span class="number">0</span>].charAt(<span class="number">1</span>) &amp;&amp; hex[<span class="number">1</span>].charAt(<span class="number">0</span>) == hex[<span class="number">1</span>].charAt(<span class="number">1</span>) &amp;&amp; hex[<span class="number">2</span>].charAt(<span class="number">0</span>) == hex[<span class="number">2</span>].charAt(<span class="number">1</span>)) {
        <span class="keyword">return</span> hex[<span class="number">0</span>].charAt(<span class="number">0</span>) + hex[<span class="number">1</span>].charAt(<span class="number">0</span>) + hex[<span class="number">2</span>].charAt(<span class="number">0</span>);
    }

    <span class="keyword">return</span> hex.join(<span class="string">""</span>);
}</pre></div></div>
              
            </li>
          
            <li id="section-134">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-134">&#182;</a>
                </div>
                <p><code>equals</code>
Can be called with any tinycolor input</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>tinycolor.equals = <span class="function"><span class="keyword">function</span> <span class="params">(color1, color2)</span> {</span>
    <span class="keyword">if</span> (!color1 || !color2) { <span class="keyword">return</span> <span class="literal">false</span>; }
    <span class="keyword">return</span> tinycolor(color1).toRgbString() == tinycolor(color2).toRgbString();
};
tinycolor.random = <span class="keyword">function</span>() {
    <span class="keyword">return</span> tinycolor.fromRatio({
        r: mathRandom(),
        g: mathRandom(),
        b: mathRandom()
    });
};</pre></div></div>
              
            </li>
          
            <li id="section-135">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-135">&#182;</a>
                </div>
                <h2>Modification Functions</h2>

              </div>
              
              
            </li>
          
            <li id="section-136">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-136">&#182;</a>
                </div>
                <p>Thanks to less.js for some of the basics here
<a href="https://github.com/cloudhead/less.js/blob/master/lib/less/functions.js">https://github.com/cloudhead/less.js/blob/master/lib/less/functions.js</a></p>

              </div>
              
                <div class="content"><div class='highlight'><pre>tinycolor.desaturate = <span class="function"><span class="keyword">function</span> <span class="params">(color, amount)</span> {</span>
    <span class="keyword">var</span> hsl = tinycolor(color).toHsl();
    hsl.s -= ((amount || <span class="number">10</span>) / <span class="number">100</span>);
    hsl.s = clamp01(hsl.s);
    <span class="keyword">return</span> tinycolor(hsl);
};
tinycolor.saturate = <span class="function"><span class="keyword">function</span> <span class="params">(color, amount)</span> {</span>
    <span class="keyword">var</span> hsl = tinycolor(color).toHsl();
    hsl.s += ((amount || <span class="number">10</span>) / <span class="number">100</span>);
    hsl.s = clamp01(hsl.s);
    <span class="keyword">return</span> tinycolor(hsl);
};
tinycolor.greyscale = <span class="keyword">function</span>(color) {
    <span class="keyword">return</span> tinycolor.desaturate(color, <span class="number">100</span>);
};
tinycolor.lighten = <span class="keyword">function</span>(color, amount) {
    <span class="keyword">var</span> hsl = tinycolor(color).toHsl();
    hsl.l += ((amount || <span class="number">10</span>) / <span class="number">100</span>);
    hsl.l = clamp01(hsl.l);
    <span class="keyword">return</span> tinycolor(hsl);
};
tinycolor.darken = <span class="function"><span class="keyword">function</span> <span class="params">(color, amount)</span> {</span>
    <span class="keyword">var</span> hsl = tinycolor(color).toHsl();
    hsl.l -= ((amount || <span class="number">10</span>) / <span class="number">100</span>);
    hsl.l = clamp01(hsl.l);
    <span class="keyword">return</span> tinycolor(hsl);
};
tinycolor.complement = <span class="keyword">function</span>(color) {
    <span class="keyword">var</span> hsl = tinycolor(color).toHsl();
    hsl.h = (hsl.h + <span class="number">180</span>) % <span class="number">360</span>;
    <span class="keyword">return</span> tinycolor(hsl);
};</pre></div></div>
              
            </li>
          
            <li id="section-137">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-137">&#182;</a>
                </div>
                <h2>Combination Functions</h2>

              </div>
              
              
            </li>
          
            <li id="section-138">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-138">&#182;</a>
                </div>
                <p>Thanks to jQuery xColor for some of the ideas behind these
<a href="https://github.com/infusion/jQuery-xcolor/blob/master/jquery.xcolor.js">https://github.com/infusion/jQuery-xcolor/blob/master/jquery.xcolor.js</a></p>

              </div>
              
                <div class="content"><div class='highlight'><pre>tinycolor.triad = <span class="keyword">function</span>(color) {
    <span class="keyword">var</span> hsl = tinycolor(color).toHsl();
    <span class="keyword">var</span> h = hsl.h;
    <span class="keyword">return</span> [
        tinycolor(color),
        tinycolor({ h: (h + <span class="number">120</span>) % <span class="number">360</span>, s: hsl.s, l: hsl.l }),
        tinycolor({ h: (h + <span class="number">240</span>) % <span class="number">360</span>, s: hsl.s, l: hsl.l })
    ];
};
tinycolor.tetrad = <span class="keyword">function</span>(color) {
    <span class="keyword">var</span> hsl = tinycolor(color).toHsl();
    <span class="keyword">var</span> h = hsl.h;
    <span class="keyword">return</span> [
        tinycolor(color),
        tinycolor({ h: (h + <span class="number">90</span>) % <span class="number">360</span>, s: hsl.s, l: hsl.l }),
        tinycolor({ h: (h + <span class="number">180</span>) % <span class="number">360</span>, s: hsl.s, l: hsl.l }),
        tinycolor({ h: (h + <span class="number">270</span>) % <span class="number">360</span>, s: hsl.s, l: hsl.l })
    ];
};
tinycolor.splitcomplement = <span class="keyword">function</span>(color) {
    <span class="keyword">var</span> hsl = tinycolor(color).toHsl();
    <span class="keyword">var</span> h = hsl.h;
    <span class="keyword">return</span> [
        tinycolor(color),
        tinycolor({ h: (h + <span class="number">72</span>) % <span class="number">360</span>, s: hsl.s, l: hsl.l}),
        tinycolor({ h: (h + <span class="number">216</span>) % <span class="number">360</span>, s: hsl.s, l: hsl.l})
    ];
};
tinycolor.analogous = <span class="keyword">function</span>(color, results, slices) {
    results = results || <span class="number">6</span>;
    slices = slices || <span class="number">30</span>;

    <span class="keyword">var</span> hsl = tinycolor(color).toHsl();
    <span class="keyword">var</span> part = <span class="number">360</span> / slices;
    <span class="keyword">var</span> ret = [tinycolor(color)];

    <span class="keyword">for</span> (hsl.h = ((hsl.h - (part * results &gt;&gt; <span class="number">1</span>)) + <span class="number">720</span>) % <span class="number">360</span>; --results; ) {
        hsl.h = (hsl.h + part) % <span class="number">360</span>;
        ret.push(tinycolor(hsl));
    }
    <span class="keyword">return</span> ret;
};
tinycolor.monochromatic = <span class="keyword">function</span>(color, results) {
    results = results || <span class="number">6</span>;
    <span class="keyword">var</span> hsv = tinycolor(color).toHsv();
    <span class="keyword">var</span> h = hsv.h, s = hsv.s, v = hsv.v;
    <span class="keyword">var</span> ret = [];
    <span class="keyword">var</span> modification = <span class="number">1</span> / results;

    <span class="keyword">while</span> (results--) {
        ret.push(tinycolor({ h: h, s: s, v: v}));
        v = (v + modification) % <span class="number">1</span>;
    }

    <span class="keyword">return</span> ret;
};</pre></div></div>
              
            </li>
          
            <li id="section-139">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-139">&#182;</a>
                </div>
                <p>Readability based on W3C recommendations: <a href="http://www.w3.org/TR/AERT#color-contrast">http://www.w3.org/TR/AERT#color-contrast</a>
Returns object with two properties:
  .brightness: the difference in brightness between the two colors
  .color: the difference in color/hue between the two colors
An &quot;acceptable&quot; color is considered to have a brightness difference of 125 and a
color difference of 500</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>tinycolor.readability = <span class="keyword">function</span>(color1, color2) {
    <span class="keyword">var</span> a = tinycolor(color1).toRgb(), b = tinycolor(color2).toRgb();
    <span class="keyword">var</span> brightnessA = (a.r * <span class="number">299</span> + a.g * <span class="number">587</span> + a.b * <span class="number">114</span>) / <span class="number">1000</span>;
    <span class="keyword">var</span> brightnessB = (b.r * <span class="number">299</span> + b.g * <span class="number">587</span> + b.b * <span class="number">114</span>) / <span class="number">1000</span>;
    <span class="keyword">var</span> colorDiff = (
        Math.max(a.r, b.r) - Math.min(a.r, b.r) +
        Math.max(a.g, b.g) - Math.min(a.g, b.g) +
        Math.max(a.b, b.b) - Math.min(a.b, b.b));
    <span class="keyword">return</span> {
        brightness: Math.abs(brightnessA - brightnessB),
        color: colorDiff
    };
};</pre></div></div>
              
            </li>
          
            <li id="section-140">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-140">&#182;</a>
                </div>
                <p>True if using color1 over color2 (or vice versa) is &quot;readable&quot;
Based on: <a href="http://www.w3.org/TR/AERT#color-contrast">http://www.w3.org/TR/AERT#color-contrast</a>
Example:
  tinycolor.readable(&quot;#000&quot;, &quot;#111&quot;) =&gt; false</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>tinycolor.readable = <span class="keyword">function</span>(color1, color2) {
    <span class="keyword">var</span> readability = tinycolor.readability(color1, color2);
    <span class="keyword">return</span> readability.brightness &gt; <span class="number">125</span> &amp;&amp; readability.color &gt; <span class="number">500</span>;
};</pre></div></div>
              
            </li>
          
            <li id="section-141">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-141">&#182;</a>
                </div>
                <p>Given a base color and a list of possible foreground or background
colors for that base, returns the most readable color.
Example:
  tinycolor.mostReadable(&quot;#123&quot;, [&quot;#fff&quot;, &quot;#000&quot;]) =&gt; &quot;#000&quot;</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>tinycolor.mostReadable = <span class="keyword">function</span>(baseColor, colorList) {
    <span class="keyword">var</span> bestColor;
    <span class="keyword">var</span> bestScore = <span class="number">0</span>;
    <span class="keyword">var</span> bestIsReadable = <span class="literal">false</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i &lt; colorList.length; i++) {
        <span class="keyword">var</span> readability = tinycolor.readability(baseColor, colorList[i]);
        <span class="keyword">var</span> readable = readability.brightness &gt; <span class="number">125</span> &amp;&amp; readability.color &gt; <span class="number">500</span>;</pre></div></div>
              
            </li>
          
            <li id="section-142">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-142">&#182;</a>
                </div>
                <p>We normalize both around the &quot;acceptable&quot; breaking point,
but rank brightness constrast higher than hue.  Why?  I&#39;m
not sure, seems reasonable.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> score = <span class="number">3</span> * (readability.brightness / <span class="number">125</span>) + (readability.color / <span class="number">500</span>);
        <span class="keyword">if</span> ((readable &amp;&amp; ! bestIsReadable) ||
            (readable &amp;&amp; bestIsReadable &amp;&amp; score &gt; bestScore) ||
            ((! readable) &amp;&amp; (! bestIsReadable) &amp;&amp; score &gt; bestScore)) {
            bestIsReadable = readable;
            bestScore = score;
            bestColor = colorList[i];
        }
    }
    <span class="keyword">return</span> bestColor;
};</pre></div></div>
              
            </li>
          
            <li id="section-143">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-143">&#182;</a>
                </div>
                <h2>Big List of Colors</h2>

              </div>
              
              
            </li>
          
            <li id="section-144">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-144">&#182;</a>
                </div>
                <p><a href="http://www.w3.org/TR/css3-color/#svg-color">http://www.w3.org/TR/css3-color/#svg-color</a></p>

              </div>
              
                <div class="content"><div class='highlight'><pre><span class="keyword">var</span> names = tinycolor.names = {
    aliceblue: <span class="string">"f0f8ff"</span>,
    antiquewhite: <span class="string">"faebd7"</span>,
    aqua: <span class="string">"0ff"</span>,
    aquamarine: <span class="string">"7fffd4"</span>,
    azure: <span class="string">"f0ffff"</span>,
    beige: <span class="string">"f5f5dc"</span>,
    bisque: <span class="string">"ffe4c4"</span>,
    black: <span class="string">"000"</span>,
    blanchedalmond: <span class="string">"ffebcd"</span>,
    blue: <span class="string">"00f"</span>,
    blueviolet: <span class="string">"8a2be2"</span>,
    brown: <span class="string">"a52a2a"</span>,
    burlywood: <span class="string">"deb887"</span>,
    burntsienna: <span class="string">"ea7e5d"</span>,
    cadetblue: <span class="string">"5f9ea0"</span>,
    chartreuse: <span class="string">"7fff00"</span>,
    chocolate: <span class="string">"d2691e"</span>,
    coral: <span class="string">"ff7f50"</span>,
    cornflowerblue: <span class="string">"6495ed"</span>,
    cornsilk: <span class="string">"fff8dc"</span>,
    crimson: <span class="string">"dc143c"</span>,
    cyan: <span class="string">"0ff"</span>,
    darkblue: <span class="string">"00008b"</span>,
    darkcyan: <span class="string">"008b8b"</span>,
    darkgoldenrod: <span class="string">"b8860b"</span>,
    darkgray: <span class="string">"a9a9a9"</span>,
    darkgreen: <span class="string">"006400"</span>,
    darkgrey: <span class="string">"a9a9a9"</span>,
    darkkhaki: <span class="string">"bdb76b"</span>,
    darkmagenta: <span class="string">"8b008b"</span>,
    darkolivegreen: <span class="string">"556b2f"</span>,
    darkorange: <span class="string">"ff8c00"</span>,
    darkorchid: <span class="string">"9932cc"</span>,
    darkred: <span class="string">"8b0000"</span>,
    darksalmon: <span class="string">"e9967a"</span>,
    darkseagreen: <span class="string">"8fbc8f"</span>,
    darkslateblue: <span class="string">"483d8b"</span>,
    darkslategray: <span class="string">"2f4f4f"</span>,
    darkslategrey: <span class="string">"2f4f4f"</span>,
    darkturquoise: <span class="string">"00ced1"</span>,
    darkviolet: <span class="string">"9400d3"</span>,
    deeppink: <span class="string">"ff1493"</span>,
    deepskyblue: <span class="string">"00bfff"</span>,
    dimgray: <span class="string">"696969"</span>,
    dimgrey: <span class="string">"696969"</span>,
    dodgerblue: <span class="string">"1e90ff"</span>,
    firebrick: <span class="string">"b22222"</span>,
    floralwhite: <span class="string">"fffaf0"</span>,
    forestgreen: <span class="string">"228b22"</span>,
    fuchsia: <span class="string">"f0f"</span>,
    gainsboro: <span class="string">"dcdcdc"</span>,
    ghostwhite: <span class="string">"f8f8ff"</span>,
    gold: <span class="string">"ffd700"</span>,
    goldenrod: <span class="string">"daa520"</span>,
    gray: <span class="string">"808080"</span>,
    green: <span class="string">"008000"</span>,
    greenyellow: <span class="string">"adff2f"</span>,
    grey: <span class="string">"808080"</span>,
    honeydew: <span class="string">"f0fff0"</span>,
    hotpink: <span class="string">"ff69b4"</span>,
    indianred: <span class="string">"cd5c5c"</span>,
    indigo: <span class="string">"4b0082"</span>,
    ivory: <span class="string">"fffff0"</span>,
    khaki: <span class="string">"f0e68c"</span>,
    lavender: <span class="string">"e6e6fa"</span>,
    lavenderblush: <span class="string">"fff0f5"</span>,
    lawngreen: <span class="string">"7cfc00"</span>,
    lemonchiffon: <span class="string">"fffacd"</span>,
    lightblue: <span class="string">"add8e6"</span>,
    lightcoral: <span class="string">"f08080"</span>,
    lightcyan: <span class="string">"e0ffff"</span>,
    lightgoldenrodyellow: <span class="string">"fafad2"</span>,
    lightgray: <span class="string">"d3d3d3"</span>,
    lightgreen: <span class="string">"90ee90"</span>,
    lightgrey: <span class="string">"d3d3d3"</span>,
    lightpink: <span class="string">"ffb6c1"</span>,
    lightsalmon: <span class="string">"ffa07a"</span>,
    lightseagreen: <span class="string">"20b2aa"</span>,
    lightskyblue: <span class="string">"87cefa"</span>,
    lightslategray: <span class="string">"789"</span>,
    lightslategrey: <span class="string">"789"</span>,
    lightsteelblue: <span class="string">"b0c4de"</span>,
    lightyellow: <span class="string">"ffffe0"</span>,
    lime: <span class="string">"0f0"</span>,
    limegreen: <span class="string">"32cd32"</span>,
    linen: <span class="string">"faf0e6"</span>,
    magenta: <span class="string">"f0f"</span>,
    maroon: <span class="string">"800000"</span>,
    mediumaquamarine: <span class="string">"66cdaa"</span>,
    mediumblue: <span class="string">"0000cd"</span>,
    mediumorchid: <span class="string">"ba55d3"</span>,
    mediumpurple: <span class="string">"9370db"</span>,
    mediumseagreen: <span class="string">"3cb371"</span>,
    mediumslateblue: <span class="string">"7b68ee"</span>,
    mediumspringgreen: <span class="string">"00fa9a"</span>,
    mediumturquoise: <span class="string">"48d1cc"</span>,
    mediumvioletred: <span class="string">"c71585"</span>,
    midnightblue: <span class="string">"191970"</span>,
    mintcream: <span class="string">"f5fffa"</span>,
    mistyrose: <span class="string">"ffe4e1"</span>,
    moccasin: <span class="string">"ffe4b5"</span>,
    navajowhite: <span class="string">"ffdead"</span>,
    navy: <span class="string">"000080"</span>,
    oldlace: <span class="string">"fdf5e6"</span>,
    olive: <span class="string">"808000"</span>,
    olivedrab: <span class="string">"6b8e23"</span>,
    orange: <span class="string">"ffa500"</span>,
    orangered: <span class="string">"ff4500"</span>,
    orchid: <span class="string">"da70d6"</span>,
    palegoldenrod: <span class="string">"eee8aa"</span>,
    palegreen: <span class="string">"98fb98"</span>,
    paleturquoise: <span class="string">"afeeee"</span>,
    palevioletred: <span class="string">"db7093"</span>,
    papayawhip: <span class="string">"ffefd5"</span>,
    peachpuff: <span class="string">"ffdab9"</span>,
    peru: <span class="string">"cd853f"</span>,
    pink: <span class="string">"ffc0cb"</span>,
    plum: <span class="string">"dda0dd"</span>,
    powderblue: <span class="string">"b0e0e6"</span>,
    purple: <span class="string">"800080"</span>,
    red: <span class="string">"f00"</span>,
    rosybrown: <span class="string">"bc8f8f"</span>,
    royalblue: <span class="string">"4169e1"</span>,
    saddlebrown: <span class="string">"8b4513"</span>,
    salmon: <span class="string">"fa8072"</span>,
    sandybrown: <span class="string">"f4a460"</span>,
    seagreen: <span class="string">"2e8b57"</span>,
    seashell: <span class="string">"fff5ee"</span>,
    sienna: <span class="string">"a0522d"</span>,
    silver: <span class="string">"c0c0c0"</span>,
    skyblue: <span class="string">"87ceeb"</span>,
    slateblue: <span class="string">"6a5acd"</span>,
    slategray: <span class="string">"708090"</span>,
    slategrey: <span class="string">"708090"</span>,
    snow: <span class="string">"fffafa"</span>,
    springgreen: <span class="string">"00ff7f"</span>,
    steelblue: <span class="string">"4682b4"</span>,
    tan: <span class="string">"d2b48c"</span>,
    teal: <span class="string">"008080"</span>,
    thistle: <span class="string">"d8bfd8"</span>,
    tomato: <span class="string">"ff6347"</span>,
    turquoise: <span class="string">"40e0d0"</span>,
    violet: <span class="string">"ee82ee"</span>,
    wheat: <span class="string">"f5deb3"</span>,
    white: <span class="string">"fff"</span>,
    whitesmoke: <span class="string">"f5f5f5"</span>,
    yellow: <span class="string">"ff0"</span>,
    yellowgreen: <span class="string">"9acd32"</span>
};</pre></div></div>
              
            </li>
          
            <li id="section-145">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-145">&#182;</a>
                </div>
                <p>Make it easy to access colors via <code>hexNames[hex]</code></p>

              </div>
              
                <div class="content"><div class='highlight'><pre><span class="keyword">var</span> hexNames = tinycolor.hexNames = flip(names);</pre></div></div>
              
            </li>
          
            <li id="section-146">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-146">&#182;</a>
                </div>
                <h2>Utilities</h2>

              </div>
              
              
            </li>
          
            <li id="section-147">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-147">&#182;</a>
                </div>
                <p><code>{ &#39;name1&#39;: &#39;val1&#39; }</code> becomes <code>{ &#39;val1&#39;: &#39;name1&#39; }</code></p>

              </div>
              
                <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">flip</span><span class="params">(o)</span> {</span>
    <span class="keyword">var</span> flipped = { };
    <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> o) {
        <span class="keyword">if</span> (o.hasOwnProperty(i)) {
            flipped[o[i]] = i;
        }
    }
    <span class="keyword">return</span> flipped;
}</pre></div></div>
              
            </li>
          
            <li id="section-148">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-148">&#182;</a>
                </div>
                <p>Take input from [0, n] and return it as [0, 1]</p>

              </div>
              
                <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">bound01</span><span class="params">(n, max)</span> {</span>
    <span class="keyword">if</span> (isOnePointZero(n)) { n = <span class="string">"100%"</span>; }

    <span class="keyword">var</span> processPercent = isPercentage(n);
    n = mathMin(max, mathMax(<span class="number">0</span>, parseFloat(n)));</pre></div></div>
              
            </li>
          
            <li id="section-149">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-149">&#182;</a>
                </div>
                <p>Automatically convert percentage into number</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (processPercent) {
        n = parseInt(n * max, <span class="number">10</span>) / <span class="number">100</span>;
    }</pre></div></div>
              
            </li>
          
            <li id="section-150">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-150">&#182;</a>
                </div>
                <p>Handle floating point rounding errors</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> ((math.abs(n - max) &lt; <span class="number">0.000001</span>)) {
        <span class="keyword">return</span> <span class="number">1</span>;
    }</pre></div></div>
              
            </li>
          
            <li id="section-151">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-151">&#182;</a>
                </div>
                <p>Convert into [0, 1] range if it isn&#39;t already</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span> (n % max) / parseFloat(max);
}</pre></div></div>
              
            </li>
          
            <li id="section-152">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-152">&#182;</a>
                </div>
                <p>Force a number between 0 and 1</p>

              </div>
              
                <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">clamp01</span><span class="params">(val)</span> {</span>
    <span class="keyword">return</span> mathMin(<span class="number">1</span>, mathMax(<span class="number">0</span>, val));
}</pre></div></div>
              
            </li>
          
            <li id="section-153">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-153">&#182;</a>
                </div>
                <p>Parse an integer into hex</p>

              </div>
              
                <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">parseHex</span><span class="params">(val)</span> {</span>
    <span class="keyword">return</span> parseInt(val, <span class="number">16</span>);
}</pre></div></div>
              
            </li>
          
            <li id="section-154">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-154">&#182;</a>
                </div>
                <p>Need to handle 1.0 as 100%, since once it is a number, there is no difference between it and 1
<a href="http://stackoverflow.com/questions/7422072/javascript-how-to-detect-number-as-a-decimal-including-1-0">http://stackoverflow.com/questions/7422072/javascript-how-to-detect-number-as-a-decimal-including-1-0</a></p>

              </div>
              
                <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">isOnePointZero</span><span class="params">(n)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">typeof</span> n == <span class="string">"string"</span> &amp;&amp; n.indexOf(<span class="string">'.'</span>) != -<span class="number">1</span> &amp;&amp; parseFloat(n) === <span class="number">1</span>;
}</pre></div></div>
              
            </li>
          
            <li id="section-155">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-155">&#182;</a>
                </div>
                <p>Check to see if string passed in is a percentage</p>

              </div>
              
                <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">isPercentage</span><span class="params">(n)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">typeof</span> n === <span class="string">"string"</span> &amp;&amp; n.indexOf(<span class="string">'%'</span>) != -<span class="number">1</span>;
}</pre></div></div>
              
            </li>
          
            <li id="section-156">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-156">&#182;</a>
                </div>
                <p>Force a hex value to have 2 characters</p>

              </div>
              
                <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">pad2</span><span class="params">(c)</span> {</span>
    <span class="keyword">return</span> c.length == <span class="number">1</span> ? <span class="string">'0'</span> + c : <span class="string">''</span> + c;
}</pre></div></div>
              
            </li>
          
            <li id="section-157">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-157">&#182;</a>
                </div>
                <p>Replace a decimal with it&#39;s percentage value</p>

              </div>
              
                <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">convertToPercentage</span><span class="params">(n)</span> {</span>
    <span class="keyword">if</span> (n &lt;= <span class="number">1</span>) {
        n = (n * <span class="number">100</span>) + <span class="string">"%"</span>;
    }

    <span class="keyword">return</span> n;
}

<span class="keyword">var</span> matchers = (<span class="keyword">function</span>() {</pre></div></div>
              
            </li>
          
            <li id="section-158">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-158">&#182;</a>
                </div>
                <p><a href="http://www.w3.org/TR/css3-values/#integers">http://www.w3.org/TR/css3-values/#integers</a></p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> CSS_INTEGER = <span class="string">"[-\\+]?\\d+%?"</span>;</pre></div></div>
              
            </li>
          
            <li id="section-159">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-159">&#182;</a>
                </div>
                <p><a href="http://www.w3.org/TR/css3-values/#number-value">http://www.w3.org/TR/css3-values/#number-value</a></p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> CSS_NUMBER = <span class="string">"[-\\+]?\\d*\\.\\d+%?"</span>;</pre></div></div>
              
            </li>
          
            <li id="section-160">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-160">&#182;</a>
                </div>
                <p>Allow positive/negative integer/number.  Don&#39;t capture the either/or, just the entire outcome.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> CSS_UNIT = <span class="string">"(?:"</span> + CSS_NUMBER + <span class="string">")|(?:"</span> + CSS_INTEGER + <span class="string">")"</span>;</pre></div></div>
              
            </li>
          
            <li id="section-161">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-161">&#182;</a>
                </div>
                <p>Actual matching.
Parentheses and commas are optional, but not required.
Whitespace can take the place of commas or opening paren</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> PERMISSIVE_MATCH3 = <span class="string">"[\\s|\\(]+("</span> + CSS_UNIT + <span class="string">")[,|\\s]+("</span> + CSS_UNIT + <span class="string">")[,|\\s]+("</span> + CSS_UNIT + <span class="string">")\\s*\\)?"</span>;
    <span class="keyword">var</span> PERMISSIVE_MATCH4 = <span class="string">"[\\s|\\(]+("</span> + CSS_UNIT + <span class="string">")[,|\\s]+("</span> + CSS_UNIT + <span class="string">")[,|\\s]+("</span> + CSS_UNIT + <span class="string">")[,|\\s]+("</span> + CSS_UNIT + <span class="string">")\\s*\\)?"</span>;

    <span class="keyword">return</span> {
        rgb: <span class="keyword">new</span> RegExp(<span class="string">"rgb"</span> + PERMISSIVE_MATCH3),
        rgba: <span class="keyword">new</span> RegExp(<span class="string">"rgba"</span> + PERMISSIVE_MATCH4),
        hsl: <span class="keyword">new</span> RegExp(<span class="string">"hsl"</span> + PERMISSIVE_MATCH3),
        hsla: <span class="keyword">new</span> RegExp(<span class="string">"hsla"</span> + PERMISSIVE_MATCH4),
        hsv: <span class="keyword">new</span> RegExp(<span class="string">"hsv"</span> + PERMISSIVE_MATCH3),
        hex3: <span class="regexp">/^([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/</span>,
        hex6: <span class="regexp">/^([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/</span>
    };
})();</pre></div></div>
              
            </li>
          
            <li id="section-162">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-162">&#182;</a>
                </div>
                <p><code>stringInputToObject</code>
Permissive string parsing.  Take in a number of formats, and output an object
based on detected format.  Returns <code>{ r, g, b }</code> or <code>{ h, s, l }</code> or <code>{ h, s, v}</code></p>

              </div>
              
                <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">stringInputToObject</span><span class="params">(color)</span> {</span>

    color = color.replace(trimLeft,<span class="string">''</span>).replace(trimRight, <span class="string">''</span>).toLowerCase();
    <span class="keyword">var</span> named = <span class="literal">false</span>;
    <span class="keyword">if</span> (names[color]) {
        color = names[color];
        named = <span class="literal">true</span>;
    }
    <span class="keyword">else</span> <span class="keyword">if</span> (color == <span class="string">'transparent'</span>) {
        <span class="keyword">return</span> { r: <span class="number">0</span>, g: <span class="number">0</span>, b: <span class="number">0</span>, a: <span class="number">0</span> };
    }</pre></div></div>
              
            </li>
          
            <li id="section-163">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-163">&#182;</a>
                </div>
                <p>Try to match string input using regular expressions.
Keep most of the number bounding out of this function - don&#39;t worry about [0,1] or [0,100] or [0,360]
Just return an object and let the conversion functions handle that.
This way the result will be the same whether the tinycolor is initialized with string or object.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> match;
    <span class="keyword">if</span> ((match = matchers.rgb.exec(color))) {
        <span class="keyword">return</span> { r: match[<span class="number">1</span>], g: match[<span class="number">2</span>], b: match[<span class="number">3</span>] };
    }
    <span class="keyword">if</span> ((match = matchers.rgba.exec(color))) {
        <span class="keyword">return</span> { r: match[<span class="number">1</span>], g: match[<span class="number">2</span>], b: match[<span class="number">3</span>], a: match[<span class="number">4</span>] };
    }
    <span class="keyword">if</span> ((match = matchers.hsl.exec(color))) {
        <span class="keyword">return</span> { h: match[<span class="number">1</span>], s: match[<span class="number">2</span>], l: match[<span class="number">3</span>] };
    }
    <span class="keyword">if</span> ((match = matchers.hsla.exec(color))) {
        <span class="keyword">return</span> { h: match[<span class="number">1</span>], s: match[<span class="number">2</span>], l: match[<span class="number">3</span>], a: match[<span class="number">4</span>] };
    }
    <span class="keyword">if</span> ((match = matchers.hsv.exec(color))) {
        <span class="keyword">return</span> { h: match[<span class="number">1</span>], s: match[<span class="number">2</span>], v: match[<span class="number">3</span>] };
    }
    <span class="keyword">if</span> ((match = matchers.hex6.exec(color))) {
        <span class="keyword">return</span> {
            r: parseHex(match[<span class="number">1</span>]),
            g: parseHex(match[<span class="number">2</span>]),
            b: parseHex(match[<span class="number">3</span>]),
            format: named ? <span class="string">"name"</span> : <span class="string">"hex"</span>
        };
    }
    <span class="keyword">if</span> ((match = matchers.hex3.exec(color))) {
        <span class="keyword">return</span> {
            r: parseHex(match[<span class="number">1</span>] + <span class="string">''</span> + match[<span class="number">1</span>]),
            g: parseHex(match[<span class="number">2</span>] + <span class="string">''</span> + match[<span class="number">2</span>]),
            b: parseHex(match[<span class="number">3</span>] + <span class="string">''</span> + match[<span class="number">3</span>]),
            format: named ? <span class="string">"name"</span> : <span class="string">"hex"</span>
        };
    }

    <span class="keyword">return</span> <span class="literal">false</span>;
}</pre></div></div>
              
            </li>
          
            <li id="section-164">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-164">&#182;</a>
                </div>
                <p>Node: Export function</p>

              </div>
              
                <div class="content"><div class='highlight'><pre><span class="keyword">if</span> (<span class="keyword">typeof</span> module !== <span class="string">"undefined"</span> &amp;&amp; module.exports) {
    module.exports = tinycolor;
}</pre></div></div>
              
            </li>
          
            <li id="section-165">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-165">&#182;</a>
                </div>
                <p>AMD/requirejs: Define the module</p>

              </div>
              
                <div class="content"><div class='highlight'><pre><span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> define !== <span class="string">"undefined"</span>) {
    define(<span class="string">'tinycolor'</span>,[],<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span><span class="keyword">return</span> tinycolor;});
}</pre></div></div>
              
            </li>
          
            <li id="section-166">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-166">&#182;</a>
                </div>
                <p>Browser: Expose to window</p>

              </div>
              
                <div class="content"><div class='highlight'><pre><span class="keyword">else</span> {
    root.tinycolor = tinycolor;
}

})(<span class="keyword">this</span>);

<span class="comment">/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>

define(<span class="string">'elementFinder'</span>,[<span class="string">"util"</span>, <span class="string">"jquery"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(util, $)</span> {</span>
  <span class="keyword">var</span> elementFinder = util.Module(<span class="string">"elementFinder"</span>);
  <span class="keyword">var</span> assert = util.assert;

  elementFinder.ignoreElement = <span class="function"><span class="keyword">function</span> <span class="title">ignoreElement</span><span class="params">(el)</span> {</span>
    <span class="keyword">if</span> (el <span class="keyword">instanceof</span> $) {
      el = el[<span class="number">0</span>];
    }
    <span class="keyword">while</span> (el) {
      <span class="keyword">if</span> ($(el).hasClass(<span class="string">"towtruck"</span>)) {
        <span class="keyword">return</span> <span class="literal">true</span>;
      }
      el = el.parentNode;
    }
    <span class="keyword">return</span> <span class="literal">false</span>;
  };

  elementFinder.elementLocation = <span class="function"><span class="keyword">function</span> <span class="title">elementLocation</span><span class="params">(el)</span> {</span>
    assert(el !== <span class="literal">null</span>, <span class="string">"Got null element"</span>);
    <span class="keyword">if</span> (el <span class="keyword">instanceof</span> $) {</pre></div></div>
              
            </li>
          
            <li id="section-167">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-167">&#182;</a>
                </div>
                <p>a jQuery element</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      el = el[<span class="number">0</span>];
    }
    <span class="keyword">if</span> (el.id) {
      <span class="keyword">return</span> <span class="string">"#"</span> + el.id;
    }
    <span class="keyword">if</span> (el.tagName == <span class="string">"BODY"</span>) {
      <span class="keyword">return</span> <span class="string">"body"</span>;
    }
    <span class="keyword">if</span> (el.tagName == <span class="string">"HEAD"</span>) {
      <span class="keyword">return</span> <span class="string">"head"</span>;
    }
    <span class="keyword">if</span> (el === document) {
      <span class="keyword">return</span> <span class="string">"document"</span>;
    }
    <span class="keyword">var</span> parent = el.parentNode;
    <span class="keyword">if</span> (! parent) {
      console.warn(<span class="string">"elementLocation("</span>, el, <span class="string">") has null parent"</span>);
      <span class="keyword">throw</span> <span class="string">"No locatable parent found"</span>;
    }
    <span class="keyword">var</span> parentLocation = elementLocation(parent);
    <span class="keyword">var</span> children = parent.childNodes;
    <span class="keyword">var</span> index = <span class="number">0</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;children.length; i++) {
      <span class="keyword">if</span> (children[i] == el) {
        <span class="keyword">break</span>;
      }
      <span class="keyword">if</span> (children[i].nodeType == document.ELEMENT_NODE) {
        <span class="keyword">if</span> (children[i].className.indexOf(<span class="string">"towtruck"</span>) != -<span class="number">1</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-168">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-168">&#182;</a>
                </div>
                <p>Don&#39;t count our UI</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>          <span class="keyword">continue</span>;
        }</pre></div></div>
              
            </li>
          
            <li id="section-169">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-169">&#182;</a>
                </div>
                <p>Don&#39;t count text or comments</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        index++;
      }
    }
    <span class="keyword">return</span> parentLocation + <span class="string">":nth-child("</span> + (index+<span class="number">1</span>) + <span class="string">")"</span>;
  };

  elementFinder.CannotFind = util.Class({
    constructor: <span class="function"><span class="keyword">function</span> <span class="title">CannotFind</span><span class="params">(location, reason, context)</span> {</span>
      <span class="keyword">this</span>.prefix = <span class="string">""</span>;
      <span class="keyword">this</span>.location = location;
      <span class="keyword">this</span>.reason = reason;
      <span class="keyword">this</span>.context = context;
    },
    toString: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">var</span> loc;
      <span class="keyword">try</span> {
        loc = elementFinder.elementLocation(<span class="keyword">this</span>.context);
      } <span class="keyword">catch</span> (e) {
        loc = <span class="keyword">this</span>.context;
      }
      <span class="keyword">return</span> (
        <span class="string">"[CannotFind "</span> + <span class="keyword">this</span>.prefix +
          <span class="string">"("</span> + <span class="keyword">this</span>.location + <span class="string">"): "</span> +
          <span class="keyword">this</span>.reason + <span class="string">" in "</span> +
          loc + <span class="string">"]"</span>);
    }
  });

  elementFinder.findElement = <span class="function"><span class="keyword">function</span> <span class="title">findElement</span><span class="params">(loc, container)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-170">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-170">&#182;</a>
                </div>
                <p>FIXME: should this all just be done with document.querySelector()?
But no!  We can&#39;t ignore towtruck elements with querySelector.
But maybe!  We <em>could</em> make towtruck elements less obtrusive?</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    container = container || document;
    <span class="keyword">var</span> el, rest;
    <span class="keyword">if</span> (loc === <span class="string">"body"</span>) {
      <span class="keyword">return</span> document.body;
    } <span class="keyword">else</span> <span class="keyword">if</span> (loc === <span class="string">"head"</span>) {
      <span class="keyword">return</span> document.head;
    } <span class="keyword">else</span> <span class="keyword">if</span> (loc === <span class="string">"document"</span>) {
      <span class="keyword">return</span> document;
    } <span class="keyword">else</span> <span class="keyword">if</span> (loc.indexOf(<span class="string">"body"</span>) === <span class="number">0</span>) {
      el = document.body;
      <span class="keyword">try</span> {
        <span class="keyword">return</span> findElement(loc.substr((<span class="string">"body"</span>).length), el);
      } <span class="keyword">catch</span> (e) {
        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> elementFinder.CannotFind) {
          e.prefix = <span class="string">"body"</span> + e.prefix;
        }
        <span class="keyword">throw</span> e;
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (loc.indexOf(<span class="string">"head"</span>) === <span class="number">0</span>) {
      el = document.head;
      <span class="keyword">try</span> {
        <span class="keyword">return</span> findElement(loc.substr((<span class="string">"head"</span>).length), el);
      } <span class="keyword">catch</span> (e) {
        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> elementFinder.CannotFind) {
          e.prefix = <span class="string">"head"</span> + e.prefix;
        }
        <span class="keyword">throw</span> e;
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (loc.indexOf(<span class="string">"#"</span>) === <span class="number">0</span>) {
      <span class="keyword">var</span> id;
      loc = loc.substr(<span class="number">1</span>);
      <span class="keyword">if</span> (loc.indexOf(<span class="string">":"</span>) === -<span class="number">1</span>) {
        id = loc;
        rest = <span class="string">""</span>;
      } <span class="keyword">else</span> {
        id = loc.substr(<span class="number">0</span>, loc.indexOf(<span class="string">":"</span>));
        rest = loc.substr(loc.indexOf(<span class="string">":"</span>));
      }
      el = document.getElementById(id);
      <span class="keyword">if</span> (! el) {
        <span class="keyword">throw</span> elementFinder.CannotFind(<span class="string">"#"</span> + id, <span class="string">"No element by that id"</span>, container);
      }
      <span class="keyword">if</span> (rest) {
        <span class="keyword">try</span> {
          <span class="keyword">return</span> findElement(rest, el);
        } <span class="keyword">catch</span> (e) {
          <span class="keyword">if</span> (e <span class="keyword">instanceof</span> elementFinder.CannotFind) {
            e.prefix = <span class="string">"#"</span> + id + e.prefix;
          }
          <span class="keyword">throw</span> e;
        }
      } <span class="keyword">else</span> {
        <span class="keyword">return</span> el;
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (loc.indexOf(<span class="string">":nth-child("</span>) === <span class="number">0</span>) {
      loc = loc.substr((<span class="string">":nth-child("</span>).length);
      <span class="keyword">if</span> (loc.indexOf(<span class="string">")"</span>) == -<span class="number">1</span>) {
        <span class="keyword">throw</span> <span class="string">"Invalid location, missing ): "</span> + loc;
      }
      <span class="keyword">var</span> num = loc.substr(<span class="number">0</span>, loc.indexOf(<span class="string">")"</span>));
      num = parseInt(num, <span class="number">10</span>);
      <span class="keyword">var</span> count = num;
      loc = loc.substr(loc.indexOf(<span class="string">")"</span>) + <span class="number">1</span>);
      <span class="keyword">var</span> children = container.childNodes;
      el = <span class="literal">null</span>;
      <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;children.length; i++) {
        <span class="keyword">var</span> child = children[i];
        <span class="keyword">if</span> (child.nodeType == document.ELEMENT_NODE) {
          <span class="keyword">if</span> (child.className.indexOf(<span class="string">"towtruck"</span>) != -<span class="number">1</span>) {
            <span class="keyword">continue</span>;
          }
          count--;
          <span class="keyword">if</span> (count === <span class="number">0</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-171">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-171">&#182;</a>
                </div>
                <p>this is the element</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>            el = child;
            <span class="keyword">break</span>;
          }
        }
      }
      <span class="keyword">if</span> (! el) {
        <span class="keyword">throw</span> elementFinder.CannotFind(<span class="string">":nth-child("</span> + num + <span class="string">")"</span>, <span class="string">"container only has "</span> + (num - count) + <span class="string">" elements"</span>, container);
      }
      <span class="keyword">if</span> (loc) {
        <span class="keyword">try</span> {
          <span class="keyword">return</span> elementFinder.findElement(loc, el);
        } <span class="keyword">catch</span> (e) {
          <span class="keyword">if</span> (e <span class="keyword">instanceof</span> elementFinder.CannotFind) {
            e.prefix = <span class="string">":nth-child("</span> + num + <span class="string">")"</span> + e.prefix;
          }
          <span class="keyword">throw</span> e;
        }
      } <span class="keyword">else</span> {
        <span class="keyword">return</span> el;
      }
    } <span class="keyword">else</span> {
      <span class="keyword">throw</span> elementFinder.CannotFind(loc, <span class="string">"Malformed location"</span>, container);
    }
  };

  elementFinder.elementByPixel = <span class="function"><span class="keyword">function</span> <span class="params">(height)</span> {</span>
    <span class="comment">/* Returns {location: "...", offset: pixels}

       To get the pixel position back, you'd do:
         $(location).offset().top + offset
     */</span>
    <span class="function"><span class="keyword">function</span> <span class="title">search</span><span class="params">(start, height)</span> {</span>
      <span class="keyword">var</span> last = <span class="literal">null</span>;
      <span class="keyword">var</span> children = start.children();
      children.each(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">var</span> el = $(<span class="keyword">this</span>);
        <span class="keyword">if</span> (el.hasClass(<span class="string">"towtruck"</span>) || el.css(<span class="string">"position"</span>) == <span class="string">"fixed"</span> || ! el.is(<span class="string">":visible"</span>)) {
          <span class="keyword">return</span>;
        }
        <span class="keyword">if</span> (el.offset().top &gt; height) {
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
        last = el;
      });
      <span class="keyword">if</span> ((! children.length) || (! last)) {</pre></div></div>
              
            </li>
          
            <li id="section-172">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-172">&#182;</a>
                </div>
                <p>There are no children, or only inapplicable children</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> {
          location: elementFinder.elementLocation(start[<span class="number">0</span>]),
          offset: height - start.offset().top,
          absoluteTop: height,
          documentHeight: $(document).height()
        };
      }
      <span class="keyword">return</span> search(last, height);
    }
    <span class="keyword">return</span> search($(document.body), height);
  };

  elementFinder.pixelForPosition = <span class="function"><span class="keyword">function</span> <span class="params">(position)</span> {</span>
    <span class="comment">/* Inverse of elementFinder.elementByPixel */</span>
    <span class="keyword">if</span> (position.location == <span class="string">"body"</span>) {
      <span class="keyword">return</span> position.offset;
    }
    <span class="keyword">var</span> el;
    <span class="keyword">try</span> {
      el = elementFinder.findElement(position.location);
    } <span class="keyword">catch</span> (e) {
      <span class="keyword">if</span> (e <span class="keyword">instanceof</span> elementFinder.CannotFind &amp;&amp; position.absoluteTop) {</pre></div></div>
              
            </li>
          
            <li id="section-173">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-173">&#182;</a>
                </div>
                <p>We don&#39;t trust absoluteTop to be quite right locally, so we adjust
for the total document height differences:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> percent = position.absoluteTop / position.documentHeight;
        <span class="keyword">return</span> $(document).height() * percent;
      }
      <span class="keyword">throw</span> e;
    }
    <span class="keyword">var</span> top = $(el).offset().top;</pre></div></div>
              
            </li>
          
            <li id="section-174">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-174">&#182;</a>
                </div>
                <p>FIXME: maybe here we should test for sanity, like if an element is
hidden.  We can use position.absoluteTop to get a sense of where the
element roughly should be.  If the sanity check failed we&#39;d use
absoluteTop</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span> top + position.offset;
  };

  <span class="keyword">return</span> elementFinder;

});

<span class="comment">/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>

define(<span class="string">'ui'</span>,[<span class="string">"require"</span>, <span class="string">"jquery"</span>, <span class="string">"util"</span>, <span class="string">"session"</span>, <span class="string">"templates"</span>, <span class="string">"templating"</span>, <span class="string">"linkify"</span>, <span class="string">"peers"</span>, <span class="string">"windowing"</span>, <span class="string">"tinycolor"</span>, <span class="string">"elementFinder"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(require, $, util, session, templates, templating, linkify, peers, windowing, tinycolor, elementFinder)</span> {</span>
  <span class="keyword">var</span> ui = util.Module(<span class="string">'ui'</span>);
  <span class="keyword">var</span> assert = util.assert;
  <span class="keyword">var</span> AssertionError = util.AssertionError;
  <span class="keyword">var</span> chat;
  <span class="keyword">var</span> $window = $(window);</pre></div></div>
              
            </li>
          
            <li id="section-175">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-175">&#182;</a>
                </div>
                <p>This is also in towtruck.less, as @button-height:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> BUTTON_HEIGHT = <span class="number">60</span> + <span class="number">1</span>; <span class="comment">// 60 is button height, 1 is border</span></pre></div></div>
              
            </li>
          
            <li id="section-176">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-176">&#182;</a>
                </div>
                <p>This is also in towtruck.less, under .towtruck-animated</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> ANIMATION_DURATION = <span class="number">1000</span>;</pre></div></div>
              
            </li>
          
            <li id="section-177">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-177">&#182;</a>
                </div>
                <p>Time the new user window sticks around until it fades away:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> NEW_USER_FADE_TIMEOUT = <span class="number">5000</span>;</pre></div></div>
              
            </li>
          
            <li id="section-178">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-178">&#182;</a>
                </div>
                <p>This is set when an animation will keep the UI from being ready
(until this time):</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> finishedAt = <span class="literal">null</span>;</pre></div></div>
              
            </li>
          
            <li id="section-179">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-179">&#182;</a>
                </div>
                <p>Time in milliseconds for the dock to animate out:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> DOCK_ANIMATION_TIME = <span class="number">300</span>;</pre></div></div>
              
            </li>
          
            <li id="section-180">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-180">&#182;</a>
                </div>
                <p>If two chat messages come from the same person in this time
(milliseconds) then they are collapsed into one message:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> COLLAPSE_MESSAGE_LIMIT = <span class="number">5000</span>;

  <span class="keyword">var</span> COLORS = [
    <span class="string">"#8A2BE2"</span>, <span class="string">"#7FFF00"</span>, <span class="string">"#DC143C"</span>, <span class="string">"#00FFFF"</span>, <span class="string">"#8FBC8F"</span>, <span class="string">"#FF8C00"</span>, <span class="string">"#FF00FF"</span>,
    <span class="string">"#FFD700"</span>, <span class="string">"#F08080"</span>, <span class="string">"#90EE90"</span>, <span class="string">"#FF6347"</span>];</pre></div></div>
              
            </li>
          
            <li id="section-181">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-181">&#182;</a>
                </div>
                <p>This would be a circular import, but we just need the chat module sometime
after everything is loaded, and this is sure to complete by that time:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  require([<span class="string">"chat"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(c)</span> {</span>
    chat = c;
  });

  <span class="comment">/* Displays some toggleable element; toggleable elements have a
     data-toggles attribute that indicates what other elements should
     be hidden when this element is shown. */</span>
  ui.displayToggle = <span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
    el = $(el);
    assert(el.length, <span class="string">"No element"</span>, arguments[<span class="number">0</span>]);
    <span class="keyword">var</span> other = $(el.attr(<span class="string">"data-toggles"</span>));
    assert(other.length, <span class="string">"Cannot toggle"</span>, el[<span class="number">0</span>], <span class="string">"selector"</span>, other.selector);
    other.hide();
    el.show();
  };

  <span class="function"><span class="keyword">function</span> <span class="title">panelPosition</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> iface = $(<span class="string">"#towtruck-dock"</span>);
    <span class="keyword">if</span> (iface.hasClass(<span class="string">"towtruck-dock-right"</span>)) {
      <span class="keyword">return</span> <span class="string">"right"</span>;
    } <span class="keyword">else</span> <span class="keyword">if</span> (iface.hasClass(<span class="string">"towtruck-dock-left"</span>)) {
      <span class="keyword">return</span> <span class="string">"left"</span>;
    } <span class="keyword">else</span> <span class="keyword">if</span> (iface.hasClass(<span class="string">"towtruck-dock-bottom"</span>)) {
      <span class="keyword">return</span> <span class="string">"bottom"</span>;
    } <span class="keyword">else</span> {
      <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"#towtruck-dock doesn't have positioning class"</span>);
    }
  }

  ui.container = <span class="literal">null</span>;</pre></div></div>
              
            </li>
          
            <li id="section-182">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-182">&#182;</a>
                </div>
                <p>This is used for some signalling when ui.prepareUI and/or
ui.activateUI is called before the DOM is fully loaded:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> deferringPrepareUI = <span class="literal">null</span>;

  <span class="function"><span class="keyword">function</span> <span class="title">deferForContainer</span><span class="params">(func)</span> {</span>
    <span class="comment">/* Defers any calls to func() until after ui.container is set
       Function cannot have a return value (as sometimes the call will
       become async).  Use like:

       method: deferForContainer(function (args) {...})
       */</span>
    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">if</span> (ui.container) {
        func.apply(<span class="keyword">this</span>, arguments);
      }
      <span class="keyword">var</span> self = <span class="keyword">this</span>;
      <span class="keyword">var</span> args = Array.prototype.slice.call(arguments);
      session.once(<span class="string">"ui-ready"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        func.apply(self, args);
      });
    };
  }</pre></div></div>
              
            </li>
          
            <li id="section-183">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-183">&#182;</a>
                </div>
                <p>This is called before activateUI; it doesn&#39;t bind anything, but does display
the dock
FIXME: because this module has lots of requirements we can&#39;t do
this before those requirements are loaded.  Maybe worth splitting
this out?  OTOH, in production we should have all the files
combined so there&#39;s not much problem loading those modules.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  ui.prepareUI = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">if</span> (! (document.readyState == <span class="string">"complete"</span> || document.readyState == <span class="string">"interactive"</span>)) {</pre></div></div>
              
            </li>
          
            <li id="section-184">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-184">&#182;</a>
                </div>
                <p>Too soon!  Wait a sec...</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      deferringPrepareUI = <span class="string">"deferring"</span>;
      document.addEventListener(<span class="string">"DOMContentLoaded"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">var</span> d = deferringPrepareUI;
        deferringPrepareUI = <span class="literal">null</span>;
        ui.prepareUI();</pre></div></div>
              
            </li>
          
            <li id="section-185">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-185">&#182;</a>
                </div>
                <p>This happens when ui.activateUI is called before the document has been
loaded:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (d == <span class="string">"activate"</span>) {
          ui.activateUI();
        }
      });
      <span class="keyword">return</span>;
    }
    <span class="keyword">var</span> container = ui.container = $(templates[<span class="string">"interface"</span>]);
    assert(container.length);
    $(<span class="string">"body"</span>).append(container);
    fixupAvatars(container);
    <span class="keyword">if</span> (session.firstRun &amp;&amp; TowTruck.startTarget) {</pre></div></div>
              
            </li>
          
            <li id="section-186">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-186">&#182;</a>
                </div>
                <p>Time at which the UI will be fully ready:
(We have to do this because the offset won&#39;t be quite right
until the animation finishes - attempts to calculate the
offset without taking into account CSS transforms have so far
failed.)</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> timeoutSeconds = DOCK_ANIMATION_TIME / <span class="number">1000</span>;
      finishedAt = Date.now() + DOCK_ANIMATION_TIME + <span class="number">50</span>;
      setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        finishedAt = Date.now() + DOCK_ANIMATION_TIME + <span class="number">40</span>;
        <span class="keyword">var</span> iface = container.find(<span class="string">"#towtruck-dock"</span>);
        <span class="keyword">var</span> start = iface.offset();
        <span class="keyword">var</span> pos = $(TowTruck.startTarget).offset();
        pos.top = Math.floor(pos.top - start.top);
        pos.left = Math.floor(pos.left - start.left);
        <span class="keyword">var</span> translate = <span class="string">"translate("</span> + pos.left + <span class="string">"px, "</span> + pos.top + <span class="string">"px)"</span>;
        iface.css({
          MozTransform: translate,
          WebkitTransform: translate,
          transform: translate,
          opacity: <span class="string">"0.0"</span>
        });
        setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-187">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-187">&#182;</a>
                </div>
                <p>We keep recalculating because the setTimeout times aren&#39;t always so accurate:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>          finishedAt = Date.now() + DOCK_ANIMATION_TIME + <span class="number">20</span>;
          <span class="keyword">var</span> transition = <span class="string">"transform "</span> + timeoutSeconds + <span class="string">"s ease-out, "</span>;
          transition += <span class="string">"opacity "</span> + timeoutSeconds + <span class="string">"s ease-out"</span>;
          iface.css({
            opacity: <span class="string">"1.0"</span>,
            MozTransition: <span class="string">"-moz-"</span> + transition,
            MozTransform: <span class="string">"translate(0, 0)"</span>,
            WebkitTransition: <span class="string">"-webkit-"</span> + transition,
            WebkitTransform: <span class="string">"translate(0, 0)"</span>,
            transition: transition,
            transform: <span class="string">"translate(0, 0)"</span>
          });
          setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            finishedAt = <span class="literal">null</span>;
            iface.attr(<span class="string">"style"</span>, <span class="string">""</span>);
          }, <span class="number">510</span>);
        }, <span class="number">5</span>);
      }, <span class="number">5</span>);
    }
    <span class="keyword">if</span> (TowTruck.startTarget) {
      <span class="keyword">var</span> el = $(TowTruck.startTarget);
      <span class="keyword">var</span> text = el.text().toLowerCase().replace(<span class="regexp">/\s+/g</span>, <span class="string">" "</span>);
      text = text.replace(<span class="regexp">/^\s*/</span>, <span class="string">""</span>).replace(<span class="regexp">/\s*$/</span>, <span class="string">""</span>);
      <span class="keyword">if</span> (text == <span class="string">"start towtruck"</span>) {
        el.attr(<span class="string">"data-end-towtruck-html"</span>, <span class="string">"End TowTruck"</span>);
      }
      <span class="keyword">if</span> (el.attr(<span class="string">"data-end-towtruck-html"</span>)) {
        el.attr(<span class="string">"data-start-towtruck-html"</span>, el.html());
        el.html(el.attr(<span class="string">"data-end-towtruck-html"</span>));
      }
      el.addClass(<span class="string">"towtruck-started"</span>);
    }
    ui.container.find(<span class="string">".towtruck-window &gt; header, .towtruck-modal &gt; header"</span>).each(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      $(<span class="keyword">this</span>).append($(<span class="string">'&lt;button class="towtruck-close"&gt;&lt;/button&gt;'</span>));
    });
  };</pre></div></div>
              
            </li>
          
            <li id="section-188">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-188">&#182;</a>
                </div>
                <p>After prepareUI, this actually makes the interface live.  We have
to do this later because we call prepareUI when many components
aren&#39;t initialized, so we don&#39;t even want the user to be able to
interact with the interface.  But activateUI is called once
everything is loaded and ready for interaction.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  ui.activateUI = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">if</span> (deferringPrepareUI) {
      console.warn(<span class="string">"ui.activateUI called before document is ready; waiting..."</span>);
      deferringPrepareUI = <span class="string">"activate"</span>;
      <span class="keyword">return</span>;
    }
    <span class="keyword">if</span> (! ui.container) {
      ui.prepareUI();
    }
    <span class="keyword">var</span> container = ui.container;</pre></div></div>
              
            </li>
          
            <li id="section-189">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-189">&#182;</a>
                </div>
                <p>create the overlay</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span>($.browser.mobile) {</pre></div></div>
              
            </li>
          
            <li id="section-190">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-190">&#182;</a>
                </div>
                <p>$(&quot;body&quot;).append( &quot;<div class='overlay' style='position: absolute; top: 0; left: 0; background-color: rgba(0,0,0,0); width: 120%; height: 100%; z-index: 1000; margin: -10px'></div>&quot; );</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    }</pre></div></div>
              
            </li>
          
            <li id="section-191">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-191">&#182;</a>
                </div>
                <p>The share link:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    ui.prepareShareLink(container);
    container.find(<span class="string">"input.towtruck-share-link"</span>).on(<span class="string">"keydown"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(event)</span> {</span>
      <span class="keyword">if</span> (event.which == <span class="number">27</span>) {
        windowing.hide(<span class="string">"#towtruck-share"</span>);
        <span class="keyword">return</span> <span class="literal">false</span>;
      }
      <span class="keyword">return</span> <span class="literal">undefined</span>;
    });
    session.on(<span class="string">"shareId"</span>, updateShareLink);</pre></div></div>
              
            </li>
          
            <li id="section-192">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-192">&#182;</a>
                </div>
                <p>The chat input element:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> input = container.find(<span class="string">"#towtruck-chat-input"</span>);
    input.bind(<span class="string">"keyup"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(event)</span> {</span>
      <span class="keyword">if</span> (event.which == <span class="number">13</span>) { <span class="comment">// Enter</span>
        submitChat();
        <span class="keyword">return</span> <span class="literal">false</span>;
      }
      <span class="keyword">if</span> (event.which == <span class="number">27</span>) { <span class="comment">// Escape</span>
        windowing.hide(<span class="string">"#towtruck-chat"</span>);
      }
      <span class="keyword">return</span> <span class="literal">false</span>;
    });

    <span class="function"><span class="keyword">function</span> <span class="title">submitChat</span><span class="params">()</span> {</span>
      <span class="keyword">var</span> val = input.val();
      <span class="keyword">if</span> (! val) {
        <span class="keyword">return</span>;
      }
      chat.submit(val);
      input.val(<span class="string">""</span>);
    }

    util.testExpose({submitChat: submitChat});</pre></div></div>
              
            </li>
          
            <li id="section-193">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-193">&#182;</a>
                </div>
                <p>Moving the window:
FIXME: this should probably be stickier, and not just move the window around
so abruptly</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> anchor = container.find(<span class="string">"#towtruck-dock-anchor"</span>);
    assert(anchor.length);</pre></div></div>
              
            </li>
          
            <li id="section-194">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-194">&#182;</a>
                </div>
                <p>FIXME: This is in place to temporarily disable dock dragging:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    anchor = container.find(<span class="string">"#towtruck-dock-anchor-disabled"</span>);
    anchor.mousedown(<span class="function"><span class="keyword">function</span> <span class="params">(event)</span> {</span>
      <span class="keyword">var</span> iface = $(<span class="string">"#towtruck-dock"</span>);</pre></div></div>
              
            </li>
          
            <li id="section-195">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-195">&#182;</a>
                </div>
                <p>FIXME: switch to .offset() and pageX/Y</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> startPos = panelPosition();
      <span class="function"><span class="keyword">function</span> <span class="title">selectoff</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> <span class="literal">false</span>;
      }
      <span class="function"><span class="keyword">function</span> <span class="title">mousemove</span><span class="params">(event2)</span> {</span>
        <span class="keyword">var</span> fromRight = $window.width() + window.pageXOffset - event2.pageX;
        <span class="keyword">var</span> fromLeft = event2.pageX - window.pageXOffset;
        <span class="keyword">var</span> fromBottom = $window.height() + window.pageYOffset - event2.pageY;</pre></div></div>
              
            </li>
          
            <li id="section-196">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-196">&#182;</a>
                </div>
                <p>FIXME: this is to temporarily disable the bottom view:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        fromBottom = <span class="number">10000</span>;

        <span class="keyword">var</span> pos;
        <span class="keyword">if</span> (fromLeft &lt; fromRight &amp;&amp; fromLeft &lt; fromBottom) {
          pos = <span class="string">"left"</span>;
        } <span class="keyword">else</span> <span class="keyword">if</span> (fromRight &lt; fromLeft &amp;&amp; fromRight &lt; fromBottom) {
          pos = <span class="string">"right"</span>;
        } <span class="keyword">else</span> {
          pos = <span class="string">"bottom"</span>;
        }
        iface.removeClass(<span class="string">"towtruck-dock-left"</span>);
        iface.removeClass(<span class="string">"towtruck-dock-right"</span>);
        iface.removeClass(<span class="string">"towtruck-dock-bottom"</span>);
        iface.addClass(<span class="string">"towtruck-dock-"</span> + pos);
        <span class="keyword">if</span> (startPos &amp;&amp; pos != startPos) {
          windowing.hide();
          startPos = <span class="literal">null</span>;
        }
      }
      $(document).bind(<span class="string">"mousemove"</span>, mousemove);</pre></div></div>
              
            </li>
          
            <li id="section-197">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-197">&#182;</a>
                </div>
                <p>If you don&#39;t turn selection off it will still select text, and show a
text selection cursor:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      $(document).bind(<span class="string">"selectstart"</span>, selectoff);</pre></div></div>
              
            </li>
          
            <li id="section-198">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-198">&#182;</a>
                </div>
                <p>FIXME: it seems like sometimes we lose the mouseup event, and it&#39;s as though
the mouse is stuck down:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      $(document).one(<span class="string">"mouseup"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        $(document).unbind(<span class="string">"mousemove"</span>, mousemove);
        $(document).unbind(<span class="string">"selectstart"</span>, selectoff);
      });
      <span class="keyword">return</span> <span class="literal">false</span>;
    });
    
    <span class="function"><span class="keyword">function</span> <span class="title">openDock</span><span class="params">()</span> {</span>
      console.log(<span class="string">"open Dock"</span>);
      
      $(<span class="string">'.towtruck-window'</span>).animate({
        opacity: <span class="number">1</span>
      });
      $(<span class="string">'#towtruck-dock-participants'</span>).animate({
        opacity: <span class="number">1</span>
      });
      $(<span class="string">'#towtruck-dock #towtruck-buttons'</span>).animate({
        opacity: <span class="number">1</span>
      });
      $(<span class="string">'.towtruck-dock-right'</span>).animate({
        width: <span class="string">"75%"</span>
      }, {
        duration:<span class="number">60</span>, easing:<span class="string">"linear"</span>
      });</pre></div></div>
              
            </li>
          
            <li id="section-199">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-199">&#182;</a>
                </div>
                <p>add bg overlay</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      $(<span class="string">"body"</span>).append( <span class="string">"&lt;div class='overlay' style='position: absolute; top: 0; left: 0; background-color: rgba(0,0,0,0.5); width: 120%; height: 100%; z-index: 1000; margin: -10px;'&gt;&lt;/div&gt;"</span> );</pre></div></div>
              
            </li>
          
            <li id="section-200">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-200">&#182;</a>
                </div>
                <p>disable vertical scrolling</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      $(<span class="string">"body"</span>).css({
        <span class="string">"position"</span>: <span class="string">"fixed"</span>,
        top: <span class="number">0</span>,
        left: <span class="number">0</span>
      });</pre></div></div>
              
            </li>
          
            <li id="section-201">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-201">&#182;</a>
                </div>
                <p>replace the anchor icon</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> src = <span class="string">"../images/togetherjs-logo-close.png"</span>;
      $(<span class="string">"#towtruck-dock-anchor #towtruck-dock-anchor-horizontal img"</span>).attr(<span class="string">"src"</span>, src);
    }
    
    <span class="function"><span class="keyword">function</span> <span class="title">closeDock</span><span class="params">()</span> {</span>
      console.log(<span class="string">"Close dock"</span>);</pre></div></div>
              
            </li>
          
            <li id="section-202">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-202">&#182;</a>
                </div>
                <p>enable vertical scrolling</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      $(<span class="string">"body"</span>).css({
        <span class="string">"position"</span>: <span class="string">""</span>,
        top: <span class="string">""</span>,
        left: <span class="string">""</span>
      });</pre></div></div>
              
            </li>
          
            <li id="section-203">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-203">&#182;</a>
                </div>
                <p>replace the anchor icon</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> src = <span class="string">"../images/togetherjs-logo-open.png"</span>;
      $(<span class="string">"#towtruck-dock-anchor #towtruck-dock-anchor-horizontal img"</span>).attr(<span class="string">"src"</span>, src);

      $(<span class="string">'.towtruck-window'</span>).animate({
        opacity: <span class="number">0</span>
      });
      $(<span class="string">'#towtruck-dock-participants'</span>).animate({
        opacity: <span class="number">0</span>
      });
      $(<span class="string">'#towtruck-dock #towtruck-buttons'</span>).animate({
        opacity: <span class="number">0</span>
      });
      $(<span class="string">'.towtruck-dock-right'</span>).animate({
        width: <span class="string">"40px"</span>
      }, {
        duration:<span class="number">60</span>, easing:<span class="string">"linear"</span>
      });</pre></div></div>
              
            </li>
          
            <li id="section-204">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-204">&#182;</a>
                </div>
                <p>remove bg overlay</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      $(<span class="string">".overlay"</span>).remove();
    }</pre></div></div>
              
            </li>
          
            <li id="section-205">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-205">&#182;</a>
                </div>
                <p>Setting the anchor button + dock mobile actions</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span>($.browser.mobile) {</pre></div></div>
              
            </li>
          
            <li id="section-206">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-206">&#182;</a>
                </div>
                <p>toggle the audio button</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      $(<span class="string">"#towtruck-audio-button"</span>).click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        windowing.toggle(<span class="string">"#towtruck-rtc-not-supported"</span>);
      });</pre></div></div>
              
            </li>
          
            <li id="section-207">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-207">&#182;</a>
                </div>
                <p>toggle the profile button</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      $(<span class="string">"#towtruck-profile-button"</span>).click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        windowing.toggle(<span class="string">"#towtruck-menu-window"</span>);
      });

      $(<span class="string">"body"</span>).append( <span class="string">"&lt;div class='overlay' style='position: absolute; top: 0; left: 0; background-color: rgba(0,0,0,0.5); width: 120%; height: 100%; z-index: 1000; margin: -10px'&gt;&lt;/div&gt;"</span> );</pre></div></div>
              
            </li>
          
            <li id="section-208">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-208">&#182;</a>
                </div>
                <p>disable vertical scrolling</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      $(<span class="string">"body"</span>).css({
        <span class="string">"position"</span>: <span class="string">"fixed"</span>,
        top: <span class="number">0</span>,
        left: <span class="number">0</span>
      });</pre></div></div>
              
            </li>
          
            <li id="section-209">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-209">&#182;</a>
                </div>
                <p>replace the anchor icon</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> src = <span class="string">"../images/togetherjs-logo-close.png"</span>;
      $(<span class="string">"#towtruck-dock-anchor #towtruck-dock-anchor-horizontal img"</span>).attr(<span class="string">"src"</span>, src);
                      
      $(<span class="string">"#towtruck-dock-anchor"</span>).toggle(<span class="keyword">function</span>() {
          closeDock();
        },<span class="keyword">function</span>(){
          openDock();
      });
    }

    $(<span class="string">"#towtruck-share-button"</span>).click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      windowing.toggle(<span class="string">"#towtruck-share"</span>);
    });

    $(<span class="string">"#towtruck-profile-button"</span>).click(<span class="function"><span class="keyword">function</span> <span class="params">(event)</span> {</span>
      <span class="keyword">if</span> ($.browser.mobile) {
        windowing.show(<span class="string">"#towtruck-menu-window"</span>);
        <span class="keyword">return</span> <span class="literal">false</span>;
      }
      toggleMenu();
      event.stopPropagation();
      <span class="keyword">return</span> <span class="literal">false</span>;
    });

    $(<span class="string">"#towtruck-menu-feedback, #towtruck-menu-feedback-button"</span>).click(<span class="keyword">function</span>(){
      windowing.hide();
      hideMenu();
      windowing.show(<span class="string">"#towtruck-feedback-form"</span>);
    });

    $(<span class="string">"#towtruck-menu-help, #towtruck-menu-help-button"</span>).click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      windowing.hide();
      hideMenu();
      require([<span class="string">"walkthrough"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(walkthrough)</span> {</span>
        windowing.hide();
        walkthrough.start(<span class="literal">false</span>);
      });
    });

    $(<span class="string">"#towtruck-menu-update-name"</span>).click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">var</span> input = $(<span class="string">"#towtruck-menu .towtruck-self-name"</span>);
      input.css({
        width: $(<span class="string">"#towtruck-menu"</span>).width() - <span class="number">32</span> + <span class="string">"px"</span>
      });
      ui.displayToggle(<span class="string">"#towtruck-menu .towtruck-self-name"</span>);
      $(<span class="string">"#towtruck-menu .towtruck-self-name"</span>).focus();
    });

    $(<span class="string">"#towtruck-menu-update-name-button"</span>).click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      windowing.show(<span class="string">"#towtruck-edit-name-window"</span>);
      $(<span class="string">"#towtruck-edit-name-window input"</span>).focus();
    });

    $(<span class="string">"#towtruck-menu .towtruck-self-name"</span>).bind(<span class="string">"keyup"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(event)</span> {</span>
      <span class="keyword">if</span> (event.which == <span class="number">13</span>) {
        ui.displayToggle(<span class="string">"#towtruck-self-name-display"</span>);
        <span class="keyword">return</span>;
      }
      <span class="keyword">var</span> val = $(<span class="string">"#towtruck-menu .towtruck-self-name"</span>).val();
      <span class="keyword">if</span> (val) {
        peers.Self.update({name: val});
      }
    });

    $(<span class="string">"#towtruck-menu-update-avatar, #towtruck-menu-update-avatar-button"</span>).click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      hideMenu();
      windowing.show(<span class="string">"#towtruck-avatar-edit"</span>);
    });

    $(<span class="string">"#towtruck-menu-end, #towtruck-menu-end-button"</span>).click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      hideMenu();
      windowing.show(<span class="string">"#towtruck-confirm-end"</span>);
    });

    $(<span class="string">"#towtruck-end-session"</span>).click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      session.close();
      $(<span class="string">".overlay"</span>).remove();
      
    });

    $(<span class="string">"#towtruck-menu-update-color"</span>).click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">var</span> picker = $(<span class="string">"#towtruck-pick-color"</span>);
      <span class="keyword">if</span> (picker.is(<span class="string">":visible"</span>)) {
        picker.hide();
        <span class="keyword">return</span>;
      }
      picker.show();
      bindPicker();
      picker.find(<span class="string">".towtruck-swatch-active"</span>).removeClass(<span class="string">"towtruck-swatch-active"</span>);
      picker.find(<span class="string">".towtruck-swatch[data-color=\""</span> + peers.Self.color + <span class="string">"\"]"</span>).addClass(<span class="string">"towtruck-swatch-active"</span>);
    });

    $(<span class="string">"#towtruck-pick-color"</span>).click(<span class="string">".towtruck-swatch"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(event)</span> {</span>
      <span class="keyword">var</span> swatch = $(event.target);
      <span class="keyword">var</span> color = swatch.attr(<span class="string">"data-color"</span>);
      peers.Self.update({
        color: color
      });
      event.stopPropagation();
      <span class="keyword">return</span> <span class="literal">false</span>;
    });

    $(<span class="string">"#towtruck-pick-color"</span>).click(<span class="function"><span class="keyword">function</span> <span class="params">(event)</span> {</span>
      $(<span class="string">"#towtruck-pick-color"</span>).hide();
      event.stopPropagation();
      <span class="keyword">return</span> <span class="literal">false</span>;
    });

    COLORS.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(color)</span> {</span>
      <span class="keyword">var</span> el = templating.sub(<span class="string">"swatch"</span>);
      el.attr(<span class="string">"data-color"</span>, color);
      <span class="keyword">var</span> darkened = tinycolor.darken(color);
      el.css({
        backgroundColor: color,
        borderColor: darkened
      });
      $(<span class="string">"#towtruck-pick-color"</span>).append(el);
    });

    $(<span class="string">"#towtruck-chat-button"</span>).click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      windowing.toggle(<span class="string">"#towtruck-chat"</span>);
    });

    session.on(<span class="string">"display-window"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(id, element)</span> {</span>
      <span class="keyword">if</span> (id == <span class="string">"towtruck-chat"</span>) {
        <span class="keyword">if</span> (! $.browser.mobile) {
          $(<span class="string">"#towtruck-chat-input"</span>).focus();
        }
      } <span class="keyword">else</span> <span class="keyword">if</span> (id == <span class="string">"towtruck-share"</span>) {
        <span class="keyword">var</span> link = element.find(<span class="string">"input.towtruck-share-link"</span>);
        <span class="keyword">if</span> (link.is(<span class="string">":visible"</span>)) {
          link.focus().select();
        }
      }
    });

    container.find(<span class="string">"#towtruck-chat-notifier"</span>).click(<span class="function"><span class="keyword">function</span> <span class="params">(event)</span> {</span>
      <span class="keyword">if</span> ($(event.target).is(<span class="string">"a"</span>) || container.is(<span class="string">".towtruck-close"</span>)) {
        <span class="keyword">return</span>;
      }
      windowing.show(<span class="string">"#towtruck-chat"</span>);
    });</pre></div></div>
              
            </li>
          
            <li id="section-210">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-210">&#182;</a>
                </div>
                <p>FIXME: Don&#39;t think this makes sense</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    $(<span class="string">".towtruck header.towtruck-title"</span>).each(<span class="function"><span class="keyword">function</span> <span class="params">(index, item)</span> {</span>
      <span class="keyword">var</span> button = $(<span class="string">'&lt;button class="towtruck-minimize"&gt;&lt;/button&gt;'</span>);
      button.click(<span class="function"><span class="keyword">function</span> <span class="params">(event)</span> {</span>
        <span class="keyword">var</span> window = button.closest(<span class="string">".towtruck-window"</span>);
        windowing.hide(window);
      });
      $(item).append(button);
    });

    $(<span class="string">"#towtruck-avatar-done"</span>).click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      ui.displayToggle(<span class="string">"#towtruck-no-avatar-edit"</span>);
    });

    $(<span class="string">"#towtruck-self-color"</span>).css({backgroundColor: peers.Self.color});

    <span class="keyword">var</span> avatar = peers.Self.avatar;
    <span class="keyword">if</span> (avatar) {
      $(<span class="string">"#towtruck-self-avatar"</span>).attr(<span class="string">"src"</span>, avatar);
    }

    <span class="keyword">var</span> starterButton = $(<span class="string">"#towtruck-starter button"</span>);
    starterButton.click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      windowing.show(<span class="string">"#towtruck-about"</span>);
    }).addClass(<span class="string">"towtruck-running"</span>);
    <span class="keyword">if</span> (starterButton.text() == <span class="string">"Start TowTruck"</span>) {
      starterButton.attr(<span class="string">"data-start-text"</span>, starterButton.text());
      starterButton.text(<span class="string">"End TowTruck Session"</span>);
    }

    ui.activateAvatarEdit(container, {
      onSave: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        windowing.hide(<span class="string">"#towtruck-avatar-edit"</span>);
      }
    });

    session.emit(<span class="string">"new-element"</span>, ui.container);

    <span class="keyword">if</span> (finishedAt &amp;&amp; finishedAt &gt; Date.now()) {
      setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        finishedAt = <span class="literal">null</span>;
        session.emit(<span class="string">"ui-ready"</span>, ui);
      }, finishedAt - Date.now());
    } <span class="keyword">else</span> {
      session.emit(<span class="string">"ui-ready"</span>, ui);
    }

  };

  ui.activateAvatarEdit = <span class="function"><span class="keyword">function</span> <span class="params">(container, options)</span> {</span>
    options = options || {};
    <span class="keyword">var</span> pendingImage = <span class="literal">null</span>;

    container.find(<span class="string">".towtruck-avatar-save"</span>).prop(<span class="string">"disabled"</span>, <span class="literal">true</span>);

    container.find(<span class="string">".towtruck-avatar-save"</span>).click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">if</span> (pendingImage) {
        peers.Self.update({avatar: pendingImage});
        container.find(<span class="string">".towtruck-avatar-save"</span>).prop(<span class="string">"disabled"</span>, <span class="literal">true</span>);
        <span class="keyword">if</span> (options.onSave) {
          options.onSave();
        }
      }
    });

    container.find(<span class="string">".towtruck-upload-avatar"</span>).on(<span class="string">"change"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      util.readFileImage(<span class="keyword">this</span>).then(<span class="function"><span class="keyword">function</span> <span class="params">(url)</span> {</span>
        sizeDownImage(url).then(<span class="function"><span class="keyword">function</span> <span class="params">(smallUrl)</span> {</span>
          pendingImage = smallUrl;
          container.find(<span class="string">".towtruck-avatar-preview"</span>).css({
            backgroundImage: <span class="string">'url('</span> + pendingImage + <span class="string">')'</span>
          });
          container.find(<span class="string">".towtruck-avatar-save"</span>).prop(<span class="string">"disabled"</span>, <span class="literal">false</span>);
          <span class="keyword">if</span> (options.onPending) {
            options.onPending();
          }
        });
      });
    });

  };

  <span class="function"><span class="keyword">function</span> <span class="title">sizeDownImage</span><span class="params">(imageUrl)</span> {</span>
    <span class="keyword">return</span> util.Deferred(<span class="function"><span class="keyword">function</span> <span class="params">(def)</span> {</span>
      <span class="keyword">var</span> $canvas = $(<span class="string">"&lt;canvas&gt;"</span>);
      $canvas[<span class="number">0</span>].height = session.AVATAR_SIZE;
      $canvas[<span class="number">0</span>].width = session.AVATAR_SIZE;
      <span class="keyword">var</span> context = $canvas[<span class="number">0</span>].getContext(<span class="string">"2d"</span>);
      <span class="keyword">var</span> img = <span class="keyword">new</span> Image();
      img.src = imageUrl;</pre></div></div>
              
            </li>
          
            <li id="section-211">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-211">&#182;</a>
                </div>
                <p>Sometimes the DOM updates immediately to call
naturalWidth/etc, and sometimes it doesn&#39;t; using setTimeout
gives it a chance to catch up</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">var</span> width = img.naturalWidth || img.width;
        <span class="keyword">var</span> height = img.naturalHeight || img.height;
        width = width * (session.AVATAR_SIZE / height);
        height = session.AVATAR_SIZE;
        context.drawImage(img, <span class="number">0</span>, <span class="number">0</span>, width, height);
        def.resolve($canvas[<span class="number">0</span>].toDataURL(<span class="string">"image/png"</span>));
      });
    });
  }

  <span class="function"><span class="keyword">function</span> <span class="title">fixupAvatars</span><span class="params">(container)</span> {</span>
    <span class="comment">/* All &lt;div class="towtruck-person" /&gt; elements need an element inside,
       so we add that element here */</span>
    container.find(<span class="string">".towtruck-person"</span>).each(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">var</span> $<span class="keyword">this</span> = $(<span class="keyword">this</span>);
      <span class="keyword">var</span> inner = $<span class="keyword">this</span>.find(<span class="string">".towtruck-person-avatar-swatch"</span>);
      <span class="keyword">if</span> (! inner.length) {
        $<span class="keyword">this</span>.append(<span class="string">'&lt;div class="towtruck-person-avatar-swatch"&gt;&lt;/div&gt;'</span>);
      }
    });
  }

  ui.prepareShareLink = <span class="function"><span class="keyword">function</span> <span class="params">(container)</span> {</span>
    container.find(<span class="string">"input.towtruck-share-link"</span>).click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      $(<span class="keyword">this</span>).select();
    }).change(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      updateShareLink();
    });
    container.find(<span class="string">"a.towtruck-share-link"</span>).click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-212">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-212">&#182;</a>
                </div>
                <p>FIXME: this is currently opening up Bluetooth, not sharing a link</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (<span class="literal">false</span> &amp;&amp; window.MozActivity) {
        <span class="keyword">var</span> activity = <span class="keyword">new</span> MozActivity({
          name: <span class="string">"share"</span>,
          data: {
            type: <span class="string">"url"</span>,
            url: $(<span class="keyword">this</span>).attr(<span class="string">"href"</span>)
          }
        });
      }</pre></div></div>
              
            </li>
          
            <li id="section-213">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-213">&#182;</a>
                </div>
                <p>FIXME: should show some help if you actually try to follow the link
like this, instead of simply suppressing it</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">return</span> <span class="literal">false</span>;
    });
    updateShareLink();
  };</pre></div></div>
              
            </li>
          
            <li id="section-214">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-214">&#182;</a>
                </div>
                <p>Menu</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="function"><span class="keyword">function</span> <span class="title">showMenu</span><span class="params">(event)</span> {</span>
    <span class="keyword">var</span> el = $(<span class="string">"#towtruck-menu"</span>);
    assert(el.length);
    el.show();
    bindMenu();
    $(document).bind(<span class="string">"click"</span>, maybeHideMenu);
  }

  <span class="function"><span class="keyword">function</span> <span class="title">bindMenu</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> el = $(<span class="string">"#towtruck-menu:visible"</span>);
    <span class="keyword">if</span> (el.length) {
      <span class="keyword">var</span> bound = $(<span class="string">"#towtruck-profile-button"</span>);
      <span class="keyword">var</span> boundOffset = bound.offset();
      el.css({
        top: boundOffset.top + bound.height() - $window.scrollTop() + <span class="string">"px"</span>,
        left: (boundOffset.left + bound.width() - <span class="number">10</span> - el.width() - $window.scrollLeft()) + <span class="string">"px"</span>
      });
    }
  }

  <span class="function"><span class="keyword">function</span> <span class="title">bindPicker</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> picker = $(<span class="string">"#towtruck-pick-color:visible"</span>);
    <span class="keyword">if</span> (picker.length) {
      <span class="keyword">var</span> menu = $(<span class="string">"#towtruck-menu-update-color"</span>);
      <span class="keyword">var</span> menuOffset = menu.offset();
      picker.css({
        top: menuOffset.top + menu.height(),
        left: menuOffset.left
      });
    }
  }

  session.on(<span class="string">"resize"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    bindMenu();
    bindPicker();
  });

  <span class="function"><span class="keyword">function</span> <span class="title">toggleMenu</span><span class="params">()</span> {</span>
    <span class="keyword">if</span> ($(<span class="string">"#towtruck-menu"</span>).is(<span class="string">":visible"</span>)) {
      hideMenu();
    } <span class="keyword">else</span> {
      showMenu();
    }
  }

  <span class="function"><span class="keyword">function</span> <span class="title">hideMenu</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> el = $(<span class="string">"#towtruck-menu"</span>);
    el.hide();
    $(document).unbind(<span class="string">"click"</span>, maybeHideMenu);
    ui.displayToggle(<span class="string">"#towtruck-self-name-display"</span>);
    $(<span class="string">"#towtruck-pick-color"</span>).hide();
  }

  <span class="function"><span class="keyword">function</span> <span class="title">maybeHideMenu</span><span class="params">(event)</span> {</span>
    <span class="keyword">var</span> t = event.target;
    <span class="keyword">while</span> (t) {
      <span class="keyword">if</span> (t.id == <span class="string">"towtruck-menu"</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-215">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-215">&#182;</a>
                </div>
                <p>Click inside the menu, ignore this</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span>;
      }
      t = t.parentNode;
    }
    hideMenu();
  }</pre></div></div>
              
            </li>
          
            <li id="section-216">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-216">&#182;</a>
                </div>
                <p>Misc</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="function"><span class="keyword">function</span> <span class="title">updateShareLink</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> input = $(<span class="string">"input.towtruck-share-link"</span>);
    <span class="keyword">var</span> link = $(<span class="string">"a.towtruck-share-link"</span>);
    <span class="keyword">var</span> display = $(<span class="string">"#towtruck-session-id"</span>);
    <span class="keyword">if</span> (! session.shareId) {
      input.val(<span class="string">""</span>);
      link.attr(<span class="string">"href"</span>, <span class="string">"#"</span>);
      display.text(<span class="string">"(none)"</span>);
    } <span class="keyword">else</span> {
      input.val(session.shareUrl());
      link.attr(<span class="string">"href"</span>, session.shareUrl());
      display.text(session.shareId);
    }
  }

  session.on(<span class="string">"close"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    
    <span class="keyword">if</span>($.browser.mobile) {</pre></div></div>
              
            </li>
          
            <li id="section-217">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-217">&#182;</a>
                </div>
                <p>remove bg overlay</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      $(<span class="string">".overlay"</span>).remove();</pre></div></div>
              
            </li>
          
            <li id="section-218">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-218">&#182;</a>
                </div>
                <p>after hitting End, reset window draggin</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      $(<span class="string">"body"</span>).css({
        <span class="string">"position"</span>: <span class="string">""</span>,
        top: <span class="string">""</span>,
        left: <span class="string">""</span>
      });
      
    }
    
    <span class="keyword">if</span> (ui.container) {
      ui.container.remove();
      ui.container = <span class="literal">null</span>;
    }</pre></div></div>
              
            </li>
          
            <li id="section-219">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-219">&#182;</a>
                </div>
                <p>Clear out any other spurious elements:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    $(<span class="string">".towtruck"</span>).remove();
    <span class="keyword">var</span> starterButton = $(<span class="string">"#towtruck-starter button"</span>);
    starterButton.removeClass(<span class="string">"towtruck-running"</span>);
    <span class="keyword">if</span> (starterButton.attr(<span class="string">"data-start-text"</span>)) {
      starterButton.text(starterButton.attr(<span class="string">"data-start-text"</span>));
      starterButton.attr(<span class="string">"data-start-text"</span>, <span class="string">""</span>);
    }
    <span class="keyword">if</span> (TowTruck.startTarget) {
      <span class="keyword">var</span> el = $(TowTruck.startTarget);
      <span class="keyword">if</span> (el.attr(<span class="string">"data-start-towtruck-html"</span>)) {
        el.html(el.attr(<span class="string">"data-start-towtruck-html"</span>));
      }
      el.removeClass(<span class="string">"towtruck-started"</span>);
    }
  });

  ui.chat = {
    text: <span class="function"><span class="keyword">function</span> <span class="params">(attrs)</span> {</span>
      assert(<span class="keyword">typeof</span> attrs.text == <span class="string">"string"</span>);
      assert(attrs.peer);
      assert(attrs.messageId);
      <span class="keyword">var</span> date = attrs.date || Date.now();
      <span class="keyword">var</span> lastEl = ui.container.find(<span class="string">"#towtruck-chat .towtruck-chat-message"</span>);
      <span class="keyword">if</span> (lastEl.length) {
        lastEl = $(lastEl[lastEl.length-<span class="number">1</span>]);
      }
      <span class="keyword">var</span> lastDate = <span class="literal">null</span>;
      <span class="keyword">if</span> (lastEl) {
        lastDate = parseInt(lastEl.attr(<span class="string">"data-date"</span>), <span class="number">10</span>);
      }
      <span class="keyword">if</span> (lastEl &amp;&amp; lastEl.attr(<span class="string">"data-person"</span>) == attrs.peer.id &amp;&amp;
          lastDate &amp;&amp; date &lt; lastDate + COLLAPSE_MESSAGE_LIMIT) {
        lastEl.attr(<span class="string">"data-date"</span>, date);
        <span class="keyword">var</span> content = lastEl.find(<span class="string">".towtruck-chat-content"</span>);
        assert(content.length);
        attrs.text = content.text() + <span class="string">"\n"</span> + attrs.text;
        attrs.messageId = lastEl.attr(<span class="string">"data-message-id"</span>);
      }
      <span class="keyword">var</span> el = templating.sub(<span class="string">"chat-message"</span>, {
        peer: attrs.peer,
        content: attrs.text,
        date: date
      });
      linkify(el.find(<span class="string">".towtruck-chat-content"</span>));
      el.attr(<span class="string">"data-person"</span>, attrs.peer.id)
        .attr(<span class="string">"data-date"</span>, date)
        .attr(<span class="string">"data-message-id"</span>, attrs.messageId);
      ui.chat.add(el, attrs.messageId, attrs.notify);
    },

    joinedSession: <span class="function"><span class="keyword">function</span> <span class="params">(attrs)</span> {</span>
      assert(attrs.peer);
      <span class="keyword">var</span> date = attrs.date || Date.now();
      <span class="keyword">var</span> el = templating.sub(<span class="string">"chat-joined"</span>, {
        peer: attrs.peer,
        date: date
      });</pre></div></div>
              
            </li>
          
            <li id="section-220">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-220">&#182;</a>
                </div>
                <p>FIXME: should bind the notification to the dock location</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      ui.chat.add(el, attrs.peer.className(<span class="string">"join-message-"</span>), <span class="number">4000</span>);
    },

    leftSession: <span class="function"><span class="keyword">function</span> <span class="params">(attrs)</span> {</span>
      assert(attrs.peer);
      <span class="keyword">var</span> date = attrs.date || Date.now();
      <span class="keyword">var</span> el = templating.sub(<span class="string">"chat-left"</span>, {
        peer: attrs.peer,
        date: date,
        declinedJoin: attrs.declinedJoin
      });</pre></div></div>
              
            </li>
          
            <li id="section-221">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-221">&#182;</a>
                </div>
                <p>FIXME: should bind the notification to the dock location</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      ui.chat.add(el, attrs.peer.className(<span class="string">"join-message-"</span>), <span class="number">4000</span>);
    },

    system: <span class="function"><span class="keyword">function</span> <span class="params">(attrs)</span> {</span>
      assert(! attrs.peer);
      assert(<span class="keyword">typeof</span> attrs.text == <span class="string">"string"</span>);
      <span class="keyword">var</span> date = attrs.date || Date.now();
      <span class="keyword">var</span> el = templating.sub(<span class="string">"chat-system"</span>, {
        content: attrs.text,
        date: date
      });
      ui.chat.add(el, <span class="literal">undefined</span>, <span class="literal">true</span>);
    },

    clear: deferForContainer(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">var</span> container = ui.container.find(<span class="string">"#towtruck-chat-messages"</span>);
      container.empty();
    }),

    urlChange: <span class="function"><span class="keyword">function</span> <span class="params">(attrs)</span> {</span>
      assert(attrs.peer);
      assert(<span class="keyword">typeof</span> attrs.url == <span class="string">"string"</span>);
      assert(<span class="keyword">typeof</span> attrs.sameUrl == <span class="string">"boolean"</span>);
      <span class="keyword">var</span> messageId = attrs.peer.className(<span class="string">"url-change-"</span>);</pre></div></div>
              
            </li>
          
            <li id="section-222">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-222">&#182;</a>
                </div>
                <p>FIXME: duplicating functionality in .add():</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> realId = <span class="string">"towtruck-chat-"</span> + messageId;
      <span class="keyword">var</span> date = attrs.date || Date.now();
      <span class="keyword">var</span> title;</pre></div></div>
              
            </li>
          
            <li id="section-223">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-223">&#182;</a>
                </div>
                <p>FIXME: strip off common domain from msg.url?  E.g., if I&#39;m on
<a href="http://example.com/foobar">http://example.com/foobar</a>, and someone goes to <a href="http://example.com/baz">http://example.com/baz</a> then
show only /baz
FIXME: truncate long titles</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (attrs.title) {
        title = attrs.title + <span class="string">" ("</span> + attrs.url + <span class="string">")"</span>;
      } <span class="keyword">else</span> {
        title = attrs.url;
      }
      <span class="keyword">var</span> el = templating.sub(<span class="string">"url-change"</span>, {
        peer: attrs.peer,
        date: date,
        href: attrs.url,
        title: title,
        sameUrl: attrs.sameUrl
      });
      el.find(<span class="string">".towtruck-nudge"</span>).click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        attrs.peer.nudge();
        <span class="keyword">return</span> <span class="literal">false</span>;
      });
      el.find(<span class="string">".towtruck-follow"</span>).click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">var</span> url = attrs.peers.url;
        <span class="keyword">if</span> (attrs.peer.urlHash) {
          url += attrs.peer.urlHash;
        }
        location.href = url;
      });
      <span class="keyword">var</span> notify = ! attrs.sameUrl;
      <span class="keyword">if</span> (attrs.sameUrl &amp;&amp; ! $(<span class="string">"#"</span> + realId).length) {</pre></div></div>
              
            </li>
          
            <li id="section-224">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-224">&#182;</a>
                </div>
                <p>Don&#39;t bother showing a same-url notification, if no previous notification
had been shown</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span>;
      }
      ui.chat.add(el, messageId, notify);
    },

    hideTimeout: <span class="literal">null</span>,

    add: deferForContainer(<span class="function"><span class="keyword">function</span> <span class="params">(el, id, notify)</span> {</span>
      <span class="keyword">if</span> (id) {
        el.attr(<span class="string">"id"</span>, <span class="string">"towtruck-chat-"</span> + util.safeClassName(id));
      }
      <span class="keyword">var</span> container = ui.container.find(<span class="string">"#towtruck-chat-messages"</span>);
      assert(container.length);
      <span class="keyword">var</span> popup = ui.container.find(<span class="string">"#towtruck-chat-notifier"</span>);
      container.append(el);
      ui.chat.scroll();
      <span class="keyword">var</span> doNotify = !! notify;
      <span class="keyword">var</span> section = popup.find(<span class="string">"#towtruck-chat-notifier-message"</span>);
      <span class="keyword">if</span> (id &amp;&amp; section.data(<span class="string">"message-id"</span>) == id) {
        doNotify = <span class="literal">true</span>;
      }
      <span class="keyword">if</span> (container.is(<span class="string">":visible"</span>)) {
        doNotify = <span class="literal">false</span>;
      }
      <span class="keyword">if</span> (doNotify) {
        section.empty();
        section.append(el.clone(<span class="literal">true</span>, <span class="literal">true</span>));
        <span class="keyword">if</span> (section.data(<span class="string">"message-id"</span>) != id)  {
          section.data(<span class="string">"message-id"</span>, id || <span class="string">""</span>);
          windowing.show(popup);
        } <span class="keyword">else</span> <span class="keyword">if</span> (! popup.is(<span class="string">":visible"</span>)) {
          windowing.show(popup);
        }
        <span class="keyword">if</span> (<span class="keyword">typeof</span> notify == <span class="string">"number"</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-225">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-225">&#182;</a>
                </div>
                <p>This is the amount of time we&#39;re supposed to notify</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>          <span class="keyword">if</span> (<span class="keyword">this</span>.hideTimeout) {
            clearTimeout(<span class="keyword">this</span>.hideTimeout);
            <span class="keyword">this</span>.hideTimeout = <span class="literal">null</span>;
          }
          <span class="keyword">this</span>.hideTimeout = setTimeout((<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            windowing.hide(popup);
            <span class="keyword">this</span>.hideTimeout = <span class="literal">null</span>;
          }).bind(<span class="keyword">this</span>), notify);
        }
      }
    }),

    scroll: deferForContainer(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">var</span> container = ui.container.find(<span class="string">"#towtruck-chat-messages"</span>)[<span class="number">0</span>];
      container.scrollTop = container.scrollHeight;
    })

  };

  session.on(<span class="string">"display-window"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(id, win)</span> {</span>
    <span class="keyword">if</span> (id == <span class="string">"towtruck-chat"</span>) {
      ui.chat.scroll();
      windowing.hide(<span class="string">"#towtruck-chat-notifier"</span>);
    }
  });

  <span class="comment">/* This class is bound to peers.Peer instances as peer.view.
     The .update() method is regularly called by peer objects when info changes. */</span>
  ui.PeerView = util.Class({

    constructor: <span class="function"><span class="keyword">function</span> <span class="params">(peer)</span> {</span>
      assert(peer.isSelf !== <span class="literal">undefined</span>, <span class="string">"PeerView instantiated with non-Peer object"</span>);
      <span class="keyword">this</span>.peer = peer;
      <span class="keyword">this</span>.dockClick = <span class="keyword">this</span>.dockClick.bind(<span class="keyword">this</span>);
    },

    <span class="comment">/* Takes an element and sets any person-related attributes on the element
       Different from updates, which use the class names we set here: */</span>
    setElement: <span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
      <span class="keyword">var</span> count = <span class="number">0</span>;
      <span class="keyword">var</span> classes = [<span class="string">"towtruck-person"</span>, <span class="string">"towtruck-person-status"</span>,
                     <span class="string">"towtruck-person-name"</span>, <span class="string">"towtruck-person-name-abbrev"</span>,
                     <span class="string">"towtruck-person-bgcolor"</span>, <span class="string">"towtruck-person-swatch"</span>,
                     <span class="string">"towtruck-person-status"</span>, <span class="string">"towtruck-person-role"</span>,
                     <span class="string">"towtruck-person-url"</span>, <span class="string">"towtruck-person-url-title"</span>,
                     <span class="string">"towtruck-person-bordercolor"</span>];
      classes.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(cls)</span> {</span>
        <span class="keyword">var</span> els = el.find(<span class="string">"."</span> + cls);
        els.addClass(<span class="keyword">this</span>.peer.className(cls + <span class="string">"-"</span>));
        count += els.length;
      }, <span class="keyword">this</span>);
      <span class="keyword">if</span> (! count) {
        console.warn(<span class="string">"setElement("</span>, el, <span class="string">") doesn't contain any person items"</span>);
      }
      <span class="keyword">this</span>.updateDisplay(el);
    },

    updateDisplay: deferForContainer(<span class="function"><span class="keyword">function</span> <span class="params">(container)</span> {</span>
      container = container || ui.container;
      <span class="keyword">var</span> abbrev = <span class="keyword">this</span>.peer.name;
      <span class="keyword">if</span> (<span class="keyword">this</span>.peer.isSelf) {
        abbrev = <span class="string">"me"</span>;
      }
      container.find(<span class="string">"."</span> + <span class="keyword">this</span>.peer.className(<span class="string">"towtruck-person-name-"</span>)).text(<span class="keyword">this</span>.peer.name || <span class="string">""</span>);
      container.find(<span class="string">"."</span> + <span class="keyword">this</span>.peer.className(<span class="string">"towtruck-person-name-abbrev-"</span>)).text(abbrev);
      <span class="keyword">var</span> avatarEl = container.find(<span class="string">"."</span> + <span class="keyword">this</span>.peer.className(<span class="string">"towtruck-person-"</span>));
      <span class="keyword">if</span> (<span class="keyword">this</span>.peer.avatar) {
        avatarEl.css({
          backgroundImage: <span class="string">"url("</span> + <span class="keyword">this</span>.peer.avatar + <span class="string">")"</span>
        });
      }
      <span class="keyword">if</span> (<span class="keyword">this</span>.peer.idle == <span class="string">"inactive"</span>) {
        avatarEl.addClass(<span class="string">"towtruck-person-inactive"</span>);
      } <span class="keyword">else</span> {
        avatarEl.removeClass(<span class="string">"towtruck-person-inactive"</span>);
      }
      avatarEl.attr(<span class="string">"title"</span>, <span class="keyword">this</span>.peer.name);
      <span class="keyword">if</span> (<span class="keyword">this</span>.peer.color) {
        avatarEl.css({
          borderColor: <span class="keyword">this</span>.peer.color
        });
        avatarEl.find(<span class="string">".towtruck-person-avatar-swatch"</span>).css({
          borderTopColor: <span class="keyword">this</span>.peer.color,
          borderRightColor: <span class="keyword">this</span>.peer.color
        });
      }
      <span class="keyword">if</span> (<span class="keyword">this</span>.peer.color) {
        <span class="keyword">var</span> colors = container.find(<span class="string">"."</span> + <span class="keyword">this</span>.peer.className(<span class="string">"towtruck-person-bgcolor-"</span>));
        colors.css({
          backgroundColor: <span class="keyword">this</span>.peer.color
        });
        colors = container.find(<span class="string">"."</span> + <span class="keyword">this</span>.peer.className(<span class="string">"towtruck-person-bordercolor-"</span>));
        colors.css({
          borderColor: <span class="keyword">this</span>.peer.color
        });
      }
      container.find(<span class="string">"."</span> + <span class="keyword">this</span>.peer.className(<span class="string">"towtruck-person-role-"</span>))
        .text(<span class="keyword">this</span>.peer.isCreator ? <span class="string">"Creator"</span> : <span class="string">"Participant"</span>);
      <span class="keyword">var</span> urlName = <span class="keyword">this</span>.peer.title || <span class="string">""</span>;
      <span class="keyword">if</span> (<span class="keyword">this</span>.peer.title) {
        urlName += <span class="string">" ("</span>;
      }
      urlName += util.truncateCommonDomain(<span class="keyword">this</span>.peer.url, location.href);
      <span class="keyword">if</span> (<span class="keyword">this</span>.peer.title) {
        urlName += <span class="string">")"</span>;
      }
      container.find(<span class="string">"."</span> + <span class="keyword">this</span>.peer.className(<span class="string">"towtruck-person-url-title-"</span>))
        .text(urlName);
      <span class="keyword">var</span> url = <span class="keyword">this</span>.peer.url;
      <span class="keyword">if</span> (<span class="keyword">this</span>.peer.urlHash) {
        url += <span class="keyword">this</span>.peer.urlHash;
      }
      container.find(<span class="string">"."</span> + <span class="keyword">this</span>.peer.className(<span class="string">"towtruck-person-url-"</span>))
        .attr(<span class="string">"href"</span>, url);</pre></div></div>
              
            </li>
          
            <li id="section-226">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-226">&#182;</a>
                </div>
                <p>FIXME: should have richer status:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      container.find(<span class="string">"."</span> + <span class="keyword">this</span>.peer.className(<span class="string">"towtruck-person-status-"</span>))
        .text(<span class="keyword">this</span>.peer.idle == <span class="string">"active"</span> ? <span class="string">"Active"</span> : <span class="string">"Inactive"</span>);
      <span class="keyword">if</span> (<span class="keyword">this</span>.peer.isSelf) {</pre></div></div>
              
            </li>
          
            <li id="section-227">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-227">&#182;</a>
                </div>
                <p>FIXME: these could also have consistent/reliable class names:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> selfName = $(<span class="string">".towtruck-self-name"</span>);
        selfName.each((<span class="function"><span class="keyword">function</span> <span class="params">(index, el)</span> {</span>
          el = $(el);
          <span class="keyword">if</span> (el.val() != <span class="keyword">this</span>.peer.name) {
            el.val(<span class="keyword">this</span>.peer.name);
          }
        }).bind(<span class="keyword">this</span>));
        $(<span class="string">"#towtruck-menu-avatar"</span>).attr(<span class="string">"src"</span>, <span class="keyword">this</span>.peer.avatar);
        <span class="keyword">if</span> (! <span class="keyword">this</span>.peer.name) {
          $(<span class="string">"#towtruck-menu .towtruck-person-name-self"</span>).text(<span class="keyword">this</span>.peer.defaultName);
        }
      }
      <span class="keyword">if</span> (<span class="keyword">this</span>.peer.url != session.currentUrl()) {
        container.find(<span class="string">"."</span> + <span class="keyword">this</span>.peer.className(<span class="string">"towtruck-person-"</span>))
            .addClass(<span class="string">"towtruck-person-other-url"</span>);
      } <span class="keyword">else</span> {
        container.find(<span class="string">"."</span> + <span class="keyword">this</span>.peer.className(<span class="string">"towtruck-person-"</span>))
            .removeClass(<span class="string">"towtruck-person-other-url"</span>);
      }
      <span class="keyword">if</span> (<span class="keyword">this</span>.peer.following) {
        <span class="keyword">if</span> (<span class="keyword">this</span>.followCheckbox) {
          <span class="keyword">this</span>.followCheckbox.prop(<span class="string">"checked"</span>, <span class="literal">true</span>);
        }
      } <span class="keyword">else</span> {
        <span class="keyword">if</span> (<span class="keyword">this</span>.followCheckbox) {
          <span class="keyword">this</span>.followCheckbox.prop(<span class="string">"checked"</span>, <span class="literal">false</span>);
        }
      }</pre></div></div>
              
            </li>
          
            <li id="section-228">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-228">&#182;</a>
                </div>
                <p>FIXME: add some style based on following?</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      updateChatParticipantList();
      <span class="keyword">this</span>.updateFollow();
    }),

    update: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">if</span> (! <span class="keyword">this</span>.peer.isSelf) {
        <span class="keyword">if</span> (<span class="keyword">this</span>.peer.status == <span class="string">"live"</span>) {
          <span class="keyword">this</span>.dock();
        } <span class="keyword">else</span> {
          <span class="keyword">this</span>.undock();
        }
      }
      <span class="keyword">this</span>.updateDisplay();
      <span class="keyword">this</span>.updateUrlDisplay();
    },

    updateUrlDisplay: <span class="function"><span class="keyword">function</span> <span class="params">(force)</span> {</span>
      <span class="keyword">var</span> url = <span class="keyword">this</span>.peer.url;
      <span class="keyword">if</span> ((! url) || (url == <span class="keyword">this</span>._lastUpdateUrlDisplay &amp;&amp; ! force)) {
        <span class="keyword">return</span>;
      }
      <span class="keyword">this</span>._lastUpdateUrlDisplay = url;
      <span class="keyword">var</span> sameUrl = url == session.currentUrl();
      ui.chat.urlChange({
        peer: <span class="keyword">this</span>.peer,
        url: <span class="keyword">this</span>.peer.url,
        title: <span class="keyword">this</span>.peer.title,
        sameUrl: sameUrl
      });
    },

    urlNudge: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-229">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-229">&#182;</a>
                </div>
                <p>FIXME: do something more distinct here</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">this</span>.updateUrlDisplay(<span class="literal">true</span>);
    },

    notifyJoined: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      ui.chat.joinedSession({
        peer: <span class="keyword">this</span>.peer
      });
    },

    dock: deferForContainer(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">if</span> (<span class="keyword">this</span>.dockElement) {
        <span class="keyword">return</span>;
      }
      <span class="keyword">this</span>.dockElement = templating.sub(<span class="string">"dock-person"</span>, {
        peer: <span class="keyword">this</span>.peer
      });
      <span class="keyword">this</span>.dockElement.attr(<span class="string">"id"</span>, <span class="keyword">this</span>.peer.className(<span class="string">"towtruck-dock-element-"</span>));
      ui.container.find(<span class="string">"#towtruck-dock-participants"</span>).append(<span class="keyword">this</span>.dockElement);
      <span class="keyword">this</span>.dockElement.find(<span class="string">".towtruck-person"</span>).animateDockEntry();
      <span class="keyword">var</span> iface = $(<span class="string">"#towtruck-dock"</span>);
      iface.css({
        height: iface.height() + BUTTON_HEIGHT + <span class="string">"px"</span>
      });
      <span class="keyword">this</span>.detailElement = templating.sub(<span class="string">"participant-window"</span>, {
        peer: <span class="keyword">this</span>.peer
      });
      <span class="keyword">var</span> followId = <span class="keyword">this</span>.peer.className(<span class="string">"towtruck-person-status-follow-"</span>);
      <span class="keyword">this</span>.detailElement.find(<span class="string">'[for="towtruck-person-status-follow"]'</span>).attr(<span class="string">"for"</span>, followId);
      <span class="keyword">this</span>.detailElement.find(<span class="string">'#towtruck-person-status-follow'</span>).attr(<span class="string">"id"</span>, followId);
      <span class="keyword">this</span>.detailElement.find(<span class="string">".towtruck-follow"</span>).click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        location.href = $(<span class="keyword">this</span>).attr(<span class="string">"href"</span>);
      });
      <span class="keyword">this</span>.detailElement.find(<span class="string">".towtruck-nudge"</span>).click((<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">this</span>.peer.nudge();
      }).bind(<span class="keyword">this</span>));
      <span class="keyword">this</span>.followCheckbox = <span class="keyword">this</span>.detailElement.find(<span class="string">"#"</span> + followId);
      <span class="keyword">this</span>.followCheckbox.change(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">if</span> (! <span class="keyword">this</span>.checked) {
          <span class="keyword">this</span>.peer.unfollow();
        }</pre></div></div>
              
            </li>
          
            <li id="section-230">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-230">&#182;</a>
                </div>
                <p>Following doesn&#39;t happen until the window is closed
FIXME: should we tell the user this?</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      });
      <span class="keyword">this</span>.maybeHideDetailWindow = <span class="keyword">this</span>.maybeHideDetailWindow.bind(<span class="keyword">this</span>);
      session.on(<span class="string">"hide-window"</span>, <span class="keyword">this</span>.maybeHideDetailWindow);
      ui.container.append(<span class="keyword">this</span>.detailElement);
      <span class="keyword">this</span>.dockElement.click((<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">this</span>.detailElement.is(<span class="string">":visible"</span>)) {
          windowing.hide(<span class="keyword">this</span>.detailElement);
        } <span class="keyword">else</span> {
          windowing.show(<span class="keyword">this</span>.detailElement, {bind: <span class="keyword">this</span>.dockElement});
          <span class="keyword">this</span>.scrollTo();
          <span class="keyword">this</span>.cursor().element.animate({
            opacity:<span class="number">0.3</span>
          }).animate({
            opacity:<span class="number">1</span>
          }).animate({
            opacity:<span class="number">0.3</span>
          }).animate({
            opacity:<span class="number">1</span>
          });
        }
      }).bind(<span class="keyword">this</span>));
      <span class="keyword">this</span>.updateFollow();
    }),

    undock: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">if</span> (! <span class="keyword">this</span>.dockElement) {
        <span class="keyword">return</span>;
      }
      <span class="keyword">this</span>.dockElement.animateDockExit().promise().then((<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">this</span>.dockElement.remove();
        <span class="keyword">this</span>.dockElement = <span class="literal">null</span>;
        <span class="keyword">this</span>.detailElement.remove();
        <span class="keyword">this</span>.detailElement = <span class="literal">null</span>;
        <span class="keyword">var</span> iface = $(<span class="string">"#towtruck-dock"</span>);
        iface.css({
         height: (iface.height() - BUTTON_HEIGHT) + <span class="string">"px"</span>
        });
      }).bind(<span class="keyword">this</span>));
    },

    scrollTo: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">if</span> (<span class="keyword">this</span>.peer.url != session.currentUrl()) {
        <span class="keyword">return</span>;
      }
      <span class="keyword">var</span> pos = <span class="keyword">this</span>.peer.scrollPosition;
      <span class="keyword">if</span> (! pos) {
        console.warn(<span class="string">"Peer has no scroll position:"</span>, <span class="keyword">this</span>.peer);
        <span class="keyword">return</span>;
      }
      pos = elementFinder.pixelForPosition(pos);
      $(document.body).easeTo(pos);
    },

    updateFollow: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">if</span> (! <span class="keyword">this</span>.peer.url) {
        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span> (! <span class="keyword">this</span>.detailElement) {
        <span class="keyword">return</span>;
      }
      <span class="keyword">var</span> same = <span class="keyword">this</span>.detailElement.find(<span class="string">".towtruck-same-url"</span>);
      <span class="keyword">var</span> different = <span class="keyword">this</span>.detailElement.find(<span class="string">".towtruck-different-url"</span>);
      <span class="keyword">if</span> (<span class="keyword">this</span>.peer.url == session.currentUrl()) {
        same.show();
        different.hide();
      } <span class="keyword">else</span> {
        same.hide();
        different.show();
      }
    },

    maybeHideDetailWindow: <span class="function"><span class="keyword">function</span> <span class="params">(windows)</span> {</span>
      <span class="keyword">if</span> (windows[<span class="number">0</span>] &amp;&amp; windows[<span class="number">0</span>][<span class="number">0</span>] === <span class="keyword">this</span>.detailElement[<span class="number">0</span>]) {
        <span class="keyword">if</span> (<span class="keyword">this</span>.followCheckbox[<span class="number">0</span>].checked) {
          <span class="keyword">this</span>.peer.follow();
        } <span class="keyword">else</span> {
          <span class="keyword">this</span>.peer.unfollow();
        }
      }
    },

    dockClick: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-231">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-231">&#182;</a>
                </div>
                <p>FIXME: scroll to person</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    },

    cursor: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">return</span> require(<span class="string">"cursor"</span>).getClient(<span class="keyword">this</span>.peer.id);
    },

    destroy: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-232">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-232">&#182;</a>
                </div>
                <p>FIXME: should I get rid of the dockElement?</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      session.off(<span class="string">"hide-window"</span>, <span class="keyword">this</span>.maybeHideDetailWindow);
    }
  });

  <span class="function"><span class="keyword">function</span> <span class="title">updateChatParticipantList</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> live = peers.getAllPeers(<span class="literal">true</span>);
    <span class="keyword">if</span> (live.length) {
      ui.displayToggle(<span class="string">"#towtruck-chat-participants"</span>);
      $(<span class="string">"#towtruck-chat-participant-list"</span>).text(
        live.map(<span class="function"><span class="keyword">function</span> <span class="params">(p)</span> {</span><span class="keyword">return</span> p.name;}).join(<span class="string">", "</span>));
    } <span class="keyword">else</span> {
      ui.displayToggle(<span class="string">"#towtruck-chat-no-participants"</span>);
    }
  }

  ui.showUrlChangeMessage = deferForContainer(<span class="function"><span class="keyword">function</span> <span class="params">(peer, url)</span> {</span>
    <span class="keyword">var</span> window = templating.sub(<span class="string">"url-change"</span>, {peer: peer});
    ui.container.append(window);
    windowing.show(window);
  });

  session.hub.on(<span class="string">"url-change-nudge"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    <span class="keyword">if</span> (msg.to &amp;&amp; msg.to != session.clientId) {</pre></div></div>
              
            </li>
          
            <li id="section-233">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-233">&#182;</a>
                </div>
                <p>Not directed to us</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">return</span>;
    }
    msg.peer.urlNudge();
  });

  session.on(<span class="string">"new-element"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
    <span class="keyword">if</span> (TowTruck.getConfig(<span class="string">"toolName"</span>)) {
      ui.updateToolName(el);
    }
  });

  <span class="keyword">var</span> setToolName = <span class="literal">false</span>;
  ui.updateToolName = <span class="function"><span class="keyword">function</span> <span class="params">(container)</span> {</span>
    container = container || $(document.body);
    <span class="keyword">var</span> name = TowTruck.getConfig(<span class="string">"toolName"</span>);
    <span class="keyword">if</span> (setToolName &amp;&amp; ! name) {
      name = <span class="string">"TowTruck"</span>;
    }
    <span class="keyword">if</span> (name) {
      container.find(<span class="string">".towtruck-tool-name"</span>).text(name);
      setToolName = <span class="literal">true</span>;
    }
  };

  <span class="keyword">return</span> ui;

});

<span class="comment">/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>

define(<span class="string">'playback'</span>,[<span class="string">"jquery"</span>, <span class="string">"util"</span>, <span class="string">"session"</span>, <span class="string">"storage"</span>, <span class="string">"require"</span>], <span class="function"><span class="keyword">function</span> <span class="params">($, util, session, storage, require)</span> {</span>
  <span class="keyword">var</span> playback = util.Module(<span class="string">"playback"</span>);
  <span class="keyword">var</span> assert = util.assert;

  <span class="keyword">var</span> ALWAYS_REPLAY = {
    <span class="string">"cursor-update"</span>: <span class="literal">true</span>,
    <span class="string">"scroll-update"</span>: <span class="literal">true</span>
  };

  playback.getLogs = <span class="function"><span class="keyword">function</span> <span class="params">(url)</span> {</span>
    <span class="keyword">if</span> (url.search(<span class="regexp">/^local:/</span>) === <span class="number">0</span>) {
      <span class="keyword">return</span> $.Deferred(<span class="function"><span class="keyword">function</span> <span class="params">(def)</span> {</span>
        storage.get(<span class="string">"recording."</span> + url.substr(<span class="string">"local:"</span>.length)).then(<span class="function"><span class="keyword">function</span> <span class="params">(logs)</span> {</span>
          <span class="keyword">if</span> (! logs) {
            def.resolve(<span class="literal">null</span>);
            <span class="keyword">return</span>;
          }
          logs = parseLogs(logs);
          def.resolve(logs);
        }, <span class="function"><span class="keyword">function</span> <span class="params">(error)</span> {</span>
          def.reject(error);
        });
      });
    }
    <span class="keyword">return</span> $.Deferred(<span class="function"><span class="keyword">function</span> <span class="params">(def)</span> {</span>
      $.ajax({
        url: url,
        dataType: <span class="string">"text"</span>
      }).then(
        <span class="function"><span class="keyword">function</span> <span class="params">(logs)</span> {</span>
          logs = parseLogs(logs);
          def.resolve(logs);
        },
        <span class="function"><span class="keyword">function</span> <span class="params">(error)</span> {</span>
          def.reject(error);
        });
    });
  };

  <span class="function"><span class="keyword">function</span> <span class="title">parseLogs</span><span class="params">(logs)</span> {</span>
    logs = logs.replace(<span class="regexp">/\r\n/g</span>, <span class="string">'\n'</span>);
    logs = logs.split(<span class="regexp">/\n/g</span>);
    <span class="keyword">var</span> result = [];
    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;logs.length; i++) {
      <span class="keyword">var</span> line = logs[i];
      line = line.replace(<span class="regexp">/^\s+/</span>, <span class="string">""</span>).replace(<span class="regexp">/\s+$/</span>, <span class="string">""</span>);
      <span class="keyword">if</span> (line.search(<span class="regexp">/\/\*/</span>) === <span class="number">0</span>) {
        <span class="keyword">var</span> last = line.search(<span class="regexp">/\*\//</span>);
        <span class="keyword">if</span> (last == -<span class="number">1</span>) {
          console.warn(<span class="string">"bad line:"</span>, line);
          <span class="keyword">continue</span>;
        }
        line = line.substr(last+<span class="number">2</span>);
      }
      line = line.replace(<span class="regexp">/^\s+/</span>, <span class="string">""</span>);
      <span class="keyword">if</span> (! line) {
        <span class="keyword">continue</span>;
      }
      line = JSON.parse(line);
      result.push(line);
    }
    <span class="keyword">return</span> Logs(result);
  }

  <span class="keyword">var</span> Logs = util.Class({
    constructor: <span class="function"><span class="keyword">function</span> <span class="params">(logs, fromStorage)</span> {</span>
      <span class="keyword">this</span>.logs = logs;
      <span class="keyword">this</span>.fromStorage = fromStorage;
      <span class="keyword">this</span>.pos = <span class="number">0</span>;
    },

    play: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">this</span>.start = Date.now();
      <span class="keyword">if</span> (<span class="keyword">this</span>.pos &gt;= <span class="keyword">this</span>.logs.length) {
        <span class="keyword">this</span>.unload();
        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span> (<span class="keyword">this</span>.pos !== <span class="number">0</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-234">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-234">&#182;</a>
                </div>
                <p>First we need to play the hello</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> toReplay = [];
        <span class="keyword">var</span> foundHello = <span class="literal">false</span>;
        <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="keyword">this</span>.pos-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) {
          <span class="keyword">var</span> item = <span class="keyword">this</span>.logs[i];
          <span class="keyword">if</span> (ALWAYS_REPLAY[item.type]) {
            toReplay.push(item);
          }
          <span class="keyword">if</span> (item.type == <span class="string">"hello"</span> || item.type == <span class="string">"hello-back"</span>) {
            <span class="keyword">this</span>.playItem(item);
            foundHello = <span class="literal">true</span>;
            <span class="keyword">break</span>;
          }
        }
        <span class="keyword">if</span> (! foundHello) {
          console.warn(<span class="string">"No hello message found before position"</span>, <span class="keyword">this</span>.pos);
        }
        toReplay.reverse();
        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;toReplay.length; i++) {
          <span class="keyword">this</span>.playItem(toReplay[i]);
        }
      }
      <span class="keyword">this</span>.playOne();
    },

    cancel: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">if</span> (<span class="keyword">this</span>.playTimer) {
        clearTimeout(<span class="keyword">this</span>.playTimer);
        <span class="keyword">this</span>.playTimer = <span class="literal">null</span>;
      }
      <span class="keyword">this</span>.start = <span class="literal">null</span>;
      <span class="keyword">this</span>.pos = <span class="number">0</span>;
      <span class="keyword">this</span>.unload();
    },

    pause: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">if</span> (<span class="keyword">this</span>.playTimer) {
        clearTimeout(<span class="keyword">this</span>.playTimer);
        <span class="keyword">this</span>.playTimer = <span class="literal">null</span>;
      }
    },

    playOne: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">this</span>.playTimer = <span class="literal">null</span>;
      <span class="keyword">if</span> (<span class="keyword">this</span>.pos &gt;= <span class="keyword">this</span>.logs.length) {
        <span class="keyword">this</span>.unload();
        <span class="keyword">return</span>;
      }
      <span class="keyword">var</span> item = <span class="keyword">this</span>.logs[<span class="keyword">this</span>.pos];
      <span class="keyword">this</span>.playItem(item);
      <span class="keyword">this</span>.pos++;
      <span class="keyword">if</span> (<span class="keyword">this</span>.pos &gt;= <span class="keyword">this</span>.logs.length) {
        <span class="keyword">this</span>.unload();
        <span class="keyword">return</span>;
      }
      <span class="keyword">var</span> next = <span class="keyword">this</span>.logs[<span class="keyword">this</span>.pos];
      <span class="keyword">var</span> pause = next.date - item.date;
      <span class="keyword">this</span>.playTimer = setTimeout(<span class="keyword">this</span>.playOne.bind(<span class="keyword">this</span>), pause);
      <span class="keyword">if</span> (<span class="keyword">this</span>.fromStorage) {
        <span class="keyword">this</span>.savePos();
      }
    },

    playItem: <span class="function"><span class="keyword">function</span> <span class="params">(item)</span> {</span>
      <span class="keyword">if</span> (item.type == <span class="string">"hello"</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-235">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-235">&#182;</a>
                </div>
                <p>We may need to pause here</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (item.url != (location.href+<span class="string">""</span>).replace(<span class="regexp">/\#.*/</span>, <span class="string">""</span>)) {
          <span class="keyword">this</span>.pause();
        }
      }
      <span class="keyword">try</span> {
        session._getChannel().onmessage(item);
      } <span class="keyword">catch</span> (e) {
        console.warn(<span class="string">"Could not play back message:"</span>, item, <span class="string">"error:"</span>, e);
      }
    },

    save: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">this</span>.fromStorage = <span class="literal">true</span>;
      storage.set(<span class="string">"playback.logs"</span>, <span class="keyword">this</span>.logs);
      <span class="keyword">this</span>.savePos();
    },

    savePos: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      storage.set(<span class="string">"playback.pos"</span>, <span class="keyword">this</span>.pos);
    },

    unload: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">if</span> (<span class="keyword">this</span>.fromStorage) {
        storage.set(<span class="string">"playback.logs"</span>, <span class="literal">undefined</span>);
        storage.set(<span class="string">"playback.pos"</span>, <span class="literal">undefined</span>);
      }</pre></div></div>
              
            </li>
          
            <li id="section-236">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-236">&#182;</a>
                </div>
                <p>FIXME: should do a bye message here</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    }

  });

  playback.getRunningLogs = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">return</span> storage.get(<span class="string">"playback.logs"</span>).then(<span class="function"><span class="keyword">function</span> <span class="params">(value)</span> {</span>
      <span class="keyword">if</span> (! value) {
        <span class="keyword">return</span> <span class="literal">null</span>;
      }
      <span class="keyword">var</span> logs = Logs(value, <span class="literal">true</span>);
      <span class="keyword">return</span> storage.get(<span class="string">"playback.pos"</span>).then(<span class="function"><span class="keyword">function</span> <span class="params">(pos)</span> {</span>
        pos = pos || <span class="number">0</span>;
        logs.pos = pos;
        <span class="keyword">return</span> logs;
      });
    });
  };

  <span class="keyword">return</span> playback;
});

<span class="comment">/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<span class="comment">/*jshint evil:true */</span>
define(<span class="string">'chat'</span>,[<span class="string">"require"</span>, <span class="string">"jquery"</span>, <span class="string">"util"</span>, <span class="string">"session"</span>, <span class="string">"ui"</span>, <span class="string">"templates"</span>, <span class="string">"playback"</span>, <span class="string">"storage"</span>, <span class="string">"peers"</span>, <span class="string">"windowing"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(require, $, util, session, ui, templates, playback, storage, peers, windowing)</span> {</span>
  <span class="keyword">var</span> chat = util.Module(<span class="string">"chat"</span>);
  <span class="keyword">var</span> assert = util.assert;
  <span class="keyword">var</span> Walkabout;

  session.hub.on(<span class="string">"chat"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    ui.chat.text({
      text: msg.text,
      peer: msg.peer,</pre></div></div>
              
            </li>
          
            <li id="section-237">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-237">&#182;</a>
                </div>
                <p>FIXME: a little unsure of trusting this (maybe I should prefix it?)</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      messageId: msg.messageId,
      notify: <span class="literal">true</span>
    });
  });</pre></div></div>
              
            </li>
          
            <li id="section-238">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-238">&#182;</a>
                </div>
                <p>FIXME: this doesn&#39;t really belong in this module:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  session.hub.on(<span class="string">"bye"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    ui.chat.leftSession({
      peer: msg.peer,
      declinedJoin: msg.reason == <span class="string">"declined-join"</span>
    });
  });

  chat.submit = <span class="function"><span class="keyword">function</span> <span class="params">(message)</span> {</span>
    <span class="keyword">var</span> parts = message.split(<span class="regexp">/ /</span>);
    <span class="keyword">if</span> (parts[<span class="number">0</span>].charAt(<span class="number">0</span>) == <span class="string">"/"</span>) {
      <span class="keyword">var</span> name = parts[<span class="number">0</span>].substr(<span class="number">1</span>).toLowerCase();
      <span class="keyword">var</span> method = commands[<span class="string">"command_"</span> + name];
      <span class="keyword">if</span> (method) {
        method.apply(<span class="literal">null</span>, parts.slice(<span class="number">1</span>));
        <span class="keyword">return</span>;
      }
    }
    <span class="keyword">var</span> messageId = session.clientId + <span class="string">"-"</span> + Date.now();
    session.send({
      type: <span class="string">"chat"</span>,
      text: message,
      messageId: messageId
    });
    ui.chat.text({
      text: message,
      peer: peers.Self,
      messageId: messageId,
      notify: <span class="literal">false</span>
    });
  };

  <span class="keyword">var</span> commands = {
    command_help: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">var</span> msg = util.trim(templates.help);
      ui.chat.system({
        text: msg
      });
    },

    command_test: <span class="function"><span class="keyword">function</span> <span class="params">(args)</span> {</span>
      <span class="keyword">if</span> (! Walkabout) {
        require([<span class="string">"walkabout"</span>], (<span class="function"><span class="keyword">function</span> <span class="params">(WalkaboutModule)</span> {</span>
          Walkabout = WalkaboutModule;
          <span class="keyword">this</span>.command_test(args);
        }).bind(<span class="keyword">this</span>));
        <span class="keyword">return</span>;
      }
      args = util.trim(args || <span class="string">""</span>).split(<span class="regexp">/\s+/g</span>);
      <span class="keyword">if</span> (args[<span class="number">0</span>] === <span class="string">""</span> || ! args.length) {
        <span class="keyword">if</span> (<span class="keyword">this</span>._testCancel) {
          args = [<span class="string">"cancel"</span>];
        } <span class="keyword">else</span> {
          args = [<span class="string">"start"</span>];
        }
      }
      <span class="keyword">if</span> (args[<span class="number">0</span>] == <span class="string">"cancel"</span>) {
        ui.chat.system({
          text: <span class="string">"Aborting test"</span>
        });
        <span class="keyword">this</span>._testCancel();
        <span class="keyword">this</span>._testCancel = <span class="literal">null</span>;
        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span> (args[<span class="number">0</span>] == <span class="string">"start"</span>) {
        <span class="keyword">var</span> times = parseInt(args[<span class="number">1</span>], <span class="number">10</span>);
        <span class="keyword">if</span> (isNaN(times) || ! times) {
          times = <span class="number">100</span>;
        }
        ui.chat.system({
          text: <span class="string">"Testing with walkabout.js"</span>
        });
        <span class="keyword">var</span> tmpl = $(templates.walkabout);
        <span class="keyword">var</span> container = ui.container.find(<span class="string">".towtruck-test-container"</span>);
        container.empty();
        container.append(tmpl);
        container.show();
        <span class="keyword">var</span> statusContainer = container.find(<span class="string">".towtruck-status"</span>);
        statusContainer.text(<span class="string">"starting..."</span>);
        <span class="keyword">this</span>._testCancel = Walkabout.runManyActions({
          ondone: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            statusContainer.text(<span class="string">"done"</span>);
            statusContainer.one(<span class="string">"click"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
              container.hide();
            });
            <span class="keyword">this</span>._testCancel = <span class="literal">null</span>;
          },
          onstatus: <span class="function"><span class="keyword">function</span> <span class="params">(status)</span> {</span>
            <span class="keyword">var</span> note = <span class="string">"actions: "</span> + status.actions.length + <span class="string">" running: "</span> +
              (status.times - status.remaining) + <span class="string">" / "</span> + status.times;
            statusContainer.text(note);
          }
        });
        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span> (args[<span class="number">0</span>] == <span class="string">"show"</span>) {
        <span class="keyword">if</span> (<span class="keyword">this</span>._testShow.length) {
          <span class="keyword">this</span>._testShow.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(item)</span> {</span>
            <span class="keyword">if</span> (item) {
              item.remove();
            }
          }, <span class="keyword">this</span>);
          <span class="keyword">this</span>._testShow = [];
        } <span class="keyword">else</span> {
          <span class="keyword">var</span> actions = Walkabout.findActions();
          actions.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(action)</span> {</span>
            <span class="keyword">this</span>._testShow.push(action.show());
          }, <span class="keyword">this</span>);
        }
        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span> (args[<span class="number">0</span>] == <span class="string">"describe"</span>) {
        Walkabout.findActions().forEach(<span class="function"><span class="keyword">function</span> <span class="params">(action)</span> {</span>
          ui.chat.system({
            text: action.description()
          });
        }, <span class="keyword">this</span>);
        <span class="keyword">return</span>;
      }
      ui.chat.system({
        text: <span class="string">"Did not understand: "</span> + args.join(<span class="string">" "</span>)
      });
    },

    _testCancel: <span class="literal">null</span>,
    _testShow: [],

    command_clear: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      ui.chat.clear();
    },

    command_exec: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">var</span> expr = Array.prototype.slice.call(arguments).join(<span class="string">" "</span>);
      <span class="keyword">var</span> result;
      <span class="keyword">var</span> e = eval;
      <span class="keyword">try</span> {
        result = eval(expr);
      } <span class="keyword">catch</span> (error) {
        ui.chat.system({
          text: <span class="string">"Error: "</span> + error
        });
      }
      <span class="keyword">if</span> (result !== <span class="literal">undefined</span>) {
        ui.chat.system({
          text: <span class="string">""</span> + result
        });
      }
    },

    command_record: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      ui.chat.system({
        text: <span class="string">"When you see the robot appear, the recording will have started"</span>
      });
      window.open(
        session.recordUrl(), <span class="string">"_blank"</span>,
        <span class="string">"left,width="</span> + ($(window).width() / <span class="number">2</span>));
    },

    playing: <span class="literal">null</span>,

    command_playback: <span class="function"><span class="keyword">function</span> <span class="params">(url)</span> {</span>
      <span class="keyword">if</span> (<span class="keyword">this</span>.playing) {
        <span class="keyword">this</span>.playing.cancel();
        <span class="keyword">this</span>.playing.unload();
        <span class="keyword">this</span>.playing = <span class="literal">null</span>;
        ui.chat.system({
          text: <span class="string">"playback cancelled"</span>
        });
        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span> (! url) {
        ui.chat.system({
          text: <span class="string">"Nothing is playing"</span>
        });
        <span class="keyword">return</span>;
      }
      <span class="keyword">var</span> logLoader = playback.getLogs(url);
      logLoader.then(
        (<span class="function"><span class="keyword">function</span> <span class="params">(logs)</span> {</span>
          <span class="keyword">if</span> (! logs) {
            ui.chat.system({
              text: <span class="string">"No logs found."</span>
            });
            <span class="keyword">return</span>;
          }
          logs.save();
          <span class="keyword">this</span>.playing = logs;
          logs.play();
        }).bind(<span class="keyword">this</span>),
        <span class="function"><span class="keyword">function</span> <span class="params">(error)</span> {</span>
          ui.chat.system({
            text: <span class="string">"Error fetching "</span> + url + <span class="string">":\n"</span> + JSON.stringify(error, <span class="literal">null</span>, <span class="string">"  "</span>)
          });
        });
      windowing.hide(<span class="string">"#towtruck-chat"</span>);
    },

    command_savelogs: <span class="function"><span class="keyword">function</span> <span class="params">(name)</span> {</span>
      session.send({
        type: <span class="string">"get-logs"</span>,
        forClient: session.clientId,
        saveAs: name
      });
      <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">(msg)</span> {</span>
        <span class="keyword">if</span> (msg.request.forClient == session.clientId &amp;&amp; msg.request.saveAs == name) {
          storage.set(<span class="string">"recording."</span> + name, msg.logs).then(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            session.hub.off(<span class="string">"logs"</span>, save);
            ui.chat.system({
              text: <span class="string">"Saved as local:"</span> + name
            });
          });
        }
      }
      session.hub.on(<span class="string">"logs"</span>, save);
    },

    command_baseurl: <span class="function"><span class="keyword">function</span> <span class="params">(url)</span> {</span>
      <span class="keyword">if</span> (! url) {
        storage.get(<span class="string">"baseUrlOverride"</span>).then(<span class="function"><span class="keyword">function</span> <span class="params">(b)</span> {</span>
          <span class="keyword">if</span> (b) {
            ui.chat.system({
              text: <span class="string">"Set to: "</span> + b.baseUrl
            });
          } <span class="keyword">else</span> {
            ui.chat.system({
              text: <span class="string">"No baseUrl override set"</span>
            });
          }
        });
        <span class="keyword">return</span>;
      }
      url = url.replace(<span class="regexp">/\/*$/</span>, <span class="string">""</span>);
      ui.chat.system({
        text: <span class="string">"If this goes wrong, do this in the console to reset:\n  localStorage.setItem('towtruck.baseUrlOverride', null)"</span>
      });
      storage.set(<span class="string">"baseUrlOverride"</span>, {
        baseUrl: url,
        expiresAt: Date.now() + (<span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>)
      }).then(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        ui.chat.system({
          text: <span class="string">"baseUrl overridden (to "</span> + url + <span class="string">"), will last for one day."</span>
        });
      });
    },

    command_config: <span class="function"><span class="keyword">function</span> <span class="params">(variable, value)</span> {</span>
      <span class="keyword">if</span> (! (variable || value)) {
        storage.get(<span class="string">"configOverride"</span>).then(<span class="function"><span class="keyword">function</span> <span class="params">(c)</span> {</span>
          <span class="keyword">if</span> (c) {
            util.forEachAttr(c, <span class="function"><span class="keyword">function</span> <span class="params">(value, attr)</span> {</span>
              <span class="keyword">if</span> (attr == <span class="string">"expiresAt"</span>) {
                <span class="keyword">return</span>;
              }
              ui.chat.system({
                text: <span class="string">"  "</span> + attr + <span class="string">" = "</span> + JSON.stringify(value)
              });
            });
            ui.chat.system({
              text: <span class="string">"Config expires at "</span> + (<span class="keyword">new</span> Date(c.expiresAt))
            });
          } <span class="keyword">else</span> {
            ui.chat.system({
              text: <span class="string">"No config override"</span>
            });
          }
        });
        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span> (variable == <span class="string">"clear"</span>) {
        storage.set(<span class="string">"configOverride"</span>, <span class="literal">undefined</span>);
        ui.chat.system({
          text: <span class="string">"Clearing all overridden configuration"</span>
        });
        <span class="keyword">return</span>;
      }
      console.log(<span class="string">"config"</span>, [variable, value]);
      <span class="keyword">if</span> (! (variable &amp;&amp; value)) {
        ui.chat.system({
          text: <span class="string">"Error: must provide /config VAR VALUE"</span>
        });
        <span class="keyword">return</span>;
      }
      <span class="keyword">try</span> {
        value = JSON.parse(value);
      } <span class="keyword">catch</span> (e) {
        ui.chat.system({
          text: <span class="string">"Error: value ("</span> + value + <span class="string">") could not be parsed: "</span> + e
        });
        <span class="keyword">return</span>;
      }
      storage.get(<span class="string">"configOverride"</span>).then(<span class="function"><span class="keyword">function</span> <span class="params">(c)</span> {</span>
        c = c || {};
        c[variable] = value;
        c.expiresAt = Date.now() + (<span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>);
        storage.set(<span class="string">"configOverride"</span>, c).then(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
          ui.chat.system({
            text: <span class="string">"Variable "</span> + variable + <span class="string">" = "</span> + JSON.stringify(value) + <span class="string">"\nValue will be set for one day."</span>
          });
        });
      });
    }

  };

  <span class="keyword">return</span> chat;

});

<span class="comment">/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/. */</span></pre></div></div>
              
            </li>
          
            <li id="section-239">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-239">&#182;</a>
                </div>
                <p>WebRTC support -- Note that this relies on parts of the interface code that usually goes in ui.js</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>define(<span class="string">'webrtc'</span>,[<span class="string">"require"</span>, <span class="string">"jquery"</span>, <span class="string">"util"</span>, <span class="string">"session"</span>, <span class="string">"ui"</span>, <span class="string">"peers"</span>, <span class="string">"storage"</span>, <span class="string">"windowing"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(require, $, util, session, ui, peers, storage, windowing)</span> {</span>
  <span class="keyword">var</span> webrtc = util.Module(<span class="string">"webrtc"</span>);
  <span class="keyword">var</span> assert = util.assert;

  session.RTCSupported = !!(window.mozRTCPeerConnection ||
                            window.webkitRTCPeerConnection ||
                            window.RTCPeerConnection);

  <span class="keyword">if</span> (session.RTCSupported &amp;&amp; $.browser.mozilla &amp;&amp; parseInt($.browser.version, <span class="number">10</span>) &lt;= <span class="number">19</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-240">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-240">&#182;</a>
                </div>
                <p>In a few versions of Firefox (18 and 19) these APIs are present but
not actually usable
See: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=828839">https://bugzilla.mozilla.org/show_bug.cgi?id=828839</a>
Because they could be pref&#39;d on we&#39;ll do a quick check:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">try</span> {
      (<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">var</span> conn = <span class="keyword">new</span> window.mozRTCPeerConnection();
      })();
    } <span class="keyword">catch</span> (e) {
      session.RTCSupported = <span class="literal">false</span>;
    }
  }

  <span class="keyword">var</span> mediaConstraints = {
    mandatory: {
      OfferToReceiveAudio: <span class="literal">true</span>,
      OfferToReceiveVideo: <span class="literal">false</span>
    }
  };
  <span class="keyword">if</span> (window.mozRTCPeerConnection) {
    mediaConstraints.mandatory.MozDontOfferDataChannel = <span class="literal">true</span>;
  }

  <span class="keyword">var</span> URL = window.webkitURL || window.URL;
  <span class="keyword">var</span> RTCSessionDescription = window.mozRTCSessionDescription || window.webkitRTCSessionDescription || window.RTCSessionDescription;
  <span class="keyword">var</span> RTCIceCandidate = window.mozRTCIceCandidate || window.webkitRTCIceCandidate || window.RTCIceCandidate;

  <span class="function"><span class="keyword">function</span> <span class="title">makePeerConnection</span><span class="params">()</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-241">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-241">&#182;</a>
                </div>
                <p>Based roughly off: <a href="https://github.com/firebase/gupshup/blob/gh-pages/js/chat.js">https://github.com/firebase/gupshup/blob/gh-pages/js/chat.js</a></p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (window.webkitRTCPeerConnection) {
      <span class="keyword">return</span> <span class="keyword">new</span> webkitRTCPeerConnection({
        <span class="string">"iceServers"</span>: [{<span class="string">"url"</span>: <span class="string">"stun:stun.l.google.com:19302"</span>}]
      }, {
        <span class="string">"optional"</span>: [{<span class="string">"DtlsSrtpKeyAgreement"</span>: <span class="literal">true</span>}]
      });
    }
    <span class="keyword">if</span> (window.mozRTCPeerConnection) {
      <span class="keyword">return</span> <span class="keyword">new</span> mozRTCPeerConnection({</pre></div></div>
              
            </li>
          
            <li id="section-242">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-242">&#182;</a>
                </div>
                <p>Or stun:124.124.124..2 ?</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="string">"iceServers"</span>: [{<span class="string">"url"</span>: <span class="string">"stun:23.21.150.121"</span>}]
      }, {
        <span class="string">"optional"</span>: []
      });
    }
    <span class="keyword">throw</span> <span class="keyword">new</span> util.AssertionError(<span class="string">"Called makePeerConnection() without supported connection"</span>);
  }

  <span class="function"><span class="keyword">function</span> <span class="title">ensureCryptoLine</span><span class="params">(sdp)</span> {</span>
    <span class="keyword">if</span> (! window.mozRTCPeerConnection) {
      <span class="keyword">return</span> sdp;
    }

    <span class="keyword">var</span> sdpLinesIn = sdp.split(<span class="string">'\r\n'</span>);
    <span class="keyword">var</span> sdpLinesOut = [];</pre></div></div>
              
            </li>
          
            <li id="section-243">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-243">&#182;</a>
                </div>
                <p>Search for m line.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; sdpLinesIn.length; i++) {
      sdpLinesOut.push(sdpLinesIn[i]);
      <span class="keyword">if</span> (sdpLinesIn[i].search(<span class="string">'m='</span>) !== -<span class="number">1</span>) {
        sdpLinesOut.push(<span class="string">"a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span>);
      }
    }

    sdp = sdpLinesOut.join(<span class="string">'\r\n'</span>);
    <span class="keyword">return</span> sdp;
  }

  <span class="function"><span class="keyword">function</span> <span class="title">getUserMedia</span><span class="params">(options, success, failure)</span> {</span>
    failure = failure || <span class="function"><span class="keyword">function</span> <span class="params">(error)</span> {</span>
      console.error(<span class="string">"Error in getUserMedia:"</span>, error);
    };
    (navigator.getUserMedia ||
     navigator.mozGetUserMedia ||
     navigator.webkitGetUserMedia ||
     navigator.msGetUserMedia).call(navigator, options, success, failure);
  }

  <span class="comment">/****************************************
   * getUserMedia Avatar support
   */</span>

  <span class="keyword">var</span> avatarEditState = {};

  session.on(<span class="string">"ui-ready"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    $(<span class="string">"#towtruck-self-avatar"</span>).click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">var</span> avatar = peers.Self.avatar;
      <span class="keyword">if</span> (avatar) {
        $preview.attr(<span class="string">"src"</span>, avatar);
      }
      ui.displayToggle(<span class="string">"#towtruck-avatar-edit"</span>);
    });
    <span class="keyword">if</span> (! session.RTCSupported) {
      $(<span class="string">"#towtruck-avatar-edit-rtc"</span>).hide();
    }

    <span class="keyword">var</span> avatarData = <span class="literal">null</span>;
    <span class="keyword">var</span> $preview = $(<span class="string">"#towtruck-self-avatar-preview"</span>);
    <span class="keyword">var</span> $accept = $(<span class="string">"#towtruck-self-avatar-accept"</span>);
    <span class="keyword">var</span> $cancel = $(<span class="string">"#towtruck-self-avatar-cancel"</span>);
    <span class="keyword">var</span> $takePic = $(<span class="string">"#towtruck-avatar-use-camera"</span>);
    <span class="keyword">var</span> $video = $(<span class="string">"#towtruck-avatar-video"</span>);
    <span class="keyword">var</span> $upload = $(<span class="string">"#towtruck-avatar-upload"</span>);

    $takePic.click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">if</span> (! streaming) {
        startStreaming();
        <span class="keyword">return</span>;
      }
      takePicture();
    });

    <span class="function"><span class="keyword">function</span> <span class="title">savePicture</span><span class="params">(dataUrl)</span> {</span>
      avatarData = dataUrl;
      $preview.attr(<span class="string">"src"</span>, avatarData);
      $accept.attr(<span class="string">"disabled"</span>, <span class="literal">null</span>);
    }

    $accept.click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      peers.Self.update({avatar:  avatarData});
      ui.displayToggle(<span class="string">"#towtruck-no-avatar-edit"</span>);</pre></div></div>
              
            </li>
          
            <li id="section-244">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-244">&#182;</a>
                </div>
                <p>FIXME: these probably shouldn&#39;t be two elements:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      $(<span class="string">"#towtruck-participants-other"</span>).show();
      $accept.attr(<span class="string">"disabled"</span>, <span class="string">"1"</span>);
    });

    $cancel.click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      ui.displayToggle(<span class="string">"#towtruck-no-avatar-edit"</span>);</pre></div></div>
              
            </li>
          
            <li id="section-245">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-245">&#182;</a>
                </div>
                <p>FIXME: like above:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      $(<span class="string">"#towtruck-participants-other"</span>).show();
    });

    <span class="keyword">var</span> streaming = <span class="literal">false</span>;
    <span class="function"><span class="keyword">function</span> <span class="title">startStreaming</span><span class="params">()</span> {</span>
      getUserMedia({
          video: <span class="literal">true</span>,
          audio: <span class="literal">false</span>
        },
        <span class="keyword">function</span>(stream) {
          streaming = <span class="literal">true</span>;
          $video[<span class="number">0</span>].src = URL.createObjectURL(stream);
          $video[<span class="number">0</span>].play();
        },
        <span class="keyword">function</span>(err) {</pre></div></div>
              
            </li>
          
            <li id="section-246">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-246">&#182;</a>
                </div>
                <p>FIXME: should pop up help or something in the case of a user
cancel</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>          console.error(<span class="string">"getUserMedia error:"</span>, err);
        }
      );
    }

    <span class="function"><span class="keyword">function</span> <span class="title">takePicture</span><span class="params">()</span> {</span>
      assert(streaming);
      <span class="keyword">var</span> height = $video[<span class="number">0</span>].videoHeight;
      <span class="keyword">var</span> width = $video[<span class="number">0</span>].videoWidth;
      width = width * (session.AVATAR_SIZE / height);
      height = session.AVATAR_SIZE;
      <span class="keyword">var</span> $canvas = $(<span class="string">"&lt;canvas&gt;"</span>);
      $canvas[<span class="number">0</span>].height = session.AVATAR_SIZE;
      $canvas[<span class="number">0</span>].width = session.AVATAR_SIZE;
      <span class="keyword">var</span> context = $canvas[<span class="number">0</span>].getContext(<span class="string">"2d"</span>);
      context.arc(session.AVATAR_SIZE/<span class="number">2</span>, session.AVATAR_SIZE/<span class="number">2</span>, session.AVATAR_SIZE/<span class="number">2</span>, <span class="number">0</span>, Math.PI*<span class="number">2</span>);
      context.closePath();
      context.clip();
      context.drawImage($video[<span class="number">0</span>], (session.AVATAR_SIZE - width) / <span class="number">2</span>, <span class="number">0</span>, width, height);
      savePicture($canvas[<span class="number">0</span>].toDataURL(<span class="string">"image/png"</span>));
    }

    $upload.on(<span class="string">"change"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">var</span> reader = <span class="keyword">new</span> FileReader();
      reader.onload = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-247">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-247">&#182;</a>
                </div>
                <p>FIXME: I don&#39;t actually know it&#39;s JPEG, but it&#39;s probably a
good enough guess:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> url = <span class="string">"data:image/jpeg;base64,"</span> + util.blobToBase64(<span class="keyword">this</span>.result);
        convertImage(url, <span class="function"><span class="keyword">function</span> <span class="params">(result)</span> {</span>
          savePicture(result);
        });
      };
      reader.onerror = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        console.error(<span class="string">"Error reading file:"</span>, <span class="keyword">this</span>.error);
      };
      reader.readAsArrayBuffer(<span class="keyword">this</span>.files[<span class="number">0</span>]);
    });

    <span class="function"><span class="keyword">function</span> <span class="title">convertImage</span><span class="params">(imageUrl, callback)</span> {</span>
      <span class="keyword">var</span> $canvas = $(<span class="string">"&lt;canvas&gt;"</span>);
      $canvas[<span class="number">0</span>].height = session.AVATAR_SIZE;
      $canvas[<span class="number">0</span>].width = session.AVATAR_SIZE;
      <span class="keyword">var</span> context = $canvas[<span class="number">0</span>].getContext(<span class="string">"2d"</span>);
      <span class="keyword">var</span> img = <span class="keyword">new</span> Image();
      img.src = imageUrl;</pre></div></div>
              
            </li>
          
            <li id="section-248">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-248">&#182;</a>
                </div>
                <p>Sometimes the DOM updates immediately to call
naturalWidth/etc, and sometimes it doesn&#39;t; using setTimeout
gives it a chance to catch up</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">var</span> width = img.naturalWidth || img.width;
        <span class="keyword">var</span> height = img.naturalHeight || img.height;
        width = width * (session.AVATAR_SIZE / height);
        height = session.AVATAR_SIZE;
        context.drawImage(img, <span class="number">0</span>, <span class="number">0</span>, width, height);
        callback($canvas[<span class="number">0</span>].toDataURL(<span class="string">"image/png"</span>));
      });
    }

  });

  <span class="comment">/****************************************
   * RTC support
   */</span>

  <span class="function"><span class="keyword">function</span> <span class="title">audioButton</span><span class="params">(selector)</span> {</span>
    ui.displayToggle(selector);
    <span class="keyword">if</span> (selector == <span class="string">"#towtruck-audio-incoming"</span>) {
      $(<span class="string">"#towtruck-audio-button"</span>).addClass(<span class="string">"towtruck-animated"</span>).addClass(<span class="string">"towtruck-color-alert"</span>);
    } <span class="keyword">else</span> {
      $(<span class="string">"#towtruck-audio-button"</span>).removeClass(<span class="string">"towtruck-animated"</span>).removeClass(<span class="string">"towtruck-color-alert"</span>);
    }
  }

  session.on(<span class="string">"ui-ready"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    $(<span class="string">"#towtruck-audio-button"</span>).click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">if</span> ($(<span class="string">"#towtruck-rtc-info"</span>).is(<span class="string">":visible"</span>)) {
        windowing.hide();
        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span> (session.RTCSupported) {
        enableAudio();
      } <span class="keyword">else</span> {
        windowing.show(<span class="string">"#towtruck-rtc-not-supported"</span>);
      }
    });

    <span class="keyword">if</span> (! session.RTCSupported) {
      audioButton(<span class="string">"#towtruck-audio-unavailable"</span>);
      <span class="keyword">return</span>;
    }
    audioButton(<span class="string">"#towtruck-audio-ready"</span>);

    <span class="keyword">var</span> audioStream = <span class="literal">null</span>;
    <span class="keyword">var</span> accepted = <span class="literal">false</span>;
    <span class="keyword">var</span> connected = <span class="literal">false</span>;
    <span class="keyword">var</span> $audio = $(<span class="string">"#towtruck-audio-element"</span>);
    <span class="keyword">var</span> offerSent = <span class="literal">null</span>;
    <span class="keyword">var</span> offerReceived = <span class="literal">null</span>;
    <span class="keyword">var</span> offerDescription = <span class="literal">false</span>;
    <span class="keyword">var</span> answerSent = <span class="literal">null</span>;
    <span class="keyword">var</span> answerReceived = <span class="literal">null</span>;
    <span class="keyword">var</span> answerDescription = <span class="literal">false</span>;
    <span class="keyword">var</span> _connection = <span class="literal">null</span>;
    <span class="keyword">var</span> iceCandidate = <span class="literal">null</span>;

    <span class="function"><span class="keyword">function</span> <span class="title">enableAudio</span><span class="params">()</span> {</span>
      accepted = <span class="literal">true</span>;
      storage.settings.get(<span class="string">"dontShowRtcInfo"</span>).then(<span class="function"><span class="keyword">function</span> <span class="params">(dontShow)</span> {</span>
        <span class="keyword">if</span> (! dontShow) {
          windowing.show(<span class="string">"#towtruck-rtc-info"</span>);
        }
      });
      <span class="keyword">if</span> (! audioStream) {
        startStreaming(connect);
        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span> (! connected) {
        connect();
      }
      toggleMute();
    }

    ui.container.find(<span class="string">"#towtruck-rtc-info .towtruck-dont-show-again"</span>).change(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      storage.settings.set(<span class="string">"dontShowRtcInfo"</span>, <span class="keyword">this</span>.checked);
    });

    <span class="function"><span class="keyword">function</span> <span class="title">error</span><span class="params">()</span> {</span>
      console.warn.apply(console, arguments);
      <span class="keyword">var</span> s = <span class="string">""</span>;
      <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;arguments.length; i++) {
        <span class="keyword">if</span> (s) {
          s += <span class="string">" "</span>;
        }
        <span class="keyword">var</span> a = arguments[i];
        <span class="keyword">if</span> (<span class="keyword">typeof</span> a == <span class="string">"string"</span>) {
          s += a;
        } <span class="keyword">else</span> {
          <span class="keyword">var</span> repl;
          <span class="keyword">try</span> {
            repl = JSON.stringify(a);
          } <span class="keyword">catch</span> (e) {
          }
          <span class="keyword">if</span> (! repl) {
            repl = <span class="string">""</span> + a;
          }
          s += repl;
        }
      }
      audioButton(<span class="string">"#towtruck-audio-error"</span>);</pre></div></div>
              
            </li>
          
            <li id="section-249">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-249">&#182;</a>
                </div>
                <p>FIXME: this title doesn&#39;t seem to display?</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      $(<span class="string">"#towtruck-audio-error"</span>).attr(<span class="string">"title"</span>, s);
    }

    <span class="function"><span class="keyword">function</span> <span class="title">startStreaming</span><span class="params">(callback)</span> {</span>
      getUserMedia(
        {
          video: <span class="literal">false</span>,
          audio: <span class="literal">true</span>
        },
        <span class="function"><span class="keyword">function</span> <span class="params">(stream)</span> {</span>
          audioStream = stream;
          attachMedia(<span class="string">"#towtruck-local-audio"</span>, stream);
          <span class="keyword">if</span> (callback) {
            callback();
          }
        },
        <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-250">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-250">&#182;</a>
                </div>
                <p>FIXME: handle cancel case</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>          <span class="keyword">if</span> (err &amp;&amp; err.code == <span class="number">1</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-251">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-251">&#182;</a>
                </div>
                <p>User cancel</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span>;
          }
          error(<span class="string">"getUserMedia error:"</span>, err);
        }
      );
    }

    <span class="function"><span class="keyword">function</span> <span class="title">attachMedia</span><span class="params">(element, media)</span> {</span>
      element = $(element)[<span class="number">0</span>];
      console.log(<span class="string">"Attaching"</span>, media, <span class="string">"to"</span>, element);
      <span class="keyword">if</span> (window.mozRTCPeerConnection) {
        element.mozSrcObject = media;
        element.play();
      } <span class="keyword">else</span> {
        element.autoplay = <span class="literal">true</span>;
        element.src = URL.createObjectURL(media);
      }
    }

    <span class="function"><span class="keyword">function</span> <span class="title">getConnection</span><span class="params">()</span> {</span>
      assert(audioStream);
      <span class="keyword">if</span> (_connection) {
        <span class="keyword">return</span> _connection;
      }
      <span class="keyword">try</span> {
        _connection = makePeerConnection();
      } <span class="keyword">catch</span> (e) {
        error(<span class="string">"Error creating PeerConnection:"</span>, e);
        <span class="keyword">throw</span> e;
      }
      _connection.onaddstream = <span class="function"><span class="keyword">function</span> <span class="params">(event)</span> {</span>
        console.log(<span class="string">"got event"</span>, event, event.type);
        attachMedia($audio, event.stream);
        audioButton(<span class="string">"#towtruck-audio-active"</span>);
      };
      _connection.onstatechange = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-252">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-252">&#182;</a>
                </div>
                <p>FIXME: this doesn&#39;t seem to work:
Actually just doesn&#39;t work on Firefox</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        console.log(<span class="string">"state change"</span>, _connection.readyState);
        <span class="keyword">if</span> (_connection.readyState == <span class="string">"closed"</span>) {
          audioButton(<span class="string">"#towtruck-audio-ready"</span>);
        }
      };
      _connection.onicecandidate = <span class="function"><span class="keyword">function</span> <span class="params">(event)</span> {</span>
        <span class="keyword">if</span> (event.candidate) {
          session.send({
            type: <span class="string">"rtc-ice-candidate"</span>,
            candidate: {
              sdpMLineIndex: event.candidate.sdpMLineIndex,
              sdpMid: event.candidate.sdpMid,
              candidate: event.candidate.candidate
            }
          });
        }
      };
      _connection.addStream(audioStream);
      <span class="keyword">return</span> _connection;
    }

    <span class="function"><span class="keyword">function</span> <span class="title">addIceCandidate</span><span class="params">()</span> {</span>
      <span class="keyword">if</span> (iceCandidate) {
        console.log(<span class="string">"adding ice"</span>, iceCandidate);
        _connection.addIceCandidate(<span class="keyword">new</span> RTCIceCandidate(iceCandidate));
      }
    }

    <span class="function"><span class="keyword">function</span> <span class="title">connect</span><span class="params">()</span> {</span>
      <span class="keyword">var</span> connection = getConnection();
      <span class="keyword">if</span> (offerReceived &amp;&amp; (! offerDescription)) {
        connection.setRemoteDescription(
          <span class="keyword">new</span> RTCSessionDescription({
            type: <span class="string">"offer"</span>,
            sdp: offerReceived
          }),
          <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            offerDescription = <span class="literal">true</span>;
            addIceCandidate();
            connect();
          },
          <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
            error(<span class="string">"Error doing RTC setRemoteDescription:"</span>, err);
          }
        );
        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span> (! (offerSent || offerReceived)) {
        connection.createOffer(<span class="function"><span class="keyword">function</span> <span class="params">(offer)</span> {</span>
          console.log(<span class="string">"made offer"</span>, offer);
          offer.sdp = ensureCryptoLine(offer.sdp);
          connection.setLocalDescription(
            offer,
            <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
              session.send({
                type: <span class="string">"rtc-offer"</span>,
                offer: offer.sdp
              });
              offerSent = offer;
              audioButton(<span class="string">"#towtruck-audio-outgoing"</span>);
            },
            <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
              error(<span class="string">"Error doing RTC setLocalDescription:"</span>, err);
            },
            mediaConstraints
          );
        }, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
          error(<span class="string">"Error doing RTC createOffer:"</span>, err);
        });
      } <span class="keyword">else</span> <span class="keyword">if</span> (! (answerSent || answerReceived)) {</pre></div></div>
              
            </li>
          
            <li id="section-253">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-253">&#182;</a>
                </div>
                <p>FIXME: I might have only needed this due to my own bugs, this might
not actually time out</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> timeout = setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
          <span class="keyword">if</span> (! answerSent) {
            error(<span class="string">"createAnswer Timed out; reload or restart browser"</span>);
          }
        }, <span class="number">2000</span>);
        connection.createAnswer(<span class="function"><span class="keyword">function</span> <span class="params">(answer)</span> {</span>
          answer.sdp = ensureCryptoLine(answer.sdp);
          clearTimeout(timeout);
          connection.setLocalDescription(
            answer,
            <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
              session.send({
                type: <span class="string">"rtc-answer"</span>,
                answer: answer.sdp
              });
              answerSent = answer;
            },
            <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
              clearTimeout(timeout);
              error(<span class="string">"Error doing RTC setLocalDescription:"</span>, err);
            },
            mediaConstraints
          );
        }, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
          error(<span class="string">"Error doing RTC createAnswer:"</span>, err);
        });
      }
    }

    <span class="function"><span class="keyword">function</span> <span class="title">toggleMute</span><span class="params">()</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-254">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-254">&#182;</a>
                </div>
                <p>FIXME: implement.  Actually, wait for this to be implementable - currently
muting of localStreams isn&#39;t possible
FIXME: replace with hang-up?</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    }

    session.hub.on(<span class="string">"rtc-offer"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
      <span class="keyword">if</span> (offerReceived || answerSent || answerReceived || offerSent) {
        abort();
      }
      offerReceived = msg.offer;
      <span class="keyword">if</span> (! accepted) {
        audioButton(<span class="string">"#towtruck-audio-incoming"</span>);
        <span class="keyword">return</span>;
      }
      <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> connection = getConnection();
        connection.setRemoteDescription(
          <span class="keyword">new</span> RTCSessionDescription({
            type: <span class="string">"offer"</span>,
            sdp: offerReceived
          }),
          <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            offerDescription = <span class="literal">true</span>;
            addIceCandidate();
            connect();
          },
          <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
            error(<span class="string">"Error doing RTC setRemoteDescription:"</span>, err);
          }
        );
      }
      <span class="keyword">if</span> (! audioStream) {
        startStreaming(run);
      } <span class="keyword">else</span> {
        run();
      }
    });

    session.hub.on(<span class="string">"rtc-answer"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
      <span class="keyword">if</span> (answerSent || answerReceived || offerReceived || (! offerSent)) {
        abort();</pre></div></div>
              
            </li>
          
            <li id="section-255">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-255">&#182;</a>
                </div>
                <p>Basically we have to abort and try again.  We&#39;ll expect the other
client to restart when appropriate</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        session.send({type: <span class="string">"rtc-abort"</span>});
        <span class="keyword">return</span>;
      }
      answerReceived = msg.answer;
      assert(offerSent);
      assert(audioStream);
      <span class="keyword">var</span> connection = getConnection();
      connection.setRemoteDescription(
        <span class="keyword">new</span> RTCSessionDescription({
          type: <span class="string">"answer"</span>,
          sdp: answerReceived
        }),
        <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
          answerDescription = <span class="literal">true</span>;</pre></div></div>
              
            </li>
          
            <li id="section-256">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-256">&#182;</a>
                </div>
                <p>FIXME: I don&#39;t think this connect is ever needed?</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>          connect();
        },
        <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
          error(<span class="string">"Error doing RTC setRemoteDescription:"</span>, err);
        }
      );
    });

    session.hub.on(<span class="string">"rtc-ice-candidate"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
      iceCandidate = msg.candidate;
      <span class="keyword">if</span> (offerDescription || answerDescription) {
        addIceCandidate();
      }
    });

    session.hub.on(<span class="string">"rtc-abort"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
      abort();
      <span class="keyword">if</span> (! accepted) {
        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span> (! audioStream) {
        startStreaming(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
          connect();
        });
      } <span class="keyword">else</span> {
        connect();
      }
    });

    session.hub.on(<span class="string">"hello"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-257">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-257">&#182;</a>
                </div>
                <p>FIXME: displayToggle should be set due to
_connection.onstatechange, but that&#39;s not working, so
instead:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      audioButton(<span class="string">"#towtruck-audio-ready"</span>);
      <span class="keyword">if</span> (accepted &amp;&amp; (offerSent || answerSent)) {
        abort();
        connect();
      }
    });

    <span class="function"><span class="keyword">function</span> <span class="title">abort</span><span class="params">()</span> {</span>
      answerSent = answerReceived = offerSent = offerReceived = <span class="literal">null</span>;
      answerDescription = offerDescription = <span class="literal">false</span>;
      _connection = <span class="literal">null</span>;
      $audio[<span class="number">0</span>].removeAttribute(<span class="string">"src"</span>);
    }

  });

  <span class="keyword">return</span> webrtc;

});

<span class="comment">/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>

define(<span class="string">'eventMaker'</span>,[<span class="string">"jquery"</span>, <span class="string">"util"</span>], <span class="function"><span class="keyword">function</span> <span class="params">($, util)</span> {</span>
  <span class="keyword">var</span> eventMaker = util.Module(<span class="string">"eventMaker"</span>);
  <span class="keyword">var</span> assert = util.assert;

  eventMaker.performClick = <span class="function"><span class="keyword">function</span> <span class="params">(target)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-258">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-258">&#182;</a>
                </div>
                <p>FIXME: should accept other parameters, like Ctrl/Alt/etc</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> event = document.createEvent(<span class="string">"MouseEvents"</span>);
    event.initMouseEvent(
      <span class="string">"click"</span>, <span class="comment">// type</span>
      <span class="literal">true</span>, <span class="comment">// canBubble</span>
      <span class="literal">true</span>, <span class="comment">// cancelable</span>
      window, <span class="comment">// view</span>
      <span class="number">0</span>, <span class="comment">// detail</span>
      <span class="number">0</span>, <span class="comment">// screenX</span>
      <span class="number">0</span>, <span class="comment">// screenY</span>
      <span class="number">0</span>, <span class="comment">// clientX</span>
      <span class="number">0</span>, <span class="comment">// clientY</span>
      <span class="literal">false</span>, <span class="comment">// ctrlKey</span>
      <span class="literal">false</span>, <span class="comment">// altKey</span>
      <span class="literal">false</span>, <span class="comment">// shiftKey</span>
      <span class="literal">false</span>, <span class="comment">// metaKey</span>
      <span class="number">0</span>, <span class="comment">// button</span>
      <span class="literal">null</span> <span class="comment">// relatedTarget</span>
    );</pre></div></div>
              
            </li>
          
            <li id="section-259">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-259">&#182;</a>
                </div>
                <p>FIXME: I&#39;m not sure this custom attribute always propagates?
seems okay in Firefox/Chrome, but I&#39;ve had problems with
setting attributes on keyboard events in the past.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    event.towtruckInternal = <span class="literal">true</span>;
    target = $(target)[<span class="number">0</span>];
    <span class="keyword">var</span> cancelled = target.dispatchEvent(event);
    <span class="keyword">if</span> (cancelled) {
      <span class="keyword">return</span>;
    }
    <span class="keyword">if</span> (target.tagName == <span class="string">"A"</span>) {
      <span class="keyword">var</span> href = target.href;
      <span class="keyword">if</span> (href) {
        location.href = href;
        <span class="keyword">return</span>;
      }
    }</pre></div></div>
              
            </li>
          
            <li id="section-260">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-260">&#182;</a>
                </div>
                <p>FIXME: should do button clicks (like a form submit)
FIXME: should run .onclick() as well</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  };

  eventMaker.fireChange = <span class="function"><span class="keyword">function</span> <span class="params">(target)</span> {</span>
    target = $(target)[<span class="number">0</span>];
    <span class="keyword">var</span> event = document.createEvent(<span class="string">"HTMLEvents"</span>);
    event.initEvent(<span class="string">"change"</span>, <span class="literal">true</span>, <span class="literal">true</span>);
    <span class="keyword">var</span> cancelled = target.dispatchEvent(event);
  };

  <span class="keyword">return</span> eventMaker;
});

<span class="comment">/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/. */</span></pre></div></div>
              
            </li>
          
            <li id="section-261">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-261">&#182;</a>
                </div>
                <p>Cursor viewing support</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>define(<span class="string">'cursor'</span>,[<span class="string">"jquery"</span>, <span class="string">"ui"</span>, <span class="string">"util"</span>, <span class="string">"session"</span>, <span class="string">"elementFinder"</span>, <span class="string">"tinycolor"</span>, <span class="string">"eventMaker"</span>, <span class="string">"peers"</span>, <span class="string">"templating"</span>], <span class="function"><span class="keyword">function</span> <span class="params">($, ui, util, session, elementFinder, tinycolor, eventMaker, peers, templating)</span> {</span>
  <span class="keyword">var</span> assert = util.assert;
  <span class="keyword">var</span> cursor = util.Module(<span class="string">"cursor"</span>);

  <span class="keyword">var</span> FOREGROUND_COLORS = [<span class="string">"#111"</span>, <span class="string">"#eee"</span>];
  <span class="keyword">var</span> CURSOR_HEIGHT = <span class="number">50</span>;
  <span class="keyword">var</span> CURSOR_ANGLE = (<span class="number">35</span> / <span class="number">180</span>) * Math.PI;
  <span class="keyword">var</span> CURSOR_WIDTH = Math.ceil(Math.sin(CURSOR_ANGLE) * CURSOR_HEIGHT);</pre></div></div>
              
            </li>
          
            <li id="section-262">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-262">&#182;</a>
                </div>
                <p>Number of milliseconds after page load in which a scroll-update
related hello-back message will be processed:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> SCROLL_UPDATE_CUTOFF = <span class="number">2000</span>;

  session.hub.on(<span class="string">"cursor-update"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    <span class="keyword">if</span> (msg.sameUrl) {
      Cursor.getClient(msg.clientId).updatePosition(msg);
    } <span class="keyword">else</span> {</pre></div></div>
              
            </li>
          
            <li id="section-263">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-263">&#182;</a>
                </div>
                <p>FIXME: This should be caught even before the cursor-update message,
when the peer goes to another URL</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      Cursor.getClient(msg.clientId).hideOtherUrl(msg);
    }
  });</pre></div></div>
              
            </li>
          
            <li id="section-264">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-264">&#182;</a>
                </div>
                <p>FIXME: should check for a peer leaving and remove the cursor object</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> Cursor = util.Class({

    constructor: <span class="function"><span class="keyword">function</span> <span class="params">(clientId)</span> {</span>
      <span class="keyword">this</span>.clientId = clientId;
      <span class="keyword">this</span>.element = templating.clone(<span class="string">"cursor"</span>);
      <span class="keyword">this</span>.elementClass = <span class="string">"towtruck-scrolled-normal"</span>;
      <span class="keyword">this</span>.element.addClass(<span class="keyword">this</span>.elementClass);
      <span class="keyword">this</span>.updatePeer(peers.getPeer(clientId));
      <span class="keyword">this</span>.lastTop = <span class="keyword">this</span>.lastLeft = <span class="literal">null</span>;
      $(document.body).append(<span class="keyword">this</span>.element);
      <span class="keyword">this</span>.element.animateCursorEntry();
      <span class="keyword">this</span>.keydownTimeout = <span class="literal">null</span>;
      <span class="keyword">this</span>.clearKeydown = <span class="keyword">this</span>.clearKeydown.bind(<span class="keyword">this</span>);
      <span class="keyword">this</span>.atOtherUrl = <span class="literal">false</span>;
    },</pre></div></div>
              
            </li>
          
            <li id="section-265">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-265">&#182;</a>
                </div>
                <p>How long after receiving a setKeydown call that we should show the
user typing.  This should be more than MIN_KEYDOWN_TIME:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    KEYDOWN_WAIT_TIME: <span class="number">2000</span>,

    updatePeer: <span class="function"><span class="keyword">function</span> <span class="params">(peer)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-266">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-266">&#182;</a>
                </div>
                <p>FIXME: can I use peer.setElement()?</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">this</span>.element.css({color: peer.color});
      <span class="keyword">var</span> img = <span class="keyword">this</span>.element.find(<span class="string">"img.towtruck-cursor-img"</span>);
      img.attr(<span class="string">"src"</span>, makeCursor(peer.color));
      <span class="keyword">var</span> name = <span class="keyword">this</span>.element.find(<span class="string">".towtruck-cursor-name"</span>);
      <span class="keyword">var</span> nameContainer = <span class="keyword">this</span>.element.find(<span class="string">".towtruck-cursor-container"</span>);
      assert(name.length);
      name.text(peer.name);
      nameContainer.css({
        backgroundColor: peer.color,
        color: tinycolor.mostReadable(peer.color, FOREGROUND_COLORS)
      });
      <span class="keyword">var</span> path = <span class="keyword">this</span>.element.find(<span class="string">"svg path"</span>);
      path.attr(<span class="string">"fill"</span>, peer.color);</pre></div></div>
              
            </li>
          
            <li id="section-267">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-267">&#182;</a>
                </div>
                <p>FIXME: should I just remove the element?</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (peer.status != <span class="string">"live"</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-268">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-268">&#182;</a>
                </div>
                <p>this.element.hide();</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.element.find(<span class="string">"svg"</span>).animate({
          opacity: <span class="number">0</span>
        }, <span class="number">350</span>);
        <span class="keyword">this</span>.element.find(<span class="string">".towtruck-cursor-container"</span>).animate({
                width: <span class="number">34</span>,
                height: <span class="number">20</span>,
                padding: <span class="number">12</span>,
                margin: <span class="number">0</span>
            }, <span class="number">200</span>).animate({
                width: <span class="number">0</span>,
                height: <span class="number">0</span>,
                padding: <span class="number">0</span>,
                opacity: <span class="number">0</span>
                }, <span class="number">200</span>);
      } <span class="keyword">else</span> {</pre></div></div>
              
            </li>
          
            <li id="section-269">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-269">&#182;</a>
                </div>
                <p>this.element.show();</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.element.animate({
          opacity:<span class="number">0.3</span>
        }).animate({
          opacity:<span class="number">1</span>
        });
      }
    },

    setClass: <span class="function"><span class="keyword">function</span> <span class="params">(name)</span> {</span>
      <span class="keyword">if</span> (name != <span class="keyword">this</span>.elementClass) {
        <span class="keyword">this</span>.element.removeClass(<span class="keyword">this</span>.elementClass).addClass(name);
        <span class="keyword">this</span>.elementClass = name;
      }
    },

    updatePosition: <span class="function"><span class="keyword">function</span> <span class="params">(pos)</span> {</span>
      <span class="keyword">var</span> top, left;
      <span class="keyword">if</span> (<span class="keyword">this</span>.atOtherUrl) {
        <span class="keyword">this</span>.element.show();
        <span class="keyword">this</span>.atOtherUrl = <span class="literal">false</span>;
      }
      <span class="keyword">if</span> (pos.element) {
        <span class="keyword">var</span> target = $(elementFinder.findElement(pos.element));
        <span class="keyword">var</span> offset = target.offset();
        top = offset.top + pos.offsetY;
        left = offset.left + pos.offsetX;
      } <span class="keyword">else</span> {</pre></div></div>
              
            </li>
          
            <li id="section-270">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-270">&#182;</a>
                </div>
                <p>No anchor, just an absolute position</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        top = pos.top;
        left = pos.left;
      }</pre></div></div>
              
            </li>
          
            <li id="section-271">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-271">&#182;</a>
                </div>
                <p>These are saved for use by .refresh():</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">this</span>.lastTop = top;
      <span class="keyword">this</span>.lastLeft = left;
      <span class="keyword">this</span>.setPosition(top, left);
    },

    hideOtherUrl: <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
      <span class="keyword">if</span> (<span class="keyword">this</span>.atOtherUrl) {
        <span class="keyword">return</span>;
      }
      <span class="keyword">this</span>.atOtherUrl = <span class="literal">true</span>;</pre></div></div>
              
            </li>
          
            <li id="section-272">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-272">&#182;</a>
                </div>
                <p>FIXME: should show away status better:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">this</span>.element.hide();
    },</pre></div></div>
              
            </li>
          
            <li id="section-273">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-273">&#182;</a>
                </div>
                <p>place Cursor rotate function down here FIXME: this doesnt do anything anymore.  This is in the CSS as an animation</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    rotateCursorDown: <span class="keyword">function</span>(){
      <span class="keyword">var</span> e = $(<span class="keyword">this</span>.element).find(<span class="string">'svg'</span>);
        e.animate({borderSpacing: -<span class="number">150</span>, opacity: <span class="number">1</span>}, {
        step: <span class="keyword">function</span>(now, fx) {
          <span class="keyword">if</span> (fx.prop == <span class="string">"borderSpacing"</span>) {
            e.css(<span class="string">'-webkit-transform'</span>, <span class="string">'rotate('</span>+now+<span class="string">'deg)'</span>)
              .css(<span class="string">'-moz-transform'</span>, <span class="string">'rotate('</span>+now+<span class="string">'deg)'</span>)
              .css(<span class="string">'-ms-transform'</span>, <span class="string">'rotate('</span>+now+<span class="string">'deg)'</span>)
              .css(<span class="string">'-o-transform'</span>, <span class="string">'rotate('</span>+now+<span class="string">'deg)'</span>)
              .css(<span class="string">'transform'</span>, <span class="string">'rotate('</span>+now+<span class="string">'deg)'</span>);
          } <span class="keyword">else</span> {
            e.css(fx.prop, now);
          }
        },
        duration: <span class="number">500</span>
      }, <span class="string">'linear'</span>).promise().then(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        e.css(<span class="string">'-webkit-transform'</span>, <span class="string">''</span>)
          .css(<span class="string">'-moz-transform'</span>, <span class="string">''</span>)
          .css(<span class="string">'-ms-transform'</span>, <span class="string">''</span>)
          .css(<span class="string">'-o-transform'</span>, <span class="string">''</span>)
          .css(<span class="string">'transform'</span>, <span class="string">''</span>)
          .css(<span class="string">"opacity"</span>, <span class="string">""</span>);
      });
    },

    setPosition: <span class="function"><span class="keyword">function</span> <span class="params">(top, left)</span> {</span>
      <span class="keyword">var</span> wTop = $(window).scrollTop();
      <span class="keyword">var</span> height = $(window).height();

      <span class="keyword">if</span> (top &lt; wTop) {</pre></div></div>
              
            </li>
          
            <li id="section-274">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-274">&#182;</a>
                </div>
                <p>FIXME: this is a totally arbitrary number, but is meant to be big enough
to keep the cursor name from being off the top of the screen.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        top = <span class="number">25</span>;
        <span class="keyword">this</span>.setClass(<span class="string">"towtruck-scrolled-above"</span>);
      } <span class="keyword">else</span> <span class="keyword">if</span> (top &gt; wTop + height - CURSOR_HEIGHT) {
        top = height - CURSOR_HEIGHT - <span class="number">5</span>;
        <span class="keyword">this</span>.setClass(<span class="string">"towtruck-scrolled-below"</span>);
      } <span class="keyword">else</span> {
        <span class="keyword">this</span>.setClass(<span class="string">"towtruck-scrolled-normal"</span>);
      }
      <span class="keyword">this</span>.element.css({
        top: top,
        left: left
      });
    },

    refresh: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">if</span> (<span class="keyword">this</span>.lastTop !== <span class="literal">null</span>) {
        <span class="keyword">this</span>.setPosition(<span class="keyword">this</span>.lastTop, <span class="keyword">this</span>.lastLeft);
      }
    },

    setKeydown: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">if</span> (<span class="keyword">this</span>.keydownTimeout) {
        clearTimeout(<span class="keyword">this</span>.keydownTimeout);
      } <span class="keyword">else</span> {
        <span class="keyword">this</span>.element.find(<span class="string">".towtruck-cursor-typing"</span>).show().animateKeyboard();
      }
      <span class="keyword">this</span>.keydownTimeout = setTimeout(<span class="keyword">this</span>.clearKeydown, <span class="keyword">this</span>.KEYDOWN_WAIT_TIME);
    },

    clearKeydown: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">this</span>.keydownTimeout = <span class="literal">null</span>;
      <span class="keyword">this</span>.element.find(<span class="string">".towtruck-cursor-typing"</span>).hide().stopKeyboardAnimation();
    },

    _destroy: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">this</span>.element.remove();
      <span class="keyword">this</span>.element = <span class="literal">null</span>;
    }
  });

  Cursor._cursors = {};

  cursor.getClient = Cursor.getClient = <span class="function"><span class="keyword">function</span> <span class="params">(clientId)</span> {</span>
    <span class="keyword">var</span> c = Cursor._cursors[clientId];
    <span class="keyword">if</span> (! c) {
      c = Cursor._cursors[clientId] = Cursor(clientId);
    }
    <span class="keyword">return</span> c;
  };

  Cursor.forEach = <span class="function"><span class="keyword">function</span> <span class="params">(callback, context)</span> {</span>
    context = context || <span class="literal">null</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> a <span class="keyword">in</span> Cursor._cursors) {
      <span class="keyword">if</span> (Cursor._cursors.hasOwnProperty(a)) {
        callback.call(context, Cursor._cursors[a], a);
      }
    }
  };

  Cursor.destroy = <span class="function"><span class="keyword">function</span> <span class="params">(clientId)</span> {</span>
    Cursor._cursors[clientId]._destroy();
    <span class="keyword">delete</span> Cursor._cursors[clientId];
  };

  peers.on(<span class="string">"new-peer identity-updated status-updated"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(peer)</span> {</span>
    <span class="keyword">var</span> c = Cursor.getClient(peer.id);
    c.updatePeer(peer);
  });

  <span class="keyword">var</span> lastTime = <span class="number">0</span>;
  <span class="keyword">var</span> MIN_TIME = <span class="number">100</span>;
  <span class="keyword">var</span> lastPosX = -<span class="number">1</span>;
  <span class="keyword">var</span> lastPosY = -<span class="number">1</span>;
  <span class="keyword">var</span> lastMessage = <span class="literal">null</span>;
  <span class="function"><span class="keyword">function</span> <span class="title">mousemove</span><span class="params">(event)</span> {</span>
    <span class="keyword">var</span> now = Date.now();
    <span class="keyword">if</span> (now - lastTime &lt; MIN_TIME) {
      <span class="keyword">return</span>;
    }
    lastTime = now;
    <span class="keyword">var</span> pageX = event.pageX;
    <span class="keyword">var</span> pageY = event.pageY;
    <span class="keyword">if</span> (Math.abs(lastPosX - pageX) &lt; <span class="number">3</span> &amp;&amp; Math.abs(lastPosY - pageY) &lt; <span class="number">3</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-275">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-275">&#182;</a>
                </div>
                <p>Not a substantial enough change</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">return</span>;
    }
    lastPosX = pageX;
    lastPosY = pageY;
    <span class="keyword">var</span> target = event.target;
    <span class="keyword">var</span> parent = $(target).closest(<span class="string">".towtruck-window, .towtruck-popup, #towtruck-dock"</span>);
    <span class="keyword">if</span> (parent.length) {
      target = parent[<span class="number">0</span>];
    } <span class="keyword">else</span> <span class="keyword">if</span> (elementFinder.ignoreElement(target)) {
      target = <span class="literal">null</span>;
    }
    <span class="keyword">if</span> ((! target) || target == document.documentElement || target == document.body) {
      lastMessage = {
        type: <span class="string">"cursor-update"</span>,
        top: pageY,
        left: pageX
      };
      session.send(lastMessage);
      <span class="keyword">return</span>;
    }
    target = $(target);
    <span class="keyword">var</span> offset = target.offset();
    <span class="keyword">if</span> (! offset) {</pre></div></div>
              
            </li>
          
            <li id="section-276">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-276">&#182;</a>
                </div>
                <p>FIXME: this really is walkabout.js&#39;s problem to fire events on the
document instead of a specific element</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      console.warn(<span class="string">"Could not get offset of element:"</span>, target[<span class="number">0</span>]);
      <span class="keyword">return</span>;
    }
    <span class="keyword">var</span> offsetX = pageX - offset.left;
    <span class="keyword">var</span> offsetY = pageY - offset.top;
    lastMessage = {
      type: <span class="string">"cursor-update"</span>,
      element: elementFinder.elementLocation(target),
      offsetX: Math.floor(offsetX),
      offsetY: Math.floor(offsetY)
    };
    session.send(lastMessage);
  }

  <span class="function"><span class="keyword">function</span> <span class="title">makeCursor</span><span class="params">(color)</span> {</span>
    <span class="keyword">var</span> canvas = $(<span class="string">"&lt;canvas&gt;&lt;/canvas&gt;"</span>);
    canvas.attr(<span class="string">"height"</span>, CURSOR_HEIGHT);
    canvas.attr(<span class="string">"width"</span>, CURSOR_WIDTH);
    <span class="keyword">var</span> context = canvas[<span class="number">0</span>].getContext(<span class="string">'2d'</span>);
    context.fillStyle = color;
    context.moveTo(<span class="number">0</span>, <span class="number">0</span>);
    context.beginPath();
    context.lineTo(<span class="number">0</span>, CURSOR_HEIGHT/<span class="number">1.2</span>);
    context.lineTo(Math.sin(CURSOR_ANGLE/<span class="number">2</span>) * CURSOR_HEIGHT / <span class="number">1.5</span>,
                   Math.cos(CURSOR_ANGLE/<span class="number">2</span>) * CURSOR_HEIGHT / <span class="number">1.5</span>);
    context.lineTo(Math.sin(CURSOR_ANGLE) * CURSOR_HEIGHT / <span class="number">1.2</span>,
                   Math.cos(CURSOR_ANGLE) * CURSOR_HEIGHT / <span class="number">1.2</span>);
    context.lineTo(<span class="number">0</span>, <span class="number">0</span>);
    context.shadowColor = <span class="string">'rgba(0,0,0,0.3)'</span>;
    context.shadowBlur = <span class="number">2</span>;
    context.shadowOffsetX = <span class="number">1</span>;
    context.shadowOffsetY = <span class="number">2</span>;
	context.strokeStyle = <span class="string">"#ffffff"</span>;
	context.stroke();
    context.fill();
    <span class="keyword">return</span> canvas[<span class="number">0</span>].toDataURL(<span class="string">"image/png"</span>);
  }

  <span class="keyword">var</span> scrollTimeout = <span class="literal">null</span>;
  <span class="keyword">var</span> scrollTimeoutSet = <span class="number">0</span>;
  <span class="keyword">var</span> SCROLL_DELAY_TIMEOUT = <span class="number">75</span>;
  <span class="keyword">var</span> SCROLL_DELAY_LIMIT = <span class="number">300</span>;

  <span class="function"><span class="keyword">function</span> <span class="title">scroll</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> now = Date.now();
    <span class="keyword">if</span> (scrollTimeout) {
      <span class="keyword">if</span> (now - scrollTimeoutSet &lt; SCROLL_DELAY_LIMIT) {
        clearTimeout(scrollTimeout);
      } <span class="keyword">else</span> {</pre></div></div>
              
            </li>
          
            <li id="section-277">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-277">&#182;</a>
                </div>
                <p>Just let it progress anyway</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span>;
      }
    }
    scrollTimeout = setTimeout(_scrollRefresh, SCROLL_DELAY_TIMEOUT);
    <span class="keyword">if</span> (! scrollTimeoutSet) {
      scrollTimeoutSet = now;
    }
  }

  <span class="keyword">var</span> lastScrollMessage = <span class="literal">null</span>;
  <span class="function"><span class="keyword">function</span> <span class="title">_scrollRefresh</span><span class="params">()</span> {</span>
    scrollTimeout = <span class="literal">null</span>;
    scrollTimeoutSet = <span class="number">0</span>;
    Cursor.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(c)</span> {</span>
      c.refresh();
    });
    lastScrollMessage = {
      type: <span class="string">"scroll-update"</span>,
      position: elementFinder.elementByPixel($(window).scrollTop())
    };
    session.send(lastScrollMessage);
  }</pre></div></div>
              
            </li>
          
            <li id="section-278">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-278">&#182;</a>
                </div>
                <p>FIXME: do the same thing for cursor position?  And give up on the
ad hoc update-on-hello?</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  session.on(<span class="string">"prepare-hello"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(helloMessage)</span> {</span>
    <span class="keyword">if</span> (lastScrollMessage) {
      helloMessage.scrollPosition = lastScrollMessage.position;
    }
  });

  session.hub.on(<span class="string">"scroll-update"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    msg.peer.scrollPosition = msg.position;
    <span class="keyword">if</span> (msg.peer.following) {
      msg.peer.view.scrollTo();
    }
  });</pre></div></div>
              
            </li>
          
            <li id="section-279">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-279">&#182;</a>
                </div>
                <p>In case there are multiple peers, we track that we&#39;ve accepted one of their
hello-based scroll updates, just so we don&#39;t bounce around (we don&#39;t intelligently
choose which one to use, just the first that comes in)</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> acceptedScrollUpdate = <span class="literal">false</span>;
  session.hub.on(<span class="string">"hello-back hello"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    <span class="keyword">if</span> (msg.type == <span class="string">"hello"</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-280">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-280">&#182;</a>
                </div>
                <p>Once a hello comes in, a bunch of hello-backs not intended for us will also
come in, and we should ignore them</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      acceptedScrollUpdate = <span class="literal">true</span>;
    }
    <span class="keyword">if</span> (! msg.scrollPosition) {
      <span class="keyword">return</span>;
    }
    msg.peer.scrollPosition = msg.scrollPosition;
    <span class="keyword">if</span> ((! acceptedScrollUpdate) &amp;&amp;
        msg.sameUrl &amp;&amp;
        Date.now() - session.timeHelloSent &lt; SCROLL_UPDATE_CUTOFF) {
      acceptedScrollUpdate = <span class="literal">true</span>;
      msg.peer.view.scrollTo();
    }
  });

  session.on(<span class="string">"ui-ready"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    $(document).mousemove(mousemove);
    document.addEventListener(<span class="string">"click"</span>, documentClick, <span class="literal">true</span>);
    document.addEventListener(<span class="string">"keydown"</span>, documentKeydown, <span class="literal">true</span>);
    $(window).scroll(scroll);
    scroll();
  });

  session.on(<span class="string">"close"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    Cursor.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(c, clientId)</span> {</span>
      Cursor.destroy(clientId);
    });
    $(document).unbind(<span class="string">"mousemove"</span>, mousemove);
    document.removeEventListener(<span class="string">"click"</span>, documentClick, <span class="literal">true</span>);
    document.removeEventListener(<span class="string">"keydown"</span>, documentKeydown, <span class="literal">true</span>);
    $(window).unbind(<span class="string">"scroll"</span>, scroll);
  });

  session.hub.on(<span class="string">"hello"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-281">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-281">&#182;</a>
                </div>
                <p>Immediately get our cursor onto this new person&#39;s screen:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (lastMessage) {
      session.send(lastMessage);
    }
    <span class="keyword">if</span> (lastScrollMessage) {
      session.send(lastScrollMessage);
    }
  });

  <span class="function"><span class="keyword">function</span> <span class="title">documentClick</span><span class="params">(event)</span> {</span>
    <span class="keyword">if</span> (event.towtruckInternal) {</pre></div></div>
              
            </li>
          
            <li id="section-282">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-282">&#182;</a>
                </div>
                <p>This is an artificial internal event</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">return</span>;
    }</pre></div></div>
              
            </li>
          
            <li id="section-283">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-283">&#182;</a>
                </div>
                <p>FIXME: this might just be my imagination, but somehow I just
really don&#39;t want to do anything at this stage of the event
handling (since I&#39;m catching every click), and I&#39;ll just do
something real soon:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">if</span> (! TowTruck.running) {</pre></div></div>
              
            </li>
          
            <li id="section-284">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-284">&#182;</a>
                </div>
                <p>This can end up running right after TowTruck has been closed, often
because TowTruck was closed with a click...</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span> (elementFinder.ignoreElement(event.target)) {
        <span class="keyword">return</span>;
      }
      <span class="keyword">var</span> location = elementFinder.elementLocation(event.target);
      <span class="keyword">var</span> offset = $(event.target).offset();
      <span class="keyword">var</span> offsetX = event.pageX - offset.left;
      <span class="keyword">var</span> offsetY = event.pageY - offset.top;
      session.send({
        type: <span class="string">"cursor-click"</span>,
        element: location,
        offsetX: offsetX,
        offsetY: offsetY
      });
      displayClick({top: event.pageY, left: event.pageX}, peers.Self.color);
    });
  }

  <span class="keyword">var</span> CLICK_TRANSITION_TIME = <span class="number">3000</span>;

  session.hub.on(<span class="string">"cursor-click"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(pos)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-285">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-285">&#182;</a>
                </div>
                <p>When the click is calculated isn&#39;t always the same as how the
last cursor update was calculated, so we force the cursor to
the last location during a click:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (! pos.sameUrl) {</pre></div></div>
              
            </li>
          
            <li id="section-286">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-286">&#182;</a>
                </div>
                <p>FIXME: if we <em>could have</em> done a local click, but we follow along
later, we&#39;ll be in different states if that click was important.
Mostly click cloning just won&#39;t work.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">return</span>;
    }
    Cursor.getClient(pos.clientId).updatePosition(pos);
    <span class="keyword">var</span> element = templating.clone(<span class="string">"click"</span>);
    <span class="keyword">var</span> target = $(elementFinder.findElement(pos.element));
    <span class="keyword">var</span> offset = target.offset();
    <span class="keyword">var</span> top = offset.top + pos.offsetY;
    <span class="keyword">var</span> left = offset.left + pos.offsetX;
    displayClick({top: top, left: left}, pos.peer.color);
    <span class="keyword">var</span> cloneClicks = TowTruck.getConfig(<span class="string">"cloneClicks"</span>);
    <span class="keyword">if</span> (cloneClicks &amp;&amp; target.is(cloneClicks)) {
      eventMaker.performClick(target);
    }
  });

  <span class="function"><span class="keyword">function</span> <span class="title">displayClick</span><span class="params">(pos, color)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-287">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-287">&#182;</a>
                </div>
                <p>FIXME: should we hide the local click if no one else is going to see it?
That means tracking who might be able to see our screen.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> element = templating.clone(<span class="string">"click"</span>);
    $(document.body).append(element);
    element.css({
      top: pos.top,
      left: pos.left,
      borderColor: color
    });
    setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      element.addClass(<span class="string">"towtruck-clicking"</span>);
    }, <span class="number">100</span>);
    setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      element.remove();
    }, CLICK_TRANSITION_TIME);
  }

  <span class="keyword">var</span> lastKeydown = <span class="number">0</span>;
  <span class="keyword">var</span> MIN_KEYDOWN_TIME = <span class="number">500</span>;

  <span class="function"><span class="keyword">function</span> <span class="title">documentKeydown</span><span class="params">(event)</span> {</span>
    setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">var</span> now = Date.now();
      <span class="keyword">if</span> (now - lastKeydown &lt; MIN_KEYDOWN_TIME) {
        <span class="keyword">return</span>;
      }
      lastKeydown = now;</pre></div></div>
              
            </li>
          
            <li id="section-288">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-288">&#182;</a>
                </div>
                <p>FIXME: is event.target interesting here?  That is, <em>what</em> the
user is typing into, not just that the user is typing?  Also
I&#39;m assuming we don&#39;t care if the user it typing into a
towtruck-related field, since chat activity is as interesting
as any other activity.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      session.send({type: <span class="string">"keydown"</span>});
    });
  }

  session.hub.on(<span class="string">"keydown"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-289">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-289">&#182;</a>
                </div>
                <p>FIXME: when the cursor is hidden there&#39;s nothing to show with setKeydown().</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> cursor = Cursor.getClient(msg.clientId);
    cursor.setKeydown();
  });

  util.testExpose({Cursor: Cursor});

  <span class="keyword">return</span> cursor;

});

<span class="comment">/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>

<span class="comment">/* This module handles all the different UI that happens (sometimes in order) when
   TowTruck is started:

   - Introduce the session when you've been invited
   - Show any browser compatibility indicators
   - Show the walkthrough the first time
   - Show the share link window

   When everything is done it fires session.emit("startup-ready")

*/</span>
define(<span class="string">'startup'</span>,[<span class="string">"util"</span>, <span class="string">"require"</span>, <span class="string">"jquery"</span>, <span class="string">"windowing"</span>, <span class="string">"storage"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(util, require, $, windowing, storage)</span> {</span>
  <span class="keyword">var</span> assert = util.assert;
  <span class="keyword">var</span> startup = util.Module(<span class="string">"startup"</span>);</pre></div></div>
              
            </li>
          
            <li id="section-290">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-290">&#182;</a>
                </div>
                <p>Avoid circular import:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> session = <span class="literal">null</span>;

  <span class="keyword">var</span> STEPS = [
    <span class="string">"browserBroken"</span>,
    <span class="string">"browserUnsupported"</span>,
    <span class="string">"sessionIntro"</span>,
    <span class="string">"walkthrough"</span>,</pre></div></div>
              
            </li>
          
            <li id="section-291">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-291">&#182;</a>
                </div>
                <p>Look in the share() below if you add anything after here:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="string">"share"</span>
    ];

  <span class="keyword">var</span> currentStep = <span class="literal">null</span>;

  startup.start = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">if</span> (! session) {
      require([<span class="string">"session"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(sessionModule)</span> {</span>
        session = sessionModule;
        startup.start();
      });
      <span class="keyword">return</span>;
    }
    <span class="keyword">var</span> index = -<span class="number">1</span>;
    <span class="keyword">if</span> (currentStep) {
      index = STEPS.indexOf(currentStep);
    }
    index++;
    <span class="keyword">if</span> (index &gt;= STEPS.length) {
      session.emit(<span class="string">"startup-ready"</span>);
      <span class="keyword">return</span>;
    }
    currentStep = STEPS[index];
    handlers[currentStep](startup.start);
  };

  <span class="keyword">var</span> handlers = {

    browserBroken: <span class="function"><span class="keyword">function</span> <span class="params">(next)</span> {</span>
      <span class="keyword">if</span> (window.WebSocket) {
        next();
        <span class="keyword">return</span>;
      }
      windowing.show(<span class="string">"#towtruck-browser-broken"</span>, {
        onClose: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
          session.close();
        }
      });
      <span class="keyword">if</span> ($.browser.msie) {
        $(<span class="string">"#towtruck-browser-broken-is-ie"</span>).show();
      }
    },

    browserUnsupported: <span class="function"><span class="keyword">function</span> <span class="params">(next)</span> {</span>
      <span class="keyword">if</span> (! $.browser.msie) {
        next();
        <span class="keyword">return</span>;
      }
      <span class="keyword">var</span> cancel = <span class="literal">true</span>;
      windowing.show(<span class="string">"#towtruck-browser-unsupported"</span>, {
        onClose: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
          <span class="keyword">if</span> (cancel) {
            session.close();
          } <span class="keyword">else</span> {
            next();
          }
        }
      });
      $(<span class="string">"#towtruck-browser-unsupported-anyway"</span>).click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        cancel = <span class="literal">false</span>;
      });
    },

    sessionIntro: <span class="function"><span class="keyword">function</span> <span class="params">(next)</span> {</span>
      <span class="keyword">if</span> ((! session.isClient) || ! session.firstRun) {
        next();
        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span> (TowTruck.getConfig(<span class="string">"suppressJoinConfirmation"</span>)) {
        next();
        <span class="keyword">return</span>;
      }
      <span class="keyword">var</span> cancelled = <span class="literal">false</span>;
      windowing.show(<span class="string">"#towtruck-intro"</span>, {
        onClose: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
          <span class="keyword">if</span> (! cancelled) {
            next();
          }
        }
      });
      $(<span class="string">"#towtruck-intro .towtruck-modal-dont-join"</span>).click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        cancelled = <span class="literal">true</span>;
        windowing.hide();
        session.close(<span class="string">"declined-join"</span>);
      });
    },

    walkthrough: <span class="function"><span class="keyword">function</span> <span class="params">(next)</span> {</span>
      storage.settings.get(<span class="string">"seenIntroDialog"</span>).then(<span class="function"><span class="keyword">function</span> <span class="params">(seenIntroDialog)</span> {</span>
        <span class="keyword">if</span> (seenIntroDialog) {
          next();
          <span class="keyword">return</span>;
        }
        require([<span class="string">"walkthrough"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(walkthrough)</span> {</span>
          walkthrough.start(<span class="literal">true</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            storage.settings.set(<span class="string">"seenIntroDialog"</span>, <span class="literal">true</span>);
            next();
          });
        });
      });
    },

    share: <span class="function"><span class="keyword">function</span> <span class="params">(next)</span> {</span>
      <span class="keyword">if</span> (session.isClient || ! session.firstRun) {
        next();
        <span class="keyword">return</span>;
      }
      require([<span class="string">"windowing"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(windowing)</span> {</span>
        windowing.show(<span class="string">"#towtruck-share"</span>);</pre></div></div>
              
            </li>
          
            <li id="section-292">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-292">&#182;</a>
                </div>
                <p>FIXME: no way to detect when the window is closed
If there was a next() step then it would not work</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      });
    }

  };

  <span class="keyword">return</span> startup;
});

<span class="comment">/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>

define(<span class="string">'ot'</span>,[<span class="string">"util"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(util)</span> {</span>

  <span class="keyword">var</span> ot = util.Module(<span class="string">"ot"</span>);
  <span class="keyword">var</span> assert = util.assert;

  <span class="keyword">var</span> StringSet = util.Class({
    <span class="comment">/* Set that only supports string items */</span>
    constructor: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">this</span>._items = {};
      <span class="keyword">this</span>._count = <span class="number">0</span>;
    },
    contains: <span class="function"><span class="keyword">function</span> <span class="params">(k)</span> {</span>
      assert(<span class="keyword">typeof</span> k == <span class="string">"string"</span>);
      <span class="keyword">return</span> <span class="keyword">this</span>._items.hasOwnProperty(k);
    },
    add: <span class="function"><span class="keyword">function</span> <span class="params">(k)</span> {</span>
      assert(<span class="keyword">typeof</span> k == <span class="string">"string"</span>);
      <span class="keyword">if</span> (<span class="keyword">this</span>.contains(k)) {
        <span class="keyword">return</span>;
      }
      <span class="keyword">this</span>._items[k] = <span class="literal">null</span>;
      <span class="keyword">this</span>._count++;
    },
    remove: <span class="function"><span class="keyword">function</span> <span class="params">(k)</span> {</span>
      assert(<span class="keyword">typeof</span> k == <span class="string">"string"</span>);
      <span class="keyword">if</span> (! <span class="keyword">this</span>.contains(k)) {
        <span class="keyword">return</span>;
      }
      <span class="keyword">delete</span> <span class="keyword">this</span>._items[k];
      <span class="keyword">this</span>._count++;
    },
    isEmpty: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">return</span> ! <span class="keyword">this</span>._count;
    }
  });

  <span class="keyword">var</span> Queue = util.Class({

    constructor: <span class="function"><span class="keyword">function</span> <span class="params">(size)</span> {</span>
      <span class="keyword">this</span>._q = [];
      <span class="keyword">this</span>._size = size;
      <span class="keyword">this</span>._deleted = <span class="number">0</span>;
    },

    _trim: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">if</span> (<span class="keyword">this</span>._size) {
        <span class="keyword">if</span> (<span class="keyword">this</span>._q.length &gt; <span class="keyword">this</span>._size) {
          <span class="keyword">this</span>._q.splice(<span class="number">0</span>, <span class="keyword">this</span>._q.length - <span class="keyword">this</span>._size);
          <span class="keyword">this</span>._deleted += <span class="keyword">this</span>._q.length - <span class="keyword">this</span>._size;
        }
      }
    },

    push: <span class="function"><span class="keyword">function</span> <span class="params">(item)</span> {</span>
      <span class="keyword">this</span>._q.push(item);
      <span class="keyword">this</span>._trim();
    },

    last: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">return</span> <span class="keyword">this</span>._q[<span class="keyword">this</span>._q.length-<span class="number">1</span>];
    },

    walkBack: <span class="function"><span class="keyword">function</span> <span class="params">(callback, context)</span> {</span>
      <span class="keyword">var</span> result = <span class="literal">true</span>;
      <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="keyword">this</span>._q.length-<span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) {
        <span class="keyword">var</span> item = <span class="keyword">this</span>._q[i];
        result = callback.call(context, item, i + <span class="keyword">this</span>._deleted);
        <span class="keyword">if</span> (result === <span class="literal">false</span>) {
          <span class="keyword">return</span> result;
        } <span class="keyword">else</span> <span class="keyword">if</span> (! result) {
          result = <span class="literal">true</span>;
        }
      }
      <span class="keyword">return</span> result;
    },

    walkForward: <span class="function"><span class="keyword">function</span> <span class="params">(index, callback, context)</span> {</span>
      <span class="keyword">var</span> result = <span class="literal">true</span>;
      <span class="keyword">for</span> (<span class="keyword">var</span> i=index; i&lt;<span class="keyword">this</span>._q.length; i++) {
        <span class="keyword">var</span> item = <span class="keyword">this</span>._q[i-<span class="keyword">this</span>._deleted];
        result = callback.call(context, item, i);
        <span class="keyword">if</span> (result === <span class="literal">false</span>) {
          <span class="keyword">return</span> result;
        } <span class="keyword">else</span> <span class="keyword">if</span> (! result) {
          result = <span class="literal">true</span>;
        }
      }
      <span class="keyword">return</span> result;
    },

    insert: <span class="function"><span class="keyword">function</span> <span class="params">(index, item)</span> {</span>
      <span class="keyword">this</span>._q.splice(index-<span class="keyword">this</span>._deleted, <span class="number">0</span>, item);
    }

  });

  <span class="keyword">var</span> Change = util.Class({

    constructor: <span class="function"><span class="keyword">function</span> <span class="params">(version, clientId, delta, known, outOfOrder)</span> {</span>
      <span class="keyword">this</span>.version = version;
      <span class="keyword">this</span>.clientId = clientId;
      <span class="keyword">this</span>.delta = delta;
      <span class="keyword">this</span>.known = known;
      <span class="keyword">this</span>.outOfOrder = !! outOfOrder;
      assert(<span class="keyword">typeof</span> version == <span class="string">"number"</span> &amp;&amp; <span class="keyword">typeof</span> clientId == <span class="string">"string"</span>,
             <span class="string">"Bad Change():"</span>, version, clientId);
    },

    toString: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">var</span> s = <span class="string">"[Change "</span> + <span class="keyword">this</span>.version + <span class="string">"."</span> + <span class="keyword">this</span>.clientId + <span class="string">": "</span>;
      s += <span class="keyword">this</span>.delta + <span class="string">" "</span>;
      <span class="keyword">if</span> (<span class="keyword">this</span>.outOfOrder) {
        s += <span class="string">"(out of order) "</span>;
      }
      <span class="keyword">var</span> cids = [];
      <span class="keyword">for</span> (<span class="keyword">var</span> a <span class="keyword">in</span> <span class="keyword">this</span>.known) {
        <span class="keyword">if</span> (<span class="keyword">this</span>.known.hasOwnProperty(a)) {
          cids.push(a);
        }
      }
      cids.sort();
      s += <span class="string">"{"</span>;
      <span class="keyword">if</span> (! cids.length) {
        s += <span class="string">"nothing known"</span>;
      } <span class="keyword">else</span> {
        cids.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(a, index)</span> {</span>
          <span class="keyword">if</span> (index) {
            s += <span class="string">";"</span>;
          }
          s += a + <span class="string">":"</span> + <span class="keyword">this</span>.known[a];
        }, <span class="keyword">this</span>);
      }
      <span class="keyword">return</span> s + <span class="string">"}]"</span>;
    },

    clone: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">return</span> Change(<span class="keyword">this</span>.version, <span class="keyword">this</span>.clientId, <span class="keyword">this</span>.delta.clone(), util.extend(<span class="keyword">this</span>.known), <span class="keyword">this</span>.outOfOrder);
    },

    isBefore: <span class="function"><span class="keyword">function</span> <span class="params">(otherChange)</span> {</span>
      assert(otherChange !== <span class="keyword">this</span>, <span class="string">"Tried to compare a change to itself"</span>, <span class="keyword">this</span>);
      <span class="keyword">return</span> otherChange.version &gt; <span class="keyword">this</span>.version ||
          (otherChange.version == <span class="keyword">this</span>.version &amp;&amp; otherChange.clientId &gt; <span class="keyword">this</span>.clientId);
    },

    knowsAboutAll: <span class="function"><span class="keyword">function</span> <span class="params">(versions)</span> {</span>
      <span class="keyword">for</span> (<span class="keyword">var</span> clientId <span class="keyword">in</span> versions) {
        <span class="keyword">if</span> (! versions.hasOwnProperty(clientId)) {
          <span class="keyword">continue</span>;
        }
        <span class="keyword">if</span> (! versions[clientId]) {
          <span class="keyword">continue</span>;
        }
        <span class="keyword">if</span> ((! <span class="keyword">this</span>.known[clientId]) || <span class="keyword">this</span>.known[clientId] &lt; versions[clientId]) {
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
      }
      <span class="keyword">return</span> <span class="literal">true</span>;
    },

    knowsAboutChange: <span class="function"><span class="keyword">function</span> <span class="params">(change)</span> {</span>
      <span class="keyword">return</span> change.clientId == <span class="keyword">this</span>.clientId ||
          (<span class="keyword">this</span>.known[change.clientId] &amp;&amp; <span class="keyword">this</span>.known[change.clientId] &gt;= change.version);
    },

    knowsAboutVersion: <span class="function"><span class="keyword">function</span> <span class="params">(version, clientId)</span> {</span>
      <span class="keyword">if</span> ((! version) || clientId == <span class="keyword">this</span>.clientId) {
        <span class="keyword">return</span> <span class="literal">true</span>;
      }
      <span class="keyword">return</span> <span class="keyword">this</span>.known[clientId] &amp;&amp; <span class="keyword">this</span>.known[clientId] &gt;= version;
    },

    maybeMissingChanges: <span class="function"><span class="keyword">function</span> <span class="params">(mostRecentVersion, clientId)</span> {</span>
      <span class="keyword">if</span> (! mostRecentVersion) {</pre></div></div>
              
            </li>
          
            <li id="section-293">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-293">&#182;</a>
                </div>
                <p>No actual changes for clientId exist</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> <span class="literal">false</span>;
      }
      <span class="keyword">if</span> (! <span class="keyword">this</span>.known[clientId]) {</pre></div></div>
              
            </li>
          
            <li id="section-294">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-294">&#182;</a>
                </div>
                <p>We don&#39;t even know about clientId, so we are definitely missing something</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> <span class="literal">true</span>;
      }
      <span class="keyword">if</span> (<span class="keyword">this</span>.known[clientId] &gt;= mostRecentVersion) {</pre></div></div>
              
            </li>
          
            <li id="section-295">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-295">&#182;</a>
                </div>
                <p>We know about all versions through mostRecentVersion</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> <span class="literal">false</span>;
      }
      <span class="keyword">if</span> ((clientId &gt; <span class="keyword">this</span>.clientId &amp;&amp; <span class="keyword">this</span>.known[clientId] &gt;= <span class="keyword">this</span>.version-<span class="number">1</span>) ||
          (clientId &lt; <span class="keyword">this</span>.clientId &amp;&amp; <span class="keyword">this</span>.known[clientId] == <span class="keyword">this</span>.version)) {</pre></div></div>
              
            </li>
          
            <li id="section-296">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-296">&#182;</a>
                </div>
                <p>We know about all versions from clientId that could exist before this
version</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> <span class="literal">false</span>;
      }</pre></div></div>
              
            </li>
          
            <li id="section-297">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-297">&#182;</a>
                </div>
                <p>We may or may not be missing something</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">return</span> <span class="literal">true</span>;
    }
  });

  <span class="comment">/* SimpleHistory synchronizes peers by relying on the server to serialize
   * the order of all updates.  Each client maintains a queue of patches
   * which have not yet been 'committed' (by being echoed back from the
   * server).  The client is responsible for transposing its own queue
   * if 'earlier' patches are heard from the server.
   *
   * Let's say that A's edit "1" and B's edit "2" occur and get put in
   * their respective SimpleHistory queues.  The server happens to
   * handle 1 first, then 2, so those are the order that all peers
   * (both A and B) see the messages.
   *
   * A sees 1, and has 1 on its queue, so everything's fine. It
   * updates the 'committed' text to match its current text and drops
   * the patch from its queue. It then sees 2, but the basis number
   * for 2 no longer matches the committed basis, so it throws it
   * away.
   *
   * B sees 1, and has 2 on its queue. It does the OT transpose thing,
   * updating the committed text to include 1 and the 'current' text
   * to include 1+2. It updates its queue with the newly transposed
   * version of 2 (call it 2prime) and updates 2prime's basis
   * number. It them resends 2prime to the server. It then receives 2
   * (the original) but the basis number no longer matches the
   * committed basis, so it throws it away.
   *
   * Now the server sees 2prime and rebroadcasts it to both A and B.
   *
   * A is seeing it for the first time, and the basis number matches,
   * so it applies it to the current and committed text.
   *
   * B sees that 2prime matches what's on the start of its queue,
   * shifts it off, and updates the committed text to match the
   * current text.
   *
   * Note that no one tries to keep an entire history of changes,
   * which is the main difference with ot.History.  Everyone applies
   * the same patches in the same order.
   */</span>
  ot.SimpleHistory = util.Class({

    constructor: <span class="keyword">function</span>(clientId, initState, initBasis) {
      <span class="keyword">this</span>.clientId = clientId;
      <span class="keyword">this</span>.committed = initState;
      <span class="keyword">this</span>.current = initState;
      <span class="keyword">this</span>.basis = initBasis;
      <span class="keyword">this</span>.queue = [];
      <span class="keyword">this</span>.deltaId = <span class="number">1</span>;
      <span class="keyword">this</span>.selection = <span class="literal">null</span>;
    },</pre></div></div>
              
            </li>
          
            <li id="section-298">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-298">&#182;</a>
                </div>
                <p>Use a fake change to represent the selection.
(This is the only bit that hard codes ot.TextReplace as the delta
representation; override this in a subclass (or don&#39;t set the
selection) if you are using a different delta representation.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    setSelection: <span class="keyword">function</span>(selection) {
      <span class="keyword">if</span> (selection) {
        <span class="keyword">this</span>.selection = ot.TextReplace(selection[<span class="number">0</span>],
                                        selection[<span class="number">1</span>] - selection[<span class="number">0</span>], <span class="string">'@'</span>);
      } <span class="keyword">else</span> {
        <span class="keyword">this</span>.selection = <span class="literal">null</span>;
      }
    },</pre></div></div>
              
            </li>
          
            <li id="section-299">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-299">&#182;</a>
                </div>
                <p>Decode the fake change to reconstruct the updated selection.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    getSelection: <span class="keyword">function</span>() {
      <span class="keyword">if</span> (! <span class="keyword">this</span>.selection) {
        <span class="keyword">return</span> <span class="literal">null</span>;
      }
      <span class="keyword">return</span> [<span class="keyword">this</span>.selection.start, <span class="keyword">this</span>.selection.start + <span class="keyword">this</span>.selection.del];
    },</pre></div></div>
              
            </li>
          
            <li id="section-300">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-300">&#182;</a>
                </div>
                <p>Add this delta to this client&#39;s queue.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    add: <span class="keyword">function</span>(delta) {
      <span class="keyword">var</span> change = {
        id: <span class="keyword">this</span>.clientId + <span class="string">'.'</span> + (<span class="keyword">this</span>.deltaId++),
        delta: delta
      };
      <span class="keyword">if</span> (! <span class="keyword">this</span>.queue.length) {
        change.basis = <span class="keyword">this</span>.basis;
      }
      <span class="keyword">this</span>.queue.push(change);
      <span class="keyword">this</span>.current = delta.apply(<span class="keyword">this</span>.current);
      <span class="keyword">return</span> !!change.basis;
    },</pre></div></div>
              
            </li>
          
            <li id="section-301">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-301">&#182;</a>
                </div>
                <p>Apply a delta received from the server.
Return true iff the current text changed as a result.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    commit: <span class="keyword">function</span>(change) {</pre></div></div>
              
            </li>
          
            <li id="section-302">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-302">&#182;</a>
                </div>
                <p>ignore it if the basis doesn&#39;t match (this patch doesn&#39;t apply)
if so, this delta is out of order; we expect the original client
to retransmit an updated delta.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (change.basis !== <span class="keyword">this</span>.basis) {
        <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 'current' text did not change</span>
      }</pre></div></div>
              
            </li>
          
            <li id="section-303">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-303">&#182;</a>
                </div>
                <p>is this the first thing on the queue?</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (<span class="keyword">this</span>.queue.length &amp;&amp; <span class="keyword">this</span>.queue[<span class="number">0</span>].id === change.id) {
        assert(change.basis === <span class="keyword">this</span>.queue[<span class="number">0</span>].basis);</pre></div></div>
              
            </li>
          
            <li id="section-304">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-304">&#182;</a>
                </div>
                <p>good, apply this to commit state &amp; remove it from queue</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.committed = <span class="keyword">this</span>.queue.shift().delta.apply(<span class="keyword">this</span>.committed);
        <span class="keyword">this</span>.basis++;
        <span class="keyword">if</span> (<span class="keyword">this</span>.queue.length) {
          <span class="keyword">this</span>.queue[<span class="number">0</span>].basis = <span class="keyword">this</span>.basis;
        }
        <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 'current' text did not change</span>
      }</pre></div></div>
              
            </li>
          
            <li id="section-305">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-305">&#182;</a>
                </div>
                <p>Transpose all bits on the queue to put this patch first.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> inserted = change.delta;
      <span class="keyword">this</span>.queue = <span class="keyword">this</span>.queue.map(<span class="keyword">function</span>(qchange) {
        <span class="keyword">var</span> tt = qchange.delta.transpose(inserted);
        inserted = tt[<span class="number">1</span>];
        <span class="keyword">return</span> {
          id: qchange.id,
          delta: tt[<span class="number">0</span>]
        };
      });
      <span class="keyword">if</span> (<span class="keyword">this</span>.selection) {</pre></div></div>
              
            </li>
          
            <li id="section-306">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-306">&#182;</a>
                </div>
                <p>update the selection!</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.selection = <span class="keyword">this</span>.selection.transpose(inserted)[<span class="number">0</span>];
      }
      <span class="keyword">this</span>.committed = change.delta.apply(<span class="keyword">this</span>.committed);
      <span class="keyword">this</span>.basis++;
      <span class="keyword">if</span> (<span class="keyword">this</span>.queue.length) {
        <span class="keyword">this</span>.queue[<span class="number">0</span>].basis = <span class="keyword">this</span>.basis;
      }</pre></div></div>
              
            </li>
          
            <li id="section-307">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-307">&#182;</a>
                </div>
                <p>Update current by replaying queued changes starting from &#39;committed&#39;</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">this</span>.current = <span class="keyword">this</span>.committed;
      <span class="keyword">this</span>.queue.forEach(<span class="keyword">function</span>(qchange) {
        <span class="keyword">this</span>.current = qchange.delta.apply(<span class="keyword">this</span>.current);
      }.bind(<span class="keyword">this</span>));
      <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// The 'current' text changed.</span>
    },</pre></div></div>
              
            </li>
          
            <li id="section-308">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-308">&#182;</a>
                </div>
                <p>Return the next change to transmit to the server, or null if there
isn&#39;t one.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    getNextToSend: <span class="keyword">function</span>() {
      <span class="keyword">var</span> qchange = <span class="keyword">this</span>.queue[<span class="number">0</span>];
      <span class="keyword">if</span> (! qchange) {
        <span class="comment">/* nothing to send */</span>
        <span class="keyword">return</span> <span class="literal">null</span>;
      }
      <span class="keyword">if</span> (qchange.sent) {
        <span class="comment">/* already sent */</span>
        <span class="keyword">return</span> <span class="literal">null</span>;
      }
      assert(qchange.basis);
      qchange.sent = <span class="literal">true</span>;
      <span class="keyword">return</span> qchange;
    }
  });

  ot.History = util.Class({

    constructor: <span class="function"><span class="keyword">function</span> <span class="params">(clientId, initState)</span> {</span>
      <span class="keyword">this</span>._history = Queue();
      <span class="keyword">this</span>._history.push({
        clientId: <span class="string">"init"</span>, state: initState
      });
      <span class="keyword">this</span>.clientId = clientId;
      <span class="keyword">this</span>.known = {};
      <span class="keyword">this</span>.mostRecentLocalChange = <span class="literal">null</span>;
    },

    add: <span class="function"><span class="keyword">function</span> <span class="params">(change)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-309">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-309">&#182;</a>
                </div>
                <p>Simplest cast, it is our change:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (change.clientId == <span class="keyword">this</span>.clientId) {
        <span class="keyword">this</span>._history.push(change);
        <span class="keyword">this</span>.mostRecentLocalChange = change.version;
        <span class="keyword">return</span> change.delta;
      }
      assert((! <span class="keyword">this</span>.known[change.clientId]) || <span class="keyword">this</span>.known[change.clientId] &lt; change.version,
            <span class="string">"Got a change"</span>, change, <span class="string">"that appears older (or same as) a known change"</span>, <span class="keyword">this</span>.known[change.clientId]);</pre></div></div>
              
            </li>
          
            <li id="section-310">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-310">&#182;</a>
                </div>
                <p>Second simplest case, we get a change that we can add to our
history without modification:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> last = <span class="keyword">this</span>._history.last();
      <span class="keyword">if</span> ((last.clientId == <span class="string">"init"</span> || last.isBefore(change)) &amp;&amp;
          change.knowsAboutAll(<span class="keyword">this</span>.known) &amp;&amp;
          change.knowsAboutVersion(<span class="keyword">this</span>.mostRecentLocalChange, <span class="keyword">this</span>.clientId)) {
        <span class="keyword">this</span>._history.push(change);
        <span class="keyword">this</span>.known[change.clientId] = change.version;
        <span class="keyword">return</span> change.delta;
      }</pre></div></div>
              
            </li>
          
            <li id="section-311">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-311">&#182;</a>
                </div>
                <p>We must do work!</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">this</span>.logHistory(<span class="string">"//"</span>);</pre></div></div>
              
            </li>
          
            <li id="section-312">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-312">&#182;</a>
                </div>
                <p>First we check if we need to modify this change because we
know about changes that it should know about (changes that
preceed it that are in our local history).</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> clientsToCheck = StringSet();
      <span class="keyword">for</span> (<span class="keyword">var</span> clientId <span class="keyword">in</span> <span class="keyword">this</span>.known) {
        <span class="keyword">if</span> (! <span class="keyword">this</span>.known.hasOwnProperty(clientId)) {
          <span class="keyword">continue</span>;
        }
        <span class="keyword">if</span> (change.maybeMissingChanges(<span class="keyword">this</span>.known[clientId], clientId)) {
          clientsToCheck.add(clientId);
        }
      }
      <span class="keyword">if</span> (change.maybeMissingChanges(<span class="keyword">this</span>.mostRecentLocalChange, <span class="keyword">this</span>.clientId)) {
        clientsToCheck.add(<span class="keyword">this</span>.clientId);
      }
      <span class="keyword">if</span> (! clientsToCheck.isEmpty()) {
        <span class="keyword">var</span> indexToCheckFrom = <span class="literal">null</span>;
        <span class="keyword">this</span>._history.walkBack(<span class="function"><span class="keyword">function</span> <span class="params">(c, index)</span> {</span>
          indexToCheckFrom = index;
          <span class="keyword">if</span> (c.clientId == <span class="string">"init"</span>) {
            <span class="keyword">return</span> <span class="literal">false</span>;
          }
          <span class="keyword">if</span> (clientsToCheck.contains(c.clientId) &amp;&amp;
              ! change.maybeMissingChanges(c.version, c.clientId)) {
            clientsToCheck.remove(c.clientId);
            <span class="keyword">if</span> (clientsToCheck.isEmpty()) {
              <span class="keyword">return</span> <span class="literal">false</span>;
            }
          }
          <span class="keyword">return</span> <span class="literal">true</span>;
        }, <span class="keyword">this</span>);
        <span class="keyword">this</span>._history.walkForward(indexToCheckFrom, <span class="function"><span class="keyword">function</span> <span class="params">(c, index)</span> {</span>
          <span class="keyword">if</span> (c.clientId == <span class="string">"init"</span>) {
            <span class="keyword">return</span> <span class="literal">true</span>;
          }
          <span class="keyword">if</span> (change.isBefore(c)) {
            <span class="keyword">return</span> <span class="literal">false</span>;
          }
          <span class="keyword">if</span> (! change.knowsAboutChange(c)) {
            <span class="keyword">var</span> presentDelta = <span class="keyword">this</span>.promoteDelta(c.delta, index, change);
            <span class="keyword">if</span> (! presentDelta.equals(c.delta)) {</pre></div></div>
              
            </li>
          
            <li id="section-313">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-313">&#182;</a>
                </div>
                <p>console.log(&quot;-&gt;rebase delta rewrite&quot;, presentDelta+&quot;&quot;);</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>            }
            <span class="keyword">this</span>.logChange(<span class="string">"-&gt;rebase"</span>, change, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
              <span class="keyword">var</span> result = change.delta.transpose(presentDelta);
              change.delta = result[<span class="number">0</span>];
              change.known[c.clientId] = c.version;
            }, <span class="string">"with:"</span>, c);
          }
          <span class="keyword">return</span> <span class="literal">true</span>;
        }, <span class="keyword">this</span>);
      }</pre></div></div>
              
            </li>
          
            <li id="section-314">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-314">&#182;</a>
                </div>
                <p>Next we insert the change into its proper location</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> indexToInsert = <span class="literal">null</span>;
      <span class="keyword">this</span>._history.walkBack(<span class="function"><span class="keyword">function</span> <span class="params">(c, index)</span> {</span>
        <span class="keyword">if</span> (c.clientId == <span class="string">"init"</span> || c.isBefore(change)) {
          indexToInsert = index+<span class="number">1</span>;
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
        <span class="keyword">return</span> <span class="literal">true</span>;
      }, <span class="keyword">this</span>);
      assert(indexToInsert);
      <span class="keyword">this</span>._history.insert(indexToInsert, change);</pre></div></div>
              
            </li>
          
            <li id="section-315">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-315">&#182;</a>
                </div>
                <p>Now we fix up any forward changes</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> fixupDelta = change.delta;
      <span class="keyword">this</span>._history.walkForward(indexToInsert+<span class="number">1</span>, <span class="function"><span class="keyword">function</span> <span class="params">(c, index)</span> {</span>
        <span class="keyword">if</span> (! c.knowsAboutChange(change)) {
          <span class="keyword">var</span> origChange = c.clone();
          <span class="keyword">this</span>.logChange(<span class="string">"^^fix"</span>, c, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            <span class="keyword">var</span> fixupResult = c.delta.transpose(fixupDelta);
            console.log(<span class="string">"  ^^real"</span>);
            <span class="keyword">var</span> result = c.delta.transpose(fixupDelta);
            c.delta = result[<span class="number">0</span>];
            c.known[change.clientId] = change.version;
            fixupDelta = fixupResult[<span class="number">1</span>];
          }, <span class="string">"clone:"</span>, change.delta+<span class="string">""</span>);
          console.log(<span class="string">"(trans)"</span>, fixupDelta+<span class="string">""</span>);
          assert(c.knowsAboutChange(change));
        }
      }, <span class="keyword">this</span>);</pre></div></div>
              
            </li>
          
            <li id="section-316">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-316">&#182;</a>
                </div>
                <p>Finally we return the transformed delta that represents
changes that should be made to the state:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">this</span>.logHistory(<span class="string">"!!"</span>);
      <span class="keyword">return</span> fixupDelta;
    },

    promoteDelta: <span class="function"><span class="keyword">function</span> <span class="params">(delta, deltaIndex, untilChange)</span> {</span>
      <span class="keyword">this</span>._history.walkForward(deltaIndex+<span class="number">1</span>, <span class="function"><span class="keyword">function</span> <span class="params">(c, index)</span> {</span>
        <span class="keyword">if</span> (untilChange.isBefore(c)) {
          <span class="keyword">return</span> <span class="literal">false</span>;
        }</pre></div></div>
              
            </li>
          
            <li id="section-317">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-317">&#182;</a>
                </div>
                <p>FIXME: not sure if this clientId check here is right.  Maybe
if untilChange.knowsAbout(c)?</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (untilChange.knowsAboutChange(c)) {
          <span class="keyword">var</span> result = c.delta.transpose(delta);
          delta = result[<span class="number">1</span>];
        }
        <span class="keyword">return</span> <span class="literal">true</span>;
      });
      <span class="keyword">return</span> delta;
    },

    logHistory: <span class="function"><span class="keyword">function</span> <span class="params">(prefix)</span> {</span>
      prefix = prefix || <span class="string">""</span>;
      <span class="keyword">var</span> postfix = Array.prototype.slice.call(arguments, <span class="number">1</span>);
      console.log.apply(console, [prefix + <span class="string">"history"</span>, <span class="keyword">this</span>.clientId, <span class="string">":"</span>].concat(postfix));
      console.log(prefix + <span class="string">" state:"</span>, JSON.stringify(<span class="keyword">this</span>.getStateSafe()));
      <span class="keyword">var</span> hstate;
      <span class="keyword">this</span>._history.walkForward(<span class="number">0</span>, <span class="function"><span class="keyword">function</span> <span class="params">(c, index)</span> {</span>
        <span class="keyword">if</span> (! index) {
          assert(c.clientId == <span class="string">"init"</span>);
          console.log(prefix + <span class="string">" init:"</span>, JSON.stringify(c.state));
          hstate = c.state;
        } <span class="keyword">else</span> {
          <span class="keyword">try</span> {
            hstate = c.delta.apply(hstate);
          } <span class="keyword">catch</span> (e) {
            hstate = <span class="string">"Error: "</span> + e;
          }
          console.log(prefix + <span class="string">"  "</span>, index, c+<span class="string">""</span>, JSON.stringify(hstate));
        }
      });
    },

    logChange: <span class="function"><span class="keyword">function</span> <span class="params">(prefix, change, callback)</span> {</span>
      prefix = prefix || <span class="string">"before"</span>;
      <span class="keyword">var</span> postfix = Array.prototype.slice.call(arguments, <span class="number">3</span>);
      console.log.apply(
        console,
        [prefix, <span class="keyword">this</span>.clientId, <span class="string">":"</span>, change+<span class="string">""</span>].concat(postfix).concat([JSON.stringify(<span class="keyword">this</span>.getStateSafe(<span class="literal">true</span>))]));
      <span class="keyword">try</span> {
        callback();
      } <span class="keyword">finally</span> {
        console.log(prefix + <span class="string">" after:"</span>, change+<span class="string">""</span>, JSON.stringify(<span class="keyword">this</span>.getStateSafe()));
      }
    },

    addDelta: <span class="function"><span class="keyword">function</span> <span class="params">(delta)</span> {</span>
      <span class="keyword">var</span> version = <span class="keyword">this</span>._createVersion();
      <span class="keyword">var</span> change = Change(version, <span class="keyword">this</span>.clientId, delta, util.extend(<span class="keyword">this</span>.knownVersions));
      <span class="keyword">this</span>.add(change);
      <span class="keyword">return</span> change;
    },

    _createVersion: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">var</span> max = <span class="number">1</span>;
      <span class="keyword">for</span> (<span class="keyword">var</span> id <span class="keyword">in</span> <span class="keyword">this</span>.knownVersions) {
        max = Math.max(max, <span class="keyword">this</span>.knownVersions[id]);
      }
      max = Math.max(max, <span class="keyword">this</span>.mostRecentLocalChange);
      <span class="keyword">return</span> max+<span class="number">1</span>;
    },

    fault: <span class="function"><span class="keyword">function</span> <span class="params">(change)</span> {</span>
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Fault'</span>);
    },

    getState: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">var</span> state;
      <span class="keyword">this</span>._history.walkForward(<span class="number">0</span>, <span class="function"><span class="keyword">function</span> <span class="params">(c)</span> {</span>
        <span class="keyword">if</span> (c.clientId == <span class="string">"init"</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-318">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-318">&#182;</a>
                </div>
                <p>Initialization, has the state</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>          state = c.state;
        } <span class="keyword">else</span> {
          state = c.delta.apply(state);
        }
      }, <span class="keyword">this</span>);
      <span class="keyword">return</span> state;
    },

    getStateSafe: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">try</span> {
        <span class="keyword">return</span> <span class="keyword">this</span>.getState();
      } <span class="keyword">catch</span> (e) {
        <span class="keyword">return</span> <span class="string">'Error: '</span> + e;
      }
    }

  });

  ot.TextReplace = util.Class({

    constructor: <span class="function"><span class="keyword">function</span> <span class="params">(start, del, text)</span> {</span>
      assert(<span class="keyword">typeof</span> start == <span class="string">"number"</span> &amp;&amp; <span class="keyword">typeof</span> del == <span class="string">"number"</span> &amp;&amp; <span class="keyword">typeof</span> text == <span class="string">"string"</span>, start, del, text);
      assert(start &gt;=<span class="number">0</span> &amp;&amp; del &gt;= <span class="number">0</span>, start, del);
      <span class="keyword">this</span>.start = start;
      <span class="keyword">this</span>.del = del;
      <span class="keyword">this</span>.text = text;
    },

    toString: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">if</span> (<span class="keyword">this</span>.empty()) {
        <span class="keyword">return</span> <span class="string">'[no-op]'</span>;
      }
      <span class="keyword">if</span> (! <span class="keyword">this</span>.del) {
        <span class="keyword">return</span> <span class="string">'[insert '</span> + JSON.stringify(<span class="keyword">this</span>.text) + <span class="string">' @'</span> + <span class="keyword">this</span>.start + <span class="string">']'</span>;
      } <span class="keyword">else</span> <span class="keyword">if</span> (! <span class="keyword">this</span>.text) {
        <span class="keyword">return</span> <span class="string">'[delete '</span> + <span class="keyword">this</span>.del + <span class="string">' chars @'</span> + <span class="keyword">this</span>.start + <span class="string">']'</span>;
      } <span class="keyword">else</span> {
        <span class="keyword">return</span> <span class="string">'[replace '</span> + <span class="keyword">this</span>.del + <span class="string">' chars with '</span> + JSON.stringify(<span class="keyword">this</span>.text) + <span class="string">' @'</span> + <span class="keyword">this</span>.start + <span class="string">']'</span>;
      }
    },

    equals: <span class="function"><span class="keyword">function</span> <span class="params">(other)</span> {</span>
      <span class="keyword">return</span> other.constructor === <span class="keyword">this</span>.constructor &amp;&amp;
          other.del === <span class="keyword">this</span>.del &amp;&amp;
          other.start === <span class="keyword">this</span>.start &amp;&amp;
          other.text === <span class="keyword">this</span>.text;
    },

    clone: <span class="function"><span class="keyword">function</span> <span class="params">(start, del, text)</span> {</span>
      <span class="keyword">if</span> (start === <span class="literal">undefined</span>) {
        start = <span class="keyword">this</span>.start;
      }
      <span class="keyword">if</span> (del === <span class="literal">undefined</span>) {
        del = <span class="keyword">this</span>.del;
      }
      <span class="keyword">if</span> (text === <span class="literal">undefined</span>) {
        text = <span class="keyword">this</span>.text;
      }
      <span class="keyword">return</span> ot.TextReplace(start, del, text);
    },

    empty: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">return</span> (! <span class="keyword">this</span>.del) &amp;&amp; (! <span class="keyword">this</span>.text);
    },

    apply: <span class="function"><span class="keyword">function</span> <span class="params">(text)</span> {</span>
      <span class="keyword">if</span> (<span class="keyword">this</span>.empty()) {
        <span class="keyword">return</span> text;
      }
      <span class="keyword">if</span> (<span class="keyword">this</span>.start &gt; text.length) {
        console.trace();
        <span class="keyword">throw</span> <span class="keyword">new</span> util.AssertionError(<span class="string">"Start after end of text ("</span> + JSON.stringify(text) + <span class="string">"/"</span> + text.length + <span class="string">"): "</span> + <span class="keyword">this</span>);
      }
      <span class="keyword">if</span> (<span class="keyword">this</span>.start + <span class="keyword">this</span>.del &gt; text.length) {
        <span class="keyword">throw</span> <span class="keyword">new</span> util.AssertionError(<span class="string">"Start+del after end of text ("</span> + JSON.stringify(text) + <span class="string">"/"</span> + text.length + <span class="string">"): "</span> + <span class="keyword">this</span>);
      }
      <span class="keyword">return</span> text.substr(<span class="number">0</span>, <span class="keyword">this</span>.start) + <span class="keyword">this</span>.text + text.substr(<span class="keyword">this</span>.start+<span class="keyword">this</span>.del);
    },

    transpose: <span class="function"><span class="keyword">function</span> <span class="params">(delta)</span> {</span>
      <span class="comment">/* Transform this delta as though the other delta had come before it.
         Returns a [new_version_of_this, transformed_delta], where transformed_delta
         satisfies:

         result1 = new_version_of_this.apply(delta.apply(text));
         result2 = transformed_delta.apply(this.apply(text));
         assert(result1 == result2);

         Does not modify this object.
      */</span>
      <span class="keyword">var</span> overlap;
      assert(delta <span class="keyword">instanceof</span> ot.TextReplace, <span class="string">"Transposing with non-TextReplace:"</span>, delta);
      <span class="keyword">if</span> (<span class="keyword">this</span>.empty()) {</pre></div></div>
              
            </li>
          
            <li id="section-319">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-319">&#182;</a>
                </div>
                <p>console.log(&quot;  =this is empty&quot;);</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> [<span class="keyword">this</span>.clone(), delta.clone()];
      }
      <span class="keyword">if</span> (delta.empty()) {</pre></div></div>
              
            </li>
          
            <li id="section-320">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-320">&#182;</a>
                </div>
                <p>console.log(&quot;  =other is empty&quot;);</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> [<span class="keyword">this</span>.clone(), delta.clone()];
      }
      <span class="keyword">if</span> (delta.before(<span class="keyword">this</span>)) {</pre></div></div>
              
            </li>
          
            <li id="section-321">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-321">&#182;</a>
                </div>
                <p>console.log(&quot;  =this after other&quot;);</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> [<span class="keyword">this</span>.clone(<span class="keyword">this</span>.start + delta.text.length - delta.del),
                delta.clone()];
      } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.before(delta)) {</pre></div></div>
              
            </li>
          
            <li id="section-322">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-322">&#182;</a>
                </div>
                <p>console.log(&quot;  =this before other&quot;);</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> [<span class="keyword">this</span>.clone(), delta.clone(delta.start + <span class="keyword">this</span>.text.length - <span class="keyword">this</span>.del)];
      } <span class="keyword">else</span> <span class="keyword">if</span> (delta.sameRange(<span class="keyword">this</span>)) {</pre></div></div>
              
            </li>
          
            <li id="section-323">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-323">&#182;</a>
                </div>
                <p>console.log(&quot;  =same range&quot;);</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> [<span class="keyword">this</span>.clone(<span class="keyword">this</span>.start+delta.text.length, <span class="number">0</span>),
                delta.clone(<span class="literal">undefined</span>, <span class="number">0</span>)];
      } <span class="keyword">else</span> <span class="keyword">if</span> (delta.contains(<span class="keyword">this</span>)) {</pre></div></div>
              
            </li>
          
            <li id="section-324">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-324">&#182;</a>
                </div>
                <p>console.log(&quot;  =other contains this&quot;);</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> [<span class="keyword">this</span>.clone(delta.start+delta.text.length, <span class="number">0</span>, <span class="keyword">this</span>.text),
                delta.clone(<span class="literal">undefined</span>, delta.del - <span class="keyword">this</span>.del + <span class="keyword">this</span>.text.length, delta.text + <span class="keyword">this</span>.text)];
      } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.contains(delta)) {</pre></div></div>
              
            </li>
          
            <li id="section-325">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-325">&#182;</a>
                </div>
                <p>console.log(&quot;  =this contains other&quot;);</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> [<span class="keyword">this</span>.clone(<span class="literal">undefined</span>, <span class="keyword">this</span>.del - delta.del + delta.text.length, delta.text + <span class="keyword">this</span>.text),
                delta.clone(<span class="keyword">this</span>.start, <span class="number">0</span>, delta.text)];
      } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.overlapsStart(delta)) {</pre></div></div>
              
            </li>
          
            <li id="section-326">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-326">&#182;</a>
                </div>
                <p>console.log(&quot;  =this overlaps start of other&quot;);</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        overlap = <span class="keyword">this</span>.start + <span class="keyword">this</span>.del - delta.start;
        <span class="keyword">return</span> [<span class="keyword">this</span>.clone(<span class="literal">undefined</span>, <span class="keyword">this</span>.del - overlap),
                delta.clone(<span class="keyword">this</span>.start + <span class="keyword">this</span>.text.length, delta.del - overlap)];
      } <span class="keyword">else</span> {</pre></div></div>
              
            </li>
          
            <li id="section-327">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-327">&#182;</a>
                </div>
                <p>console.log(&quot;  =this overlaps end of other&quot;);</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        assert(delta.overlapsStart(<span class="keyword">this</span>), delta+<span class="string">""</span>, <span class="string">"does not overlap start of"</span>, <span class="keyword">this</span>+<span class="string">""</span>, delta.before(<span class="keyword">this</span>));
        overlap = delta.start + delta.del - <span class="keyword">this</span>.start;
        <span class="keyword">return</span> [<span class="keyword">this</span>.clone(delta.start + delta.text.length, <span class="keyword">this</span>.del - overlap),
                delta.clone(<span class="literal">undefined</span>, delta.del - overlap)];
      }
      <span class="keyword">throw</span> <span class="string">'Should not happen'</span>;
    },

    before: <span class="function"><span class="keyword">function</span> <span class="params">(other)</span> {</span>
      <span class="keyword">return</span> <span class="keyword">this</span>.start + <span class="keyword">this</span>.del &lt;= other.start;
    },

    contains: <span class="function"><span class="keyword">function</span> <span class="params">(other)</span> {</span>
      <span class="keyword">return</span> other.start &gt;= <span class="keyword">this</span>.start &amp;&amp; other.start + other.del &lt; <span class="keyword">this</span>.start + <span class="keyword">this</span>.del;
    },

    sameRange: <span class="function"><span class="keyword">function</span> <span class="params">(other)</span> {</span>
      <span class="keyword">return</span> other.start == <span class="keyword">this</span>.start &amp;&amp; other.del == <span class="keyword">this</span>.del;
    },

    overlapsStart: <span class="function"><span class="keyword">function</span> <span class="params">(other)</span> {</span>
      <span class="keyword">return</span> <span class="keyword">this</span>.start &lt; other.start &amp;&amp; <span class="keyword">this</span>.start + <span class="keyword">this</span>.del &gt; other.start;
    },

    classMethods: {

      <span class="comment">/* Make a new ot.TextReplace that converts oldValue to newValue. */</span>
      fromChange: <span class="keyword">function</span>(oldValue, newValue) {
        assert(<span class="keyword">typeof</span> oldValue == <span class="string">"string"</span>);
        assert(<span class="keyword">typeof</span> newValue == <span class="string">"string"</span>);
        <span class="keyword">var</span> commonStart = <span class="number">0</span>;
        <span class="keyword">while</span> (commonStart &lt; newValue.length &amp;&amp;
               newValue.charAt(commonStart) == oldValue.charAt(commonStart)) {
          commonStart++;
        }
        <span class="keyword">var</span> commonEnd = <span class="number">0</span>;
        <span class="keyword">while</span> (commonEnd &lt; (newValue.length - commonStart) &amp;&amp;
               commonEnd &lt; (oldValue.length - commonStart) &amp;&amp;
               newValue.charAt(newValue.length - commonEnd - <span class="number">1</span>) ==
               oldValue.charAt(oldValue.length - commonEnd - <span class="number">1</span>)) {
          commonEnd++;
        }
        <span class="keyword">var</span> removed = oldValue.substr(commonStart, oldValue.length - commonStart - commonEnd);
        <span class="keyword">var</span> inserted = newValue.substr(commonStart, newValue.length - commonStart - commonEnd);
        <span class="keyword">if</span> (! (removed.length || inserted)) {
          <span class="keyword">return</span> <span class="literal">null</span>;
        }
        <span class="keyword">return</span> <span class="keyword">this</span>(commonStart, removed.length, inserted);
      },

      random: <span class="function"><span class="keyword">function</span> <span class="params">(source, generator)</span> {</span>
        <span class="keyword">var</span> text, start, len;
        <span class="keyword">var</span> ops = [<span class="string">"ins"</span>, <span class="string">"del"</span>, <span class="string">"repl"</span>];
        <span class="keyword">if</span> (! source.length) {
          ops = [<span class="string">"ins"</span>];
        }
        <span class="keyword">switch</span> (generator.pick(ops)) {
        <span class="keyword">case</span> <span class="string">"ins"</span>:
          <span class="keyword">if</span> (! generator.number(<span class="number">2</span>)) {
            text = generator.string(<span class="number">1</span>);
          } <span class="keyword">else</span> {
            text = generator.string(generator.number(<span class="number">3</span>)+<span class="number">1</span>);
          }
          <span class="keyword">if</span> (! generator.number(<span class="number">4</span>)) {
            start = <span class="number">0</span>;
          } <span class="keyword">else</span> <span class="keyword">if</span> (! generator.number(<span class="number">3</span>)) {
            start = source.length-<span class="number">1</span>;
          } <span class="keyword">else</span> {
            start = generator.number(source.length);
          }
          <span class="keyword">return</span> <span class="keyword">this</span>(start, <span class="number">0</span>, text);

        <span class="keyword">case</span> <span class="string">"del"</span>:
          <span class="keyword">if</span> (! generator.number(<span class="number">20</span>)) {
            <span class="keyword">return</span> <span class="keyword">this</span>(<span class="number">0</span>, source.length, <span class="string">""</span>);
          }
          start = generator.number(source.length-<span class="number">1</span>);
          <span class="keyword">if</span> (! generator.number(<span class="number">2</span>)) {
            len = <span class="number">1</span>;
          } <span class="keyword">else</span> {
            len = generator.number(<span class="number">5</span>)+<span class="number">1</span>;
          }
          len = Math.min(len, source.length - start);
          <span class="keyword">return</span> <span class="keyword">this</span>(start, len, <span class="string">""</span>);

        <span class="keyword">case</span> <span class="string">"repl"</span>:
          start = generator.number(source.length-<span class="number">1</span>);
          len = generator.number(<span class="number">5</span>);
          len = Math.min(len, source.length - start);
          text = generator.string(generator.number(<span class="number">2</span>)+<span class="number">1</span>);
          <span class="keyword">return</span> <span class="keyword">this</span>(start, len, text);
        }
        <span class="keyword">throw</span> <span class="string">'Unreachable'</span>;
      }
    }
  });

  <span class="keyword">return</span> ot;
});

<span class="comment">/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>

define(<span class="string">'forms'</span>,[<span class="string">"jquery"</span>, <span class="string">"util"</span>, <span class="string">"session"</span>, <span class="string">"elementFinder"</span>, <span class="string">"eventMaker"</span>, <span class="string">"templating"</span>, <span class="string">"ot"</span>], <span class="function"><span class="keyword">function</span> <span class="params">($, util, session, elementFinder, eventMaker, templating, ot)</span> {</span>
  <span class="keyword">var</span> forms = util.Module(<span class="string">"forms"</span>);
  <span class="keyword">var</span> assert = util.assert;</pre></div></div>
              
            </li>
          
            <li id="section-328">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-328">&#182;</a>
                </div>
                <p>This is how much larger the focus element is than the element it surrounds
(this is padding on each side)</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> FOCUS_BUFFER = <span class="number">5</span>;

  <span class="keyword">var</span> inRemoteUpdate = <span class="literal">false</span>;

  <span class="function"><span class="keyword">function</span> <span class="title">maybeChange</span><span class="params">(event)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-329">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-329">&#182;</a>
                </div>
                <p>Called when we get an event that may or may not indicate a real change
(like keyup in a textarea)</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> tag = event.target.tagName;
    <span class="keyword">if</span> (tag == <span class="string">"TEXTAREA"</span> || tag == <span class="string">"INPUT"</span>) {
      change(event);
    }
  }

  <span class="function"><span class="keyword">function</span> <span class="title">change</span><span class="params">(event)</span> {</span>
    <span class="keyword">if</span> (inRemoteUpdate) {
      <span class="keyword">return</span>;
    }
    <span class="keyword">if</span> (elementFinder.ignoreElement(event.target) || elementTracked(event.target)) {
      <span class="keyword">return</span>;
    }
    <span class="keyword">var</span> el = $(event.target);
    <span class="keyword">var</span> location = elementFinder.elementLocation(el);
    <span class="keyword">var</span> value = getValue(el);
    <span class="keyword">var</span> msg = {
      type: <span class="string">"form-update"</span>,
      element: location
    };
    <span class="keyword">if</span> (isText(el)) {
      <span class="keyword">var</span> history = el.data(<span class="string">"towtruckHistory"</span>);
      <span class="keyword">if</span> (history.current == value) {
        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span> (history) {
        <span class="keyword">var</span> delta = ot.TextReplace.fromChange(history.current, value);
        assert(delta);
        history.add(delta);
        maybeSendUpdate(msg.element, history);
        <span class="keyword">return</span>;
      } <span class="keyword">else</span> {
        msg.value = value;
        msg.basis = <span class="number">1</span>;
        el.data(<span class="string">"towtruckHistory"</span>, ot.SimpleHistory(session.clientId, value, <span class="number">1</span>));
      }
    } <span class="keyword">else</span> {
      msg.value = value;
    }
    session.send(msg);
  }

  <span class="function"><span class="keyword">function</span> <span class="title">isCheckable</span><span class="params">(el)</span> {</span>
    el = $(el);
    <span class="keyword">var</span> type = (el.prop(<span class="string">"type"</span>) || <span class="string">"text"</span>).toLowerCase();
    <span class="keyword">if</span> (el.prop(<span class="string">"tagName"</span>) == <span class="string">"INPUT"</span> &amp;&amp; [<span class="string">"radio"</span>, <span class="string">"checkbox"</span>].indexOf(type) != -<span class="number">1</span>) {
      <span class="keyword">return</span> <span class="literal">true</span>;
    }
    <span class="keyword">return</span> <span class="literal">false</span>;
  }

  <span class="keyword">var</span> editTrackers = {};
  <span class="keyword">var</span> liveTrackers = [];

  TowTruck.addTracker = <span class="function"><span class="keyword">function</span> <span class="params">(TrackerClass, skipSetInit)</span> {</span>
    assert(<span class="keyword">typeof</span> TrackerClass === <span class="string">"function"</span>, <span class="string">"You must pass in a class"</span>);
    assert(<span class="keyword">typeof</span> TrackerClass.prototype.trackerName === <span class="string">"string"</span>,
           <span class="string">"Needs a .prototype.trackerName string"</span>);</pre></div></div>
              
            </li>
          
            <li id="section-330">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-330">&#182;</a>
                </div>
                <p>Test for required instance methods.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="string">"destroy update init makeInit tracked"</span>.split(<span class="regexp">/ /</span>).forEach(<span class="keyword">function</span>(m) {
      assert(<span class="keyword">typeof</span> TrackerClass.prototype[m] === <span class="string">"function"</span>,
             <span class="string">"Missing required tracker method: "</span>+m);
    });</pre></div></div>
              
            </li>
          
            <li id="section-331">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-331">&#182;</a>
                </div>
                <p>Test for required class methods.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="string">"scan tracked"</span>.split(<span class="regexp">/ /</span>).forEach(<span class="keyword">function</span>(m) {
      assert(<span class="keyword">typeof</span> TrackerClass[m] === <span class="string">"function"</span>,
             <span class="string">"Missing required tracker class method: "</span>+m);
    });
    editTrackers[TrackerClass.prototype.trackerName] = TrackerClass;
    <span class="keyword">if</span> (!skipSetInit) {
      setInit();
    }
  };

  <span class="keyword">var</span> AceEditor = util.Class({

    trackerName: <span class="string">"AceEditor"</span>,

    constructor: <span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
      <span class="keyword">this</span>.element = $(el);
      assert(<span class="keyword">this</span>.element.hasClass(<span class="string">"ace_editor"</span>));
      <span class="keyword">this</span>._change = <span class="keyword">this</span>._change.bind(<span class="keyword">this</span>);
      <span class="keyword">this</span>._editor().document.on(<span class="string">"change"</span>, <span class="keyword">this</span>._change);
    },

    tracked: <span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
      <span class="keyword">return</span> <span class="keyword">this</span>.element[<span class="number">0</span>] === el;
    },

    destroy: <span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
      <span class="keyword">this</span>._editor().document.removeListener(<span class="string">"change"</span>, <span class="keyword">this</span>._change);
    },

    update: <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
      <span class="keyword">this</span>._editor().document.getDocument().applyDeltas([msg.delta]);
    },

    init: <span class="function"><span class="keyword">function</span> <span class="params">(update, msg)</span> {</span>
      <span class="keyword">this</span>._editor().document.setValue(update.value);
    },

    makeInit: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">return</span> {
        element: elementFinder.elementLocation(<span class="keyword">this</span>.element),
        tracker: <span class="keyword">this</span>.trackerName,
        value: <span class="keyword">this</span>._editor().document.getValue()
      };
    },

    _editor: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">return</span> <span class="keyword">this</span>.element[<span class="number">0</span>].env;
    },

    _change: <span class="function"><span class="keyword">function</span> <span class="params">(e)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-332">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-332">&#182;</a>
                </div>
                <p>FIXME: I should have an internal .send() function that automatically
asserts !inRemoteUpdate, among other things</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (inRemoteUpdate) {
        <span class="keyword">return</span>;
      }</pre></div></div>
              
            </li>
          
            <li id="section-333">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-333">&#182;</a>
                </div>
                <p>FIXME: I want to use a more normalized version of replace instead of
ACE&#39;s native delta</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      session.send({
        type: <span class="string">"form-update"</span>,
        tracker: <span class="keyword">this</span>.trackerName,
        element: elementFinder.elementLocation(<span class="keyword">this</span>.element),
        delta: JSON.parse(JSON.stringify(e.data))
      });
    }
  });

  AceEditor.scan = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">return</span> $(<span class="string">".ace_editor"</span>);
  };

  AceEditor.tracked = <span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
    <span class="keyword">return</span> !! $(el).closest(<span class="string">".ace_editor"</span>).length;
  };

  TowTruck.addTracker(AceEditor, <span class="literal">true</span> <span class="comment">/* skip setInit */</span>);

  <span class="keyword">var</span> CodeMirrorEditor = util.Class({
    trackerName: <span class="string">"CodeMirrorEditor"</span>,

    constructor: <span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
      <span class="keyword">this</span>.element = $(el);
      assert(<span class="keyword">this</span>.element[<span class="number">0</span>].CodeMirror);
      <span class="keyword">this</span>._change = <span class="keyword">this</span>._change.bind(<span class="keyword">this</span>);
      <span class="keyword">this</span>._editor().on(<span class="string">"change"</span>, <span class="keyword">this</span>._change);
    },

    tracked: <span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
      <span class="keyword">return</span> <span class="keyword">this</span>.element[<span class="number">0</span>] === el;
    },

    destroy: <span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
      <span class="keyword">this</span>._editor().off(<span class="string">"change"</span>, <span class="keyword">this</span>._change);
    },

    update: <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
      <span class="keyword">this</span>._editor().replaceRange(
        msg.change.text,
        msg.change.from,
        msg.change.to);
    },

    init: <span class="function"><span class="keyword">function</span> <span class="params">(update, msg)</span> {</span>
      <span class="keyword">this</span>._editor().setValue(update.value);
    },

    makeInit: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">return</span> {
        element: elementFinder.elementLocation(<span class="keyword">this</span>.element),
        tracker: <span class="keyword">this</span>.trackerName,
        value: <span class="keyword">this</span>._editor().getValue()
      };
    },

    _change: <span class="function"><span class="keyword">function</span> <span class="params">(editor, change)</span> {</span>
      <span class="keyword">if</span> (inRemoteUpdate) {
        <span class="keyword">return</span>;
      }
      <span class="keyword">delete</span> change.origin;
      <span class="keyword">var</span> next = change.next;
      <span class="keyword">delete</span> change.next;
      session.send({
        type: <span class="string">"form-update"</span>,
        tracker: <span class="keyword">this</span>.trackerName,
        element: elementFinder.elementLocation(<span class="keyword">this</span>.element),
        change: change
      });
      <span class="keyword">if</span> (next) {
        <span class="keyword">this</span>._change(editor, next);
      }
    },

    _editor: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">return</span> <span class="keyword">this</span>.element[<span class="number">0</span>].CodeMirror;
    }
  });

  CodeMirrorEditor.scan = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">var</span> result = [];
    <span class="keyword">var</span> els = document.body.getElementsByTagName(<span class="string">"*"</span>);
    <span class="keyword">var</span> _len = els.length;
    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;_len; i++) {
      <span class="keyword">var</span> el = els[i];
      <span class="keyword">if</span> (el.CodeMirror) {
        result.push(el);
      }
    }
    <span class="keyword">return</span> $(result);
  };

  CodeMirrorEditor.tracked = <span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
    el = $(el)[<span class="number">0</span>];
    <span class="keyword">while</span> (el) {
      <span class="keyword">if</span> (el.CodeMirror) {
        <span class="keyword">return</span> <span class="literal">true</span>;
      }
      el = el.parentNode;
    }
    <span class="keyword">return</span> <span class="literal">false</span>;
  };

  TowTruck.addTracker(CodeMirrorEditor, <span class="literal">true</span> <span class="comment">/* skip setInit */</span>);

  <span class="function"><span class="keyword">function</span> <span class="title">buildTrackers</span><span class="params">()</span> {</span>
    assert(! liveTrackers.length);
    util.forEachAttr(editTrackers, <span class="function"><span class="keyword">function</span> <span class="params">(TrackerClass)</span> {</span>
      <span class="keyword">var</span> els = TrackerClass.scan();
      $.each(els, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        liveTrackers.push(<span class="keyword">new</span> TrackerClass(<span class="keyword">this</span>));
      });
    });
  }

  <span class="function"><span class="keyword">function</span> <span class="title">destroyTrackers</span><span class="params">()</span> {</span>
    liveTrackers.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(tracker)</span> {</span>
      tracker.destroy();
    });
    liveTrackers = [];
  }

  <span class="function"><span class="keyword">function</span> <span class="title">elementTracked</span><span class="params">(el)</span> {</span>
    <span class="keyword">var</span> result = <span class="literal">false</span>;
    util.forEachAttr(editTrackers, <span class="function"><span class="keyword">function</span> <span class="params">(TrackerClass)</span> {</span>
      <span class="keyword">if</span> (TrackerClass.tracked(el)) {
        result = <span class="literal">true</span>;
      }
    });
    <span class="keyword">return</span> result;
  }

  <span class="function"><span class="keyword">function</span> <span class="title">getTracker</span><span class="params">(el, name)</span> {</span>
    el = $(el)[<span class="number">0</span>];
    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;liveTrackers.length; i++) {
      <span class="keyword">var</span> tracker = liveTrackers[i];
      <span class="keyword">if</span> (tracker.tracked(el)) {
        assert((! name) || name == tracker.trackerName, <span class="string">"Expected to map to a tracker type"</span>, name, <span class="string">"but got"</span>, tracker.trackerName);
        <span class="keyword">return</span> tracker;
      }
    }
    <span class="keyword">return</span> <span class="literal">null</span>;
  }

  <span class="keyword">var</span> TEXT_TYPES = (
    <span class="string">"color date datetime datetime-local email "</span> +
        <span class="string">"tel text time week"</span>).split(<span class="regexp">/ /g</span>);

  <span class="function"><span class="keyword">function</span> <span class="title">isText</span><span class="params">(el)</span> {</span>
    el = $(el);
    <span class="keyword">var</span> tag = el.prop(<span class="string">"tagName"</span>);
    <span class="keyword">var</span> type = (el.prop(<span class="string">"type"</span>) || <span class="string">"text"</span>).toLowerCase();
    <span class="keyword">if</span> (tag == <span class="string">"TEXTAREA"</span>) {
      <span class="keyword">return</span> <span class="literal">true</span>;
    }
    <span class="keyword">if</span> (tag == <span class="string">"INPUT"</span> &amp;&amp; TEXT_TYPES.indexOf(type) != -<span class="number">1</span>) {
      <span class="keyword">return</span> <span class="literal">true</span>;
    }
    <span class="keyword">return</span> <span class="literal">false</span>;
  }

  <span class="function"><span class="keyword">function</span> <span class="title">getValue</span><span class="params">(el)</span> {</span>
    el = $(el);
    <span class="keyword">if</span> (isCheckable(el)) {
      <span class="keyword">return</span> el.prop(<span class="string">"checked"</span>);
    } <span class="keyword">else</span> {
      <span class="keyword">return</span> el.val();
    }
  }

  <span class="function"><span class="keyword">function</span> <span class="title">setValue</span><span class="params">(el, value)</span> {</span>
    el = $(el);
    <span class="keyword">if</span> (isCheckable(el)) {
      el.prop(<span class="string">"checked"</span>, value);
    } <span class="keyword">else</span> {
      el.val(value);
    }
    eventMaker.fireChange(el);
  }

  <span class="comment">/* Send the top of this history queue, if it hasn't been already sent. */</span>
  <span class="function"><span class="keyword">function</span> <span class="title">maybeSendUpdate</span><span class="params">(element, history)</span> {</span>
    <span class="keyword">var</span> change = history.getNextToSend();
    <span class="keyword">if</span> (! change) {
      <span class="comment">/* nothing to send */</span>
      <span class="keyword">return</span>;
    }
    <span class="keyword">var</span> msg = {
      type: <span class="string">"form-update"</span>,
      element: element,
      <span class="string">"server-echo"</span>: <span class="literal">true</span>,
      replace: {
        id: change.id,
        basis: change.basis,
        delta: {
          start: change.delta.start,
          del: change.delta.del,
          text: change.delta.text
        }
      }
    };
    session.send(msg);
  }

  session.hub.on(<span class="string">"form-update"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    <span class="keyword">if</span> (! msg.sameUrl) {
      <span class="keyword">return</span>;
    }
    <span class="keyword">var</span> el = $(elementFinder.findElement(msg.element));
    <span class="keyword">if</span> (msg.tracker) {
      <span class="keyword">var</span> tracker = getTracker(el, msg.tracker);
      assert(tracker);
      inRemoteUpdate = <span class="literal">true</span>;
      <span class="keyword">try</span> {
        tracker.update(msg);
      } <span class="keyword">finally</span> {
        inRemoteUpdate = <span class="literal">false</span>;
      }
      <span class="keyword">return</span>;
    }
    <span class="keyword">var</span> text = isText(el);
    <span class="keyword">var</span> selection;
    <span class="keyword">if</span> (text) {
      selection = [el[<span class="number">0</span>].selectionStart, el[<span class="number">0</span>].selectionEnd];
    }
    <span class="keyword">var</span> value;
    <span class="keyword">if</span> (msg.replace) {
      <span class="keyword">var</span> history = el.data(<span class="string">"towtruckHistory"</span>);
      <span class="keyword">if</span> (!history) {
        console.warn(<span class="string">"form update received for uninitialized form element"</span>);
        <span class="keyword">return</span>;
      }
      history.setSelection(selection);</pre></div></div>
              
            </li>
          
            <li id="section-334">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-334">&#182;</a>
                </div>
                <p>make a real TextReplace object.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      msg.replace.delta = ot.TextReplace(msg.replace.delta.start,
                                         msg.replace.delta.del,
                                         msg.replace.delta.text);</pre></div></div>
              
            </li>
          
            <li id="section-335">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-335">&#182;</a>
                </div>
                <p>apply this change to the history</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> changed = history.commit(msg.replace);
      maybeSendUpdate(msg.element, history);
      <span class="keyword">if</span> (! changed) {
        <span class="keyword">return</span>;
      }
      value = history.current;
      selection = history.getSelection();
    } <span class="keyword">else</span> {
      value = msg.value;
    }
    inRemoteUpdate = <span class="literal">true</span>;
    <span class="keyword">try</span> {
      setValue(el, value);
      <span class="keyword">if</span> (text) {
        el[<span class="number">0</span>].selectionStart = selection[<span class="number">0</span>];
        el[<span class="number">0</span>].selectionEnd = selection[<span class="number">1</span>];
      }
    } <span class="keyword">finally</span> {
      inRemoteUpdate = <span class="literal">false</span>;
    }
  });

  <span class="keyword">var</span> initSent = <span class="literal">false</span>;

  <span class="function"><span class="keyword">function</span> <span class="title">sendInit</span><span class="params">()</span> {</span>
    initSent = <span class="literal">true</span>;
    <span class="keyword">var</span> msg = {
      type: <span class="string">"form-init"</span>,
      pageAge: Date.now() - TowTruck.pageLoaded,
      updates: []
    };
    <span class="keyword">var</span> els = $(<span class="string">"textarea, input, select"</span>);
    els.each(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">if</span> (elementFinder.ignoreElement(<span class="keyword">this</span>) || elementTracked(<span class="keyword">this</span>)) {
        <span class="keyword">return</span>;
      }
      <span class="keyword">var</span> el = $(<span class="keyword">this</span>);
      <span class="keyword">var</span> value = getValue(el);
      <span class="keyword">var</span> upd = {
        element: elementFinder.elementLocation(<span class="keyword">this</span>),
        value: value
      };
      <span class="keyword">if</span> (isText(el)) {
        <span class="keyword">var</span> history = el.data(<span class="string">"towtruckHistory"</span>);
        <span class="keyword">if</span> (history) {
          upd.value = history.committed;
          upd.basis = history.basis;
        }
      }
      msg.updates.push(upd);
    });
    liveTrackers.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(tracker)</span> {</span>
      <span class="keyword">var</span> init = tracker.makeInit();
      assert(tracker.tracked(elementFinder.findElement(init.element)));
      msg.updates.push(init);
    });
    <span class="keyword">if</span> (msg.updates.length) {
      session.send(msg);
    }
  }

  <span class="function"><span class="keyword">function</span> <span class="title">setInit</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> els = $(<span class="string">"textarea, input, select"</span>);
    els.each(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">if</span> (elementTracked(<span class="keyword">this</span>)) {
        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span> (elementFinder.ignoreElement(<span class="keyword">this</span>)) {
        <span class="keyword">return</span>;
      }
      <span class="keyword">var</span> el = $(<span class="keyword">this</span>);
      <span class="keyword">var</span> value = getValue(el);
      el.data(<span class="string">"towtruckHistory"</span>, ot.SimpleHistory(session.clientId, value, <span class="number">1</span>));
    });
    destroyTrackers();
    buildTrackers();
  }

  session.on(<span class="string">"reinitialize"</span>, setInit);

  session.on(<span class="string">"ui-ready"</span>, setInit);

  session.on(<span class="string">"close"</span>, destroyTrackers);

  session.hub.on(<span class="string">"form-init"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    <span class="keyword">if</span> (! msg.sameUrl) {
      <span class="keyword">return</span>;
    }
    <span class="keyword">if</span> (initSent) {</pre></div></div>
              
            </li>
          
            <li id="section-336">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-336">&#182;</a>
                </div>
                <p>In a 3+-peer situation more than one client may init; in this case
we&#39;re probably the other peer, and not the peer that needs the init
A quick check to see if we should init...</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> myAge = Date.now() - TowTruck.pageLoaded;
      <span class="keyword">if</span> (msg.pageAge &lt; myAge) {</pre></div></div>
              
            </li>
          
            <li id="section-337">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-337">&#182;</a>
                </div>
                <p>We&#39;ve been around longer than the other person...</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span>;
      }
    }</pre></div></div>
              
            </li>
          
            <li id="section-338">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-338">&#182;</a>
                </div>
                <p>FIXME: need to figure out when to ignore inits</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    msg.updates.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(update)</span> {</span>
      <span class="keyword">var</span> el;
      <span class="keyword">try</span> {
        el = elementFinder.findElement(update.element);
      } <span class="keyword">catch</span> (e) {
        <span class="comment">/* skip missing element */</span>
        console.warn(e);
        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span> (update.tracker) {
        <span class="keyword">var</span> tracker = getTracker(el, update.tracker);
        assert(tracker);
        inRemoteUpdate = <span class="literal">true</span>;
        <span class="keyword">try</span> {
          tracker.init(update, msg);
        } <span class="keyword">finally</span> {
          inRemoteUpdate = <span class="literal">false</span>;
        }
      } <span class="keyword">else</span> {
        inRemoteUpdate = <span class="literal">true</span>;
        <span class="keyword">try</span> {
          setValue(el, update.value);
          <span class="keyword">if</span> (update.basis) {
            <span class="keyword">var</span> history = $(el).data(<span class="string">"towtruckHistory"</span>);</pre></div></div>
              
            </li>
          
            <li id="section-339">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-339">&#182;</a>
                </div>
                <p>don&#39;t overwrite history if we&#39;re already up to date
(we might have outstanding queued changes we don&#39;t want to lose)</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (!(history &amp;&amp; history.basis === update.basis &amp;&amp;</pre></div></div>
              
            </li>
          
            <li id="section-340">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-340">&#182;</a>
                </div>
                <p>if history.basis is 1, the form could have lingering
edits from before towtruck was launched.  that&#39;s too bad,
we need to erase them to resynchronize with the peer
we just asked to join.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>                  history.basis !== <span class="number">1</span>)) {
              $(el).data(<span class="string">"towtruckHistory"</span>, ot.SimpleHistory(session.clientId, update.value, update.basis));
            }
          }
        } <span class="keyword">finally</span> {
          inRemoteUpdate = <span class="literal">false</span>;
        }
      }
    });
  });

  <span class="keyword">var</span> lastFocus = <span class="literal">null</span>;

  <span class="function"><span class="keyword">function</span> <span class="title">focus</span><span class="params">(event)</span> {</span>
    <span class="keyword">var</span> target = event.target;
    <span class="keyword">if</span> (elementFinder.ignoreElement(target)) {
      blur(event);
      <span class="keyword">return</span>;
    }
    <span class="keyword">if</span> (target != lastFocus) {
      lastFocus = target;
      session.send({type: <span class="string">"form-focus"</span>, element: elementFinder.elementLocation(target)});
    }
  }

  <span class="function"><span class="keyword">function</span> <span class="title">blur</span><span class="params">(event)</span> {</span>
    <span class="keyword">var</span> target = event.target;
    <span class="keyword">if</span> (lastFocus) {
      lastFocus = <span class="literal">null</span>;
      session.send({type: <span class="string">"form-focus"</span>, element: <span class="literal">null</span>});
    }
  }

  <span class="keyword">var</span> focusElements = {};

  session.hub.on(<span class="string">"form-focus"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    <span class="keyword">var</span> current = focusElements[msg.peer.id];
    <span class="keyword">if</span> (current) {
      current.remove();
      current = <span class="literal">null</span>;
    }
    <span class="keyword">if</span> (! msg.element) {</pre></div></div>
              
            </li>
          
            <li id="section-341">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-341">&#182;</a>
                </div>
                <p>A blur</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">return</span>;
    }
    <span class="keyword">var</span> element = elementFinder.findElement(msg.element);
    focusElements[msg.peer.id] = createFocusElement(msg.peer, element);
  });

  session.hub.on(<span class="string">"hello"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    <span class="keyword">if</span> (lastFocus) {
      setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">if</span> (lastFocus) {
          session.send({type: <span class="string">"form-focus"</span>, element: elementFinder.elementLocation(lastFocus)});
        }
      });
    }
  });

  <span class="function"><span class="keyword">function</span> <span class="title">createFocusElement</span><span class="params">(peer, around)</span> {</span>
    around = $(around);
    <span class="keyword">var</span> el = templating.sub(<span class="string">"focus"</span>, {peer: peer});
    el = el.find(<span class="string">".towtruck-focus"</span>);
    <span class="keyword">var</span> aroundOffset = around.offset();
    el.css({
      top: aroundOffset.top-FOCUS_BUFFER + <span class="string">"px"</span>,
      left: aroundOffset.left-FOCUS_BUFFER + <span class="string">"px"</span>,
      width: around.outerWidth() + (FOCUS_BUFFER*<span class="number">2</span>) + <span class="string">"px"</span>,
      height: around.outerHeight() + (FOCUS_BUFFER*<span class="number">2</span>) + <span class="string">"px"</span>
    });
    $(document.body).append(el);
    <span class="keyword">return</span> el;
  }

  session.on(<span class="string">"ui-ready"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    $(document).on(<span class="string">"change"</span>, change);</pre></div></div>
              
            </li>
          
            <li id="section-342">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-342">&#182;</a>
                </div>
                <p>note that textInput, keydown, and keypress aren&#39;t appropriate events
to watch, since they fire <em>before</em> the element&#39;s value changes.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    $(document).on(<span class="string">"input keyup cut paste"</span>, maybeChange);
    $(document).on(<span class="string">"focusin"</span>, focus);
    $(document).on(<span class="string">"focusout"</span>, blur);
  });

  session.on(<span class="string">"close"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    $(document).off(<span class="string">"change"</span>, change);
    $(document).off(<span class="string">"input keyup cut paste"</span>, maybeChange);
    $(document).off(<span class="string">"focusin"</span>, focus);
    $(document).off(<span class="string">"focusout"</span>, blur);
  });

  session.hub.on(<span class="string">"hello"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    <span class="keyword">if</span> (msg.sameUrl) {
      setTimeout(sendInit);
    }
  });

  <span class="keyword">return</span> forms;
});

<span class="comment">/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>

<span class="comment">/* Loading this module will cause, when TowTruck is active, the
   session object to emit visibility-change with a `hidden` argument
   whenever the visibility changes, on browsers where we can detect
   it.
   */</span>

define(<span class="string">'visibilityApi'</span>,[<span class="string">"session"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(session)</span> {</span>

  <span class="keyword">var</span> hidden;
  <span class="keyword">var</span> visibilityChange;
  <span class="keyword">if</span> (document.hidden !== <span class="literal">undefined</span>) { <span class="comment">// Opera 12.10 and Firefox 18 and later support</span>
    hidden = <span class="string">"hidden"</span>;
    visibilityChange = <span class="string">"visibilitychange"</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (document.mozHidden !== <span class="literal">undefined</span>) {
    hidden = <span class="string">"mozHidden"</span>;
    visibilityChange = <span class="string">"mozvisibilitychange"</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (document.msHidden !== <span class="literal">undefined</span>) {
    hidden = <span class="string">"msHidden"</span>;
    visibilityChange = <span class="string">"msvisibilitychange"</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (document.webkitHidden !== <span class="literal">undefined</span>) {
    hidden = <span class="string">"webkitHidden"</span>;
    visibilityChange = <span class="string">"webkitvisibilitychange"</span>;
  }

  session.on(<span class="string">"start"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    document.addEventListener(visibilityChange, change, <span class="literal">false</span>);
  });

  session.on(<span class="string">"close"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    document.removeEventListener(visibilityChange, change, <span class="literal">false</span>);
  });

  <span class="function"><span class="keyword">function</span> <span class="title">change</span><span class="params">()</span> {</span>
    session.emit(<span class="string">"visibility-change"</span>, document[hidden]);
  }

});
TowTruck.require = TowTruck._requireObject = require;
require([<span class="string">"session"</span>]);
}());</pre></div></div>
              
            </li>
          
        </ul>
      </div>
    </section>






        <hr>

        <footer>

          <section class="row" id="footer">
            <div class="col-xs-3 text-left">
              <p><a href="https://mozillalabs.com/en-US/" target="_blank"><img src="../images/footer-mozilla-labs.png"></a></p>
            </div>
            <div class="col-xs-3">
              <ul class="list-unstyled text-left">
                <li class=""><a href=".././" class="scrollnav">Overview</a></li>
                <li><a href=".././docs/developers-getting-started.html" target="_blank">Docs</a></li>
                <li class=""><a href="mailto:towtruck@mozilla.com" target="_blank">Contact</a></li>
              </ul>
            </div>
            <div class="col-xs-3">
              <ul class="list-unstyled text-left">
                <li class=""><a href="https://mozillalabs.com/en-US/towtruck/" target="_blank">About</a></li>
                <li class=""><a href="https://github.com/mozilla/towtruck" target="_blank">Github</a></li>
                <li><a href="../source/analytics.js.html">Source Code</a></li>
                <li><a href="../faq.html">FAQ</a></li>
                <li class=""><a href="https://twitter.com/moztowtruck" target="_blank">Twitter</a></li>
              </ul>
            </div>
            <div class="col-xs-3">
              <ul class="list-unstyled text-left">
                <li class=""><a href="https://www.mozilla.org/en-US/privacy-policy.html" target="_blank">Privacy Policy</a></li>
                <li class=""><a href="https://www.mozilla.org/en-US/about/legal.html" target="_blank">Legal Notices</a></li>
                <li class=""><a href="https://www.mozilla.org/en-US/legal/fraud-report/index.html" target="_blank">Report Trademark Abuses</a></li>
              </ul>
            </div>
          </section>
        </footer>
      </section>

    </div> <!-- /container -->

  </body>
</html>
